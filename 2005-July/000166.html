<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Qrc-svn] r236 - in qrc/trunk: gaym/src gaym-extras
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/qrc-svn/2005-July/index.html" >
   <LINK REL="made" HREF="mailto:qrc-svn%40lists.berlios.de?Subject=Re%3A%20%5BQrc-svn%5D%20r236%20-%20in%20qrc/trunk%3A%20gaym/src%20gaym-extras&In-Reply-To=%3C200507240325.j6O3Pn2s022958%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000165.html">
   <LINK REL="Next"  HREF="000167.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Qrc-svn] r236 - in qrc/trunk: gaym/src gaym-extras</H1>
    <B>Jason LeBrun at BerliOS</B> 
    <A HREF="mailto:qrc-svn%40lists.berlios.de?Subject=Re%3A%20%5BQrc-svn%5D%20r236%20-%20in%20qrc/trunk%3A%20gaym/src%20gaym-extras&In-Reply-To=%3C200507240325.j6O3Pn2s022958%40sheep.berlios.de%3E"
       TITLE="[Qrc-svn] r236 - in qrc/trunk: gaym/src gaym-extras">jblebrun at berlios.de
       </A><BR>
    <I>Sun Jul 24 05:25:49 CEST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="000165.html">[Qrc-svn] r235 - qrc/trunk/gaym/src
</A></li>
        <LI>Next message: <A HREF="000167.html">[Qrc-svn] r237 - in qrc/trunk: gaym/src gaym-extras
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#166">[ date ]</a>
              <a href="thread.html#166">[ thread ]</a>
              <a href="subject.html#166">[ subject ]</a>
              <a href="author.html#166">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: jblebrun
Date: 2005-07-24 05:25:47 +0200 (Sun, 24 Jul 2005)
New Revision: 236

Modified:
   qrc/trunk/gaym-extras/chatsort.c
   qrc/trunk/gaym-extras/gaym-extras.c
   qrc/trunk/gaym-extras/roombrowse.c
   qrc/trunk/gaym/src/gaym.c
   qrc/trunk/gaym/src/msgs.c
   qrc/trunk/gaym/src/weblogin.c
Log:
*If server too busy to list member rooms, still list configtxt rooms.
*A first attempt at chat icons in the room, using the buddy system. For various reason, this method blows, so it's going to be completely re-hauled to use imgstore. But just in caes, the work is being committed.

gaym.c:
*Created a new signal that signals the reception of a buddy icon.

msgs.c:
*fetch_thumbnail_cb emits the new signal
*if the server is busy, the non-member rooms are still displayed.

gaym-extra.c:
mega thumbnail code!

roombrowse.c, chatsort.c, weblogin.c
formatting changes (ran indent)



Modified: qrc/trunk/gaym/src/gaym.c
===================================================================
--- qrc/trunk/gaym/src/gaym.c	2005-07-24 00:15:50 UTC (rev 235)
+++ qrc/trunk/gaym/src/gaym.c	2005-07-24 03:25:47 UTC (rev 236)
@@ -35,6 +35,7 @@
 #include &quot;version.h&quot;
 #include &quot;request.h&quot;
 #include &quot;privacy.h&quot;
+#include &quot;signals.h&quot;
 
 #include &quot;helpers.h&quot;
 #include &quot;gayminfo.h&quot;
@@ -1511,6 +1512,15 @@
                         &quot;conversation-created&quot;, plugin,
                         GAIM_CALLBACK(gaym_get_photo_info), NULL);
 
+    gaim_signal_register(gaim_accounts_get_handle(),
+                         &quot;buddy-icon-fetched&quot;,
+                         gaim_marshal_VOID__POINTER_POINTER, NULL, 2,
+                         gaim_value_new(GAIM_TYPE_SUBTYPE,
+                                        GAIM_SUBTYPE_CONNECTION),
+                         gaim_value_new(GAIM_TYPE_SUBTYPE,
+                                        GAIM_SUBTYPE_BUDDY_ICON));
+
+
     gaim_prefs_add_none(&quot;/plugins/prpl/gaym&quot;);
     gaim_prefs_add_int(&quot;/plugins/prpl/gaym/chat_room_instances&quot;, 4);
     gaim_prefs_add_bool(&quot;/plugins/prpl/gaym/show_join&quot;, TRUE);

Modified: qrc/trunk/gaym/src/msgs.c
===================================================================
--- qrc/trunk/gaym/src/msgs.c	2005-07-24 00:15:50 UTC (rev 235)
+++ qrc/trunk/gaym/src/msgs.c	2005-07-24 03:25:47 UTC (rev 236)
@@ -88,17 +88,26 @@
 void gaym_fetch_thumbnail_cb(void *user_data, const char *pic_data,
                              size_t len)
 {
-    if (!user_data || !pic_data) {
+    if (!user_data)
         return;
+    struct gaym_fetch_thumbnail_data *d = user_data;
+    if (!pic_data) {
+        gaim_signal_emit(gaim_accounts_get_handle(), &quot;buddy-icon-fetched&quot;,
+                         d-&gt;gc, NULL, d-&gt;who);
+        return;
     }
 
-    struct gaym_fetch_thumbnail_data *d = user_data;
 
     if (GAIM_CONNECTION_IS_VALID(d-&gt;gc) &amp;&amp; len) {
         gaim_buddy_icons_set_for_user(gaim_connection_get_account(d-&gt;gc),
                                       d-&gt;who, (void *) pic_data, len);
+        gaim_signal_emit(gaim_accounts_get_handle(), &quot;buddy-icon-fetched&quot;,
+                         d-&gt;gc, gaim_buddy_icons_find(d-&gt;gc-&gt;account,
+                                                      d-&gt;who));
     } else {
         gaim_debug_error(&quot;gaym&quot;, &quot;Fetching buddy icon failed.\n&quot;);
+        gaim_signal_emit(gaim_accounts_get_handle(), &quot;buddy-icon-fetched&quot;,
+                         d-&gt;gc, NULL, d-&gt;who);
     }
 
     g_free(d-&gt;who);
@@ -1235,10 +1244,22 @@
     }
     buf = g_strdup_printf(_(&quot;%s&quot;), args[1]);
     gaim_notify_error(gc, _(&quot;Server Busy&quot;), _(&quot;Server Busy&quot;), buf);
-    if (gaym-&gt;roomlist) {
-        gaim_roomlist_cancel_get_list(gaym-&gt;roomlist);
+    // if (gaym-&gt;roomlist) {
+    // gaim_roomlist_cancel_get_list(gaym-&gt;roomlist);
+    // }
+    g_free(buf);
+    /**
+     * Can't get member created rooms right now.
+     * This is our trigger to add the static rooms
+     */
+    build_roomlist_from_config(gaym-&gt;roomlist, gaym-&gt;confighash,
+                               gaym-&gt;roomlist_filter);
+    if (gaym-&gt;roomlist_filter) {
+        g_free(gaym-&gt;roomlist_filter);
+        gaym-&gt;roomlist_filter = NULL;
     }
-    g_free(buf);
+    return;
+
 }
 
 void gaym_msg_richnames_list(struct gaym_conn *gaym, const char *name,

Modified: qrc/trunk/gaym/src/weblogin.c
===================================================================
--- qrc/trunk/gaym/src/weblogin.c	2005-07-24 00:15:50 UTC (rev 235)
+++ qrc/trunk/gaym/src/weblogin.c	2005-07-24 03:25:47 UTC (rev 236)
@@ -62,16 +62,18 @@
 
 } GaimFetchUrlData;
 
-static void gaym_session_destroy(GaimUrlSession* session) {
+static void gaym_session_destroy(GaimUrlSession * session)
+{
     if (session-&gt;cookies)
-	g_free(session-&gt;cookies);
+        g_free(session-&gt;cookies);
     if (session-&gt;username)
-	g_free(session-&gt;username);
+        g_free(session-&gt;username);
     if (session-&gt;password)
-	g_free(session-&gt;password);
-    gaim_debug_misc(&quot;gaym&quot;,&quot;freeing session: %x\n&quot;,session);
+        g_free(session-&gt;password);
+    gaim_debug_misc(&quot;gaym&quot;, &quot;freeing session: %x\n&quot;, session);
     g_free(session);
 }
+
 /* gaim_url_decode doesn't change pluses to spaces - edit in place */
 static const char *gaym_url_decode(const char *string)
 {
@@ -89,7 +91,7 @@
 
 static void destroy_fetch_url_data(GaimFetchUrlData * gfud)
 {
-    gaim_debug_misc(&quot;gaym&quot;,&quot;destroy_fetch_url_data called\n&quot;);
+    gaim_debug_misc(&quot;gaym&quot;, &quot;destroy_fetch_url_data called\n&quot;);
     if (gfud-&gt;webdata != NULL)
         g_free(gfud-&gt;webdata);
     if (gfud-&gt;url != NULL)
@@ -104,7 +106,7 @@
         g_free(gfud-&gt;website.user);
     if (gfud-&gt;website.passwd != NULL)
         g_free(gfud-&gt;website.passwd);
-   
+
     g_free(gfud);
 }
 
@@ -233,9 +235,9 @@
                     g_strdup_printf(&quot;%s; %.*s&quot;, session-&gt;cookies,
                                     cookie_size, next_token);
             else
-
-	    //FIXME: I think there is a function for resizing the memory
-	    //which is more efficient then a allocation and freeing.
+                // FIXME: I think there is a function for resizing the
+                // memory
+                // which is more efficient then a allocation and freeing.
                 new_cookie =
                     g_strdup_printf(&quot;%.*s&quot;, cookie_size, next_token);
             if (new_cookie) {
@@ -263,6 +265,7 @@
 // 
 // 
 // 
+// 
 // this
 // structure, as well.
 static void
@@ -297,6 +300,7 @@
                        // 
                        // 
                        // 
+                       // 
                        // (see 
                        // above)
                        (gfud-&gt;full ? &quot;&quot; : &quot;/&quot;),
@@ -310,6 +314,7 @@
                        // 
                        // 
                        // 
+                       // 
                        // See 
                        // above
                        (gfud-&gt;full ? &quot;&quot; : &quot;/&quot;),
@@ -490,7 +495,7 @@
 {
 
     GaimUrlSession *session = (GaimUrlSession *) data;
-    struct gaym_conn* gaym = session-&gt;gaym;
+    struct gaym_conn *gaym = session-&gt;gaym;
     // Get hash from text
     if (session &amp;&amp; GAIM_CONNECTION_IS_VALID(session-&gt;account-&gt;gc)) {
         // char *pw_hash;
@@ -503,11 +508,11 @@
 
 
 
-	gaym-&gt;server_stats=NULL;
-	gaym-&gt;hash_pw=NULL;
-	gaym-&gt;server_bioline=NULL;
-	gaym-&gt;thumbnail=NULL;
-	
+        gaym-&gt;server_stats = NULL;
+        gaym-&gt;hash_pw = NULL;
+        gaym-&gt;server_bioline = NULL;
+        gaym-&gt;thumbnail = NULL;
+
         // First, look for password
         match = &quot;password\&quot; value=\&quot;&quot;;
         temp = strstr(text, match);
@@ -553,13 +558,13 @@
                     || (gaym-&gt;server_bioline = NULL);
                 g_free(bio);
 
-		//Parse out stats part of bio.
-		temp2 = strchr(result, (char)0x01);
-		if(temp2++) {
-		    gaim_debug_misc(&quot;gaym&quot;, &quot;Stats: %s\n&quot;, temp2);
-		    gaym-&gt;server_stats = g_strdup(temp2);
-		}
-	    }
+                // Parse out stats part of bio.
+                temp2 = strchr(result, (char) 0x01);
+                if (temp2++) {
+                    gaim_debug_misc(&quot;gaym&quot;, &quot;Stats: %s\n&quot;, temp2);
+                    gaym-&gt;server_stats = g_strdup(temp2);
+                }
+            }
         } else {
             // gaim_connection_error(
             // gaim_account_get_connection(((struct
@@ -573,7 +578,7 @@
         gaim_debug_misc(&quot;gaym&quot;, &quot;gaym-&gt;session: %x\n&quot;, session);
     }
 
-    //We don't need the session info anymore.
+    // We don't need the session info anymore.
     gaym_session_destroy(session);
 
 }
@@ -584,8 +589,7 @@
 
     GaimUrlSession *session = (GaimUrlSession *) data;
     gaim_debug_misc(&quot;gaym&quot;, &quot;Step 4: session: %x\n&quot;, session);
-    if (session
-        &amp;&amp; GAIM_CONNECTION_IS_VALID(session-&gt;account-&gt;gc)) {
+    if (session &amp;&amp; GAIM_CONNECTION_IS_VALID(session-&gt;account-&gt;gc)) {
         // The fourth step is to parse a rand=# value out of the message
         // text from
         // The previous step.
@@ -594,8 +598,7 @@
         int nonce;
         char *buf = g_strdup_printf(_(&quot;Signon: %s&quot;),
                                     (session-&gt;account-&gt;username));
-        gaim_connection_update_progress(session-&gt;account-&gt;gc, buf, 5,
-                                        6);
+        gaim_connection_update_progress(session-&gt;account-&gt;gc, buf, 5, 6);
         sscanf(text, &quot;?rand=%d&quot;, &amp;nonce);
         snprintf(url, 512,
                  &quot;<A HREF="http://www.gay.com/messenger/applet.html?rand=%d">http://www.gay.com/messenger/applet.html?rand=%d</A>&quot;,
@@ -607,8 +610,8 @@
     } else {
         gaim_debug_misc(&quot;gaym&quot;, &quot;Connection was cancelled before step4\n&quot;);
         gaim_debug_misc(&quot;gaym&quot;, &quot;session: %x\n&quot;, session);
-	gaym_session_destroy(session);	
-	
+        gaym_session_destroy(session);
+
         // g_free(gaym-&gt;session);
     }
 }
@@ -639,8 +642,7 @@
         char *url = &quot;<A HREF="http://www.gay.com/messenger/frameset.html">http://www.gay.com/messenger/frameset.html</A>&quot;;
         char *buf = g_strdup_printf(_(&quot;Signon: %s&quot;),
                                     (session-&gt;account-&gt;username));
-        gaim_connection_update_progress(session-&gt;account-&gt;gc, buf, 4,
-                                        6);
+        gaim_connection_update_progress(session-&gt;account-&gt;gc, buf, 4, 6);
         session-&gt;hasFormData = FALSE;
         gaim_session_fetch(url, FALSE, NULL, FALSE, gaym_weblogin_step4,
                            session, session);
@@ -648,7 +650,7 @@
 
         gaim_debug_misc(&quot;gaym&quot;, &quot;Connection was cancelled before step3\n&quot;);
         gaim_debug_misc(&quot;gaym&quot;, &quot;session: %x\n&quot;, session);
-	gaym_session_destroy(session);	
+        gaym_session_destroy(session);
         // g_free(gaym-&gt;session);
 
     }
@@ -657,19 +659,17 @@
 gaym_weblogin_step2(gpointer data, const char *text, size_t len)
 {
 
-    
+
     GaimUrlSession *session = (GaimUrlSession *) data;
-    if (session
-        &amp;&amp; GAIM_CONNECTION_IS_VALID(session-&gt;account-&gt;gc)) {
-	gaim_debug_misc(&quot;gaym&quot;,&quot;Step 2: connection is valid.\n&quot;);
+    if (session &amp;&amp; GAIM_CONNECTION_IS_VALID(session-&gt;account-&gt;gc)) {
+        gaim_debug_misc(&quot;gaym&quot;, &quot;Step 2: connection is valid.\n&quot;);
         // The second step is to do the actual login.
         // We connect to misc/dologin.html, using cookies set from step 1
         // And add a few more cookie values.
         char url[1024];
         char *buf = g_strdup_printf(_(&quot;Signon: %s&quot;),
                                     session-&gt;account-&gt;username);
-        gaim_connection_update_progress(session-&gt;account-&gt;gc, buf, 3,
-                                        6);
+        gaim_connection_update_progress(session-&gt;account-&gt;gc, buf, 3, 6);
 
         snprintf(url, 1024,
                  &quot;<A HREF="http://www.gay.com/misc/dologin.html?__login_haveForm=1&amp;__login_save=1&amp;__login_member=%s&amp;redir=%%2Findex.html&amp;__login_basepage=%%2Fmisc%%2Fdologin.html&amp;__login_password=%s">http://www.gay.com/misc/dologin.html?__login_haveForm=1&amp;__login_save=1&amp;__login_member=%s&amp;redir=%%2Findex.html&amp;__login_basepage=%%2Fmisc%%2Fdologin.html&amp;__login_password=%s</A>&quot;,
@@ -681,7 +681,7 @@
     } else {
         gaim_debug_misc(&quot;gaym&quot;, &quot;Connection was cancelled before step2\n&quot;);
         gaim_debug_misc(&quot;gaym&quot;, &quot;session: %x\n&quot;, session);
-	gaym_session_destroy(session);
+        gaym_session_destroy(session);
         // g_free(gaym-&gt;session);
     }
 }
@@ -706,7 +706,7 @@
         session-&gt;account = account;
         session-&gt;username = g_strdup(account-&gt;username);
         session-&gt;password = g_strdup(account-&gt;password);
-	session-&gt;gaym = gaym;
+        session-&gt;gaym = gaym;
 
 
         gaim_debug_misc(&quot;gaym&quot;, &quot;Made session: %x\n&quot;, session);
@@ -726,22 +726,22 @@
         } else {
             gaim_debug_misc(&quot;gaym&quot;, &quot;cancelled before step1\n&quot;);
             gaim_debug_misc(&quot;gaym&quot;, &quot;gaym-&gt;sessoin: %x\n&quot;, session);
-	    gaym_session_destroy(session);
+            gaym_session_destroy(session);
         }
 
     }
 }
 
 void gaym_try_cached_password(GaimAccount * account,
-                            void (*callback) (GaimAccount * account))
+                              void (*callback) (GaimAccount * account))
 {
 
-    const char* pw;
-    pw=gaim_account_get_string(account, &quot;password&quot;, NULL);
-    if (pw==NULL)
+    const char *pw;
+    pw = gaim_account_get_string(account, &quot;password&quot;, NULL);
+    if (pw == NULL)
         gaym_get_hash_from_weblogin(account, callback);
-    
 
+
 }
 
 /**

Modified: qrc/trunk/gaym-extras/chatsort.c
===================================================================
--- qrc/trunk/gaym-extras/chatsort.c	2005-07-24 00:15:50 UTC (rev 235)
+++ qrc/trunk/gaym-extras/chatsort.c	2005-07-24 03:25:47 UTC (rev 236)
@@ -17,71 +17,76 @@
 #define CHATSORT_PLUGIN_ID &quot;gtk-chatsort&quot;
 
 
-//A dummy sort function... don't sort at all!
-static gint sort_chat_users(GtkTreeModel *model, GtkTreeIter *a, GtkTreeIter *b, gpointer userdata) {
-return 1;
+// A dummy sort function... don't sort at all!
+static gint sort_chat_users(GtkTreeModel * model, GtkTreeIter * a,
+                            GtkTreeIter * b, gpointer userdata)
+{
+    return 1;
 }
 
-//This gets called BEFORE a chatlist is populated... just creates a new type of chat window.
-static void redochatwindow(GaimConversation *c) {
+// This gets called BEFORE a chatlist is populated... just creates a new
+// type of chat window.
+static void redochatwindow(GaimConversation * c)
+{
 
-	GtkTreeModel *oldls;
-	GtkTreeSelection *select;
-	GtkTreeIter iter;
+    GtkTreeModel *oldls;
+    GtkTreeSelection *select;
+    GtkTreeIter iter;
 
-	//Get a handle to the chat pane for the conversation
-	GaimGtkConversation* gtkconv = GAIM_GTK_CONVERSATION(c);
-	GaimGtkChatPane* gtkchat = gtkconv-&gt;u.chat;
+    // Get a handle to the chat pane for the conversation
+    GaimGtkConversation *gtkconv = GAIM_GTK_CONVERSATION(c);
+    GaimGtkChatPane *gtkchat = gtkconv-&gt;u.chat;
 
-	
-	oldls = gtk_tree_view_get_model(GTK_TREE_VIEW(gtkchat-&gt;list));
-	select = gtk_tree_view_get_selection(GTK_TREE_VIEW(gtkchat-&gt;list));
 
-	//This is a dummy &quot;root&quot; item. If it's not here,
-	//then the first name entered into the list gets &quot;stucK&quot; at the
-	//top. This is a hack.
-	gtk_list_store_append(GTK_LIST_STORE(oldls), &amp;iter);
-	gtk_list_store_set(GTK_LIST_STORE(oldls), &amp;iter, CHAT_USERS_NAME_COLUMN, &quot; &quot;, -1);
-        gtk_tree_sortable_set_sort_func(GTK_TREE_SORTABLE(oldls), CHAT_USERS_NAME_COLUMN, sort_chat_users, NULL, NULL);
-	
+    oldls = gtk_tree_view_get_model(GTK_TREE_VIEW(gtkchat-&gt;list));
+    select = gtk_tree_view_get_selection(GTK_TREE_VIEW(gtkchat-&gt;list));
+
+    // This is a dummy &quot;root&quot; item. If it's not here,
+    // then the first name entered into the list gets &quot;stucK&quot; at the
+    // top. This is a hack.
+    gtk_list_store_append(GTK_LIST_STORE(oldls), &amp;iter);
+    gtk_list_store_set(GTK_LIST_STORE(oldls), &amp;iter,
+                       CHAT_USERS_NAME_COLUMN, &quot; &quot;, -1);
+    gtk_tree_sortable_set_sort_func(GTK_TREE_SORTABLE(oldls),
+                                    CHAT_USERS_NAME_COLUMN,
+                                    sort_chat_users, NULL, NULL);
+
 }
 
-static gboolean plugin_load(GaimPlugin *plugin)
+static gboolean plugin_load(GaimPlugin * plugin)
 {
-	gaim_signal_connect(gaim_conversations_get_handle(),
-						&quot;chat-joined&quot;,
-						plugin, GAIM_CALLBACK(redochatwindow), NULL);
-	
-	return TRUE;
+    gaim_signal_connect(gaim_conversations_get_handle(),
+                        &quot;chat-joined&quot;,
+                        plugin, GAIM_CALLBACK(redochatwindow), NULL);
+
+    return TRUE;
 }
 
-static GaimPluginInfo info =
-{
-	GAIM_PLUGIN_MAGIC,
-	GAIM_MAJOR_VERSION,
-	GAIM_MINOR_VERSION,
-	GAIM_PLUGIN_STANDARD,
-	GAIM_GTK_PLUGIN_TYPE,
-	0,
-	NULL,
-	GAIM_PRIORITY_DEFAULT,
-	CHATSORT_PLUGIN_ID,
-	N_(&quot;Chatroom Sort options&quot;),
-	VERSION,
-	N_(&quot;Changes the sorting options of chatroom lists.&quot;),
-	N_(&quot;When a new conversation is opened this plugin will insert the last conversation into the current conversation.&quot;),
-	&quot;Jason LeBrun &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/qrc-svn">gaim at jasonlebrun.info</A>&quot;,
-	GAIM_WEBSITE,
-	plugin_load,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL
+static GaimPluginInfo info = {
+    GAIM_PLUGIN_MAGIC,
+    GAIM_MAJOR_VERSION,
+    GAIM_MINOR_VERSION,
+    GAIM_PLUGIN_STANDARD,
+    GAIM_GTK_PLUGIN_TYPE,
+    0,
+    NULL,
+    GAIM_PRIORITY_DEFAULT,
+    CHATSORT_PLUGIN_ID,
+    N_(&quot;Chatroom Sort options&quot;),
+    VERSION,
+    N_(&quot;Changes the sorting options of chatroom lists.&quot;),
+    N_(&quot;When a new conversation is opened this plugin will insert the last conversation into the current conversation.&quot;),
+    &quot;Jason LeBrun &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/qrc-svn">gaim at jasonlebrun.info</A>&quot;,
+    GAIM_WEBSITE,
+    plugin_load,
+    NULL,
+    NULL,
+    NULL,
+    NULL,
+    NULL
 };
 
-static void
-init_plugin(GaimPlugin *plugin)
+static void init_plugin(GaimPlugin * plugin)
 {
 }
 

Modified: qrc/trunk/gaym-extras/gaym-extras.c
===================================================================
--- qrc/trunk/gaym-extras/gaym-extras.c	2005-07-24 00:15:50 UTC (rev 235)
+++ qrc/trunk/gaym-extras/gaym-extras.c	2005-07-24 03:25:47 UTC (rev 236)
@@ -10,96 +10,418 @@
 #include &quot;signals.h&quot;
 #include &quot;util.h&quot;
 #include &quot;version.h&quot;
+#include &quot;buddyicon.h&quot;
 
 #include &quot;gtkconv.h&quot;
 #include &quot;gtkimhtml.h&quot;
 #include &quot;gtkplugin.h&quot;
-
 #define CHATSORT_PLUGIN_ID &quot;gtk-chaticon&quot;
 
-GHashTable* icons;
-GHashTable* icon_spots;
-static void clear_icon() {
+GHashTable *icons;
+GHashTable *icon_spots;
+GHashTable *pending_updates;
+GaimConvWindow *hider_window;
 
+typedef struct _GaymChatIcon {
+
+    GaimConversation *conv;
+    GtkWidget *icon_container_parent;
+    GtkWidget *icon_container;
+    GtkWidget *icon;
+    gboolean show_icon;
+    GdkPixbufAnimation *anim;
+    GdkPixbufAnimationIter *iter;
+    gboolean animate;
+    guint32 icon_timer;
+
+} GaymChatIcon;
+
+static void
+get_icon_scale_size(GdkPixbufAnimation * icon, GaimBuddyIconSpec * spec,
+                    int *width, int *height)
+{
+    *width = gdk_pixbuf_animation_get_width(icon);
+    *height = gdk_pixbuf_animation_get_height(icon);
+
+    /* this should eventually get smarter about preserving the aspect
+       ratio when scaling, but gimmie a break, I just woke up */
+    if (spec &amp;&amp; spec-&gt;scale_rules &amp; GAIM_ICON_SCALE_DISPLAY) {
+        if (*width &lt; spec-&gt;min_width)
+            *width = spec-&gt;min_width;
+        else if (*width &gt; spec-&gt;max_width)
+            *width = spec-&gt;max_width;
+
+        if (*height &lt; spec-&gt;min_height)
+            *height = spec-&gt;min_height;
+        else if (*height &gt; spec-&gt;max_height)
+            *height = spec-&gt;max_height;
+    }
+
+    /* and now for some arbitrary sanity checks */
+    if (*width &gt; 100)
+        *width = 100;
+    if (*height &gt; 100)
+        *height = 100;
 }
-static void changed_cb(GtkTreeSelection* selection, gpointer data){
 
-	GaimConversation* c = (GaimConversation*)data;
-	GtkTreeIter iter;
-	GtkTreeModel* model;
-	gchar* name;
-	GaimConversation *temp;
-	gtk_tree_selection_get_selected(selection, &amp;model, &amp;iter);
-	gtk_tree_model_get(model,&amp;iter,CHAT_USERS_NAME_COLUMN, &amp;name, -1);
 
-	gaim_debug_misc(&quot;chatsort&quot;,&quot;Click: %s\n&quot;,name);
-	gtk_button_set_label(g_hash_table_lookup(icon_spots, c), name);
-	//Look in local icon cache here.
-	//If the icon isn't here, get it from gaym
-	//Update the widget
+void
+gaym_gtkconv_update_buddy_icon(GaimConversation * conv,
+                               GaimBuddyIcon * icon)
+{
+    GaimGtkConversation *gtkconv;
+    // GaimGtkWindow *gtkwin =
+    // GAIM_GTK_WINDOW(gaim_conversation_get_window(conv));
+
+    char filename[256];
+    FILE *file;
+    GError *err = NULL;
+
+    const void *data = NULL;
+    size_t len;
+
+    GdkPixbuf *buf;
+
+    GtkWidget *event;
+    GtkWidget *frame;
+    GdkPixbuf *scale;
+    GdkPixmap *pm;
+    GdkBitmap *bm;
+    int scale_width, scale_height;
+    GtkRequisition requisition;
+
+    GaimAccount *account;
+    GaimPluginProtocolInfo *prpl_info = NULL;
+
+    // GaimButtonStyle button_type;
+
+    gaim_debug_misc(&quot;chaticon&quot;, &quot;entered update function\n&quot;);
+    g_return_if_fail(conv != NULL);
+    g_return_if_fail(GAIM_IS_GTK_CONVERSATION(conv));
+    g_return_if_fail(gaim_conversation_get_type(conv) == GAIM_CONV_CHAT);
+
+    gtkconv = GAIM_GTK_CONVERSATION(conv);
+
+    GaymChatIcon *icon_data = g_hash_table_lookup(icons, conv);
+    gaim_debug_misc(&quot;chaticon&quot;,
+                    &quot;got icon_data: %x ... icon is %x, show_icon is %i\n&quot;,
+                    icon_data, icon, icon_data-&gt;show_icon);
+    // Look things up in our hand hash table of icon stuff.
+
+    if (!icon)
+        return;
+    if (!icon_data-&gt;show_icon)
+        return;
+
+    account = gaim_conversation_get_account(conv);
+    if (account &amp;&amp; account-&gt;gc)
+        prpl_info = GAIM_PLUGIN_PROTOCOL_INFO(account-&gt;gc-&gt;prpl);
+
+    /* Remove the current icon stuff */
+    if (icon_data-&gt;icon_container != NULL)
+        gtk_widget_destroy(icon_data-&gt;icon_container);
+    icon_data-&gt;icon_container = NULL;
+
+    if (icon_data-&gt;anim != NULL)
+        g_object_unref(G_OBJECT(icon_data-&gt;anim));
+
+    icon_data-&gt;anim = NULL;
+
+    gaim_debug_misc(&quot;chaticon&quot;, &quot;did some unreffing\n&quot;);
+    if (icon_data-&gt;icon_timer != 0)
+        g_source_remove(icon_data-&gt;icon_timer);
+
+    icon_data-&gt;icon_timer = 0;
+
+    if (icon_data-&gt;iter != NULL)
+        g_object_unref(G_OBJECT(icon_data-&gt;iter));
+
+    icon_data-&gt;iter = NULL;
+
+    if (!gaim_prefs_get_bool
+        (&quot;/gaim/gtk/conversations/im/show_buddy_icons&quot;))
+        return;
+
+    if (gaim_conversation_get_gc(conv) == NULL)
+        return;
+
+    gaim_debug_misc(&quot;chaticon&quot;, &quot;did some more unreffing\n&quot;);
+    // ///ICON GETTING
+    // icon = gaim_conv_im_get_icon(GAIM_CONV_IM(conv));
+
+    // if (icon == NULL)
+    // return;
+
+    data = gaim_buddy_icon_get_data(icon, &amp;len);
+
+    // ////END ICON GETTING
+
+    /* this is such an evil hack, i don't know why i'm even considering
+       it. we'll do it differently when gdk-pixbuf-loader isn't leaky
+       anymore. */
+    /* gdk-pixbuf-loader was leaky? is it still? */
+
+    gaim_debug_misc(&quot;chaticon&quot;, &quot;Got icon data\n&quot;);
+    g_snprintf(filename, sizeof(filename),
+               &quot;%s&quot; G_DIR_SEPARATOR_S &quot;gaimicon-%s.%d&quot;,
+               g_get_tmp_dir(), gaim_buddy_icon_get_username(icon),
+               getpid());
+
+    if (!(file = g_fopen(filename, &quot;wb&quot;)))
+        return;
+
+    fwrite(data, 1, len, file);
+    fclose(file);
+    gaim_debug_misc(&quot;chaticon&quot;, &quot;Wrote temp file\n&quot;);
+    icon_data-&gt;anim = gdk_pixbuf_animation_new_from_file(filename, &amp;err);
+
+    gaim_debug_misc(&quot;chaticon&quot;, &quot;Loaded icon from temp file\n&quot;);
+    /* make sure we remove the file as soon as possible */
+    g_unlink(filename);
+
+    if (err) {
+        gaim_debug(GAIM_DEBUG_ERROR, &quot;gtkconv&quot;,
+                   &quot;Buddy icon error: %s\n&quot;, err-&gt;message);
+        g_error_free(err);
+    }
+
+    if (!icon_data-&gt;anim)
+        return;
+
+    if (gdk_pixbuf_animation_is_static_image(icon_data-&gt;anim)) {
+        icon_data-&gt;iter = NULL;
+        buf = gdk_pixbuf_animation_get_static_image(icon_data-&gt;anim);
+    } else {
+        icon_data-&gt;iter = gdk_pixbuf_animation_get_iter(icon_data-&gt;anim, NULL); /* LEAK 
+                                                                                 */
+        buf = gdk_pixbuf_animation_iter_get_pixbuf(icon_data-&gt;iter);
+        // if (icon_data-&gt;animate)
+        // start_anim(NULL, conv);
+    }
+
+    get_icon_scale_size(icon_data-&gt;anim,
+                        prpl_info ? &amp;prpl_info-&gt;icon_spec : NULL,
+                        &amp;scale_width, &amp;scale_height);
+    scale =
+        gdk_pixbuf_scale_simple(buf,
+                                MAX(gdk_pixbuf_get_width(buf) *
+                                    scale_width /
+                                    gdk_pixbuf_animation_get_width
+                                    (icon_data-&gt;anim), 1),
+                                MAX(gdk_pixbuf_get_height(buf) *
+                                    scale_height /
+                                    gdk_pixbuf_animation_get_height
+                                    (icon_data-&gt;anim), 1),
+                                GDK_INTERP_NEAREST);
+
+    gdk_pixbuf_render_pixmap_and_mask(scale, &amp;pm, &amp;bm, 100);
+    g_object_unref(G_OBJECT(scale));
+
+
+    icon_data-&gt;icon_container = gtk_vbox_new(FALSE, 0);
+
+    frame = gtk_frame_new(NULL);
+    gtk_frame_set_shadow_type(GTK_FRAME(frame),
+                              (bm ? GTK_SHADOW_NONE : GTK_SHADOW_IN));
+    gtk_box_pack_start(GTK_BOX(icon_data-&gt;icon_container), frame,
+                       FALSE, FALSE, 0);
+
+    event = gtk_event_box_new();
+    gtk_container_add(GTK_CONTAINER(frame), event);
+    // g_signal_connect(G_OBJECT(event), &quot;button-press-event&quot;,
+    // G_CALLBACK(icon_menu), conv);
+    gtk_widget_show(event);
+
+    icon_data-&gt;icon = gtk_image_new_from_pixmap(pm, bm);
+    gtk_widget_set_size_request(icon_data-&gt;icon, scale_width,
+                                scale_height);
+    gtk_container_add(GTK_CONTAINER(event), icon_data-&gt;icon);
+    gtk_widget_show(icon_data-&gt;icon);
+
+    g_object_unref(G_OBJECT(pm));
+
+    if (bm)
+        g_object_unref(G_OBJECT(bm));
+
+    // ////OLD CODE, KEEPING FOR REFERENCE UNTIL COMPLETE.
+    // button_type =
+    // gaim_prefs_get_int(&quot;/gaim/gtk/conversations/button_type&quot;);
+    /* the button seems to get its size before the box, so... */
+    gtk_widget_size_request(gtkconv-&gt;send, &amp;requisition);
+    // if (button_type == GAIM_BUTTON_NONE || requisition.height * 1.5 &lt;
+    // scale_height) {
+    gtk_box_pack_start(GTK_BOX(icon_data-&gt;icon_container_parent),
+                       icon_data-&gt;icon_container, FALSE, FALSE, 0);
+    /* gtk_box_reorder_child(GTK_BOX(gtkconv-&gt;lower_hbox), vbox, 0); */
+    // } else {
+    // gtk_box_pack_start(GTK_BOX(gtkconv-&gt;bbox),
+    // icon_data-&gt;icon_container, FALSE, FALSE, 0);
+    // gtk_box_reorder_child(GTK_BOX(gtkconv-&gt;bbox),
+    // icon_data-&gt;icon_container, 0);
+    // }
+
+    gtk_widget_show(icon_data-&gt;icon_container);
+    gtk_widget_show(frame);
+    // ////////////////////
+    /* The buddy icon code needs badly to be fixed. */
+    buf = gdk_pixbuf_animation_get_static_image(icon_data-&gt;anim);
+    // if(conv ==
+    // gaim_conv_window_get_active_conversation(gaim_conversation_get_window(conv)))
+    // gtk_window_set_icon(GTK_WINDOW(gtkwin-&gt;window), buf);
 }
-//This gets called BEFORE a chatlist is populated... just creates a new type of chat window.
-static void redochatwindow(GaimConversation *c) {
 
-	GtkTreeModel *oldls;
-	
-	//Get a handle to the chat pane for the conversation
-	GaimGtkConversation* gtkconv = GAIM_GTK_CONVERSATION(c);
-	GaimGtkChatPane* gtkchat = gtkconv-&gt;u.chat;
-	GtkTreeSelection* select = gtk_tree_view_get_selection(GTK_TREE_VIEW(gtkchat-&gt;list));
-	gtk_tree_selection_set_mode(select, GTK_SELECTION_SINGLE);
 
-	oldls = gtk_tree_view_get_model(GTK_TREE_VIEW(gtkchat-&gt;list));	
-	GtkBox* vbox = GTK_BOX(gtkchat-&gt;list-&gt;parent-&gt;parent);
-	GtkWidget* button = gtk_button_new_with_label(&quot;A Button&quot;);
-	g_signal_connect(G_OBJECT(select), &quot;changed&quot;, G_CALLBACK(changed_cb), c);
+static void changed_cb(GtkTreeSelection * selection, gpointer data)
+{
 
-	gtk_box_pack_end(vbox, GTK_WIDGET(button), FALSE, FALSE, 0);
-	gtk_widget_show(button);
-	g_hash_table_insert(icon_spots, c, button);
-	
+    GaimConversation *c = (GaimConversation *) data;
+    GtkTreeIter iter;
+    GtkTreeModel *model;
+    gchar *name;
 
+    gtk_tree_selection_get_selected(selection, &amp;model, &amp;iter);
+    gtk_tree_model_get(model, &amp;iter, CHAT_USERS_NAME_COLUMN, &amp;name, -1);
+
+    gaim_debug_misc(&quot;chatsort&quot;, &quot;Click: %s\n&quot;, name);
+    gtk_button_set_label(g_hash_table_lookup(icon_spots, c), name);
+
+    GaimBuddyIcon *icon =
+        gaim_buddy_icons_find(gaim_conversation_get_account(c), name);
+    if (!icon) {
+
+        // This triggers a conversation window quickly, to trigger an icon 
+        // get.
+        GaimConversation *temp =
+            gaim_conversation_new(GAIM_CONV_IM,
+                                  gaim_conversation_get_account(c), name);
+        gaim_debug_misc(&quot;chaticon&quot;, &quot;Created temp conv %x\n&quot;, temp);
+        // gaim_conversation_destroy(temp);
+        g_hash_table_replace(pending_updates, c, temp);
+    } else {
+        gaym_gtkconv_update_buddy_icon(c, icon);
+    }
 }
 
+// This gets called BEFORE a chatlist is populated... just creates a new
+// type of chat window.
+static void redochatwindow(GaimConversation * c)
+{
 
-static gboolean plugin_load(GaimPlugin *plugin)
+    GtkTreeModel *oldls;
+
+    // Get a handle to the chat pane for the conversation
+    GaimGtkConversation *gtkconv = GAIM_GTK_CONVERSATION(c);
+    GaimGtkChatPane *gtkchat = gtkconv-&gt;u.chat;
+    GtkTreeSelection *select =
+        gtk_tree_view_get_selection(GTK_TREE_VIEW(gtkchat-&gt;list));
+    gtk_tree_selection_set_mode(select, GTK_SELECTION_SINGLE);
+
+    oldls = gtk_tree_view_get_model(GTK_TREE_VIEW(gtkchat-&gt;list));
+    GtkBox *vbox = GTK_BOX(gtkchat-&gt;list-&gt;parent-&gt;parent);
+
+    GtkWidget *button = gtk_button_new_with_label(&quot;A Button&quot;);
+    gtk_box_pack_end(vbox, GTK_WIDGET(button), FALSE, FALSE, 0);
+    gtk_widget_show(button);
+
+
+    g_signal_connect(G_OBJECT(select), &quot;changed&quot;, G_CALLBACK(changed_cb),
+                     c);
+
+    GaymChatIcon *icon_data = g_new0(GaymChatIcon, 1);
+
+    icon_data-&gt;icon_container_parent = GTK_WIDGET(vbox);
+    icon_data-&gt;icon_container = NULL;
+    icon_data-&gt;icon = NULL;
+    icon_data-&gt;anim = NULL;
+    icon_data-&gt;iter = NULL;
+    icon_data-&gt;show_icon = TRUE;
+
+    g_hash_table_insert(icon_spots, c, button);
+    g_hash_table_insert(icons, c, icon_data);
+
+}
+
+static gboolean check_for_update(gpointer * conversation,
+                                 const gpointer * temp, gpointer * icon)
 {
-	icons=g_hash_table_new(g_direct_hash, g_direct_equal);
-	icon_spots=g_hash_table_new(g_direct_hash, g_direct_equal);
-	
-	gaim_signal_connect(gaim_conversations_get_handle(), &quot;chat-joined&quot;, plugin, GAIM_CALLBACK(redochatwindow), NULL);
-	gaim_signal_connect(gaim_conversations_get_handle(), &quot;chat-buddy-left&quot;, plugin, GAIM_CALLBACK(clear_icon), NULL);
 
-	return TRUE;
+    g_return_val_if_fail(conversation != NULL, TRUE);
+    g_return_val_if_fail(temp != NULL, TRUE);
+    g_return_val_if_fail(icon != NULL, TRUE);
+
+    GaimBuddyIcon *bicon = (GaimBuddyIcon *) icon;
+    GaimConversation *c = (GaimConversation *) conversation;
+    GaimConversation *tempconv = (GaimConversation *) temp;
+
+
+    const gchar *name_needing_update =
+        gaim_conversation_get_name(tempconv);
+    gaim_debug_misc(&quot;chaticon&quot;,
+                    &quot;Conversation: %x, looked for name in %x, found %s\n&quot;,
+                    c, tempconv, name_needing_update);
+
+    g_return_val_if_fail(name_needing_update != NULL, FALSE);
+
+    if (!strcmp(gaim_buddy_icon_get_username(bicon), name_needing_update)) {
+        gaym_gtkconv_update_buddy_icon(c, bicon);
+        gaim_buddy_icon_ref(bicon);
+        gaim_conversation_destroy(tempconv);
+        return TRUE;
+    }
+    return TRUE;
 }
 
-static GaimPluginInfo info =
+static void icon_updated(GaimConnection * gc, GaimBuddyIcon * icon)
 {
-	GAIM_PLUGIN_MAGIC,
-	GAIM_MAJOR_VERSION,
-	GAIM_MINOR_VERSION,
-	GAIM_PLUGIN_STANDARD,
-	GAIM_GTK_PLUGIN_TYPE,
-	0,
-	NULL,
-	GAIM_PRIORITY_DEFAULT,
-	CHATSORT_PLUGIN_ID,
-	N_(&quot;Chatroom Icons&quot;),
-	VERSION,
-	N_(&quot;Shows user thumbnails below the names list in a chatroom.&quot;),
-	N_(&quot;Shows user thumbnails below the names list in a chatroom.&quot;),
-	&quot;Jason LeBrun &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/qrc-svn">gaim at jasonlebrun.info</A>&quot;,
-	GAIM_WEBSITE,
-	plugin_load,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL
+
+    g_return_if_fail(icon != NULL);
+    gaim_debug_misc(&quot;chaticon&quot;, &quot;Icon updated: (%x) %s\n&quot;, icon,
+                    gaim_buddy_icon_get_username(icon));
+    g_hash_table_foreach_remove(pending_updates,
+                                (GHRFunc) check_for_update, icon);
+
+}
+static gboolean plugin_load(GaimPlugin * plugin)
+{
+    icons = g_hash_table_new(g_direct_hash, g_direct_equal);
+    icon_spots = g_hash_table_new(g_direct_hash, g_direct_equal);
+    pending_updates = g_hash_table_new(g_direct_hash, g_direct_equal);
+
+    gaim_signal_connect(gaim_conversations_get_handle(), &quot;chat-joined&quot;,
+                        plugin, GAIM_CALLBACK(redochatwindow), NULL);
+    gaim_signal_connect(gaim_accounts_get_handle(), &quot;buddy-icon-fetched&quot;,
+                        plugin, GAIM_CALLBACK(icon_updated), NULL);
+
+    hider_window = gaim_conv_window_new();
+    // gaim_conv_window_hide(hider_window);
+    return TRUE;
+}
+
+static GaimPluginInfo info = {
+    GAIM_PLUGIN_MAGIC,
+    GAIM_MAJOR_VERSION,
+    GAIM_MINOR_VERSION,
+    GAIM_PLUGIN_STANDARD,
+    GAIM_GTK_PLUGIN_TYPE,
+    0,
+    NULL,
+    GAIM_PRIORITY_DEFAULT,
+    CHATSORT_PLUGIN_ID,
+    N_(&quot;Chatroom Icons&quot;),
+    VERSION,
+    N_(&quot;Shows user thumbnails below the names list in a chatroom.&quot;),
+    N_(&quot;Shows user thumbnails below the names list in a chatroom.&quot;),
+    &quot;Jason LeBrun &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/qrc-svn">gaim at jasonlebrun.info</A>&quot;,
+    GAIM_WEBSITE,
+    plugin_load,
+    NULL,
+    NULL,
+    NULL,
+    NULL,
+    NULL
 };
 
-static void
-init_plugin(GaimPlugin *plugin)
+static void init_plugin(GaimPlugin * plugin)
 {
 }
 

Modified: qrc/trunk/gaym-extras/roombrowse.c
===================================================================
--- qrc/trunk/gaym-extras/roombrowse.c	2005-07-24 00:15:50 UTC (rev 235)
+++ qrc/trunk/gaym-extras/roombrowse.c	2005-07-24 03:25:47 UTC (rev 236)
@@ -1,5 +1,5 @@
 /* Puts last 4k of log in new conversations a la Everybuddy (and then
- * stolen by Trillian &quot;Pro&quot;) */
+   stolen by Trillian &quot;Pro&quot;) */
 
 #include &quot;internal.h&quot;
 #include &quot;gtkgaim.h&quot;
@@ -34,20 +34,19 @@
 
 struct RoomBrowseInfo {
 
-	GaimAccount *account;
-	GaimConnection *gc;
+    GaimAccount *account;
+    GaimConnection *gc;
 };
-	
-static GtkWidget *
-setup_roombrowse_pane(GaimConversation *conv)
+
+static GtkWidget *setup_roombrowse_pane(GaimConversation * conv)
 {
-	GaimGtkConversation *gtkconv;
-	GaimGtkChatPane *gtkchat;
-	GaimConnection *gc;
-	GtkWidget *vpaned, *hpaned;
-	GtkWidget *vbox;
+    GaimGtkConversation *gtkconv;
+    GaimGtkChatPane *gtkchat;
+    GaimConnection *gc;
+    GtkWidget *vpaned, *hpaned;
+    GtkWidget *vbox;
 
-	/**
+        /**
 	 * Unused variables:
 	 *
 	 * GaimPluginProtocolInfo *prpl_info = NULL;
@@ -63,392 +62,403 @@
 	 * GList *focus_chain = NULL;
 	 */
 
-	gtkconv = GAIM_GTK_CONVERSATION(conv);
-	gtkchat = gtkconv-&gt;u.chat;
-	gc      = gaim_conversation_get_gc(conv);
+    gtkconv = GAIM_GTK_CONVERSATION(conv);
+    gtkchat = gtkconv-&gt;u.chat;
+    gc = gaim_conversation_get_gc(conv);
 
-	/* Setup the outer pane. */
-	vpaned = gtk_vpaned_new();
-	gtk_widget_show(vpaned);
-	/* Setup the top part of the pane. */
-	vbox = gtk_vbox_new(FALSE, 6);
-	gtk_paned_pack1(GTK_PANED(vpaned), vbox, TRUE, TRUE);
-	gtk_widget_show(vbox);
+    /* Setup the outer pane. */
+    vpaned = gtk_vpaned_new();
+    gtk_widget_show(vpaned);
+    /* Setup the top part of the pane. */
+    vbox = gtk_vbox_new(FALSE, 6);
+    gtk_paned_pack1(GTK_PANED(vpaned), vbox, TRUE, TRUE);
+    gtk_widget_show(vbox);
 
-	/* Setup the horizontal pane. */
-	hpaned = gtk_hpaned_new();
-	gtk_box_pack_start(GTK_BOX(vbox), hpaned, TRUE, TRUE, 0);
-	gtk_widget_show(hpaned);
+    /* Setup the horizontal pane. */
+    hpaned = gtk_hpaned_new();
+    gtk_box_pack_start(GTK_BOX(vbox), hpaned, TRUE, TRUE, 0);
+    gtk_widget_show(hpaned);
 
-	/* Setup the scrolled window to put gtkimhtml in. */
-	gtkconv-&gt;sw = gtk_scrolled_window_new(NULL, NULL);
-	gtk_scrolled_window_set_policy(GTK_SCROLLED_WINDOW(gtkconv-&gt;sw),
-								   GTK_POLICY_AUTOMATIC, GTK_POLICY_ALWAYS);
-	gtk_scrolled_window_set_shadow_type(GTK_SCROLLED_WINDOW(gtkconv-&gt;sw),
-										GTK_SHADOW_IN);
-	gtk_paned_pack1(GTK_PANED(hpaned), gtkconv-&gt;sw, TRUE, TRUE);
+    /* Setup the scrolled window to put gtkimhtml in. */
+    gtkconv-&gt;sw = gtk_scrolled_window_new(NULL, NULL);
+    gtk_scrolled_window_set_policy(GTK_SCROLLED_WINDOW(gtkconv-&gt;sw),
+                                   GTK_POLICY_AUTOMATIC,
+                                   GTK_POLICY_ALWAYS);
+    gtk_scrolled_window_set_shadow_type(GTK_SCROLLED_WINDOW(gtkconv-&gt;sw),
+                                        GTK_SHADOW_IN);
+    gtk_paned_pack1(GTK_PANED(hpaned), gtkconv-&gt;sw, TRUE, TRUE);
 
-	gtk_widget_set_size_request(gtkconv-&gt;sw,
-			gaim_prefs_get_int(&quot;/gaim/gtk/conversations/chat/default_width&quot;),
-			gaim_prefs_get_int(&quot;/gaim/gtk/conversations/chat/default_height&quot;));
+    gtk_widget_set_size_request(gtkconv-&gt;sw,
+                                gaim_prefs_get_int
+                                (&quot;/gaim/gtk/conversations/chat/default_width&quot;),
+                                gaim_prefs_get_int
+                                (&quot;/gaim/gtk/conversations/chat/default_height&quot;));
 
-//	g_signal_connect(G_OBJECT(gtkconv-&gt;sw), &quot;size-allocate&quot;,
-//					 G_CALLBACK(size_allocate_cb), conv);
+    // g_signal_connect(G_OBJECT(gtkconv-&gt;sw), &quot;size-allocate&quot;,
+    // G_CALLBACK(size_allocate_cb), conv);
 
-	gtk_widget_show(gtkconv-&gt;sw);
+    gtk_widget_show(gtkconv-&gt;sw);
 
-	return vpaned;
+    return vpaned;
 }
 
-static gint
-close_conv_cb(GtkWidget *w, gpointer d)
+static gint close_conv_cb(GtkWidget * w, gpointer d)
 {
-        GaimConversation *conv = (GaimConversation *)d;
-	
-        gaim_conversation_destroy(conv);
+    GaimConversation *conv = (GaimConversation *) d;
 
-        return TRUE;
+    gaim_conversation_destroy(conv);
+
+    return TRUE;
 }
-GdkPixbuf* get_tab_icon(GaimConversation *conv, gboolean small_icon)
+
+GdkPixbuf *get_tab_icon(GaimConversation * conv, gboolean small_icon)
 {
-        GaimAccount *account = NULL;
-        const char *name = NULL;
-        GdkPixbuf *status = NULL;
+    GaimAccount *account = NULL;
+    const char *name = NULL;
+    GdkPixbuf *status = NULL;
 
-        g_return_val_if_fail( conv != NULL, NULL);
+    g_return_val_if_fail(conv != NULL, NULL);
 
-        account = gaim_conversation_get_account(conv);
-        name = gaim_conversation_get_name(conv);
+    account = gaim_conversation_get_account(conv);
+    name = gaim_conversation_get_name(conv);
 
-        g_return_val_if_fail( account != NULL, NULL);
-        g_return_val_if_fail( name != NULL, NULL);
+    g_return_val_if_fail(account != NULL, NULL);
+    g_return_val_if_fail(name != NULL, NULL);
 
 
-        if (gaim_conversation_get_type(conv) == GAIM_CONV_IM) {
-                GaimBuddy *b = gaim_find_buddy(account, name);
-                if (b != NULL) {
-                        status = gaim_gtk_blist_get_status_icon((GaimBlistNode*)b,
-                                (small_icon ? GAIM_STATUS_ICON_SMALL : GAIM_STATUS_ICON_LARGE));
-                }
+    if (gaim_conversation_get_type(conv) == GAIM_CONV_IM) {
+        GaimBuddy *b = gaim_find_buddy(account, name);
+        if (b != NULL) {
+            status = gaim_gtk_blist_get_status_icon((GaimBlistNode *) b,
+                                                    (small_icon ?
+                                                     GAIM_STATUS_ICON_SMALL
+                                                     :
+                                                     GAIM_STATUS_ICON_LARGE));
         }
+    }
 
-        if (!status) {
-                GdkPixbuf *pixbuf;
-                pixbuf = create_prpl_icon(account);
+    if (!status) {
+        GdkPixbuf *pixbuf;
+        pixbuf = create_prpl_icon(account);
 
-                if (small_icon &amp;&amp; pixbuf != NULL)
-                {
-                        status = gdk_pixbuf_scale_simple(pixbuf, 15, 15,
-                                        GDK_INTERP_BILINEAR);
-                        g_object_unref(pixbuf);
-                }
-                else
-                        status = pixbuf;
-        }
- return status;
+        if (small_icon &amp;&amp; pixbuf != NULL) {
+            status = gdk_pixbuf_scale_simple(pixbuf, 15, 15,
+                                             GDK_INTERP_BILINEAR);
+            g_object_unref(pixbuf);
+        } else
+            status = pixbuf;
+    }
+    return status;
 }
 
 /**
  * Unused function
  */
 #if 0
-static void
-update_tab_icon(GaimConversation *conv)
+static void update_tab_icon(GaimConversation * conv)
 {
-        GaimGtkConversation *gtkconv;
-        GaimConvWindow *win = gaim_conversation_get_window(conv);
-        GaimAccount *account;
-        const char *name;
-        GdkPixbuf *status = NULL;
+    GaimGtkConversation *gtkconv;
+    GaimConvWindow *win = gaim_conversation_get_window(conv);
+    GaimAccount *account;
+    const char *name;
+    GdkPixbuf *status = NULL;
 
-        g_return_if_fail(conv != NULL);
+    g_return_if_fail(conv != NULL);
 
-        gtkconv = GAIM_GTK_CONVERSATION(conv);
-        name = gaim_conversation_get_name(conv);
-        account = gaim_conversation_get_account(conv);
+    gtkconv = GAIM_GTK_CONVERSATION(conv);
+    name = gaim_conversation_get_name(conv);
+    account = gaim_conversation_get_account(conv);
 
-        status = get_tab_icon(conv, TRUE);
+    status = get_tab_icon(conv, TRUE);
 
-        g_return_if_fail(status != NULL);
+    g_return_if_fail(status != NULL);
 
-        gtk_image_set_from_pixbuf(GTK_IMAGE(gtkconv-&gt;icon), status);
-        gtk_image_set_from_pixbuf(GTK_IMAGE(gtkconv-&gt;menu_icon), status);
+    gtk_image_set_from_pixbuf(GTK_IMAGE(gtkconv-&gt;icon), status);
+    gtk_image_set_from_pixbuf(GTK_IMAGE(gtkconv-&gt;menu_icon), status);
 
-        if (status != NULL)
-                g_object_unref(status);
+    if (status != NULL)
+        g_object_unref(status);
 
-        if (gaim_conv_window_get_active_conversation(win) == conv &amp;&amp;
-                gtkconv-&gt;u.im-&gt;anim == NULL)
-        {
-                status = get_tab_icon(conv, FALSE);
+    if (gaim_conv_window_get_active_conversation(win) == conv &amp;&amp;
+        gtkconv-&gt;u.im-&gt;anim == NULL) {
+        status = get_tab_icon(conv, FALSE);
 
-                gtk_window_set_icon(GTK_WINDOW(GAIM_GTK_WINDOW(win)-&gt;window), status);
+        gtk_window_set_icon(GTK_WINDOW(GAIM_GTK_WINDOW(win)-&gt;window),
+                            status);
 
-                if (status != NULL)
-                        g_object_unref(status);
-        }
+        if (status != NULL)
+            g_object_unref(status);
+    }
 }
 #endif
 
 /* Courtesy of Galeon! */
 static void
-tab_close_button_state_changed_cb(GtkWidget *widget, GtkStateType prev_state)
+tab_close_button_state_changed_cb(GtkWidget * widget,
+                                  GtkStateType prev_state)
 {
-        if (GTK_WIDGET_STATE(widget) == GTK_STATE_ACTIVE)
-                gtk_widget_set_state(widget, GTK_STATE_NORMAL);
+    if (GTK_WIDGET_STATE(widget) == GTK_STATE_ACTIVE)
+        gtk_widget_set_state(widget, GTK_STATE_NORMAL);
 }
 
 static void
-roombrowse_gtk_add_conversation(GaimConvWindow *win, GaimConversation *conv)
+roombrowse_gtk_add_conversation(GaimConvWindow * win,
+                                GaimConversation * conv)
 {
-	GaimGtkWindow *gtkwin;
-	GaimGtkConversation *gtkconv, *focus_gtkconv;
-	GaimConversation *focus_conv;
-	GtkWidget *pane = NULL;
-	GtkWidget *tab_cont;
-	GtkWidget *tabby, *menu_tabby;
-	GtkWidget *close_image;
-	gboolean new_ui;
-	GaimConversationType conv_type;
-	const char *name;
+    GaimGtkWindow *gtkwin;
+    GaimGtkConversation *gtkconv, *focus_gtkconv;
+    GaimConversation *focus_conv;
+    GtkWidget *pane = NULL;
+    GtkWidget *tab_cont;
+    GtkWidget *tabby, *menu_tabby;
+    GtkWidget *close_image;
+    gboolean new_ui;
+    GaimConversationType conv_type;
+    const char *name;
 
-	name      = gaim_conversation_get_name(conv);
-	conv_type = gaim_conversation_get_type(conv);
-	gtkwin    = GAIM_GTK_WINDOW(win);
+    name = gaim_conversation_get_name(conv);
+    conv_type = gaim_conversation_get_type(conv);
+    gtkwin = GAIM_GTK_WINDOW(win);
 
-	if (conv-&gt;ui_data != NULL) {
-		gtkconv = (GaimGtkConversation *)conv-&gt;ui_data;
+    if (conv-&gt;ui_data != NULL) {
+        gtkconv = (GaimGtkConversation *) conv-&gt;ui_data;
 
-		tab_cont = gtkconv-&gt;tab_cont;
+        tab_cont = gtkconv-&gt;tab_cont;
 
-		new_ui = FALSE;
-	}
-	else {
-		gtkconv = g_malloc0(sizeof(GaimGtkConversation));
-		conv-&gt;ui_data = gtkconv;
+        new_ui = FALSE;
+    } else {
+        gtkconv = g_malloc0(sizeof(GaimGtkConversation));
+        conv-&gt;ui_data = gtkconv;
 
-		/* Setup some initial variables. */
-		gtkconv-&gt;sg       = gtk_size_group_new(GTK_SIZE_GROUP_BOTH);
-		gtkconv-&gt;tooltips = gtk_tooltips_new();
+        /* Setup some initial variables. */
+        gtkconv-&gt;sg = gtk_size_group_new(GTK_SIZE_GROUP_BOTH);
+        gtkconv-&gt;tooltips = gtk_tooltips_new();
 
-	gaim_debug_misc(&quot;roombrowse&quot;,&quot;setting up pane\n&quot;);	
-		pane = setup_roombrowse_pane(conv);
-		
-	gaim_debug_misc(&quot;roombrowse&quot;,&quot;set up pane\n&quot;);	
+        gaim_debug_misc(&quot;roombrowse&quot;, &quot;setting up pane\n&quot;);
+        pane = setup_roombrowse_pane(conv);
 
-		if (pane == NULL) {
-			g_free(gtkconv);
-			conv-&gt;ui_data = NULL;
+        gaim_debug_misc(&quot;roombrowse&quot;, &quot;set up pane\n&quot;);
 
-			return;
-		}
+        if (pane == NULL) {
+            g_free(gtkconv);
+            conv-&gt;ui_data = NULL;
 
-		
-		
-		/* Setup the container for the tab. */
-		gtkconv-&gt;tab_cont = tab_cont = gtk_vbox_new(FALSE, 6);
-		gtk_container_set_border_width(GTK_CONTAINER(tab_cont), 6);
-		gtk_container_add(GTK_CONTAINER(tab_cont), pane);
-		gtk_widget_show(pane);
+            return;
+        }
 
-		new_ui = TRUE;
 
-		gtkconv-&gt;make_sound = FALSE;
-		gtkconv-&gt;show_formatting_toolbar = FALSE;
-		gtkconv-&gt;show_timestamps = FALSE;
-		
-		g_signal_connect_swapped(G_OBJECT(pane), &quot;focus&quot;,
-					 G_CALLBACK(gtk_widget_grab_focus),
-					 gtkconv-&gt;entry);
-	}
 
-	gaim_debug_misc(&quot;roombrowse&quot;,&quot;Setting up tabs\n&quot;);
-	gtkconv-&gt;tabby = tabby = gtk_hbox_new(FALSE, 6);
-        gtkconv-&gt;menu_tabby = menu_tabby = gtk_hbox_new(FALSE, 6);
-	gtkconv-&gt;entry = gtk_imhtml_new(NULL, NULL);
-		gtkconv-&gt;toolbar = gtk_imhtmltoolbar_new();
+        /* Setup the container for the tab. */
+        gtkconv-&gt;tab_cont = tab_cont = gtk_vbox_new(FALSE, 6);
+        gtk_container_set_border_width(GTK_CONTAINER(tab_cont), 6);
+        gtk_container_add(GTK_CONTAINER(tab_cont), pane);
+        gtk_widget_show(pane);
 
-	gaim_debug_misc(&quot;roombrowse&quot;,&quot;Setting up close button\n&quot;);
-	/* Close button. */
-	gtkconv-&gt;close = gtk_button_new();
-	gtk_widget_set_size_request(GTK_WIDGET(gtkconv-&gt;close), 16, 16);
-	gtk_button_set_relief(GTK_BUTTON(gtkconv-&gt;close), GTK_RELIEF_NONE);
-	close_image = gtk_image_new_from_stock(GTK_STOCK_CLOSE, GTK_ICON_SIZE_MENU);
-	gtk_widget_show(close_image);
-	gtk_container_add(GTK_CONTAINER(gtkconv-&gt;close), close_image);
-	gtk_tooltips_set_tip(gtkconv-&gt;tooltips, gtkconv-&gt;close,
-			     _(&quot;Close conversation&quot;), NULL);
+        new_ui = TRUE;
 
-	g_signal_connect(G_OBJECT(gtkconv-&gt;close), &quot;clicked&quot;,
-		 G_CALLBACK(close_conv_cb), conv);
+        gtkconv-&gt;make_sound = FALSE;
+        gtkconv-&gt;show_formatting_toolbar = FALSE;
+        gtkconv-&gt;show_timestamps = FALSE;
 
-	/*
-	* I love Galeon. They have a fix for that stupid annoying visible
-	* border bug. I love you guys! -- ChipX86
-	*/
-	g_signal_connect(G_OBJECT(gtkconv-&gt;close), &quot;state_changed&quot;,
-			 G_CALLBACK(tab_close_button_state_changed_cb), NULL);
+        g_signal_connect_swapped(G_OBJECT(pane), &quot;focus&quot;,
+                                 G_CALLBACK(gtk_widget_grab_focus),
+                                 gtkconv-&gt;entry);
+    }
 
-	/* Status icon. */
-	gtkconv-&gt;icon = gtk_image_new();
-	gtkconv-&gt;menu_icon = gtk_image_new();
-//	update_tab_icon(conv);
+    gaim_debug_misc(&quot;roombrowse&quot;, &quot;Setting up tabs\n&quot;);
+    gtkconv-&gt;tabby = tabby = gtk_hbox_new(FALSE, 6);
+    gtkconv-&gt;menu_tabby = menu_tabby = gtk_hbox_new(FALSE, 6);
+    gtkconv-&gt;entry = gtk_imhtml_new(NULL, NULL);
+    gtkconv-&gt;toolbar = gtk_imhtmltoolbar_new();
 
-	/* Tab label. */
-	gtkconv-&gt;tab_label = gtk_label_new(gaim_conversation_get_title(conv));
-	gtkconv-&gt;menu_label = gtk_label_new(gaim_conversation_get_title(conv));
+    gaim_debug_misc(&quot;roombrowse&quot;, &quot;Setting up close button\n&quot;);
+    /* Close button. */
+    gtkconv-&gt;close = gtk_button_new();
+    gtk_widget_set_size_request(GTK_WIDGET(gtkconv-&gt;close), 16, 16);
+    gtk_button_set_relief(GTK_BUTTON(gtkconv-&gt;close), GTK_RELIEF_NONE);
+    close_image =
+        gtk_image_new_from_stock(GTK_STOCK_CLOSE, GTK_ICON_SIZE_MENU);
+    gtk_widget_show(close_image);
+    gtk_container_add(GTK_CONTAINER(gtkconv-&gt;close), close_image);
+    gtk_tooltips_set_tip(gtkconv-&gt;tooltips, gtkconv-&gt;close,
+                         _(&quot;Close conversation&quot;), NULL);
+
+    g_signal_connect(G_OBJECT(gtkconv-&gt;close), &quot;clicked&quot;,
+                     G_CALLBACK(close_conv_cb), conv);
+
+    /* 
+     * I love Galeon. They have a fix for that stupid annoying visible
+     * border bug. I love you guys! -- ChipX86
+     */
+    g_signal_connect(G_OBJECT(gtkconv-&gt;close), &quot;state_changed&quot;,
+                     G_CALLBACK(tab_close_button_state_changed_cb), NULL);
+
+    /* Status icon. */
+    gtkconv-&gt;icon = gtk_image_new();
+    gtkconv-&gt;menu_icon = gtk_image_new();
+    // update_tab_icon(conv);
+
+    /* Tab label. */
+    gtkconv-&gt;tab_label = gtk_label_new(gaim_conversation_get_title(conv));
+    gtkconv-&gt;menu_label = gtk_label_new(gaim_conversation_get_title(conv));
 #if 0
-	gtk_misc_set_alignment(GTK_MISC(gtkconv-&gt;tab_label), 0.00, 0.5);
-	gtk_misc_set_padding(GTK_MISC(gtkconv-&gt;tab_label), 4, 0);
+    gtk_misc_set_alignment(GTK_MISC(gtkconv-&gt;tab_label), 0.00, 0.5);
+    gtk_misc_set_padding(GTK_MISC(gtkconv-&gt;tab_label), 4, 0);
 #endif
 
-	gaim_debug_misc(&quot;roombrowse&quot;,&quot;Packing\n&quot;);
-	/* Pack it all together. */
-	gtk_box_pack_start(GTK_BOX(tabby), gtkconv-&gt;icon, FALSE, FALSE, 0);
-	gtk_box_pack_start(GTK_BOX(menu_tabby), gtkconv-&gt;menu_icon,
-			   FALSE, FALSE, 0);
+    gaim_debug_misc(&quot;roombrowse&quot;, &quot;Packing\n&quot;);
+    /* Pack it all together. */
+    gtk_box_pack_start(GTK_BOX(tabby), gtkconv-&gt;icon, FALSE, FALSE, 0);
+    gtk_box_pack_start(GTK_BOX(menu_tabby), gtkconv-&gt;menu_icon,
+                       FALSE, FALSE, 0);
 
-	gtk_widget_show_all(gtkconv-&gt;icon);
-	gtk_widget_show_all(gtkconv-&gt;menu_icon);
+    gtk_widget_show_all(gtkconv-&gt;icon);
+    gtk_widget_show_all(gtkconv-&gt;menu_icon);
 
-	gtk_box_pack_start(GTK_BOX(tabby), gtkconv-&gt;tab_label, TRUE, TRUE, 0);
-	gtk_box_pack_start(GTK_BOX(menu_tabby), gtkconv-&gt;menu_label, TRUE, TRUE, 0);
-	gtk_widget_show(gtkconv-&gt;tab_label);
-	gtk_widget_show(gtkconv-&gt;menu_label);
-	gtk_misc_set_alignment(GTK_MISC(gtkconv-&gt;menu_label), 0, 0);
+    gtk_box_pack_start(GTK_BOX(tabby), gtkconv-&gt;tab_label, TRUE, TRUE, 0);
+    gtk_box_pack_start(GTK_BOX(menu_tabby), gtkconv-&gt;menu_label, TRUE,
+                       TRUE, 0);
+    gtk_widget_show(gtkconv-&gt;tab_label);
+    gtk_widget_show(gtkconv-&gt;menu_label);
+    gtk_misc_set_alignment(GTK_MISC(gtkconv-&gt;menu_label), 0, 0);
 
-	gtk_box_pack_start(GTK_BOX(tabby), gtkconv-&gt;close, FALSE, FALSE, 0);
-	if (gaim_prefs_get_bool(&quot;/gaim/gtk/conversations/close_on_tabs&quot;))
-		gtk_widget_show(gtkconv-&gt;close);
+    gtk_box_pack_start(GTK_BOX(tabby), gtkconv-&gt;close, FALSE, FALSE, 0);
+    if (gaim_prefs_get_bool(&quot;/gaim/gtk/conversations/close_on_tabs&quot;))
+        gtk_widget_show(gtkconv-&gt;close);
 
-	gtk_widget_show(tabby);
-	gtk_widget_show(menu_tabby);
+    gtk_widget_show(tabby);
+    gtk_widget_show(menu_tabby);
 
-	if (gaim_conversation_get_type(conv) == GAIM_CONV_IM)
-		gaim_gtkconv_update_buddy_icon(conv);
+    if (gaim_conversation_get_type(conv) == GAIM_CONV_IM)
+        gaim_gtkconv_update_buddy_icon(conv);
 
-	gaim_debug_misc(&quot;roombrowse&quot;,&quot;Adding to notebook\n&quot;);
-	gaim_debug_misc(&quot;roombrowse&quot;,&quot;gtkwin-&gt;notebook=%x\n&quot;,gtkwin-&gt;notebook);
-	gaim_debug_misc(&quot;roombrowse&quot;,&quot;gtkwin=%x\n&quot;,gtkwin);
-	gaim_debug_misc(&quot;roombrowse&quot;,&quot;tabby=%x\n&quot;,tabby);
-	gaim_debug_misc(&quot;roombrowse&quot;,&quot;menu_tabby=%x\n&quot;,menu_tabby);
-	gaim_debug_misc(&quot;roombrowse&quot;,&quot;tab_cont=%x\n&quot;,tab_cont);
+    gaim_debug_misc(&quot;roombrowse&quot;, &quot;Adding to notebook\n&quot;);
+    gaim_debug_misc(&quot;roombrowse&quot;, &quot;gtkwin-&gt;notebook=%x\n&quot;,
+                    gtkwin-&gt;notebook);
+    gaim_debug_misc(&quot;roombrowse&quot;, &quot;gtkwin=%x\n&quot;, gtkwin);
+    gaim_debug_misc(&quot;roombrowse&quot;, &quot;tabby=%x\n&quot;, tabby);
+    gaim_debug_misc(&quot;roombrowse&quot;, &quot;menu_tabby=%x\n&quot;, menu_tabby);
+    gaim_debug_misc(&quot;roombrowse&quot;, &quot;tab_cont=%x\n&quot;, tab_cont);
 
-	/* Add this pane to the conversation's notebook. */
-	int n=	gtk_notebook_get_n_pages(GTK_NOTEBOOK(gtkwin-&gt;notebook));
-	gaim_debug_misc(&quot;roombrowse:&quot;,&quot;Notebook has %d pages\n&quot;,n);
-	gtk_notebook_append_page_menu(GTK_NOTEBOOK(gtkwin-&gt;notebook), tab_cont, tabby, menu_tabby);
-	gaim_debug_misc(&quot;roombrowse&quot;,&quot;Got through append_page_menu\n&quot;);
-	gtk_widget_show(tab_cont);
-	
-	if (gaim_conv_window_get_conversation_count(win) == 1) {
-		/* Er, bug in notebooks? Switch to the page manually. */
-		gtk_notebook_set_current_page(GTK_NOTEBOOK(gtkwin-&gt;notebook), 0);
+    /* Add this pane to the conversation's notebook. */
+    int n = gtk_notebook_get_n_pages(GTK_NOTEBOOK(gtkwin-&gt;notebook));
+    gaim_debug_misc(&quot;roombrowse:&quot;, &quot;Notebook has %d pages\n&quot;, n);
+    gtk_notebook_append_page_menu(GTK_NOTEBOOK(gtkwin-&gt;notebook), tab_cont,
+                                  tabby, menu_tabby);
+    gaim_debug_misc(&quot;roombrowse&quot;, &quot;Got through append_page_menu\n&quot;);
+    gtk_widget_show(tab_cont);
 
-		gtk_notebook_set_show_tabs(GTK_NOTEBOOK(gtkwin-&gt;notebook),
-					   gaim_prefs_get_bool(&quot;/gaim/gtk/conversations/tabs&quot;));
-	}
-	else
-		gtk_notebook_set_show_tabs(GTK_NOTEBOOK(gtkwin-&gt;notebook), TRUE);
-	gaim_debug_misc(&quot;roombrowse&quot;,&quot;FOcus stuff\n&quot;);
-	focus_conv = g_list_nth_data(gaim_conv_window_get_conversations(win),
-				     gtk_notebook_get_current_page(GTK_NOTEBOOK(gtkwin-&gt;notebook)));
-	focus_gtkconv = GAIM_GTK_CONVERSATION(focus_conv);
-	gtk_widget_grab_focus(focus_gtkconv-&gt;entry);
+    if (gaim_conv_window_get_conversation_count(win) == 1) {
+        /* Er, bug in notebooks? Switch to the page manually. */
+        gtk_notebook_set_current_page(GTK_NOTEBOOK(gtkwin-&gt;notebook), 0);
 
-	if (!new_ui)
-		g_object_unref(gtkconv-&gt;tab_cont);
+        gtk_notebook_set_show_tabs(GTK_NOTEBOOK(gtkwin-&gt;notebook),
+                                   gaim_prefs_get_bool
+                                   (&quot;/gaim/gtk/conversations/tabs&quot;));
+    } else
+        gtk_notebook_set_show_tabs(GTK_NOTEBOOK(gtkwin-&gt;notebook), TRUE);
+    gaim_debug_misc(&quot;roombrowse&quot;, &quot;FOcus stuff\n&quot;);
+    focus_conv = g_list_nth_data(gaim_conv_window_get_conversations(win),
+                                 gtk_notebook_get_current_page(GTK_NOTEBOOK
+                                                               (gtkwin-&gt;
+                                                                notebook)));
+    focus_gtkconv = GAIM_GTK_CONVERSATION(focus_conv);
+    gtk_widget_grab_focus(focus_gtkconv-&gt;entry);
+
+    if (!new_ui)
+        g_object_unref(gtkconv-&gt;tab_cont);
 }
 
 
-static void roombrowse_menu_cb(GaimBlistNode* node, gpointer data) {
-	GaimConvWindow *win=gaim_get_first_window_with_type(GAIM_CONV_MISC);
-	GaimConversation *conv=g_new0(GaimConversation, 1);
+static void roombrowse_menu_cb(GaimBlistNode * node, gpointer data)
+{
+    GaimConvWindow *win = gaim_get_first_window_with_type(GAIM_CONV_MISC);
+    GaimConversation *conv = g_new0(GaimConversation, 1);
 
-	GaimAccount* account=((GaimChat*)node)-&gt;account;
-	if(!win)
-		win=gaim_conv_window_new();
-	GaimChat* chat = ((GaimChat*)node);
-	char *room= g_strdup(g_hash_table_lookup(chat-&gt;components,&quot;name&quot;));
+    GaimAccount *account = ((GaimChat *) node)-&gt;account;
+    if (!win)
+        win = gaim_conv_window_new();
+    GaimChat *chat = ((GaimChat *) node);
+    char *room = g_strdup(g_hash_table_lookup(chat-&gt;components, &quot;name&quot;));
 
-	
-	gaim_debug_misc(&quot;roombrowser&quot;,&quot;In cb with node=%x, account=%x\n&quot;,node,account);
-	conv=gaim_conversation_new(GAIM_CONV_MISC, account, room);
-	
-	gaim_conversation_set_logging(conv, FALSE);
-		
-	roombrowse_gtk_add_conversation(conv-&gt;window, conv);
-	gaim_conv_window_show(conv-&gt;window);
 
-	g_free(room);
-	
+    gaim_debug_misc(&quot;roombrowser&quot;, &quot;In cb with node=%x, account=%x\n&quot;,
+                    node, account);
+    conv = gaim_conversation_new(GAIM_CONV_MISC, account, room);
+
+    gaim_conversation_set_logging(conv, FALSE);
+
+    roombrowse_gtk_add_conversation(conv-&gt;window, conv);
+    gaim_conv_window_show(conv-&gt;window);
+
+    g_free(room);
+
 }
-static void roombrowse_menu_create(GaimBlistNode *node, GList **menu)
+static void roombrowse_menu_create(GaimBlistNode * node, GList ** menu)
 {
-  
-	char *label,*room;	
-  
-	struct gaym_conn *gaym;
-	GaimChat *chat=(GaimChat*)node;
-  
-	gaim_debug_misc(&quot;roombrowse&quot;,&quot;In callback\n&quot;);
-	if(node-&gt;type != GAIM_BLIST_CHAT_NODE)
-		return;
-  
-	gaym=chat-&gt;account-&gt;gc-&gt;proto_data;
-  
-	room=g_strdup(g_hash_table_lookup(chat-&gt;components,&quot;name&quot;));
-	gaim_debug_misc(&quot;roombrowse&quot;,&quot;Room name: %s\n&quot;,room);
-	if(!room)
-		return;
-  
-    
-		label = g_strdup_printf(&quot;Lurk in %s&quot;,room);
-		GaimBlistNodeAction* act=gaim_blist_node_action_new(label,
-				roombrowse_menu_cb,
-				chat-&gt;account);
-  
-		*menu=g_list_append(*menu,act);
-    //g_free(label);
+
+    char *label, *room;
+
+    struct gaym_conn *gaym;
+    GaimChat *chat = (GaimChat *) node;
+
+    gaim_debug_misc(&quot;roombrowse&quot;, &quot;In callback\n&quot;);
+    if (node-&gt;type != GAIM_BLIST_CHAT_NODE)
+        return;
+
+    gaym = chat-&gt;account-&gt;gc-&gt;proto_data;
+
+    room = g_strdup(g_hash_table_lookup(chat-&gt;components, &quot;name&quot;));
+    gaim_debug_misc(&quot;roombrowse&quot;, &quot;Room name: %s\n&quot;, room);
+    if (!room)
+        return;
+
+
+    label = g_strdup_printf(&quot;Lurk in %s&quot;, room);
+    GaimBlistNodeAction *act = gaim_blist_node_action_new(label,
+                                                          roombrowse_menu_cb,
+                                                          chat-&gt;account);
+
+    *menu = g_list_append(*menu, act);
+    // g_free(label);
 }
-static gboolean plugin_load(GaimPlugin *plugin)
+static gboolean plugin_load(GaimPlugin * plugin)
 {
-	gaim_signal_connect(gaim_blist_get_handle(),
-						&quot;blist-node-extended-menu&quot;,
-						plugin, GAIM_CALLBACK(roombrowse_menu_create), NULL);
+    gaim_signal_connect(gaim_blist_get_handle(),
+                        &quot;blist-node-extended-menu&quot;,
+                        plugin, GAIM_CALLBACK(roombrowse_menu_create),
+                        NULL);
 
-	
-	gaim_debug_misc(&quot;roombrowse&quot;,&quot;Callback registered!\n&quot;);	
-	return TRUE;
+
+    gaim_debug_misc(&quot;roombrowse&quot;, &quot;Callback registered!\n&quot;);
+    return TRUE;
 }
 
-static GaimPluginInfo info =
-{
-	GAIM_PLUGIN_MAGIC,
-	GAIM_MAJOR_VERSION,
-	GAIM_MINOR_VERSION,
-	GAIM_PLUGIN_STANDARD,
-	GAIM_GTK_PLUGIN_TYPE,
-	0,
-	NULL,
-	GAIM_PRIORITY_DEFAULT,
-	CHATSORT_PLUGIN_ID,
-	N_(&quot;Gay.Com Room Browser&quot;),
-	VERSION,
-	N_(&quot;Browse rooms in gay.com&quot;),
-	N_(&quot;Adds a right-click item to context menu.&quot;),
-	&quot;Jason LeBrun &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/qrc-svn">gaim at jasonlebrun.info</A>&quot;,
-	GAIM_WEBSITE,
-	plugin_load,
-	NULL,
-	NULL,
-	NULL,
-	NULL,
-	NULL
+static GaimPluginInfo info = {
+    GAIM_PLUGIN_MAGIC,
+    GAIM_MAJOR_VERSION,
+    GAIM_MINOR_VERSION,
+    GAIM_PLUGIN_STANDARD,
+    GAIM_GTK_PLUGIN_TYPE,
+    0,
+    NULL,
+    GAIM_PRIORITY_DEFAULT,
+    CHATSORT_PLUGIN_ID,
+    N_(&quot;Gay.Com Room Browser&quot;),
+    VERSION,
+    N_(&quot;Browse rooms in gay.com&quot;),
+    N_(&quot;Adds a right-click item to context menu.&quot;),
+    &quot;Jason LeBrun &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/qrc-svn">gaim at jasonlebrun.info</A>&quot;,
+    GAIM_WEBSITE,
+    plugin_load,
+    NULL,
+    NULL,
+    NULL,
+    NULL,
+    NULL
 };
 
-static void
-init_plugin(GaimPlugin *plugin)
+static void init_plugin(GaimPlugin * plugin)
 {
 }
 


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000165.html">[Qrc-svn] r235 - qrc/trunk/gaym/src
</A></li>
	<LI>Next message: <A HREF="000167.html">[Qrc-svn] r237 - in qrc/trunk: gaym/src gaym-extras
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#166">[ date ]</a>
              <a href="thread.html#166">[ thread ]</a>
              <a href="subject.html#166">[ subject ]</a>
              <a href="author.html#166">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/qrc-svn">More information about the Qrc-svn
mailing list</a><br>
</body></html>
