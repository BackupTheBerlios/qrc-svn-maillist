<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Qrc-svn] r264 - in qrc/tags: . release-0.9/gaym/src release-0.9/gaym-extras/src release-0.9/nsis
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/qrc-svn/2005-July/index.html" >
   <LINK REL="made" HREF="mailto:qrc-svn%40lists.berlios.de?Subject=Re%3A%20%5BQrc-svn%5D%20r264%20-%20in%20qrc/tags%3A%20.%20release-0.9/gaym/src%20release-0.9/gaym-extras/src%20release-0.9/nsis&In-Reply-To=%3C200507311913.j6VJDUqB023067%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000193.html">
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Qrc-svn] r264 - in qrc/tags: . release-0.9/gaym/src release-0.9/gaym-extras/src release-0.9/nsis</H1>
    <B>Jason LeBrun at BerliOS</B> 
    <A HREF="mailto:qrc-svn%40lists.berlios.de?Subject=Re%3A%20%5BQrc-svn%5D%20r264%20-%20in%20qrc/tags%3A%20.%20release-0.9/gaym/src%20release-0.9/gaym-extras/src%20release-0.9/nsis&In-Reply-To=%3C200507311913.j6VJDUqB023067%40sheep.berlios.de%3E"
       TITLE="[Qrc-svn] r264 - in qrc/tags: . release-0.9/gaym/src release-0.9/gaym-extras/src release-0.9/nsis">jblebrun at berlios.de
       </A><BR>
    <I>Sun Jul 31 21:13:30 CEST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="000193.html">[Qrc-svn] r263 - in qrc/branches: . buddy_icon_hack/gaym/src buddy_icon_hack/gaym-extras/src buddy_icon_hack/nsis
</A></li>
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#194">[ date ]</a>
              <a href="thread.html#194">[ thread ]</a>
              <a href="subject.html#194">[ subject ]</a>
              <a href="author.html#194">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: jblebrun
Date: 2005-07-31 21:13:29 +0200 (Sun, 31 Jul 2005)
New Revision: 264

Added:
   qrc/tags/release-0.9/
   qrc/tags/release-0.9/gaym-extras/src/bio-popups.c
   qrc/tags/release-0.9/gaym-extras/src/gaym-extras.c
   qrc/tags/release-0.9/gaym-extras/src/roombrowse.c
   qrc/tags/release-0.9/gaym/src/gaym.c
   qrc/tags/release-0.9/gaym/src/gaym.h
   qrc/tags/release-0.9/gaym/src/gayminfo.c
   qrc/tags/release-0.9/gaym/src/gayminfo.h
   qrc/tags/release-0.9/gaym/src/helpers.c
   qrc/tags/release-0.9/gaym/src/msgs.c
   qrc/tags/release-0.9/nsis/installer.nsi
Removed:
   qrc/tags/release-0.9/gaym-extras/src/bio-popups.c
   qrc/tags/release-0.9/gaym-extras/src/gaym-extras.c
   qrc/tags/release-0.9/gaym-extras/src/roombrowse.c
   qrc/tags/release-0.9/gaym/src/gaym.c
   qrc/tags/release-0.9/gaym/src/gaym.h
   qrc/tags/release-0.9/gaym/src/gayminfo.c
   qrc/tags/release-0.9/gaym/src/gayminfo.h
   qrc/tags/release-0.9/gaym/src/helpers.c
   qrc/tags/release-0.9/gaym/src/msgs.c
   qrc/tags/release-0.9/nsis/installer.nsi
Log:
This revision seems stable. Please test the hell out of it.



Copied: qrc/tags/release-0.9 (from rev 259, qrc/trunk)

Deleted: qrc/tags/release-0.9/gaym/src/gaym.c
===================================================================
--- qrc/trunk/gaym/src/gaym.c	2005-07-30 22:19:23 UTC (rev 259)
+++ qrc/tags/release-0.9/gaym/src/gaym.c	2005-07-31 19:13:29 UTC (rev 264)
@@ -1,1632 +0,0 @@
-/**
- * @file gaym.c
- *
- * gaim
- *
- * Copyright (C) 2003, Robbert Haarman &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/qrc-svn">gaim at inglorion.net</A>&gt;
- * Copyright (C) 2003, Ethan Blanton &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/qrc-svn">eblanton at cs.purdue.edu</A>&gt;
- * Copyright (C) 2000-2003, Rob Flynn &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/qrc-svn">rob at tgflinux.com</A>&gt;
- * Copyright (C) 1998-1999, Mark Spencer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/qrc-svn">markster at marko.net</A>&gt;
- *
- * This program is free software; you can redistribute it and/or modify
- * it under the terms of the GNU General Public License as published by
- * the Free Software Foundation; either version 2 of the License, or
- * (at your option) any later version.
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- * GNU General Public License for more details.
- *
- * You should have received a copy of the GNU General Public License
- * along with this program; if not, write to the Free Software
- * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
- */
-
-#include &quot;internal.h&quot;
-#include &quot;accountopt.h&quot;
-#include &quot;blist.h&quot;
-#include &quot;conversation.h&quot;
-#include &quot;debug.h&quot;
-#include &quot;notify.h&quot;
-#include &quot;prpl.h&quot;
-#include &quot;plugin.h&quot;
-#include &quot;util.h&quot;
-#include &quot;version.h&quot;
-#include &quot;request.h&quot;
-#include &quot;privacy.h&quot;
-#include &quot;signals.h&quot;
-
-#include &quot;helpers.h&quot;
-#include &quot;gayminfo.h&quot;
-#include &quot;gaympriv.h&quot;
-#include &quot;botfilter.h&quot;
-#include &quot;gaym.h&quot;
-
-static const char *gaym_blist_icon(GaimAccount * a, GaimBuddy * b);
-static void gaym_blist_emblems(GaimBuddy * b, char **se, char **sw,
-                               char **nw, char **ne);
-static GList *gaym_away_states(GaimConnection * gc);
-static GList *gaym_actions(GaimPlugin * plugin, gpointer context);
-/* static GList *gaym_chat_info(GaimConnection *gc); */
-static void gaym_login(GaimAccount * account);
-static void gaym_login_cb(gpointer data, gint source,
-                          GaimInputCondition cond);
-static void gaym_close(GaimConnection * gc);
-static int gaym_im_send(GaimConnection * gc, const char *who,
-                        const char *what, GaimConvImFlags flags);
-static int gaym_chat_send(GaimConnection * gc, int id, const char *what);
-static void gaym_chat_join(GaimConnection * gc, GHashTable * data);
-static void gaym_input_cb(gpointer data, gint source,
-                          GaimInputCondition cond);
-
-static guint gaym_nick_hash(const char *nick);
-static gboolean gaym_nick_equal(const char *nick1, const char *nick2);
-static void gaym_buddy_free(struct gaym_buddy *ib);
-static void gaym_channel_member_free(GaymBuddy * cm);
-
-static void gaym_buddy_append(char *name, struct gaym_buddy *ib,
-                              BListWhois * blist_whois);
-static void gaym_buddy_clear_done(char *name, struct gaym_buddy *ib,
-                                  gpointer nothing);
-
-static GaimPlugin *_gaym_plugin = NULL;
-
-static const char *status_chars = &quot;@+%&amp;&quot;;
-
-int gaym_send(struct gaym_conn *gaym, const char *buf)
-{
-    int ret;
-
-    if (gaym-&gt;fd &lt; 0)
-        return -1;
-
-    /* gaim_debug(GAIM_DEBUG_MISC, &quot;gaym&quot;, &quot;sent: %s&quot;, buf); */
-    if ((ret = write(gaym-&gt;fd, buf, strlen(buf))) &lt; 0)
-        gaim_connection_error(gaim_account_get_connection(gaym-&gt;account),
-                              _(&quot;Server has disconnected&quot;));
-
-    return ret;
-}
-
-gboolean gaym_blist_timeout(struct gaym_conn * gaym)
-{
-    /**
-     * There are 510 characters available for an IRC command (512 if
-     * you count CR-LF).  &quot;WHOIS &quot; takes up 6 characters.  Assuming
-     * you need allow an extra character for the NULL when using
-     * g_string_sized_new(), we need to allocate (510-6)+1=505 here.
-     */
-    BListWhois *blist_whois = g_new0(BListWhois, 1);
-    blist_whois-&gt;count = 0;
-    blist_whois-&gt;string = g_string_sized_new(505);
-
-    char *list, *buf;
-
-    g_hash_table_foreach(gaym-&gt;buddies, (GHFunc) gaym_buddy_append,
-                         (gpointer) blist_whois);
-
-    list = g_string_free(blist_whois-&gt;string, FALSE);
-    if (!list || !strlen(list)) {
-        g_hash_table_foreach(gaym-&gt;buddies, (GHFunc) gaym_buddy_clear_done,
-                             NULL);
-        gaim_timeout_remove(gaym-&gt;timer);
-        gaym-&gt;timer =
-            gaim_timeout_add(BLIST_UPDATE_PERIOD,
-                             (GSourceFunc) gaym_blist_timeout,
-                             (gpointer) gaym);
-        g_free(list);
-        g_free(blist_whois);
-
-        return TRUE;
-    }
-    gaym-&gt;blist_updating = TRUE;
-    buf = gaym_format(gaym, &quot;vn&quot;, &quot;WHOIS&quot;, list);
-    gaym_send(gaym, buf);
-    gaim_timeout_remove(gaym-&gt;timer);
-    gaym-&gt;timer =
-        gaim_timeout_add(BLIST_CHUNK_INTERVAL,
-                         (GSourceFunc) gaym_blist_timeout,
-                         (gpointer) gaym);
-
-    g_free(buf);
-    g_free(list);
-    g_free(blist_whois);
-
-    return TRUE;
-}
-
-static void gaym_buddy_clear_done(char *name, struct gaym_buddy *ib,
-                                  gpointer nothing)
-{
-    ib-&gt;done = FALSE;
-}
-
-static void gaym_buddy_append(char *name, struct gaym_buddy *ib,
-                              BListWhois * blist_whois)
-{
-    char *converted_name = NULL;
-    converted_name = gaym_nick_to_gcom_strdup(name);
-
-    /**
-     * There are 510 characters available for an IRC command (512 if
-     * you count CR-LF).  &quot;WHOIS &quot; takes up 6 characters.  This means
-     * we have up to 504 characters available for comma separated
-     * converted_names
-     */
-    if (ib-&gt;done == FALSE &amp;&amp; blist_whois-&gt;count &lt; 10
-        &amp;&amp; (strlen(converted_name) + blist_whois-&gt;string-&gt;len + 1) &lt;=
-        504) {
-        blist_whois-&gt;count++;
-        ib-&gt;done = TRUE;
-        if (blist_whois-&gt;string-&gt;len == 0) {
-            g_string_append_printf(blist_whois-&gt;string, &quot;%s&quot;,
-                                   converted_name);
-        } else {
-            g_string_append_printf(blist_whois-&gt;string, &quot;,%s&quot;,
-                                   converted_name);
-        }
-    }
-
-    g_free(converted_name);
-    return;
-}
-
-static void gaym_whois_one(struct gaym_conn *gaym, struct gaym_buddy *ib)
-{
-    char *buf;
-    char *nick;
-    nick = gaym_nick_to_gcom_strdup(ib-&gt;name);
-    buf = gaym_format(gaym, &quot;vn&quot;, &quot;WHOIS&quot;, nick);
-    gaym_send(gaym, buf);
-    g_free(nick);
-    g_free(buf);
-}
-
-static const char *gaym_blist_icon(GaimAccount * a, GaimBuddy * b)
-{
-    return &quot;gaym&quot;;
-}
-
-static void gaym_blist_emblems(GaimBuddy * b, char **se, char **sw,
-                               char **nw, char **ne)
-{
-    if (b-&gt;present == GAIM_BUDDY_OFFLINE)
-        *se = &quot;offline&quot;;
-}
-
-static char *gaym_status_text(GaimBuddy * buddy)
-{
-    char *status;
-
-    struct gaym_conn *gaym =
-        (struct gaym_conn *) buddy-&gt;account-&gt;gc-&gt;proto_data;
-
-    if (!gaym) {
-        return g_strdup(_(&quot;Offline&quot;));
-    }
-
-    struct gaym_buddy *ib =
-        g_hash_table_lookup(gaym-&gt;buddies, buddy-&gt;name);
-
-    if (!ib) {
-        return g_strdup(_(&quot;Offline&quot;));
-    }
-
-    if (!ib-&gt;online) {
-        return g_strdup(_(&quot;Offline&quot;));
-    }
-
-    if (!ib-&gt;bio) {
-        return NULL;
-    }
-
-    status = g_markup_escape_text(ib-&gt;bio, strlen(ib-&gt;bio));
-
-    return status;
-}
-
-static char *gaym_tooltip_text(GaimBuddy * buddy)
-{
-    struct gaym_conn *gaym =
-        (struct gaym_conn *) buddy-&gt;account-&gt;gc-&gt;proto_data;
-
-    if (!gaym) {
-        return NULL;
-    }
-
-    struct gaym_buddy *ib =
-        g_hash_table_lookup(gaym-&gt;channel_members, buddy-&gt;name);
-
-    if (!ib)
-        ib = g_hash_table_lookup(gaym-&gt;buddies, buddy-&gt;name);
-
-    if (!ib) {
-        return NULL;
-    }
-
-    return build_tooltip_text(ib);
-}
-
-static GList *gaym_away_states(GaimConnection * gc)
-{
-    return g_list_prepend(NULL, (gpointer) GAIM_AWAY_CUSTOM);
-}
-
-static void gaym_set_info(GaimConnection * gc, const char *info)
-{
-    struct gaym_conn *gaym = gc-&gt;proto_data;
-    GaimAccount *account = gaim_connection_get_account(gc);
-    char *hostname = &quot;none&quot;;
-    char *buf, *bioline;
-    int i = 0;
-
-    char *tmpinfo = NULL;
-    if (info) {
-        tmpinfo = g_strdup(info);
-        for (i = 0; i &lt; strlen(tmpinfo); i++) {
-            if (tmpinfo[i] == '\n') {
-                tmpinfo[i] = ' ';
-            }
-        }
-        tmpinfo = g_strstrip(tmpinfo);
-    }
-
-    if (gc-&gt;away &amp;&amp; !tmpinfo) {
-        /**
-         * don't change any bio settings, since this is just
-         * setting an away message
-         */
-    } else {
-        if (gaym-&gt;bio) {
-            g_free(gaym-&gt;bio);
-        }
-        if (tmpinfo &amp;&amp; strlen(tmpinfo) &gt; 0) {
-            gaim_debug_misc(&quot;gaym&quot;, &quot;option1, info=%x\n&quot;, tmpinfo);
-            /* java client allows MAX_BIO_LEN characters */
-            gaym-&gt;bio = g_strndup(tmpinfo, MAX_BIO_LEN);
-        } else if (gaym-&gt;server_bioline
-                   &amp;&amp; strlen(gaym-&gt;server_bioline) &gt; 0) {
-            gaim_debug_misc(&quot;gaym&quot;, &quot;option2\n&quot;);
-            gaym-&gt;bio = gaym_bio_strdup(gaym-&gt;server_bioline);
-        } else {
-            gaim_debug_misc(&quot;gaym&quot;, &quot;option3\n&quot;);
-            gaym-&gt;bio = g_strdup(&quot;Gaim User&quot;);
-        }
-        gaim_account_set_user_info(account, gaym-&gt;bio);
-        gaim_account_set_string(account, &quot;bioline&quot;, gaym-&gt;bio);
-        gaim_debug_info(&quot;gaym&quot;, &quot;INFO=%x BIO=%x\n&quot;, tmpinfo, gaym-&gt;bio);
-        gaim_debug_misc(&quot;gaym&quot;, &quot;In login_cb, gc-&gt;account=%x\n&quot;,
-                        gc-&gt;account);
-    }
-
-    bioline =
-        g_strdup_printf(&quot;%s#%s\001%s&quot;,
-                        gaym-&gt;thumbnail ? gaym-&gt;thumbnail : &quot;&quot;,
-                        gc-&gt;away ? gc-&gt;away : (gaym-&gt;bio ? gaym-&gt;bio : &quot;&quot;),
-                        gaym-&gt;server_stats ? gaym-&gt;server_stats : &quot;&quot;);
-
-    buf = gaym_format(gaym, &quot;vvvv:&quot;, &quot;USER&quot;,
-                      gaim_account_get_username(account),
-                      hostname, gaym-&gt;server, bioline);
-
-    gaim_debug_misc(&quot;gaym&quot;, &quot;BIO=%x\n&quot;, bioline);
-
-    if (gaym_send(gaym, buf) &lt; 0) {
-        gaim_connection_error(gc, &quot;Error registering with server&quot;);
-    }
-
-    if (tmpinfo) {
-        g_free(tmpinfo);
-    }
-    g_free(bioline);
-    g_free(buf);
-
-    return;
-}
-
-static void gaym_show_set_info(GaimPluginAction * action)
-{
-    GaimConnection *gc = (GaimConnection *) action-&gt;context;
-    gaim_account_request_change_user_info(gaim_connection_get_account(gc));
-}
-
-static GList *gaym_actions(GaimPlugin * plugin, gpointer context)
-{
-    GList *list = NULL;
-    GaimPluginAction *act = NULL;
-
-    act = gaim_plugin_action_new(_(&quot;Change Bio&quot;), gaym_show_set_info);
-    list = g_list_prepend(list, act);
-
-    return list;
-}
-
-static void gaym_blist_join_chat_cb(GaimBlistNode * node, gpointer data)
-{
-    const char *args[1];
-
-    GaimChat *chat = (GaimChat *) node;
-    struct gaym_conn *gaym = chat-&gt;account-&gt;gc-&gt;proto_data;
-    args[0] = data;
-
-    g_return_if_fail(args[0] != NULL);
-    g_return_if_fail(gaym != NULL);
-
-    gaym_cmd_join(gaym, &quot;join&quot;, NULL, args);
-}
-
-static GList *gaym_blist_node_menu(GaimBlistNode * node)
-{
-    GList *m = NULL;
-    GaimBlistNodeAction *act = NULL;
-    int i = 0;
-
-    if (node-&gt;type != GAIM_BLIST_CHAT_NODE) {
-        return m;
-    }
-
-    GaimChat *chat = (GaimChat *) node;
-    char *channel = g_hash_table_lookup(chat-&gt;components, &quot;channel&quot;);
-
-    if (!channel) {
-        return m;
-    }
-
-    if (!g_str_has_suffix(channel, &quot;=*&quot;)) {
-        return m;
-    }
-
-    char *label = NULL;
-    char *instance = NULL;
-
-    int max = gaim_prefs_get_int(&quot;/plugins/prpl/gaym/chat_room_instances&quot;);
-
-    for (i = max; i &gt; 0; i--) {
-        label = g_strdup_printf(_(&quot;Join Room %d&quot;), i);
-        instance =
-            g_strdup_printf(&quot;%.*s%d&quot;, strlen(channel) - 1, channel, i);
-        act =
-            gaim_blist_node_action_new(label, gaym_blist_join_chat_cb,
-                                       instance);
-        m = g_list_prepend(m, act);
-    }
-    return m;
-}
-
-static GList *gaym_chat_join_info(GaimConnection * gc)
-{
-    GList *m = NULL;
-    struct proto_chat_entry *pce;
-
-    pce = g_new0(struct proto_chat_entry, 1);
-    pce-&gt;label = _(&quot;_Room:&quot;);
-    pce-&gt;identifier = &quot;channel&quot;;
-    m = g_list_prepend(m, pce);
-
-    return m;
-}
-
-GHashTable *gaym_chat_info_defaults(GaimConnection * gc,
-                                    const char *chat_name)
-{
-    GHashTable *defaults;
-
-    defaults =
-        g_hash_table_new_full(g_str_hash, g_str_equal, NULL, g_free);
-
-    if (chat_name != NULL)
-        g_hash_table_insert(defaults, &quot;channel&quot;, g_strdup(chat_name));
-
-    return defaults;
-}
-
-static void gaym_login_with_chat_key(GaimAccount * account)
-{
-    GaimConnection *gc;
-    struct gaym_conn *gaym;
-    char *buf;
-    const char *username = gaim_account_get_username(account);
-    int err;
-
-    gc = gaim_account_get_connection(account);
-    gaym = gc-&gt;proto_data;
-
-    buf = g_strdup_printf(_(&quot;Signon: %s&quot;), username);
-    gaim_connection_update_progress(gc, buf, 5, 6);
-    g_free(buf);
-    gaim_debug_misc(&quot;gaym&quot;, &quot;Trying login to %s\n&quot;, gaym-&gt;server);
-    err = gaim_proxy_connect(account, gaym-&gt;server,
-                             gaim_account_get_int(account, &quot;port&quot;,
-                                                  IRC_DEFAULT_PORT),
-                             gaym_login_cb, gc);
-    if (err || !account-&gt;gc) {
-        gaim_connection_error(gc, _(&quot;Couldn't create socket&quot;));
-        gaim_debug_misc(&quot;gaym&quot;, &quot;err: %d, account-&gt;gc: %x\n&quot;, err,
-                        account-&gt;gc);
-        return;
-    }
-
-}
-
-static void gaym_login(GaimAccount * account)
-{
-    GaimConnection *gc;
-    struct gaym_conn *gaym;
-    char *buf;
-    const char *username = gaim_account_get_username(account);
-
-    gc = gaim_account_get_connection(account);
-    gc-&gt;flags |= GAIM_CONNECTION_NO_NEWLINES | GAIM_CONNECTION_AUTO_RESP;
-
-    if (strpbrk(username, &quot; \t\v\r\n&quot;) != NULL) {
-        gaim_connection_error(gc,
-                              _(&quot;IRC nicks may not contain whitespace&quot;));
-        return;
-    }
-
-    gc-&gt;proto_data = gaym = g_new0(struct gaym_conn, 1);
-    gaym-&gt;account = account;
-
-
-    /**
-     * gaim_connection_set_display_name(gc, userparts[0]);
-     */
-    gaim_connection_set_display_name(gc, username);
-    gaym-&gt;server =
-        g_strdup(gaim_account_get_string
-                 (account, &quot;server&quot;, &quot;www.gay.com&quot;));
-    /**
-     * gaym-&gt;server = &quot;www.gay.com&quot;;
-     */
-    gaym-&gt;buddies =
-        g_hash_table_new_full((GHashFunc) gaym_nick_hash,
-                              (GEqualFunc) gaym_nick_equal, NULL,
-                              (GDestroyNotify) gaym_buddy_free);
-
-    gaym-&gt;channel_members =
-        g_hash_table_new_full((GHashFunc) gaym_nick_hash,
-                              (GEqualFunc) gaym_nick_equal, NULL,
-                              (GDestroyNotify) gaym_channel_member_free);
-
-    gaym-&gt;cmds = g_hash_table_new(g_str_hash, g_str_equal);
-    gaym_cmd_table_build(gaym);
-    gaym-&gt;msgs = g_hash_table_new(g_str_hash, g_str_equal);
-    gaym_msg_table_build(gaym);
-    gaym-&gt;roomlist_filter = NULL;
-    /**
-     * The last parameter needs to be NULL here, since the same
-     * field is added for both the key and the value (and if we
-     * free it twice, thats bad and causes crashing!).
-     */
-    gaym-&gt;info_window_needed =
-        g_hash_table_new_full(g_str_hash, g_str_equal, g_free, NULL);
-
-    gaym-&gt;entry_order =
-        g_hash_table_new_full(g_str_hash, g_str_equal, g_free, g_free);
-
-    /**
-     * This is similar to gaym-&gt;info_window_needed, except this is
-     * for thumbails inside the IM conversation window if the
-     * person is not already on the buddy list
-     */
-
-    buf = g_strdup_printf(_(&quot;Signon: %s&quot;), username);
-    gaim_connection_update_progress(gc, buf, 1, 6);
-    g_free(buf);
-
-
-    /**
-     * Making a change to try cached password first.
-     * gaym_try_cached_password(account, gaym_login_with_chat_key);
-     */
-    gaym_get_chat_key_from_weblogin(account, gaym_login_with_chat_key);
-}
-
-
-static void gaym_get_configtxt_cb(gpointer proto_data,
-                                  const gchar * config_text, size_t len)
-{
-    struct gaym_conn *gaym = (struct gaym_conn *) proto_data;
-    GaimConnection *gc = gaim_account_get_connection(gaym-&gt;account);
-
-    g_return_if_fail(config_text != NULL);
-
-    gaym-&gt;confighash = gaym_properties_new(config_text);
-    g_return_if_fail(gaym-&gt;confighash != NULL);
-
-    // synchronize_deny_list(gc, gaym-&gt;confighash);
-
-    return;
-}
-static void gaym_login_cb(gpointer data, gint source,
-                          GaimInputCondition cond)
-{
-    GaimConnection *gc = data;
-    struct gaym_conn *gaym = gc-&gt;proto_data;
-    char hostname[256];
-    char *buf;
-    const char *username;
-    const char *user_bioline = NULL;
-    char *bioline;
-    char *login_name;
-
-    if (GAIM_CONNECTION_IS_VALID(gc)) {
-
-
-        GList *connections = gaim_connections_get_all();
-
-        if (source &lt; 0) {
-            gaim_connection_error(gc, _(&quot;Couldn't connect to host&quot;));
-            return;
-        }
-
-        if (!g_list_find(connections, gc)) {
-            close(source);
-            return;
-        }
-
-        gaym-&gt;fd = source;
-        gaim_debug_misc(&quot;gaym&quot;, &quot;In login_cb with chat_key=%s\n&quot;,
-                        gaym-&gt;chat_key);
-        if (gaym-&gt;chat_key) {
-
-            buf = gaym_format(gaym, &quot;vv&quot;, &quot;PASS&quot;, gaym-&gt;chat_key);
-            if (gaym_send(gaym, buf) &lt; 0) {
-                gaim_connection_error(gc, &quot;Error sending password&quot;);
-                return;
-            }
-            g_free(buf);
-        } else {
-            gaim_connection_error(gc,
-                                  _
-                                  (&quot;Password wasn't recorded. Report bug.&quot;));
-            return;
-        }
-        gethostname(hostname, sizeof(hostname));
-        hostname[sizeof(hostname) - 1] = '\0';
-        username = gaim_account_get_string(gaym-&gt;account, &quot;username&quot;, &quot;&quot;);
-        user_bioline =
-            g_strdup(gaim_account_get_string
-                     (gaym-&gt;account, &quot;bioline&quot;, &quot;&quot;));
-        gaim_debug_info(&quot;gaym&quot;, &quot;USER BIOLINE=%x\n&quot;, user_bioline);
-        gaim_account_set_user_info(gc-&gt;account, user_bioline);
-        gaim_debug_misc(&quot;gaym&quot;,
-                        &quot;In login_cb, user_bioline: %x, gc-&gt;account=%x\n&quot;,
-                        user_bioline, gc-&gt;account);
-
-        login_name =
-            gaym_nick_to_gcom_strdup(gaim_connection_get_display_name(gc));
-        bioline = g_strdup_printf(&quot;%s#%s\001%s&quot;,
-                                  gaym-&gt;thumbnail,
-                                  user_bioline ? user_bioline : &quot;&quot;,
-                                  gaym-&gt;server_stats ? gaym-&gt;
-                                  server_stats : &quot;&quot;);
-
-        buf = gaym_format(gaym, &quot;vn&quot;, &quot;NICK&quot;, login_name);
-        gaim_debug_misc(&quot;gaym&quot;, &quot;Command: %s\n&quot;, buf);
-
-        if (gaym_send(gaym, buf) &lt; 0) {
-            gaim_connection_error(gc, &quot;Error sending nickname&quot;);
-            return;
-        }
-        g_free(buf);
-        buf =
-            gaym_format(gaym, &quot;vvvv:&quot;, &quot;USER&quot;, login_name, hostname,
-                        gaym-&gt;server, bioline);
-
-        gaim_debug_misc(&quot;gaym&quot;, &quot;Command: %s\n&quot;, buf);
-        if (gaym_send(gaym, buf) &lt; 0) {
-            gaim_connection_error(gc, &quot;Error registering with server&quot;);
-            return;
-        }
-        g_free(login_name);
-        g_free(buf);
-
-        const char *server = gaim_account_get_string(gc-&gt;account, &quot;server&quot;,
-                                                     IRC_DEFAULT_SERVER);
-        char *url =
-            g_strdup_printf
-            (&quot;<A HREF="http://%s/messenger/config.txt?%s">http://%s/messenger/config.txt?%s</A>&quot;, server, gaym-&gt;chat_key);
-
-        char *user_agent = &quot;Mozilla/4.0&quot;;
-
-        get_spamlist_from_web();
-        gaim_url_fetch(url, FALSE, user_agent, FALSE,
-                       gaym_get_configtxt_cb, gaym);
-
-        g_free(url);
-        gc-&gt;inpa =
-            gaim_input_add(gaym-&gt;fd, GAIM_INPUT_READ, gaym_input_cb, gc);
-
-
-    }
-}
-static void gaym_close(GaimConnection * gc)
-{
-    struct gaym_conn *gaym = gc-&gt;proto_data;
-
-    gaim_debug_misc(&quot;gaym&quot;, &quot;gaym close function has been called\n&quot;);
-    if (gaym == NULL)
-        return;
-
-    gaym_cmd_quit(gaym, &quot;quit&quot;, NULL, NULL);
-
-    if (gc-&gt;inpa)
-        gaim_input_remove(gc-&gt;inpa);
-
-    g_free(gaym-&gt;inbuf);
-    gaim_debug_misc(&quot;gaym&quot;, &quot;closing fd %i\n&quot;, gaym-&gt;fd);
-    close(gaym-&gt;fd);
-
-    if (gaym-&gt;timer)
-        gaim_timeout_remove(gaym-&gt;timer);
-
-    if (gaym-&gt;thumbnail)
-        g_free(gaym-&gt;thumbnail);
-
-    if (gaym-&gt;chat_key)
-        g_free(gaym-&gt;chat_key);
-
-    if (gaym-&gt;server_bioline)
-        g_free(gaym-&gt;server_bioline);
-
-    if (gaym-&gt;server_stats)
-        g_free(gaym-&gt;server_stats);
-
-    if (gaym-&gt;roomlist_filter)
-        g_free(gaym-&gt;roomlist_filter);
-
-    if (gaym-&gt;bio)
-        g_free(gaym-&gt;bio);
-
-    g_hash_table_destroy(gaym-&gt;cmds);
-    g_hash_table_destroy(gaym-&gt;msgs);
-    g_hash_table_destroy(gaym-&gt;info_window_needed);
-    g_hash_table_destroy(gaym-&gt;entry_order);
-    if (gaym-&gt;motd)
-        g_string_free(gaym-&gt;motd, TRUE);
-
-    if (gaym-&gt;names)
-        g_string_free(gaym-&gt;names, TRUE);
-
-    if (gaym-&gt;nameconv)
-        g_free(gaym-&gt;nameconv);
-    if (gaym-&gt;subroom)
-        g_free(gaym-&gt;subroom);
-
-    g_hash_table_destroy(gaym-&gt;confighash);
-
-    if (gaym-&gt;hammer_cancel_dialog)
-        gaim_request_close(GAIM_REQUEST_ACTION,
-                           gaym-&gt;hammer_cancel_dialog);
-
-    g_free(gaym-&gt;server);
-    g_free(gaym);
-}
-
-static int gaym_im_send(GaimConnection * gc, const char *who,
-                        const char *what, GaimConvImFlags flags)
-{
-    struct gaym_conn *gaym = gc-&gt;proto_data;
-    const char *args[2];
-    char *automsg = NULL;
-    char *stripped_msg = NULL;
-    if (strchr(status_chars, *who) != NULL) {
-        args[0] = who + 1;
-    } else {
-        args[0] = who;
-    }
-    if (flags &amp; GAIM_CONV_IM_AUTO_RESP) {
-        stripped_msg = gaim_markup_strip_html(what);
-        automsg = g_strdup_printf(&quot;&lt;AUTO-REPLY&gt; %s&quot;, stripped_msg);
-        g_free(stripped_msg);
-        args[1] = automsg;
-
-    } else {
-        args[1] = what;
-    }
-    gaym_cmd_privmsg(gaym, &quot;msg&quot;, NULL, args);
-    if (automsg) {
-        g_free(automsg);
-    }
-    return 1;
-}
-
-static void gaym_get_info(GaimConnection * gc, const char *who)
-{
-    struct gaym_conn *gaym = gc-&gt;proto_data;
-    const char *args[1];
-    args[0] = who;
-
-    char *normalized = g_strdup(gaim_normalize(gc-&gt;account, who));
-    /**
-     * We are adding the same char* to both the key and the value.
-     * If this changes, we need to change the corresponding
-     * g_hash_table_new_full() so that things are properly cleaned
-     * up during the remove/destroy phase.
-     */
-    g_hash_table_insert(gaym-&gt;info_window_needed, normalized, normalized);
-    gaym_cmd_whois(gaym, &quot;whois&quot;, NULL, args);
-}
-
-static void gaym_set_away(GaimConnection * gc, const char *state,
-                          const char *msg)
-{
-    char *bio = NULL;
-    char *tmpmsg = NULL;
-    int i = 0;
-    struct gaym_conn *gaym = gc-&gt;proto_data;
-
-    if (gc-&gt;away) {
-        g_free(gc-&gt;away);
-        gc-&gt;away = NULL;
-    }
-
-    /**
-     * In addition to setting the away message, set the Bio to the
-     * away message; if the away message is NULL, then set the Bio
-     * to the original bio.
-     */
-
-    if (msg) {
-        tmpmsg = g_strdup(msg);
-        for (i = 0; i &lt; strlen(tmpmsg); i++) {
-            if (tmpmsg[i] == '\n') {
-                tmpmsg[i] = ' ';
-            }
-        }
-        tmpmsg = g_strstrip(tmpmsg);
-
-        gc-&gt;away = g_strndup(tmpmsg, MAX_BIO_LEN);
-        gaym_set_info(gc, NULL);
-        g_free(tmpmsg);
-    } else {
-        if (gaym &amp;&amp; gaym-&gt;bio) {
-            bio = g_strdup(gaym-&gt;bio);
-            gaym_set_info(gc, bio);
-            g_free(bio);
-        } else {
-            gaym_set_info(gc, NULL);
-        }
-    }
-
-    /**
-     *  The following would be great, and gay.com's server supports
-     *  it, but gay.com's clients don't see the result.  So even though
-     *  we can see the result, we won't bother.
-     *
-     * args[0] = msg;
-     * gaym_cmd_away(gaym, &quot;away&quot;, NULL, args);
-     */
-}
-
-GaymBuddy *gaym_get_channel_member_reference(struct gaym_conn
-                                             *gaym, const gchar * name)
-{
-
-    GaymBuddy *channel_member =
-        (GaymBuddy *) g_hash_table_lookup(gaym-&gt;channel_members,
-                                          name);
-
-    if (!channel_member) {
-        GaymBuddy *channel_member = g_new0(GaymBuddy, 1);
-        channel_member-&gt;ref_count = 1;
-        g_hash_table_insert(gaym-&gt;channel_members, g_strdup(name),
-                            channel_member);
-        gaim_debug_misc(&quot;gaym&quot;, &quot;Creating channel_members entry for %s\n&quot;,
-                        name);
-        return g_hash_table_lookup(gaym-&gt;channel_members, name);
-    } else {
-        gaim_debug_misc(&quot;gaym&quot;,
-                        &quot;Adding reference to channel_members entry for %s\n&quot;,
-                        name);
-        (channel_member-&gt;ref_count)++;
-        return channel_member;
-    }
-
-}
-
-gboolean gaym_unreference_channel_member(struct gaym_conn * gaym,
-                                         gchar * name)
-{
-
-    GaymBuddy *channel_member;
-    channel_member =
-        (GaymBuddy *) g_hash_table_lookup(gaym-&gt;channel_members, name);
-    if (!channel_member)
-        return FALSE;
-    else {
-
-        if (channel_member-&gt;ref_count &lt;= 0)
-            gaim_debug_error(&quot;gaym&quot;,
-                             &quot;****Reference counting error with channel members struct.\n&quot;);
-
-        channel_member-&gt;ref_count--;
-
-        if (channel_member-&gt;ref_count == 0) {
-            gaim_debug_misc(&quot;gaym&quot;, &quot;Removing %s from channel_members\n&quot;,
-                            name);
-            return g_hash_table_remove(gaym-&gt;channel_members, name);
-        }
-        return FALSE;
-    }
-}
-
-static void gaym_add_buddy(GaimConnection * gc, GaimBuddy * buddy,
-                           GaimGroup * group)
-{
-    if (buddy-&gt;name) {
-        buddy-&gt;name = g_strstrip(buddy-&gt;name);
-    }
-    if (buddy-&gt;alias) {
-        buddy-&gt;alias = g_strstrip(buddy-&gt;alias);
-    }
-    if (buddy-&gt;server_alias) {
-        buddy-&gt;server_alias = g_strstrip(buddy-&gt;server_alias);
-    }
-    struct gaym_conn *gaym = (struct gaym_conn *) gc-&gt;proto_data;
-    struct gaym_buddy *ib = g_new0(struct gaym_buddy, 1);
-    ib-&gt;name = g_strdup(buddy-&gt;name);
-    ib-&gt;done = FALSE;
-    ib-&gt;online = FALSE;
-    ib-&gt;bio = NULL;
-    ib-&gt;thumbnail = NULL;
-    ib-&gt;sex = NULL;
-    ib-&gt;age = NULL;
-    ib-&gt;location = NULL;
-    g_hash_table_replace(gaym-&gt;buddies, ib-&gt;name, ib);
-    gaim_debug_misc(&quot;gaym&quot;, &quot;Add buddy: %s\n&quot;, buddy-&gt;name);
-    /**
-     * if the timer isn't set, this is during signon, so we don't want to
-     * flood ourself off with WHOIS's, so we don't, but after that we want
-     * to know when someone's online asap
-     */
-    if (gaym-&gt;timer)
-        gaym_whois_one(gaym, ib);
-}
-
-static void gaym_remove_buddy(GaimConnection * gc, GaimBuddy * buddy,
-                              GaimGroup * group)
-{
-    struct gaym_conn *gaym = (struct gaym_conn *) gc-&gt;proto_data;
-
-    /**
-     * Only remove buddy-&gt;name from gaym-&gt;buddies if it doesn't
-     * exist in any other group on the buddy list.  This allows us
-     * to manage the buddy once, even though it might exist in
-     * several groups within the buddy list.
-     *
-     * To add to confusion, the buddy being deleted is not yet deleted,
-     * so we look for less than two identical buddies, and if so, then
-     * remove the buddy from gaym-&gt;buddies.
-     */
-
-    GSList *buddies = gaim_find_buddies(gaym-&gt;account, buddy-&gt;name);
-    guint length = g_slist_length(buddies);
-
-    if (length &lt; 2) {
-        g_hash_table_remove(gaym-&gt;buddies, buddy-&gt;name);
-    }
-
-    g_slist_free(buddies);
-}
-
-static void gaym_input_cb(gpointer data, gint source,
-                          GaimInputCondition cond)
-{
-    GaimConnection *gc = data;
-    struct gaym_conn *gaym = gc-&gt;proto_data;
-    char *cur, *end;
-    int len;
-
-    if (gaym-&gt;inbuflen &lt; gaym-&gt;inbufused + IRC_INITIAL_BUFSIZE) {
-        gaym-&gt;inbuflen += IRC_INITIAL_BUFSIZE;
-        gaym-&gt;inbuf = g_realloc(gaym-&gt;inbuf, gaym-&gt;inbuflen);
-    }
-
-    if ((len =
-         read(gaym-&gt;fd, gaym-&gt;inbuf + gaym-&gt;inbufused,
-              IRC_INITIAL_BUFSIZE - 1)) &lt; 0) {
-        gaim_connection_error(gc, _(&quot;Read error&quot;));
-        return;
-    } else if (len == 0) {
-        gaim_connection_error(gc, _(&quot;Server has disconnected&quot;));
-        return;
-    }
-
-    gaym-&gt;inbufused += len;
-    gaym-&gt;inbuf[gaym-&gt;inbufused] = '\0';
-
-    cur = gaym-&gt;inbuf;
-    while (cur &lt; gaym-&gt;inbuf + gaym-&gt;inbufused &amp;&amp;
-           ((end = strstr(cur, &quot;\r\n&quot;)) || (end = strstr(cur, &quot;\n&quot;)))) {
-        int step = (*end == '\r' ? 2 : 1);
-        *end = '\0';
-        gaym_parse_msg(gaym, cur);
-        cur = end + step;
-    }
-    if (cur != gaym-&gt;inbuf + gaym-&gt;inbufused) { /* leftover */
-        gaym-&gt;inbufused -= (cur - gaym-&gt;inbuf);
-        memmove(gaym-&gt;inbuf, cur, gaym-&gt;inbufused);
-    } else {
-        gaym-&gt;inbufused = 0;
-    }
-}
-
-static void gaym_add_permit(GaimConnection * gc, const char *name)
-{
-    if (!gaym_nick_check(name)) {
-        gaim_privacy_permit_remove(gc-&gt;account, name, TRUE);
-        gaim_notify_error(gc, _(&quot;Invalid User Name&quot;), name,
-                          _(&quot;Invalid user name not added.&quot;));
-    } else {
-        gaym_privacy_change(gc, name);
-    }
-}
-
-static void gaym_add_deny(GaimConnection * gc, const char *name)
-{
-    if (!gaym_nick_check(name)) {
-        gaim_privacy_deny_remove(gc-&gt;account, name, TRUE);
-        gaim_notify_error(gc, _(&quot;Invalid User Name&quot;), name,
-                          _(&quot;Invalid user name not added.&quot;));
-        return;
-    }
-    gaym_server_store_deny(gc, name, TRUE);
-    gaym_privacy_change(gc, name);
-}
-
-static void gaym_rem_permit(GaimConnection * gc, const char *name)
-{
-    gaym_privacy_change(gc, name);
-}
-
-static void gaym_rem_deny(GaimConnection * gc, const char *name)
-{
-    gaym_server_store_deny(gc, name, FALSE);
-    gaym_privacy_change(gc, name);
-}
-
-static void gaym_set_permit_deny(GaimConnection * gc)
-{
-    gaym_privacy_change(gc, NULL);
-}
-
-static void gaym_warn(GaimConnection * gc, const char *who,
-                      gboolean anonymous)
-{
-    void *handle = NULL;
-    struct gaym_conn *gaym = gc-&gt;proto_data;
-    char *buf =
-        g_strdup_printf
-        (&quot;<A HREF="http://%s/members/report/form.html?area=chat&amp;room=&amp;report=%s">http://%s/members/report/form.html?area=chat&amp;room=&amp;report=%s</A>&quot;,
-         gaym-&gt;server, who);
-    gaim_notify_uri(handle, buf);
-    g_free(buf);
-}
-
-static void gaym_chat_join(GaimConnection * gc, GHashTable * data)
-{
-    struct gaym_conn *gaym = gc-&gt;proto_data;
-    const char *args[1];
-    char *alias = NULL;
-
-    GaimChat *c = NULL;
-
-    /**
-     * need a copy, because data gets
-     * destroyed in roomlist.c
-     */
-    GHashTable *chatinfo = NULL;
-
-    args[0] = g_hash_table_lookup(data, &quot;channel&quot;);
-
-    if (args[0]) {
-        alias = g_hash_table_lookup(data, &quot;description&quot;);
-        c = gaim_blist_find_chat(gaim_connection_get_account(gc), args[0]);
-        if (!c) {
-            chatinfo = g_hash_table_new(g_str_hash, g_str_equal);
-
-            g_hash_table_replace(chatinfo, &quot;channel&quot;, g_strdup(args[0]));
-
-            c = gaim_chat_new(gaim_connection_get_account(gc),
-                              alias, chatinfo);
-
-            gaim_blist_add_chat(c, NULL, NULL);
-        }
-    }
-
-    if (!args[0] || *args[0] != '#') {
-        /**
-         * Trigger a room search in config.txt....
-         */
-        return;
-    }
-
-    gaym_cmd_join(gaym, &quot;join&quot;, NULL, args);
-}
-
-static char *gaym_get_chat_name(GHashTable * data)
-{
-    return g_strdup(g_hash_table_lookup(data, &quot;channel&quot;));
-}
-
-static void gaym_chat_invite(GaimConnection * gc, int id,
-                             const char *message, const char *name)
-{
-    struct gaym_conn *gaym = gc-&gt;proto_data;
-    GaimConversation *convo = gaim_find_chat(gc, id);
-    const char *args[2];
-
-    if (!convo) {
-        gaim_debug(GAIM_DEBUG_ERROR, &quot;gaym&quot;,
-                   &quot;Got chat invite request for bogus chat\n&quot;);
-        return;
-    }
-    args[0] = name;
-    args[1] = gaim_conversation_get_name(convo);
-    gaym_cmd_invite(gaym, &quot;invite&quot;, gaim_conversation_get_name(convo),
-                    args);
-}
-
-static void gaym_chat_leave(GaimConnection * gc, int id)
-{
-    struct gaym_conn *gaym = gc-&gt;proto_data;
-    GaimConversation *convo = gaim_find_chat(gc, id);
-    const char *args[2];
-
-    if (!convo)
-        return;
-
-    args[0] = gaim_conversation_get_name(convo);
-    args[1] = NULL;
-    gaym_cmd_part(gaym, &quot;part&quot;, gaim_conversation_get_name(convo), args);
-    serv_got_chat_left(gc, id);
-}
-
-static int gaym_chat_send(GaimConnection * gc, int id, const char *what)
-{
-    struct gaym_conn *gaym = gc-&gt;proto_data;
-    GaimConversation *convo = gaim_find_chat(gc, id);
-    const char *args[2];
-    char *tmp;
-
-    if (!convo) {
-        gaim_debug(GAIM_DEBUG_ERROR, &quot;gaym&quot;,
-                   &quot;chat send on nonexistent chat\n&quot;);
-        return -EINVAL;
-    }
-#if 0
-    if (*what == '/') {
-        return gaym_parse_cmd(gaym, convo-&gt;name, what + 1);
-    }
-#endif
-    args[0] = convo-&gt;name;
-    args[1] = what;
-
-    gaym_cmd_privmsg(gaym, &quot;msg&quot;, NULL, args);
-
-    tmp = gaim_escape_html(what);
-    serv_got_chat_in(gc, id, gaim_connection_get_display_name(gc), 0, tmp,
-                     time(NULL));
-    g_free(tmp);
-    return 0;
-}
-
-static guint gaym_nick_hash(const char *nick)
-{
-    char *lc = NULL;
-    guint bucket;
-
-    if (!nick)
-        return 0;
-    lc = g_utf8_strdown(nick, -1);
-    bucket = g_str_hash(lc);
-    g_free(lc);
-
-    return bucket;
-}
-
-static gboolean gaym_nick_equal(const char *nick1, const char *nick2)
-{
-    return (gaim_utf8_strcasecmp(nick1, nick2) == 0);
-}
-
-static void gaym_channel_member_free(GaymBuddy * cm)
-{
-    g_free(cm-&gt;name);
-    g_free(cm-&gt;bio);
-    g_free(cm-&gt;thumbnail);
-    g_free(cm-&gt;sex);
-    g_free(cm-&gt;age);
-    g_free(cm-&gt;location);
-    g_free(cm);
-}
-
-static void gaym_buddy_free(struct gaym_buddy *ib)
-{
-    g_free(ib-&gt;name);
-    g_free(ib-&gt;bio);
-    g_free(ib-&gt;thumbnail);
-    g_free(ib-&gt;sex);
-    g_free(ib-&gt;age);
-    g_free(ib-&gt;location);
-    g_free(ib);
-}
-
-static GaimChat *gaym_find_blist_chat(GaimAccount * account,
-                                      const char *name)
-{
-    char *chat_name;
-    GaimChat *chat;
-    GaimPlugin *prpl;
-    GaimPluginProtocolInfo *prpl_info = NULL;
-    struct proto_chat_entry *pce;
-    GaimBlistNode *node, *group;
-    GList *parts;
-
-    GaimBuddyList *gaimbuddylist = gaim_get_blist();
-
-    g_return_val_if_fail(gaimbuddylist != NULL, NULL);
-    g_return_val_if_fail((name != NULL) &amp;&amp; (*name != '\0'), NULL);
-
-    if (!gaim_account_is_connected(account))
-        return NULL;
-
-    prpl = gaim_find_prpl(gaim_account_get_protocol_id(account));
-    prpl_info = GAIM_PLUGIN_PROTOCOL_INFO(prpl);
-
-    for (group = gaimbuddylist-&gt;root; group != NULL; group = group-&gt;next) {
-        for (node = group-&gt;child; node != NULL; node = node-&gt;next) {
-            if (GAIM_BLIST_NODE_IS_CHAT(node)) {
-
-                chat = (GaimChat *) node;
-
-                if (account != chat-&gt;account)
-                    continue;
-
-                parts =
-                    prpl_info-&gt;
-                    chat_info(gaim_account_get_connection(chat-&gt;account));
-
-                pce = parts-&gt;data;
-                chat_name = g_hash_table_lookup(chat-&gt;components,
-                                                pce-&gt;identifier);
-
-                if (chat-&gt;account == account &amp;&amp; chat_name != NULL &amp;&amp;
-                    name != NULL
-                    &amp;&amp; g_pattern_match_simple(chat_name, name)) {
-
-                    return chat;
-                }
-            }
-        }
-    }
-
-    return NULL;
-}
-
-static GaimRoomlist *gaym_roomlist_get_list(GaimConnection * gc)
-{
-    struct gaym_conn *gaym;
-    GList *fields = NULL;
-    GaimRoomlistField *f;
-    char *buf;
-
-    gaym = gc-&gt;proto_data;
-
-    if (gaym-&gt;roomlist) {
-        gaim_roomlist_unref(gaym-&gt;roomlist);
-    }
-
-    gaym-&gt;roomlist = gaim_roomlist_new(gaim_connection_get_account(gc));
-
-    f = gaim_roomlist_field_new(GAIM_ROOMLIST_FIELD_STRING, _(&quot;Channel&quot;),
-                                &quot;channel&quot;, FALSE);
-    fields = g_list_prepend(fields, f);
-
-    f = gaim_roomlist_field_new(GAIM_ROOMLIST_FIELD_STRING, &quot;&quot;,
-                                &quot;description&quot;, TRUE);
-    fields = g_list_prepend(fields, f);
-
-    gaim_roomlist_set_fields(gaym-&gt;roomlist, fields);
-
-    /**
-     * Member created rooms are retrieved through the IRC protocol
-     * and after the last response is recieved from that request
-     * the static rooms are added
-     */
-
-    buf = gaym_format(gaym, &quot;v&quot;, &quot;LIST #_*&quot;);
-    gaym_send(gaym, buf);
-    g_free(buf);
-
-    return gaym-&gt;roomlist;
-}
-
-static void gaym_roomlist_cancel(struct _GaimRoomlist *list)
-{
-    GaimConnection *gc = gaim_account_get_connection(list-&gt;account);
-    struct gaym_conn *gaym;
-
-    if (gc == NULL)
-        return;
-
-    gaym = gc-&gt;proto_data;
-
-    gaim_roomlist_set_in_progress(list, FALSE);
-
-    if (gaym-&gt;roomlist == list) {
-        g_list_free(g_list_nth_data(list-&gt;rooms, 0));
-        gaym-&gt;roomlist = NULL;
-        gaim_roomlist_unref(list);
-    }
-
-    if (gaym-&gt;roomlist_filter) {
-        g_free(gaym-&gt;roomlist_filter);
-        gaym-&gt;roomlist_filter = NULL;
-    }
-}
-
-void gaym_roomlist_expand_category(struct _GaimRoomlist *list,
-                                   struct _GaimRoomlistRoom *category)
-{
-    GaimRoomlistRoom *room = NULL;
-    gchar *altname = NULL;
-    gchar *altchan = NULL;
-    int i = 0;
-
-    if (category-&gt;type &amp; GAIM_ROOMLIST_ROOMTYPE_ROOM
-        &amp;&amp; !category-&gt;expanded_once) {
-
-        category-&gt;expanded_once = TRUE;
-
-        int max =
-            gaim_prefs_get_int(&quot;/plugins/prpl/gaym/chat_room_instances&quot;);
-
-        gchar *name = category-&gt;fields-&gt;data;
-        gchar *chan = category-&gt;fields-&gt;next-&gt;data;
-
-        for (i = 1; i &lt;= max; i++) {
-            altname = g_strdup_printf(&quot;%.*s%d&quot;, strlen(name) - 1, name, i);
-            altchan = g_strdup_printf(&quot;%.*s%d&quot;, strlen(chan) - 1, chan, i);
-
-            room =
-                gaim_roomlist_room_new(GAIM_ROOMLIST_ROOMTYPE_ROOM,
-                                       altname, category);
-
-            gaim_roomlist_room_add_field(list, room, altname);
-            gaim_roomlist_room_add_field(list, room, altchan);
-            gaim_roomlist_room_add(list, room);
-            g_free(altname);
-            g_free(altchan);
-        }
-    }
-    gaim_roomlist_set_in_progress(list, FALSE);
-}
-
-static GaimPluginProtocolInfo prpl_info = {
-    0,                          /* options */
-    NULL,                       /* user_splits */
-    NULL,                       /* protocol_options */
-    {&quot;jpg&quot;, 57, 77, 57, 77},    /* icon_spec */
-    gaym_blist_icon,            /* list_icon */
-    gaym_blist_emblems,         /* list_emblems */
-    gaym_status_text,           /* status_text */
-    gaym_tooltip_text,          /* tooltip_text */
-    gaym_away_states,           /* away_states */
-    gaym_blist_node_menu,       /* blist_node_menu */
-    gaym_chat_join_info,        /* chat_info */
-    gaym_chat_info_defaults,    /* chat_info_defaults */
-    gaym_login,                 /* login */
-    gaym_close,                 /* close */
-    gaym_im_send,               /* send_im */
-    gaym_set_info,              /* set_info */
-    NULL,                       /* send_typing */
-    gaym_get_info,              /* get_info */
-    gaym_set_away,              /* set_away */
-    NULL,                       /* set_idle */
-    NULL,                       /* change_passwd */
-    gaym_add_buddy,             /* add_buddy */
-    NULL,                       /* add_buddies */
-    gaym_remove_buddy,          /* remove_buddy */
-    NULL,                       /* remove_buddies */
-    gaym_add_permit,            /* add_permit */
-    gaym_add_deny,              /* add_deny */
-    gaym_rem_permit,            /* rem_permit */
-    gaym_rem_deny,              /* rem_deny */
-    gaym_set_permit_deny,       /* set_permit_deny */
-    gaym_warn,                  /* warn */
-    gaym_chat_join,             /* join_chat */
-    NULL,                       /* reject_chat */
-    gaym_get_chat_name,         /* get_chat_name */
-    gaym_chat_invite,           /* chat_invite */
-    gaym_chat_leave,            /* chat_leave */
-    NULL,                       /* chat_whisper */
-    gaym_chat_send,             /* chat_send */
-    NULL,                       /* keepalive */
-    NULL,                       /* register_user */
-    NULL,                       /* get_cb_info */
-    NULL,                       /* get_cb_away */
-    NULL,                       /* alias_buddy */
-    NULL,                       /* group_buddy */
-    NULL,                       /* rename_group */
-    NULL,                       /* buddy_free */
-    NULL,                       /* convo_closed */
-    NULL,                       /* normalize */
-    NULL,                       /* set_buddy_icon */
-    NULL,                       /* remove_group */
-    NULL,                       /* get_cb_real_name */
-    NULL,                       /* set_chat_topic */
-    gaym_find_blist_chat,       /* find_blist_chat */
-    gaym_roomlist_get_list,     /* roomlist_get_list */
-    gaym_roomlist_cancel,       /* roomlist_cancel */
-    gaym_roomlist_expand_category,      /* roomlist_expand_category */
-    NULL,                       /* can_receive_file */
-    gaym_dccsend_send_file      /* send_file */
-};
-
-void deref_one_user(gpointer * user, gpointer * data)
-{
-
-    struct gaym_conn *gaym = (struct gaym_conn *) data;
-    GaimConvChatBuddy *cb = (GaimConvChatBuddy *) user;
-    gaim_debug_misc(&quot;gaym&quot;, &quot;Removing %s in %x from list\n&quot;,
-                    (char *) cb-&gt;name, cb);
-
-    gaim_debug_misc(&quot;    &quot;, &quot;Succes was: %i\n&quot;,
-                    gaym_unreference_channel_member(gaym, cb-&gt;name));
-
-}
-static void gaym_clean_channel_members(GaimConversation * conv)
-{
-
-    g_return_if_fail(conv != NULL);
-
-    if (conv-&gt;type == GAIM_CONV_CHAT) {
-        GaimConvChat *chat = gaim_conversation_get_chat_data(conv);
-        GaimConnection *gc = gaim_conversation_get_gc(conv);
-        g_return_if_fail(gc != NULL);
-        struct gaym_conn *gaym = gc-&gt;proto_data;
-        GList *users = gaim_conv_chat_get_users(chat);
-        gaim_debug_misc(&quot;gaym&quot;, &quot;got userlist %x length %i\n&quot;, users,
-                        g_list_length(users));
-        g_list_foreach(users, (GFunc) deref_one_user, gaym);
-    } else if (conv-&gt;type == GAIM_CONV_IM) {
-        gaim_debug_misc(&quot;gaym&quot;, &quot;removing reference to %s\n&quot;, conv-&gt;name);
-        GaimConnection *gc = gaim_conversation_get_gc(conv);
-        g_return_if_fail(gc != NULL);
-        struct gaym_conn *gaym = gc-&gt;proto_data;
-        gaym_unreference_channel_member(gaym, conv-&gt;name);
-    }
-}
-static void gaym_get_photo_info(GaimConversation * conv)
-{
-    char *buf;
-    char *name;
-    gaim_debug_misc(&quot;gaym&quot;, &quot;Got conversation-created signal\n&quot;);
-    if (strncmp(conv-&gt;account-&gt;protocol_id, &quot;prpl-gaym&quot;, 9) == 0
-        &amp;&amp; gaim_conversation_get_type(conv) == GAIM_CONV_IM) {
-
-        /**
-         * First check to see if we already have the photo via
-         * the buddy list process.
-         */
-
-        struct gaym_conn *gaym;
-
-        GaimConnection *gc = gaim_conversation_get_gc(conv);
-        gaym = (struct gaym_conn *) gc-&gt;proto_data;
-
-        if (!gaym) {
-            return;
-        }
-
-        struct gaym_buddy *ib =
-            g_hash_table_lookup(gaym-&gt;buddies, conv-&gt;name);
-
-        if (ib) {
-            return;
-        }
-
-        /**
-         * Since this person isn't in our buddy list, go ahead
-         * with the WHOIS to get the photo for the IM thumbnail
-         */
-
-
-        name = gaym_nick_to_gcom_strdup(conv-&gt;name);
-        buf = gaym_format(gaym, &quot;vn&quot;, &quot;WHOIS&quot;, name);
-        gaim_debug_misc(&quot;gaym&quot;, &quot;Conversation triggered command: %s\n&quot;,
-                        buf);
-        gaym_send(gaym, buf);
-        gaym_get_channel_member_reference(gaym, name);
-        g_free(name);
-        g_free(buf);
-        // Opens a reference in channel_members.
-
-    }
-}
-
-static GaimPluginPrefFrame *get_plugin_pref_frame(GaimPlugin * plugin)
-{
-    GaimPluginPrefFrame *frame;
-    GaimPluginPref *ppref;
-
-    frame = gaim_plugin_pref_frame_new();
-
-    ppref = gaim_plugin_pref_new_with_label(_(&quot;Chat Rooms&quot;));
-    gaim_plugin_pref_frame_add(frame, ppref);
-
-    ppref =
-        gaim_plugin_pref_new_with_name_and_label
-        (&quot;/plugins/prpl/gaym/show_join&quot;, _(&quot;Show entrance announcement&quot;));
-    gaim_plugin_pref_frame_add(frame, ppref);
-
-    ppref =
-        gaim_plugin_pref_new_with_name_and_label
-        (&quot;/plugins/prpl/gaym/show_bio_with_join&quot;,
-         _(&quot;Show member bio with entrance announcement&quot;));
-    gaim_plugin_pref_frame_add(frame, ppref);
-
-    ppref =
-        gaim_plugin_pref_new_with_name_and_label
-        (&quot;/plugins/prpl/gaym/show_part&quot;, _(&quot;Show exit announcement&quot;));
-    gaim_plugin_pref_frame_add(frame, ppref);
-
-    ppref =
-        gaim_plugin_pref_new_with_name_and_label
-        (&quot;/plugins/prpl/gaym/chat_room_instances&quot;,
-         _(&quot;Number of chat room instances to display&quot;));
-    gaim_plugin_pref_set_bounds(ppref, 0, 9);
-    gaim_plugin_pref_frame_add(frame, ppref);
-
-    ppref =
-        gaim_plugin_pref_new_with_label(_
-                                        (&quot;Bio-Based Chat Room Activity Filtering&quot;));
-    gaim_plugin_pref_frame_add(frame, ppref);
-
-    ppref =
-        gaim_plugin_pref_new_with_name_and_label
-        (&quot;/plugins/prpl/gaym/botfilter_enable&quot;, _(&quot;Enable&quot;));
-    gaim_plugin_pref_frame_add(frame, ppref);
-
-    ppref =
-        gaim_plugin_pref_new_with_name_and_label
-        (&quot;/plugins/prpl/gaym/botfilter_ignore_null&quot;,
-         _(&quot;Ignore if bio is blank&quot;));
-    gaim_plugin_pref_frame_add(frame, ppref);
-
-    ppref =
-        gaim_plugin_pref_new_with_name_and_label
-        (&quot;/plugins/prpl/gaym/botfilter_patterns&quot;,
-         _
-         (&quot;Ignore if bio contains these patterns\n\t? = match any single character\n\t* = match zero, one, or more&quot;));
-    gaim_plugin_pref_frame_add(frame, ppref);
-
-    ppref =
-        gaim_plugin_pref_new_with_name_and_label
-        (&quot;/plugins/prpl/gaym/botfilter_sep&quot;,
-         _(&quot;Above patterns are separated by&quot;));
-    gaim_plugin_pref_set_max_length(ppref, 1);
-    gaim_plugin_pref_frame_add(frame, ppref);
-
-    ppref =
-        gaim_plugin_pref_new_with_name_and_label
-        (&quot;/plugins/prpl/gaym/botfilter_url&quot;,
-         _
-         (&quot;URL for GayBoi's spam database\n\tblank to disable\n\tchanges affect next login\n\tdefault is &quot;
-          GAYBOI_SPAM_URL));
-    gaim_plugin_pref_frame_add(frame, ppref);
-
-    return frame;
-}
-
-static GaimPluginUiInfo prefs_info = {
-    get_plugin_pref_frame
-};
-
-static GaimPluginInfo info = {
-    GAIM_PLUGIN_MAGIC,
-    GAIM_MAJOR_VERSION,
-    GAIM_MINOR_VERSION,
-    GAIM_PLUGIN_PROTOCOL,                                 /**&lt; type           */
-    NULL,                                                 /**&lt; ui_requirement */
-    0,                                                    /**&lt; flags          */
-    NULL,                                                 /**&lt; dependencies   */
-    GAIM_PRIORITY_DEFAULT,                                /**&lt; priority       */
-
-    &quot;prpl-gaym&quot;,                                          /**&lt; id             */
-    &quot;GayM&quot;,                                               /**&lt; name           */
-    VERSION,                                              /**&lt; version        */
-    N_(&quot;GayM Protocol Plugin&quot;),                           /**  summary        */
-    N_(&quot;Gay.com Messaging based on IRC&quot;),                 /**  description    */
-    NULL,                                                 /**&lt; author         */
-    &quot;<A HREF="http://qrc.berlios.de/">http://qrc.berlios.de/</A>&quot;,                             /**&lt; homepage       */
-
-    NULL,                                                 /**&lt; load           */
-    NULL,                                                 /**&lt; unload         */
-    NULL,                                                 /**&lt; destroy        */
-
-    NULL,                                                  /**&lt; ui_info        */
-    &amp;prpl_info,                                           /**&lt; extra_info     */
-    &amp;prefs_info,
-    gaym_actions
-};
-
-static void _init_plugin(GaimPlugin * plugin)
-{
-
-    GaimAccountOption *option;
-
-    option = gaim_account_option_string_new(_(&quot;Bio Line&quot;), &quot;bioline&quot;, &quot;&quot;);
-    prpl_info.protocol_options =
-        g_list_prepend(prpl_info.protocol_options, option);
-
-    option =
-        gaim_account_option_int_new(_(&quot;Port&quot;), &quot;port&quot;, IRC_DEFAULT_PORT);
-    prpl_info.protocol_options =
-        g_list_prepend(prpl_info.protocol_options, option);
-
-    option =
-        gaim_account_option_string_new(_(&quot;Server&quot;), &quot;server&quot;,
-                                       IRC_DEFAULT_SERVER);
-    prpl_info.protocol_options =
-        g_list_prepend(prpl_info.protocol_options, option);
-
-    /**
-     * We have to pull thumbnails, since they aren't pushed like with
-     * other protocols.
-     */
-    gaim_signal_connect(gaim_conversations_get_handle(),
-                        &quot;conversation-created&quot;, plugin,
-                        GAIM_CALLBACK(gaym_get_photo_info), NULL);
-
-
-    gaim_signal_connect(gaim_conversations_get_handle(),
-                        &quot;deleting-conversation&quot;, plugin,
-                        GAIM_CALLBACK(gaym_clean_channel_members), NULL);
-
-    gaim_signal_register(gaim_accounts_get_handle(),
-                         &quot;info-updated&quot;,
-                         gaim_marshal_VOID__POINTER_POINTER, NULL, 2,
-                         gaim_value_new(GAIM_TYPE_SUBTYPE,
-                                        GAIM_SUBTYPE_ACCOUNT),
-                         gaim_value_new(GAIM_TYPE_POINTER,
-                                        GAIM_TYPE_CHAR));
-
-
-
-    gaim_prefs_add_none(&quot;/plugins/prpl/gaym&quot;);
-    gaim_prefs_add_int(&quot;/plugins/prpl/gaym/chat_room_instances&quot;, 4);
-    gaim_prefs_add_bool(&quot;/plugins/prpl/gaym/show_join&quot;, TRUE);
-    gaim_prefs_add_bool(&quot;/plugins/prpl/gaym/show_part&quot;, TRUE);
-    gaim_prefs_add_bool(&quot;/plugins/prpl/gaym/show_bio_with_join&quot;, TRUE);
-
-    gaim_prefs_add_bool(&quot;/plugins/prpl/gaym/botfilter_enable&quot;, FALSE);
-    gaim_prefs_add_bool(&quot;/plugins/prpl/gaym/botfilter_ignore_null&quot;, FALSE);
-    gaim_prefs_add_string(&quot;/plugins/prpl/gaym/botfilter_sep&quot;, &quot;|&quot;);
-    gaim_prefs_add_string(&quot;/plugins/prpl/gaym/botfilter_patterns&quot;,
-                          &quot;NULL|MODE * -i|*dantcamboy*|*Free preview*|*epowerchat*|*Live gay sex cam show*|*camboiz*&quot;);
-    gaim_prefs_add_string(&quot;/plugins/prpl/gaym/botfilter_url&quot;,
-                          GAYBOI_SPAM_URL);
-
-    gaim_prefs_connect_callback(&quot;/plugins/prpl/gaym/botfilter_url&quot;,
-                                botfilter_url_changed_cb, NULL);
-
-    gaim_prefs_add_string(&quot;/plugins/prpl/gaym/botfilter_url_result&quot;, &quot;&quot;);
-    gaim_prefs_add_int(&quot;/plugins/prpl/gaym/botfilter_url_last_check&quot;, 0);
-
-    _gaym_plugin = plugin;
-
-    gaym_register_commands();
-}
-
-GAIM_INIT_PLUGIN(gaym, _init_plugin, info);
-
-
-
-/**
- * vim:tabstop=4:shiftwidth=4:expandtab:
- */

Copied: qrc/tags/release-0.9/gaym/src/gaym.c (from rev 262, qrc/trunk/gaym/src/gaym.c)

Deleted: qrc/tags/release-0.9/gaym/src/gaym.h
===================================================================
--- qrc/trunk/gaym/src/gaym.h	2005-07-30 22:19:23 UTC (rev 259)
+++ qrc/tags/release-0.9/gaym/src/gaym.h	2005-07-31 19:13:29 UTC (rev 264)
@@ -1,247 +0,0 @@
-/**
- * @file gaym.h
- * 
- * gaim
- *
- * Copyright (C) 2003, Ethan Blanton &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/qrc-svn">eblanton at cs.purdue.edu</A>&gt;
- * 
- * This program is free software; you can redistribute it and/or modify
- * it under the terms of the GNU General Public License as published by
- * the Free Software Foundation; either version 2 of the License, or
- * (at your option) any later version.
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- * GNU General Public License for more details.
- *
- * You should have received a copy of the GNU General Public License
- * along with this program; if not, write to the Free Software
- * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
- */
-
-#ifndef _GAIM_GAYM_H
-#define _GAIM_GAYM_H
-
-#include &quot;internal.h&quot;
-
-#include &lt;glib.h&gt;
-
-#include &quot;roomlist.h&quot;
-
-#define IRC_DEFAULT_SERVER &quot;www.gay.com&quot;
-#define IRC_DEFAULT_PORT 7514
-
-#define IRC_DEFAULT_CHARSET &quot;UTF-8&quot;
-#define IRC_DEFAULT_ALIAS &quot;gaim&quot;
-
-#define IRC_INITIAL_BUFSIZE 1024
-
-#define BLIST_UPDATE_PERIOD 60000       /* buddy list updated every 45s */
-#define BLIST_CHUNK_INTERVAL 5000       /* 5s between ISON chunks */
-
-#define MAX_BIO_LEN 150         /* max number of characters in bio */
-
-#define MAX_CHANNEL_MEMBERS 200
-
-#define GAYBOI_SPAM_URL &quot;<A HREF="http://gayboi.org/spam/spamlst.php">http://gayboi.org/spam/spamlst.php</A>&quot;
-
-typedef struct _BListWhois BListWhois;
-struct _BListWhois {
-    int count;
-    GString *string;
-};
-
-enum { IRC_USEROPT_SERVER, IRC_USEROPT_PORT, IRC_USEROPT_CHARSET };
-enum gaym_state { IRC_STATE_NEW, IRC_STATE_ESTABLISHED };
-enum info_string { INFO_AGE, INFO_LOCATION, INFO_BIO, INFO_URL };
-
-struct gaym_conn {
-    GaimAccount *account;
-    GHashTable *msgs;
-    GHashTable *cmds;
-    char *server;
-    int fd;
-    guint timer;
-    GHashTable *buddies;        /* hash table of struct gaym_buddy */
-    GHashTable *channel_members;        /* hash table of struct gaym_buddy 
-                                         */
-
-    char *inbuf;
-    int inbuflen;
-    int inbufused;
-
-    char *thumbnail;
-    char *chat_key;
-    char *server_bioline;
-    char *server_stats;
-    char *roomlist_filter;
-    char *bio;
-
-    gboolean blist_updating;
-    GHashTable *info_window_needed;
-
-    GString *motd;
-    GString *names;
-    char *nameconv;
-    char *traceconv;
-
-    GaimRoomlist *roomlist;
-
-    GList **node_menu;
-    gboolean quitting;
-    char *subroom;
-    GHashTable *confighash;
-    GHashTable *entry_order;
-
-    char *persist_room;
-    gboolean cancelling_persist;
-    void *hammer_cancel_dialog;
-
-};
-
-typedef struct {
-
-    gchar *cookies;
-    GHashTable *cookie_table;
-    void (*session_cb) (GaimAccount *);
-    GaimAccount *account;
-    char *username;
-    char *password;
-    struct gaym_conn *gaym;
-    gboolean hasFormData;
-
-} GaimUrlSession;
-
-typedef struct gaym_buddy GaymBuddy;
-struct gaym_buddy {
-    char *name;                 /* gaym formatted nick */
-    gboolean done;              /* has been checked */
-    gboolean online;            /* is online */
-    gint ref_count;             /* reference count for mem mngmnt */
-    char *bio;                  /* bio string */
-    char *thumbnail;            /* thumbnail string */
-    char *sex;                  /* sex string */
-    char *age;                  /* age string */
-    char *location;             /* location string */
-};
-
-gboolean gaym_unreference_channel_member(struct gaym_conn *gaym,
-                                         gchar * name);
-GaymBuddy *gaym_get_channel_member_info(struct gaym_conn *gaym,
-                                        const gchar * name);
-
-GaymBuddy *gaym_get_channel_member_reference(struct gaym_conn
-                                             *gaym, const char *name);
-typedef int (*IRCCmdCallback) (struct gaym_conn * gaym, const char *cmd,
-                               const char *target, const char **args);
-
-int gaym_send(struct gaym_conn *gaym, const char *buf);
-gboolean gaym_blist_timeout(struct gaym_conn *gaym);
-
-char *gaym_mgaym2html(const char *string);
-char *gaym_mgaym2txt(const char *string);
-
-void gaym_register_commands(void);
-void gaym_msg_table_build(struct gaym_conn *gaym);
-void gaym_parse_msg(struct gaym_conn *gaym, char *input);
-char *gaym_parse_ctcp(struct gaym_conn *gaym, const char *from,
-                      const char *to, const char *msg, int notice);
-char *gaym_format(struct gaym_conn *gaym, const char *format, ...);
-
-typedef void (msg_handler) (struct gaym_conn * gaym, const char *name,
-                            const char *from, char **args);
-msg_handler gaym_msg_away;
-msg_handler gaym_msg_default;
-msg_handler gaym_msg_away;
-msg_handler gaym_msg_badmode;
-msg_handler gaym_msg_banned;
-msg_handler gaym_msg_chanmode;
-msg_handler gaym_msg_endwhois;
-msg_handler gaym_msg_endmotd;
-msg_handler gaym_msg_invite;
-msg_handler gaym_msg_inviteonly;
-msg_handler gaym_msg_who;
-msg_handler gaym_msg_chanfull;
-msg_handler gaym_msg_join;
-msg_handler gaym_msg_kick;
-msg_handler gaym_msg_list;
-msg_handler gaym_msg_login_failed;
-msg_handler gaym_msg_mode;
-msg_handler gaym_msg_motd;
-msg_handler gaym_msg_names;
-msg_handler gaym_msg_nick;
-msg_handler gaym_msg_nickused;
-msg_handler gaym_msg_nochan;
-msg_handler gaym_msg_nonick_chan;
-msg_handler gaym_msg_nonick;
-msg_handler gaym_msg_no_such_nick;
-msg_handler gaym_msg_nochangenick;
-msg_handler gaym_msg_nosend;
-msg_handler gaym_msg_notice;
-msg_handler gaym_msg_notinchan;
-msg_handler gaym_msg_notop;
-msg_handler gaym_msg_part;
-msg_handler gaym_msg_ping;
-msg_handler gaym_msg_pong;
-msg_handler gaym_msg_privmsg;
-msg_handler gaym_msg_regonly;
-msg_handler gaym_msg_quit;
-msg_handler gaym_msg_topic;
-msg_handler gaym_msg_trace;
-msg_handler gaym_msg_unknown;
-msg_handler gaym_msg_wallops;
-msg_handler gaym_msg_whois;
-msg_handler gaym_msg_richnames_list;
-msg_handler gaym_msg_create_pay_only;
-msg_handler gaym_msg_pay_channel;
-msg_handler gaym_msg_toomany_channels;
-msg_handler gaym_msg_list_busy;
-
-
-void gaym_cmd_table_build(struct gaym_conn *gaym);
-
-typedef int (cmd_handler) (struct gaym_conn * gaym, const char *cmd,
-                           const char *target, const char **args);
-
-cmd_handler gaym_cmd_default;
-cmd_handler gaym_cmd_away;
-cmd_handler gaym_cmd_ctcp_action;
-cmd_handler gaym_cmd_invite;
-cmd_handler gaym_cmd_join;
-cmd_handler gaym_cmd_kick;
-cmd_handler gaym_cmd_list;
-cmd_handler gaym_cmd_mode;
-cmd_handler gaym_cmd_names;
-cmd_handler gaym_cmd_nick;
-cmd_handler gaym_cmd_op;
-cmd_handler gaym_cmd_privmsg;
-cmd_handler gaym_cmd_part;
-cmd_handler gaym_cmd_ping;
-cmd_handler gaym_cmd_quit;
-cmd_handler gaym_cmd_quote;
-cmd_handler gaym_cmd_query;
-cmd_handler gaym_cmd_remove;
-cmd_handler gaym_cmd_topic;
-cmd_handler gaym_cmd_trace;
-cmd_handler gaym_cmd_wallops;
-cmd_handler gaym_cmd_whois;
-
-
-void gaym_dccsend_send_file(GaimConnection * gc, const char *who,
-                            const char *file);
-void gaym_dccsend_recv(struct gaym_conn *gaym, const char *from,
-                       const char *msg);
-void gaym_get_chat_key_from_weblogin(GaimAccount * account,
-                                     void (*callback) (GaimAccount *));
-
-void gaim_session_fetch(const char *url, gboolean full,
-                        const char *user_agent, gboolean http11,
-                        void (*cb) (gpointer, const char *, size_t),
-                        void *user_data, GaimUrlSession * session);
-
-#endif                          /* _GAIM_GAYM_H */
-
-/**
- * vim:tabstop=4:shiftwidth=4:expandtab:
- */

Copied: qrc/tags/release-0.9/gaym/src/gaym.h (from rev 262, qrc/trunk/gaym/src/gaym.h)

Deleted: qrc/tags/release-0.9/gaym/src/gayminfo.c
===================================================================
--- qrc/trunk/gaym/src/gayminfo.c	2005-07-30 22:19:23 UTC (rev 259)
+++ qrc/tags/release-0.9/gaym/src/gayminfo.c	2005-07-31 19:13:29 UTC (rev 264)
@@ -1,310 +0,0 @@
-/**
- * @file gayminfo.c
- *
- * GayM
- *
- * GayM is the legal property of its developers, whose names are too numerous
- * to list here.  Please refer to the COPYRIGHT file distributed with this
- * source distribution.
- *
- * This program is free software; you can redistribute it and/or modify
- * it under the terms of the GNU General Public License as published by
- * the Free Software Foundation; either version 2 of the License, or
- * (at your option) any later version.
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- * GNU General Public License for more details.
- *
- * You should have received a copy of the GNU General Public License
- * along with this program; if not, write to the Free Software
- * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
- */
-
-#include &quot;gayminfo.h&quot;
-#include &quot;util.h&quot;
-#include &quot;debug.h&quot;
-
-char *gaym_thumbnail_strdup(const char *info)
-{
-    char *start = strchr(info, ':');
-    char *end = 0;
-    if (start) {
-        start++;
-        end = strchr(info, '#');
-    }
-    if (start != end &amp;&amp; end) {
-        return g_strdup_printf(&quot;%.*s&quot;, end - start, start);
-    } else {
-        return 0;
-    }
-}
-
-char *gaym_bio_strdup(const char *info)
-{
-    char *start = strchr(info, '#');
-    char *end = 0;
-    if (start) {
-        start++;
-        end = strchr(start, 0x01);
-        if (!end)
-            end = strchr(start, 0);
-    }
-
-    if ((end) &amp;&amp; (start &lt; end)) {
-        return g_strdup_printf(&quot;%.*s&quot;, end - start, start);
-    } else {
-        return 0;
-    }
-}
-
-char *gaym_stats_strdup(const char *info)
-{
-
-    char *start = strchr(info, '#');
-
-    if (start)
-        start = strchr(start, 0x01);
-
-    char *end = 0;
-    if (start) {
-        start++;
-        end = strchr(info, '\0');
-    }
-
-    if (start != end &amp;&amp; end) {
-        return g_strdup_printf(&quot;%.*s&quot;, end - start, start);
-    } else {
-        return 0;
-    }
-}
-
-
-void gaym_update_channel_member(struct gaym_conn *gaym, const char *nick,
-                                const char *info)
-{
-    GaymBuddy *cm = gaym_get_channel_member_reference(gaym, nick);
-    if (!cm) {
-        gaim_debug_error(&quot;gaym&quot;,
-                         &quot;ERROR: A member has joined a channel, or a conversation was opened, but we were unable to add the member to the internal management structure. Report a bug.&quot;);
-        return;
-    } else {
-        gchar *stats = gaym_stats_strdup(info);
-        if (stats) {
-            gchar **s = g_strsplit(stats, &quot;|&quot;, 3);
-            if (s[0] &amp;&amp; strlen(g_strstrip(s[0])) &gt; 0) {
-                cm-&gt;sex = g_ascii_strup(s[0], -1);
-            }
-            if (s[1] &amp;&amp; strlen(g_strstrip(s[1])) &gt; 0) {
-                cm-&gt;age = g_strdup(s[1]);
-            }
-            if (s[2] &amp;&amp; strlen(g_strstrip(s[2])) &gt; 0) {
-                cm-&gt;location = g_strdup(s[2]);
-            }
-            g_strfreev(s);
-            g_free(stats);
-        }
-        cm-&gt;name = g_strdup(nick);
-        cm-&gt;bio = gaym_bio_strdup(info);
-        cm-&gt;thumbnail = gaym_thumbnail_strdup(info);
-
-    }
-}
-void gaym_fetch_thumbnail_cb(void *user_data, const char *pic_data,
-                             size_t len)
-{
-    if (!user_data)
-        return;
-    struct gaym_fetch_thumbnail_data *d = user_data;
-    if (!pic_data) {
-        return;
-    }
-
-    if (len &amp;&amp; !g_strrstr_len(pic_data, len, &quot;Server Error&quot;)) {
-        char *dir =
-            g_build_filename(gaim_user_dir(), &quot;icons&quot;, &quot;gaym&quot;, d-&gt;who,
-                             NULL);
-        char *filename = g_strdup(d-&gt;filename);
-        char *path = g_build_filename(dir, filename, NULL);
-        gaim_debug_misc(&quot;gayminfo&quot;, &quot;dir: %s\n&quot;, dir);
-        gaim_debug_misc(&quot;gayminfo&quot;, &quot;filename: %s\n&quot;, filename);
-        gaim_debug_misc(&quot;gayminfo&quot;, &quot;path: %s\n&quot;, path);
-        if (!g_file_test(dir, G_FILE_TEST_EXISTS))
-            gaim_build_dir(dir, S_IRUSR | S_IWUSR | S_IXUSR);
-
-        if (path &amp;&amp; !g_file_test(path, G_FILE_TEST_EXISTS)) {
-            FILE *file;
-            if ((file = g_fopen(path, &quot;wb&quot;))) {
-                fwrite(pic_data, 1, len, file);
-                fclose(file);
-            } else {
-                gaim_debug_misc(&quot;fetch_thumbnail_cb&quot;,
-                                &quot;Couldn't write file\n&quot;);
-            }
-            g_free(filename);
-            g_free(path);
-            g_free(dir);
-        }
-    }
-    if (GAIM_CONNECTION_IS_VALID(d-&gt;gc) &amp;&amp; len) {
-        gaim_signal_emit(gaim_accounts_get_handle(), &quot;info-updated&quot;,
-                         d-&gt;gc, NULL, d-&gt;who);
-        if (gaim_find_conversation_with_account(d-&gt;who, d-&gt;gc-&gt;account)) {
-            gaim_buddy_icons_set_for_user(gaim_connection_get_account
-                                          (d-&gt;gc), d-&gt;who,
-                                          (void *) pic_data, len);
-        }
-
-    } else {
-        gaim_debug_error(&quot;gaym&quot;, &quot;Fetching buddy icon failed.\n&quot;);
-    }
-
-    g_free(d-&gt;who);
-    g_free(d);
-}
-
-void gaym_buddy_status(struct gaym_conn *gaym, char *name,
-                       gboolean online, char *info)
-{
-    char *bio = NULL;
-    char *thumbnail = NULL;
-    char *stats = NULL;
-    char *url = NULL;
-    struct gaym_fetch_thumbnail_data *data;
-
-    if (!gaym || !gaym-&gt;account || !gaym-&gt;buddies || !name) {
-        return;
-    }
-
-    if (info) {
-        bio = gaym_bio_strdup(info);
-        if (bio) {
-            bio = g_strstrip(bio);
-        }
-
-        thumbnail = gaym_thumbnail_strdup(info);
-        if (thumbnail) {
-            thumbnail = g_strstrip(thumbnail);
-        }
-
-        stats = gaym_stats_strdup(info);
-        if (stats) {
-            stats = g_strstrip(stats);
-        }
-    }
-
-    GaimConnection *gc = gaim_account_get_connection(gaym-&gt;account);
-
-    if (!gc) {
-        return;
-    }
-
-    struct gaym_buddy *ib = g_hash_table_lookup(gaym-&gt;buddies, name);
-
-    char *normalized = g_strdup(gaim_normalize(gaym-&gt;account, name));
-
-    if (thumbnail) {
-        gboolean do_fetch = 1;
-        GError *err = NULL;
-        if (!ib || gaim_utf8_strcasecmp(thumbnail, ib-&gt;thumbnail)) {
-            char *dirname =
-                g_build_filename(gaim_user_dir(), &quot;icons&quot;, &quot;gaym&quot;,
-                                 gaim_normalize(gaym-&gt;account, name),
-                                 NULL);
-            GDir *gdir = g_dir_open(dirname, 0, &amp;err);
-            if (gdir) {
-                const char *filename;
-
-                while ((filename = g_dir_read_name(gdir)))      // don't
-                    // free
-                    // filename: 
-                    // owned
-                    // by
-                    // glib.
-                {
-                    char *thumbnail_base = g_path_get_basename(thumbnail);
-                    gaim_debug_misc(&quot;gaym&quot;, &quot;compared %s and %s\n&quot;,
-                                    thumbnail_base, filename);
-                    if (!gaim_utf8_strcasecmp(thumbnail_base, filename)) {
-                        do_fetch = 0;
-                        break;
-                    }
-                    g_free(thumbnail_base);
-                }
-            }
-            if (do_fetch) {
-
-                gaim_debug_misc(&quot;gaym&quot;,
-                                &quot;********************************************\n&quot;);
-                gaim_debug_misc(&quot;gaym&quot;,
-                                &quot;*****************FETCH**********************\n&quot;);
-                gaim_debug_misc(&quot;gaym&quot;,
-                                &quot;********************************************\n&quot;);
-                char *hashurl = NULL;
-                hashurl =
-                    g_hash_table_lookup(gaym-&gt;confighash,
-                                        &quot;mini-profile-panel.thumbnail-prefix&quot;);
-                g_return_if_fail(hashurl != NULL);
-                data = g_new0(struct gaym_fetch_thumbnail_data, 1);
-                data-&gt;gc = gaim_account_get_connection(gaym-&gt;account);
-                data-&gt;who = g_strdup(gaim_normalize(gaym-&gt;account, name));
-                data-&gt;filename = g_strdup(g_strrstr(thumbnail, &quot;/&quot;));
-                gaim_debug_misc(&quot;gayminfo&quot;, &quot;Found filename: %s\n&quot;,
-                                data-&gt;filename);
-                url = g_strdup_printf(&quot;%s%s&quot;, hashurl, thumbnail);
-                gaim_url_fetch(url, FALSE, &quot;Mozilla/4.0&quot;, FALSE,
-                               gaym_fetch_thumbnail_cb, data);
-                g_free(url);
-            }
-
-        }
-    }
-
-    g_free(normalized);
-
-    if (ib) {
-        g_free(ib-&gt;bio);
-        ib-&gt;bio = NULL;
-        g_free(ib-&gt;thumbnail);
-        ib-&gt;thumbnail = NULL;
-        g_free(ib-&gt;sex);
-        ib-&gt;sex = NULL;
-        g_free(ib-&gt;age);
-        ib-&gt;age = NULL;
-        g_free(ib-&gt;location);
-        ib-&gt;location = NULL;
-
-        ib-&gt;online = online;
-
-        if (bio &amp;&amp; strlen(g_strstrip(bio)) &gt; 0) {
-            ib-&gt;bio = bio;
-        }
-        if (thumbnail &amp;&amp; strlen(g_strstrip(thumbnail)) &gt; 0) {
-            ib-&gt;thumbnail = thumbnail;
-        }
-        if (stats &amp;&amp; strlen(g_strstrip(stats)) &gt; 0) {
-            gchar **s = g_strsplit(stats, &quot;|&quot;, 3);
-            if (s[0] &amp;&amp; strlen(g_strstrip(s[0])) &gt; 0) {
-                ib-&gt;sex = g_ascii_strup(s[0], -1);
-            }
-            if (s[1] &amp;&amp; strlen(g_strstrip(s[1])) &gt; 0) {
-                ib-&gt;age = g_strdup(s[1]);
-            }
-            if (s[2] &amp;&amp; strlen(g_strstrip(s[2])) &gt; 0) {
-                ib-&gt;location = g_strdup(s[2]);
-            }
-            g_strfreev(s);
-            g_free(stats);
-        }
-        GaimBuddy *buddy = gaim_find_buddy(gaym-&gt;account, name);
-        if (buddy) {
-            serv_got_update(gc, buddy-&gt;name, online, 0, 0, 0, 0);
-        }
-    }
-    return;
-}
-
-/**
- * vim:tabstop=4:shiftwidth=4:expandtab:
- */

Copied: qrc/tags/release-0.9/gaym/src/gayminfo.c (from rev 261, qrc/trunk/gaym/src/gayminfo.c)

Deleted: qrc/tags/release-0.9/gaym/src/gayminfo.h
===================================================================
--- qrc/trunk/gaym/src/gayminfo.h	2005-07-30 22:19:23 UTC (rev 259)
+++ qrc/tags/release-0.9/gaym/src/gayminfo.h	2005-07-31 19:13:29 UTC (rev 264)
@@ -1,98 +0,0 @@
-/**
- * @file gayminfo.h GayM User Info (IRC-based) API
- *
- * GayM
- *
- * GayM is the legal property of its developers, whose names are too numerous
- * to list here.  Please refer to the COPYRIGHT file distributed with this
- * source distribution.
- *
- * This program is free software; you can redistribute it and/or modify
- * it under the terms of the GNU General Public License as published by
- * the Free Software Foundation; either version 2 of the License, or
- * (at your option) any later version.
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- * GNU General Public License for more details.
- *
- * You should have received a copy of the GNU General Public License
- * along with this program; if not, write to the Free Software
- * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
- */
-#ifndef _GAIM_GAYM_GAYMINFO_H_
-#define _GAIM_GAYM_GAYMINFO_H_
-
-#include &lt;glib.h&gt;
-
-#include &quot;gaym.h&quot;
-
-/**
- * Begin temporary, pending further refactoring
- */
-#include &quot;connection.h&quot;
-struct gaym_fetch_thumbnail_data {
-    GaimConnection *gc;
-    char *who;
-    char *filename;
-    char *bio;
-    char *stats;
-    // const char *pic_data;
-    // gint pic_data_len;
-};
-void gaym_fetch_thumbnail_cb(void *user_data, const char *pic_data,
-                             size_t len);
-/**
- * End temporary, pending further refactoring
- */
-
-/**
- * Extract the thumbnail string from the extra IRC info about the user.
- * The returned string should be freed when no longer needed.
- *
- * @param info The extra IRC info string.
- *
- * @return The thumbnail string.
- */
-char *gaym_thumbnail_strdup(const char *info);
-
-/**
- * Extract the bio string from the extra IRC info about the user.
- * The returned string should be freed when no longer needed.
- *
- * @param info The extra IRC info string.
- *
- * @return The bio string.
- */
-char *gaym_bio_strdup(const char *info);
-
-/**
- * Extract the stats string from the extra IRC info about the user.
- * The returned string should be freed when no longer needed.
- *
- * @param info The extra IRC info string.
- *
- * @return The stats string.
- */
-char *gaym_stats_strdup(const char *info);
-
-/**
- * Process extra IRC information about a buddy
- *
- * @param gaym The protocol-specific data related to the connection.
- * @param name The buddy name
- * @param online Is the buddy on line.
- * @param info The extra IRC info string about the buddy, if any.
- */
-void gaym_buddy_status(struct gaym_conn *gaym, char *name,
-                       gboolean online, char *info);
-
-
-void gaym_update_channel_member(struct gaym_conn *gaym, const char *nick,
-                                const char *info);
-#endif                          /* _GAIM_GAYM_GAYMINFO_H_ */
-
-/**
- * vim:tabstop=4:shiftwidth=4:expandtab:
- */

Copied: qrc/tags/release-0.9/gaym/src/gayminfo.h (from rev 261, qrc/trunk/gaym/src/gayminfo.h)

Deleted: qrc/tags/release-0.9/gaym/src/helpers.c
===================================================================
--- qrc/trunk/gaym/src/helpers.c	2005-07-30 22:19:23 UTC (rev 259)
+++ qrc/tags/release-0.9/gaym/src/helpers.c	2005-07-31 19:13:29 UTC (rev 264)
@@ -1,509 +0,0 @@
-/**
- * GayM
- *
- * GayM is the legal property of its developers, whose names are too numerous
- * to list here.  Please refer to the COPYRIGHT file distributed with this
- * source distribution.
- *
- * This program is free software; you can redistribute it and/or modify
- * it under the terms of the GNU General Public License as published by
- * the Free Software Foundation; either version 2 of the License, or
- * (at your option) any later version.
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- * GNU General Public License for more details.
- *
- * You should have received a copy of the GNU General Public License
- * along with this program; if not, write to the Free Software
- * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
- */
-#include &quot;internal.h&quot;
-#include &quot;debug.h&quot;
-#include &quot;helpers.h&quot;
-
-void gcom_nick_to_gaym(char *nick)
-{
-    int i = 0;
-
-    if (!nick) {
-        return;
-    }
-
-    /**
-     * If there is a &quot;|&quot; in the first position, it must be removed.
-     */
-    if (nick[0] == '|') {
-        nick[0] = ' ';
-        nick = g_strchug(nick);
-    }
-
-    /**
-     * Any remaining &quot;|&quot; must be replaced with &quot;.&quot;
-     */
-    for (i = 0; i &lt; strlen(nick); i++) {
-        if (nick[i] == '|') {
-            nick[i] = '.';
-        }
-    }
-    return;
-}
-
-char *gaym_nick_to_gcom_strdup(const char *nick)
-{
-    int i = 0;
-    char *converted = NULL;
-
-    /**
-     * If the first character is not an upper or lower case letter
-     * then gay.com's IRC server requires &quot;|&quot; to be prepended
-     */
-    if (g_ascii_isalpha(nick[0])) {
-        converted = g_strdup_printf(&quot;%s&quot;, nick);
-    } else {
-        converted = g_strdup_printf(&quot;|%s&quot;, nick);
-    }
-
-    /**
-     * gay.com's IRC server requires all &quot;.&quot; in nicks to be represented
-     * by &quot;|&quot;
-     */
-    for (i = 0; i &lt; strlen(converted); i++) {
-        if (converted[i] == '.') {
-            converted[i] = '|';
-        }
-    }
-    return converted;
-}
-
-char *return_string_between(const char *startbit, const char *endbit,
-                            const char *source)
-{
-    char *start = 0;
-    char *end = 0;
-
-    if (!source || !startbit || !endbit)
-        return 0;
-
-    start = strstr(source, startbit);
-
-    if (start) {
-        start += strlen(startbit);
-        end = strstr(start, endbit);
-    }
-    /**
-     * gaim_debug_misc(&quot;gaym&quot;, &quot;source: %d; start: %d; end: %d\n&quot;, source,
-     * start, end);
-     */
-    if (start &amp;&amp; end) {
-        return g_strdup_printf(&quot;%.*s&quot;, end - start, start);
-    } else {
-        return 0;
-    }
-}
-
-gchar *ascii2native(const gchar * str)
-{
-    gint i;                     /* Temp variable */
-    gint len = strlen(str);
-
-    /**
-     * This allocates enough space, and probably a little too much.
-     */
-    gchar *outstr = g_malloc(len * sizeof(guchar));
-
-    gint pos = 0;               /* Current position in the output string. */
-    for (i = 0; i &lt; len; i++) {
-        /**
-         * If we see a '\u' then parse it.
-         */
-        if (((char) *(str + i) == '\\')
-            &amp;&amp; (((char) *(str + i + 1)) == 'u')
-            &amp;&amp; (g_ascii_isxdigit((char) *(str + i + 2)))
-            &amp;&amp; (g_ascii_isxdigit((char) *(str + i + 3)))
-            &amp;&amp; (g_ascii_isxdigit((char) *(str + i + 4)))
-            &amp;&amp; (g_ascii_isxdigit((char) *(str + i + 5)))) {
-
-            gint bytes;
-            gchar unibuf[6];
-            gunichar value = 0;
-
-            /**
-             * Assumption that the /u will be followed by 4 hex digits.
-             * &lt;&lt;12 to multiply by 16^3, &lt;&lt;8 for 16^2, &lt;&lt;4 for 16
-             * I.e., each hex digit
-             */
-            value = (g_ascii_xdigit_value((gchar) * (str + i + 2)) &lt;&lt; 12) +
-                (g_ascii_xdigit_value((gchar) * (str + i + 3)) &lt;&lt; 8) +
-                (g_ascii_xdigit_value((gchar) * (str + i + 4)) &lt;&lt; 4) +
-                (g_ascii_xdigit_value((gchar) * (str + i + 5)));
-
-            bytes = g_unichar_to_utf8(value, unibuf);
-            int j;
-            for (j = 0; j &lt; bytes; j++) {
-                outstr[pos++] = unibuf[j];
-            }
-            /**
-             * Move past the entire escape sequence.
-             */
-            i += 5;
-        }
-        /**
-         * Otherwise, just copy the byte.
-         */
-        else {
-            outstr[pos++] = str[i];
-        }
-    }
-    return outstr;
-}
-
-gboolean gaym_nick_check(const char *nick)
-{
-    gboolean retval = FALSE;
-
-    if (!nick) {
-        return retval;
-    }
-
-    char *allowed =
-        &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_.-\0&quot;;
-    int i = 0;
-    int j = 0;
-
-    /**
-     * validate characters
-     */
-    for (i = 0; nick[i]; i++) {
-        retval = FALSE;
-        for (j = 0; allowed[j]; j++) {
-            if (nick[i] == allowed[j]) {
-                retval = TRUE;
-                break;
-            }
-        }
-        if (!retval) {
-            break;
-        }
-    }
-    if (!retval) {
-        return retval;
-    }
-    /**
-     * validate length
-     */
-    if (i &gt; 30) {
-        retval = FALSE;
-        return retval;
-    }
-    /**
-     * its valid!
-     */
-    return retval;
-}
-
-void replace_dollar_n(gpointer key, gpointer value, gpointer user_data)
-{
-
-    /**
-     * replace $[0-9] with %s, so we can use printf style
-     * processing with the provided property values
-     */
-    gchar *pos = (gchar *) value;
-    while ((pos = (strchr(pos, '$')))) {
-        pos++;
-        if (g_ascii_isdigit(*pos)) {
-            *pos = 's';
-            *(pos - 1) = '%';
-
-        }
-    }
-}
-
-GHashTable *gaym_properties_new(const gchar * str)
-{
-
-    gchar *tmpstr = NULL;
-    gchar **tmparr = NULL;
-    gchar **proparr = NULL;
-    int i = 0;
-
-    GHashTable *props =
-        g_hash_table_new_full(g_str_hash, g_str_equal, g_free, g_free);
-
-    /**
-     * convert ascii-escaped to native
-     */
-    tmpstr = ascii2native(str);
-
-    /**
-     * strip out continuation character followed by newline 
-     */
-    // tmparr = g_strsplit(tmpstr, &quot;\\\n&quot;, -1);
-    // g_free(tmpstr);
-    // tmpstr = g_strjoinv(NULL, tmparr);
-    // g_strfreev(tmparr);
-    /**
-     * Since the properties get stripped of spaces later,
-     * just replace \\\n with &lt;space&gt;\n in-place, for speed.
-     * */
-    char *pos = tmpstr;
-    while ((pos = g_strrstr(pos, &quot;\\\n&quot;))) {
-        *pos = ' ';
-        *(pos + 1) = ' ';
-    }
-    /**
-     * We're getting close.  Now we need an array as follows:
-     *
-     * property=value
-     * property=value
-     * ...
-     */
-    tmparr = g_strsplit(tmpstr, &quot;\n&quot;, -1);
-
-    for (i = 0; tmparr[i] != NULL; i++) {
-        /**
-         * do nothing if this is a blank line
-         */
-        if (strlen(g_strstrip(tmparr[i])) == 0) {
-            continue;
-        }
-        /**
-         * do nothing if this is a comment line
-         */
-        if (tmparr[i][0] == '#') {
-            continue;
-        }
-        /**
-         * this must be a property=value string, so we make
-         * it into a 2-element array:
-         *
-         * property
-         * value
-         *
-         * but we won't store it in our hash table unless both
-         * have real values after stripping whitespace
-         */
-        proparr = g_strsplit(tmparr[i], &quot;=&quot;, 2);
-        if (proparr[0] &amp;&amp; strlen(g_strstrip(proparr[0])) &gt; 0
-            &amp;&amp; proparr[1] &amp;&amp; strlen(g_strstrip(proparr[1])) &gt; 0) {
-
-            g_hash_table_insert(props, g_strdup(proparr[0]),
-                                g_strdup(proparr[1]));
-
-        }
-        g_strfreev(proparr);
-    }
-
-    g_strfreev(tmparr);
-
-    g_hash_table_foreach(props, replace_dollar_n, NULL);
-
-    return props;
-}
-
-int roomlist_level_strip(char *description)
-{
-    int val = 0;
-    int i = 0;
-
-    if (!description) {
-        return val;
-    }
-
-    for (i = 0; i &lt; strlen(description); i++) {
-        if (description[i] == '+') {
-            description[i] = ' ';
-        } else {
-            break;
-        }
-        val++;
-    }
-
-    description = g_strchug(description);
-
-    return val;
-}
-
-GaimRoomlistRoom *find_parent(int level, int old_level,
-                              GaimRoomlistRoom * last_room)
-{
-    GaimRoomlistRoom *parent = NULL;
-    int i = 0;
-
-    if (level == 0) {
-        /* do nothing */
-    } else if (level == old_level) {
-        parent = last_room-&gt;parent;
-    } else if (level &gt; old_level) {
-        parent = last_room;
-    } else if (level &lt; old_level) {
-        parent = last_room;
-        for (i = old_level - level; i &gt;= 0; i--) {
-            parent = parent-&gt;parent;
-        }
-    }
-    return parent;
-}
-
-void build_roomlist_from_config(GaimRoomlist * roomlist,
-                                GHashTable * confighash, gchar * pattern)
-{
-    gchar **roominst = NULL;
-    gchar *altname = NULL;
-    gchar *normalized = NULL;
-    gchar *lowercase = NULL;
-    gchar *found = NULL;
-    int level = 0;
-    int old_level = 0;
-    int i = 0;
-    GaimRoomlistRoom *room = NULL;
-    GaimRoomlistRoom *parent = NULL;
-
-    g_return_if_fail(roomlist != NULL);
-    g_return_if_fail(confighash != NULL);
-
-    int max = gaim_prefs_get_int(&quot;/plugins/prpl/gaym/chat_room_instances&quot;);
-
-    gchar *roomstr = g_hash_table_lookup(confighash, &quot;roomlist&quot;);
-    g_return_if_fail(roomstr != NULL);
-
-    gchar **roomarr = g_strsplit(roomstr, &quot;|&quot;, -1);
-
-    /**
-     * We need to skip the first instance, because they start
-     * with a &quot;|&quot;, which we've just split by, leaving a blank
-     * at the beginning of the list
-     */
-    for (i = 1; roomarr[i] != NULL; i++) {
-        if (roomarr[i][0] == '#') {
-            /**
-             * This is an actual room string, break it into its
-             * component parts, determine the level and the parent,
-             * and add this as both a room and a category
-             */
-            if (pattern != NULL) {
-                lowercase = g_utf8_strdown(roomarr[i], -1);
-                normalized =
-                    g_utf8_normalize(lowercase, -1, G_NORMALIZE_ALL);
-                found = g_strstr_len(normalized, -1, pattern);
-                g_free(normalized);
-                g_free(lowercase);
-            }
-            if (found != NULL || pattern == NULL) {
-                found = NULL;
-                roominst = g_strsplit(roomarr[i], &quot; &quot;, 2);
-                level = roomlist_level_strip(roominst[1]);
-                parent = find_parent(level, old_level, room);
-                altname = g_strdup_printf(&quot;%s:*&quot;, roominst[1]);
-                if (max == 0) {
-                    room =
-                        gaim_roomlist_room_new(GAIM_ROOMLIST_ROOMTYPE_ROOM,
-                                               altname, parent);
-                } else {
-                    room =
-                        gaim_roomlist_room_new
-                        (GAIM_ROOMLIST_ROOMTYPE_CATEGORY |
-                         GAIM_ROOMLIST_ROOMTYPE_ROOM, altname, parent);
-                }
-                gaim_roomlist_room_add_field(roomlist, room, altname);
-                gaim_roomlist_room_add_field(roomlist, room, roominst[0]);
-                gaim_roomlist_room_add(roomlist, room);
-                g_free(altname);
-                g_strfreev(roominst);
-                old_level = level;
-            }
-        } else if (pattern == NULL) {
-            /**
-             * This is a plain category, determine the level and
-             * the parent and add it.
-             */
-            level = roomlist_level_strip(roomarr[i]);
-            parent = find_parent(level, old_level, room);
-            room =
-                gaim_roomlist_room_new(GAIM_ROOMLIST_ROOMTYPE_CATEGORY,
-                                       roomarr[i], parent);
-            gaim_roomlist_room_add(roomlist, room);
-        }
-        old_level = level;
-    }
-    g_strfreev(roomarr);
-    gaim_roomlist_set_in_progress(roomlist, FALSE);
-}
-
-GaimConvChatBuddyFlags chat_pecking_order(const char *extra)
-{
-    GaimConvChatBuddyFlags flags = GAIM_CBFLAGS_NONE;
-    if (extra[0] == '1' &amp;&amp; extra[1] == '8') {
-        /* profile and g-rated photo */
-        flags = GAIM_CBFLAGS_FOUNDER;
-    } else if (extra[0] == '1' &amp;&amp; extra[1] == '9') {
-        /* profile and x-rated photo */
-        flags = GAIM_CBFLAGS_OP;
-    } else if (extra[0] == '8') {
-        /* profile but no photo */
-        flags = GAIM_CBFLAGS_HALFOP;
-    } else if (extra[0] == '0') {
-        /* no profile and no photo */
-        flags = GAIM_CBFLAGS_NONE;
-    } else {
-        /* unknown */
-        flags = GAIM_CBFLAGS_VOICE;
-    }
-    return flags;
-}
-
-char *build_tooltip_text(struct gaym_buddy *ib)
-{
-    char *escaped;
-    GString *tooltip = g_string_new(&quot;&quot;);
-    g_string_printf(tooltip, &quot;&lt;b&gt;&lt;i&gt;%s&lt;/i&gt;&lt;/b&gt;&quot;, ib-&gt;name);
-
-    g_return_val_if_fail(ib != NULL, NULL);
-
-    if (ib-&gt;sex) {
-        escaped = g_markup_escape_text(ib-&gt;sex, strlen(ib-&gt;sex));
-        g_string_append_printf(tooltip, _(&quot;\n&lt;b&gt;%s:&lt;/b&gt; %s&quot;), _(&quot;Sex&quot;),
-                               escaped);
-        g_free(escaped);
-    }
-
-    if (ib-&gt;age) {
-        escaped = g_markup_escape_text(ib-&gt;age, strlen(ib-&gt;age));
-        g_string_append_printf(tooltip, _(&quot;\n&lt;b&gt;%s:&lt;/b&gt; %s&quot;), _(&quot;Age&quot;),
-                               escaped);
-        g_free(escaped);
-    }
-    if (ib-&gt;location) {
-        escaped = g_markup_escape_text(ib-&gt;location, strlen(ib-&gt;location));
-        g_string_append_printf(tooltip, _(&quot;\n&lt;b&gt;%s:&lt;/b&gt; %s&quot;),
-                               _(&quot;Location&quot;), escaped);
-        g_free(escaped);
-    }
-
-    if (ib-&gt;bio) {
-        escaped = g_markup_escape_text(ib-&gt;bio, strlen(ib-&gt;bio));
-        g_string_append_printf(tooltip, _(&quot;\n&lt;b&gt;%s:&lt;/b&gt; %s&quot;), _(&quot;Bio&quot;),
-                               escaped);
-        g_free(escaped);
-    }
-
-    if (tooltip-&gt;len == 0) {
-        g_string_append_printf(tooltip, _(&quot; No info.&quot;));
-    }
-    // g_string_erase(tooltip, 0, 1);
-
-    return g_string_free(tooltip, FALSE);
-}
-
-GaimConvChatBuddyFlags include_chat_entry_order(GaimConvChatBuddyFlags
-                                                flags, gint entry)
-{
-
-    return (flags | (entry &lt;&lt; 4));
-}
-
-/**
- * vim:tabstop=4:shiftwidth=4:expandtab:
- */

Copied: qrc/tags/release-0.9/gaym/src/helpers.c (from rev 261, qrc/trunk/gaym/src/helpers.c)

Deleted: qrc/tags/release-0.9/gaym/src/msgs.c
===================================================================
--- qrc/trunk/gaym/src/msgs.c	2005-07-30 22:19:23 UTC (rev 259)
+++ qrc/tags/release-0.9/gaym/src/msgs.c	2005-07-31 19:13:29 UTC (rev 264)
@@ -1,1331 +0,0 @@
-/**
- * @file msgs.c
- *
- * GayM
- *
- * GayM is the legal property of its developers, whose names are too numerous
- * to list here.  Please refer to the COPYRIGHT file distributed with this
- * source distribution.
- *
- * This program is free software; you can redistribute it and/or modify
- * it under the terms of the GNU General Public License as published by
- * the Free Software Foundation; either version 2 of the License, or
- * (at your option) any later version.
- *
- * This program is distributed in the hope that it will be useful,
- * but WITHOUT ANY WARRANTY; without even the implied warranty of
- * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- * GNU General Public License for more details.
- *
- * You should have received a copy of the GNU General Public License
- * along with this program; if not, write to the Free Software
- * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
- */
-
-#include &quot;internal.h&quot;
-#include &quot;conversation.h&quot;
-#include &quot;blist.h&quot;
-#include &quot;notify.h&quot;
-#include &quot;util.h&quot;
-#include &quot;debug.h&quot;
-#include &quot;imgstore.h&quot;
-#include &quot;request.h&quot;
-#include &quot;privacy.h&quot;
-#include &quot;prefs.h&quot;
-
-#include &quot;botfilter.h&quot;
-#include &quot;gaym.h&quot;
-#include &quot;gayminfo.h&quot;
-#include &quot;gaympriv.h&quot;
-#include &quot;helpers.h&quot;
-
-static char *gaym_mask_nick(const char *mask)
-{
-    char *end, *buf;
-
-    end = strchr(mask, '!');
-    if (!end)
-        buf = g_strdup(mask);
-    else
-        buf = g_strndup(mask, end - mask);
-
-    return buf;
-}
-
-static void gaym_chat_remove_buddy(GaimConversation * convo, char *data[2])
-{
-    /**
-     * FIXME: is *message ever used ???
-     */
-    char *message = g_strdup_printf(&quot;quit: %s&quot;, data[1]);
-
-    if (gaim_conv_chat_find_user(GAIM_CONV_CHAT(convo), data[0]))
-        gaim_conv_chat_remove_user(GAIM_CONV_CHAT(convo), data[0], NULL);
-
-    g_free(message);
-}
-
-void gaym_msg_default(struct gaym_conn *gaym, const char *name,
-                      const char *from, char **args)
-{
-    gaim_debug(GAIM_DEBUG_INFO, &quot;gaym&quot;, &quot;Unrecognized message: %s\n&quot;,
-               args[0]);
-}
-
-void gaym_msg_away(struct gaym_conn *gaym, const char *name,
-                   const char *from, char **args)
-{
-    GaimConnection *gc = gaim_account_get_connection(gaym-&gt;account);
-
-    if (!args || !args[1] || !gc) {
-        return;
-    }
-
-    gcom_nick_to_gaym(args[1]);
-    serv_got_im(gc, args[1], args[2], GAIM_CONV_IM_AUTO_RESP, time(NULL));
-}
-
-static void gaym_fetch_photo_cb(void *user_data, const char *info_data,
-                                size_t len)
-{
-    if (!info_data || !user_data) {
-        return;
-    }
-
-    struct gaym_fetch_thumbnail_data *d = user_data;
-
-    char *info, *t;
-
-    struct gaym_conn *gaym = d-&gt;gc-&gt;proto_data;
-
-    char *hashurl =
-        g_hash_table_lookup(gaym-&gt;confighash, &quot;view-profile-url&quot;);
-    g_return_if_fail(hashurl != NULL);
-
-    int id = gaim_imgstore_add(info_data, len, NULL);
-    if (d-&gt;stats &amp;&amp; d-&gt;bio)
-        info =
-            g_strdup_printf
-            (&quot;&lt;b&gt;Stats:&lt;/b&gt; %s&lt;br&gt;&lt;b&gt;Bio:&lt;/b&gt; %s&lt;br&gt;&lt;img id=%d&gt;&lt;br&gt;&lt;a href='%s%s'&gt;Full Profile&lt;/a&gt;&quot;,
-             d-&gt;stats, d-&gt;bio, id, hashurl, d-&gt;who);
-    else if (d-&gt;stats)
-        info =
-            g_strdup_printf
-            (&quot;&lt;b&gt;Stats:&lt;/b&gt; %s&lt;br&gt;&lt;img id=%d&gt;&lt;br&gt;&lt;a href='%s%s'&gt;Full Profile&lt;/a&gt;&quot;,
-             d-&gt;stats, id, hashurl, d-&gt;who);
-    else if (d-&gt;bio)
-        info =
-            g_strdup_printf
-            (&quot;&lt;b&gt;Bio:&lt;/b&gt; %s&lt;br&gt;&lt;img id=%d&gt;&lt;br&gt;&lt;a href='%s%s'&gt;Full Profile&lt;/a&gt;&quot;,
-             d-&gt;bio, id, hashurl, d-&gt;who);
-    else
-        info =
-            g_strdup_printf
-            (&quot;No Info Found&lt;br&gt;&lt;img id=%d&gt;&lt;br&gt;&lt;a href='%s%s'&gt;Full Profile&lt;/a&gt;&quot;,
-             id, hashurl, d-&gt;who);
-
-    gaim_notify_userinfo(d-&gt;gc, d-&gt;who,
-                         t = g_strdup_printf(&quot;Gay.com - %s&quot;, d-&gt;who),
-                         d-&gt;who, NULL, info, NULL, NULL);
-    g_free(t);
-
-    if (d) {
-        if (d-&gt;who)
-            g_free(d-&gt;who);
-        if (d-&gt;bio)
-            g_free(d-&gt;bio);
-        if (d-&gt;stats)
-            g_free(d-&gt;stats);
-        g_free(d);
-    }
-    gaim_imgstore_unref(id);
-}
-
-static void gaym_fetch_info_cb(void *user_data, const char *info_data,
-                               size_t len)
-{
-    struct gaym_fetch_thumbnail_data *d = user_data;
-    char *picpath;
-    char *picurl;
-    char *info, *t;
-    char *match = &quot;pictures.0.url=&quot;;
-
-    struct gaym_conn *gaym = d-&gt;gc-&gt;proto_data;
-
-    char *hashurl =
-        g_hash_table_lookup(gaym-&gt;confighash, &quot;view-profile-url&quot;);
-    g_return_if_fail(hashurl != NULL);
-
-    if (d-&gt;stats &amp;&amp; d-&gt;bio)
-        info =
-            g_strdup_printf
-            (&quot;&lt;b&gt;Stats:&lt;/b&gt; %s&lt;br&gt;&lt;b&gt;Bio:&lt;/b&gt; %s&lt;br&gt;&lt;a href='%s%s'&gt;Full Profile&lt;/a&gt;&quot;,
-             d-&gt;stats, d-&gt;bio, hashurl, d-&gt;who);
-    else if (d-&gt;stats)
-        info =
-            g_strdup_printf
-            (&quot;&lt;b&gt;Stats:&lt;/b&gt; %s&lt;br&gt;&lt;a href='%s%s'&gt;Full Profile&lt;/a&gt;&quot;,
-             d-&gt;stats, hashurl, d-&gt;who);
-    else if (d-&gt;bio)
-        info =
-            g_strdup_printf
-            (&quot;&lt;b&gt;Bio:&lt;/b&gt; %s&lt;br&gt;&lt;a href='%s%s'&gt;Full Profile&lt;/a&gt;&quot;,
-             d-&gt;bio, hashurl, d-&gt;who);
-    else
-        info =
-            g_strdup_printf
-            (&quot;No Info Found&lt;br&gt;&lt;a href='%s%s'&gt;Full Profile&lt;/a&gt;&quot;,
-             hashurl, d-&gt;who);
-
-    picpath = return_string_between(match, &quot;\n&quot;, info_data);
-    if (!picpath || strlen(picpath) == 0) {
-        gaim_notify_userinfo(d-&gt;gc, d-&gt;who,
-                             t = g_strdup_printf(&quot;Gay.com - %s&quot;, d-&gt;who),
-                             d-&gt;who, NULL, info, NULL, NULL);
-        g_free(t);
-        return;
-    }
-
-    picurl = g_strdup_printf(&quot;<A HREF="http://www.gay.com%s">http://www.gay.com%s</A>&quot;, picpath);
-    if (picurl) {
-        gaim_url_fetch(picurl, FALSE, &quot;Mozilla/4.0 (compatible; MSIE 5.0)&quot;,
-                       FALSE, gaym_fetch_photo_cb, user_data);
-        return;
-    }
-}
-
-void gaym_msg_no_such_nick(struct gaym_conn *gaym, const char *name,
-                           const char *from, char **args)
-{
-    /**
-     * name = 701
-     * from = irc.server.name
-     * args[1] = the nick that wasn't found
-     */
-
-    if (!gaym || !args || !args[1]) {
-        return;
-    }
-
-    gcom_nick_to_gaym(args[1]);
-
-    gaym_buddy_status(gaym, args[1], FALSE, NULL);
-
-    char *normalized = g_strdup(gaim_normalize(gaym-&gt;account, args[1]));
-
-    if (g_hash_table_lookup(gaym-&gt;info_window_needed, normalized)) {
-        g_hash_table_remove(gaym-&gt;info_window_needed, normalized);
-
-        char *hashurl =
-            g_hash_table_lookup(gaym-&gt;confighash, &quot;view-profile-url&quot;);
-        g_return_if_fail(hashurl != NULL);
-
-        char *buf;
-        buf =
-            g_strdup_printf
-            (&quot;That user is not logged on. Check &lt;a href='%s%s'&gt;here&lt;/a&gt; to see if that user has a profile.&quot;,
-             hashurl, args[1]);
-        gaim_notify_userinfo(gaim_account_get_connection(gaym-&gt;account),
-                             NULL, NULL, &quot;No such user&quot;, NULL, buf, NULL,
-                             NULL);
-    }
-    g_free(normalized);
-}
-
-void gaym_msg_whois(struct gaym_conn *gaym, const char *name,
-                    const char *from, char **args)
-{
-    /**
-     * name = 311
-     * from = irc.server.name
-     * args[1] = the nick that we have information about
-     */
-
-    if (!gaym || !args || !args[1]) {
-        return;
-    }
-
-    gcom_nick_to_gaym(args[1]);
-
-    gaym_buddy_status(gaym, args[1], TRUE, args[5]);
-
-    char *normalized = g_strdup(gaim_normalize(gaym-&gt;account, args[1]));
-
-    struct gaym_fetch_thumbnail_data *data;
-
-    // Update, but then release the reference. It was already opened
-    // during conversation-created.
-    gaym_update_channel_member(gaym, args[1], args[5]);
-    gaym_unreference_channel_member(gaym, args[1]);
-    gaim_signal_emit(gaim_accounts_get_handle(), &quot;info-updated&quot;,
-                     gaym-&gt;account, args[1]);
-
-    if (g_hash_table_lookup(gaym-&gt;info_window_needed, normalized)) {
-
-        data = g_new0(struct gaym_fetch_thumbnail_data, 1);
-        data-&gt;gc = gaim_account_get_connection(gaym-&gt;account);
-        data-&gt;who = g_strdup(args[1]);
-        data-&gt;bio = gaym_bio_strdup(args[5]);
-        data-&gt;stats = gaym_stats_strdup(args[5]);
-        g_hash_table_remove(gaym-&gt;info_window_needed, normalized);
-        char *hashurl = g_hash_table_lookup(gaym-&gt;confighash,
-                                            &quot;ohm.profile-url&quot;);
-        g_return_if_fail(hashurl != NULL);
-
-        char *infourl = g_strdup_printf(&quot;%s?pw=%s&amp;name=%s&quot;, hashurl,
-                                        gaym-&gt;chat_key, args[1]);
-        if (infourl) {
-            gaim_url_fetch(infourl, FALSE,
-                           &quot;Mozilla/4.0 (compatible; MSIE 5.0)&quot;, FALSE,
-                           gaym_fetch_info_cb, data);
-            g_free(infourl);
-        }
-    }
-    g_free(normalized);
-}
-
-void gaym_msg_login_failed(struct gaym_conn *gaym, const char *name,
-                           const char *from, char **args)
-{
-
-
-
-    gaym_cmd_quit(gaym, &quot;quit&quot;, NULL, NULL);
-
-    // if (gc-&gt;inpa)
-    // gaim_input_remove(gc-&gt;inpa);
-
-    // g_free(gaym-&gt;inbuf);
-    // gaim_debug_misc(&quot;gaym&quot;, &quot;Login failed. closing fd %i\n&quot;, gaym-&gt;fd);
-    // close(gaym-&gt;fd);
-    // gaim_debug_misc(&quot;gaym&quot;, &quot;Get chatkey from weblogin\n&quot;);
-    // gaym_get_hash_from_weblogin(gaym-&gt;account,
-    // gaym_login_with_chat_key);
-
-}
-
-void gaym_msg_list(struct gaym_conn *gaym, const char *name,
-                   const char *from, char **args)
-{
-    /**
-     * If you free anything here related to the roomlist
-     * be sure you test what happens when the roomlist reference
-     * count goes to zero! Because it may crash gaim.
-     */
-    if (!gaym-&gt;roomlist) {
-        return;
-    }
-    /**
-     * Begin result of member created room list
-     */
-    if (!strcmp(name, &quot;321&quot;) &amp;&amp; gaym-&gt;roomlist_filter == NULL) {
-        GaimRoomlistRoom *room;
-        room = gaim_roomlist_room_new(GAIM_ROOMLIST_ROOMTYPE_CATEGORY,
-                                      _(&quot;Member Created&quot;), NULL);
-        gaim_roomlist_room_add(gaym-&gt;roomlist, room);
-        gaim_roomlist_set_in_progress(gaym-&gt;roomlist, TRUE);
-        return;
-    }
-
-    /**
-     * The list of member created rooms
-     */
-    if (!strcmp(name, &quot;322&quot;)) {
-        GaimRoomlistRoom *room;
-        char *field_start = NULL;
-        char *field_end = NULL;
-        size_t field_len = 0;
-        int i = 0;
-
-        if (!args[1]) {
-            return;
-        }
-
-        /**
-         * strip leading &quot;#_&quot; and trailing &quot;=1&quot;
-         */
-        field_start = strchr(args[1], '_');
-        field_end = strrchr(args[1], '=');
-
-        if (!field_start || !field_end) {
-            gaim_debug_error(&quot;gaym&quot;,
-                             &quot;Member created room list parsing error&quot;);
-            return;
-        }
-        field_start++;
-        field_end = field_end + 2;
-
-        field_len = field_end - field_start;
-
-        char *field_name = g_strndup(field_start, field_len);
-
-        /**
-         * replace all remaining &quot;_&quot; with &quot; &quot;
-         */
-        for (i = 0; field_name[i] != '\0'; i++) {
-            if (field_name[i] == '_') {
-                field_name[i] = ' ';
-            }
-        }
-        /**
-         * replace '=' with ':'
-         */
-        field_name[i - 2] = ':';
-
-        gchar *lowercase = g_utf8_strdown(field_name, -1);
-        gchar *normalized =
-            g_utf8_normalize(lowercase, -1, G_NORMALIZE_ALL);
-        g_free(lowercase);
-        if (gaym-&gt;roomlist_filter == NULL ||
-            g_strstr_len(normalized, -1, gaym-&gt;roomlist_filter) != NULL) {
-
-            room = gaim_roomlist_room_new(GAIM_ROOMLIST_ROOMTYPE_ROOM,
-                                          field_name,
-                                          g_list_nth_data(gaym-&gt;roomlist-&gt;
-                                                          rooms, 0));
-            gaim_roomlist_room_add_field(gaym-&gt;roomlist, room, field_name);
-            gaim_roomlist_room_add_field(gaym-&gt;roomlist, room, args[1]);
-            gaim_roomlist_room_add(gaym-&gt;roomlist, room);
-        }
-        g_free(normalized);
-        g_free(field_name);
-    }
-
-    /**
-     * End result of member created room list
-     * This is our trigger to add the static rooms
-     */
-    if (!strcmp(name, &quot;323&quot;)) {
-        build_roomlist_from_config(gaym-&gt;roomlist, gaym-&gt;confighash,
-                                   gaym-&gt;roomlist_filter);
-        if (gaym-&gt;roomlist_filter) {
-            g_free(gaym-&gt;roomlist_filter);
-            gaym-&gt;roomlist_filter = NULL;
-        }
-        return;
-    }
-}
-
-void gaym_msg_unknown(struct gaym_conn *gaym, const char *name,
-                      const char *from, char **args)
-{
-    GaimConnection *gc = gaim_account_get_connection(gaym-&gt;account);
-    char *buf;
-
-    if (!args || !args[1] || !gc)
-        return;
-
-    buf = g_strdup_printf(_(&quot;Unknown message '%s'&quot;), args[1]);
-    gaim_notify_error(gc, _(&quot;Unknown message&quot;), buf,
-                      _
-                      (&quot;Gaim has sent a message the IRC server did not understand.&quot;));
-    g_free(buf);
-}
-
-void gaym_msg_names(struct gaym_conn *gaym, const char *name,
-                    const char *from, char **args)
-{
-    char *names, *cur, *end, *tmp, *msg;
-    GaimConversation *convo;
-
-    if (!strcmp(name, &quot;366&quot;)) {
-        convo =
-            gaim_find_conversation_with_account(gaym-&gt;nameconv ? gaym-&gt;
-                                                nameconv : args[1],
-                                                gaym-&gt;account);
-        if (!convo) {
-            gaim_debug(GAIM_DEBUG_ERROR, &quot;gaym&quot;,
-                       &quot;Got a NAMES list for %s, which doesn't exist\n&quot;,
-                       args[2]);
-            g_string_free(gaym-&gt;names, TRUE);
-            gaym-&gt;names = NULL;
-            g_free(gaym-&gt;nameconv);
-            gaym-&gt;nameconv = NULL;
-            return;
-        }
-
-        names = cur = g_string_free(gaym-&gt;names, FALSE);
-        gaym-&gt;names = NULL;
-        if (gaym-&gt;nameconv) {
-            msg =
-                g_strdup_printf(_(&quot;Users on %s: %s&quot;),
-                                args[1] ? args[1] : &quot;&quot;,
-                                names ? names : &quot;&quot;);
-            if (gaim_conversation_get_type(convo) == GAIM_CONV_CHAT)
-                gaim_conv_chat_write(GAIM_CONV_CHAT(convo), &quot;&quot;, msg,
-                                     GAIM_MESSAGE_SYSTEM |
-                                     GAIM_MESSAGE_NO_LOG, time(NULL));
-            else
-                gaim_conv_im_write(GAIM_CONV_IM(convo), &quot;&quot;, msg,
-                                   GAIM_MESSAGE_SYSTEM |
-                                   GAIM_MESSAGE_NO_LOG, time(NULL));
-            g_free(msg);
-            g_free(gaym-&gt;nameconv);
-            gaym-&gt;nameconv = NULL;
-        } else {
-            GList *users = NULL;
-
-            while (*cur) {
-                end = strchr(cur, ' ');
-                tmp = g_strndup(cur, end - cur);
-                gcom_nick_to_gaym(tmp);
-                users = g_list_prepend(users, tmp);
-                cur = end;
-                if (*cur)
-                    cur++;
-            }
-            users = g_list_reverse(users);
-
-            if (users != NULL) {
-                GList *l;
-
-                gaim_conv_chat_add_users(GAIM_CONV_CHAT(convo), users,
-                                         NULL);
-
-                for (l = users; l != NULL; l = l-&gt;next)
-                    g_free(l-&gt;data);
-
-                g_list_free(users);
-            }
-        }
-        g_free(names);
-    } else {
-        if (!gaym-&gt;names)
-            gaym-&gt;names = g_string_new(&quot;&quot;);
-
-        gaym-&gt;names = g_string_append(gaym-&gt;names, args[3]);
-    }
-}
-
-/**
- * Change this to WELCOME
- */
-
-void gaym_msg_endmotd(struct gaym_conn *gaym, const char *name,
-                      const char *from, char **args)
-{
-    GaimConnection *gc;
-
-    gaim_debug_misc(&quot;gaym&quot;, &quot;Got motd\n&quot;);
-
-    gc = gaim_account_get_connection(gaym-&gt;account);
-    if (!gc) {
-        gaim_debug_misc(&quot;gaym&quot;, &quot;!gc ???\n&quot;);
-        return;
-    }
-    gaim_connection_set_state(gc, GAIM_CONNECTED);
-    serv_finish_login(gc);
-
-    gaym_blist_timeout(gaym);
-    if (!gaym-&gt;timer)
-        gaym-&gt;timer =
-            gaim_timeout_add(BLIST_UPDATE_PERIOD,
-                             (GSourceFunc) gaym_blist_timeout,
-                             (gpointer) gaym);
-}
-
-void gaym_msg_nochan(struct gaym_conn *gaym, const char *name,
-                     const char *from, char **args)
-{
-    GaimConnection *gc = gaim_account_get_connection(gaym-&gt;account);
-
-    if (gc == NULL || args == NULL || args[1] == NULL)
-        return;
-
-    gaim_notify_error(gc, NULL, _(&quot;No such channel&quot;), args[1]);
-}
-
-void gaym_msg_nonick_chan(struct gaym_conn *gaym, const char *name,
-                          const char *from, char **args)
-{
-    GaimConnection *gc = gaim_account_get_connection(gaym-&gt;account);
-
-    if (gc == NULL || args == NULL || args[1] == NULL)
-        return;
-
-    gaim_notify_error(gc, NULL, _(&quot;Not logged in:&quot;), args[1]);
-}
-
-void gaym_msg_nonick(struct gaym_conn *gaym, const char *name,
-                     const char *from, char **args)
-{
-    GaimConnection *gc;
-    GaimConversation *convo;
-
-    convo = gaim_find_conversation_with_account(args[1], gaym-&gt;account);
-    if (convo) {
-        if (gaim_conversation_get_type(convo) == GAIM_CONV_CHAT) {
-            /* does this happen? */
-            gaim_conv_chat_write(GAIM_CONV_CHAT(convo), args[1],
-                                 _(&quot;no such channel&quot;),
-                                 GAIM_MESSAGE_SYSTEM | GAIM_MESSAGE_NO_LOG,
-                                 time(NULL));
-        } else {
-            gaim_conv_im_write(GAIM_CONV_IM(convo), args[1],
-                               _(&quot;User is not logged in&quot;),
-                               GAIM_MESSAGE_SYSTEM | GAIM_MESSAGE_NO_LOG,
-                               time(NULL));
-        }
-    } else {
-        if ((gc = gaim_account_get_connection(gaym-&gt;account)) == NULL)
-            return;
-        gaim_notify_error(gc, NULL, _(&quot;No such nick or channel&quot;), args[1]);
-    }
-}
-
-void gaym_msg_nosend(struct gaym_conn *gaym, const char *name,
-                     const char *from, char **args)
-{
-    GaimConnection *gc;
-    GaimConversation *convo;
-
-    convo = gaim_find_conversation_with_account(args[1], gaym-&gt;account);
-    if (convo) {
-        gaim_conv_chat_write(GAIM_CONV_CHAT(convo), args[1], args[2],
-                             GAIM_MESSAGE_SYSTEM | GAIM_MESSAGE_NO_LOG,
-                             time(NULL));
-    } else {
-        if ((gc = gaim_account_get_connection(gaym-&gt;account)) == NULL)
-            return;
-        gaim_notify_error(gc, NULL, _(&quot;Could not send&quot;), args[2]);
-    }
-}
-
-/**
- * Is this used?
- */
-void gaym_msg_notinchan(struct gaym_conn *gaym, const char *name,
-                        const char *from, char **args)
-{
-    GaimConversation *convo =
-        gaim_find_conversation_with_account(args[1], gaym-&gt;account);
-
-    gaim_debug(GAIM_DEBUG_INFO, &quot;gaym&quot;,
-               &quot;We're apparently not in %s, but tried to use it\n&quot;,
-               args[1]);
-    if (convo) {
-        /* g_slist_remove(gaym-&gt;gc-&gt;buddy_chats, convo);
-           gaim_conversation_set_account(convo, NULL); */
-        gaim_conv_chat_write(GAIM_CONV_CHAT(convo), args[1], args[2],
-                             GAIM_MESSAGE_SYSTEM | GAIM_MESSAGE_NO_LOG,
-                             time(NULL));
-    }
-}
-
-/**
- * Invite WORKS in gay.com!
- */
-void gaym_msg_invite(struct gaym_conn *gaym, const char *name,
-                     const char *from, char **args)
-{
-    GaimConnection *gc = gaim_account_get_connection(gaym-&gt;account);
-    char *nick = gaym_mask_nick(from);
-    GHashTable *components =
-        g_hash_table_new_full(g_str_hash, g_str_equal, g_free, g_free);
-
-    if (!args || !args[1] || !gc) {
-        g_free(nick);
-        g_hash_table_destroy(components);
-        return;
-    }
-
-    if (!gaym_privacy_check(gc, nick)) {
-        g_free(nick);
-        g_hash_table_destroy(components);
-        return;
-    }
-
-    g_hash_table_insert(components, strdup(&quot;channel&quot;), strdup(args[1]));
-    gcom_nick_to_gaym(nick);
-    serv_got_chat_invite(gc, args[1], nick, NULL, components);
-
-    g_free(nick);
-}
-
-void gaym_msg_inviteonly(struct gaym_conn *gaym, const char *name,
-                         const char *from, char **args)
-{
-    GaimConnection *gc = gaim_account_get_connection(gaym-&gt;account);
-    char *buf;
-
-    if (!args || !args[1] || !gc)
-        return;
-
-    buf =
-        g_strdup_printf(_(&quot;Joining %s requires an invitation.&quot;), args[1]);
-    gaim_notify_error(gc, _(&quot;Invitation only&quot;), _(&quot;Invitation only&quot;), buf);
-    g_free(buf);
-}
-
-void gaym_msg_trace(struct gaym_conn *gaym, const char *name,
-                    const char *from, char **args)
-{
-    GaimConversation *conv =
-        gaim_find_conversation_with_account(gaym-&gt;traceconv ? gaym-&gt;
-                                            traceconv : args[1],
-                                            gaym-&gt;account);
-    gaim_conversation_write(conv, &quot;TRACE&quot;, args[3],
-                            GAIM_MESSAGE_SYSTEM | GAIM_MESSAGE_NO_LOG,
-                            time(NULL));
-
-}
-
-void gaym_msg_join(struct gaym_conn *gaym, const char *name,
-                   const char *from, char **args)
-{
-    GaimConnection *gc = gaim_account_get_connection(gaym-&gt;account);
-    g_return_if_fail(gc != NULL);
-
-    char *nick = gaym_mask_nick(from);
-
-    GaimConversation *convo;
-    GaimConvChatBuddyFlags flags = GAIM_CBFLAGS_NONE;
-    char *bio = NULL;
-    char *bio_markedup = NULL;
-    static int id = 1;
-
-    gcom_nick_to_gaym(nick);
-    if (!gaim_utf8_strcasecmp(nick, gaim_connection_get_display_name(gc))) {
-        /* We are joining a channel for the first time */
-        if (gaym-&gt;persist_room &amp;&amp; !strcmp(gaym-&gt;persist_room, args[0])) {
-            g_free(gaym-&gt;persist_room);
-            gaym-&gt;persist_room = NULL;
-            gaim_request_close(GAIM_REQUEST_ACTION,
-                               gaym-&gt;hammer_cancel_dialog);
-
-        }
-
-        serv_got_joined_chat(gc, id++, args[0]);
-
-        gint *entry = g_new(gint, 1);
-        *entry = MAX_CHANNEL_MEMBERS;
-        g_hash_table_insert(gaym-&gt;entry_order, g_strdup(args[0]), entry);
-
-        g_free(nick);
-        return;
-    }
-
-    convo = gaim_find_conversation_with_account(args[0], gaym-&gt;account);
-    if (convo == NULL) {
-        gaim_debug(GAIM_DEBUG_ERROR, &quot;gaym&quot;, &quot;JOIN for %s failed\n&quot;,
-                   args[0]);
-        g_free(nick);
-        return;
-    }
-
-    gint *entry = g_hash_table_lookup(gaym-&gt;entry_order, args[0]);
-    g_return_if_fail(entry != NULL);
-
-    gaym_buddy_status(gaym, nick, TRUE, args[1]);
-
-
-    gboolean gaym_botfilter_permit =
-        gaym_botfilter_check(gc, nick, bio, FALSE);
-
-    bio = gaym_bio_strdup(args[1]);
-    if (bio) {
-        bio_markedup = gaim_markup_linkify(bio);
-        g_free(bio);
-    }
-
-    if (*entry &lt;= MAX_CHANNEL_MEMBERS) {
-        *entry = MAX_CHANNEL_MEMBERS + 1;
-    }
-
-    flags = chat_pecking_order(args[1]);
-    flags = include_chat_entry_order(flags, (*entry)++);
-
-    gboolean gaym_privacy_permit = gaym_privacy_check(gc, nick);
-    gboolean show_join =
-        gaim_prefs_get_bool(&quot;/plugins/prpl/gaym/show_join&quot;);
-
-    if (gaim_prefs_get_bool(&quot;/plugins/prpl/gaym/show_bio_with_join&quot;)) {
-        gaim_conv_chat_add_user(GAIM_CONV_CHAT(convo), nick, bio_markedup,
-                                flags, (gaym_privacy_permit
-                                        &amp;&amp; gaym_botfilter_permit
-                                        &amp;&amp; show_join));
-    } else {
-        gaim_conv_chat_add_user(GAIM_CONV_CHAT(convo), nick, NULL,
-                                flags, (gaym_privacy_permit
-                                        &amp;&amp; gaym_botfilter_permit
-                                        &amp;&amp; show_join));
-    }
-
-    /**
-     * Make the ignore.png icon appear next to the nick.
-     */
-    GaimConversationUiOps *ops = gaim_conversation_get_ui_ops(convo);
-    if (gaym_privacy_permit &amp;&amp; gaym_botfilter_permit) {
-        gaim_conv_chat_unignore(GAIM_CONV_CHAT(convo), nick);
-    } else {
-        gaim_conv_chat_ignore(GAIM_CONV_CHAT(convo), nick);
-    }
-    ops-&gt;chat_update_user((convo), nick);
-
-    gaym_update_channel_member(gaym, nick, args[1]);
-    g_free(bio_markedup);
-    g_free(nick);
-}
-
-void gaym_msg_mode(struct gaym_conn *gaym, const char *name,
-                   const char *from, char **args)
-{
-    GaimConversation *convo;
-    char *nick = gaym_mask_nick(from), *buf;
-
-    if (*args[0] == '#' || *args[0] == '&amp;') {   /* Channel */
-        convo =
-            gaim_find_conversation_with_account(args[0], gaym-&gt;account);
-        if (!convo) {
-            gaim_debug(GAIM_DEBUG_ERROR, &quot;gaym&quot;,
-                       &quot;MODE received for %s, which we are not in\n&quot;,
-                       args[0]);
-            g_free(nick);
-            return;
-        }
-        buf =
-            g_strdup_printf(_(&quot;mode (%s %s) by %s&quot;), args[1],
-                            args[2] ? args[2] : &quot;&quot;, nick);
-        gaim_conv_chat_write(GAIM_CONV_CHAT(convo), args[0], buf,
-                             GAIM_MESSAGE_SYSTEM | GAIM_MESSAGE_NO_LOG,
-                             time(NULL));
-        g_free(buf);
-        if (args[2]) {
-            GaimConvChatBuddyFlags newflag, flags;
-            char *mcur, *cur, *end, *user;
-            gboolean add = FALSE;
-            mcur = args[1];
-            cur = args[2];
-            while (*cur &amp;&amp; *mcur) {
-                if ((*mcur == '+') || (*mcur == '-')) {
-                    add = (*mcur == '+') ? TRUE : FALSE;
-                    mcur++;
-                    continue;
-                }
-                end = strchr(cur, ' ');
-                if (!end)
-                    end = cur + strlen(cur);
-                user = g_strndup(cur, end - cur);
-                flags =
-                    gaim_conv_chat_user_get_flags(GAIM_CONV_CHAT(convo),
-                                                  user);
-                newflag = GAIM_CBFLAGS_NONE;
-                if (*mcur == 'o')
-                    newflag = GAIM_CBFLAGS_OP;
-                else if (*mcur == 'h')
-                    newflag = GAIM_CBFLAGS_HALFOP;
-                else if (*mcur == 'v')
-                    newflag = GAIM_CBFLAGS_VOICE;
-                if (newflag) {
-                    if (add)
-                        flags |= newflag;
-                    else
-                        flags &amp;= ~newflag;
-                    gaim_conv_chat_user_set_flags(GAIM_CONV_CHAT(convo),
-                                                  user, flags);
-                }
-                g_free(user);
-                cur = end;
-                if (*cur)
-                    cur++;
-                if (*mcur)
-                    mcur++;
-            }
-        }
-    } else {                    /* User */
-    }
-    g_free(nick);
-}
-
-void gaym_msg_nick(struct gaym_conn *gaym, const char *name,
-                   const char *from, char **args)
-{
-    GSList *chats;
-
-    GaimConnection *gc = gaim_account_get_connection(gaym-&gt;account);
-    char *nick = gaym_mask_nick(from);
-
-    if (!gc) {
-        g_free(nick);
-        return;
-    }
-
-    chats = gc-&gt;buddy_chats;
-
-    if (!gaim_utf8_strcasecmp(nick, gaim_connection_get_display_name(gc))) {
-        gaim_connection_set_display_name(gc, args[0]);
-    }
-
-    while (chats) {
-        GaimConvChat *chat = GAIM_CONV_CHAT(chats-&gt;data);
-        /* This is ugly ... */
-        if (gaim_conv_chat_find_user(chat, nick))
-            gaim_conv_chat_rename_user(chat, nick, args[0]);
-        chats = chats-&gt;next;
-    }
-    g_free(nick);
-}
-
-void gaym_msg_notice(struct gaym_conn *gaym, const char *name,
-                     const char *from, char **args)
-{
-    GaimConnection *gc = gaim_account_get_connection(gaym-&gt;account);
-
-    if (!gc) {
-        return;
-    }
-
-    char *newargs[2];
-
-    newargs[0] = &quot; notice &quot;;    /* The spaces are magic, leave 'em in! */
-    newargs[1] = args[1];
-    gaym_msg_privmsg(gaym, name, from, newargs);
-}
-
-void gaym_msg_part(struct gaym_conn *gaym, const char *name,
-                   const char *from, char **args)
-{
-    GaimConversation *convo;
-    char *msg;
-
-    GaimConnection *gc = gaim_account_get_connection(gaym-&gt;account);
-    char *nick = gaym_mask_nick(from);
-
-    if (!args || !args[0] || !gc || !nick) {
-        g_free(nick);
-        return;
-    }
-
-    convo = gaim_find_conversation_with_account(args[0], gaym-&gt;account);
-    gboolean show_part =
-        gaim_prefs_get_bool(&quot;/plugins/prpl/gaym/show_part&quot;);
-
-    gcom_nick_to_gaym(nick);
-    if (!gaim_utf8_strcasecmp(nick, gaim_connection_get_display_name(gc))) {
-
-        g_hash_table_remove(gaym-&gt;entry_order, args[0]);
-        msg = g_strdup_printf(_(&quot;You have parted the channel&quot;));
-
-        gaim_conv_chat_write(GAIM_CONV_CHAT(convo), args[0], msg,
-                             GAIM_MESSAGE_SYSTEM, time(NULL));
-        g_free(msg);
-        serv_got_chat_left(gc,
-                           gaim_conv_chat_get_id(GAIM_CONV_CHAT(convo)));
-    } else {
-        if (!gaim_conv_chat_is_user_ignored(GAIM_CONV_CHAT(convo), nick)
-            &amp;&amp; show_part) {
-            gaim_conv_chat_remove_user(GAIM_CONV_CHAT(convo), nick, NULL);
-        } else {
-            GaimConversationUiOps *ops =
-                gaim_conversation_get_ui_ops(convo);
-            if (ops != NULL &amp;&amp; ops-&gt;chat_remove_user != NULL) {
-                ops-&gt;chat_remove_user(convo, nick);
-            }
-            GaimConvChatBuddy *cb =
-                gaim_conv_chat_cb_find(GAIM_CONV_CHAT(convo), nick);
-            if (cb) {
-                gaim_conv_chat_set_users(GAIM_CONV_CHAT(convo),
-                                         g_list_remove
-                                         (gaim_conv_chat_get_users
-                                          (GAIM_CONV_CHAT(convo)), cb));
-                gaim_conv_chat_cb_destroy(cb);
-                if (!gaym_unreference_channel_member(gaym, nick))
-                    gaim_debug_error(&quot;gaym&quot;,
-                                     &quot;channel_members reference counting bug.\n&quot;);
-            }
-        }
-    }
-
-    g_free(nick);
-}
-
-void gaym_msg_ping(struct gaym_conn *gaym, const char *name,
-                   const char *from, char **args)
-{
-    char *buf;
-    if (!args || !args[0])
-        return;
-
-    buf = gaym_format(gaym, &quot;v:&quot;, &quot;PONG&quot;, args[0]);
-    gaym_send(gaym, buf);
-    g_free(buf);
-}
-
-void gaym_msg_pong(struct gaym_conn *gaym, const char *name,
-                   const char *from, char **args)
-{
-    GaimConversation *convo;
-    GaimConnection *gc;
-    char **parts, *msg;
-    time_t oldstamp;
-
-    if (!args || !args[1])
-        return;
-
-    parts = g_strsplit(args[1], &quot; &quot;, 2);
-
-    if (!parts[0] || !parts[1]) {
-        g_strfreev(parts);
-        return;
-    }
-
-    if (sscanf(parts[1], &quot;%lu&quot;, &amp;oldstamp) != 1) {
-        msg = g_strdup(_(&quot;Error: invalid PONG from server&quot;));
-    } else {
-        msg =
-            g_strdup_printf(_(&quot;PING reply -- Lag: %lu seconds&quot;),
-                            time(NULL) - oldstamp);
-    }
-
-    convo = gaim_find_conversation_with_account(parts[0], gaym-&gt;account);
-    g_strfreev(parts);
-    if (convo) {
-        if (gaim_conversation_get_type(convo) == GAIM_CONV_CHAT)
-            gaim_conv_chat_write(GAIM_CONV_CHAT(convo), &quot;PONG&quot;, msg,
-                                 GAIM_MESSAGE_SYSTEM | GAIM_MESSAGE_NO_LOG,
-                                 time(NULL));
-        else
-            gaim_conv_im_write(GAIM_CONV_IM(convo), &quot;PONG&quot;, msg,
-                               GAIM_MESSAGE_SYSTEM | GAIM_MESSAGE_NO_LOG,
-                               time(NULL));
-    } else {
-        gc = gaim_account_get_connection(gaym-&gt;account);
-        if (!gc) {
-            g_free(msg);
-            return;
-        }
-        gaim_notify_info(gc, NULL, &quot;PONG&quot;, msg);
-    }
-    g_free(msg);
-}
-
-void gaym_msg_privmsg(struct gaym_conn *gaym, const char *name,
-                      const char *from, char **args)
-{
-    GaimConversation *convo;
-    char *tmp, *msg;
-    int notice = 0;
-
-    GaimConnection *gc = gaim_account_get_connection(gaym-&gt;account);
-    char *nick = gaym_mask_nick(from);
-
-    if (!args || !args[0] || !args[1] || !gc) {
-        g_free(nick);
-        return;
-    }
-
-    /**
-     * Only nicks (sender/receiver) should use gcom_nick_to_gaym().
-     *
-     * Channels (which begin with either &quot;#&quot; or &quot;&amp;&quot;) should not be
-     * converted.
-     *
-     * Messages should also not be converted.
-     *
-     * CHAT ROOM:
-     * nick = the sender
-     * args[0] = the receiving channel
-     * args[1] = the message
-     *
-     * INSTANT MESSAGE:
-     * nick = the sender
-     * args[0] = the receiver (me)
-     * args[1] = the message
-     *
-     * NOTICE:
-     * nick = the sender
-     * args[0] = &quot; notice &quot;
-     * args[1] = the message
-     */
-    gcom_nick_to_gaym(nick);
-    if (args[0][0] != '#' &amp;&amp; args[0][0] != '&amp;') {
-        gcom_nick_to_gaym(args[0]);
-    }
-
-    convo = gaim_find_conversation_with_account(args[0], gaym-&gt;account);
-
-    notice = !strcmp(args[0], &quot; notice &quot;);
-    tmp = gaym_parse_ctcp(gaym, nick, args[0], args[1], notice);
-
-    if (!tmp) {
-        g_free(nick);
-        return;
-    }
-
-    if (!gaym_privacy_check(gc, nick)) {
-        g_free(nick);
-        return;
-    }
-
-    msg = gaim_escape_html(tmp);
-
-    g_free(tmp);
-
-    if (notice) {
-        tmp = g_strdup_printf(&quot;(notice) %s&quot;, msg);
-        g_free(msg);
-        msg = tmp;
-    }
-
-    if (!gaim_utf8_strcasecmp
-        (args[0], gaim_connection_get_display_name(gc))) {
-        serv_got_im(gc, nick, msg, 0, time(NULL));
-    } else if (notice) {
-        serv_got_im(gc, nick, msg, 0, time(NULL));
-    } else if (convo) {
-
-        serv_got_chat_in(gc, gaim_conv_chat_get_id(GAIM_CONV_CHAT(convo)),
-                         nick, 0, msg, time(NULL));
-    } else {
-        gaim_debug(GAIM_DEBUG_ERROR, &quot;gaym&quot;,
-                   &quot;Got a PRIVMSG on %s, which does not exist\n&quot;, args[0]);
-    }
-
-    g_free(msg);
-    g_free(nick);
-}
-
-void gaym_msg_regonly(struct gaym_conn *gaym, const char *name,
-                      const char *from, char **args)
-{
-    GaimConnection *gc = gaim_account_get_connection(gaym-&gt;account);
-    char *msg;
-
-    if (!args || !args[1] || !args[2] || !gc)
-        return;
-
-    msg = g_strdup_printf(_(&quot;Cannot join %s:&quot;), args[1]);
-    gaim_notify_error(gc, _(&quot;Cannot join channel&quot;), msg, args[2]);
-    g_free(msg);
-}
-
-/* I don't think gay.com ever sends this message */
-void gaym_msg_quit(struct gaym_conn *gaym, const char *name,
-                   const char *from, char **args)
-{
-    GaimConnection *gc = gaim_account_get_connection(gaym-&gt;account);
-    char *data[2];
-
-    if (!args || !args[0] || !gc)
-        return;
-
-    data[0] = gaym_mask_nick(from);
-    data[1] = args[0];
-    /* XXX this should have an API, I shouldn't grab this directly */
-    g_slist_foreach(gc-&gt;buddy_chats, (GFunc) gaym_chat_remove_buddy, data);
-
-    gaym_buddy_status(gaym, data[0], FALSE, NULL);
-
-    g_free(data[0]);
-
-    return;
-}
-
-void gaym_msg_who(struct gaym_conn *gaym, const char *name,
-                  const char *from, char **args)
-{
-}
-
-void hammer_stop_cb(gpointer data)
-{
-
-    struct gaym_conn *gaym = (struct gaym_conn *) data;
-
-    gaym-&gt;cancelling_persist = TRUE;
-    gaim_debug_misc(&quot;gaym&quot;, &quot;Cancelling persist: %s\n&quot;,
-                    gaym-&gt;persist_room);
-}
-
-void hammer_cb(gpointer data)
-{
-
-    struct gaym_conn *gaym = (struct gaym_conn *) data;
-    const char *args[1];
-    char *msg;
-    gaim_debug_misc(&quot;gaym&quot;, &quot;Persisting room %s\n&quot;, gaym-&gt;persist_room);
-    args[0] = gaym-&gt;persist_room;
-    gaym-&gt;cancelling_persist = FALSE;
-    msg = g_strdup_printf(&quot;Hammering into room %s&quot;, gaym-&gt;persist_room);
-    gaym-&gt;hammer_cancel_dialog =
-        gaim_request_action(gaym-&gt;account-&gt;gc, _(&quot;Cancel Hammer&quot;), msg,
-                            NULL, 0, gaym, 1, (&quot;Cancel&quot;), hammer_stop_cb);
-
-    gaym_cmd_join(gaym, NULL, NULL, args);
-    if (msg)
-        g_free(msg);
-}
-
-void gaym_msg_chanfull(struct gaym_conn *gaym, const char *name,
-                       const char *from, char **args)
-{
-    GaimConnection *gc = gaim_account_get_connection(gaym-&gt;account);
-    char *buf;
-    const char *joinargs[1];
-
-    if (!args || !args[1] || !gc)
-        return;
-
-    joinargs[0] = args[1];
-
-    if (gaym-&gt;persist_room &amp;&amp; !strcmp(gaym-&gt;persist_room, args[1]))
-        if (gaym-&gt;cancelling_persist) {
-            if (gaym-&gt;persist_room) {
-                g_free(gaym-&gt;persist_room);
-                gaym-&gt;persist_room = NULL;
-            }
-            gaym-&gt;cancelling_persist = FALSE;
-        } else {
-            gaim_debug_misc(&quot;gaym&quot;, &quot;trying again\n&quot;);
-            gaym_cmd_join(gaym, NULL, NULL, joinargs);
-    } else {
-
-        gaym-&gt;persist_room = g_strdup(args[1]);
-        buf =
-            g_strdup_printf(&quot;%s is full. Do you want to keep trying?&quot;,
-                            args[1]);
-        gaim_request_yes_no(gc, _(&quot;Room Full&quot;), _(&quot;Room Full&quot;), buf, 0,
-                            gaym, hammer_cb, NULL);
-
-        g_free(buf);
-    }
-}
-
-void gaym_msg_create_pay_only(struct gaym_conn *gaym, const char *name,
-                              const char *from, char **args)
-{
-    GaimConnection *gc = gaim_account_get_connection(gaym-&gt;account);
-    char *buf;
-    if (!args || !args[1] || !gc) {
-        return;
-    }
-    buf = g_strdup_printf(_(&quot;%s&quot;), args[2]);
-    gaim_notify_error(gc, _(&quot;Pay Only&quot;), _(&quot;Pay Only&quot;), buf);
-    /**
-     * FIXME
-     * by now the chatroom is already in the buddy list...need
-     * to remove it or something
-     */
-    g_free(buf);
-}
-
-void gaym_msg_pay_channel(struct gaym_conn *gaym, const char *name,
-                          const char *from, char **args)
-{
-    GaimConnection *gc = gaim_account_get_connection(gaym-&gt;account);
-    char *buf;
-
-    if (!args || !args[1] || !gc)
-        return;
-
-    buf =
-        g_strdup_printf(_(&quot;The channel %s is for paying members only.&quot;),
-                        args[1]);
-    gaim_notify_error(gc, _(&quot;Pay Only&quot;), _(&quot;Pay Only&quot;), buf);
-    g_free(buf);
-}
-
-void gaym_msg_toomany_channels(struct gaym_conn *gaym, const char *name,
-                               const char *from, char **args)
-{
-    GaimConnection *gc = gaim_account_get_connection(gaym-&gt;account);
-    char *buf;
-
-    if (!args || !args[1] || !gc)
-        return;
-
-    buf =
-        g_strdup_printf(_
-                        (&quot;You have joined too many channels the maximum is (2). You cannot join channel %s. Part another channel first .&quot;),
-                        args[1]);
-    gaim_notify_error(gc, _(&quot;Maximum ChannelsReached&quot;),
-                      _(&quot;Maximum ChannelsReached&quot;), buf);
-    g_free(buf);
-}
-
-void gaym_msg_list_busy(struct gaym_conn *gaym, const char *name,
-                        const char *from, char **args)
-{
-    GaimConnection *gc = gaim_account_get_connection(gaym-&gt;account);
-    char *buf;
-    if (!args || !args[1] || !gc) {
-        return;
-    }
-    buf = g_strdup_printf(_(&quot;%s&quot;), args[1]);
-    gaim_notify_error(gc, _(&quot;Server Busy&quot;), _(&quot;Server Busy&quot;), buf);
-    // if (gaym-&gt;roomlist) {
-    // gaim_roomlist_cancel_get_list(gaym-&gt;roomlist);
-    // }
-    g_free(buf);
-    /**
-     * Can't get member created rooms right now.
-     * This is our trigger to add the static rooms
-     */
-    build_roomlist_from_config(gaym-&gt;roomlist, gaym-&gt;confighash,
-                               gaym-&gt;roomlist_filter);
-    if (gaym-&gt;roomlist_filter) {
-        g_free(gaym-&gt;roomlist_filter);
-        gaym-&gt;roomlist_filter = NULL;
-    }
-    return;
-
-}
-
-void gaym_msg_richnames_list(struct gaym_conn *gaym, const char *name,
-                             const char *from, char **args)
-{
-    GaimConnection *gc = gaim_account_get_connection(gaym-&gt;account);
-    GaimConversation *convo;
-    GaimConvChatBuddyFlags flags = GAIM_CBFLAGS_NONE;
-    char *channel = args[1];
-    char *nick = args[2];
-    char *extra = args[4];
-
-    if (!gc) {
-        return;
-    }
-
-    gcom_nick_to_gaym(nick);
-    gaim_debug(GAIM_DEBUG_INFO, &quot;gaym&quot;,
-               &quot;gaym_msg_richnames_list() Channel: %s Nick: %s Extra: %s\n&quot;,
-               channel, nick, extra);
-
-    convo = gaim_find_conversation_with_account(channel, gaym-&gt;account);
-
-    char *bio = gaym_bio_strdup(extra);
-    gboolean gaym_botfilter_permit =
-        gaym_botfilter_check(gc, nick, bio, FALSE);
-    g_free(bio);
-
-    gaym_buddy_status(gaym, nick, TRUE, extra);
-
-    if (convo == NULL) {
-        gaim_debug(GAIM_DEBUG_ERROR, &quot;gaym&quot;, &quot;690 for %s failed\n&quot;,
-                   args[1]);
-        return;
-    }
-
-    gint *entry = g_hash_table_lookup(gaym-&gt;entry_order, channel);
-    g_return_if_fail(entry != NULL);
-
-    flags = chat_pecking_order(extra);
-    flags = include_chat_entry_order(flags, (*entry)--);
-
-    gaim_conv_chat_add_user(GAIM_CONV_CHAT(convo), nick, NULL, flags,
-                            FALSE);
-
-    /**
-     * Make the ignore.png icon appear next to the nick.
-     */
-    GaimConversationUiOps *ops = gaim_conversation_get_ui_ops(convo);
-    if (gaym_privacy_check(gc, nick) &amp;&amp; gaym_botfilter_permit) {
-        gaim_conv_chat_unignore(GAIM_CONV_CHAT(convo), nick);
-    } else {
-        gaim_conv_chat_ignore(GAIM_CONV_CHAT(convo), nick);
-    }
-    ops-&gt;chat_update_user((convo), nick);
-    gaym_update_channel_member(gaym, nick, extra);
-}
-
-/**
- * vim:tabstop=4:shiftwidth=4:expandtab:
- */

Copied: qrc/tags/release-0.9/gaym/src/msgs.c (from rev 262, qrc/trunk/gaym/src/msgs.c)

Deleted: qrc/tags/release-0.9/gaym-extras/src/bio-popups.c
===================================================================
--- qrc/trunk/gaym-extras/src/bio-popups.c	2005-07-30 22:19:23 UTC (rev 259)
+++ qrc/tags/release-0.9/gaym-extras/src/bio-popups.c	2005-07-31 19:13:29 UTC (rev 264)
@@ -1,459 +0,0 @@
-#include &quot;gaym-extras.h&quot;
-// Consider combining into one popup hash...
-GHashTable *popup_rects;
-GHashTable *popup_timeouts;
-GHashTable *popups;
-void clean_popup_stuff(GaimConversation * c)
-{
-
-    if (!g_strrstr(gaim_account_get_protocol_id(c-&gt;account), &quot;prpl-gaym&quot;))
-        return;
-    GaimGtkConversation *gtkconv = GAIM_GTK_CONVERSATION(c);
-    if (c-&gt;type == GAIM_CONV_IM) {
-        g_hash_table_remove(popup_timeouts, gtkconv-&gt;tab_label);
-        g_hash_table_remove(popups, gtkconv-&gt;tab_label);
-    } else if (c-&gt;type == GAIM_CONV_CHAT) {
-        GaimGtkChatPane *gtkchat = gtkconv-&gt;u.chat;
-        g_hash_table_remove(popup_timeouts, gtkchat-&gt;list);
-        g_hash_table_remove(popup_rects, gtkchat-&gt;list);
-        g_hash_table_remove(popups, gtkchat-&gt;list);
-    }
-
-}
-
-static void namelist_leave_cb(GtkWidget * tv, GdkEventCrossing * e,
-                              gpointer n)
-{
-    // This prevent clicks from demloishing popups.
-    if (e-&gt;mode != GDK_CROSSING_NORMAL)
-        return;
-
-    guint *timeout = g_hash_table_lookup(popup_timeouts, tv);
-    g_hash_table_remove(popups, tv);
-
-    if (*timeout) {
-        g_source_remove(*timeout);
-        *timeout = 0;
-    }
-}
-
-static void namelist_paint_tip(GtkWidget * tipwindow,
-                               GdkEventExpose * event, gpointer data)
-{
-    g_return_if_fail(data);
-
-    char *tooltiptext = ((struct paint_data *) data)-&gt;tooltiptext;
-    GdkPixbuf *pixbuf = ((struct paint_data *) data)-&gt;pixbuf;
-    GtkStyle *style = NULL;
-
-    PangoLayout *layout;
-
-    layout = gtk_widget_create_pango_layout(tipwindow, NULL);
-    pango_layout_set_markup(layout, tooltiptext, strlen(tooltiptext));
-    pango_layout_set_wrap(layout, PANGO_WRAP_WORD);
-    pango_layout_set_width(layout, 300000);
-    style = tipwindow-&gt;style;
-
-    gtk_paint_flat_box(style, tipwindow-&gt;window, GTK_STATE_NORMAL,
-                       GTK_SHADOW_OUT, NULL, tipwindow, &quot;tooltip&quot;, 0, 0,
-                       -1, -1);
-
-#if GTK_CHECK_VERSION(2,2,0)
-    gdk_draw_pixbuf(GDK_DRAWABLE(tipwindow-&gt;window), NULL, pixbuf,
-                    0, 0, 4, 4, -1, -1, GDK_RGB_DITHER_NONE, 0, 0);
-#else
-    gdk_pixbuf_render_to_drawable(pixbuf,
-                                  GDK_DRAWABLE(tipwindow-&gt;window), NULL, 0,
-                                  0, 4, 4, -1, -1, GDK_RGB_DITHER_NONE, 0,
-                                  0);
-#endif
-
-    gtk_paint_layout(style, tipwindow-&gt;window, GTK_STATE_NORMAL, TRUE,
-                     NULL, tipwindow, &quot;tooltip&quot;,
-                     gdk_pixbuf_get_width(pixbuf) + 9, 4, layout);
-
-    g_object_unref(pixbuf);
-    g_object_unref(layout);
-    g_free(tooltiptext);
-    g_free(data);
-
-    return;
-}
-
-GdkPixbuf *lookup_cached_thumbnail(GaimAccount * account,
-                                   const char *fullname)
-{
-    GDir *gdir = NULL;
-    GError *err = NULL;
-    GdkPixbuf *pixbuf = NULL;
-    const char *filename = NULL;
-    char *dirname = NULL;
-    char *path = NULL;
-    const char *name = gaim_normalize(account, fullname);
-    dirname =
-        g_build_filename(gaim_user_dir(), &quot;icons&quot;, &quot;gaym&quot;, name, NULL);
-    if (dirname) {
-        gdir = g_dir_open(dirname, 0, &amp;err);
-        if (gdir) {
-            filename = g_dir_read_name(gdir);   // don't free filename:
-                                                // owned by glib.
-            if (filename) {
-                path = g_build_filename(dirname, filename, NULL);
-                if (path)
-                    pixbuf = gdk_pixbuf_new_from_file(path, &amp;err);
-                g_free(path);
-            }
-            g_free(gdir);
-        }
-        g_free(dirname);
-    }
-    return pixbuf;
-}
-
-static gboolean tooltip_timeout(struct timeout_cb_data *data)
-{
-    const gchar *name;
-    int scr_w, scr_h, w, h, x, y;
-#if GTK_CHECK_VERSION(2,2,0)
-    int mon_num;
-    GdkScreen *screen = NULL;
-#endif
-    PangoLayout *layout;
-    gboolean tooltip_top = FALSE;
-    char *tooltiptext = NULL;
-    GdkRectangle mon_size;
-    guint *timeout;
-    GtkWidget *tipwindow;
-    GtkWidget *tv = data-&gt;tv;
-
-    GaymTooltipType type = data-&gt;type;
-    GaimAccount *account = data-&gt;account;
-    GaimPluginProtocolInfo *prpl_info =
-        GAIM_PLUGIN_PROTOCOL_INFO(gaim_find_prpl
-                                  (gaim_account_get_protocol_id(account)));
-
-
-    timeout = (guint *) g_hash_table_lookup(popup_timeouts, tv);
-    /* we check to see if we're still supposed to be moving, now that gtk
-       events have happened, and the mouse might not still be in the buddy 
-       list */
-    while (gtk_events_pending())
-        gtk_main_iteration();
-    if (!(*timeout)) {
-        return FALSE;
-    }
-
-    if (type == TOOLTIP_CHAT) {
-        GtkTreePath *path;
-        GtkTreeIter iter;
-        GtkTreeModel *model;
-        GdkRectangle *rect;
-
-        rect = g_hash_table_lookup(popup_rects, tv);
-        if (!gtk_tree_view_get_path_at_pos
-            (GTK_TREE_VIEW(tv), rect-&gt;x, rect-&gt;y, &amp;path, NULL, NULL, NULL))
-            return FALSE;
-        model = gtk_tree_view_get_model(GTK_TREE_VIEW(tv));
-        gtk_tree_model_get_iter(model, &amp;iter, path);
-        gtk_tree_model_get(model, &amp;iter, CHAT_USERS_NAME_COLUMN, &amp;name,
-                           -1);
-        gtk_tree_path_free(path);
-    } else if (type == TOOLTIP_IM) {
-        name = gtk_label_get_text(GTK_LABEL(tv));
-    } else
-        return FALSE;
-
-
-
-
-    GaimBuddy *gb = g_new0(GaimBuddy, 1);
-    gb-&gt;name = g_strdup(name);
-    gb-&gt;account = account;
-    tooltiptext = prpl_info-&gt;tooltip_text(gb);
-    g_free(gb-&gt;name);
-    g_free(gb);
-
-    if (!tooltiptext)
-        return FALSE;
-
-
-    g_return_val_if_fail(tooltiptext != NULL, FALSE);
-
-    tipwindow = g_hash_table_lookup(popups, tv);
-    if (tipwindow) {
-        g_hash_table_remove(popups, tv);
-    }
-    tipwindow = gtk_window_new(GTK_WINDOW_POPUP);
-    g_hash_table_insert(popups, tv, tipwindow);
-
-    gtk_widget_set_app_paintable(tipwindow, TRUE);
-    gtk_window_set_resizable(GTK_WINDOW(tipwindow), FALSE);
-    gtk_widget_set_name(tipwindow, &quot;gtk-tooltips&quot;);
-
-    struct paint_data *pdata = g_new0(struct paint_data, 1);
-    pdata-&gt;tooltiptext = tooltiptext;
-    pdata-&gt;pixbuf = lookup_cached_thumbnail(account, name);
-    g_signal_connect(G_OBJECT(tipwindow), &quot;expose_event&quot;,
-                     G_CALLBACK(namelist_paint_tip), pdata);
-    gtk_widget_ensure_style(tipwindow);
-    layout = gtk_widget_create_pango_layout(tipwindow, NULL);
-    pango_layout_set_wrap(layout, PANGO_WRAP_WORD);
-    pango_layout_set_width(layout, 300000);
-    pango_layout_set_markup(layout, tooltiptext, strlen(tooltiptext));
-    pango_layout_get_size(layout, &amp;w, &amp;h);
-
-#if GTK_CHECK_VERSION(2,2,0)
-    gdk_display_get_pointer(gdk_display_get_default(), &amp;screen, &amp;x, &amp;y,
-                            NULL);
-    mon_num = gdk_screen_get_monitor_at_point(screen, x, y);
-    gdk_screen_get_monitor_geometry(screen, mon_num, &amp;mon_size);
-
-    scr_w = mon_size.width + mon_size.x;
-    scr_h = mon_size.height + mon_size.y;
-#else
-    scr_w = gdk_screen_width();
-    scr_h = gdk_screen_height();
-    gdk_window_get_pointer(NULL, &amp;x, &amp;y, NULL);
-    mon_size.x = 0;
-    mon_size.y = 0;
-#endif
-
-
-    w = PANGO_PIXELS(w) + 8;
-    h = PANGO_PIXELS(h) + 8;
-
-    /* For the width, set it to the text width, plus 13 for 4 pixels on
-       each side and 5 between icon/text. For height, the greater of the
-       text height and the icon height, plus 8 (4 for each buffer on top
-       and bottom). */
-    w = w + gdk_pixbuf_get_width(pdata-&gt;pixbuf) + 4;
-    h = MAX(h, gdk_pixbuf_get_height(pdata-&gt;pixbuf) + 8);
-
-#if GTK_CHECK_VERSION(2,2,0)
-    if (w &gt; mon_size.width)
-        w = mon_size.width - 10;
-
-    if (h &gt; mon_size.height)
-        h = mon_size.height - 10;
-#endif
-
-    // Find the conversation window here....
-    // if (GTK_WIDGET_NO_WINDOW(window))
-    // y+=window-&gt;allocation.y;
-
-    x -= ((w &gt;&gt; 1) + 4);
-
-    if ((y + h + 4) &gt; scr_h || tooltip_top)
-        y = y - h - 5;
-    else
-        y = y + 6;
-
-    if (y &lt; mon_size.y)
-        y = mon_size.y;
-
-    if (y != mon_size.y) {
-        if ((x + w) &gt; scr_w)
-            x -= (x + w + 5) - scr_w;
-        else if (x &lt; mon_size.x)
-            x = mon_size.x;
-    } else {
-        x -= (w / 2 + 10);
-        if (x &lt; mon_size.x)
-            x = mon_size.x;
-    }
-
-    g_object_unref(layout);
-    gtk_widget_set_size_request(tipwindow, w, h);
-    gtk_window_move(GTK_WINDOW(tipwindow), x, y);
-    gtk_widget_show(tipwindow);
-
-    return FALSE;
-}
-
-
-static gboolean namelist_motion_cb(GtkWidget * tv, GdkEventMotion * event,
-                                   gpointer account)
-{
-    GtkTreeModel *ls = NULL;
-    GtkTreePath *path = NULL;
-    GtkTreeIter iter;
-    char *name;
-    static int count = 0;
-    gboolean tf;
-    GdkRectangle *rect;
-    guint *timeout;
-    count++;
-    guint delay;
-    rect = g_hash_table_lookup(popup_rects, tv);
-    g_return_val_if_fail(rect != NULL, FALSE);
-
-    timeout = g_hash_table_lookup(popup_timeouts, tv);
-
-    delay = gaim_prefs_get_int(&quot;/gaim/gtk/blist/tooltip_delay&quot;);
-
-    if (delay == 0)
-        return FALSE;
-
-    if (*timeout) {
-        if ((event-&gt;y &gt; rect-&gt;y) &amp;&amp; ((event-&gt;y - rect-&gt;height) &lt; rect-&gt;y))
-            return FALSE;
-        /* We've left the cell.  Remove the timeout and create a new one
-           below */
-
-        g_hash_table_remove(popups, tv);
-        g_source_remove(*timeout);
-    }
-
-    gtk_tree_view_get_path_at_pos(GTK_TREE_VIEW(tv), event-&gt;x, event-&gt;y,
-                                  &amp;path, NULL, NULL, NULL);
-    if (G_UNLIKELY(path == NULL))
-        return FALSE;
-    struct timeout_cb_data *timeout_data =
-        g_new0(struct timeout_cb_data, 1);
-    timeout_data-&gt;tv = tv;
-    timeout_data-&gt;account = account;
-    timeout_data-&gt;type = TOOLTIP_CHAT;
-    *timeout =
-        g_timeout_add(delay, (GSourceFunc) tooltip_timeout, timeout_data);
-
-    gtk_tree_view_get_cell_area(GTK_TREE_VIEW(tv), path, NULL, rect);
-
-    ls = gtk_tree_view_get_model(GTK_TREE_VIEW(tv));
-    tf = gtk_tree_model_get_iter(ls, &amp;iter, path);
-    gtk_tree_model_get(ls, &amp;iter, CHAT_USERS_NAME_COLUMN, &amp;name, -1);
-    gtk_tree_view_get_cell_area(GTK_TREE_VIEW(tv), path, NULL, rect);
-
-    return TRUE;
-}
-
-static void tab_leave_cb(GtkWidget * event, GdkEventCrossing * e,
-                         gpointer conv)
-{
-
-    GaimConversation *c = (GaimConversation *) conv;
-
-    GaimGtkConversation *gtkconv = GAIM_GTK_CONVERSATION(c);
-    // Prevent clicks from demolishing popup.
-    if (e-&gt;mode != GDK_CROSSING_NORMAL)
-        return;
-    GtkWidget *tab = gtkconv-&gt;tab_label;
-
-    guint *timeout = g_hash_table_lookup(popup_timeouts, tab);
-    g_hash_table_remove(popups, tab);
-
-
-    if (timeout &amp;&amp; *timeout) {
-        g_source_remove(*timeout);
-        *timeout = 0;
-    }
-}
-
-
-static gboolean tab_entry_cb(GtkWidget * event,
-                             GdkEventCrossing * crossing, gpointer conv)
-{
-
-    guint *timeout;
-    guint delay;
-    GaimConversation *c = (GaimConversation *) conv;
-    GaimAccount *account = gaim_conversation_get_account(c);
-    GaimGtkConversation *gtkconv = GAIM_GTK_CONVERSATION(c);
-
-    GtkWidget *tab = gtkconv-&gt;tab_label;
-    timeout = g_hash_table_lookup(popup_timeouts, tab);
-
-    delay = gaim_prefs_get_int(&quot;/gaim/gtk/blist/tooltip_delay&quot;);
-
-    if (delay == 0)
-        return FALSE;
-
-    if (timeout &amp;&amp; *timeout)
-        return FALSE;
-
-    // g_hash_table_remove(popups, tab);
-    // g_source_remove(*timeout);
-
-
-
-    struct timeout_cb_data *timeout_data =
-        g_new0(struct timeout_cb_data, 1);
-    timeout_data-&gt;tv = tab;
-    timeout_data-&gt;account = account;
-    timeout_data-&gt;type = TOOLTIP_IM;
-    *timeout =
-        g_timeout_add(delay, (GSourceFunc) tooltip_timeout, timeout_data);
-
-    return TRUE;
-}
-
-void add_chat_popup_stuff(GaimConversation * c)
-{
-
-    GaimGtkConversation *gtkconv = GAIM_GTK_CONVERSATION(c);
-    GaimGtkChatPane *gtkchat = gtkconv-&gt;u.chat;
-    GaimAccount *account = gaim_conversation_get_account(c);
-
-    g_signal_connect(G_OBJECT(gtkchat-&gt;list), &quot;motion-notify-event&quot;,
-                     G_CALLBACK(namelist_motion_cb), account);
-    g_signal_connect(G_OBJECT(gtkchat-&gt;list), &quot;leave-notify-event&quot;,
-                     G_CALLBACK(namelist_leave_cb), NULL);
-
-
-    g_hash_table_insert(popup_rects, gtkchat-&gt;list,
-                        g_new0(GdkRectangle, 1));
-    g_hash_table_insert(popup_timeouts, gtkchat-&gt;list, g_new0(guint, 1));
-
-
-}
-
-void add_im_popup_stuff(GaimConversation * c)
-{
-    GaimGtkConversation *gtkconv = GAIM_GTK_CONVERSATION(c);
-    GtkWidget *event = gtk_event_box_new();
-    GtkWidget *hbox = gtk_hbox_new(FALSE, 6);
-
-    gtk_widget_ref(gtkconv-&gt;icon);
-    gtk_container_remove(GTK_CONTAINER(gtkconv-&gt;tabby),
-                         GTK_WIDGET(gtkconv-&gt;icon));
-    gtk_box_pack_start(GTK_BOX(hbox), GTK_WIDGET(gtkconv-&gt;icon), FALSE,
-                       FALSE, 0);
-    gtk_widget_ref(gtkconv-&gt;icon);
-    gtk_widget_unref(gtkconv-&gt;icon);
-
-    gtk_widget_ref(gtkconv-&gt;tab_label);
-    gtk_container_remove(GTK_CONTAINER(gtkconv-&gt;tabby),
-                         GTK_WIDGET(gtkconv-&gt;tab_label));
-    gtk_box_pack_start(GTK_BOX(hbox), GTK_WIDGET(gtkconv-&gt;tab_label), TRUE,
-                       TRUE, 0);
-    gtk_widget_unref(gtkconv-&gt;tab_label);
-
-
-    gtk_widget_add_events(event,
-                          GDK_ENTER_NOTIFY_MASK | GDK_LEAVE_NOTIFY_MASK);
-    g_signal_connect(G_OBJECT(event), &quot;enter-notify-event&quot;,
-                     G_CALLBACK(tab_entry_cb), c);
-    g_signal_connect(G_OBJECT(event), &quot;leave-notify-event&quot;,
-                     G_CALLBACK(tab_leave_cb), c);
-    gtk_box_pack_start(GTK_BOX(gtkconv-&gt;tabby), GTK_WIDGET(event), TRUE,
-                       TRUE, 0);
-    gtk_box_reorder_child(GTK_BOX(gtkconv-&gt;tabby), GTK_WIDGET(event), 0);
-    gtk_widget_show(GTK_WIDGET(event));
-    gtk_widget_show(GTK_WIDGET(hbox));
-    gtk_event_box_set_visible_window(GTK_EVENT_BOX(event), FALSE);
-    gtk_container_add(GTK_CONTAINER(event), GTK_WIDGET(hbox));
-    g_hash_table_insert(popup_timeouts, gtkconv-&gt;tab_label,
-                        g_new0(guint, 1));
-}
-
-void init_popups()
-{
-    popup_rects =
-        g_hash_table_new_full(g_direct_hash, g_direct_equal, NULL, g_free);
-
-    popup_timeouts =
-        g_hash_table_new_full(g_direct_hash, g_direct_equal, NULL, g_free);
-
-    popups =
-        g_hash_table_new_full(g_direct_hash, g_direct_equal, NULL,
-                              (GDestroyNotify) gtk_widget_destroy);
-}

Copied: qrc/tags/release-0.9/gaym-extras/src/bio-popups.c (from rev 260, qrc/trunk/gaym-extras/src/bio-popups.c)

Deleted: qrc/tags/release-0.9/gaym-extras/src/gaym-extras.c
===================================================================
--- qrc/trunk/gaym-extras/src/gaym-extras.c	2005-07-30 22:19:23 UTC (rev 259)
+++ qrc/tags/release-0.9/gaym-extras/src/gaym-extras.c	2005-07-31 19:13:29 UTC (rev 264)
@@ -1,140 +0,0 @@
-/* Show icons in chat room windows */
-
-
-#include &quot;gaym-extras.h&quot;
-// Adds motion handlers to IM tab labels.
-static void redo_im_window(GaimConversation * c)
-{
-    if (!g_strrstr(gaim_account_get_protocol_id(c-&gt;account), &quot;prpl-gaym&quot;))
-        return;
-    if (c &amp;&amp; c-&gt;type == GAIM_CONV_IM)
-        add_im_popup_stuff(c);
-}
-
-
-static void update_info_cb(GaimAccount * account, char *name)
-{
-    if (!g_strrstr(gaim_account_get_protocol_id(account), &quot;prpl-gaym&quot;))
-        return;
-    gaim_debug_misc(&quot;gaym-extras&quot;, &quot;info update\n&quot;);
-}
-
-static void redochatwindow(GaimConversation * c)
-{
-    if (!g_strrstr(gaim_account_get_protocol_id(c-&gt;account), &quot;prpl-gaym&quot;))
-        return;
-    add_chat_sort_functions(c);
-    add_chat_popup_stuff(c);
-    add_chat_icon_stuff(c);
-}
-static gchar *find_file(const char *dir, const char *base)
-{
-    char *filename;
-
-    if (base == NULL)
-        return NULL;
-
-    if (!strcmp(dir, &quot;gaim&quot;))
-        filename =
-            g_build_filename(GAIM_DATADIR, &quot;pixmaps&quot;, &quot;gaim&quot;, base, NULL);
-    else {
-        filename = g_build_filename(GAIM_DATADIR, &quot;pixmaps&quot;, &quot;gaim&quot;, dir,
-                                    base, NULL);
-    }
-
-    if (!g_file_test(filename, G_FILE_TEST_EXISTS)) {
-        g_critical(&quot;Unable to load stock pixmap %s\n&quot;, filename);
-
-        g_free(filename);
-
-        return NULL;
-    }
-
-    return filename;
-
-}
-
-void extras_register_stock()
-{
-
-    static gboolean stock_is_init = FALSE;
-    GtkIconFactory *icon_factory = NULL;
-    int i;
-    if (stock_is_init)
-        return;
-    stock_is_init = TRUE;
-    icon_factory = gtk_icon_factory_new();
-
-    gtk_icon_factory_add_default(icon_factory);
-
-    for (i = 0; i &lt; G_N_ELEMENTS(stock_icons); i++) {
-        GdkPixbuf *pixbuf;
-        GtkIconSet *iconset;
-        gchar *filename;
-        filename = find_file(stock_icons[i].dir, stock_icons[i].filename);
-        if (filename == NULL)
-            continue;
-
-        pixbuf = gdk_pixbuf_new_from_file(filename, NULL);
-        g_free(filename);
-        iconset = gtk_icon_set_new_from_pixbuf(pixbuf);
-
-        g_object_unref(pixbuf);
-        gtk_icon_factory_add(icon_factory, stock_icons[i].name, iconset);
-        gtk_icon_set_unref(iconset);
-    }
-
-
-}
-static gboolean plugin_load(GaimPlugin * plugin)
-{
-    init_chat_icons();
-    init_popups();
-
-    gaim_signal_connect(gaim_conversations_get_handle(), &quot;chat-joined&quot;,
-                        plugin, GAIM_CALLBACK(redochatwindow), NULL);
-
-    gaim_signal_connect(gaim_conversations_get_handle(),
-                        &quot;conversation-created&quot;, plugin,
-                        GAIM_CALLBACK(redo_im_window), NULL);
-
-    gaim_signal_connect(gaim_accounts_get_handle(), &quot;info-updated&quot;, plugin,
-                        GAIM_CALLBACK(update_info_cb), NULL);
-
-    gaim_signal_connect(gaim_conversations_get_handle(),
-                        &quot;deleting-conversation&quot;, plugin,
-                        GAIM_CALLBACK(clean_popup_stuff), NULL);
-
-    extras_register_stock();
-    return TRUE;
-}
-
-static GaimPluginInfo info = {
-    GAIM_PLUGIN_MAGIC,
-    GAIM_MAJOR_VERSION,
-    GAIM_MINOR_VERSION,
-    GAIM_PLUGIN_STANDARD,
-    GAIM_GTK_PLUGIN_TYPE,
-    0,
-    NULL,
-    GAIM_PRIORITY_DEFAULT,
-    GAYM_EXTRAS_PLUGIN_ID,
-    N_(&quot;Gaym Extras&quot;),
-    VERSION,
-    N_(&quot;GUI-related additions for the gaym protocol plugin.&quot;),
-    N_(&quot;Current functionality provided by this plugin:\n1. Allows namelist sort order in rooms to be changed.\n2. Shows thumbnails for currently selected user in rooms.\n3. Popup displays bio when you hover over a name in the namelist.\n4. Popup shows bio when you hover over an IM tab.&quot;),
-    &quot;Jason LeBrun <A HREF="https://lists.berlios.de/mailman/listinfo/qrc-svn">gaym at jasonlebrun.info</A>&quot;,
-    GAIM_WEBSITE,
-    plugin_load,
-    NULL,
-    NULL,
-    NULL,
-    NULL,
-    NULL
-};
-
-static void init_plugin(GaimPlugin * plugin)
-{
-}
-
-GAIM_INIT_PLUGIN(history, init_plugin, info)

Copied: qrc/tags/release-0.9/gaym-extras/src/gaym-extras.c (from rev 260, qrc/trunk/gaym-extras/src/gaym-extras.c)

Deleted: qrc/tags/release-0.9/gaym-extras/src/roombrowse.c
===================================================================
--- qrc/trunk/gaym-extras/src/roombrowse.c	2005-07-30 22:19:23 UTC (rev 259)
+++ qrc/tags/release-0.9/gaym-extras/src/roombrowse.c	2005-07-31 19:13:29 UTC (rev 264)
@@ -1,435 +0,0 @@
-/* Puts last 4k of log in new conversations a la Everybuddy (and then
-   stolen by Trillian &quot;Pro&quot;) */
-
-#include &quot;internal.h&quot;
-#include &quot;gtkgaim.h&quot;
-
-#include &quot;conversation.h&quot;
-#include &quot;debug.h&quot;
-#include &quot;log.h&quot;
-#include &quot;prefs.h&quot;
-#include &quot;signals.h&quot;
-#include &quot;util.h&quot;
-#include &quot;version.h&quot;
-#include &quot;prpl.h&quot;
-
-#include &quot;gtkconv.h&quot;
-#include &quot;gtkimhtml.h&quot;
-#include &quot;gtkplugin.h&quot;
-#include &quot;gtkdialogs.h&quot;
-#include &quot;gtkutils.h&quot;
-#include &quot;gtkblist.h&quot;
-#include &quot;gtkimhtmltoolbar.h&quot;
-#include &lt;gdk/gdkkeysyms.h&gt;
-
-#define CHATSORT_PLUGIN_ID &quot;gtk-chatsort&quot;
-#define CHATSORT_USERS_COLUMNS 4
-#define CHATSORT_USERS_ENTRY_COLUMN 3
-
-/**
- * Unused variables:
- *
- * static GList *browsers = NULL;
- */
-
-struct RoomBrowseInfo {
-
-    GaimAccount *account;
-    GaimConnection *gc;
-};
-
-static GtkWidget *setup_roombrowse_pane(GaimConversation * conv)
-{
-    GaimGtkConversation *gtkconv;
-    GaimGtkChatPane *gtkchat;
-    GaimConnection *gc;
-    GtkWidget *vpaned, *hpaned;
-    GtkWidget *vbox;
-
-        /**
-	 * Unused variables:
-	 *
-	 * GaimPluginProtocolInfo *prpl_info = NULL;
-	 * GtkWidget *hbox;
-	 * GtkWidget *lbox, *bbox;
-	 * GtkWidget *label;
-	 * GtkWidget *list;
-	 * GtkWidget *button;
-	 * GtkWidget *sw;
-	 * GtkListStore *ls;
-	 * GtkCellRenderer *rend;
-	 * GtkTreeViewColumn *col;
-	 * GList *focus_chain = NULL;
-	 */
-
-    gtkconv = GAIM_GTK_CONVERSATION(conv);
-    gtkchat = gtkconv-&gt;u.chat;
-    gc = gaim_conversation_get_gc(conv);
-
-    /* Setup the outer pane. */
-    vpaned = gtk_vpaned_new();
-    gtk_widget_show(vpaned);
-    /* Setup the top part of the pane. */
-    vbox = gtk_vbox_new(FALSE, 6);
-    gtk_paned_pack1(GTK_PANED(vpaned), vbox, TRUE, TRUE);
-    gtk_widget_show(vbox);
-
-    /* Setup the horizontal pane. */
-    hpaned = gtk_hpaned_new();
-    gtk_box_pack_start(GTK_BOX(vbox), hpaned, TRUE, TRUE, 0);
-    gtk_widget_show(hpaned);
-
-    /* Setup the scrolled window to put gtkimhtml in. */
-    gtkconv-&gt;sw = gtk_scrolled_window_new(NULL, NULL);
-    gtk_scrolled_window_set_policy(GTK_SCROLLED_WINDOW(gtkconv-&gt;sw),
-                                   GTK_POLICY_AUTOMATIC,
-                                   GTK_POLICY_ALWAYS);
-    gtk_scrolled_window_set_shadow_type(GTK_SCROLLED_WINDOW(gtkconv-&gt;sw),
-                                        GTK_SHADOW_IN);
-    gtk_paned_pack1(GTK_PANED(hpaned), gtkconv-&gt;sw, TRUE, TRUE);
-
-    gtk_widget_set_size_request(gtkconv-&gt;sw,
-                                gaim_prefs_get_int
-                                (&quot;/gaim/gtk/conversations/chat/default_width&quot;),
-                                gaim_prefs_get_int
-                                (&quot;/gaim/gtk/conversations/chat/default_height&quot;));
-
-    // g_signal_connect(G_OBJECT(gtkconv-&gt;sw), &quot;size-allocate&quot;,
-    // G_CALLBACK(size_allocate_cb), conv);
-
-    gtk_widget_show(gtkconv-&gt;sw);
-
-    return vpaned;
-}
-
-static gint close_conv_cb(GtkWidget * w, gpointer d)
-{
-    GaimConversation *conv = (GaimConversation *) d;
-
-    gaim_conversation_destroy(conv);
-
-    return TRUE;
-}
-
-GdkPixbuf *get_tab_icon(GaimConversation * conv, gboolean small_icon)
-{
-    GaimAccount *account = NULL;
-    const char *name = NULL;
-    GdkPixbuf *status = NULL;
-
-    g_return_val_if_fail(conv != NULL, NULL);
-
-    account = gaim_conversation_get_account(conv);
-    name = gaim_conversation_get_name(conv);
-
-    g_return_val_if_fail(account != NULL, NULL);
-    g_return_val_if_fail(name != NULL, NULL);
-
-
-    if (gaim_conversation_get_type(conv) == GAIM_CONV_IM) {
-        GaimBuddy *b = gaim_find_buddy(account, name);
-        if (b != NULL) {
-            status = gaim_gtk_blist_get_status_icon((GaimBlistNode *) b,
-                                                    (small_icon ?
-                                                     GAIM_STATUS_ICON_SMALL
-                                                     :
-                                                     GAIM_STATUS_ICON_LARGE));
-        }
-    }
-
-    if (!status) {
-        GdkPixbuf *pixbuf;
-        pixbuf = create_prpl_icon(account);
-
-        if (small_icon &amp;&amp; pixbuf != NULL) {
-            status = gdk_pixbuf_scale_simple(pixbuf, 15, 15,
-                                             GDK_INTERP_BILINEAR);
-            g_object_unref(pixbuf);
-        } else
-            status = pixbuf;
-    }
-    return status;
-}
-
-/**
- * Unused function
- */
-#if 0
-static void update_tab_icon(GaimConversation * conv)
-{
-    GaimGtkConversation *gtkconv;
-    GaimConvWindow *win = gaim_conversation_get_window(conv);
-    GaimAccount *account;
-    const char *name;
-    GdkPixbuf *status = NULL;
-
-    g_return_if_fail(conv != NULL);
-
-    gtkconv = GAIM_GTK_CONVERSATION(conv);
-    name = gaim_conversation_get_name(conv);
-    account = gaim_conversation_get_account(conv);
-
-    status = get_tab_icon(conv, TRUE);
-
-    g_return_if_fail(status != NULL);
-
-    gtk_image_set_from_pixbuf(GTK_IMAGE(gtkconv-&gt;icon), status);
-    gtk_image_set_from_pixbuf(GTK_IMAGE(gtkconv-&gt;menu_icon), status);
-
-    if (status != NULL)
-        g_object_unref(status);
-
-    if (gaim_conv_window_get_active_conversation(win) == conv &amp;&amp;
-        gtkconv-&gt;u.im-&gt;anim == NULL) {
-        status = get_tab_icon(conv, FALSE);
-
-        gtk_window_set_icon(GTK_WINDOW(GAIM_GTK_WINDOW(win)-&gt;window),
-                            status);
-
-        if (status != NULL)
-            g_object_unref(status);
-    }
-}
-#endif
-
-/* Courtesy of Galeon! */
-static void
-tab_close_button_state_changed_cb(GtkWidget * widget,
-                                  GtkStateType prev_state)
-{
-    if (GTK_WIDGET_STATE(widget) == GTK_STATE_ACTIVE)
-        gtk_widget_set_state(widget, GTK_STATE_NORMAL);
-}
-
-static void
-roombrowse_gtk_add_conversation(GaimConvWindow * win,
-                                GaimConversation * conv)
-{
-    GaimGtkWindow *gtkwin;
-    GaimGtkConversation *gtkconv, *focus_gtkconv;
-    GaimConversation *focus_conv;
-    GtkWidget *pane = NULL;
-    GtkWidget *tab_cont;
-    GtkWidget *tabby, *menu_tabby;
-    GtkWidget *close_image;
-    gboolean new_ui;
-    GaimConversationType conv_type;
-    const char *name;
-
-    name = gaim_conversation_get_name(conv);
-    conv_type = gaim_conversation_get_type(conv);
-    gtkwin = GAIM_GTK_WINDOW(win);
-
-    if (conv-&gt;ui_data != NULL) {
-        gtkconv = (GaimGtkConversation *) conv-&gt;ui_data;
-
-        tab_cont = gtkconv-&gt;tab_cont;
-
-        new_ui = FALSE;
-    } else {
-        gtkconv = g_malloc0(sizeof(GaimGtkConversation));
-        conv-&gt;ui_data = gtkconv;
-
-        /* Setup some initial variables. */
-        gtkconv-&gt;sg = gtk_size_group_new(GTK_SIZE_GROUP_BOTH);
-        gtkconv-&gt;tooltips = gtk_tooltips_new();
-
-        gaim_debug_misc(&quot;roombrowse&quot;, &quot;setting up pane\n&quot;);
-        pane = setup_roombrowse_pane(conv);
-
-        gaim_debug_misc(&quot;roombrowse&quot;, &quot;set up pane\n&quot;);
-
-        if (pane == NULL) {
-            g_free(gtkconv);
-            conv-&gt;ui_data = NULL;
-
-            return;
-        }
-
-
-
-        /* Setup the container for the tab. */
-        gtkconv-&gt;tab_cont = tab_cont = gtk_vbox_new(FALSE, 6);
-        gtk_container_set_border_width(GTK_CONTAINER(tab_cont), 6);
-        gtk_container_add(GTK_CONTAINER(tab_cont), pane);
-        gtk_widget_show(pane);
-
-        new_ui = TRUE;
-
-        gtkconv-&gt;make_sound = FALSE;
-        gtkconv-&gt;show_formatting_toolbar = FALSE;
-        gtkconv-&gt;show_timestamps = FALSE;
-
-        g_signal_connect_swapped(G_OBJECT(pane), &quot;focus&quot;,
-                                 G_CALLBACK(gtk_widget_grab_focus),
-                                 gtkconv-&gt;entry);
-    }
-
-    gaim_debug_misc(&quot;roombrowse&quot;, &quot;Setting up tabs\n&quot;);
-    gtkconv-&gt;tabby = tabby = gtk_hbox_new(FALSE, 6);
-    gtkconv-&gt;menu_tabby = menu_tabby = gtk_hbox_new(FALSE, 6);
-    gtkconv-&gt;entry = gtk_imhtml_new(NULL, NULL);
-    gtkconv-&gt;toolbar = gtk_imhtmltoolbar_new();
-
-    gaim_debug_misc(&quot;roombrowse&quot;, &quot;Setting up close button\n&quot;);
-    /* Close button. */
-    gtkconv-&gt;close = gtk_button_new();
-    gtk_widget_set_size_request(GTK_WIDGET(gtkconv-&gt;close), 16, 16);
-    gtk_button_set_relief(GTK_BUTTON(gtkconv-&gt;close), GTK_RELIEF_NONE);
-    close_image =
-        gtk_image_new_from_stock(GTK_STOCK_CLOSE, GTK_ICON_SIZE_MENU);
-    gtk_widget_show(close_image);
-    gtk_container_add(GTK_CONTAINER(gtkconv-&gt;close), close_image);
-    gtk_tooltips_set_tip(gtkconv-&gt;tooltips, gtkconv-&gt;close,
-                         _(&quot;Close conversation&quot;), NULL);
-
-    g_signal_connect(G_OBJECT(gtkconv-&gt;close), &quot;clicked&quot;,
-                     G_CALLBACK(close_conv_cb), conv);
-
-    /* 
-     * I love Galeon. They have a fix for that stupid annoying visible
-     * border bug. I love you guys! -- ChipX86
-     */
-    g_signal_connect(G_OBJECT(gtkconv-&gt;close), &quot;state_changed&quot;,
-                     G_CALLBACK(tab_close_button_state_changed_cb), NULL);
-
-    /* Status icon. */
-    gtkconv-&gt;icon = gtk_image_new();
-    gtkconv-&gt;menu_icon = gtk_image_new();
-    // update_tab_icon(conv);
-
-    /* Tab label. */
-    gtkconv-&gt;tab_label = gtk_label_new(gaim_conversation_get_title(conv));
-    gtkconv-&gt;menu_label = gtk_label_new(gaim_conversation_get_title(conv));
-#if 0
-    gtk_misc_set_alignment(GTK_MISC(gtkconv-&gt;tab_label), 0.00, 0.5);
-    gtk_misc_set_padding(GTK_MISC(gtkconv-&gt;tab_label), 4, 0);
-#endif
-
-    gaim_debug_misc(&quot;roombrowse&quot;, &quot;Packing\n&quot;);
-    /* Pack it all together. */
-    gtk_box_pack_start(GTK_BOX(tabby), gtkconv-&gt;icon, FALSE, FALSE, 0);
-    gtk_box_pack_start(GTK_BOX(menu_tabby), gtkconv-&gt;menu_icon,
-                       FALSE, FALSE, 0);
-
-    gtk_widget_show_all(gtkconv-&gt;icon);
-    gtk_widget_show_all(gtkconv-&gt;menu_icon);
-
-    gtk_box_pack_start(GTK_BOX(tabby), gtkconv-&gt;tab_label, TRUE, TRUE, 0);
-    gtk_box_pack_start(GTK_BOX(menu_tabby), gtkconv-&gt;menu_label, TRUE,
-                       TRUE, 0);
-    gtk_widget_show(gtkconv-&gt;tab_label);
-    gtk_widget_show(gtkconv-&gt;menu_label);
-    gtk_misc_set_alignment(GTK_MISC(gtkconv-&gt;menu_label), 0, 0);
-
-    gtk_box_pack_start(GTK_BOX(tabby), gtkconv-&gt;close, FALSE, FALSE, 0);
-    if (gaim_prefs_get_bool(&quot;/gaim/gtk/conversations/close_on_tabs&quot;))
-        gtk_widget_show(gtkconv-&gt;close);
-
-    gtk_widget_show(tabby);
-    gtk_widget_show(menu_tabby);
-
-    if (gaim_conversation_get_type(conv) == GAIM_CONV_IM)
-        gaim_gtkconv_update_buddy_icon(conv);
-
-    gaim_debug_misc(&quot;roombrowse&quot;, &quot;Adding to notebook\n&quot;);
-    gaim_debug_misc(&quot;roombrowse&quot;, &quot;gtkwin-&gt;notebook=%x\n&quot;,
-                    gtkwin-&gt;notebook);
-    gaim_debug_misc(&quot;roombrowse&quot;, &quot;gtkwin=%x\n&quot;, gtkwin);
-    gaim_debug_misc(&quot;roombrowse&quot;, &quot;tabby=%x\n&quot;, tabby);
-    gaim_debug_misc(&quot;roombrowse&quot;, &quot;menu_tabby=%x\n&quot;, menu_tabby);
-    gaim_debug_misc(&quot;roombrowse&quot;, &quot;tab_cont=%x\n&quot;, tab_cont);
-
-    /* Add this pane to the conversation's notebook. */
-    int n = gtk_notebook_get_n_pages(GTK_NOTEBOOK(gtkwin-&gt;notebook));
-    gaim_debug_misc(&quot;roombrowse:&quot;, &quot;Notebook has %d pages\n&quot;, n);
-    gtk_notebook_append_page_menu(GTK_NOTEBOOK(gtkwin-&gt;notebook), tab_cont,
-                                  tabby, menu_tabby);
-    gaim_debug_misc(&quot;roombrowse&quot;, &quot;Got through append_page_menu\n&quot;);
-    gtk_widget_show(tab_cont);
-
-    if (gaim_conv_window_get_conversation_count(win) == 1) {
-        /* Er, bug in notebooks? Switch to the page manually. */
-        gtk_notebook_set_current_page(GTK_NOTEBOOK(gtkwin-&gt;notebook), 0);
-
-        gtk_notebook_set_show_tabs(GTK_NOTEBOOK(gtkwin-&gt;notebook),
-                                   gaim_prefs_get_bool
-                                   (&quot;/gaim/gtk/conversations/tabs&quot;));
-    } else
-        gtk_notebook_set_show_tabs(GTK_NOTEBOOK(gtkwin-&gt;notebook), TRUE);
-    gaim_debug_misc(&quot;roombrowse&quot;, &quot;FOcus stuff\n&quot;);
-    focus_conv = g_list_nth_data(gaim_conv_window_get_conversations(win),
-                                 gtk_notebook_get_current_page(GTK_NOTEBOOK
-                                                               (gtkwin-&gt;
-                                                                notebook)));
-    focus_gtkconv = GAIM_GTK_CONVERSATION(focus_conv);
-    gtk_widget_grab_focus(focus_gtkconv-&gt;entry);
-
-    if (!new_ui)
-        g_object_unref(gtkconv-&gt;tab_cont);
-}
-
-
-static void roombrowse_menu_cb(GaimBlistNode * node, gpointer data)
-{
-    GaimConvWindow *win = gaim_get_first_window_with_type(GAIM_CONV_MISC);
-    GaimConversation *conv = g_new0(GaimConversation, 1);
-
-    GaimAccount *account = ((GaimChat *) node)-&gt;account;
-    if (!win)
-        win = gaim_conv_window_new();
-    GaimChat *chat = ((GaimChat *) node);
-    char *room = g_strdup(g_hash_table_lookup(chat-&gt;components, &quot;name&quot;));
-
-
-    gaim_debug_misc(&quot;roombrowser&quot;, &quot;In cb with node=%x, account=%x\n&quot;,
-                    node, account);
-    conv = gaim_conversation_new(GAIM_CONV_MISC, account, room);
-
-    gaim_conversation_set_logging(conv, FALSE);
-
-    roombrowse_gtk_add_conversation(conv-&gt;window, conv);
-    gaim_conv_window_show(conv-&gt;window);
-
-    g_free(room);
-
-}
-static void roombrowse_menu_create(GaimBlistNode * node, GList ** menu)
-{
-
-    char *label, *room;
-
-    struct gaym_conn *gaym;
-    GaimChat *chat = (GaimChat *) node;
-
-    gaim_debug_misc(&quot;roombrowse&quot;, &quot;In callback\n&quot;);
-    if (node-&gt;type != GAIM_BLIST_CHAT_NODE)
-        return;
-
-    gaym = chat-&gt;account-&gt;gc-&gt;proto_data;
-
-    room = g_strdup(g_hash_table_lookup(chat-&gt;components, &quot;name&quot;));
-    gaim_debug_misc(&quot;roombrowse&quot;, &quot;Room name: %s\n&quot;, room);
-    if (!room)
-        return;
-
-
-    label = g_strdup_printf(&quot;Lurk in %s&quot;, room);
-    GaimBlistNodeAction *act = gaim_blist_node_action_new(label,
-                                                          roombrowse_menu_cb,
-                                                          chat-&gt;account);
-
-    *menu = g_list_append(*menu, act);
-    // g_free(label);
-}
-static gboolean roombrowse_load(GaimPlugin * plugin)
-{
-    gaim_signal_connect(gaim_blist_get_handle(),
-                        &quot;blist-node-extended-menu&quot;,
-                        plugin, GAIM_CALLBACK(roombrowse_menu_create),
-                        NULL);
-
-
-    gaim_debug_misc(&quot;roombrowse&quot;, &quot;Callback registered!\n&quot;);
-    return TRUE;
-}

Copied: qrc/tags/release-0.9/gaym-extras/src/roombrowse.c (from rev 262, qrc/trunk/gaym-extras/src/roombrowse.c)

Deleted: qrc/tags/release-0.9/nsis/installer.nsi
===================================================================
--- qrc/trunk/nsis/installer.nsi	2005-07-30 22:19:23 UTC (rev 259)
+++ qrc/tags/release-0.9/nsis/installer.nsi	2005-07-31 19:13:29 UTC (rev 264)
@@ -1,346 +0,0 @@
-; NSIS Script for the Gaim-QRC Plugins
-; Uses NSIS v2.0
-
-Name &quot;Gaim-QRC ${QRC_VERSION}&quot;
-
-; Registry keys:
-!define QRC_REG_KEY        &quot;SOFTWARE\gaim-qrc&quot;
-!define QRC_UNINSTALL_KEY  &quot;SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\gaim-qrc&quot;
-!define QRC_UNINST_EXE     &quot;gaim-qrc-uninst.exe&quot;
-!define GAYM_DLL           &quot;libgaym.dll&quot;
-!define BOT_CHALLENGER_DLL &quot;libbot-challenger.dll&quot;
-!define GAYM_EXTRAS_DLL	   &quot;libgaym-extras.dll&quot;
-!define GAYM_PNG           &quot;gaym.png&quot;
-!define QRC_UNINSTALL_LNK  &quot;Gaim-QRC Uninstall.lnk&quot;
-!define	ALPHA_PNG	   &quot;alpha.png&quot;
-!define	ENTRY_PNG	   &quot;entry.png&quot;
-!define	PIC_PNG		    &quot;pic.png&quot;
-!include &quot;MUI.nsh&quot;
-
-;Do A CRC Check
-CRCCheck On
-
-;Output File Name
-OutFile &quot;..\gaim-${GAIM_VERSION}-qrc-${QRC_VERSION}.exe&quot;
-
-ShowInstDetails show
-ShowUnInstDetails show
-SetCompressor lzma
-
-; Translations
-!include &quot;locale\english.nsh&quot;
-
-; Gaim Plugin installer helper stuff
-
-!addincludedir &quot;${GAIM_TOP}\src\win32\nsis&quot;
-!include &quot;${GAIM_TOP}\src\win32\nsis\gaim-plugin.nsh&quot;
-
-; Modern UI Configuration
-!define MUI_HEADERIMAGE
-
-; Pages
-!define MUI_WELCOMEPAGE_TITLE $(WELCOME_TITLE)
-!define MUI_WELCOMEPAGE_TEXT $(WELCOME_TEXT)
-!insertmacro MUI_PAGE_WELCOME
-
-!insertmacro MUI_PAGE_LICENSE  &quot;..\COPYING&quot;
-
-!define MUI_DIRECTORYPAGE_TEXT_TOP $(DIR_SUBTITLE)
-!define MUI_DIRECTORYPAGE_TEXT_DESTINATION $(DIR_INNERTEXT)
-!insertmacro MUI_PAGE_DIRECTORY
-
-!define MUI_FINISHPAGE_NOAUTOCLOSE
-!insertmacro MUI_PAGE_INSTFILES
-
-!define MUI_FINISHPAGE_TITLE $(FINISH_TITLE)
-!define MUI_FINISHPAGE_TEXT $(FINISH_TEXT)
-!insertmacro MUI_PAGE_FINISH
-
-; MUI Config
-
-!define MUI_CUSTOMFUNCTION_GUIINIT qrc_checkGaimVersion
-!define MUI_ABORTWARNING
-!define MUI_UNINSTALLER
-!define MUI_PROGRESSBAR smooth
-!define MUI_INSTALLCOLORS /windows
-
-!insertmacro MUI_LANGUAGE &quot;English&quot;
-
-!define MUI_LICENSEPAGE_RADIOBUTTONS
-
-
-;The Default Installation Directory
-InstallDir &quot;$PROGRAMFILES\gaim&quot;
-InstallDirRegKey HKLM SOFTWARE\gaim &quot;&quot;
-
-Section -SecUninstallOldPlugin
-  ; Check install rights..
-  Call CheckUserInstallRights
-  Pop $R0
-
-  StrCmp $R0 &quot;HKLM&quot; rights_hklm
-  StrCmp $R0 &quot;HKCU&quot; rights_hkcu done
-
-  rights_hkcu:
-      ReadRegStr $R1 HKCU &quot;${QRC_REG_KEY}&quot; &quot;&quot;
-      ReadRegStr $R2 HKCU &quot;${QRC_REG_KEY}&quot; &quot;Version&quot;
-      ReadRegStr $R3 HKCU &quot;${QRC_UNINSTALL_KEY}&quot; &quot;UninstallString&quot;
-      Goto try_uninstall
-
-  rights_hklm:
-      ReadRegStr $R1 HKLM &quot;${QRC_REG_KEY}&quot; &quot;&quot;
-      ReadRegStr $R2 HKLM &quot;${QRC_REG_KEY}&quot; &quot;Version&quot;
-      ReadRegStr $R3 HKLM &quot;${QRC_UNINSTALL_KEY}&quot; &quot;UninstallString&quot;
-
-  ; If previous version exists .. remove
-  try_uninstall:
-    StrCmp $R1 &quot;&quot; done
-      StrCmp $R2 &quot;&quot; uninstall_problem
-        IfFileExists $R3 0 uninstall_problem
-          ; Have uninstall string.. go ahead and uninstall.
-          SetOverwrite on
-          ; Need to copy uninstaller outside of the install dir
-          ClearErrors
-          CopyFiles /SILENT $R3 &quot;$TEMP\${QRC_UNINST_EXE}&quot;
-          SetOverwrite off
-          IfErrors uninstall_problem
-            ; Ready to uninstall..
-            ClearErrors
-            ExecWait '&quot;$TEMP\${QRC_UNINST_EXE}&quot; /S _?=$R1'
-            IfErrors exec_error
-              Delete &quot;$TEMP\${QRC_UNINST_EXE}&quot;
-              Goto done
-
-            exec_error:
-              Delete &quot;$TEMP\${QRC_UNINST_EXE}&quot;
-              Goto uninstall_problem
-
-        uninstall_problem:
-            ; Just delete the plugin and uninstaller, and remove Registry key
-             MessageBox MB_YESNO $(QRC_PROMPT_WIPEOUT) IDYES do_wipeout IDNO cancel_install
-          cancel_install:
-            Quit
-
-          do_wipeout:
-            StrCmp $R0 &quot;HKLM&quot; del_lm_reg del_cu_reg
-            del_cu_reg:
-              DeleteRegKey HKCU ${QRC_REG_KEY}
-              Goto uninstall_prob_cont
-            del_lm_reg:
-              DeleteRegKey HKLM ${QRC_REG_KEY}
-
-            uninstall_prob_cont:
-              ; plugin DLL
-              Delete &quot;$R1\plugins\${GAYM_DLL}&quot;
-              Delete &quot;$R1\plugins\${BOT_CHALLENGER_DLL}&quot;
-              Delete &quot;$R1\plugins\${GAYM_EXTRAS_DLL}&quot;
-              ; pixmaps
-	      Delete &quot;$R1\pixmaps\${ALPHA_PNG}&quot;
-	      Delete &quot;$R1\pixmaps\${ENTRY_PNG}&quot;
-	      Delete &quot;$R1\pixmaps\${PIC_PNG}&quot;
-              Delete &quot;$R1\pixmaps\gaim\status\default\${GAYM_PNG}&quot;
-              Delete &quot;$R3&quot;
-
-  done:
-
-SectionEnd
-
-
-Section &quot;Install&quot;
-  Call CheckUserInstallRights
-  Pop $R0
-
-  StrCmp $R0 &quot;NONE&quot; instrights_none
-  StrCmp $R0 &quot;HKLM&quot; instrights_hklm instrights_hkcu
-
-  instrights_hklm:
-    ; Write the version registry keys:
-    WriteRegStr HKLM ${QRC_REG_KEY} &quot;&quot; &quot;$INSTDIR&quot;
-    WriteRegStr HKLM ${QRC_REG_KEY} &quot;Version&quot; &quot;${QRC_VERSION}&quot;
-
-    ; Write the uninstall keys for Windows
-    WriteRegStr HKLM ${QRC_UNINSTALL_KEY} &quot;DisplayName&quot; &quot;$(QRC_UNINSTALL_DESC)&quot;
-    WriteRegStr HKLM ${QRC_UNINSTALL_KEY} &quot;UninstallString&quot; &quot;$INSTDIR\${QRC_UNINST_EXE}&quot;
-    SetShellVarContext &quot;all&quot;
-    Goto install_files
-
-  instrights_hkcu:
-    ; Write the version registry keys:
-    WriteRegStr HKCU ${QRC_REG_KEY} &quot;&quot; &quot;$INSTDIR&quot;
-    WriteRegStr HKCU ${QRC_REG_KEY} &quot;Version&quot; &quot;${QRC_VERSION}&quot;
-
-    ; Write the uninstall keys for Windows
-    WriteRegStr HKCU ${QRC_UNINSTALL_KEY} &quot;DisplayName&quot; &quot;$(QRC_UNINSTALL_DESC)&quot;
-    WriteRegStr HKCU ${QRC_UNINSTALL_KEY} &quot;UninstallString&quot; &quot;$INSTDIR\${QRC_UNINST_EXE}&quot;
-    Goto install_files
-  
-  instrights_none:
-    ; No registry keys for us...
-    
-  install_files:
-    SetOutPath &quot;$INSTDIR\plugins&quot;
-    SetCompress Auto
-    SetOverwrite on
-    File &quot;..\gaym\src\.libs\${GAYM_DLL}&quot;
-    File &quot;..\gaym-extras\src\.libs\${GAYM_EXTRAS_DLL}&quot;
-    File &quot;..\bot-challenger\.libs\${BOT_CHALLENGER_DLL}&quot;
-    
-    SetOutPath &quot;$INSTDIR\pixmaps\gaim\status\default&quot;
-    File &quot;..\gaym\pixmaps\${GAYM_PNG}&quot;
-    	
-    SetOutPath &quot;$INSTDIR\pixmaps&quot;
-    File &quot;..\gaym-extras\pixmaps\${ALPHA_PNG}&quot;
-    File &quot;..\gaym-extras\pixmaps\${ENTRY_PNG}&quot;
-    File &quot;..\gaym-extras\pixmaps\${PIC_PNG}&quot;
-    StrCmp $R0 &quot;NONE&quot; done
-    CreateShortCut &quot;$SMPROGRAMS\Gaim\${QRC_UNINSTALL_LNK}&quot; &quot;$INSTDIR\${QRC_UNINST_EXE}&quot;
-    WriteUninstaller &quot;$INSTDIR\${QRC_UNINST_EXE}&quot;
-    SetOverWrite off
-
-  done:
-SectionEnd
-
-Section Uninstall
-  Call un.CheckUserInstallRights
-  Pop $R0
-  StrCmp $R0 &quot;NONE&quot; no_rights
-  StrCmp $R0 &quot;HKCU&quot; try_hkcu try_hklm
-
-  try_hkcu:
-    ReadRegStr $R0 HKCU &quot;${QRC_REG_KEY}&quot; &quot;&quot;
-    StrCmp $R0 $INSTDIR 0 cant_uninstall
-      ; HKCU install path matches our INSTDIR.. so uninstall
-      DeleteRegKey HKCU &quot;${QRC_REG_KEY}&quot;
-      DeleteRegKey HKCU &quot;${QRC_UNINSTALL_KEY}&quot;
-      Goto cont_uninstall
-
-  try_hklm:
-    ReadRegStr $R0 HKLM &quot;${QRC_REG_KEY}&quot; &quot;&quot;
-    StrCmp $R0 $INSTDIR 0 try_hkcu
-      ; HKLM install path matches our INSTDIR.. so uninstall
-      DeleteRegKey HKLM &quot;${QRC_REG_KEY}&quot;
-      DeleteRegKey HKLM &quot;${QRC_UNINSTALL_KEY}&quot;
-      ; Sets start menu and desktop scope to all users..
-      SetShellVarContext &quot;all&quot;
-
-  cont_uninstall:
-    ; plugin 
-    Delete &quot;$INSTDIR\plugins\${GAYM_DLL}&quot;
-    Delete &quot;$INSTDIR\plugins\${BOT_CHALLENGER_DLL}&quot;
-    ; pixmaps
-    Delete &quot;$INSTDIR\pixmaps\gaim\status\default\${GAYM_PNG}&quot;
-    Delete &quot;$INSTDIR\pixmaps\${ALPHA_PNG}&quot;
-    Delete &quot;$INSTDIR\pixmaps\${ENTRY_PNG}&quot;
-    Delete &quot;$INSTDIR\pixmaps\${PIC_PNG}&quot;
-    ; uninstaller
-    Delete &quot;$INSTDIR\${QRC_UNINST_EXE}&quot;
-    ; uninstaller shortcut
-    Delete &quot;$SMPROGRAMS\Gaim\${QRC_UNINSTALL_LNK}&quot;
-    
-    ; try to delete the Gaim directories, in case it has already uninstalled
-    RMDir &quot;$INSTDIR\plugins&quot;
-    RMDir &quot;$INSTDIR&quot;
-    RMDir &quot;$SMPROGRAMS\Gaim&quot;
-
-    Goto done
-
-  cant_uninstall:
-    MessageBox MB_OK $(un.QRC_UNINSTALL_ERROR_1) IDOK
-    Quit
-
-  no_rights:
-    MessageBox MB_OK $(un.QRC_UNINSTALL_ERROR_2) IDOK
-    Quit
-
-  done:
-SectionEnd
-
-Function .onVerifyInstDir
-  IfFileExists $INSTDIR\gaim.exe Good1
-    Abort
-  Good1:
-FunctionEnd
-
-Function qrc_checkGaimVersion
-  Push $R0
-
-  Push ${GAIM_VERSION}
-  Call CheckGaimVersion
-  Pop $R0
-
-  StrCmp $R0 ${GAIM_VERSION_OK} qrc_checkGaimVersion_OK
-  StrCmp $R0 ${GAIM_VERSION_INCOMPATIBLE} +1 +6
-    Call GetGaimVersion
-    IfErrors +3
-    Pop $R0
-    MessageBox MB_OK|MB_ICONSTOP &quot;$(BAD_GAIM_VERSION_1) $R0 $(BAD_GAIM_VERSION_2)&quot;
-    goto +2
-    MessageBox MB_OK|MB_ICONSTOP &quot;$(NO_GAIM_VERSION)&quot;
-    Quit
-
-  qrc_checkGaimVersion_OK:
-  Pop $R0
-FunctionEnd
-
-Function CheckUserInstallRights
-        ClearErrors
-        UserInfo::GetName
-        IfErrors Win9x
-        Pop $0
-        UserInfo::GetAccountType
-        Pop $1
-
-        StrCmp $1 &quot;Admin&quot; 0 +3
-                StrCpy $1 &quot;HKLM&quot;
-                Goto done
-        StrCmp $1 &quot;Power&quot; 0 +3
-                StrCpy $1 &quot;HKLM&quot;
-                Goto done
-        StrCmp $1 &quot;User&quot; 0 +3
-                StrCpy $1 &quot;HKCU&quot;
-                Goto done
-        StrCmp $1 &quot;Guest&quot; 0 +3
-                StrCpy $1 &quot;NONE&quot;
-                Goto done
-        ; Unknown error
-        StrCpy $1 &quot;NONE&quot;
-        Goto done
-
-        Win9x:
-                StrCpy $1 &quot;HKLM&quot;
-
-        done:
-        Push $1
-FunctionEnd
-
-Function un.CheckUserInstallRights
-        ClearErrors
-        UserInfo::GetName
-        IfErrors Win9x
-        Pop $0
-        UserInfo::GetAccountType
-        Pop $1
-        StrCmp $1 &quot;Admin&quot; 0 +3
-                StrCpy $1 &quot;HKLM&quot;
-                Goto done
-        StrCmp $1 &quot;Power&quot; 0 +3
-                StrCpy $1 &quot;HKLM&quot;
-                Goto done
-        StrCmp $1 &quot;User&quot; 0 +3
-                StrCpy $1 &quot;HKCU&quot;
-                Goto done
-        StrCmp $1 &quot;Guest&quot; 0 +3
-                StrCpy $1 &quot;NONE&quot;
-                Goto done
-        ; Unknown error
-        StrCpy $1 &quot;NONE&quot;
-        Goto done
-
-        Win9x:
-                StrCpy $1 &quot;HKLM&quot;
-
-        done:
-        Push $1
-FunctionEnd
-
-

Copied: qrc/tags/release-0.9/nsis/installer.nsi (from rev 260, qrc/trunk/nsis/installer.nsi)


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000193.html">[Qrc-svn] r263 - in qrc/branches: . buddy_icon_hack/gaym/src buddy_icon_hack/gaym-extras/src buddy_icon_hack/nsis
</A></li>
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#194">[ date ]</a>
              <a href="thread.html#194">[ thread ]</a>
              <a href="subject.html#194">[ subject ]</a>
              <a href="author.html#194">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/qrc-svn">More information about the Qrc-svn
mailing list</a><br>
</body></html>
