<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Qrc-svn] r249 - in qrc/trunk: gaym/src gaym-extras
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/qrc-svn/2005-July/index.html" >
   <LINK REL="made" HREF="mailto:qrc-svn%40lists.berlios.de?Subject=Re%3A%20%5BQrc-svn%5D%20r249%20-%20in%20qrc/trunk%3A%20gaym/src%20gaym-extras&In-Reply-To=%3C200507281431.j6SEVNUW020160%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000178.html">
   <LINK REL="Next"  HREF="000180.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Qrc-svn] r249 - in qrc/trunk: gaym/src gaym-extras</H1>
    <B>Jason LeBrun at BerliOS</B> 
    <A HREF="mailto:qrc-svn%40lists.berlios.de?Subject=Re%3A%20%5BQrc-svn%5D%20r249%20-%20in%20qrc/trunk%3A%20gaym/src%20gaym-extras&In-Reply-To=%3C200507281431.j6SEVNUW020160%40sheep.berlios.de%3E"
       TITLE="[Qrc-svn] r249 - in qrc/trunk: gaym/src gaym-extras">jblebrun at berlios.de
       </A><BR>
    <I>Thu Jul 28 16:31:23 CEST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="000178.html">[Qrc-svn] r248 - in qrc/trunk: . gaym/src gaym-extras
</A></li>
        <LI>Next message: <A HREF="000180.html">[Qrc-svn] r250 - qrc/trunk/gaym/src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#179">[ date ]</a>
              <a href="thread.html#179">[ thread ]</a>
              <a href="subject.html#179">[ subject ]</a>
              <a href="author.html#179">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: jblebrun
Date: 2005-07-28 16:31:20 +0200 (Thu, 28 Jul 2005)
New Revision: 249

Modified:
   qrc/trunk/gaym-extras/bio-popups.c
   qrc/trunk/gaym-extras/chaticon.c
   qrc/trunk/gaym-extras/chatsort.c
   qrc/trunk/gaym-extras/gaym-extras.c
   qrc/trunk/gaym-extras/roombrowse.c
   qrc/trunk/gaym/src/gaym.c
   qrc/trunk/gaym/src/gaym.h
   qrc/trunk/gaym/src/weblogin.c
Log:
*Lots of bugfixes!
*Chat icons in popups, if they've been cached in a file already.
*Fixed cookie code so gay.com lets us login again.
*Applied indent to everything


We need a new numbering system. How about this is release 0.9?
Still on the table before a release:
*Fix hammer code.
*Finish thumbnail caching system (it's never cleaned at ALL, once you get an icon, that's what you'll see forever).
*Have popups trigger thumbnail fetches
*Have popups update when thumbnails arrive
*Windows build? Anyone want to test this? It builds... need some dll guinea pigs. See README.mingw for details.

Longer term goals (release 1.0
*Completely redone info window
*Floating info window
*Caching of things like your thumbnail and config.txt, so we can login super fast.
*Roombrowser (see who is in a room without entering... super /names)




Modified: qrc/trunk/gaym/src/gaym.c
===================================================================
--- qrc/trunk/gaym/src/gaym.c	2005-07-27 07:47:36 UTC (rev 248)
+++ qrc/trunk/gaym/src/gaym.c	2005-07-28 14:31:20 UTC (rev 249)
@@ -1119,11 +1119,11 @@
 
 static guint gaym_nick_hash(const char *nick)
 {
-    char *lc=NULL;
+    char *lc = NULL;
     guint bucket;
-    
-    if(!nick)
-	return 0;
+
+    if (!nick)
+        return 0;
     lc = g_utf8_strdown(nick, -1);
     bucket = g_str_hash(lc);
     g_free(lc);
@@ -1360,7 +1360,7 @@
     NULL,                       /* normalize */
     NULL,                       /* set_buddy_icon */
     NULL,                       /* remove_group */
-    NULL,		       /* get_cb_real_name */
+    NULL,                       /* get_cb_real_name */
     NULL,                       /* set_chat_topic */
     gaym_find_blist_chat,       /* find_blist_chat */
     gaym_roomlist_get_list,     /* roomlist_get_list */

Modified: qrc/trunk/gaym/src/gaym.h
===================================================================
--- qrc/trunk/gaym/src/gaym.h	2005-07-27 07:47:36 UTC (rev 248)
+++ qrc/trunk/gaym/src/gaym.h	2005-07-28 14:31:20 UTC (rev 249)
@@ -54,7 +54,7 @@
 
 enum { IRC_USEROPT_SERVER, IRC_USEROPT_PORT, IRC_USEROPT_CHARSET };
 enum gaym_state { IRC_STATE_NEW, IRC_STATE_ESTABLISHED };
-enum info_string {INFO_AGE, INFO_LOCATION, INFO_BIO, INFO_URL};
+enum info_string { INFO_AGE, INFO_LOCATION, INFO_BIO, INFO_URL };
 
 struct gaym_conn {
     GaimAccount *account;
@@ -103,7 +103,8 @@
 
 typedef struct {
 
-    char *cookies;
+    gchar *cookies;
+    GHashTable *cookie_table;
     void (*session_cb) (GaimAccount *);
     GaimAccount *account;
     char *username;

Modified: qrc/trunk/gaym/src/weblogin.c
===================================================================
--- qrc/trunk/gaym/src/weblogin.c	2005-07-27 07:47:36 UTC (rev 248)
+++ qrc/trunk/gaym/src/weblogin.c	2005-07-28 14:31:20 UTC (rev 249)
@@ -30,6 +30,7 @@
 
 #include &quot;gaym.h&quot;
 
+#include &quot;helpers.h&quot;
 
 typedef struct {
     void (*callback) (void *, const char *, size_t);
@@ -197,81 +198,48 @@
 
 // This looks for Set-cookie: fields in headers, and adds those cookies
 // To the session struct.
+static void add_cookie(gpointer key, gpointer value, gpointer data)
+{
+    g_return_if_fail(key != NULL);
+    g_return_if_fail(value != NULL);
+    g_return_if_fail(data != NULL);
+    GaimUrlSession *session = (GaimUrlSession *) data;
+    gchar *cookies = session-&gt;cookies;
+    session-&gt;cookies =
+        g_strconcat(cookies ? cookies : &quot;&quot;, key, &quot;=&quot;, value, &quot;; &quot;, NULL);
+    g_free(cookies);
 
-// TODO If a cookie value is re-set, then it will be duplicated, since
-// Set-Cookie
-// field is just appended to already existing cookies. This is not an
-// issue for
-// the current gay.com implementation, but this should be changed, so that
-// receiving a duplicate cookie *updates* the existing value.
-// JBL 10-16-2004
+}
 static void parse_cookies(const char *webdata, GaimUrlSession * session,
                           size_t len)
 {
-
-
-    char *haystack = g_malloc0(len * sizeof(char));
-    size_t cookie_size;
-    strncpy(haystack, webdata, len);
-    char *next_token = haystack;
-    char *end_token;
-    char *new_cookie;
-
-    const char *match = &quot;Set-cookie: &quot;;
-    while ((next_token = strstr(next_token, match))) {
-
-        next_token += strlen(match);    // We don't want the &quot;Set-cookie:
-        // &quot; part!
-        end_token = strstr(next_token, &quot;\r\n&quot;);
-
-        if (!end_token)
-            continue;
-        else {
-
-            cookie_size = end_token - next_token;
-
-            if (session-&gt;cookies)
-                new_cookie =
-                    g_strdup_printf(&quot;%s; %.*s&quot;, session-&gt;cookies,
-                                    cookie_size, next_token);
-            else
-                // FIXME: I think there is a function for resizing the
-                // memory
-                // which is more efficient then a allocation and freeing.
-                new_cookie =
-                    g_strdup_printf(&quot;%.*s&quot;, cookie_size, next_token);
-            if (new_cookie) {
-                g_free(session-&gt;cookies);       // g_strdup makes
-                // allocates memory, so
-                // get rid of the old
-                // stuff.
-                session-&gt;cookies = new_cookie;
-            }
-
-
-
+    gchar **cookies = g_strsplit(webdata, &quot;\n&quot;, -1);
+    gchar **cookie_parts;
+    char *cookie;
+    int index = 0;
+    while (cookies[index]) {
+        cookie =
+            return_string_between(&quot;Set-cookie: &quot;, &quot;; &quot;, cookies[index]);
+        if (cookie) {
+            cookie_parts = g_strsplit(cookie, &quot;=&quot;, 2);
+            if (cookie_parts[0] &amp;&amp; cookie_parts[1])
+                g_hash_table_replace(session-&gt;cookie_table,
+                                     cookie_parts[0], cookie_parts[1]);
         }
-
+        g_free(cookie);
+        index++;
     }
+    g_strfreev(cookies);
+    g_hash_table_foreach(session-&gt;cookie_table, (GHFunc) add_cookie,
+                         session);
+
 }
 
 
-// This is a modified version of gaim's url_fetched_cb function. It has
-// been
-// modified to pass cookies during requests. The cookies are set in
-// user_data,
-// cast as a GaimUrlSession item. Any cookies in the response are added to 
-// 
-// 
-// 
-// 
-// 
-// 
-// 
-// 
-// 
-// this
-// structure, as well.
+/* This is a modified version of gaim's url_fetched_cb function. It has
+   been modified to pass cookies during requests. The cookies are set in
+   user_data, cast as a GaimUrlSession item. Any cookies in the response
+   are added to this structure, as well. */
 static void
 session_fetched_cb(gpointer url_data, gint sock, GaimInputCondition cond)
 {
@@ -299,36 +267,17 @@
                transfer encoding. Gaim doesn't know how to handle
                &quot;chunked&quot;, so should always send the Host header
                regardless, to get around some observed problems */
-            g_snprintf(buf, sizeof(buf), &quot;GET %s%s HTTP/%s\r\n&quot; &quot;User-Agent: %s\r\n&quot; &quot;Host: %s\r\n&quot; &quot;Cookie: %s\r\n&quot;,   // (1) 
-                                                                                                                        // 
-                       // 
-                       // 
-                       // 
-                       // 
-                       // 
-                       // 
-                       // 
-                       // 
-                       // (see 
-                       // above)
+            g_snprintf(buf, sizeof(buf),
+                       &quot;GET %s%s HTTP/%s\r\n&quot; &quot;User-Agent: %s\r\n&quot;
+                       &quot;Host: %s\r\n&quot; &quot;Cookie: %s\r\n&quot;,
                        (gfud-&gt;full ? &quot;&quot; : &quot;/&quot;),
                        (gfud-&gt;full ? gfud-&gt;url : gfud-&gt;website.page),
-                       (gfud-&gt;http11 ? &quot;1.1&quot; : &quot;1.0&quot;),
-                       gfud-&gt;user_agent, gfud-&gt;website.address,
-                       gfud-&gt;session-&gt;cookies);
+                       (gfud-&gt;http11 ? &quot;1.1&quot; : &quot;1.0&quot;), gfud-&gt;user_agent,
+                       gfud-&gt;website.address, gfud-&gt;session-&gt;cookies);
         } else {
-            g_snprintf(buf, sizeof(buf), &quot;GET %s%s HTTP/%s\r\n&quot; &quot;Host: %s\r\n&quot; &quot;Accept-Encoding: identity\r\n&quot; &quot;Cookie: %s\r\n&quot;,        // (1) 
-                                                                                                                                        // 
-                       // 
-                       // 
-                       // 
-                       // 
-                       // 
-                       // 
-                       // 
-                       // 
-                       // See 
-                       // above
+            g_snprintf(buf, sizeof(buf),
+                       &quot;GET %s%s HTTP/%s\r\n&quot; &quot;Host: %s\r\n&quot;
+                       &quot;Accept-Encoding: identity\r\n&quot; &quot;Cookie: %s\r\n&quot;,
                        (gfud-&gt;full ? &quot;&quot; : &quot;/&quot;),
                        (gfud-&gt;full ? gfud-&gt;url : gfud-&gt;website.page),
                        (gfud-&gt;http11 ? &quot;1.1&quot; : &quot;1.0&quot;),
@@ -383,15 +332,9 @@
                                     gfud-&gt;len, gfud-&gt;len, gfud-&gt;webdata);
 
                     // JBL 10-16-2004: Put cookies into session
-                    gaim_debug(GAIM_DEBUG_MISC, &quot;gaym&quot;,
-                               &quot;Parsing cookies...&quot;);
 
                     parse_cookies(gfud-&gt;webdata, gfud-&gt;session, gfud-&gt;len);
-                    gaim_debug(GAIM_DEBUG_MISC, &quot;gaym&quot;,
-                               &quot;Found cookies: %s\n&quot;,
-                               (gfud-&gt;session-&gt;cookies));
-                    gaim_debug_misc(&quot;gaim_url_fetch&quot;,
-                                    &quot;Parsing of cookies successful\n&quot;);
+
                     /* See if we can find a redirect. */
                     if (parse_redirect
                         (gfud-&gt;webdata, gfud-&gt;len, sock, gfud))
@@ -451,9 +394,6 @@
         gfud-&gt;webdata = g_realloc(gfud-&gt;webdata, gfud-&gt;len + 1);
         gfud-&gt;webdata[gfud-&gt;len] = 0;
 
-        /* gaim_debug_misc(&quot;gaim_url_fetch&quot;, &quot;Received: '%s'\n&quot;,
-           gfud-&gt;webdata); */
-
         gaim_input_remove(gfud-&gt;inpa);
         close(sock);
         gfud-&gt;callback(gfud-&gt;user_data, gfud-&gt;webdata, gfud-&gt;len);
@@ -510,7 +450,6 @@
     struct gaym_conn *gaym = session-&gt;gaym;
     // Get hash from text
     if (session &amp;&amp; GAIM_CONNECTION_IS_VALID(session-&gt;account-&gt;gc)) {
-        // char *chat_key;
         char *bio;
         char *thumbnail;
         char *temp = NULL;
@@ -581,7 +520,7 @@
             // gaim_connection_error(
             // gaim_account_get_connection(((struct
             // gaym_conn*)((GaimUrlSession*)session)-&gt;account),
-            // _(&quot;Problem parsing password from web. Report a bug.&quot;));
+            // _(&quot;Problem parsing password from web. Report a bug.&quot;)));
         }
         session-&gt;session_cb(gaym-&gt;account);
 
@@ -610,7 +549,7 @@
         int nonce;
         char *buf = g_strdup_printf(_(&quot;Signon: %s&quot;),
                                     (session-&gt;account-&gt;username));
-        gaim_connection_update_progress(session-&gt;account-&gt;gc, buf, 5, 6);
+        gaim_connection_update_progress(session-&gt;account-&gt;gc, buf, 3, 6);
         sscanf(text, &quot;?rand=%d&quot;, &amp;nonce);
         snprintf(url, 512,
                  &quot;<A HREF="http://www.gay.com/messenger/applet.html?rand=%d">http://www.gay.com/messenger/applet.html?rand=%d</A>&quot;,
@@ -628,75 +567,6 @@
     }
 }
 
-
-static void
-gaym_weblogin_step3(gpointer data, const char *text, size_t len)
-{
-
-
-
-
-    GaimUrlSession *session = (GaimUrlSession *) data;
-
-    gaim_debug_misc(&quot;gaym&quot;, &quot;Step 3: session: %x\n&quot;, session);
-    if (session &amp;&amp; GAIM_CONNECTION_IS_VALID(session-&gt;account-&gt;gc)) {
-        if (!strstr(session-&gt;cookies, &quot;MEMBERX&quot;)) {
-            gaim_connection_error((session-&gt;account-&gt;gc),
-                                  _
-                                  (&quot;Problem during login. Are you sure your password is correct?&quot;));
-            return;
-        }
-        // The third step is to get a nonce needed for getting the applet.
-        // We connect to messenger/frameset.html, using previously set
-        // cookie values.
-        // From the returned body, we will need to parse out the rand
-        // values.
-        char *url = &quot;<A HREF="http://www.gay.com/messenger/frameset.html">http://www.gay.com/messenger/frameset.html</A>&quot;;
-        char *buf = g_strdup_printf(_(&quot;Signon: %s&quot;),
-                                    (session-&gt;account-&gt;username));
-        gaim_connection_update_progress(session-&gt;account-&gt;gc, buf, 4, 6);
-        session-&gt;hasFormData = FALSE;
-        gaim_session_fetch(url, FALSE, NULL, FALSE, gaym_weblogin_step4,
-                           session, session);
-    } else {
-
-        gaim_debug_misc(&quot;gaym&quot;, &quot;Connection was cancelled before step3\n&quot;);
-        gaim_debug_misc(&quot;gaym&quot;, &quot;session: %x\n&quot;, session);
-        gaym_session_destroy(session);
-        // g_free(gaym-&gt;session);
-
-    }
-}
-static void
-gaym_weblogin_step2(gpointer data, const char *text, size_t len)
-{
-
-
-    GaimUrlSession *session = (GaimUrlSession *) data;
-    if (session &amp;&amp; GAIM_CONNECTION_IS_VALID(session-&gt;account-&gt;gc)) {
-        gaim_debug_misc(&quot;gaym&quot;, &quot;Step 2: connection is valid.\n&quot;);
-        // The second step is to do the actual login.
-        // We connect to misc/dologin.html, using cookies set from step 1
-        // And add a few more cookie values.
-        char url[1024];
-        char *buf = g_strdup_printf(_(&quot;Signon: %s&quot;),
-                                    session-&gt;account-&gt;username);
-        gaim_connection_update_progress(session-&gt;account-&gt;gc, buf, 3, 6);
-
-        snprintf(url, 1024,
-                 &quot;<A HREF="http://www.gay.com/misc/dologin.html?__login_haveForm=1&amp;__login_save=1&amp;__login_member=%s&amp;redir=%%2Findex.html&amp;__login_basepage=%%2Fmisc%%2Fdologin.html&amp;__login_password=%s">http://www.gay.com/misc/dologin.html?__login_haveForm=1&amp;__login_save=1&amp;__login_member=%s&amp;redir=%%2Findex.html&amp;__login_basepage=%%2Fmisc%%2Fdologin.html&amp;__login_password=%s</A>&quot;,
-                 session-&gt;username, session-&gt;password);
-
-        session-&gt;hasFormData = TRUE;
-        gaim_session_fetch(url, FALSE, NULL, FALSE, gaym_weblogin_step3,
-                           session, session);
-    } else {
-        gaim_debug_misc(&quot;gaym&quot;, &quot;Connection was cancelled before step2\n&quot;);
-        gaim_debug_misc(&quot;gaym&quot;, &quot;session: %x\n&quot;, session);
-        gaym_session_destroy(session);
-        // g_free(gaym-&gt;session);
-    }
-}
 void
 gaym_get_chat_key_from_weblogin(GaimAccount * account,
                                 void (*callback) (GaimAccount * account))
@@ -705,13 +575,6 @@
     struct gaym_conn *gaym = account-&gt;gc-&gt;proto_data;
     if (GAIM_CONNECTION_IS_VALID(account-&gt;gc)) {
 
-        // FIXME: By passing struct gaym_conn around through the 
-        // callbacks, instead of a GaimAccount struct, we will
-        // lose the information needed to free this session if 
-        // conncetion is cancelled. This needs to be modified
-        // to make sure that the GaimUrlSession *session memory
-        // is not leaked!
-
         GaimUrlSession *session = g_new0(GaimUrlSession, 1);
         session-&gt;session_cb = callback;
         session-&gt;cookies = NULL;
@@ -719,8 +582,9 @@
         session-&gt;username = g_strdup(account-&gt;username);
         session-&gt;password = g_strdup(account-&gt;password);
         session-&gt;gaym = gaym;
+        session-&gt;cookie_table =
+            g_hash_table_new_full(g_str_hash, g_str_equal, g_free, g_free);
 
-
         gaim_debug_misc(&quot;gaym&quot;, &quot;Made session: %x\n&quot;, session);
         if (GAIM_CONNECTION_IS_VALID
             (((GaimUrlSession *) session)-&gt;account-&gt;gc)) {
@@ -733,15 +597,7 @@
 
             session-&gt;hasFormData = TRUE;
             gaim_session_fetch(url, FALSE, NULL, FALSE,
-                               gaym_weblogin_step3, session, session);
-
-            /* char *url = &quot;<A HREF="http://www.gay.com/index.html">http://www.gay.com/index.html</A>&quot;; char *buf =
-               g_strdup_printf(_(&quot;Signon: %s&quot;), ((GaimUrlSession *)
-               session)-&gt; account-&gt;username);
-               gaim_connection_update_progress(((GaimUrlSession *)
-               session)-&gt; account-&gt;gc, buf, 2, 6); session-&gt;hasFormData =
-               FALSE; gaim_session_fetch(url, FALSE, NULL, FALSE,
-               gaym_weblogin_step3, session, session); */
+                               gaym_weblogin_step4, session, session);
         } else {
             gaim_debug_misc(&quot;gaym&quot;, &quot;cancelled before step1\n&quot;);
             gaim_debug_misc(&quot;gaym&quot;, &quot;gaym-&gt;sessoin: %x\n&quot;, session);

Modified: qrc/trunk/gaym-extras/bio-popups.c
===================================================================
--- qrc/trunk/gaym-extras/bio-popups.c	2005-07-27 07:47:36 UTC (rev 248)
+++ qrc/trunk/gaym-extras/bio-popups.c	2005-07-28 14:31:20 UTC (rev 249)
@@ -19,12 +19,13 @@
 
 }
 
-static void namelist_leave_cb(GtkWidget * tv, GdkEventCrossing * e, gpointer n)
+static void namelist_leave_cb(GtkWidget * tv, GdkEventCrossing * e,
+                              gpointer n)
 {
-    //This prevent clicks from demloishing popups.
-    if(e-&gt;mode != GDK_CROSSING_NORMAL)
-	return;
-    
+    // This prevent clicks from demloishing popups.
+    if (e-&gt;mode != GDK_CROSSING_NORMAL)
+        return;
+
     guint *timeout = g_hash_table_lookup(popup_timeouts, tv);
     g_hash_table_remove(popups, tv);
 
@@ -34,20 +35,21 @@
     }
 }
 
-static void namelist_paint_tip(GtkWidget * tipwindow, GdkEventExpose * event, gpointer data)
+static void namelist_paint_tip(GtkWidget * tipwindow,
+                               GdkEventExpose * event, gpointer data)
 {
-    char* tooltiptext=((struct paint_data*)data)-&gt;tooltiptext;
-    const char* name=((struct paint_data*)data)-&gt;name;
+    char *tooltiptext = ((struct paint_data *) data)-&gt;tooltiptext;
+    const char *name = ((struct paint_data *) data)-&gt;name;
     GtkStyle *style;
-    char* filename=g_strdup_printf(&quot;%s.jpg&quot;,name);
-    char* path = g_build_filename(gaim_user_dir(), &quot;icons&quot;, &quot;gaym&quot;, filename, NULL);
-    gaim_debug_misc(&quot;popups&quot;,&quot;trying to load image %s\n&quot;,path);
-    GError* err=NULL;
-    GdkPixbuf* pixbuf = gdk_pixbuf_new_from_file(path, &amp;err);	
-    if(err)
-    {
-	gaim_debug_error(&quot;popups&quot;,&quot;Pixbuf error: %s\n&quot;,err-&gt;message);
-	g_error_free(err);
+    char *filename = g_strdup_printf(&quot;%s.jpg&quot;, name);
+    char *path =
+        g_build_filename(gaim_user_dir(), &quot;icons&quot;, &quot;gaym&quot;, filename, NULL);
+    gaim_debug_misc(&quot;popups&quot;, &quot;trying to load image %s\n&quot;, path);
+    GError *err = NULL;
+    GdkPixbuf *pixbuf = gdk_pixbuf_new_from_file(path, &amp;err);
+    if (err) {
+        gaim_debug_error(&quot;popups&quot;, &quot;Pixbuf error: %s\n&quot;, err-&gt;message);
+        g_error_free(err);
     }
     g_free(filename);
     g_free(path);
@@ -66,18 +68,19 @@
                        -1, -1);
 
 #if GTK_CHECK_VERSION(2,2,0)
-     gdk_draw_pixbuf(GDK_DRAWABLE(tipwindow-&gt;window), NULL, pixbuf,
-     0, 0, 4, 4, -1, -1, GDK_RGB_DITHER_NONE, 0, 0);
+    gdk_draw_pixbuf(GDK_DRAWABLE(tipwindow-&gt;window), NULL, pixbuf,
+                    0, 0, 4, 4, -1, -1, GDK_RGB_DITHER_NONE, 0, 0);
 #else
-     gdk_pixbuf_render_to_drawable(pixbuf,
-     GDK_DRAWABLE(tipwindow-&gt;window), NULL, 0, 0, 4, 4, -1, -1,
-     GDK_RGB_DITHER_NONE, 0, 0);
+    gdk_pixbuf_render_to_drawable(pixbuf,
+                                  GDK_DRAWABLE(tipwindow-&gt;window), NULL, 0,
+                                  0, 4, 4, -1, -1, GDK_RGB_DITHER_NONE, 0,
+                                  0);
 #endif
 
     gtk_paint_layout(style, tipwindow-&gt;window, GTK_STATE_NORMAL, TRUE,
-                     NULL, tipwindow, &quot;tooltip&quot;, 57, 4, layout);
+                     NULL, tipwindow, &quot;tooltip&quot;, 65, 4, layout);
 
-    g_object_unref (pixbuf);
+    g_object_unref(pixbuf);
     g_object_unref(layout);
     g_free(tooltiptext);
     g_free(data);
@@ -100,12 +103,14 @@
     guint *timeout;
     GtkWidget *tipwindow;
     GtkWidget *tv = data-&gt;tv;
-    
+
     GaymTooltipType type = data-&gt;type;
     struct gaym_conn *gaym = data-&gt;gaym;
     g_free(data);
     GaimPluginProtocolInfo *prpl_info =
-        GAIM_PLUGIN_PROTOCOL_INFO(gaim_find_prpl (gaim_account_get_protocol_id (gaym-&gt;account)));
+        GAIM_PLUGIN_PROTOCOL_INFO(gaim_find_prpl
+                                  (gaim_account_get_protocol_id
+                                   (gaym-&gt;account)));
 
     timeout = (guint *) g_hash_table_lookup(popup_timeouts, tv);
     /* we check to see if we're still supposed to be moving, now that gtk
@@ -158,8 +163,7 @@
     g_return_val_if_fail(tooltiptext != NULL, FALSE);
 
     tipwindow = g_hash_table_lookup(popups, tv);
-    if (tipwindow)
-    {
+    if (tipwindow) {
         g_hash_table_remove(popups, tv);
     }
     tipwindow = gtk_window_new(GTK_WINDOW_POPUP);
@@ -168,10 +172,10 @@
     gtk_widget_set_app_paintable(tipwindow, TRUE);
     gtk_window_set_resizable(GTK_WINDOW(tipwindow), FALSE);
     gtk_widget_set_name(tipwindow, &quot;gtk-tooltips&quot;);
-    
-    struct paint_data* pdata=g_new0(struct paint_data,1);
-    pdata-&gt;tooltiptext=tooltiptext;
-    pdata-&gt;name=name;
+
+    struct paint_data *pdata = g_new0(struct paint_data, 1);
+    pdata-&gt;tooltiptext = tooltiptext;
+    pdata-&gt;name = name;
     g_signal_connect(G_OBJECT(tipwindow), &quot;expose_event&quot;,
                      G_CALLBACK(namelist_paint_tip), pdata);
     gtk_widget_ensure_style(tipwindow);
@@ -203,8 +207,8 @@
 
     /* 57 is the size of a large status icon plus 4 pixels padding on each 
        side.  I should #define this or something */
-    w = w + 57;
-    h = MAX(h, 57);
+    w = w + 65;
+    h = MAX(h, 65);
 
 #if GTK_CHECK_VERSION(2,2,0)
     if (w &gt; mon_size.width)
@@ -248,7 +252,8 @@
 }
 
 
-static gboolean namelist_motion_cb(GtkWidget * tv, GdkEventMotion * event, gpointer gaym)
+static gboolean namelist_motion_cb(GtkWidget * tv, GdkEventMotion * event,
+                                   gpointer gaym)
 {
     GtkTreeModel *ls = NULL;
     GtkTreePath *path = NULL;
@@ -275,15 +280,15 @@
             return FALSE;
         /* We've left the cell.  Remove the timeout and create a new one
            below */
-	
+
         g_hash_table_remove(popups, tv);
         g_source_remove(*timeout);
     }
 
     gtk_tree_view_get_path_at_pos(GTK_TREE_VIEW(tv), event-&gt;x, event-&gt;y,
                                   &amp;path, NULL, NULL, NULL);
-    if(G_UNLIKELY(path == NULL))
-	return FALSE;
+    if (G_UNLIKELY(path == NULL))
+        return FALSE;
     struct timeout_cb_data *timeout_data =
         g_new0(struct timeout_cb_data, 1);
     timeout_data-&gt;tv = tv;
@@ -302,11 +307,12 @@
     return TRUE;
 }
 
-static void tab_leave_cb(GtkWidget * event, GdkEventCrossing * e, gpointer n)
+static void tab_leave_cb(GtkWidget * event, GdkEventCrossing * e,
+                         gpointer n)
 {
-    //Prevent clicks from demolishing popup.
-    if(e-&gt;mode != GDK_CROSSING_NORMAL)
-	return;
+    // Prevent clicks from demolishing popup.
+    if (e-&gt;mode != GDK_CROSSING_NORMAL)
+        return;
     GtkWidget *tab = gtk_bin_get_child(GTK_BIN(event));
     guint *timeout = g_hash_table_lookup(popup_timeouts, tab);
     g_hash_table_remove(popups, tab);
@@ -319,7 +325,8 @@
 }
 
 
-static gboolean tab_entry_cb(GtkWidget * event, GdkEventCrossing * crossing, gpointer conv)
+static gboolean tab_entry_cb(GtkWidget * event,
+                             GdkEventCrossing * crossing, gpointer conv)
 {
 
     guint *timeout;
@@ -354,15 +361,15 @@
     return TRUE;
 }
 
-void add_chat_popup_stuff(GaimConversation* c) {
-    
+void add_chat_popup_stuff(GaimConversation * c)
+{
+
     GaimGtkConversation *gtkconv = GAIM_GTK_CONVERSATION(c);
     GaimGtkChatPane *gtkchat = gtkconv-&gt;u.chat;
     GaimConnection *gc = gaim_conversation_get_gc(c);
-    
+
     g_signal_connect(G_OBJECT(gtkchat-&gt;list), &quot;motion-notify-event&quot;,
-                     G_CALLBACK(namelist_motion_cb),
-                     gc-&gt;proto_data);
+                     G_CALLBACK(namelist_motion_cb), gc-&gt;proto_data);
     g_signal_connect(G_OBJECT(gtkchat-&gt;list), &quot;leave-notify-event&quot;,
                      G_CALLBACK(namelist_leave_cb), NULL);
 
@@ -373,28 +380,40 @@
 
 
 }
-void add_im_popup_stuff(GaimConversation* c) {
-	GaimGtkConversation *gtkconv = GAIM_GTK_CONVERSATION(c);
-        GtkWidget *event = gtk_event_box_new();
-        gtk_widget_ref(gtkconv-&gt;tab_label);
-        gtk_container_remove(GTK_CONTAINER(gtkconv-&gt;tabby), GTK_WIDGET(gtkconv-&gt;tab_label));
-        gtk_widget_add_events(event, GDK_ENTER_NOTIFY_MASK | GDK_LEAVE_NOTIFY_MASK);
-        g_signal_connect(G_OBJECT(event), &quot;enter-notify-event&quot;, G_CALLBACK(tab_entry_cb), c);
-        g_signal_connect(G_OBJECT(event), &quot;leave-notify-event&quot;, G_CALLBACK(tab_leave_cb), c);
-        gtk_box_pack_start(GTK_BOX(gtkconv-&gt;tabby), GTK_WIDGET(event), TRUE, TRUE, 0);
-        gtk_widget_show(GTK_WIDGET(event));
-        gtk_container_add(GTK_CONTAINER(event), GTK_WIDGET(gtkconv-&gt;tab_label));
-        gtk_widget_unref(gtkconv-&gt;tab_label);
-        gtk_widget_show(GTK_WIDGET(gtkconv-&gt;tab_label));
-        g_hash_table_insert(popup_timeouts, gtkconv-&gt;tab_label, g_new0(guint, 1));
+
+void add_im_popup_stuff(GaimConversation * c)
+{
+    GaimGtkConversation *gtkconv = GAIM_GTK_CONVERSATION(c);
+    GtkWidget *event = gtk_event_box_new();
+    gtk_widget_ref(gtkconv-&gt;tab_label);
+    gtk_container_remove(GTK_CONTAINER(gtkconv-&gt;tabby),
+                         GTK_WIDGET(gtkconv-&gt;tab_label));
+    gtk_widget_add_events(event,
+                          GDK_ENTER_NOTIFY_MASK | GDK_LEAVE_NOTIFY_MASK);
+    g_signal_connect(G_OBJECT(event), &quot;enter-notify-event&quot;,
+                     G_CALLBACK(tab_entry_cb), c);
+    g_signal_connect(G_OBJECT(event), &quot;leave-notify-event&quot;,
+                     G_CALLBACK(tab_leave_cb), c);
+    gtk_box_pack_start(GTK_BOX(gtkconv-&gt;tabby), GTK_WIDGET(event), TRUE,
+                       TRUE, 0);
+    gtk_widget_show(GTK_WIDGET(event));
+    gtk_container_add(GTK_CONTAINER(event),
+                      GTK_WIDGET(gtkconv-&gt;tab_label));
+    gtk_widget_unref(gtkconv-&gt;tab_label);
+    gtk_widget_show(GTK_WIDGET(gtkconv-&gt;tab_label));
+    g_hash_table_insert(popup_timeouts, gtkconv-&gt;tab_label,
+                        g_new0(guint, 1));
 }
 
-void init_popups(){
-    popup_rects = g_hash_table_new_full(g_direct_hash, g_direct_equal, NULL, g_free);
+void init_popups()
+{
+    popup_rects =
+        g_hash_table_new_full(g_direct_hash, g_direct_equal, NULL, g_free);
 
-    popup_timeouts = g_hash_table_new_full(g_direct_hash, g_direct_equal, NULL, g_free);
+    popup_timeouts =
+        g_hash_table_new_full(g_direct_hash, g_direct_equal, NULL, g_free);
 
-    popups = g_hash_table_new_full(g_direct_hash, g_direct_equal, NULL, (GDestroyNotify) gtk_widget_destroy);
+    popups =
+        g_hash_table_new_full(g_direct_hash, g_direct_equal, NULL,
+                              (GDestroyNotify) gtk_widget_destroy);
 }
-
-

Modified: qrc/trunk/gaym-extras/chaticon.c
===================================================================
--- qrc/trunk/gaym-extras/chaticon.c	2005-07-27 07:47:36 UTC (rev 248)
+++ qrc/trunk/gaym-extras/chaticon.c	2005-07-28 14:31:20 UTC (rev 249)
@@ -153,7 +153,8 @@
 
     icon_data-&gt;event = gtk_event_box_new();
     gtk_container_add(GTK_CONTAINER(icon_data-&gt;frame), icon_data-&gt;event);
-    gtk_widget_set_size_request(GTK_WIDGET(icon_data-&gt;frame), scale_width, scale_height);
+    gtk_widget_set_size_request(GTK_WIDGET(icon_data-&gt;frame), scale_width,
+                                scale_height);
 
     // g_signal_connect(G_OBJECT(icon_data-&gt;event), &quot;button-press-event&quot;,
     // G_CALLBACK(icon_menu), conv);
@@ -182,7 +183,8 @@
 
     struct fetch_thumbnail_data *d = (struct fetch_thumbnail_data *) data;
 
-    gaim_debug_misc(&quot;chaticon&quot;,&quot;Check for update: %x %s %s %i\n&quot;,c,name,d-&gt;who, d-&gt;pic_data_len);
+    gaim_debug_misc(&quot;chaticon&quot;, &quot;Check for update: %x %s %s %i\n&quot;, c, name,
+                    d-&gt;who, d-&gt;pic_data_len);
     g_return_val_if_fail(name_needing_update != NULL, FALSE);
 
     if (!strcmp(d-&gt;who, name_needing_update)) {
@@ -201,32 +203,31 @@
         return;
     }
     if (len &amp;&amp; !g_strrstr_len(pic_data, len, &quot;Server Error&quot;)) {
-	char* dir;	
-	if ((!d-&gt;from_file) &amp;&amp; (dir = g_build_filename(gaim_user_dir(), &quot;icons&quot;, &quot;gaym&quot;, NULL) != NULL)) {
-	    d-&gt;pic_data = pic_data;
-	    d-&gt;pic_data_len = len;
-	    gaim_build_dir(dir, S_IRUSR | S_IWUSR | S_IXUSR);
-	    char* filename = g_strdup_printf(&quot;%s.jpg&quot;,d-&gt;who);
-	    char* path = g_build_filename(dir, filename, NULL);
-	    FILE* file;
-	    if ((file = g_fopen(path, &quot;wb&quot;)))
-	    {
-		fwrite(pic_data, 1, len, file);
-	        fclose(file);
-	    }
-	    else
-	    {
-		gaim_debug_misc(&quot;chaticon&quot;,&quot;Couldn't write file\n&quot;);
-	    }
-	    g_free(filename);
-	    g_free(path);
-	    g_free(dir);
-	}
+        char *dir;
+        if ((dir =
+             g_build_filename(gaim_user_dir(), &quot;icons&quot;, &quot;gaym&quot;,
+                              NULL)) != NULL) {
+            d-&gt;pic_data = pic_data;
+            d-&gt;pic_data_len = len;
+            gaim_build_dir(dir, S_IRUSR | S_IWUSR | S_IXUSR);
+            char *filename = g_strdup_printf(&quot;%s.jpg&quot;, d-&gt;who);
+            char *path = g_build_filename(dir, filename, NULL);
+            FILE *file;
+            if ((file = g_fopen(path, &quot;wb&quot;))) {
+                fwrite(pic_data, 1, len, file);
+                fclose(file);
+            } else {
+                gaim_debug_misc(&quot;chaticon&quot;, &quot;Couldn't write file\n&quot;);
+            }
+            g_free(filename);
+            g_free(path);
+            g_free(dir);
+        }
     } else {
         d-&gt;pic_data = 0;
         d-&gt;pic_data_len = 0;
     }
-     
+
     g_hash_table_foreach_remove(pending_updates,
                                 (GHRFunc) check_for_update, d);
     g_free(d);
@@ -257,44 +258,44 @@
     if (icon_data-&gt;event != NULL)
         gtk_widget_destroy(icon_data-&gt;event);
     icon_data-&gt;event = NULL;
-    
-    
-    char* dir = g_build_filename(gaim_user_dir(), &quot;icons&quot;, &quot;gaym&quot;, NULL);
-    char* filename = g_strdup_printf(&quot;%s.jpg&quot;,name);
-    char* path=NULL;
-    FILE* file;
+
+
+    char *dir = g_build_filename(gaim_user_dir(), &quot;icons&quot;, &quot;gaym&quot;, NULL);
+    char *filename = g_strdup_printf(&quot;%s.jpg&quot;, name);
+    char *path = NULL;
+    FILE *file;
     struct stat st;
-    struct fetch_thumbnail_data *data=g_new0(struct fetch_thumbnail_data,1);
-    
-    if ((dir != NULL) &amp;&amp; (filename != NULL) &amp;&amp; (path = g_build_filename(dir, filename, NULL)));
-    {
-	if (!g_stat(path, &amp;st) &amp;&amp; (file = g_fopen(path, &quot;rb&quot;)))
-	{
-	    data-&gt;pic_data = g_malloc(st.st_size);
-	    data-&gt;who=name;
-	    data-&gt;pic_data_len = st.st_size;
-	    data-&gt;from_file = TRUE;
-	    fread(data-&gt;pic_data, 1, st.st_size, file);
-	    fclose(file);
-	}
-	g_free(dir);
-	g_free(filename);
-	g_free(path);
-	g_hash_table_replace(pending_updates, c, name);
-	fetch_thumbnail_cb(data, data-&gt;pic_data, data-&gt;pic_data_len);
-	return;
+    struct fetch_thumbnail_data *data =
+        g_new0(struct fetch_thumbnail_data, 1);
+    path = g_build_filename(dir, filename, NULL);
+    if (path &amp;&amp; !g_stat(path, &amp;st)) {
+        if (file = g_fopen(path, &quot;rb&quot;)) {
+            data-&gt;pic_data = g_malloc(st.st_size);
+            data-&gt;who = name;
+            data-&gt;pic_data_len = st.st_size;
+            data-&gt;from_file = TRUE;
+            fread(data-&gt;pic_data, 1, st.st_size, file);
+            fclose(file);
+        }
+        g_free(dir);
+        g_free(filename);
+        g_free(path);
+
+        gaym_gtkconv_update_thumbnail(c, data);
+        fetch_thumbnail_cb(data, data-&gt;pic_data, data-&gt;pic_data_len);
+        return;
     }
     // Get GaymBuddy struct for the thumbnail URL.
     cm = g_hash_table_lookup(gaym-&gt;channel_members, name);
-    if(!cm)
-	return;
+    if (!cm)
+        return;
 
-    
+
     // Fetch thumbnail.
 
     char *hashurl = g_hash_table_lookup(gaym-&gt;confighash,
                                         &quot;mini-profile-panel.thumbnail-prefix&quot;);
-   
+
     data = g_new0(struct fetch_thumbnail_data, 1);
     data-&gt;who = name;
     data-&gt;from_file = FALSE;
@@ -306,10 +307,12 @@
     g_hash_table_replace(pending_updates, c, name);
 
 }
-void add_chat_icon_stuff(GaimConversation *c) {
-    
+
+void add_chat_icon_stuff(GaimConversation * c)
+{
+
     GtkTreeModel *ls;
-    
+
     GaimGtkConversation *gtkconv = GAIM_GTK_CONVERSATION(c);
     GaimGtkChatPane *gtkchat = gtkconv-&gt;u.chat;
     GaimPluginProtocolInfo *prpl_info = NULL;
@@ -320,7 +323,7 @@
         prpl_info = GAIM_PLUGIN_PROTOCOL_INFO(account-&gt;gc-&gt;prpl);
     GtkTreeSelection *select =
         gtk_tree_view_get_selection(GTK_TREE_VIEW(gtkchat-&gt;list));
-    
+
     gtk_tree_selection_set_mode(select, GTK_SELECTION_SINGLE);
 
     ls = gtk_tree_view_get_model(GTK_TREE_VIEW(gtkchat-&gt;list));
@@ -337,7 +340,7 @@
     icon_data-&gt;iter = NULL;
     icon_data-&gt;show_icon = TRUE;
     icon_data-&gt;icon_container = gtk_vbox_new(FALSE, 0);
-    
+
     gtk_widget_set_size_request(GTK_WIDGET(icon_data-&gt;icon_container),
                                 prpl_info-&gt;icon_spec.max_width,
                                 prpl_info-&gt;icon_spec.max_height);
@@ -352,7 +355,7 @@
     gtk_widget_show(icon_data-&gt;frame);
     gtk_box_pack_end(GTK_BOX(icon_data-&gt;icon_container_parent),
                      icon_data-&gt;icon_container, FALSE, FALSE, 0);
-    
+
     icon_data-&gt;event = gtk_event_box_new();
     gtk_container_add(GTK_CONTAINER(icon_data-&gt;frame), icon_data-&gt;event);
 
@@ -364,8 +367,10 @@
 
 
 }
-void init_chat_icons() {
 
+void init_chat_icons()
+{
+
     icons = g_hash_table_new(g_direct_hash, g_direct_equal);
     pending_updates = g_hash_table_new(g_direct_hash, g_direct_equal);
 }

Modified: qrc/trunk/gaym-extras/chatsort.c
===================================================================
--- qrc/trunk/gaym-extras/chatsort.c	2005-07-27 07:47:36 UTC (rev 248)
+++ qrc/trunk/gaym-extras/chatsort.c	2005-07-28 14:31:20 UTC (rev 249)
@@ -122,11 +122,12 @@
     }
 
 }
-void add_chat_sort_functions(GaimConversation* c) {
-     
+void add_chat_sort_functions(GaimConversation * c)
+{
+
     GaimGtkConversation *gtkconv = GAIM_GTK_CONVERSATION(c);
     GaimGtkChatPane *gtkchat = gtkconv-&gt;u.chat;
-    
+
     GtkBox *iconbox = (GtkBox *) gtkconv-&gt;info-&gt;parent;
     GtkWidget *button = gtk_button_new_with_label(&quot;E&quot;);
     gtk_button_set_relief(GTK_BUTTON(button), GTK_RELIEF_NONE);

Modified: qrc/trunk/gaym-extras/gaym-extras.c
===================================================================
--- qrc/trunk/gaym-extras/gaym-extras.c	2005-07-27 07:47:36 UTC (rev 248)
+++ qrc/trunk/gaym-extras/gaym-extras.c	2005-07-28 14:31:20 UTC (rev 249)
@@ -8,16 +8,17 @@
 
 
 
-//Adds motion handlers to IM tab labels.
+// Adds motion handlers to IM tab labels.
 static void redo_im_window(GaimConversation * c)
 {
-    if (c &amp;&amp; c-&gt;type == GAIM_CONV_IM) 
-	add_im_popup_stuff(c);
+    if (c &amp;&amp; c-&gt;type == GAIM_CONV_IM)
+        add_im_popup_stuff(c);
 }
 
 
-static void update_info_cb(GaimAccount* account, char* name) {
-    gaim_debug_misc(&quot;gaym-extras&quot;,&quot;info update\n&quot;);
+static void update_info_cb(GaimAccount * account, char *name)
+{
+    gaim_debug_misc(&quot;gaym-extras&quot;, &quot;info update\n&quot;);
 }
 
 static void redochatwindow(GaimConversation * c)
@@ -31,17 +32,17 @@
 {
     init_chat_icons();
     init_popups();
-    
+
     gaim_signal_connect(gaim_conversations_get_handle(), &quot;chat-joined&quot;,
                         plugin, GAIM_CALLBACK(redochatwindow), NULL);
-    
+
     gaim_signal_connect(gaim_conversations_get_handle(),
                         &quot;conversation-created&quot;, plugin,
                         GAIM_CALLBACK(redo_im_window), NULL);
-    
+
     gaim_signal_connect(gaim_accounts_get_handle(), &quot;info-updated&quot;, plugin,
                         GAIM_CALLBACK(update_info_cb), NULL);
-    
+
     gaim_signal_connect(gaim_conversations_get_handle(),
                         &quot;deleting-conversation&quot;, plugin,
                         GAIM_CALLBACK(clean_popup_stuff), NULL);

Modified: qrc/trunk/gaym-extras/roombrowse.c
===================================================================
--- qrc/trunk/gaym-extras/roombrowse.c	2005-07-27 07:47:36 UTC (rev 248)
+++ qrc/trunk/gaym-extras/roombrowse.c	2005-07-28 14:31:20 UTC (rev 249)
@@ -433,5 +433,3 @@
     gaim_debug_misc(&quot;roombrowse&quot;, &quot;Callback registered!\n&quot;);
     return TRUE;
 }
-
-


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000178.html">[Qrc-svn] r248 - in qrc/trunk: . gaym/src gaym-extras
</A></li>
	<LI>Next message: <A HREF="000180.html">[Qrc-svn] r250 - qrc/trunk/gaym/src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#179">[ date ]</a>
              <a href="thread.html#179">[ thread ]</a>
              <a href="subject.html#179">[ subject ]</a>
              <a href="author.html#179">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/qrc-svn">More information about the Qrc-svn
mailing list</a><br>
</body></html>
