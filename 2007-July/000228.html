<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Qrc-svn] r297 - in qrc/trunk: . gaym/src
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/qrc-svn/2007-July/index.html" >
   <LINK REL="made" HREF="mailto:qrc-svn%40lists.berlios.de?Subject=Re%3A%20%5BQrc-svn%5D%20r297%20-%20in%20qrc/trunk%3A%20.%20gaym/src&In-Reply-To=%3C200707140426.l6E4QC6g006398%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000225.html">
   <LINK REL="Next"  HREF="000226.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Qrc-svn] r297 - in qrc/trunk: . gaym/src</H1>
    <B>jblebrun at BerliOS</B> 
    <A HREF="mailto:qrc-svn%40lists.berlios.de?Subject=Re%3A%20%5BQrc-svn%5D%20r297%20-%20in%20qrc/trunk%3A%20.%20gaym/src&In-Reply-To=%3C200707140426.l6E4QC6g006398%40sheep.berlios.de%3E"
       TITLE="[Qrc-svn] r297 - in qrc/trunk: . gaym/src">jblebrun at mail.berlios.de
       </A><BR>
    <I>Sat Jul 14 06:26:19 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000225.html">[Qrc-svn] r296 - qrc/branches
</A></li>
        <LI>Next message: <A HREF="000226.html">[Qrc-svn] r298 - qrc/trunk/gaym/src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#228">[ date ]</a>
              <a href="thread.html#228">[ thread ]</a>
              <a href="subject.html#228">[ subject ]</a>
              <a href="author.html#228">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: jblebrun
Date: 2007-07-14 06:26:09 +0200 (Sat, 14 Jul 2007)
New Revision: 297

Modified:
   qrc/trunk/configure.ac
   qrc/trunk/gaym/src/Makefile.am
   qrc/trunk/gaym/src/botfilter.c
   qrc/trunk/gaym/src/botfilter.h
   qrc/trunk/gaym/src/cmds.c
   qrc/trunk/gaym/src/dcc_send.c
   qrc/trunk/gaym/src/gaym.c
   qrc/trunk/gaym/src/gaym.h
   qrc/trunk/gaym/src/gayminfo.c
   qrc/trunk/gaym/src/gayminfo.h
   qrc/trunk/gaym/src/gaympriv.c
   qrc/trunk/gaym/src/gaympriv.h
   qrc/trunk/gaym/src/helpers.c
   qrc/trunk/gaym/src/helpers.h
   qrc/trunk/gaym/src/msgs.c
   qrc/trunk/gaym/src/parse.c
   qrc/trunk/gaym/src/weblogin.c
Log:
Changes to work with pidgin 2.0.2
Also fixed crashing info problem



Modified: qrc/trunk/configure.ac
===================================================================
--- qrc/trunk/configure.ac	2007-07-13 19:53:50 UTC (rev 296)
+++ qrc/trunk/configure.ac	2007-07-14 04:26:09 UTC (rev 297)
@@ -11,8 +11,10 @@
 REQUIRED_PKG_CONFIG=&quot;0.15.0&quot;
 AC_SUBST(REQUIRED_PKG_CONFIG)
 
-REQUIRED_GAIM=&quot;gaim gaim &gt;= 2.0&quot;
-AC_SUBST(REQUIRED_GAIM)
+#REQUIRED_GAIM=&quot;gaim gaim &gt;= 2.0&quot;
+#AC_SUBST(REQUIRED_GAIM)
+REQUIRED_PURPLE=&quot;purple purple &gt;= 2.0&quot;
+AC_SUBST(REQUIRED_PURPLE)
 
 REQUIRED_GTK=&quot;gtk+-2.0&quot;
 AC_SUBST(REQUIRED_GTK)
@@ -38,7 +40,7 @@
 
 	
 AC_ARG_ENABLE([bot-challenger],
-	[AS_HELP_STRING(--enable-bot-challenger,build the bot-challenger plugin @&lt;:@default=yes@:&gt;@)],,
+	[AS_HELP_STRING(--enable-bot-challenger,build the bot-challenger plugin @&lt;:@default=no@:&gt;@)],,
 	[enable_bot_challenger=&quot;no&quot;])
 
 AC_ARG_ENABLE([gaym],
@@ -46,8 +48,8 @@
 	[enable_gaym=&quot;yes&quot;])
 
 AC_ARG_ENABLE([gaym-extras],
-	[AS_HELP_STRING(--enable-gaym-extras,build the gaym-extras plugin @&lt;:@default=yes@:&gt;@)],,
-	[enable_gaym_extras=&quot;yes&quot;])
+	[AS_HELP_STRING(--enable-gaym-extras,build the gaym-extras plugin @&lt;:@default=no@:&gt;@)],,
+	[enable_gaym_extras=&quot;no&quot;])
 
 AM_CONDITIONAL([COND_BOT_CHALLENGER], [test &quot;$enable_bot_challenger&quot; = &quot;no&quot;])
 AM_CONDITIONAL([COND_DISPLAY_OPTIONS], [test &quot;$enable_display_options&quot; = &quot;yes&quot;])
@@ -70,8 +72,8 @@
 fi
 
 # Checks for libraries.
-AC_ARG_WITH([gaim-prefix],
-	[AS_HELP_STRING(--with-gaim-prefix,specify the prefix where gaim is found)],
+AC_ARG_WITH([purple-prefix],
+	[AS_HELP_STRING(--with-purple-prefix,specify the prefix where Pidgin is found)],
 	PKG_CONFIG_PATH=$withval/lib/pkgconfig,[])
 export PKG_CONFIG_PATH
 
@@ -92,22 +94,22 @@
 		]
 	)
 fi
-PKG_CHECK_MODULES([GAIM], [$REQUIRED_GAIM],
+PKG_CHECK_MODULES([PURPLE], [$REQUIRED_PURPLE],
 	[
-	AC_SUBST(GAIM_CFLAGS)
-	AC_SUBST(GAIM_LIBS)
+	AC_SUBST(PURPLE_CFLAGS)
+	AC_SUBST(PURPLE_LIBS)
 	]
 )
-AC_ARG_VAR([GAIM_DATADIR], [datadir of GAIM, overriding pkg-config])dnl
-AC_ARG_VAR([GAIM_LIBDIR], [libdir of GAIM, overriding pkg-config])dnl
-AC_CACHE_CHECK([for GAIM][_DATADIR], [pkg_cv_][GAIM][_DATADIR],
-	[_PKG_CONFIG([GAIM][_DATADIR], [variable=datadir], [gaim])])
-AC_CACHE_CHECK([for GAIM][_LIBDIR], [pkg_cv_][GAIM][_LIBDIR],
-	[_PKG_CONFIG([GAIM][_LIBDIR], [variable=libdir], [gaim])])
-GAIM[]_DATADIR=$pkg_cv_[]GAIM[]_DATADIR
-GAIM[]_LIBDIR=$pkg_cv_[]GAIM[]_LIBDIR
-AC_SUBST(GAIM_DATADIR)
-AC_SUBST(GAIM_LIBDIR)
+AC_ARG_VAR([PURPLE_DATADIR], [datadir of PURPLE, overriding pkg-config])dnl
+AC_ARG_VAR([PURPLE_LIBDIR], [libdir of PURPLE, overriding pkg-config])dnl
+AC_CACHE_CHECK([for PURPLE][_DATADIR], [pkg_cv_][PURPLE][_DATADIR],
+	[_PKG_CONFIG([PURPLE][_DATADIR], [variable=datadir], [purple])])
+AC_CACHE_CHECK([for PURPLE][_LIBDIR], [pkg_cv_][PURPLE][_LIBDIR],
+	[_PKG_CONFIG([PURPLE][_LIBDIR], [variable=libdir], [purple])])
+PURPLE[]_DATADIR=$pkg_cv_[]PURPLE[]_DATADIR
+PURPLE[]_LIBDIR=$pkg_cv_[]PURPLE[]_LIBDIR
+AC_SUBST(PURPLE_DATADIR)
+AC_SUBST(PURPLE_LIBDIR)
 
 # Checks for header files.
 AC_HEADER_STDC
@@ -154,7 +156,9 @@
 echo Build gaym plugin................ : $enable_gaym
 echo Build gaym-extras plugin......... : $enable_gaym_extras
 echo
-echo Installation directory........... : $GAIM_LIBDIR/gaim
+echo Installation directory........... : $PURPLE_LIBDIR/purple-2
 echo
+echo CFLAGS: $CFLAGS
+echo PURPLE_CFLAGS: $PURPLE_CFLAGS
 echo configure complete, now type \'make\'
 echo

Modified: qrc/trunk/gaym/src/Makefile.am
===================================================================
--- qrc/trunk/gaym/src/Makefile.am	2007-07-13 19:53:50 UTC (rev 296)
+++ qrc/trunk/gaym/src/Makefile.am	2007-07-14 04:26:09 UTC (rev 297)
@@ -1,5 +1,5 @@
 pkgdir = \
-	$(GAIM_LIBDIR)/gaim
+	$(PURPLE_LIBDIR)/purple-2
 
 GAYMSOURCES = \
 	botfilter.c \
@@ -15,7 +15,8 @@
 	helpers.h \
 	msgs.c \
 	parse.c \
-	weblogin.c 
+	weblogin.c \
+	url_fetch.c
 
 AM_CFLAGS = \
 	$(st)
@@ -23,7 +24,7 @@
 libgaym_la_LDFLAGS = \
 	-module \
 	-avoid-version \
-	$(GAIM_LIBS)
+	$(PURPLE_LIBS)
 
 pkg_LTLIBRARIES = \
 	libgaym.la
@@ -33,6 +34,6 @@
 
 AM_CPPFLAGS = \
 	$(DEBUG_CFLAGS) \
-	$(GAIM_CFLAGS) \
+	$(PURPLE_CFLAGS) \
 	$(GLIB_CFLAGS) \
-	-DGAIM_PLUGINS
+	-DPURPLE_PLUGINS

Modified: qrc/trunk/gaym/src/botfilter.c
===================================================================
--- qrc/trunk/gaym/src/botfilter.c	2007-07-13 19:53:50 UTC (rev 296)
+++ qrc/trunk/gaym/src/botfilter.c	2007-07-14 04:26:09 UTC (rev 297)
@@ -45,7 +45,7 @@
     gboolean found = FALSE;
     for (search = filtered_bots; search; search = search-&gt;next) {
         FilteredBot *bot = search-&gt;data;
-        if (!gaim_utf8_strcasecmp(bot-&gt;username, nick)) {
+        if (!purple_utf8_strcasecmp(bot-&gt;username, nick)) {
             found = TRUE;
             break;
         }
@@ -67,7 +67,7 @@
     }
 }
 
-gboolean gaym_botfilter_check(GaimConnection * gc, const char *nick,
+gboolean gaym_botfilter_check(PurpleConnection * gc, const char *nick,
                               const char *text,
                               gboolean gaym_privacy_change)
 {
@@ -77,22 +77,22 @@
     gboolean permitted = TRUE;
     int i = 0;
 
-    if (!gaim_prefs_get_bool(&quot;/plugins/prpl/gaym/botfilter_enable&quot;)) {
+    if (!purple_prefs_get_bool(&quot;/plugins/prpl/gaym/botfilter_enable&quot;)) {
         permitted = TRUE;
         update_filtered_bots(nick, permitted);
         return permitted;
     }
 
     /* don't ignore self */
-    if (!gaim_utf8_strcasecmp(gc-&gt;account-&gt;username, nick)) {
+    if (!purple_utf8_strcasecmp(gc-&gt;account-&gt;username, nick)) {
         permitted = TRUE;
-        gaim_debug_info(&quot;gaym&quot;, &quot;declining to block/ignore self\n&quot;);
+        purple_debug_info(&quot;gaym&quot;, &quot;declining to block/ignore self\n&quot;);
         update_filtered_bots(nick, permitted);
         return permitted;
     }
 
     /* don't ignore buddies */
-    if (gaim_find_buddy(gc-&gt;account, nick)) {
+    if (purple_find_buddy(gc-&gt;account, nick)) {
         permitted = TRUE;
         return permitted;
     }
@@ -100,15 +100,15 @@
     /* don't ignore permit list members */
     GSList *slist = NULL;
     for (slist = gc-&gt;account-&gt;permit; slist != NULL; slist = slist-&gt;next) {
-        if (!gaim_utf8_strcasecmp
-            (nick, gaim_normalize(gc-&gt;account, (char *) slist-&gt;data))) {
+        if (!purple_utf8_strcasecmp
+            (nick, purple_normalize(gc-&gt;account, (char *) slist-&gt;data))) {
             permitted = TRUE;
             return permitted;
         }
     }
 
     /**
-     * prevent gaim privacy changes from affecting previously
+     * prevent purple privacy changes from affecting previously
      * filtered bots
      */
     if (gaym_privacy_change) {
@@ -116,7 +116,7 @@
         GSList *search = NULL;
         for (search = filtered_bots; search; search = search-&gt;next) {
             FilteredBot *bot = search-&gt;data;
-            if (!gaim_utf8_strcasecmp(bot-&gt;username, nick)) {
+            if (!purple_utf8_strcasecmp(bot-&gt;username, nick)) {
                 permitted = FALSE;
                 break;
             }
@@ -125,7 +125,7 @@
     }
 
     if (!text) {
-        if (gaim_prefs_get_bool
+        if (purple_prefs_get_bool
             (&quot;/plugins/prpl/gaym/botfilter_ignore_null&quot;)) {
             permitted = FALSE;
         } else {
@@ -136,30 +136,30 @@
     }
 
     const char *sep =
-        gaim_prefs_get_string(&quot;/plugins/prpl/gaym/botfilter_sep&quot;);
+        purple_prefs_get_string(&quot;/plugins/prpl/gaym/botfilter_sep&quot;);
     const char *patterns =
-        gaim_prefs_get_string(&quot;/plugins/prpl/gaym/botfilter_patterns&quot;);
+        purple_prefs_get_string(&quot;/plugins/prpl/gaym/botfilter_patterns&quot;);
     const char *gayboi_patterns =
-        gaim_prefs_get_string(&quot;/plugins/prpl/gaym/botfilter_url_result&quot;);
+        purple_prefs_get_string(&quot;/plugins/prpl/gaym/botfilter_url_result&quot;);
 
-    if (!sep || !gaim_utf8_strcasecmp(sep, &quot;&quot;)
-        || ((!patterns || !gaim_utf8_strcasecmp(patterns, &quot;&quot;))
+    if (!sep || !purple_utf8_strcasecmp(sep, &quot;&quot;)
+        || ((!patterns || !purple_utf8_strcasecmp(patterns, &quot;&quot;))
             &amp;&amp; (!gayboi_patterns
-                || !gaim_utf8_strcasecmp(gayboi_patterns, &quot;&quot;)))) {
+                || !purple_utf8_strcasecmp(gayboi_patterns, &quot;&quot;)))) {
         permitted = TRUE;
         update_filtered_bots(nick, permitted);
         return permitted;
     }
 
     char *combined = NULL;
-    if (patterns &amp;&amp; gaim_utf8_strcasecmp(patterns, &quot;&quot;) &amp;&amp; gayboi_patterns
-        &amp;&amp; gaim_utf8_strcasecmp(gayboi_patterns, &quot;&quot;)) {
+    if (patterns &amp;&amp; purple_utf8_strcasecmp(patterns, &quot;&quot;) &amp;&amp; gayboi_patterns
+        &amp;&amp; purple_utf8_strcasecmp(gayboi_patterns, &quot;&quot;)) {
         combined = g_strdup_printf(&quot;%s|%s&quot;, patterns, gayboi_patterns);
     } else {
-        if (patterns &amp;&amp; gaim_utf8_strcasecmp(patterns, &quot;&quot;)) {
+        if (patterns &amp;&amp; purple_utf8_strcasecmp(patterns, &quot;&quot;)) {
             combined = g_strdup_printf(&quot;%s&quot;, patterns);
         } else if (gayboi_patterns
-                   &amp;&amp; gaim_utf8_strcasecmp(gayboi_patterns, &quot;&quot;)) {
+                   &amp;&amp; purple_utf8_strcasecmp(gayboi_patterns, &quot;&quot;)) {
             combined = g_strdup_printf(&quot;%s&quot;, gayboi_patterns);
         }
     }
@@ -181,47 +181,47 @@
     return permitted;
 }
 
-void process_spamlist_from_web_cb(GaimUtilFetchUrlData *url_data, void *data, const gchar *result,
+void process_spamlist_from_web_cb(PurpleUtilFetchUrlData *url_data, void *data, const gchar *result,
                                   gsize len, const gchar* error_message)
 {
     if (!result) {
-        gaim_prefs_set_string(&quot;/plugins/prpl/gaym/botfilter_url_result&quot;,
+        purple_prefs_set_string(&quot;/plugins/prpl/gaym/botfilter_url_result&quot;,
                               &quot;&quot;);
-        gaim_prefs_set_int(&quot;/plugins/prpl/gaym/botfilter_url_last_check&quot;,
+        purple_prefs_set_int(&quot;/plugins/prpl/gaym/botfilter_url_last_check&quot;,
                            0);
         return;
     }
     if (!g_str_has_prefix(result, &quot;&lt;HTML&gt;\n&quot;)) {
-        gaim_prefs_set_string(&quot;/plugins/prpl/gaym/botfilter_url_result&quot;,
+        purple_prefs_set_string(&quot;/plugins/prpl/gaym/botfilter_url_result&quot;,
                               &quot;&quot;);
-        gaim_prefs_set_int(&quot;/plugins/prpl/gaym/botfilter_url_last_check&quot;,
+        purple_prefs_set_int(&quot;/plugins/prpl/gaym/botfilter_url_last_check&quot;,
                            0);
         return;
     }
     if (!g_str_has_suffix(result, &quot;&lt;/HTML&gt;&quot;)) {
-        gaim_prefs_set_string(&quot;/plugins/prpl/gaym/botfilter_url_result&quot;,
+        purple_prefs_set_string(&quot;/plugins/prpl/gaym/botfilter_url_result&quot;,
                               &quot;&quot;);
-        gaim_prefs_set_int(&quot;/plugins/prpl/gaym/botfilter_url_last_check&quot;,
+        purple_prefs_set_int(&quot;/plugins/prpl/gaym/botfilter_url_last_check&quot;,
                            0);
         return;
     }
     const char *sep =
-        gaim_prefs_get_string(&quot;/plugins/prpl/gaym/botfilter_sep&quot;);
-    if (!sep || !gaim_utf8_strcasecmp(sep, &quot;&quot;)) {
-        gaim_prefs_set_string(&quot;/plugins/prpl/gaym/botfilter_url_result&quot;,
+        purple_prefs_get_string(&quot;/plugins/prpl/gaym/botfilter_sep&quot;);
+    if (!sep || !purple_utf8_strcasecmp(sep, &quot;&quot;)) {
+        purple_prefs_set_string(&quot;/plugins/prpl/gaym/botfilter_url_result&quot;,
                               &quot;&quot;);
-        gaim_prefs_set_int(&quot;/plugins/prpl/gaym/botfilter_url_last_check&quot;,
+        purple_prefs_set_int(&quot;/plugins/prpl/gaym/botfilter_url_last_check&quot;,
                            0);
         return;
     }
-    char *html_stripped = gaim_markup_strip_html(result);
+    char *html_stripped = purple_markup_strip_html(result);
     char *stripped = g_strstrip(html_stripped);
     char **split = g_strsplit(stripped, &quot;\n &quot;, 0);
     char *starsep = g_strdup_printf(&quot;*%s*&quot;, sep);
     char *joined = g_strjoinv(starsep, split);
     char *url_result = g_strdup_printf(&quot;*%s*&quot;, joined);
 
-    gaim_prefs_set_string(&quot;/plugins/prpl/gaym/botfilter_url_result&quot;,
+    purple_prefs_set_string(&quot;/plugins/prpl/gaym/botfilter_url_result&quot;,
                           url_result);
 
     g_free(url_result);
@@ -236,33 +236,33 @@
     char *user_agent = &quot;Mozilla/4.0&quot;;
 
     const char *url =
-        gaim_prefs_get_string(&quot;/plugins/prpl/gaym/botfilter_url&quot;);
-    if (!url || !gaim_utf8_strcasecmp(url, &quot;&quot;)) {
-        gaim_prefs_set_string(&quot;/plugins/prpl/gaym/botfilter_url_result&quot;,
+        purple_prefs_get_string(&quot;/plugins/prpl/gaym/botfilter_url&quot;);
+    if (!url || !purple_utf8_strcasecmp(url, &quot;&quot;)) {
+        purple_prefs_set_string(&quot;/plugins/prpl/gaym/botfilter_url_result&quot;,
                               &quot;&quot;);
-        gaim_prefs_set_int(&quot;/plugins/prpl/gaym/botfilter_url_last_check&quot;,
+        purple_prefs_set_int(&quot;/plugins/prpl/gaym/botfilter_url_last_check&quot;,
                            0);
         return;
     }
 
     int last_check =
-        gaim_prefs_get_int(&quot;/plugins/prpl/gaym/botfilter_url_last_check&quot;);
+        purple_prefs_get_int(&quot;/plugins/prpl/gaym/botfilter_url_last_check&quot;);
 
 
     if (!last_check || time(NULL) - last_check &gt; MIN_CHECK_INTERVAL) {
-        gaim_prefs_set_int(&quot;/plugins/prpl/gaym/botfilter_url_last_check&quot;,
+        purple_prefs_set_int(&quot;/plugins/prpl/gaym/botfilter_url_last_check&quot;,
                            time(NULL));
-        gaim_util_fetch_url(url, FALSE, user_agent, FALSE,
+        purple_util_fetch_url(url, FALSE, user_agent, FALSE,
                        process_spamlist_from_web_cb, NULL);
     }
 
     return;
 }
 
-void botfilter_url_changed_cb(const char *name, GaimPrefType type,
+void botfilter_url_changed_cb(const char *name, PurplePrefType type,
                               gconstpointer value, gpointer data)
 {
-    gaim_prefs_set_int(&quot;/plugins/prpl/gaym/botfilter_url_last_check&quot;, 0);
+    purple_prefs_set_int(&quot;/plugins/prpl/gaym/botfilter_url_last_check&quot;, 0);
 }
 
 /**

Modified: qrc/trunk/gaym/src/botfilter.h
===================================================================
--- qrc/trunk/gaym/src/botfilter.h	2007-07-13 19:53:50 UTC (rev 296)
+++ qrc/trunk/gaym/src/botfilter.h	2007-07-14 04:26:09 UTC (rev 297)
@@ -21,8 +21,8 @@
  * along with this program; if not, write to the Free Software
  * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
  */
-#ifndef _GAIM_GAYM_BOTFILTER_H_
-#define _GAIM_GAYM_BOTFILTER_H_
+#ifndef _PURPLE_GAYM_BOTFILTER_H_
+#define _PURPLE_GAYM_BOTFILTER_H_
 
 #include &quot;connection.h&quot;
 
@@ -38,7 +38,7 @@
  *
  * @return TRUE if the user is allowed, or @c FALSE otherwise.
  */
-gboolean gaym_botfilter_check(GaimConnection * gc, const char *nick,
+gboolean gaym_botfilter_check(PurpleConnection * gc, const char *nick,
                               const char *text,
                               gboolean gaym_privacy_change);
 
@@ -49,10 +49,10 @@
  */
 void get_spamlist_from_web(void);
 
-void botfilter_url_changed_cb(const char *name, GaimPrefType type,
+void botfilter_url_changed_cb(const char *name, PurplePrefType type,
                               gconstpointer value, gpointer data);
 
-#endif                          /* _GAIM_GAYM_BOTFILTER_H_ */
+#endif                          /* _PURPLE_GAYM_BOTFILTER_H_ */
 
 /**
  * vim:tabstop=4:shiftwidth=4:expandtab:

Modified: qrc/trunk/gaym/src/cmds.c
===================================================================
--- qrc/trunk/gaym/src/cmds.c	2007-07-13 19:53:50 UTC (rev 296)
+++ qrc/trunk/gaym/src/cmds.c	2007-07-14 04:26:09 UTC (rev 297)
@@ -1,7 +1,7 @@
 /**
  * @file cmds.c
  * 
- * gaim
+ * purple
  *
  * Copyright (C) 2003, Ethan Blanton &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/qrc-svn">eblanton at cs.purdue.edu</A>&gt;
  * 
@@ -36,8 +36,8 @@
 int gaym_cmd_default(struct gaym_conn *gaym, const char *cmd,
                      const char *target, const char **args)
 {
-    GaimConversation *convo =
-        gaim_find_conversation_with_account(GAIM_CONV_TYPE_ANY, target,
+    PurpleConversation *convo =
+        purple_find_conversation_with_account(PURPLE_CONV_TYPE_ANY, target,
                                             gaym-&gt;account);
     char *buf;
 
@@ -45,13 +45,13 @@
         return 1;
 
     buf = g_strdup_printf(_(&quot;Unknown command: %s&quot;), cmd);
-    if (gaim_conversation_get_type(convo) == GAIM_CONV_TYPE_IM)
-        gaim_conv_im_write(GAIM_CONV_IM(convo), &quot;&quot;, buf,
-                           GAIM_MESSAGE_SYSTEM | GAIM_MESSAGE_NO_LOG,
+    if (purple_conversation_get_type(convo) == PURPLE_CONV_TYPE_IM)
+        purple_conv_im_write(PURPLE_CONV_IM(convo), &quot;&quot;, buf,
+                           PURPLE_MESSAGE_SYSTEM | PURPLE_MESSAGE_NO_LOG,
                            time(NULL));
     else
-        gaim_conv_chat_write(GAIM_CONV_CHAT(convo), &quot;&quot;, buf,
-                             GAIM_MESSAGE_SYSTEM | GAIM_MESSAGE_NO_LOG,
+        purple_conv_chat_write(PURPLE_CONV_CHAT(convo), &quot;&quot;, buf,
+                             PURPLE_MESSAGE_SYSTEM | PURPLE_MESSAGE_NO_LOG,
                              time(NULL));
     g_free(buf);
 
@@ -83,10 +83,10 @@
 int gaym_cmd_ctcp_action(struct gaym_conn *gaym, const char *cmd,
                          const char *target, const char **args)
 {
-    GaimConnection *gc = gaim_account_get_connection(gaym-&gt;account);
+    PurpleConnection *gc = purple_account_get_connection(gaym-&gt;account);
     char *action, *dst, **newargs;
     const char *src;
-    GaimConversation *convo;
+    PurpleConversation *convo;
 
     if (!args || !args[0] || !gc)
         return 0;
@@ -121,20 +121,20 @@
     g_free(newargs);
 
     convo =
-        gaim_find_conversation_with_account(GAIM_CONV_TYPE_ANY, target,
+        purple_find_conversation_with_account(PURPLE_CONV_TYPE_ANY, target,
                                             gaym-&gt;account);
     if (convo) {
         action = g_strdup_printf(&quot;/me %s&quot;, args[0]);
         if (action[strlen(action) - 1] == '\n')
             action[strlen(action) - 1] = '\0';
-        if (gaim_conversation_get_type(convo) == GAIM_CONV_TYPE_CHAT)
+        if (purple_conversation_get_type(convo) == PURPLE_CONV_TYPE_CHAT)
             serv_got_chat_in(gc,
-                             gaim_conv_chat_get_id(GAIM_CONV_CHAT(convo)),
-                             gaim_connection_get_display_name(gc), 0,
+                             purple_conv_chat_get_id(PURPLE_CONV_CHAT(convo)),
+                             purple_connection_get_display_name(gc), 0,
                              action, time(NULL));
         else
-            gaim_conv_im_write(GAIM_CONV_IM(convo),
-                               gaim_connection_get_display_name(gc),
+            purple_conv_im_write(PURPLE_CONV_IM(convo),
+                               purple_connection_get_display_name(gc),
                                action, 0, time(NULL));
         g_free(action);
     }
@@ -193,13 +193,13 @@
                   const char *target, const char **args)
 {
     char *buf;
-    GaimConversation *convo;
+    PurpleConversation *convo;
 
     if (!args || !args[0])
         return 0;
 
     convo =
-        gaim_find_conversation_with_account(GAIM_CONV_TYPE_CHAT, target,
+        purple_find_conversation_with_account(PURPLE_CONV_TYPE_CHAT, target,
                                             gaym-&gt;account);
     if (!convo)
         return 0;
@@ -224,7 +224,7 @@
     } else {
         gaym-&gt;roomlist_filter = NULL;
     }
-    gaim_roomlist_show_with_account(gaym-&gt;account);
+    purple_roomlist_show_with_account(gaym-&gt;account);
 
     return 0;
 }
@@ -232,7 +232,7 @@
 int gaym_cmd_mode(struct gaym_conn *gaym, const char *cmd,
                   const char *target, const char **args)
 {
-    GaimConnection *gc;
+    PurpleConnection *gc;
     char *buf;
 
     if (!args)
@@ -250,10 +250,10 @@
     } else if (!strcmp(cmd, &quot;umode&quot;)) {
         if (!args[0])
             return 0;
-        gc = gaim_account_get_connection(gaym-&gt;account);
+        gc = purple_account_get_connection(gaym-&gt;account);
         buf =
             gaym_format(gaym, &quot;vnv&quot;, &quot;MODE&quot;,
-                        gaim_connection_get_display_name(gc), args[0]);
+                        purple_connection_get_display_name(gc), args[0]);
     } else {
         return 0;
     }
@@ -320,7 +320,7 @@
         sign = &quot;-&quot;;
         mode = &quot;v&quot;;
     } else {
-        gaim_debug(GAIM_DEBUG_ERROR, &quot;gaym&quot;, &quot;invalid 'op' command '%s'\n&quot;,
+        purple_debug(PURPLE_DEBUG_ERROR, &quot;gaym&quot;, &quot;invalid 'op' command '%s'\n&quot;,
                    cmd);
         return 0;
     }
@@ -405,7 +405,7 @@
     } else {
         nick = g_strdup(args[0]);
     }
-    gchar* unescaped=gaim_unescape_html(args[1]);
+    gchar* unescaped=purple_unescape_html(args[1]);
     cur = unescaped;
     end = unescaped;
     while (*end &amp;&amp; *cur) {
@@ -415,7 +415,7 @@
         msg = g_strndup(cur, end - cur);
 
         buf = gaym_format(gaym, &quot;vt:&quot;, &quot;PRIVMSG&quot;, nick, msg);
-	gaim_debug_misc(&quot;gaym_cmd_privmsg&quot;,buf);
+	purple_debug_misc(&quot;gaym_cmd_privmsg&quot;,buf);
         gaym_send(gaym, buf);
         g_free(msg);
         g_free(buf);
@@ -463,21 +463,21 @@
 int gaym_cmd_query(struct gaym_conn *gaym, const char *cmd,
                    const char *target, const char **args)
 {
-    GaimConversation *convo;
-    GaimConnection *gc;
+    PurpleConversation *convo;
+    PurpleConnection *gc;
 
     if (!args || !args[0])
         return 0;
 
     convo =
-        gaim_conversation_new(GAIM_CONV_TYPE_IM, gaym-&gt;account, args[0]);
+        purple_conversation_new(PURPLE_CONV_TYPE_IM, gaym-&gt;account, args[0]);
 
     if (args[1]) {
-        gc = gaim_account_get_connection(gaym-&gt;account);
+        gc = purple_account_get_connection(gaym-&gt;account);
         gaym_cmd_privmsg(gaym, cmd, target, args);
-        gaim_conv_im_write(GAIM_CONV_IM(convo),
-                           gaim_connection_get_display_name(gc), args[1],
-                           GAIM_MESSAGE_SEND, time(NULL));
+        purple_conv_im_write(PURPLE_CONV_IM(convo),
+                           purple_connection_get_display_name(gc), args[1],
+                           PURPLE_MESSAGE_SEND, time(NULL));
     }
 
     return 0;
@@ -510,31 +510,31 @@
 {
     char *buf;
     const char *topic;
-    GaimConversation *convo;
+    PurpleConversation *convo;
 
     if (!args)
         return 0;
 
     convo =
-        gaim_find_conversation_with_account(GAIM_CONV_TYPE_CHAT, target,
+        purple_find_conversation_with_account(PURPLE_CONV_TYPE_CHAT, target,
                                             gaym-&gt;account);
     if (!convo)
         return 0;
 
     if (!args[0]) {
-        topic = gaim_conv_chat_get_topic(GAIM_CONV_CHAT(convo));
+        topic = purple_conv_chat_get_topic(PURPLE_CONV_CHAT(convo));
 
         if (topic) {
             char *tmp, *tmp2;
             tmp = g_markup_escape_text(topic, -1);
-            tmp2 = gaim_markup_linkify(tmp);
+            tmp2 = purple_markup_linkify(tmp);
             buf = g_strdup_printf(_(&quot;current topic is: %s&quot;), tmp2);
             g_free(tmp);
             g_free(tmp2);
         } else
             buf = g_strdup(_(&quot;No topic is set&quot;));
-        gaim_conv_chat_write(GAIM_CONV_CHAT(convo), target, buf,
-                             GAIM_MESSAGE_SYSTEM | GAIM_MESSAGE_NO_LOG,
+        purple_conv_chat_write(PURPLE_CONV_CHAT(convo), target, buf,
+                             PURPLE_MESSAGE_SYSTEM | PURPLE_MESSAGE_NO_LOG,
                              time(NULL));
         g_free(buf);
 
@@ -592,7 +592,7 @@
         return 0;
 
     buf = gaym_format(gaym, &quot;vn&quot;, &quot;WHO&quot;, args[0]);
-    gaim_debug_misc(&quot;cmds&quot;, &quot;Exceuting %s\n&quot;, buf);
+    purple_debug_misc(&quot;cmds&quot;, &quot;Exceuting %s\n&quot;, buf);
     gaym_send(gaym, buf);
     g_free(buf);
     return 0;

Modified: qrc/trunk/gaym/src/dcc_send.c
===================================================================
--- qrc/trunk/gaym/src/dcc_send.c	2007-07-13 19:53:50 UTC (rev 296)
+++ qrc/trunk/gaym/src/dcc_send.c	2007-07-14 04:26:09 UTC (rev 297)
@@ -1,10 +1,10 @@
 /**
  * @file dcc_send.c Functions used in sending files with DCC SEND
  *
- * gaim
+ * purple
  *
  * Copyright (C) 2004, Timothy T Ringenbach &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/qrc-svn">omarvo at hotmail.com</A>&gt;
- * Copyright (C) 2003, Robbert Haarman &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/qrc-svn">gaim at inglorion.net</A>&gt;
+ * Copyright (C) 2003, Robbert Haarman &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/qrc-svn">purple at inglorion.net</A>&gt;
  *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License as published by
@@ -36,7 +36,7 @@
     gchar *ip;
 };
 
-static void gaym_dccsend_recv_destroy(GaimXfer * xfer)
+static void gaym_dccsend_recv_destroy(PurpleXfer * xfer)
 {
     struct gaym_xfer_rx_data *xd = xfer-&gt;data;
 
@@ -51,7 +51,7 @@
  * It sends the acknowledgement (in the form of a total byte count as an
  * unsigned 4 byte integer in network byte order)
  */
-static void gaym_dccsend_recv_ack(GaimXfer * xfer, const char *data,
+static void gaym_dccsend_recv_ack(PurpleXfer * xfer, const char *data,
                                   size_t size)
 {
     unsigned long l;
@@ -60,11 +60,11 @@
     write(xfer-&gt;fd, &amp;l, sizeof(l));
 }
 
-static void gaym_dccsend_recv_init(GaimXfer * xfer)
+static void gaym_dccsend_recv_init(PurpleXfer * xfer)
 {
     struct gaym_xfer_rx_data *xd = xfer-&gt;data;
 
-    gaim_xfer_start(xfer, -1, xd-&gt;ip, xfer-&gt;remote_port);
+    purple_xfer_start(xfer, -1, xd-&gt;ip, xfer-&gt;remote_port);
     g_free(xd-&gt;ip);
     xd-&gt;ip = NULL;
 }
@@ -73,7 +73,7 @@
 void gaym_dccsend_recv(struct gaym_conn *gaym, const char *from,
                        const char *msg)
 {
-    GaimXfer *xfer;
+    PurpleXfer *xfer;
     struct gaym_xfer_rx_data *xd;
     gchar **token;
     struct in_addr addr;
@@ -114,11 +114,11 @@
     }
     i++;
 
-    xfer = gaim_xfer_new(gaym-&gt;account, GAIM_XFER_RECEIVE, from);
+    xfer = purple_xfer_new(gaym-&gt;account, PURPLE_XFER_RECEIVE, from);
     xd = g_new0(struct gaym_xfer_rx_data, 1);
     xfer-&gt;data = xd;
 
-    gaim_xfer_set_filename(xfer, filename-&gt;str);
+    purple_xfer_set_filename(xfer, filename-&gt;str);
     xfer-&gt;remote_port = atoi(token[i + 1]);
 
     nip = strtoul(token[i], NULL, 10);
@@ -128,18 +128,18 @@
     } else {
         xd-&gt;ip = g_strdup(token[i]);
     }
-    gaim_debug(GAIM_DEBUG_INFO, &quot;gaym&quot;, &quot;Receiving file from %s\n&quot;,
+    purple_debug(PURPLE_DEBUG_INFO, &quot;gaym&quot;, &quot;Receiving file from %s\n&quot;,
                xd-&gt;ip);
-    gaim_xfer_set_size(xfer, token[i + 2] ? atoi(token[i + 2]) : 0);
+    purple_xfer_set_size(xfer, token[i + 2] ? atoi(token[i + 2]) : 0);
 
-    gaim_xfer_set_init_fnc(xfer, gaym_dccsend_recv_init);
-    gaim_xfer_set_ack_fnc(xfer, gaym_dccsend_recv_ack);
+    purple_xfer_set_init_fnc(xfer, gaym_dccsend_recv_init);
+    purple_xfer_set_ack_fnc(xfer, gaym_dccsend_recv_ack);
 
-    gaim_xfer_set_end_fnc(xfer, gaym_dccsend_recv_destroy);
-    gaim_xfer_set_request_denied_fnc(xfer, gaym_dccsend_recv_destroy);
-    gaim_xfer_set_cancel_send_fnc(xfer, gaym_dccsend_recv_destroy);
+    purple_xfer_set_end_fnc(xfer, gaym_dccsend_recv_destroy);
+    purple_xfer_set_request_denied_fnc(xfer, gaym_dccsend_recv_destroy);
+    purple_xfer_set_cancel_send_fnc(xfer, gaym_dccsend_recv_destroy);
 
-    gaim_xfer_request(xfer);
+    purple_xfer_request(xfer);
     g_strfreev(token);
     g_string_free(filename, TRUE);
 }
@@ -155,7 +155,7 @@
     guint rxlen;
 };
 
-static void gaym_dccsend_send_destroy(GaimXfer * xfer)
+static void gaym_dccsend_send_destroy(PurpleXfer * xfer)
 {
     struct gaym_xfer_send_data *xd = xfer-&gt;data;
 
@@ -163,7 +163,7 @@
         return;
 
     if (xd-&gt;inpa &gt; 0)
-        gaim_input_remove(xd-&gt;inpa);
+        purple_input_remove(xd-&gt;inpa);
     if (xd-&gt;fd != -1)
         close(xd-&gt;fd);
 
@@ -175,15 +175,15 @@
 
 /* just in case you were wondering, this is why DCC is gay */
 static void gaym_dccsend_send_read(gpointer data, int source,
-                                   GaimInputCondition cond)
+                                   PurpleInputCondition cond)
 {
-    GaimXfer *xfer = data;
+    PurpleXfer *xfer = data;
     struct gaym_xfer_send_data *xd = xfer-&gt;data;
     char *buffer[16];
     int len;
 
     if ((len = read(source, buffer, sizeof(buffer))) &lt;= 0) {
-        gaim_input_remove(xd-&gt;inpa);
+        purple_input_remove(xd-&gt;inpa);
         xd-&gt;inpa = 0;
         return;
     }
@@ -210,11 +210,11 @@
             xd-&gt;rxqueue = NULL;
         }
 
-        if (acked &gt;= gaim_xfer_get_size(xfer)) {
-            gaim_input_remove(xd-&gt;inpa);
+        if (acked &gt;= purple_xfer_get_size(xfer)) {
+            purple_input_remove(xd-&gt;inpa);
             xd-&gt;inpa = 0;
-            gaim_xfer_set_completed(xfer, TRUE);
-            gaim_xfer_end(xfer);
+            purple_xfer_set_completed(xfer, TRUE);
+            purple_xfer_end(xfer);
             return;
         }
 
@@ -223,11 +223,11 @@
 }
 
 ssize_t gaym_dccsend_send_write(const guchar * buffer, size_t size,
-                                GaimXfer * xfer)
+                                PurpleXfer * xfer)
 {
     ssize_t s;
 
-    s = MIN(gaim_xfer_get_bytes_remaining(xfer), size);
+    s = MIN(purple_xfer_get_bytes_remaining(xfer), size);
     if (!s)
         return 0;
 
@@ -235,9 +235,9 @@
 }
 
 static void gaym_dccsend_send_connected(gpointer data, int source,
-                                        GaimInputCondition cond)
+                                        PurpleInputCondition cond)
 {
-    GaimXfer *xfer = (GaimXfer *) data;
+    PurpleXfer *xfer = (PurpleXfer *) data;
     struct gaym_xfer_send_data *xd = xfer-&gt;data;
     int conn;
 
@@ -247,30 +247,30 @@
            the nonblocking nature of the listening socket, so we'll just
            try again next time */
         /* Let's print an error message anyway */
-        gaim_debug_warning(&quot;gaym&quot;, &quot;accept: %s\n&quot;, strerror(errno));
+        purple_debug_warning(&quot;gaym&quot;, &quot;accept: %s\n&quot;, strerror(errno));
         return;
     }
 
-    gaim_input_remove(xfer-&gt;watcher);
+    purple_input_remove(xfer-&gt;watcher);
     xfer-&gt;watcher = 0;
     close(xd-&gt;fd);
     xd-&gt;fd = -1;
 
     xd-&gt;inpa =
-        gaim_input_add(conn, GAIM_INPUT_READ, gaym_dccsend_send_read,
+        purple_input_add(conn, PURPLE_INPUT_READ, gaym_dccsend_send_read,
                        xfer);
     /* Start the transfer */
-    gaim_xfer_start(xfer, conn, NULL, 0);
+    purple_xfer_start(xfer, conn, NULL, 0);
 }
 
 /* 
  * This function is called after the user has selected a file to send.
  */
-static void gaym_dccsend_send_init(GaimXfer * xfer)
+static void gaym_dccsend_send_init(PurpleXfer * xfer)
 {
     struct gaym_xfer_send_data *xd = xfer-&gt;data;
-    GaimConnection *gc =
-        gaim_account_get_connection(gaim_xfer_get_account(xfer));
+    PurpleConnection *gc =
+        purple_account_get_connection(purple_xfer_get_account(xfer));
     struct gaym_conn *gaym = gc-&gt;proto_data;
     int sock;
     const char *arg[2];
@@ -281,26 +281,26 @@
     xfer-&gt;filename = g_path_get_basename(xfer-&gt;local_filename);
 
     /* Create a listening socket */
-    sock = gaim_network_listen_range(0, 0, SOCK_DGRAM, NULL, NULL);
+    sock = purple_network_listen_range(0, 0, SOCK_DGRAM, NULL, NULL);
 
     if (sock &lt; 0) {
-        gaim_notify_error(gc, NULL, _(&quot;File Transfer Aborted&quot;),
-                          _(&quot;Gaim could not open a listening port.&quot;));
-        gaim_xfer_cancel_local(xfer);
+        purple_notify_error(gc, NULL, _(&quot;File Transfer Aborted&quot;),
+                          _(&quot;Purple could not open a listening port.&quot;));
+        purple_xfer_cancel_local(xfer);
         return;
     }
 
     xd-&gt;fd = sock;
 
-    port = gaim_network_get_port_from_fd(sock);
-    gaim_debug_misc(&quot;gaym&quot;, &quot;port is %hu\n&quot;, port);
+    port = purple_network_get_port_from_fd(sock);
+    purple_debug_misc(&quot;gaym&quot;, &quot;port is %hu\n&quot;, port);
     /* Monitor the listening socket */
-    xfer-&gt;watcher = gaim_input_add(sock, GAIM_INPUT_READ,
+    xfer-&gt;watcher = purple_input_add(sock, PURPLE_INPUT_READ,
                                    gaym_dccsend_send_connected, xfer);
 
     /* Send the intended recipient the DCC request */
     arg[0] = xfer-&gt;who;
-    inet_aton(gaim_network_get_my_ip(gaym-&gt;fd), &amp;addr);
+    inet_aton(purple_network_get_my_ip(gaym-&gt;fd), &amp;addr);
     arg[1] = tmp = g_strdup_printf(&quot;\001DCC SEND \&quot;%s\&quot; %u %hu %zu\001&quot;,
                                    xfer-&gt;filename, ntohl(addr.s_addr),
                                    port, xfer-&gt;size);
@@ -310,19 +310,19 @@
 }
 
 /**
- * Gaim calls this function when the user selects Send File from the
+ * Purple calls this function when the user selects Send File from the
  * buddy menu
- * It sets up the GaimXfer struct and tells Gaim to go ahead
+ * It sets up the PurpleXfer struct and tells Purple to go ahead
  */
-void gaym_dccsend_send_file(GaimConnection * gc, const char *who,
+void gaym_dccsend_send_file(PurpleConnection * gc, const char *who,
                             const char *file)
 {
-    GaimXfer *xfer;
+    PurpleXfer *xfer;
     struct gaym_xfer_send_data *xd;
 
     /* Build the file transfer handle */
     xfer =
-        gaim_xfer_new(gaim_connection_get_account(gc), GAIM_XFER_SEND,
+        purple_xfer_new(purple_connection_get_account(gc), PURPLE_XFER_SEND,
                       who);
 
 
@@ -331,16 +331,16 @@
     xfer-&gt;data = xd;
 
     /* Setup our I/O op functions */
-    gaim_xfer_set_init_fnc(xfer, gaym_dccsend_send_init);
-    gaim_xfer_set_write_fnc(xfer, gaym_dccsend_send_write);
-    gaim_xfer_set_end_fnc(xfer, gaym_dccsend_send_destroy);
-    gaim_xfer_set_request_denied_fnc(xfer, gaym_dccsend_send_destroy);
-    gaim_xfer_set_cancel_send_fnc(xfer, gaym_dccsend_send_destroy);
+    purple_xfer_set_init_fnc(xfer, gaym_dccsend_send_init);
+    purple_xfer_set_write_fnc(xfer, gaym_dccsend_send_write);
+    purple_xfer_set_end_fnc(xfer, gaym_dccsend_send_destroy);
+    purple_xfer_set_request_denied_fnc(xfer, gaym_dccsend_send_destroy);
+    purple_xfer_set_cancel_send_fnc(xfer, gaym_dccsend_send_destroy);
     /* Now perform the request */
     if (file)
-        gaim_xfer_request_accepted(xfer, file);
+        purple_xfer_request_accepted(xfer, file);
     else
-        gaim_xfer_request(xfer);
+        purple_xfer_request(xfer);
 }
 
 /**

Modified: qrc/trunk/gaym/src/gaym.c
===================================================================
--- qrc/trunk/gaym/src/gaym.c	2007-07-13 19:53:50 UTC (rev 296)
+++ qrc/trunk/gaym/src/gaym.c	2007-07-14 04:26:09 UTC (rev 297)
@@ -1,9 +1,9 @@
 /**
  * @file gaym.c
  *
- * gaim
+ * purple
  *
- * Copyright (C) 2003, Robbert Haarman &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/qrc-svn">gaim at inglorion.net</A>&gt;
+ * Copyright (C) 2003, Robbert Haarman &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/qrc-svn">purple at inglorion.net</A>&gt;
  * Copyright (C) 2003, Ethan Blanton &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/qrc-svn">eblanton at cs.purdue.edu</A>&gt;
  * Copyright (C) 2000-2003, Rob Flynn &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/qrc-svn">rob at tgflinux.com</A>&gt;
  * Copyright (C) 1998-1999, Mark Spencer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/qrc-svn">markster at marko.net</A>&gt;
@@ -42,23 +42,20 @@
 #include &quot;botfilter.h&quot;
 #include &quot;gaym.h&quot;
 
-static const char *gaym_blist_icon(GaimAccount * a, GaimBuddy * b);
-static void gaym_blist_emblems(GaimBuddy * b, const char **se,
-                               const char **sw, const char **nw,
-                               const char **ne);
-static GList *gaym_status_types(GaimAccount * account);
-static GList *gaym_actions(GaimPlugin * plugin, gpointer context);
-/* static GList *gaym_chat_info(GaimConnection *gc); */
-static void gaym_login(GaimAccount * account);
+static const char *gaym_blist_icon(PurpleAccount * a, PurpleBuddy * b);
+static GList *gaym_status_types(PurpleAccount * account);
+static GList *gaym_actions(PurplePlugin * plugin, gpointer context);
+/* static GList *gaym_chat_info(PurpleConnection *gc); */
+static void gaym_login(PurpleAccount * account);
 static void gaym_login_cb(gpointer data, gint source, const gchar* error_message);
-static void gaym_close(GaimConnection * gc);
-static int gaym_im_send(GaimConnection * gc, const char *who,
-                        const char *what, GaimMessageFlags flags);
-static int gaym_chat_send(GaimConnection * gc, int id, const char *what,
-                          GaimMessageFlags flags);
-static void gaym_chat_join(GaimConnection * gc, GHashTable * data);
+static void gaym_close(PurpleConnection * gc);
+static int gaym_im_send(PurpleConnection * gc, const char *who,
+                        const char *what, PurpleMessageFlags flags);
+static int gaym_chat_send(PurpleConnection * gc, int id, const char *what,
+                          PurpleMessageFlags flags);
+static void gaym_chat_join(PurpleConnection * gc, GHashTable * data);
 static void gaym_input_cb(gpointer data, gint source,
-                          GaimInputCondition cond);
+                          PurpleInputCondition cond);
 static guint gaym_nick_hash(const char *nick);
 static gboolean gaym_nick_equal(const char *nick1, const char *nick2);
 static void gaym_buddy_free(struct gaym_buddy *ib);
@@ -69,8 +66,8 @@
 static void gaym_buddy_clear_done(char *name, struct gaym_buddy *ib,
                                   gpointer nothing);
 
-static void connect_signals(GaimConnection * plugin);
-static GaimPlugin *_gaym_plugin = NULL;
+static void connect_signals(PurpleConnection * plugin);
+static PurplePlugin *_gaym_plugin = NULL;
 
 static const char *status_chars = &quot;@+%&amp;&quot;;
 
@@ -81,9 +78,9 @@
     if (gaym-&gt;fd &lt; 0)
         return -1;
 
-    /* gaim_debug(GAIM_DEBUG_MISC, &quot;gaym&quot;, &quot;sent: %s&quot;, buf); */
+    /* purple_debug(PURPLE_DEBUG_MISC, &quot;gaym&quot;, &quot;sent: %s&quot;, buf); */
     if ((ret = write(gaym-&gt;fd, buf, strlen(buf))) &lt; 0)
-        gaim_connection_error(gaim_account_get_connection(gaym-&gt;account),
+        purple_connection_error(purple_account_get_connection(gaym-&gt;account),
                               _(&quot;Server has disconnected&quot;));
 
     return ret;
@@ -110,9 +107,9 @@
     if (!list || !strlen(list)) {
         g_hash_table_foreach(gaym-&gt;buddies, (GHFunc) gaym_buddy_clear_done,
                              NULL);
-        gaim_timeout_remove(gaym-&gt;timer);
+        purple_timeout_remove(gaym-&gt;timer);
         gaym-&gt;timer =
-            gaim_timeout_add(BLIST_UPDATE_PERIOD,
+            purple_timeout_add(BLIST_UPDATE_PERIOD,
                              (GSourceFunc) gaym_blist_timeout,
                              (gpointer) gaym);
         g_free(list);
@@ -123,9 +120,9 @@
     gaym-&gt;blist_updating = TRUE;
     buf = gaym_format(gaym, &quot;vn&quot;, &quot;WHOIS&quot;, list);
     gaym_send(gaym, buf);
-    gaim_timeout_remove(gaym-&gt;timer);
+    purple_timeout_remove(gaym-&gt;timer);
     gaym-&gt;timer =
-        gaim_timeout_add(BLIST_CHUNK_INTERVAL,
+        purple_timeout_add(BLIST_CHUNK_INTERVAL,
                          (GSourceFunc) gaym_blist_timeout,
                          (gpointer) gaym);
 
@@ -183,21 +180,13 @@
     g_free(buf);
 }
 
-static const char *gaym_blist_icon(GaimAccount * a, GaimBuddy * b)
+static const char *gaym_blist_icon(PurpleAccount * a, PurpleBuddy * b)
 {
     return &quot;gaym&quot;;
 }
 
-static void gaym_blist_emblems(GaimBuddy * b, const char **se,
-                               const char **sw, const char **nw,
-                               const char **ne)
+static char *gaym_status_text(PurpleBuddy * buddy)
 {
-    // if (b-&gt;present == GAIM_BUDDY_OFFLINE)
-    // *se = &quot;offline&quot;;
-}
-
-static char *gaym_status_text(GaimBuddy * buddy)
-{
     char *status;
 
     struct gaym_conn *gaym =
@@ -227,11 +216,13 @@
     return status;
 }
 
-static void gaym_tooltip_text(GaimBuddy * buddy, GString *str, gboolean full)
+static void gaym_tooltip_text(PurpleBuddy * buddy, PurpleNotifyUserInfo *user_info, gboolean full)
 {
     if (!buddy || !buddy-&gt;account || !buddy-&gt;account-&gt;gc)
         return;
 
+    PurpleNotifyUserInfo *info = purple_notify_user_info_new();
+    
     struct gaym_conn *gaym =
         (struct gaym_conn *) buddy-&gt;account-&gt;gc-&gt;proto_data;
 
@@ -240,42 +231,37 @@
     }
 
     struct gaym_buddy *ib = g_hash_table_lookup(gaym-&gt;channel_members,
-                                                gaim_normalize(gaym-&gt;
+                                                purple_normalize(gaym-&gt;
                                                                account,
                                                                buddy-&gt;
                                                                name));
     if (!ib)
         ib = g_hash_table_lookup(gaym-&gt;buddies,
-                                 gaim_normalize(gaym-&gt;account,
+                                 purple_normalize(gaym-&gt;account,
                                                 buddy-&gt;name));
 
-    if (!ib) {
-	g_string_assign(str, &quot;No info found.&quot;);
-        return;
-    }
-
-    build_tooltip_text(ib, str);
+    build_tooltip_text(ib, info);
     
 }
 
-static GList *gaym_status_types(GaimAccount * account)
+static GList *gaym_status_types(PurpleAccount * account)
 {
-    GaimStatusType *type;
+    PurpleStatusType *type;
     GList *types = NULL;
 
-    type = gaim_status_type_new(GAIM_STATUS_OFFLINE, &quot;offline&quot;,
+    type = purple_status_type_new(PURPLE_STATUS_OFFLINE, &quot;offline&quot;,
                                 _(&quot;Offline&quot;), FALSE);
     types = g_list_append(types, type);
 
-    type = gaim_status_type_new(GAIM_STATUS_AVAILABLE, &quot;available&quot;,
+    type = purple_status_type_new(PURPLE_STATUS_AVAILABLE, &quot;available&quot;,
                                 _(&quot;Available&quot;), TRUE);
     types = g_list_append(types, type);
 
     type =
-        gaim_status_type_new_with_attrs(GAIM_STATUS_AWAY, &quot;away&quot;,
+        purple_status_type_new_with_attrs(PURPLE_STATUS_AWAY, &quot;away&quot;,
                                         _(&quot;Away&quot;), TRUE, TRUE, FALSE,
                                         &quot;message&quot;, _(&quot;Message&quot;),
-                                        gaim_value_new(GAIM_TYPE_STRING),
+                                        purple_value_new(PURPLE_TYPE_STRING),
                                         NULL);
     types = g_list_append(types, type);
 
@@ -283,10 +269,10 @@
 
 }
 
-static void gaym_set_info(GaimConnection * gc, const char *info)
+static void gaym_set_info(PurpleConnection * gc, const char *info)
 {
     struct gaym_conn *gaym = gc-&gt;proto_data;
-    GaimAccount *account = gaim_connection_get_account(gc);
+    PurpleAccount *account = purple_connection_get_account(gc);
     char *hostname = &quot;none&quot;;
     char *buf, *bioline;
     int i = 0;
@@ -311,21 +297,21 @@
             g_free(gaym-&gt;bio);
         }
         if (tmpinfo &amp;&amp; strlen(tmpinfo) &gt; 0) {
-            gaim_debug_misc(&quot;gaym&quot;, &quot;option1, info=%x\n&quot;, tmpinfo);
+            purple_debug_misc(&quot;gaym&quot;, &quot;option1, info=%x\n&quot;, tmpinfo);
             /* java client allows MAX_BIO_LEN characters */
             gaym-&gt;bio = g_strndup(tmpinfo, MAX_BIO_LEN);
         } else if (gaym-&gt;server_bioline
                    &amp;&amp; strlen(gaym-&gt;server_bioline) &gt; 0) {
-            gaim_debug_misc(&quot;gaym&quot;, &quot;option2\n&quot;);
+            purple_debug_misc(&quot;gaym&quot;, &quot;option2\n&quot;);
             gaym-&gt;bio = gaym_bio_strdup(gaym-&gt;server_bioline);
         } else {
-            gaim_debug_misc(&quot;gaym&quot;, &quot;option3\n&quot;);
-            gaym-&gt;bio = g_strdup(&quot;Gaim User&quot;);
+            purple_debug_misc(&quot;gaym&quot;, &quot;option3\n&quot;);
+            gaym-&gt;bio = g_strdup(&quot;Purple User&quot;);
         }
-        gaim_account_set_user_info(account, gaym-&gt;bio);
-        gaim_account_set_string(account, &quot;bioline&quot;, gaym-&gt;bio);
-        gaim_debug_info(&quot;gaym&quot;, &quot;INFO=%x BIO=%x\n&quot;, tmpinfo, gaym-&gt;bio);
-        gaim_debug_misc(&quot;gaym&quot;, &quot;In login_cb, gc-&gt;account=%x\n&quot;,
+        purple_account_set_user_info(account, gaym-&gt;bio);
+        purple_account_set_string(account, &quot;bioline&quot;, gaym-&gt;bio);
+        purple_debug_info(&quot;gaym&quot;, &quot;INFO=%x BIO=%x\n&quot;, tmpinfo, gaym-&gt;bio);
+        purple_debug_misc(&quot;gaym&quot;, &quot;In login_cb, gc-&gt;account=%x\n&quot;,
                         gc-&gt;account);
     }
 
@@ -338,13 +324,13 @@
                         gaym-&gt;server_stats ? gaym-&gt;server_stats : &quot;&quot;);
 
     buf = gaym_format(gaym, &quot;vvvv:&quot;, &quot;USER&quot;,
-                      gaim_account_get_username(account),
+                      purple_account_get_username(account),
                       hostname, gaym-&gt;server, bioline);
 
-    gaim_debug_misc(&quot;gaym&quot;, &quot;BIO=%x\n&quot;, bioline);
+    purple_debug_misc(&quot;gaym&quot;, &quot;BIO=%x\n&quot;, bioline);
 
     if (gaym_send(gaym, buf) &lt; 0) {
-        gaim_connection_error(gc, &quot;Error registering with server&quot;);
+        purple_connection_error(gc, &quot;Error registering with server&quot;);
     }
 
     if (tmpinfo) {
@@ -356,28 +342,28 @@
     return;
 }
 
-static void gaym_show_set_info(GaimPluginAction * action)
+static void gaym_show_set_info(PurplePluginAction * action)
 {
-    GaimConnection *gc = (GaimConnection *) action-&gt;context;
-    gaim_account_request_change_user_info(gaim_connection_get_account(gc));
+    PurpleConnection *gc = (PurpleConnection *) action-&gt;context;
+    purple_account_request_change_user_info(purple_connection_get_account(gc));
 }
 
-static GList *gaym_actions(GaimPlugin * plugin, gpointer context)
+static GList *gaym_actions(PurplePlugin * plugin, gpointer context)
 {
     GList *list = NULL;
-    GaimPluginAction *act = NULL;
+    PurplePluginAction *act = NULL;
 
-    act = gaim_plugin_action_new(_(&quot;Change Bio&quot;), gaym_show_set_info);
+    act = purple_plugin_action_new(_(&quot;Change Bio&quot;), gaym_show_set_info);
     list = g_list_prepend(list, act);
 
     return list;
 }
 
-static void gaym_blist_join_chat_cb(GaimBlistNode * node, gpointer data)
+static void gaym_blist_join_chat_cb(PurpleBlistNode * node, gpointer data)
 {
     const char *args[1];
 
-    GaimChat *chat = (GaimChat *) node;
+    PurpleChat *chat = (PurpleChat *) node;
     struct gaym_conn *gaym = chat-&gt;account-&gt;gc-&gt;proto_data;
     args[0] = data;
 
@@ -387,17 +373,17 @@
     gaym_cmd_join(gaym, &quot;join&quot;, NULL, args);
 }
 
-static GList *gaym_blist_node_menu(GaimBlistNode * node)
+static GList *gaym_blist_node_menu(PurpleBlistNode * node)
 {
     GList *m = NULL;
-    GaimMenuAction *act = NULL;
+    PurpleMenuAction *act = NULL;
     int i = 0;
 
-    if (node-&gt;type != GAIM_BLIST_CHAT_NODE) {
+    if (node-&gt;type != PURPLE_BLIST_CHAT_NODE) {
         return m;
     }
 
-    GaimChat *chat = (GaimChat *) node;
+    PurpleChat *chat = (PurpleChat *) node;
     char *channel = g_hash_table_lookup(chat-&gt;components, &quot;channel&quot;);
 
     if (!channel) {
@@ -411,21 +397,21 @@
     char *label = NULL;
     char *instance = NULL;
 
-    int max = gaim_prefs_get_int(&quot;/plugins/prpl/gaym/chat_room_instances&quot;);
+    int max = purple_prefs_get_int(&quot;/plugins/prpl/gaym/chat_room_instances&quot;);
 
     for (i = max; i &gt; 0; i--) {
         label = g_strdup_printf(_(&quot;Join Room %d&quot;), i);
         instance =
             g_strdup_printf(&quot;%.*s%d&quot;, strlen(channel) - 1, channel, i);
         act =
-            gaim_menu_action_new(label, GAIM_CALLBACK(gaym_blist_join_chat_cb),
+            purple_menu_action_new(label, PURPLE_CALLBACK(gaym_blist_join_chat_cb),
                                        instance, NULL);
         m = g_list_prepend(m, act);
     }
     return m;
 }
 
-static GList *gaym_chat_join_info(GaimConnection * gc)
+static GList *gaym_chat_join_info(PurpleConnection * gc)
 {
     GList *m = NULL;
     struct proto_chat_entry *pce;
@@ -438,7 +424,7 @@
     return m;
 }
 
-GHashTable *gaym_chat_info_defaults(GaimConnection * gc,
+GHashTable *gaym_chat_info_defaults(PurpleConnection * gc,
                                     const char *chat_name)
 {
     GHashTable *defaults;
@@ -452,28 +438,28 @@
     return defaults;
 }
 
-static void gaym_login_with_chat_key(GaimAccount * account)
+static void gaym_login_with_chat_key(PurpleAccount * account)
 {
-    GaimConnection *gc;
+    PurpleConnection *gc;
     struct gaym_conn *gaym;
     char *buf;
-    const char *username = gaim_account_get_username(account);
+    const char *username = purple_account_get_username(account);
 
-    gc = gaim_account_get_connection(account);
+    gc = purple_account_get_connection(account);
     gaym = gc-&gt;proto_data;
 
     buf = g_strdup_printf(_(&quot;Signon: %s&quot;), username);
-    gaim_connection_update_progress(gc, buf, 5, 6);
+    purple_connection_update_progress(gc, buf, 5, 6);
     g_free(buf);
-    gaim_debug_misc(&quot;gaym&quot;, &quot;Trying login to %s\n&quot;, gaym-&gt;server);
-    GaimProxyConnectData* pdata = gaim_proxy_connect(NULL, account, 
+    purple_debug_misc(&quot;gaym&quot;, &quot;Trying login to %s\n&quot;, gaym-&gt;server);
+    PurpleProxyConnectData* pdata = purple_proxy_connect(NULL, account, 
 			     gaym-&gt;server,
-                             gaim_account_get_int(account, &quot;port&quot;, IRC_DEFAULT_PORT),
+                             purple_account_get_int(account, &quot;port&quot;, IRC_DEFAULT_PORT),
                              *gaym_login_cb, 
 			     gc);
     if (!pdata || !account-&gt;gc) {
-        gaim_connection_error(gc, _(&quot;Couldn't create socket&quot;));
-        gaim_debug_misc(&quot;gaym&quot;, &quot;account-&gt;gc: %x\n&quot;, account-&gt;gc);
+        purple_connection_error(gc, _(&quot;Couldn't create socket&quot;));
+        purple_debug_misc(&quot;gaym&quot;, &quot;account-&gt;gc: %x\n&quot;, account-&gt;gc);
         return;
     }
 
@@ -490,18 +476,18 @@
 
 }
 
-static void gaym_login(GaimAccount * account)
+static void gaym_login(PurpleAccount * account)
 {
-    GaimConnection *gc;
+    PurpleConnection *gc;
     struct gaym_conn *gaym;
     char *buf;
-    const char *username = gaim_account_get_username(account);
+    const char *username = purple_account_get_username(account);
 
-    gc = gaim_account_get_connection(account);
-    gc-&gt;flags |= GAIM_CONNECTION_NO_NEWLINES | GAIM_CONNECTION_AUTO_RESP;
+    gc = purple_account_get_connection(account);
+    gc-&gt;flags |= PURPLE_CONNECTION_NO_NEWLINES | PURPLE_CONNECTION_AUTO_RESP;
 
     if (strpbrk(username, &quot; \t\v\r\n&quot;) != NULL) {
-        gaim_connection_error(gc,
+        purple_connection_error(gc,
                               _(&quot;IRC nicks may not contain whitespace&quot;));
         return;
     }
@@ -511,11 +497,11 @@
 
 
     /**
-     * gaim_connection_set_display_name(gc, userparts[0]);
+     * purple_connection_set_display_name(gc, userparts[0]);
      */
-    gaim_connection_set_display_name(gc, username);
+    purple_connection_set_display_name(gc, username);
     gaym-&gt;server =
-        g_strdup(gaim_account_get_string
+        g_strdup(purple_account_get_string
                  (account, &quot;server&quot;, &quot;www.gay.com&quot;));
     /**
      * gaym-&gt;server = &quot;www.gay.com&quot;;
@@ -564,7 +550,7 @@
      */
 
     buf = g_strdup_printf(_(&quot;Signon: %s&quot;), username);
-    gaim_connection_update_progress(gc, buf, 1, 6);
+    purple_connection_update_progress(gc, buf, 1, 6);
     g_free(buf);
 
 
@@ -576,11 +562,11 @@
 }
 
 
-static void gaym_get_configtxt_cb(GaimUtilFetchUrlData* data, gpointer proto_data,
+static void gaym_get_configtxt_cb(PurpleUtilFetchUrlData* data, gpointer proto_data,
                                   const gchar * config_text, size_t len, const gchar* error_message)
 {
     struct gaym_conn *gaym = (struct gaym_conn*)proto_data;
-    // GaimConnection *gc = gaim_account_get_connection(gaym-&gt;account);
+    // PurpleConnection *gc = purple_account_get_connection(gaym-&gt;account);
 
     g_return_if_fail(config_text != NULL);
 
@@ -595,7 +581,7 @@
 }
 static void gaym_login_cb(gpointer data, gint source, const gchar *error_message)
 {
-    GaimConnection *gc = data;
+    PurpleConnection *gc = data;
     struct gaym_conn *gaym = gc-&gt;proto_data;
     char hostname[256];
     char *buf;
@@ -604,13 +590,13 @@
     char *bioline;
     char *login_name;
 
-    if (GAIM_CONNECTION_IS_VALID(gc)) {
+    if (PURPLE_CONNECTION_IS_VALID(gc)) {
 
 
-        GList *connections = gaim_connections_get_all();
+        GList *connections = purple_connections_get_all();
 
         if (source &lt; 0) {
-            gaim_connection_error(gc, _(&quot;Couldn't connect to host&quot;));
+            purple_connection_error(gc, _(&quot;Couldn't connect to host&quot;));
             return;
         }
 
@@ -620,36 +606,36 @@
         }
 
         gaym-&gt;fd = source;
-        gaim_debug_misc(&quot;gaym&quot;, &quot;In login_cb with chat_key=%s\n&quot;,
+        purple_debug_misc(&quot;gaym&quot;, &quot;In login_cb with chat_key=%s\n&quot;,
                         gaym-&gt;chat_key);
         if (gaym-&gt;chat_key) {
 
             buf = gaym_format(gaym, &quot;vv&quot;, &quot;PASS&quot;, gaym-&gt;chat_key);
             if (gaym_send(gaym, buf) &lt; 0) {
-                gaim_connection_error(gc, &quot;Error sending password&quot;);
+                purple_connection_error(gc, &quot;Error sending password&quot;);
                 return;
             }
             g_free(buf);
         } else {
-            gaim_connection_error(gc,
+            purple_connection_error(gc,
                                   _
                                   (&quot;Password wasn't recorded. Report bug.&quot;));
             return;
         }
         gethostname(hostname, sizeof(hostname));
         hostname[sizeof(hostname) - 1] = '\0';
-        username = gaim_account_get_string(gaym-&gt;account, &quot;username&quot;, &quot;&quot;);
+        username = purple_account_get_string(gaym-&gt;account, &quot;username&quot;, &quot;&quot;);
         user_bioline =
-            g_strdup(gaim_account_get_string
+            g_strdup(purple_account_get_string
                      (gaym-&gt;account, &quot;bioline&quot;, &quot;&quot;));
-        gaim_debug_info(&quot;gaym&quot;, &quot;USER BIOLINE=%x\n&quot;, user_bioline);
-        gaim_account_set_user_info(gc-&gt;account, user_bioline);
-        gaim_debug_misc(&quot;gaym&quot;,
+        purple_debug_info(&quot;gaym&quot;, &quot;USER BIOLINE=%x\n&quot;, user_bioline);
+        purple_account_set_user_info(gc-&gt;account, user_bioline);
+        purple_debug_misc(&quot;gaym&quot;,
                         &quot;In login_cb, user_bioline: %x, gc-&gt;account=%x\n&quot;,
                         user_bioline, gc-&gt;account);
 
         login_name =
-            gaym_nick_to_gcom_strdup(gaim_connection_get_display_name(gc));
+            gaym_nick_to_gcom_strdup(purple_connection_get_display_name(gc));
         bioline = g_strdup_printf(&quot;%s#%s\001%s&quot;,
                                   gaym-&gt;thumbnail,
                                   user_bioline ? user_bioline : &quot;&quot;,
@@ -657,10 +643,10 @@
                                   server_stats : &quot;&quot;);
 
         buf = gaym_format(gaym, &quot;vn&quot;, &quot;NICK&quot;, login_name);
-        gaim_debug_misc(&quot;gaym&quot;, &quot;Command: %s\n&quot;, buf);
+        purple_debug_misc(&quot;gaym&quot;, &quot;Command: %s\n&quot;, buf);
 
         if (gaym_send(gaym, buf) &lt; 0) {
-            gaim_connection_error(gc, &quot;Error sending nickname&quot;);
+            purple_connection_error(gc, &quot;Error sending nickname&quot;);
             return;
         }
         g_free(buf);
@@ -668,15 +654,15 @@
             gaym_format(gaym, &quot;vvvv:&quot;, &quot;USER&quot;, login_name, hostname,
                         gaym-&gt;server, bioline);
 
-        gaim_debug_misc(&quot;gaym&quot;, &quot;Command: %s\n&quot;, buf);
+        purple_debug_misc(&quot;gaym&quot;, &quot;Command: %s\n&quot;, buf);
         if (gaym_send(gaym, buf) &lt; 0) {
-            gaim_connection_error(gc, &quot;Error registering with server&quot;);
+            purple_connection_error(gc, &quot;Error registering with server&quot;);
             return;
         }
         g_free(login_name);
         g_free(buf);
 
-        const char *server = gaim_account_get_string(gc-&gt;account, &quot;server&quot;,
+        const char *server = purple_account_get_string(gc-&gt;account, &quot;server&quot;,
                                                      IRC_DEFAULT_SERVER);
         char *url =
             g_strdup_printf
@@ -685,12 +671,12 @@
         char *user_agent = &quot;Mozilla/4.0&quot;;
 
         get_spamlist_from_web();
-        gaim_util_fetch_url(url, FALSE, user_agent, FALSE,
+        purple_util_fetch_url(url, FALSE, user_agent, FALSE,
                        gaym_get_configtxt_cb, gaym);
 
         g_free(url);
         gc-&gt;inpa =
-            gaim_input_add(gaym-&gt;fd, GAIM_INPUT_READ, gaym_input_cb, gc);
+            purple_input_add(gaym-&gt;fd, PURPLE_INPUT_READ, gaym_input_cb, gc);
 
         connect_signals(gc);
 
@@ -703,25 +689,25 @@
     hammer_cb_data_destroy(data);
 }
 
-static void gaym_close(GaimConnection * gc)
+static void gaym_close(PurpleConnection * gc)
 {
     struct gaym_conn *gaym = gc-&gt;proto_data;
 
-    gaim_debug_misc(&quot;gaym&quot;, &quot;gaym close function has been called\n&quot;);
+    purple_debug_misc(&quot;gaym&quot;, &quot;gaym close function has been called\n&quot;);
     if (gaym == NULL)
         return;
 
     gaym_cmd_quit(gaym, &quot;quit&quot;, NULL, NULL);
 
     if (gc-&gt;inpa)
-        gaim_input_remove(gc-&gt;inpa);
+        purple_input_remove(gc-&gt;inpa);
 
     g_free(gaym-&gt;inbuf);
-    gaim_debug_misc(&quot;gaym&quot;, &quot;closing fd %i\n&quot;, gaym-&gt;fd);
+    purple_debug_misc(&quot;gaym&quot;, &quot;closing fd %i\n&quot;, gaym-&gt;fd);
     close(gaym-&gt;fd);
 
     if (gaym-&gt;timer)
-        gaim_timeout_remove(gaym-&gt;timer);
+        purple_timeout_remove(gaym-&gt;timer);
 
     if (gaym-&gt;thumbnail)
         g_free(gaym-&gt;thumbnail);
@@ -768,8 +754,8 @@
     g_free(gaym);
 }
 
-static int gaym_im_send(GaimConnection * gc, const char *who,
-                        const char *what, GaimMessageFlags flags)
+static int gaym_im_send(PurpleConnection * gc, const char *who,
+                        const char *what, PurpleMessageFlags flags)
 {
     struct gaym_conn *gaym = gc-&gt;proto_data;
     const char *args[2];
@@ -780,8 +766,8 @@
     } else {
         args[0] = who;
     }
-    stripped_msg = gaim_markup_strip_html(what);
-    if (flags &amp; GAIM_MESSAGE_AUTO_RESP) {
+    stripped_msg = purple_markup_strip_html(what);
+    if (flags &amp; PURPLE_MESSAGE_AUTO_RESP) {
         automsg = g_strdup_printf(&quot;&lt;AUTO-REPLY&gt; %s&quot;, stripped_msg);
         g_free(stripped_msg);
         args[1] = automsg;
@@ -799,9 +785,9 @@
     return 1;
 }
 
-static void gaym_get_info_quietly(GaimConnection * gc, const char *who)
+static void gaym_get_info_quietly(PurpleConnection * gc, const char *who)
 {
-    gaim_debug_misc(&quot;gaym&quot;, &quot;request info quietly\n&quot;);
+    purple_debug_misc(&quot;gaym&quot;, &quot;request info quietly\n&quot;);
     struct gaym_conn *gaym = gc-&gt;proto_data;
     const char *args[1];
     args[0] = who;
@@ -823,27 +809,25 @@
     g_hash_table_remove(data-&gt;gaym-&gt;info_window_needed, data-&gt;who);
 
 }
-static void gaym_get_info(GaimConnection * gc, const char *who)
+static void gaym_get_info(PurpleConnection * gc, const char *who)
 {
     struct gaym_conn *gaym = gc-&gt;proto_data;
+
     const char *args[1];
-    char buf[100];
     args[0] = who;
 
-    char *normalized = g_strdup(gaim_normalize(gc-&gt;account, who));
+    char *normalized = g_strdup(purple_normalize(gc-&gt;account, who));
 
     struct get_info_data *data = g_new0(struct get_info_data, 1);
-    data-&gt;who = normalized;
-    data-&gt;gaym = gaym;
-    snprintf(buf, 100, &quot;Fetching info for %s...\n&quot;, who);
-    void *dialog = gaim_request_action(gc, who,
-                                       buf, NULL, 0, data, 1, (&quot;Cancel&quot;),
-                                       cancel_get_info_cb);
-    g_hash_table_insert(gaym-&gt;info_window_needed, normalized, dialog);
+    PurpleNotifyUserInfo *info = purple_notify_user_info_new();
+    purple_debug_misc(&quot;get_info&quot;,&quot;Made new info item %x\n&quot;,info);
+    purple_notify_user_info_add_pair(info, &quot;Fetching info for&quot;,who);
+    purple_notify_userinfo(gc, who, info, NULL, data);
+    g_hash_table_insert(gaym-&gt;info_window_needed, normalized, info);
     gaym_cmd_whois(gaym, &quot;whois&quot;, NULL, args);
 }
 
-static void gaym_set_status(GaimAccount * account, GaimStatus * status)
+static void gaym_set_status(PurpleAccount * account, PurpleStatus * status)
 {
     // char *bio = NULL;
     // char *tmpmsg = NULL;
@@ -880,14 +864,14 @@
         GaymBuddy *channel_member = g_new0(GaymBuddy, 1);
         channel_member-&gt;ref_count = 1;
         g_hash_table_insert(gaym-&gt;channel_members,
-                            g_strdup(gaim_normalize(gaym-&gt;account, name)),
+                            g_strdup(purple_normalize(gaym-&gt;account, name)),
                             channel_member);
-        gaim_debug_misc(&quot;gaym&quot;, &quot;Creating channel_members entry for %s\n&quot;,
+        purple_debug_misc(&quot;gaym&quot;, &quot;Creating channel_members entry for %s\n&quot;,
                         name);
         return g_hash_table_lookup(gaym-&gt;channel_members,
-                                   gaim_normalize(gaym-&gt;account, name));
+                                   purple_normalize(gaym-&gt;account, name));
     } else {
-        gaim_debug_misc(&quot;gaym&quot;,
+        purple_debug_misc(&quot;gaym&quot;,
                         &quot;Adding reference to channel_members entry for %s\n&quot;,
                         name);
         (channel_member-&gt;ref_count)++;
@@ -903,31 +887,31 @@
     GaymBuddy *channel_member;
     channel_member =
         (GaymBuddy *) g_hash_table_lookup(gaym-&gt;channel_members,
-                                          gaim_normalize(gaym-&gt;account,
+                                          purple_normalize(gaym-&gt;account,
                                                          name));
     if (!channel_member)
         return FALSE;
     else {
 
         if (channel_member-&gt;ref_count &lt;= 0)
-            gaim_debug_error(&quot;gaym&quot;,
+            purple_debug_error(&quot;gaym&quot;,
                              &quot;****Reference counting error with channel members struct.\n&quot;);
 
         channel_member-&gt;ref_count--;
 
         if (channel_member-&gt;ref_count == 0) {
-            gaim_debug_misc(&quot;gaym&quot;, &quot;Removing %s from channel_members\n&quot;,
+            purple_debug_misc(&quot;gaym&quot;, &quot;Removing %s from channel_members\n&quot;,
                             name);
             return g_hash_table_remove(gaym-&gt;channel_members,
-                                       gaim_normalize(gaym-&gt;account,
+                                       purple_normalize(gaym-&gt;account,
                                                       name));
         }
         return FALSE;
     }
 }
 
-static void gaym_add_buddy(GaimConnection * gc, GaimBuddy * buddy,
-                           GaimGroup * group)
+static void gaym_add_buddy(PurpleConnection * gc, PurpleBuddy * buddy,
+                           PurpleGroup * group)
 {
     if (buddy-&gt;name) {
         buddy-&gt;name = g_strstrip(buddy-&gt;name);
@@ -949,7 +933,7 @@
     ib-&gt;age = NULL;
     ib-&gt;location = NULL;
     g_hash_table_replace(gaym-&gt;buddies, ib-&gt;name, ib);
-    gaim_debug_misc(&quot;gaym&quot;, &quot;Add buddy: %s\n&quot;, buddy-&gt;name);
+    purple_debug_misc(&quot;gaym&quot;, &quot;Add buddy: %s\n&quot;, buddy-&gt;name);
     /**
      * if the timer isn't set, this is during signon, so we don't want to
      * flood ourself off with WHOIS's, so we don't, but after that we want
@@ -959,8 +943,8 @@
         gaym_whois_one(gaym, ib);
 }
 
-static void gaym_remove_buddy(GaimConnection * gc, GaimBuddy * buddy,
-                              GaimGroup * group)
+static void gaym_remove_buddy(PurpleConnection * gc, PurpleBuddy * buddy,
+                              PurpleGroup * group)
 {
     struct gaym_conn *gaym = (struct gaym_conn *) gc-&gt;proto_data;
 
@@ -975,7 +959,7 @@
      * remove the buddy from gaym-&gt;buddies.
      */
 
-    GSList *buddies = gaim_find_buddies(gaym-&gt;account, buddy-&gt;name);
+    GSList *buddies = purple_find_buddies(gaym-&gt;account, buddy-&gt;name);
     guint length = g_slist_length(buddies);
 
     if (length &lt; 2) {
@@ -986,9 +970,9 @@
 }
 
 static void gaym_input_cb(gpointer data, gint source,
-                          GaimInputCondition cond)
+                          PurpleInputCondition cond)
 {
-    GaimConnection *gc = data;
+    PurpleConnection *gc = data;
     struct gaym_conn *gaym = gc-&gt;proto_data;
     char *cur, *end;
     int len;
@@ -1001,10 +985,10 @@
     if ((len =
          read(gaym-&gt;fd, gaym-&gt;inbuf + gaym-&gt;inbufused,
               IRC_INITIAL_BUFSIZE - 1)) &lt; 0) {
-        gaim_connection_error(gc, _(&quot;Read error&quot;));
+        purple_connection_error(gc, _(&quot;Read error&quot;));
         return;
     } else if (len == 0) {
-        gaim_connection_error(gc, _(&quot;Server has disconnected&quot;));
+        purple_connection_error(gc, _(&quot;Server has disconnected&quot;));
         return;
     }
 
@@ -1027,22 +1011,22 @@
     }
 }
 
-static void gaym_add_permit(GaimConnection * gc, const char *name)
+static void gaym_add_permit(PurpleConnection * gc, const char *name)
 {
     if (!gaym_nick_check(name)) {
-        gaim_privacy_permit_remove(gc-&gt;account, name, TRUE);
-        gaim_notify_error(gc, _(&quot;Invalid User Name&quot;), name,
+        purple_privacy_permit_remove(gc-&gt;account, name, TRUE);
+        purple_notify_error(gc, _(&quot;Invalid User Name&quot;), name,
                           _(&quot;Invalid user name not added.&quot;));
     } else {
         gaym_privacy_change(gc, name);
     }
 }
 
-static void gaym_add_deny(GaimConnection * gc, const char *name)
+static void gaym_add_deny(PurpleConnection * gc, const char *name)
 {
     if (!gaym_nick_check(name)) {
-        gaim_privacy_deny_remove(gc-&gt;account, name, TRUE);
-        gaim_notify_error(gc, _(&quot;Invalid User Name&quot;), name,
+        purple_privacy_deny_remove(gc-&gt;account, name, TRUE);
+        purple_notify_error(gc, _(&quot;Invalid User Name&quot;), name,
                           _(&quot;Invalid user name not added.&quot;));
         return;
     }
@@ -1050,34 +1034,34 @@
     gaym_privacy_change(gc, name);
 }
 
-static void gaym_rem_permit(GaimConnection * gc, const char *name)
+static void gaym_rem_permit(PurpleConnection * gc, const char *name)
 {
     gaym_privacy_change(gc, name);
 }
 
-static void gaym_rem_deny(GaimConnection * gc, const char *name)
+static void gaym_rem_deny(PurpleConnection * gc, const char *name)
 {
     gaym_server_store_deny(gc, name, FALSE);
     gaym_privacy_change(gc, name);
 }
 
-static void gaym_set_permit_deny(GaimConnection * gc)
+static void gaym_set_permit_deny(PurpleConnection * gc)
 {
     gaym_privacy_change(gc, NULL);
 }
 
-/* static void gaym_warn(GaimConnection * gc, const char *who, gboolean
+/* static void gaym_warn(PurpleConnection * gc, const char *who, gboolean
    anonymous) { void *handle = NULL; struct gaym_conn *gaym =
    gc-&gt;proto_data; char *buf = g_strdup_printf
    (&quot;<A HREF="http://%s/members/report/form.html?area=chat&amp;room=&amp;report=%s">http://%s/members/report/form.html?area=chat&amp;room=&amp;report=%s</A>&quot;,
-   gaym-&gt;server, who); gaim_notify_uri(handle, buf); g_free(buf); } */
-static void gaym_chat_join(GaimConnection * gc, GHashTable * data)
+   gaym-&gt;server, who); purple_notify_uri(handle, buf); g_free(buf); } */
+static void gaym_chat_join(PurpleConnection * gc, GHashTable * data)
 {
     struct gaym_conn *gaym = gc-&gt;proto_data;
     const char *args[1];
     char *alias = NULL;
 
-    GaimChat *c = NULL;
+    PurpleChat *c = NULL;
 
     /**
      * need a copy, because data gets
@@ -1089,16 +1073,16 @@
 
     if (args[0]) {
         alias = g_hash_table_lookup(data, &quot;description&quot;);
-        c = gaim_blist_find_chat(gaim_connection_get_account(gc), args[0]);
+        c = purple_blist_find_chat(purple_connection_get_account(gc), args[0]);
         if (!c) {
             chatinfo = g_hash_table_new(g_str_hash, g_str_equal);
 
             g_hash_table_replace(chatinfo, &quot;channel&quot;, g_strdup(args[0]));
 
-            c = gaim_chat_new(gaim_connection_get_account(gc),
+            c = purple_chat_new(purple_connection_get_account(gc),
                               alias, chatinfo);
 
-            gaim_blist_add_chat(c, NULL, NULL);
+            purple_blist_add_chat(c, NULL, NULL);
         }
     }
 
@@ -1117,49 +1101,49 @@
     return g_strdup(g_hash_table_lookup(data, &quot;channel&quot;));
 }
 
-static void gaym_chat_invite(GaimConnection * gc, int id,
+static void gaym_chat_invite(PurpleConnection * gc, int id,
                              const char *message, const char *name)
 {
     struct gaym_conn *gaym = gc-&gt;proto_data;
-    GaimConversation *convo = gaim_find_chat(gc, id);
+    PurpleConversation *convo = purple_find_chat(gc, id);
     const char *args[2];
 
     if (!convo) {
-        gaim_debug(GAIM_DEBUG_ERROR, &quot;gaym&quot;,
+        purple_debug(PURPLE_DEBUG_ERROR, &quot;gaym&quot;,
                    &quot;Got chat invite request for bogus chat\n&quot;);
         return;
     }
     args[0] = name;
-    args[1] = gaim_conversation_get_name(convo);
-    gaym_cmd_invite(gaym, &quot;invite&quot;, gaim_conversation_get_name(convo),
+    args[1] = purple_conversation_get_name(convo);
+    gaym_cmd_invite(gaym, &quot;invite&quot;, purple_conversation_get_name(convo),
                     args);
 }
 
-static void gaym_chat_leave(GaimConnection * gc, int id)
+static void gaym_chat_leave(PurpleConnection * gc, int id)
 {
     struct gaym_conn *gaym = gc-&gt;proto_data;
-    GaimConversation *convo = gaim_find_chat(gc, id);
+    PurpleConversation *convo = purple_find_chat(gc, id);
     const char *args[2];
 
     if (!convo)
         return;
 
-    args[0] = gaim_conversation_get_name(convo);
+    args[0] = purple_conversation_get_name(convo);
     args[1] = NULL;
-    gaym_cmd_part(gaym, &quot;part&quot;, gaim_conversation_get_name(convo), args);
+    gaym_cmd_part(gaym, &quot;part&quot;, purple_conversation_get_name(convo), args);
     serv_got_chat_left(gc, id);
 }
 
-static int gaym_chat_send(GaimConnection * gc, int id, const char *what,
-                          GaimMessageFlags flags)
+static int gaym_chat_send(PurpleConnection * gc, int id, const char *what,
+                          PurpleMessageFlags flags)
 {
     struct gaym_conn *gaym = gc-&gt;proto_data;
-    GaimConversation *convo = gaim_find_chat(gc, id);
+    PurpleConversation *convo = purple_find_chat(gc, id);
     const char *args[2];
     char *tmp;
 
     if (!convo) {
-        gaim_debug(GAIM_DEBUG_ERROR, &quot;gaym&quot;,
+        purple_debug(PURPLE_DEBUG_ERROR, &quot;gaym&quot;,
                    &quot;chat send on nonexistent chat\n&quot;);
         return -EINVAL;
     }
@@ -1174,7 +1158,7 @@
     gaym_cmd_privmsg(gaym, &quot;msg&quot;, NULL, args);
 
     tmp = g_markup_escape_text(what, -1);
-    serv_got_chat_in(gc, id, gaim_connection_get_display_name(gc), 0, tmp,
+    serv_got_chat_in(gc, id, purple_connection_get_display_name(gc), 0, tmp,
                      time(NULL));
     g_free(tmp);
     return 0;
@@ -1196,7 +1180,7 @@
 
 static gboolean gaym_nick_equal(const char *nick1, const char *nick2)
 {
-    return (gaim_utf8_strcasecmp(nick1, nick2) == 0);
+    return (purple_utf8_strcasecmp(nick1, nick2) == 0);
 }
 
 static void gaym_channel_member_free(GaymBuddy * cm)
@@ -1221,40 +1205,40 @@
     g_free(ib);
 }
 
-static GaimChat *gaym_find_blist_chat(GaimAccount * account,
+static PurpleChat *gaym_find_blist_chat(PurpleAccount * account,
                                       const char *name)
 {
     char *chat_name;
-    GaimChat *chat;
-    GaimPlugin *prpl;
-    GaimPluginProtocolInfo *prpl_info = NULL;
+    PurpleChat *chat;
+    PurplePlugin *prpl;
+    PurplePluginProtocolInfo *prpl_info = NULL;
     struct proto_chat_entry *pce;
-    GaimBlistNode *node, *group;
+    PurpleBlistNode *node, *group;
     GList *parts;
 
-    GaimBuddyList *gaimbuddylist = gaim_get_blist();
+    PurpleBuddyList *purplebuddylist = purple_get_blist();
 
-    g_return_val_if_fail(gaimbuddylist != NULL, NULL);
+    g_return_val_if_fail(purplebuddylist != NULL, NULL);
     g_return_val_if_fail((name != NULL) &amp;&amp; (*name != '\0'), NULL);
 
-    if (!gaim_account_is_connected(account))
+    if (!purple_account_is_connected(account))
         return NULL;
 
-    prpl = gaim_find_prpl(gaim_account_get_protocol_id(account));
-    prpl_info = GAIM_PLUGIN_PROTOCOL_INFO(prpl);
+    prpl = purple_find_prpl(purple_account_get_protocol_id(account));
+    prpl_info = PURPLE_PLUGIN_PROTOCOL_INFO(prpl);
 
-    for (group = gaimbuddylist-&gt;root; group != NULL; group = group-&gt;next) {
+    for (group = purplebuddylist-&gt;root; group != NULL; group = group-&gt;next) {
         for (node = group-&gt;child; node != NULL; node = node-&gt;next) {
-            if (GAIM_BLIST_NODE_IS_CHAT(node)) {
+            if (PURPLE_BLIST_NODE_IS_CHAT(node)) {
 
-                chat = (GaimChat *) node;
+                chat = (PurpleChat *) node;
 
                 if (account != chat-&gt;account)
                     continue;
 
                 parts =
                     prpl_info-&gt;
-                    chat_info(gaim_account_get_connection(chat-&gt;account));
+                    chat_info(purple_account_get_connection(chat-&gt;account));
 
                 pce = parts-&gt;data;
                 chat_name = g_hash_table_lookup(chat-&gt;components,
@@ -1272,30 +1256,30 @@
     return NULL;
 }
 
-static GaimRoomlist *gaym_roomlist_get_list(GaimConnection * gc)
+static PurpleRoomlist *gaym_roomlist_get_list(PurpleConnection * gc)
 {
     struct gaym_conn *gaym;
     GList *fields = NULL;
-    GaimRoomlistField *f;
+    PurpleRoomlistField *f;
     char *buf;
 
     gaym = gc-&gt;proto_data;
 
     if (gaym-&gt;roomlist) {
-        gaim_roomlist_unref(gaym-&gt;roomlist);
+        purple_roomlist_unref(gaym-&gt;roomlist);
     }
 
-    gaym-&gt;roomlist = gaim_roomlist_new(gaim_connection_get_account(gc));
+    gaym-&gt;roomlist = purple_roomlist_new(purple_connection_get_account(gc));
 
-    f = gaim_roomlist_field_new(GAIM_ROOMLIST_FIELD_STRING, _(&quot;Channel&quot;),
+    f = purple_roomlist_field_new(PURPLE_ROOMLIST_FIELD_STRING, _(&quot;Channel&quot;),
                                 &quot;channel&quot;, FALSE);
     fields = g_list_prepend(fields, f);
 
-    f = gaim_roomlist_field_new(GAIM_ROOMLIST_FIELD_STRING, &quot;&quot;,
+    f = purple_roomlist_field_new(PURPLE_ROOMLIST_FIELD_STRING, &quot;&quot;,
                                 &quot;description&quot;, TRUE);
     fields = g_list_prepend(fields, f);
 
-    gaim_roomlist_set_fields(gaym-&gt;roomlist, fields);
+    purple_roomlist_set_fields(gaym-&gt;roomlist, fields);
 
     /**
      * Member created rooms are retrieved through the IRC protocol
@@ -1310,9 +1294,9 @@
     return gaym-&gt;roomlist;
 }
 
-static void gaym_roomlist_cancel(struct _GaimRoomlist *list)
+static void gaym_roomlist_cancel(struct _PurpleRoomlist *list)
 {
-    GaimConnection *gc = gaim_account_get_connection(list-&gt;account);
+    PurpleConnection *gc = purple_account_get_connection(list-&gt;account);
     struct gaym_conn *gaym;
 
     if (gc == NULL)
@@ -1320,12 +1304,12 @@
 
     gaym = gc-&gt;proto_data;
 
-    gaim_roomlist_set_in_progress(list, FALSE);
+    purple_roomlist_set_in_progress(list, FALSE);
 
     if (gaym-&gt;roomlist == list) {
         g_list_free(g_list_nth_data(list-&gt;rooms, 0));
         gaym-&gt;roomlist = NULL;
-        gaim_roomlist_unref(list);
+        purple_roomlist_unref(list);
     }
 
     if (gaym-&gt;roomlist_filter) {
@@ -1334,21 +1318,21 @@
     }
 }
 
-void gaym_roomlist_expand_category(struct _GaimRoomlist *list,
-                                   struct _GaimRoomlistRoom *category)
+void gaym_roomlist_expand_category(struct _PurpleRoomlist *list,
+                                   struct _PurpleRoomlistRoom *category)
 {
-    GaimRoomlistRoom *room = NULL;
+    PurpleRoomlistRoom *room = NULL;
     gchar *altname = NULL;
     gchar *altchan = NULL;
     int i = 0;
 
-    if (category-&gt;type &amp; GAIM_ROOMLIST_ROOMTYPE_ROOM
+    if (category-&gt;type &amp; PURPLE_ROOMLIST_ROOMTYPE_ROOM
         &amp;&amp; !category-&gt;expanded_once) {
 
         category-&gt;expanded_once = TRUE;
 
         int max =
-            gaim_prefs_get_int(&quot;/plugins/prpl/gaym/chat_room_instances&quot;);
+            purple_prefs_get_int(&quot;/plugins/prpl/gaym/chat_room_instances&quot;);
 
         gchar *name = category-&gt;fields-&gt;data;
         gchar *chan = category-&gt;fields-&gt;next-&gt;data;
@@ -1358,27 +1342,27 @@
             altchan = g_strdup_printf(&quot;%.*s%d&quot;, strlen(chan) - 1, chan, i);
 
             room =
-                gaim_roomlist_room_new(GAIM_ROOMLIST_ROOMTYPE_ROOM,
+                purple_roomlist_room_new(PURPLE_ROOMLIST_ROOMTYPE_ROOM,
                                        altname, category);
 
-            gaim_roomlist_room_add_field(list, room, altname);
-            gaim_roomlist_room_add_field(list, room, altchan);
-            gaim_roomlist_room_add(list, room);
+            purple_roomlist_room_add_field(list, room, altname);
+            purple_roomlist_room_add_field(list, room, altchan);
+            purple_roomlist_room_add(list, room);
             g_free(altname);
             g_free(altchan);
         }
     }
-    gaim_roomlist_set_in_progress(list, FALSE);
+    purple_roomlist_set_in_progress(list, FALSE);
 }
 
-static GaimPluginProtocolInfo prpl_info = {
+static PurplePluginProtocolInfo prpl_info = {
     0,                          /* options */
     NULL,                       /* user_splits */
     NULL,                       /* protocol_options */
-    {&quot;jpg,jpeg,gif,bmp,ico&quot;, 57, 77, 57, 77, GAIM_ICON_SCALE_DISPLAY},  /* icon_spec 
+    {&quot;jpg,jpeg,gif,bmp,ico&quot;, 57, 77, 57, 77, PURPLE_ICON_SCALE_DISPLAY},  /* icon_spec 
                                                                          */
     gaym_blist_icon,            /* list_icon */
-    gaym_blist_emblems,         /* list_emblems */
+    NULL,                        /* list_emblems */
     gaym_status_text,           /* status_text */
     gaym_tooltip_text,          /* tooltip_text */
     gaym_status_types,          /* status_types */
@@ -1440,46 +1424,46 @@
 {
 
     struct gaym_conn *gaym = (struct gaym_conn *) data;
-    GaimConvChatBuddy *cb = (GaimConvChatBuddy *) user;
-    gaim_debug_misc(&quot;gaym&quot;, &quot;Removing %s in %x from list\n&quot;,
+    PurpleConvChatBuddy *cb = (PurpleConvChatBuddy *) user;
+    purple_debug_misc(&quot;gaym&quot;, &quot;Removing %s in %x from list\n&quot;,
                     (char *) cb-&gt;name, cb);
 
-    gaim_debug_misc(&quot;    &quot;, &quot;Succes was: %i\n&quot;,
+    purple_debug_misc(&quot;    &quot;, &quot;Succes was: %i\n&quot;,
                     gaym_unreference_channel_member(gaym, cb-&gt;name));
 
 }
-static void gaym_clean_channel_members(GaimConversation * conv)
+static void gaym_clean_channel_members(PurpleConversation * conv)
 {
     if (strncmp(conv-&gt;account-&gt;protocol_id, &quot;prpl-gaym&quot;, 9))
         return;
 
     g_return_if_fail(conv != NULL);
 
-    if (conv-&gt;type == GAIM_CONV_TYPE_CHAT) {
-        GaimConvChat *chat = gaim_conversation_get_chat_data(conv);
-        GaimConnection *gc = gaim_conversation_get_gc(conv);
+    if (conv-&gt;type == PURPLE_CONV_TYPE_CHAT) {
+        PurpleConvChat *chat = purple_conversation_get_chat_data(conv);
+        PurpleConnection *gc = purple_conversation_get_gc(conv);
         g_return_if_fail(gc != NULL);
         struct gaym_conn *gaym = gc-&gt;proto_data;
-        GList *users = gaim_conv_chat_get_users(chat);
-        gaim_debug_misc(&quot;gaym&quot;, &quot;got userlist %x length %i\n&quot;, users,
+        GList *users = purple_conv_chat_get_users(chat);
+        purple_debug_misc(&quot;gaym&quot;, &quot;got userlist %x length %i\n&quot;, users,
                         g_list_length(users));
         g_list_foreach(users, (GFunc) deref_one_user, gaym);
-    } else if (conv-&gt;type == GAIM_CONV_TYPE_IM) {
-        gaim_debug_misc(&quot;gaym&quot;, &quot;removing reference to %s\n&quot;, conv-&gt;name);
-        GaimConnection *gc = gaim_conversation_get_gc(conv);
+    } else if (conv-&gt;type == PURPLE_CONV_TYPE_IM) {
+        purple_debug_misc(&quot;gaym&quot;, &quot;removing reference to %s\n&quot;, conv-&gt;name);
+        PurpleConnection *gc = purple_conversation_get_gc(conv);
         g_return_if_fail(gc != NULL);
         struct gaym_conn *gaym = gc-&gt;proto_data;
         gaym_unreference_channel_member(gaym, conv-&gt;name);
     }
 }
-static void gaym_get_photo_info(GaimConversation * conv)
+static void gaym_get_photo_info(PurpleConversation * conv)
 {
     char *buf;
     char *name;
-    gaim_debug_misc(&quot;******gaym&quot;,
+    purple_debug_misc(&quot;******gaym&quot;,
                     &quot;****************Got conversation-created signal\n&quot;);
     if (strncmp(conv-&gt;account-&gt;protocol_id, &quot;prpl-gaym&quot;, 9) == 0
-        &amp;&amp; gaim_conversation_get_type(conv) == GAIM_CONV_TYPE_IM) {
+        &amp;&amp; purple_conversation_get_type(conv) == PURPLE_CONV_TYPE_IM) {
 
         /**
          * First check to see if we already have the photo via
@@ -1488,7 +1472,7 @@
 
         struct gaym_conn *gaym;
 
-        GaimConnection *gc = gaim_conversation_get_gc(conv);
+        PurpleConnection *gc = purple_conversation_get_gc(conv);
         gaym = (struct gaym_conn *) gc-&gt;proto_data;
 
         if (!gaym) {
@@ -1510,7 +1494,7 @@
 
         name = gaym_nick_to_gcom_strdup(conv-&gt;name);
         buf = gaym_format(gaym, &quot;vn&quot;, &quot;WHOIS&quot;, name);
-        gaim_debug_misc(&quot;gaym&quot;, &quot;Conversation triggered command: %s\n&quot;,
+        purple_debug_misc(&quot;gaym&quot;, &quot;Conversation triggered command: %s\n&quot;,
                         buf);
         gaym_send(gaym, buf);
         gaym_get_channel_member_reference(gaym, name);
@@ -1521,93 +1505,93 @@
     }
 }
 
-static GaimPluginPrefFrame *get_plugin_pref_frame(GaimPlugin * plugin)
+static PurplePluginPrefFrame *get_plugin_pref_frame(PurplePlugin * plugin)
 {
-    GaimPluginPrefFrame *frame;
-    GaimPluginPref *ppref;
+    PurplePluginPrefFrame *frame;
+    PurplePluginPref *ppref;
 
-    frame = gaim_plugin_pref_frame_new();
+    frame = purple_plugin_pref_frame_new();
 
-    ppref = gaim_plugin_pref_new_with_label(_(&quot;Chat Rooms&quot;));
-    gaim_plugin_pref_frame_add(frame, ppref);
+    ppref = purple_plugin_pref_new_with_label(_(&quot;Chat Rooms&quot;));
+    purple_plugin_pref_frame_add(frame, ppref);
 
     ppref =
-        gaim_plugin_pref_new_with_name_and_label
+        purple_plugin_pref_new_with_name_and_label
         (&quot;/plugins/prpl/gaym/show_join&quot;, _(&quot;Show entrance announcement&quot;));
-    gaim_plugin_pref_frame_add(frame, ppref);
+    purple_plugin_pref_frame_add(frame, ppref);
 
     ppref =
-        gaim_plugin_pref_new_with_name_and_label
+        purple_plugin_pref_new_with_name_and_label
         (&quot;/plugins/prpl/gaym/show_bio_with_join&quot;,
          _(&quot;Show member bio with entrance announcement&quot;));
-    gaim_plugin_pref_frame_add(frame, ppref);
+    purple_plugin_pref_frame_add(frame, ppref);
 
     ppref =
-        gaim_plugin_pref_new_with_name_and_label
+        purple_plugin_pref_new_with_name_and_label
         (&quot;/plugins/prpl/gaym/show_part&quot;, _(&quot;Show exit announcement&quot;));
-    gaim_plugin_pref_frame_add(frame, ppref);
+    purple_plugin_pref_frame_add(frame, ppref);
 
     ppref =
-        gaim_plugin_pref_new_with_name_and_label
+        purple_plugin_pref_new_with_name_and_label
         (&quot;/plugins/prpl/gaym/chat_room_instances&quot;,
          _(&quot;Number of chat room instances to display&quot;));
-    gaim_plugin_pref_set_bounds(ppref, 0, 9);
-    gaim_plugin_pref_frame_add(frame, ppref);
+    purple_plugin_pref_set_bounds(ppref, 0, 9);
+    purple_plugin_pref_frame_add(frame, ppref);
 
     ppref =
-        gaim_plugin_pref_new_with_label(_
+        purple_plugin_pref_new_with_label(_
                                         (&quot;Bio-Based Chat Room Activity Filtering&quot;));
-    gaim_plugin_pref_frame_add(frame, ppref);
+    purple_plugin_pref_frame_add(frame, ppref);
 
     ppref =
-        gaim_plugin_pref_new_with_name_and_label
+        purple_plugin_pref_new_with_name_and_label
         (&quot;/plugins/prpl/gaym/botfilter_enable&quot;, _(&quot;Enable&quot;));
-    gaim_plugin_pref_frame_add(frame, ppref);
+    purple_plugin_pref_frame_add(frame, ppref);
 
     ppref =
-        gaim_plugin_pref_new_with_name_and_label
+        purple_plugin_pref_new_with_name_and_label
         (&quot;/plugins/prpl/gaym/botfilter_ignore_null&quot;,
          _(&quot;Ignore if bio is blank&quot;));
-    gaim_plugin_pref_frame_add(frame, ppref);
+    purple_plugin_pref_frame_add(frame, ppref);
 
     ppref =
-        gaim_plugin_pref_new_with_name_and_label
+        purple_plugin_pref_new_with_name_and_label
         (&quot;/plugins/prpl/gaym/botfilter_patterns&quot;,
          _
          (&quot;Ignore if bio contains these patterns\n\t? = match any single character\n\t* = match zero, one, or more&quot;));
-    gaim_plugin_pref_frame_add(frame, ppref);
+    purple_plugin_pref_frame_add(frame, ppref);
 
     ppref =
-        gaim_plugin_pref_new_with_name_and_label
+        purple_plugin_pref_new_with_name_and_label
         (&quot;/plugins/prpl/gaym/botfilter_sep&quot;,
          _(&quot;Above patterns are separated by&quot;));
-    gaim_plugin_pref_set_max_length(ppref, 1);
-    gaim_plugin_pref_frame_add(frame, ppref);
+    purple_plugin_pref_set_max_length(ppref, 1);
+    purple_plugin_pref_frame_add(frame, ppref);
 
     ppref =
-        gaim_plugin_pref_new_with_name_and_label
+        purple_plugin_pref_new_with_name_and_label
         (&quot;/plugins/prpl/gaym/botfilter_url&quot;,
          _
          (&quot;URL for GayBoi's spam database\n\tblank to disable\n\tchanges affect next login\n\tdefault is &quot;
           GAYBOI_SPAM_URL));
-    gaim_plugin_pref_frame_add(frame, ppref);
+    purple_plugin_pref_frame_add(frame, ppref);
 
     return frame;
 }
 
-static GaimPluginUiInfo prefs_info = {
+static PurplePluginUiInfo prefs_info = {
     get_plugin_pref_frame
 };
 
-static GaimPluginInfo info = {
-    GAIM_PLUGIN_MAGIC,
-    GAIM_MAJOR_VERSION,
-    GAIM_MINOR_VERSION,
-    GAIM_PLUGIN_PROTOCOL,                                 /**&lt; type           */
+static PurplePluginInfo info = {
+    PURPLE_PLUGIN_MAGIC,
+    PURPLE_MAJOR_VERSION,
+    PURPLE_MINOR_VERSION,
+    PURPLE_PLUGIN_PROTOCOL,                                 /**&lt; type           */
     NULL,                                                 /**&lt; ui_requirement */
     0,                                                    /**&lt; flags          */
     NULL,                                                 /**&lt; dependencies   */
-    GAIM_PRIORITY_DEFAULT,                                /**&lt; priority       */
+    PURPLE_PRIORITY_DEFAULT,                                /**&lt; priority       */
 
     &quot;prpl-gaym&quot;,                                          /**&lt; id             */
     &quot;GayM&quot;,                                               /**&lt; name           */
@@ -1627,7 +1611,7 @@
 };
 
 
-void gaym_get_room_namelist(GaimAccount * account, const char *room)
+void gaym_get_room_namelist(PurpleAccount * account, const char *room)
 {
 
 
@@ -1655,113 +1639,113 @@
 
 
 
-static void connect_signals(GaimConnection * plugin)
+static void connect_signals(PurpleConnection * plugin)
 {
 
     static gboolean connection_done = FALSE;
     if (connection_done)
         return;
     connection_done = TRUE;
-    gaim_debug_misc(&quot;gaym&quot;,
-                    &quot;CONNECTING SIGNALS: gaim_conversations_get_handle(): %x\n&quot;,
-                    gaim_conversations_get_handle());
-    gaim_signal_connect(gaim_conversations_get_handle(),
+    purple_debug_misc(&quot;gaym&quot;,
+                    &quot;CONNECTING SIGNALS: purple_conversations_get_handle(): %x\n&quot;,
+                    purple_conversations_get_handle());
+    purple_signal_connect(purple_conversations_get_handle(),
                         &quot;conversation-created&quot;, plugin,
-                        GAIM_CALLBACK(gaym_get_photo_info), NULL);
+                        PURPLE_CALLBACK(gaym_get_photo_info), NULL);
 
-    gaim_signal_connect(gaim_conversations_get_handle(),
+    purple_signal_connect(purple_conversations_get_handle(),
                         &quot;deleting-conversation&quot;, plugin,
-                        GAIM_CALLBACK(gaym_clean_channel_members), NULL);
+                        PURPLE_CALLBACK(gaym_clean_channel_members), NULL);
 
 
-    gaim_signal_connect(gaim_accounts_get_handle(), &quot;request-namelist&quot;,
-                        plugin, GAIM_CALLBACK(gaym_get_room_namelist),
+    purple_signal_connect(purple_accounts_get_handle(), &quot;request-namelist&quot;,
+                        plugin, PURPLE_CALLBACK(gaym_get_room_namelist),
                         NULL);
-    gaim_signal_connect(gaim_accounts_get_handle(), &quot;request-info-quietly&quot;,
-                        plugin, GAIM_CALLBACK(gaym_get_info_quietly),
+    purple_signal_connect(purple_accounts_get_handle(), &quot;request-info-quietly&quot;,
+                        plugin, PURPLE_CALLBACK(gaym_get_info_quietly),
                         NULL);
 
 
 
 }
-static void _init_plugin(GaimPlugin * plugin)
+static void _init_plugin(PurplePlugin * plugin)
 {
 
-    GaimAccountOption *option;
+    PurpleAccountOption *option;
 
-    option = gaim_account_option_string_new(_(&quot;Bio Line&quot;), &quot;bioline&quot;, &quot;&quot;);
+    option = purple_account_option_string_new(_(&quot;Bio Line&quot;), &quot;bioline&quot;, &quot;&quot;);
     prpl_info.protocol_options =
         g_list_prepend(prpl_info.protocol_options, option);
 
     option =
-        gaim_account_option_int_new(_(&quot;Port&quot;), &quot;port&quot;, IRC_DEFAULT_PORT);
+        purple_account_option_int_new(_(&quot;Port&quot;), &quot;port&quot;, IRC_DEFAULT_PORT);
     prpl_info.protocol_options =
         g_list_prepend(prpl_info.protocol_options, option);
 
     option =
-        gaim_account_option_string_new(_(&quot;Server&quot;), &quot;server&quot;,
+        purple_account_option_string_new(_(&quot;Server&quot;), &quot;server&quot;,
                                        IRC_DEFAULT_SERVER);
     prpl_info.protocol_options =
         g_list_prepend(prpl_info.protocol_options, option);
 
-    gaim_signal_register(gaim_accounts_get_handle(),
+    purple_signal_register(purple_accounts_get_handle(),
                          &quot;info-updated&quot;,
-                         gaim_marshal_VOID__POINTER_POINTER, NULL, 2,
-                         gaim_value_new(GAIM_TYPE_SUBTYPE,
-                                        GAIM_SUBTYPE_ACCOUNT),
-                         gaim_value_new(GAIM_TYPE_POINTER,
-                                        GAIM_TYPE_CHAR));
+                         purple_marshal_VOID__POINTER_POINTER, NULL, 2,
+                         purple_value_new(PURPLE_TYPE_SUBTYPE,
+                                        PURPLE_SUBTYPE_ACCOUNT),
+                         purple_value_new(PURPLE_TYPE_POINTER,
+                                        PURPLE_TYPE_CHAR));
 
-    gaim_signal_register(gaim_accounts_get_handle(),
+    purple_signal_register(purple_accounts_get_handle(),
                          &quot;namelist-complete&quot;,
-                         gaim_marshal_VOID__POINTER_POINTER, NULL, 2,
-                         gaim_value_new(GAIM_TYPE_SUBTYPE,
-                                        GAIM_SUBTYPE_ACCOUNT),
-                         gaim_value_new(GAIM_TYPE_POINTER));
-    gaim_signal_register(gaim_accounts_get_handle(),
+                         purple_marshal_VOID__POINTER_POINTER, NULL, 2,
+                         purple_value_new(PURPLE_TYPE_SUBTYPE,
+                                        PURPLE_SUBTYPE_ACCOUNT),
+                         purple_value_new(PURPLE_TYPE_POINTER));
+    purple_signal_register(purple_accounts_get_handle(),
                          &quot;request-namelist&quot;,
-                         gaim_marshal_VOID__POINTER_POINTER, NULL, 2,
-                         gaim_value_new(GAIM_TYPE_SUBTYPE,
-                                        GAIM_SUBTYPE_ACCOUNT),
-                         gaim_value_new(GAIM_TYPE_POINTER,
-                                        GAIM_TYPE_CHAR));
-    gaim_signal_register(gaim_accounts_get_handle(),
+                         purple_marshal_VOID__POINTER_POINTER, NULL, 2,
+                         purple_value_new(PURPLE_TYPE_SUBTYPE,
+                                        PURPLE_SUBTYPE_ACCOUNT),
+                         purple_value_new(PURPLE_TYPE_POINTER,
+                                        PURPLE_TYPE_CHAR));
+    purple_signal_register(purple_accounts_get_handle(),
                          &quot;request-info-quietly&quot;,
-                         gaim_marshal_VOID__POINTER_POINTER, NULL, 2,
-                         gaim_value_new(GAIM_TYPE_SUBTYPE,
-                                        GAIM_SUBTYPE_ACCOUNT),
-                         gaim_value_new(GAIM_TYPE_POINTER,
-                                        GAIM_TYPE_CHAR));
+                         purple_marshal_VOID__POINTER_POINTER, NULL, 2,
+                         purple_value_new(PURPLE_TYPE_SUBTYPE,
+                                        PURPLE_SUBTYPE_ACCOUNT),
+                         purple_value_new(PURPLE_TYPE_POINTER,
+                                        PURPLE_TYPE_CHAR));
 
 
 
-    gaim_prefs_add_none(&quot;/plugins/prpl/gaym&quot;);
-    gaim_prefs_add_int(&quot;/plugins/prpl/gaym/chat_room_instances&quot;, 4);
-    gaim_prefs_add_bool(&quot;/plugins/prpl/gaym/show_join&quot;, TRUE);
-    gaim_prefs_add_bool(&quot;/plugins/prpl/gaym/show_part&quot;, TRUE);
-    gaim_prefs_add_bool(&quot;/plugins/prpl/gaym/show_bio_with_join&quot;, TRUE);
+    purple_prefs_add_none(&quot;/plugins/prpl/gaym&quot;);
+    purple_prefs_add_int(&quot;/plugins/prpl/gaym/chat_room_instances&quot;, 4);
+    purple_prefs_add_bool(&quot;/plugins/prpl/gaym/show_join&quot;, TRUE);
+    purple_prefs_add_bool(&quot;/plugins/prpl/gaym/show_part&quot;, TRUE);
+    purple_prefs_add_bool(&quot;/plugins/prpl/gaym/show_bio_with_join&quot;, TRUE);
 
-    gaim_prefs_add_bool(&quot;/plugins/prpl/gaym/botfilter_enable&quot;, FALSE);
-    gaim_prefs_add_bool(&quot;/plugins/prpl/gaym/botfilter_ignore_null&quot;, FALSE);
-    gaim_prefs_add_string(&quot;/plugins/prpl/gaym/botfilter_sep&quot;, &quot;|&quot;);
-    gaim_prefs_add_string(&quot;/plugins/prpl/gaym/botfilter_patterns&quot;,
+    purple_prefs_add_bool(&quot;/plugins/prpl/gaym/botfilter_enable&quot;, FALSE);
+    purple_prefs_add_bool(&quot;/plugins/prpl/gaym/botfilter_ignore_null&quot;, FALSE);
+    purple_prefs_add_string(&quot;/plugins/prpl/gaym/botfilter_sep&quot;, &quot;|&quot;);
+    purple_prefs_add_string(&quot;/plugins/prpl/gaym/botfilter_patterns&quot;,
                           &quot;NULL|MODE * -i|*dantcamboy*|*Free preview*|*epowerchat*|*Live gay sex cam show*|*camboiz*&quot;);
-    gaim_prefs_add_string(&quot;/plugins/prpl/gaym/botfilter_url&quot;,
+    purple_prefs_add_string(&quot;/plugins/prpl/gaym/botfilter_url&quot;,
                           GAYBOI_SPAM_URL);
 
-    gaim_prefs_connect_callback(&quot;/plugins/prpl/gaym/botfilter_url&quot;,
+    purple_prefs_connect_callback(&quot;/plugins/prpl/gaym/botfilter_url&quot;,
                                 &quot;botfilter_url&quot;, botfilter_url_changed_cb,
                                 NULL);
 
-    gaim_prefs_add_string(&quot;/plugins/prpl/gaym/botfilter_url_result&quot;, &quot;&quot;);
-    gaim_prefs_add_int(&quot;/plugins/prpl/gaym/botfilter_url_last_check&quot;, 0);
+    purple_prefs_add_string(&quot;/plugins/prpl/gaym/botfilter_url_result&quot;, &quot;&quot;);
+    purple_prefs_add_int(&quot;/plugins/prpl/gaym/botfilter_url_last_check&quot;, 0);
 
     _gaym_plugin = plugin;
 
     gaym_register_commands();
 }
 
-GAIM_INIT_PLUGIN(gaym, _init_plugin, info);
+PURPLE_INIT_PLUGIN(gaym, _init_plugin, info);
 
 
 

Modified: qrc/trunk/gaym/src/gaym.h
===================================================================
--- qrc/trunk/gaym/src/gaym.h	2007-07-13 19:53:50 UTC (rev 296)
+++ qrc/trunk/gaym/src/gaym.h	2007-07-14 04:26:09 UTC (rev 297)
@@ -1,7 +1,7 @@
 /**
  * @file gaym.h
  * 
- * gaim
+ * purple
  *
  * Copyright (C) 2003, Ethan Blanton &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/qrc-svn">eblanton at cs.purdue.edu</A>&gt;
  * 
@@ -20,8 +20,8 @@
  * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
  */
 
-#ifndef _GAIM_GAYM_H
-#define _GAIM_GAYM_H
+#ifndef _PURPLE_GAYM_H
+#define _PURPLE_GAYM_H
 
 #ifdef HAVE_CONFIG_H
 #include &quot;config.h&quot;
@@ -41,12 +41,12 @@
 #include &lt;glib-2.0/glib/gi18n.h&gt;
 
 #include &quot;roomlist.h&quot;
-
+#include &quot;util.h&quot;
 #define IRC_DEFAULT_SERVER &quot;www.gay.com&quot;
 #define IRC_DEFAULT_PORT 7514
 
 #define IRC_DEFAULT_CHARSET &quot;UTF-8&quot;
-#define IRC_DEFAULT_ALIAS &quot;gaim&quot;
+#define IRC_DEFAULT_ALIAS &quot;purple&quot;
 
 #define IRC_INITIAL_BUFSIZE 1024
 
@@ -74,7 +74,7 @@
 enum info_string { INFO_AGE, INFO_LOCATION, INFO_BIO, INFO_URL };
 
 struct gaym_conn {
-    GaimAccount *account;
+    PurpleAccount *account;
     GHashTable *msgs;
     GHashTable *cmds;
     char *server;
@@ -103,7 +103,7 @@
     char *nameconv;
     char *traceconv;
 
-    GaimRoomlist *roomlist;
+    PurpleRoomlist *roomlist;
 
     GList **node_menu;
     gboolean quitting;
@@ -123,14 +123,14 @@
 
     gchar *cookies;
     GHashTable *cookie_table;
-    void (*session_cb) (GaimAccount *);
-    GaimAccount *account;
+    void (*session_cb) (PurpleAccount *);
+    PurpleAccount *account;
     char *username;
     char *password;
     struct gaym_conn *gaym;
     gboolean hasFormData;
 
-} GaimUrlSession;
+} PurpleUrlSession;
 typedef struct gaym_buddy GaymBuddy;
 struct gaym_buddy {
     gchar *name;                /* gaym formatted nick */
@@ -269,17 +269,18 @@
     // 
     // (during names pass)
 } GaymNamelist;
-void gaym_get_chat_key_from_weblogin(GaimAccount * account,
-                                     void (*callback) (GaimAccount *));
+void gaym_get_chat_key_from_weblogin(PurpleAccount * account,
+                                     void (*callback) (PurpleAccount *));
 
-void gaym_get_room_namelist(GaimAccount * account, const char *room);
-void gaim_session_fetch(const char *url, gboolean full,
-                        const char *user_agent, gboolean http11,
-                        void (*cb) (gpointer, const char *, size_t),
-                        void *user_data, GaimUrlSession * session);
+void gaym_get_room_namelist(PurpleAccount * account, const char *room);
 
-#endif                          /* _GAIM_GAYM_H */
+PurpleUtilFetchUrlData* gaym_util_fetch_url_request(const char *url, gboolean full,
+		const char *user_agent, gboolean http11,
+		const char *request, gboolean include_headers,
+		PurpleUtilFetchUrlCallback callback, void *user_data);
 
+#endif                          /* _PURPLE_GAYM_H */
+
 /**
  * vim:tabstop=4:shiftwidth=4:expandtab:
  */

Modified: qrc/trunk/gaym/src/gayminfo.c
===================================================================
--- qrc/trunk/gaym/src/gayminfo.c	2007-07-13 19:53:50 UTC (rev 296)
+++ qrc/trunk/gaym/src/gayminfo.c	2007-07-14 04:26:09 UTC (rev 297)
@@ -25,15 +25,7 @@
 #include &quot;gayminfo.h&quot;
 #include &quot;util.h&quot;
 #include &quot;debug.h&quot;
-// #define GAYM_TOKEN 1
 
-#ifdef GAYM_TOKEN
-gboolean gaym_stats_find_gaym_token(const char *info)
-{
-    gaim_debug_misc(&quot;token&quot;, &quot;checking for token in %s\n&quot;, info);
-    return (gboolean) g_strrstr(info, &quot;\xC2\xA0 \xC2\xA0&quot;);
-}
-#endif
 char *gaym_thumbnail_strdup(const char *info)
 {
     char *start = strchr(info, ':');
@@ -59,13 +51,6 @@
         if (!end)
             end = strchr(start, 0);
     }
-#ifdef GAYM_TOKEN
-    gaim_debug_misc(&quot;gaym&quot;, &quot;end: %x, end-1: %x, end-5: %x\n&quot;, end,
-                    *(end - 1), *(end - 5));
-    if (end - 5 &gt;= start)
-        if (!strncmp((end - 5), &quot;\xC2\xA0 \xC2\xA0&quot;, 5))
-            end -= 5;
-#endif
     if ((end) &amp;&amp; (start &lt; end)) {
         return g_strdup_printf(&quot;%.*s&quot;, end - start, start);
     } else {
@@ -100,7 +85,7 @@
 {
     GaymBuddy *cm = gaym_get_channel_member_reference(gaym, nick);
     if (!cm) {
-        gaim_debug_error(&quot;gaym&quot;,
+        purple_debug_error(&quot;gaym&quot;,
                          &quot;ERROR: A member has joined a channel, or a conversation was opened, but we were unable to add the member to the internal management structure. Report a bug.&quot;);
         return;
     } else {
@@ -121,14 +106,11 @@
         }
         cm-&gt;name = g_strdup(nick);
         cm-&gt;bio = gaym_bio_strdup(info);
-#ifdef GAYM_TOKEN
-        cm-&gt;gaymuser = gaym_stats_find_gaym_token(info);
-#endif
         cm-&gt;thumbnail = gaym_thumbnail_strdup(info);
 
     }
 }
-void gaym_fetch_thumbnail_cb(GaimUtilFetchUrlData *url_data, void *user_data, const gchar *pic_data,
+void gaym_fetch_thumbnail_cb(PurpleUtilFetchUrlData *url_data, void *user_data, const gchar *pic_data,
                              gsize len, const gchar* error_message)
 {
     if (!user_data)
@@ -141,40 +123,37 @@
     if (!d-&gt;gc)
 	return;
     if (len &amp;&amp; !g_strrstr_len(pic_data, len, &quot;Server Error&quot;)) {
-	gaim_debug_misc(&quot;gaym&quot;,&quot;Setting buddy icon for %s\n&quot;,d-&gt;who);
-	if(len&lt;1024) {
-	    void* new_pic_data=NULL;
-	    gaim_debug_misc(&quot;gaym&quot;,&quot;Short icon file, padding to 1024\n&quot;);
-	    new_pic_data=g_malloc0(1024);
-	    memcpy(new_pic_data, pic_data, len);
-	    len=1024;
-	    gaim_buddy_icon_new(d-&gt;gc-&gt;account, d-&gt;who, (void*)new_pic_data, len);
-	    g_free(new_pic_data);
-	}
-	else {
-	    gaim_buddy_icon_new(d-&gt;gc-&gt;account, d-&gt;who, (void*)pic_data, len);
-	}
-	//GaimBuddyIcon *icon=gaim_buddy_icons_find(d-&gt;gc-&gt;account,d-&gt;who);
+	purple_debug_misc(&quot;gaym&quot;,&quot;Setting buddy icon for %s\n&quot;,d-&gt;who);
+	//if(len&lt;1024) 
+    //    len=1024;
+	void* new_pic_data=NULL;
+	purple_debug_misc(&quot;gaym&quot;,&quot;Short icon file, padding to 1024\n&quot;);
+	new_pic_data=g_malloc0(len);
+	memcpy(new_pic_data, pic_data, len);
+	purple_buddy_icon_new(d-&gt;gc-&gt;account, d-&gt;who, (void*)new_pic_data, len, NULL);
+	//g_free(new_pic_data);
+	//PurpleBuddyIcon *icon=purple_buddy_icons_find(d-&gt;gc-&gt;account,d-&gt;who, NULL);
 	//guint len;
-	//const guchar* data=gaim_buddy_icon_get_data(icon, &amp;len);
+	//const guchar* data=purple_buddy_icon_get_data(icon, &amp;len);
     }
-    if (GAIM_CONNECTION_IS_VALID(d-&gt;gc) &amp;&amp; len) {
-        gaim_signal_emit(gaim_accounts_get_handle(), &quot;info-updated&quot;,
+    if (PURPLE_CONNECTION_IS_VALID(d-&gt;gc) &amp;&amp; len) {
+        purple_signal_emit(purple_accounts_get_handle(), &quot;info-updated&quot;,
                          d-&gt;gc-&gt;account, d-&gt;who);
-      /*  if (gaim_find_conversation_with_account(d-&gt;who, d-&gt;gc-&gt;account)) {
+      /*  if (purple_find_conversation_with_account(d-&gt;who, d-&gt;gc-&gt;account)) {
 	    
-	    gaim_debug_misc(&quot;fetch_thumbnail_cb&quot;,&quot;setting buddy icon\n&quot;);
-            gaim_buddy_icons_set_for_user(gaim_connection_get_account
+	    purple_debug_misc(&quot;fetch_thumbnail_cb&quot;,&quot;setting buddy icon\n&quot;);
+            purple_buddy_icons_set_for_user(purple_connection_get_account
              (d-&gt;gc), d-&gt;who,
              (void *) pic_data, len);
         }*/
 
     } else {
-        gaim_debug_error(&quot;gaym&quot;, &quot;Fetching buddy icon failed.\n&quot;);
+        purple_debug_error(&quot;gaym&quot;, &quot;Fetching buddy icon failed.\n&quot;);
     }
 
     g_free(d-&gt;who);
     g_free(d);
+    purple_debug_misc(&quot;gaym&quot;,&quot;Finished buddy icon set callback\n&quot;);
 }
 
 void gaym_buddy_status(struct gaym_conn *gaym, char *name,
@@ -193,9 +172,6 @@
     }
 
     if (info) {
-#ifdef GAYM_TOKEN
-        gaymuser = gaym_stats_find_gaym_token(info);
-#endif
         bio = gaym_bio_strdup(info);
         if (bio) {
             bio = g_strstrip(bio);
@@ -214,7 +190,7 @@
 
     }
 
-    GaimConnection *gc = gaim_account_get_connection(gaym-&gt;account);
+    PurpleConnection *gc = purple_account_get_connection(gaym-&gt;account);
 
     if (!gc) {
         return;
@@ -224,23 +200,23 @@
     if (!ib)
         ib = g_hash_table_lookup(gaym-&gt;channel_members, name);
 
-    char *normalized = g_strdup(gaim_normalize(gaym-&gt;account, name));
+    char *normalized = g_strdup(purple_normalize(gaym-&gt;account, name));
 
     if (thumbnail &amp;&amp; fetch_thumbnail) {
-        if (!ib || gaim_utf8_strcasecmp(thumbnail, ib-&gt;thumbnail)) {
+        if (!ib || purple_utf8_strcasecmp(thumbnail, ib-&gt;thumbnail)) {
                 char *hashurl = NULL;
                 hashurl =
                     g_hash_table_lookup(gaym-&gt;confighash,
                                         &quot;mini-profile-panel.thumbnail-prefix&quot;);
                 g_return_if_fail(hashurl != NULL);
                 data = g_new0(struct gaym_fetch_thumbnail_data, 1);
-                data-&gt;gc = gaim_account_get_connection(gaym-&gt;account);
-                data-&gt;who = g_strdup(gaim_normalize(gaym-&gt;account, name));
+                data-&gt;gc = purple_account_get_connection(gaym-&gt;account);
+                data-&gt;who = g_strdup(purple_normalize(gaym-&gt;account, name));
                 data-&gt;filename = g_strdup(g_strrstr(thumbnail, &quot;/&quot;));
-                gaim_debug_misc(&quot;gayminfo&quot;, &quot;Found filename: %s\n&quot;,
+                purple_debug_misc(&quot;gayminfo&quot;, &quot;Found filename: %s\n&quot;,
                                 data-&gt;filename);
                 url = g_strdup_printf(&quot;%s%s&quot;, hashurl, thumbnail);
-                gaim_util_fetch_url(url, FALSE, &quot;Mozilla/4.0&quot;, FALSE,
+                purple_util_fetch_url(url, FALSE, &quot;Mozilla/4.0&quot;, FALSE,
                                gaym_fetch_thumbnail_cb, data);
                 g_free(url);
 
@@ -284,12 +260,12 @@
             g_free(stats);
         }
         ib-&gt;gaymuser = gaymuser;
-        GaimBuddy *buddy = gaim_find_buddy(gaym-&gt;account, name);
+        PurpleBuddy *buddy = purple_find_buddy(gaym-&gt;account, name);
         if (buddy) {
 	if(ib-&gt;online)
-	    gaim_prpl_got_user_status(gaym-&gt;account, buddy-&gt;name, GAYM_STATUS_ID_AVAILABLE, NULL);
+	    purple_prpl_got_user_status(gaym-&gt;account, buddy-&gt;name, GAYM_STATUS_ID_AVAILABLE, NULL);
 	else
-	    gaim_prpl_got_user_status(gaym-&gt;account, buddy-&gt;name, GAYM_STATUS_ID_OFFLINE, NULL);
+	    purple_prpl_got_user_status(gaym-&gt;account, buddy-&gt;name, GAYM_STATUS_ID_OFFLINE, NULL);
 	}
     }
     return;

Modified: qrc/trunk/gaym/src/gayminfo.h
===================================================================
--- qrc/trunk/gaym/src/gayminfo.h	2007-07-13 19:53:50 UTC (rev 296)
+++ qrc/trunk/gaym/src/gayminfo.h	2007-07-14 04:26:09 UTC (rev 297)
@@ -21,8 +21,8 @@
  * along with this program; if not, write to the Free Software
  * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
  */
-#ifndef _GAIM_GAYM_GAYMINFO_H_
-#define _GAIM_GAYM_GAYMINFO_H_
+#ifndef _PURPLE_GAYM_GAYMINFO_H_
+#define _PURPLE_GAYM_GAYMINFO_H_
 
 #include &lt;glib.h&gt;
 
@@ -34,7 +34,7 @@
  */
 #include &quot;connection.h&quot;
 struct gaym_fetch_thumbnail_data {
-    GaimConnection *gc;
+    PurpleConnection *gc;
     char *who;
     char *filename;
     char *bio;
@@ -43,7 +43,7 @@
     // gint pic_data_len;
 };
 
-void gaym_fetch_thumbnail_cb(GaimUtilFetchUrlData *url_data, void *user_data, const gchar *pic_data,
+void gaym_fetch_thumbnail_cb(PurpleUtilFetchUrlData *url_data, void *user_data, const gchar *pic_data,
                              gsize len, const gchar* error_message);
 /**
  * End temporary, pending further refactoring
@@ -99,7 +99,7 @@
 
 void gaym_update_channel_member(struct gaym_conn *gaym, const char *nick,
                                 const char *info);
-#endif                          /* _GAIM_GAYM_GAYMINFO_H_ */
+#endif                          /* _PURPLE_GAYM_GAYMINFO_H_ */
 
 /**
  * vim:tabstop=4:shiftwidth=4:expandtab:

Modified: qrc/trunk/gaym/src/gaympriv.c
===================================================================
--- qrc/trunk/gaym/src/gaympriv.c	2007-07-13 19:53:50 UTC (rev 296)
+++ qrc/trunk/gaym/src/gaympriv.c	2007-07-14 04:26:09 UTC (rev 297)
@@ -28,7 +28,7 @@
 /* system headers */
 #include &lt;glib.h&gt;
 
-/* gaim headers for this plugin */
+/* purple headers for this plugin */
 #include &quot;account.h&quot;
 #include &quot;debug.h&quot;
 #include &quot;privacy.h&quot;
@@ -40,7 +40,7 @@
 #include &quot;gaympriv.h&quot;
 #include &quot;helpers.h&quot;
 
-gboolean gaym_privacy_check(GaimConnection * gc, const char *nick)
+gboolean gaym_privacy_check(PurpleConnection * gc, const char *nick)
 {
     /**
      * returns TRUE if allowed through, FALSE otherwise
@@ -50,61 +50,61 @@
 
     switch (gc-&gt;account-&gt;perm_deny) {
     case 0:
-        gaim_debug_warning(&quot;gaym&quot;, &quot;Privacy setting was 0.  If you can &quot;
+        purple_debug_warning(&quot;gaym&quot;, &quot;Privacy setting was 0.  If you can &quot;
                            &quot;reproduce this, please file a bug report.\n&quot;);
         permitted = TRUE;
         break;
 
-    case GAIM_PRIVACY_ALLOW_ALL:
+    case PURPLE_PRIVACY_ALLOW_ALL:
         permitted = TRUE;
         break;
 
-    case GAIM_PRIVACY_DENY_ALL:
-        gaim_debug_info(&quot;gaym&quot;,
-                        &quot;%s blocked data received from %s (GAIM_PRIVACY_DENY_ALL)\n&quot;,
+    case PURPLE_PRIVACY_DENY_ALL:
+        purple_debug_info(&quot;gaym&quot;,
+                        &quot;%s blocked data received from %s (PURPLE_PRIVACY_DENY_ALL)\n&quot;,
                         gc-&gt;account-&gt;username, nick);
         break;
 
-    case GAIM_PRIVACY_ALLOW_USERS:
+    case PURPLE_PRIVACY_ALLOW_USERS:
         for (list = gc-&gt;account-&gt;permit; list != NULL; list = list-&gt;next) {
-            if (!gaim_utf8_strcasecmp
-                (nick, gaim_normalize(gc-&gt;account, (char *) list-&gt;data))) {
+            if (!purple_utf8_strcasecmp
+                (nick, purple_normalize(gc-&gt;account, (char *) list-&gt;data))) {
                 permitted = TRUE;
-                gaim_debug_info(&quot;gaym&quot;,
-                                &quot;%s allowed data received from %s (GAIM_PRIVACY_ALLOW_USERS)\n&quot;,
+                purple_debug_info(&quot;gaym&quot;,
+                                &quot;%s allowed data received from %s (PURPLE_PRIVACY_ALLOW_USERS)\n&quot;,
                                 gc-&gt;account-&gt;username, nick);
                 break;
             }
         }
         break;
 
-    case GAIM_PRIVACY_DENY_USERS:
+    case PURPLE_PRIVACY_DENY_USERS:
         /* seeing we're letting everyone through, except the deny list */
         permitted = TRUE;
         for (list = gc-&gt;account-&gt;deny; list != NULL; list = list-&gt;next) {
-            if (!gaim_utf8_strcasecmp
-                (nick, gaim_normalize(gc-&gt;account, (char *) list-&gt;data))) {
+            if (!purple_utf8_strcasecmp
+                (nick, purple_normalize(gc-&gt;account, (char *) list-&gt;data))) {
                 permitted = FALSE;
-                gaim_debug_info(&quot;gaym&quot;,
-                                &quot;%s blocked data received from %s (GAIM_PRIVACY_DENY_USERS)\n&quot;,
+                purple_debug_info(&quot;gaym&quot;,
+                                &quot;%s blocked data received from %s (PURPLE_PRIVACY_DENY_USERS)\n&quot;,
                                 gc-&gt;account-&gt;username, nick);
                 break;
             }
         }
         break;
 
-    case GAIM_PRIVACY_ALLOW_BUDDYLIST:
-        if (gaim_find_buddy(gc-&gt;account, nick) != NULL) {
+    case PURPLE_PRIVACY_ALLOW_BUDDYLIST:
+        if (purple_find_buddy(gc-&gt;account, nick) != NULL) {
             permitted = TRUE;
         } else {
-            gaim_debug_info(&quot;gaym&quot;,
-                            &quot;%s blocked data received from %s (GAIM_PRIVACY_ALLOW_BUDDYLIST)\n&quot;,
+            purple_debug_info(&quot;gaym&quot;,
+                            &quot;%s blocked data received from %s (PURPLE_PRIVACY_ALLOW_BUDDYLIST)\n&quot;,
                             gc-&gt;account-&gt;username, nick);
         }
         break;
 
     default:
-        gaim_debug_warning(&quot;gaym&quot;,
+        purple_debug_warning(&quot;gaym&quot;,
                            &quot;Privacy setting was unknown.  If you can &quot;
                            &quot;reproduce this, please file a bug report.\n&quot;);
         permitted = FALSE;
@@ -114,28 +114,28 @@
     /**
      * don't block/ignore self
      */
-    if (!gaim_utf8_strcasecmp(gc-&gt;account-&gt;username, nick)) {
+    if (!purple_utf8_strcasecmp(gc-&gt;account-&gt;username, nick)) {
         permitted = TRUE;
-        gaim_debug_info(&quot;gaym&quot;, &quot;declining to block/ignore self\n&quot;);
+        purple_debug_info(&quot;gaym&quot;, &quot;declining to block/ignore self\n&quot;);
         return permitted;
     }
 
     return permitted;
 }
 
-void gaym_privacy_change(GaimConnection * gc, const char *name)
+void gaym_privacy_change(PurpleConnection * gc, const char *name)
 {
     /**
      * don't allow adding self to permit/deny lists
      */
 
     if (name) {
-        if (!gaim_utf8_strcasecmp(gc-&gt;account-&gt;username, name)) {
-            gaim_privacy_deny_remove(gc-&gt;account, gc-&gt;account-&gt;username,
+        if (!purple_utf8_strcasecmp(gc-&gt;account-&gt;username, name)) {
+            purple_privacy_deny_remove(gc-&gt;account, gc-&gt;account-&gt;username,
                                      TRUE);
-            gaim_privacy_permit_remove(gc-&gt;account, gc-&gt;account-&gt;username,
+            purple_privacy_permit_remove(gc-&gt;account, gc-&gt;account-&gt;username,
                                        TRUE);
-            gaim_debug_info(&quot;gaym&quot;,
+            purple_debug_info(&quot;gaym&quot;,
                             &quot;declining to add self to permit/deny list\n&quot;);
             return;
         }
@@ -143,22 +143,22 @@
 
     GSList *rooms = NULL;
     for (rooms = gc-&gt;buddy_chats; rooms; rooms = rooms-&gt;next) {
-        GaimConversation *convo = rooms-&gt;data;
-        GaimConvChat *chat = gaim_conversation_get_chat_data(convo);
+        PurpleConversation *convo = rooms-&gt;data;
+        PurpleConvChat *chat = purple_conversation_get_chat_data(convo);
         GList *people = NULL;
         for (people = chat-&gt;in_room; people; people = people-&gt;next) {
-            GaimConvChatBuddy *buddy = people-&gt;data;
-            GaimConversationUiOps *ops =
-                gaim_conversation_get_ui_ops(convo);
+            PurpleConvChatBuddy *buddy = people-&gt;data;
+            PurpleConversationUiOps *ops =
+                purple_conversation_get_ui_ops(convo);
             if (name) {
-                if (!gaim_utf8_strcasecmp(name, buddy-&gt;name)) {
+                if (!purple_utf8_strcasecmp(name, buddy-&gt;name)) {
                     if (gaym_privacy_check(gc, buddy-&gt;name)
                         &amp;&amp; gaym_botfilter_check(gc, buddy-&gt;name, NULL,
                                                 TRUE)) {
-                        gaim_conv_chat_unignore(GAIM_CONV_CHAT(convo),
+                        purple_conv_chat_unignore(PURPLE_CONV_CHAT(convo),
                                                 buddy-&gt;name);
                     } else {
-                        gaim_conv_chat_ignore(GAIM_CONV_CHAT(convo),
+                        purple_conv_chat_ignore(PURPLE_CONV_CHAT(convo),
                                               buddy-&gt;name);
                     }
                     ops-&gt;chat_update_user((convo), buddy-&gt;name);
@@ -166,10 +166,10 @@
             } else {
                 if (gaym_privacy_check(gc, buddy-&gt;name)
                     &amp;&amp; gaym_botfilter_check(gc, buddy-&gt;name, NULL, TRUE)) {
-                    gaim_conv_chat_unignore(GAIM_CONV_CHAT(convo),
+                    purple_conv_chat_unignore(PURPLE_CONV_CHAT(convo),
                                             buddy-&gt;name);
                 } else {
-                    gaim_conv_chat_ignore(GAIM_CONV_CHAT(convo),
+                    purple_conv_chat_ignore(PURPLE_CONV_CHAT(convo),
                                           buddy-&gt;name);
                 }
                 ops-&gt;chat_update_user((convo), buddy-&gt;name);
@@ -178,15 +178,15 @@
     }
 }
 
-void gaym_server_change_deny_status_cb(GaimUtilFetchUrlData *url_data, void *data, const gchar *result,
+void gaym_server_change_deny_status_cb(PurpleUtilFetchUrlData *url_data, void *data, const gchar *result,
                                        gsize len, const gchar* error_message)
 {
-    gaim_debug_info(&quot;gaym&quot;, &quot;gaym_server_change_deny_status_cb:\n%s\n&quot;,
+    purple_debug_info(&quot;gaym&quot;, &quot;gaym_server_change_deny_status_cb:\n%s\n&quot;,
                     result);
     return;
 }
 
-void gaym_server_store_deny(GaimConnection * gc, const char *name,
+void gaym_server_store_deny(PurpleConnection * gc, const char *name,
                             gboolean add)
 {
     char *action = NULL;
@@ -208,14 +208,14 @@
 
     char *user_agent = &quot;Mozilla/4.0&quot;;
 
-    gaim_util_fetch_url(url, FALSE, user_agent, FALSE,
+    purple_util_fetch_url(url, FALSE, user_agent, FALSE,
                    gaym_server_change_deny_status_cb, NULL);
 
     g_free(url);
     return;
 }
 
-void synchronize_deny_list(GaimConnection * gc, GHashTable * confighash)
+void synchronize_deny_list(PurpleConnection * gc, GHashTable * confighash)
 {
     char *srvdeny = NULL;
     gchar **srvdenylist = NULL;
@@ -244,20 +244,20 @@
     for (i = 0; srvdenylist[i]; i++) {
         needsync = TRUE;
         for (list = gc-&gt;account-&gt;deny; list != NULL; list = list-&gt;next) {
-            if (!gaim_utf8_strcasecmp
+            if (!purple_utf8_strcasecmp
                 (srvdenylist[i],
-                 gaim_normalize(gc-&gt;account, (char *) list-&gt;data))) {
+                 purple_normalize(gc-&gt;account, (char *) list-&gt;data))) {
                 needsync = FALSE;
                 break;
             }
         }
         if (needsync) {
-            if (!gaim_privacy_deny_add(gc-&gt;account, srvdenylist[i], TRUE)) {
-                gaim_debug_error(&quot;gaym&quot;,
+            if (!purple_privacy_deny_add(gc-&gt;account, srvdenylist[i], TRUE)) {
+                purple_debug_error(&quot;gaym&quot;,
                                  &quot;Failed to add %s to local deny list from server.\n&quot;,
                                  srvdenylist[i]);
             } else {
-                gaim_debug_misc(&quot;gaym&quot;,
+                purple_debug_misc(&quot;gaym&quot;,
                                 &quot;Added %s to local deny list from server.\n&quot;,
                                 srvdenylist[i]);
             }
@@ -268,9 +268,9 @@
     for (list = gc-&gt;account-&gt;deny; list != NULL; list = list-&gt;next) {
         needsync = TRUE;
         for (i = 0; srvdenylist[i]; i++) {
-            if (!gaim_utf8_strcasecmp
+            if (!purple_utf8_strcasecmp
                 (srvdenylist[i],
-                 gaim_normalize(gc-&gt;account, (char *) list-&gt;data))) {
+                 purple_normalize(gc-&gt;account, (char *) list-&gt;data))) {
                 needsync = FALSE;
                 break;
             }

Modified: qrc/trunk/gaym/src/gaympriv.h
===================================================================
--- qrc/trunk/gaym/src/gaympriv.h	2007-07-13 19:53:50 UTC (rev 296)
+++ qrc/trunk/gaym/src/gaympriv.h	2007-07-14 04:26:09 UTC (rev 297)
@@ -21,8 +21,8 @@
  * along with this program; if not, write to the Free Software
  * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
  */
-#ifndef _GAIM_GAYM_GAYMPRIV_H_
-#define _GAIM_GAYM_GAYMPRIV_H_
+#ifndef _PURPLE_GAYM_GAYMPRIV_H_
+#define _PURPLE_GAYM_GAYMPRIV_H_
 
 #include &quot;connection.h&quot;
 
@@ -37,7 +37,7 @@
  *
  * @return TRUE if the user is allowed, or @c FALSE otherwise.
  */
-gboolean gaym_privacy_check(GaimConnection * gc, const char *nick);
+gboolean gaym_privacy_check(PurpleConnection * gc, const char *nick);
 
 /**
  * Respond to notification that the account's privacy settings have
@@ -49,18 +49,18 @@
  *                this must be NULL so that all users are reset and
  *                checked.
  */
-void gaym_privacy_change(GaimConnection * gc, const char *name);
+void gaym_privacy_change(PurpleConnection * gc, const char *name);
 
 /**
  * Report the status of the http request to add a name to the deny
  * list or remove a name from the deny list.
  *
  * @param gc     The connection.
- * @param data   The data passed from gaim_url_fetch().
+ * @param data   The data passed from purple_url_fetch().
  * @param result The information fetched by the http GET.
  * @param len    The length of the result.
  */
-void gaym_server_change_deny_status_cb(GaimUtilFetchUrlData *url_data, void *data, const gchar *result,
+void gaym_server_change_deny_status_cb(PurpleUtilFetchUrlData *url_data, void *data, const gchar *result,
                                        gsize len, const gchar* error_message);
 
 /**
@@ -70,11 +70,11 @@
  * @param name The name of the user to add or remove.
  * @param add  TRUE of the name should be added, FALSE if the name should be removed.
  */
-void gaym_server_store_deny(GaimConnection * gc, const char *name,
+void gaym_server_store_deny(PurpleConnection * gc, const char *name,
                             gboolean add);
 
 /**
- * Try to synchronize the server's deny list with gaim's local deny
+ * Try to synchronize the server's deny list with purple's local deny
  * list.  Because there may be a limit to the number of people you can
  * store on the server's deny list, this function's goal so to put the
  * superset of the two on both.
@@ -82,9 +82,9 @@
  * @param gc          The connection.
  * @param confighash The config.txt java properties retrieved from Gay.com.
  */
-void synchronize_deny_list(GaimConnection * gc, GHashTable * confighash);
+void synchronize_deny_list(PurpleConnection * gc, GHashTable * confighash);
 
-#endif                          /* _GAIM_GAYM_GAYMPRIV_H_ */
+#endif                          /* _PURPLE_GAYM_GAYMPRIV_H_ */
 
 /**
  * vim:tabstop=4:shiftwidth=4:expandtab:

Modified: qrc/trunk/gaym/src/helpers.c
===================================================================
--- qrc/trunk/gaym/src/helpers.c	2007-07-13 19:53:50 UTC (rev 296)
+++ qrc/trunk/gaym/src/helpers.c	2007-07-14 04:26:09 UTC (rev 297)
@@ -92,7 +92,7 @@
         end = strstr(start, endbit);
     }
     /**
-     * gaim_debug_misc(&quot;gaym&quot;, &quot;source: %d; start: %d; end: %d\n&quot;, source,
+     * purple_debug_misc(&quot;gaym&quot;, &quot;source: %d; start: %d; end: %d\n&quot;, source,
      * start, end);
      */
     if (start &amp;&amp; end) {
@@ -288,7 +288,7 @@
         proparr = g_strsplit(tmparr[i], &quot;=&quot;, 2);
         if (proparr[0] &amp;&amp; strlen(g_strstrip(proparr[0])) &gt; 0
             &amp;&amp; proparr[1] &amp;&amp; strlen(g_strstrip(proparr[1])) &gt; 0) {
-            // gaim_debug_misc(&quot;properties&quot;,&quot;Inserted
+            // purple_debug_misc(&quot;properties&quot;,&quot;Inserted
             // %s=%s\n&quot;,proparr[0],proparr[1]);
             g_hash_table_insert(props, g_strdup(proparr[0]),
                                 g_strdup(proparr[1]));
@@ -327,10 +327,10 @@
     return val;
 }
 
-GaimRoomlistRoom *find_parent(int level, int old_level,
-                              GaimRoomlistRoom * last_room)
+PurpleRoomlistRoom *find_parent(int level, int old_level,
+                              PurpleRoomlistRoom * last_room)
 {
-    GaimRoomlistRoom *parent = NULL;
+    PurpleRoomlistRoom *parent = NULL;
     int i = 0;
 
     if (level == 0) {
@@ -348,7 +348,7 @@
     return parent;
 }
 
-void build_roomlist_from_config(GaimRoomlist * roomlist,
+void build_roomlist_from_config(PurpleRoomlist * roomlist,
                                 GHashTable * confighash, gchar * pattern)
 {
     gchar **roominst = NULL;
@@ -359,13 +359,13 @@
     int level = 0;
     int old_level = 0;
     int i = 0;
-    GaimRoomlistRoom *room = NULL;
-    GaimRoomlistRoom *parent = NULL;
+    PurpleRoomlistRoom *room = NULL;
+    PurpleRoomlistRoom *parent = NULL;
 
     g_return_if_fail(roomlist != NULL);
     g_return_if_fail(confighash != NULL);
 
-    int max = gaim_prefs_get_int(&quot;/plugins/prpl/gaym/chat_room_instances&quot;);
+    int max = purple_prefs_get_int(&quot;/plugins/prpl/gaym/chat_room_instances&quot;);
 
     gchar *roomstr = g_hash_table_lookup(confighash, &quot;roomlist&quot;);
     g_return_if_fail(roomstr != NULL);
@@ -400,17 +400,17 @@
                 altname = g_strdup_printf(&quot;%s:*&quot;, roominst[1]);
                 if (max == 0) {
                     room =
-                        gaim_roomlist_room_new(GAIM_ROOMLIST_ROOMTYPE_ROOM,
+                        purple_roomlist_room_new(PURPLE_ROOMLIST_ROOMTYPE_ROOM,
                                                altname, parent);
                 } else {
                     room =
-                        gaim_roomlist_room_new
-                        (GAIM_ROOMLIST_ROOMTYPE_CATEGORY |
-                         GAIM_ROOMLIST_ROOMTYPE_ROOM, altname, parent);
+                        purple_roomlist_room_new
+                        (PURPLE_ROOMLIST_ROOMTYPE_CATEGORY |
+                         PURPLE_ROOMLIST_ROOMTYPE_ROOM, altname, parent);
                 }
-                gaim_roomlist_room_add_field(roomlist, room, altname);
-                gaim_roomlist_room_add_field(roomlist, room, roominst[0]);
-                gaim_roomlist_room_add(roomlist, room);
+                purple_roomlist_room_add_field(roomlist, room, altname);
+                purple_roomlist_room_add_field(roomlist, room, roominst[0]);
+                purple_roomlist_room_add(roomlist, room);
                 g_free(altname);
                 g_strfreev(roominst);
                 old_level = level;
@@ -423,87 +423,78 @@
             level = roomlist_level_strip(roomarr[i]);
             parent = find_parent(level, old_level, room);
             room =
-                gaim_roomlist_room_new(GAIM_ROOMLIST_ROOMTYPE_CATEGORY,
+                purple_roomlist_room_new(PURPLE_ROOMLIST_ROOMTYPE_CATEGORY,
                                        roomarr[i], parent);
-            gaim_roomlist_room_add(roomlist, room);
+            purple_roomlist_room_add(roomlist, room);
         }
         old_level = level;
     }
     g_strfreev(roomarr);
-    gaim_roomlist_set_in_progress(roomlist, FALSE);
+    purple_roomlist_set_in_progress(roomlist, FALSE);
 }
 
-GaimConvChatBuddyFlags chat_pecking_order(const char *extra)
+PurpleConvChatBuddyFlags chat_pecking_order(const char *extra)
 {
-    GaimConvChatBuddyFlags flags = GAIM_CBFLAGS_NONE;
+    PurpleConvChatBuddyFlags flags = PURPLE_CBFLAGS_NONE;
     if (extra[0] == '1' &amp;&amp; extra[1] == '8') {
         /* profile and g-rated photo */
-        flags = GAIM_CBFLAGS_FOUNDER;
+        flags = PURPLE_CBFLAGS_FOUNDER;
     } else if (extra[0] == '1' &amp;&amp; extra[1] == '9') {
         /* profile and x-rated photo */
-        flags = GAIM_CBFLAGS_OP;
+        flags = PURPLE_CBFLAGS_OP;
     } else if (extra[0] == '8') {
         /* profile but no photo */
-        flags = GAIM_CBFLAGS_HALFOP;
+        flags = PURPLE_CBFLAGS_HALFOP;
     } else if (extra[0] == '0') {
         /* no profile and no photo */
-        flags = GAIM_CBFLAGS_NONE;
+        flags = PURPLE_CBFLAGS_NONE;
     } else {
         /* unknown */
-        flags = GAIM_CBFLAGS_VOICE;
+        flags = PURPLE_CBFLAGS_VOICE;
     }
     return flags;
 }
 
-GString* build_tooltip_text(struct gaym_buddy *ib, GString* tooltip)
+void build_tooltip_text(struct gaym_buddy *ib, PurpleNotifyUserInfo* info)
 {
-    if (!ib-&gt;name)
-        return g_string_assign(tooltip, &quot;No info found.&quot;);
+    if (!ib || !ib-&gt;name)
+    {
+        purple_notify_user_info_add_pair(info, NULL, &quot;No info&quot;);
+        return;
+    }
     char *escaped;
 
     // g_string_printf(tooltip, &quot;&lt;b&gt;&lt;i&gt;%s&lt;/i&gt;&lt;/b&gt;&quot;, ib-&gt;name);
 
-    g_return_val_if_fail(ib != NULL, NULL);
-
     if (ib-&gt;sex) {
         escaped = g_markup_escape_text(ib-&gt;sex, strlen(ib-&gt;sex));
-        g_string_append_printf(tooltip, _(&quot;\n&lt;b&gt;%s:&lt;/b&gt; %s&quot;), _(&quot;Sex&quot;),
-                               escaped);
+        purple_notify_user_info_add_pair(info, _(&quot;Sex&quot;), escaped);
         g_free(escaped);
     }
 
     if (ib-&gt;age) {
         escaped = g_markup_escape_text(ib-&gt;age, strlen(ib-&gt;age));
-        g_string_append_printf(tooltip, _(&quot;\n&lt;b&gt;%s:&lt;/b&gt; %s&quot;), _(&quot;Age&quot;),
-                               escaped);
+        purple_notify_user_info_add_pair(info, _(&quot;Age&quot;), escaped);
         g_free(escaped);
     }
     if (ib-&gt;location) {
         escaped = g_markup_escape_text(ib-&gt;location, strlen(ib-&gt;location));
-        g_string_append_printf(tooltip, _(&quot;\n&lt;b&gt;%s:&lt;/b&gt; %s&quot;),
-                               _(&quot;Location&quot;), escaped);
+        purple_notify_user_info_add_pair(info, _(&quot;Location&quot;), escaped);
         g_free(escaped);
     }
 
     if (ib-&gt;bio) {
         escaped = g_markup_escape_text(ib-&gt;bio, strlen(ib-&gt;bio));
-        g_string_append_printf(tooltip, _(&quot;\n&lt;b&gt;%s:&lt;/b&gt; %s&quot;), _(&quot;Bio&quot;),
-                               escaped);
+        purple_notify_user_info_add_pair(info, _(&quot;Bio&quot;), escaped);
         g_free(escaped);
     }
 
     if (ib-&gt;gaymuser) {
-        g_string_append(tooltip, _(&quot;\n&lt;i&gt;Gaym user.&lt;/i&gt;&quot;));
+        //g_string_append(tooltip, _(&quot;\n&lt;i&gt;Gaym user.&lt;/i&gt;&quot;));
     }
-    if (tooltip-&gt;len == 0) {
-        g_string_append_printf(tooltip, _(&quot; No info.&quot;));
-    }
-    // g_string_erase(tooltip, 0, 1);
-
-    return tooltip;
 }
 
-GaimConvChatBuddyFlags include_chat_entry_order(GaimConvChatBuddyFlags
+PurpleConvChatBuddyFlags include_chat_entry_order(PurpleConvChatBuddyFlags
                                                 flags, gint entry)
 {
 

Modified: qrc/trunk/gaym/src/helpers.h
===================================================================
--- qrc/trunk/gaym/src/helpers.h	2007-07-13 19:53:50 UTC (rev 296)
+++ qrc/trunk/gaym/src/helpers.h	2007-07-14 04:26:09 UTC (rev 297)
@@ -21,8 +21,8 @@
  * along with this program; if not, write to the Free Software
  * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
  */
-#ifndef _GAIM_GAYM_HELPERS_H_
-#define _GAIM_GAYM_HELPERS_H_
+#ifndef _PURPLE_GAYM_HELPERS_H_
+#define _PURPLE_GAYM_HELPERS_H_
 
 #include &lt;glib.h&gt;
 
@@ -36,7 +36,7 @@
 /**
  * Convert a nick from gay.com to what GayM needs to see.
  * The conversion is done in place.  The converted value
- * is for use within GayM/Gaim as well as with http requests
+ * is for use within GayM/Purple as well as with http requests
  * to gay.com. When interacting with gay.com's IRC server,
  * the nick must be converted using gaym_nick_to_gcom_strdup().
  *
@@ -134,44 +134,43 @@
  *
  * @return The parent of the room to be added.
  */
-GaimRoomlistRoom *find_parent(int level, int old_level,
-                              GaimRoomlistRoom * last_room);
+PurpleRoomlistRoom *find_parent(int level, int old_level,
+                              PurpleRoomlistRoom * last_room);
 
 /**
  * Build the portion of the roomlist that is provided in the
  * config.txt java properties file within the property &quot;roomlist&quot;.
  *
- * @param roomlist The GaimRoomlist that these rooms should be loaded
+ * @param roomlist The PurpleRoomlist that these rooms should be loaded
  *                 into.
  * @param confighash The GHashTable that config.txt was converted into
  * @param pattern The pattern to match against or NULL for everythying
  */
-void build_roomlist_from_config(GaimRoomlist * roomlist,
+void build_roomlist_from_config(PurpleRoomlist * roomlist,
                                 GHashTable * confighash, gchar * pattern);
 
 /**
- * Determine the correct GaimConvChatBuddyFlags based on the &quot;extra&quot;
+ * Determine the correct PurpleConvChatBuddyFlags based on the &quot;extra&quot;
  * information that is provided during join, whois, etc.
  *
  * @param extra The string containing the information about the flags.
  *
- * @return The correct GaimConvChatBuddyFlags.
+ * @return The correct PurpleConvChatBuddyFlags.
  */
-GaimConvChatBuddyFlags chat_pecking_order(const char *extra);
+PurpleConvChatBuddyFlags chat_pecking_order(const char *extra);
 
 /**
  * Format and return the tooltip text for a buddy/user
  *
  * @param ib The stuct containing the information about the buddy
- * @param str The GString in which to place the tooltop
+ * @param info The info struct in which to place the tooltip info
  *
- * @return   A pointer to the GString object
  */
-GString* build_tooltip_text(struct gaym_buddy *ib, GString* str);
+void build_tooltip_text(struct gaym_buddy *ib, PurpleNotifyUserInfo *info);
 
-GaimConvChatBuddyFlags include_chat_entry_order(GaimConvChatBuddyFlags
+PurpleConvChatBuddyFlags include_chat_entry_order(PurpleConvChatBuddyFlags
                                                 flags, gint entry);
-#endif                          /* _GAIM_GAYM_HELPERS_H_ */
+#endif                          /* _PURPLE_GAYM_HELPERS_H_ */
 
 /**
  * vim:tabstop=4:shiftwidth=4:expandtab:

Modified: qrc/trunk/gaym/src/msgs.c
===================================================================
--- qrc/trunk/gaym/src/msgs.c	2007-07-13 19:53:50 UTC (rev 296)
+++ qrc/trunk/gaym/src/msgs.c	2007-07-14 04:26:09 UTC (rev 297)
@@ -51,15 +51,15 @@
     return buf;
 }
 
-static void gaym_chat_remove_buddy(GaimConversation * convo, char *data[2])
+static void gaym_chat_remove_buddy(PurpleConversation * convo, char *data[2])
 {
     /**
      * FIXME: is *message ever used ???
      */
     char *message = g_strdup_printf(&quot;quit: %s&quot;, data[1]);
 
-    if (gaim_conv_chat_find_user(GAIM_CONV_CHAT(convo), data[0]))
-        gaim_conv_chat_remove_user(GAIM_CONV_CHAT(convo), data[0], NULL);
+    if (purple_conv_chat_find_user(PURPLE_CONV_CHAT(convo), data[0]))
+        purple_conv_chat_remove_user(PURPLE_CONV_CHAT(convo), data[0], NULL);
 
     g_free(message);
 }
@@ -67,60 +67,50 @@
 void gaym_msg_default(struct gaym_conn *gaym, const char *name,
                       const char *from, char **args)
 {
-    gaim_debug(GAIM_DEBUG_INFO, &quot;gaym&quot;, &quot;Unrecognized message: %s\n&quot;,
+    purple_debug(PURPLE_DEBUG_INFO, &quot;gaym&quot;, &quot;Unrecognized message: %s\n&quot;,
                args[0]);
 }
 
 void gaym_msg_away(struct gaym_conn *gaym, const char *name,
                    const char *from, char **args)
 {
-    GaimConnection *gc = gaim_account_get_connection(gaym-&gt;account);
+    PurpleConnection *gc = purple_account_get_connection(gaym-&gt;account);
 
     if (!args || !args[1] || !gc) {
         return;
     }
 
     gcom_nick_to_gaym(args[1]);
-    serv_got_im(gc, args[1], args[2], GAIM_MESSAGE_AUTO_RESP, time(NULL));
+    serv_got_im(gc, args[1], args[2], PURPLE_MESSAGE_AUTO_RESP, time(NULL));
 }
 
-static void gaym_fetch_photo_cb(GaimUtilFetchUrlData *url_data, void *user_data, const gchar *info_data,
-                                gsize len, const gchar* err)
+static void gaym_fetch_photo_cb(PurpleUtilFetchUrlData *url_data, gpointer user_data, const gchar *url_text, gsize len, const gchar* err)
 {
-    if (!info_data || !user_data) {
+    if (!url_text || !user_data) {
         return;
     }
 
     struct gaym_fetch_thumbnail_data *d = user_data;
 
-    char *info, *t = 0;
 
     struct gaym_conn *gaym = d-&gt;gc-&gt;proto_data;
 
-    char *hashurl =
-        g_hash_table_lookup(gaym-&gt;confighash, &quot;view-profile-url&quot;);
-    g_return_if_fail(hashurl != NULL);
 
-    void *dialog =
-        g_hash_table_lookup(gaym-&gt;info_window_needed,
-                            gaim_normalize(d-&gt;gc-&gt;account, d-&gt;who));
+    PurpleNotifyUserInfo *info = g_hash_table_lookup(gaym-&gt;info_window_needed, purple_normalize(d-&gt;gc-&gt;account, d-&gt;who));
 
-    if (!dialog)
+    if (!info)
         return;
 
-    int id = gaim_imgstore_add(info_data, len, NULL);
-    info = g_strdup_printf (&quot;&lt;a href='%s%s'&gt; Full Profile&lt;/a&gt;&lt;br&gt;&quot;
-                            &quot;&lt;b&gt;Stats:&lt;/b&gt; %s&lt;br&gt;&quot;
-                            &quot;&lt;b&gt;Bio:&lt;/b&gt; %s&lt;br&gt;&quot;
-                            &quot;&lt;img id=%d&gt;&quot;,
-                            hashurl, d-&gt;who, d-&gt;stats, d-&gt;bio, id);
-
-    gaim_request_close(GAIM_REQUEST_ACTION, dialog);
+    int id = purple_imgstore_add_with_id(g_memdup(url_text, len), len, NULL);
+    char* imghtml=g_strdup_printf(&quot;&lt;img id=\&quot;%d\&quot;&gt;&quot;,id);
+    purple_debug_misc(&quot;userinfo&quot;,&quot;img html: %s\n&quot;,imghtml);
+     
+    purple_notify_user_info_add_pair(info, NULL, imghtml);
+    purple_notify_userinfo(d-&gt;gc, d-&gt;who, info, NULL, NULL); 
     g_hash_table_remove(gaym-&gt;info_window_needed,
-                        gaim_normalize(d-&gt;gc-&gt;account, d-&gt;who));
-    gaim_notify_userinfo(d-&gt;gc, d-&gt;who, info, NULL, NULL);
-    g_free(t);
+                        purple_normalize(d-&gt;gc-&gt;account, d-&gt;who));
 
+    g_free(imghtml);
     if (d) {
         if (d-&gt;who)
             g_free(d-&gt;who);
@@ -130,16 +120,13 @@
             g_free(d-&gt;stats);
         g_free(d);
     }
-    gaim_imgstore_unref(id);
 }
 
-static void gaym_fetch_info_cb(GaimUtilFetchUrlData *url_data, void *user_data, const gchar *info_data,
-                               gsize len, const gchar* error_message)
+static void gaym_fetch_info_cb(PurpleUtilFetchUrlData *url_data, void *user_data, const gchar *info_data, gsize len, const gchar* error_message)
 {
     struct gaym_fetch_thumbnail_data *d = user_data;
     char *picpath;
     char *picurl;
-    char *info;
     char *match = &quot;pictures.0.url=&quot;;
 
     struct gaym_conn *gaym = d-&gt;gc-&gt;proto_data;
@@ -147,50 +134,33 @@
     char *hashurl =
         g_hash_table_lookup(gaym-&gt;confighash, &quot;view-profile-url&quot;);
     g_return_if_fail(hashurl != NULL);
+    char *proflink = g_strdup_printf(&quot;&lt;a href='%s%s'&gt;Full Profile&lt;/a&gt;&quot;,hashurl,d-&gt;who);
+    g_free(hashurl);
+    
+    PurpleNotifyUserInfo *info = 
+        g_hash_table_lookup(gaym-&gt;info_window_needed, purple_normalize(d-&gt;gc-&gt;account, d-&gt;who));
 
-    void *dialog =
-        g_hash_table_lookup(gaym-&gt;info_window_needed,
-                            gaim_normalize(d-&gt;gc-&gt;account, d-&gt;who));
-
-    if (!dialog)
+    if (!info)
         return;
 
-    if (d-&gt;stats &amp;&amp; d-&gt;bio)
-        info =
-            g_strdup_printf
-            (&quot;&lt;b&gt;Stats:&lt;/b&gt; %s&lt;br&gt;&lt;b&gt;Bio:&lt;/b&gt; %s&lt;br&gt;&lt;a href='%s%s'&gt;Full Profile&lt;/a&gt;&quot;,
-             d-&gt;stats, d-&gt;bio, hashurl, d-&gt;who);
-    else if (d-&gt;stats)
-        info =
-            g_strdup_printf
-            (&quot;&lt;b&gt;Stats:&lt;/b&gt; %s&lt;br&gt;&lt;a href='%s%s'&gt;Full Profile&lt;/a&gt;&quot;,
-             d-&gt;stats, hashurl, d-&gt;who);
-    else if (d-&gt;bio)
-        info =
-            g_strdup_printf
-            (&quot;&lt;b&gt;Bio:&lt;/b&gt; %s&lt;br&gt;&lt;a href='%s%s'&gt;Full Profile&lt;/a&gt;&quot;,
-             d-&gt;bio, hashurl, d-&gt;who);
-    else
-        info =
-            g_strdup_printf
-            (&quot;No Info Found&lt;br&gt;&lt;a href='%s%s'&gt;Full Profile&lt;/a&gt;&quot;,
-             hashurl, d-&gt;who);
-
+    purple_debug_misc(&quot;info_cb&quot;,&quot;Get info %x\n&quot;,info);
+    purple_notify_user_info_add_pair(info, NULL, proflink);
+    purple_notify_user_info_add_pair(info, &quot;Stats&quot;, d-&gt;stats?d-&gt;stats:&quot;Not Found&quot;);
+    purple_notify_user_info_add_pair(info, &quot;Bio&quot;, d-&gt;bio?d-&gt;bio:&quot;Not Found&quot;);
+    purple_debug_misc(&quot;info_cb&quot;,&quot;info updated %x\n&quot;,info);
+    purple_notify_userinfo(d-&gt;gc, d-&gt;who, info, NULL, NULL); 
     picpath = return_string_between(match, &quot;\n&quot;, info_data);
-    if (!picpath || strlen(picpath) == 0) {
-        gaim_request_close(GAIM_REQUEST_ACTION, dialog);
-        g_hash_table_remove(gaym-&gt;info_window_needed,
-                            gaim_normalize(d-&gt;gc-&gt;account, d-&gt;who));
-        gaim_notify_userinfo(d-&gt;gc, d-&gt;who, info, NULL, NULL);
-        return;
-    }
-
     picurl = g_strdup_printf(&quot;<A HREF="http://www.gay.com%s">http://www.gay.com%s</A>&quot;, picpath);
+    purple_debug_misc(&quot;msgs&quot;, &quot;Picture url: %s\n&quot;, picurl);
     if (picurl) {
-        gaim_util_fetch_url(picurl, FALSE, &quot;Mozilla/4.0 (compatible; MSIE 5.0)&quot;,
+        purple_util_fetch_url(picurl, FALSE, &quot;Mozilla/4.0 (compatible; MSIE 5.0)&quot;,
                        FALSE, gaym_fetch_photo_cb, user_data);
         return;
     }
+    else {
+    g_hash_table_remove(gaym-&gt;info_window_needed,
+                        purple_normalize(d-&gt;gc-&gt;account, d-&gt;who));
+    }
 }
 
 void gaym_msg_no_such_nick(struct gaym_conn *gaym, const char *name,
@@ -210,26 +180,25 @@
 
     gaym_buddy_status(gaym, args[1], FALSE, NULL, FALSE);
 
-    char *normalized = g_strdup(gaim_normalize(gaym-&gt;account, args[1]));
+    char *normalized = g_strdup(purple_normalize(gaym-&gt;account, args[1]));
 
     void *dialog;
     if ((dialog =
          g_hash_table_lookup(gaym-&gt;info_window_needed, normalized))) {
         g_hash_table_remove(gaym-&gt;info_window_needed, normalized);
 
+        PurpleNotifyUserInfo *info = purple_notify_user_info_new();
         char *hashurl =
             g_hash_table_lookup(gaym-&gt;confighash, &quot;view-profile-url&quot;);
         g_return_if_fail(hashurl != NULL);
+        char *proflink = g_strdup_printf(&quot;&lt;a href='%s%s'&gt;Check for Full Profile&lt;/a&gt;&quot;,hashurl,args[1]);
+        g_free(hashurl);
+        purple_notify_user_info_add_pair(info, NULL, &quot;No such user online.&quot;);
+        purple_notify_user_info_add_pair(info, NULL, proflink);
+        
+        purple_notify_userinfo(purple_account_get_connection(gaym-&gt;account),
+                             args[1], info, NULL, NULL);
 
-        char *buf;
-        buf =
-            g_strdup_printf
-            (&quot;That user is not logged on. Check &lt;a href='%s%s'&gt;here&lt;/a&gt; to see if that user has a profile.&quot;,
-             hashurl, args[1]);
-        gaim_request_close(GAIM_REQUEST_ACTION, dialog);
-        gaim_notify_userinfo(gaim_account_get_connection(gaym-&gt;account),
-                             args[1], buf, NULL, NULL);
-
     }
     g_free(normalized);
 }
@@ -251,7 +220,7 @@
 
     gaym_buddy_status(gaym, args[1], TRUE, args[5], TRUE);
 
-    char *normalized = g_strdup(gaim_normalize(gaym-&gt;account, args[1]));
+    char *normalized = g_strdup(purple_normalize(gaym-&gt;account, args[1]));
 
     struct gaym_fetch_thumbnail_data *data;
 
@@ -259,14 +228,14 @@
     // during conversation-created.
     gaym_update_channel_member(gaym, normalized, args[5]);
     gaym_unreference_channel_member(gaym, normalized);
-    gaim_debug_misc(&quot;gaym&quot;, &quot;signalling info update for %s\n&quot;, normalized);
-    gaim_signal_emit(gaim_accounts_get_handle(), &quot;info-updated&quot;,
+    purple_debug_misc(&quot;gaym&quot;, &quot;signalling info update for %s\n&quot;, normalized);
+    purple_signal_emit(purple_accounts_get_handle(), &quot;info-updated&quot;,
                      gaym-&gt;account, normalized);
 
     if (g_hash_table_lookup(gaym-&gt;info_window_needed, normalized)) {
 
         data = g_new0(struct gaym_fetch_thumbnail_data, 1);
-        data-&gt;gc = gaim_account_get_connection(gaym-&gt;account);
+        data-&gt;gc = purple_account_get_connection(gaym-&gt;account);
         data-&gt;who = g_strdup(args[1]);
         data-&gt;bio = gaym_bio_strdup(args[5]);
         data-&gt;stats = gaym_stats_strdup(args[5]);
@@ -277,7 +246,8 @@
         char *infourl = g_strdup_printf(&quot;%s?pw=%s&amp;name=%s&quot;, hashurl,
                                         gaym-&gt;chat_key, args[1]);
         if (infourl) {
-            gaim_util_fetch_url(infourl, FALSE,
+            purple_debug_misc(&quot;msgs&quot;,&quot;Fetching %s\n&quot;,infourl);
+            purple_util_fetch_url(infourl, FALSE,
                            &quot;Mozilla/4.0 (compatible; MSIE 5.0)&quot;, FALSE,
                            gaym_fetch_info_cb, data);
             g_free(infourl);
@@ -297,12 +267,12 @@
     gaym_cmd_quit(gaym, &quot;quit&quot;, NULL, NULL);
 
     // if (gc-&gt;inpa)
-    // gaim_input_remove(gc-&gt;inpa);
+    // purple_input_remove(gc-&gt;inpa);
 
     // g_free(gaym-&gt;inbuf);
-    // gaim_debug_misc(&quot;gaym&quot;, &quot;Login failed. closing fd %i\n&quot;, gaym-&gt;fd);
+    // purple_debug_misc(&quot;gaym&quot;, &quot;Login failed. closing fd %i\n&quot;, gaym-&gt;fd);
     // close(gaym-&gt;fd);
-    // gaim_debug_misc(&quot;gaym&quot;, &quot;Get chatkey from weblogin\n&quot;);
+    // purple_debug_misc(&quot;gaym&quot;, &quot;Get chatkey from weblogin\n&quot;);
     // gaym_get_hash_from_weblogin(gaym-&gt;account,
     // gaym_login_with_chat_key);
 
@@ -314,7 +284,7 @@
     /**
      * If you free anything here related to the roomlist
      * be sure you test what happens when the roomlist reference
-     * count goes to zero! Because it may crash gaim.
+     * count goes to zero! Because it may crash purple.
      */
     if (!gaym-&gt;roomlist) {
         return;
@@ -323,11 +293,11 @@
      * Begin result of member created room list
      */
     if (!strcmp(name, &quot;321&quot;) &amp;&amp; gaym-&gt;roomlist_filter == NULL) {
-        GaimRoomlistRoom *room;
-        room = gaim_roomlist_room_new(GAIM_ROOMLIST_ROOMTYPE_CATEGORY,
+        PurpleRoomlistRoom *room;
+        room = purple_roomlist_room_new(PURPLE_ROOMLIST_ROOMTYPE_CATEGORY,
                                       _(&quot;Member Created&quot;), NULL);
-        gaim_roomlist_room_add(gaym-&gt;roomlist, room);
-        gaim_roomlist_set_in_progress(gaym-&gt;roomlist, TRUE);
+        purple_roomlist_room_add(gaym-&gt;roomlist, room);
+        purple_roomlist_set_in_progress(gaym-&gt;roomlist, TRUE);
         return;
     }
 
@@ -335,7 +305,7 @@
      * The list of member created rooms
      */
     if (!strcmp(name, &quot;322&quot;)) {
-        GaimRoomlistRoom *room;
+        PurpleRoomlistRoom *room;
         char *field_start = NULL;
         char *field_end = NULL;
         size_t field_len = 0;
@@ -352,7 +322,7 @@
         field_end = strrchr(args[1], '=');
 
         if (!field_start || !field_end) {
-            gaim_debug_error(&quot;gaym&quot;,
+            purple_debug_error(&quot;gaym&quot;,
                              &quot;Member created room list parsing error&quot;);
             return;
         }
@@ -383,13 +353,13 @@
         if (gaym-&gt;roomlist_filter == NULL ||
             g_strstr_len(normalized, -1, gaym-&gt;roomlist_filter) != NULL) {
 
-            room = gaim_roomlist_room_new(GAIM_ROOMLIST_ROOMTYPE_ROOM,
+            room = purple_roomlist_room_new(PURPLE_ROOMLIST_ROOMTYPE_ROOM,
                                           field_name,
                                           g_list_nth_data(gaym-&gt;roomlist-&gt;
                                                           rooms, 0));
-            gaim_roomlist_room_add_field(gaym-&gt;roomlist, room, field_name);
-            gaim_roomlist_room_add_field(gaym-&gt;roomlist, room, args[1]);
-            gaim_roomlist_room_add(gaym-&gt;roomlist, room);
+            purple_roomlist_room_add_field(gaym-&gt;roomlist, room, field_name);
+            purple_roomlist_room_add_field(gaym-&gt;roomlist, room, args[1]);
+            purple_roomlist_room_add(gaym-&gt;roomlist, room);
         }
         g_free(normalized);
         g_free(field_name);
@@ -413,16 +383,16 @@
 void gaym_msg_unknown(struct gaym_conn *gaym, const char *name,
                       const char *from, char **args)
 {
-    GaimConnection *gc = gaim_account_get_connection(gaym-&gt;account);
+    PurpleConnection *gc = purple_account_get_connection(gaym-&gt;account);
     char *buf;
 
     if (!args || !args[1] || !gc)
         return;
 
     buf = g_strdup_printf(_(&quot;Unknown message '%s'&quot;), args[1]);
-    gaim_notify_error(gc, _(&quot;Unknown message&quot;), buf,
+    purple_notify_error(gc, _(&quot;Unknown message&quot;), buf,
                       _
-                      (&quot;Gaim has sent a message the IRC server did not understand.&quot;));
+                      (&quot;Purple has sent a message the IRC server did not understand.&quot;));
     g_free(buf);
 }
 
@@ -430,35 +400,35 @@
                     const char *from, char **args)
 {
     char *names, *cur, *end, *tmp, *msg;
-    GaimConversation *convo;
-    gaim_debug_misc(&quot;names&quot;, &quot;%s %s %s %s&quot;, name, from, args[1], args[2]);
+    PurpleConversation *convo;
+    purple_debug_misc(&quot;names&quot;, &quot;%s %s %s %s&quot;, name, from, args[1], args[2]);
     if (!strcmp(name, &quot;366&quot;)) {
         GaymNamelist *namelist = g_queue_peek_head(gaym-&gt;namelists);
-        gaim_debug_misc(&quot;names&quot;, &quot;namelist-&gt;roomname:%s\n&quot;,
+        purple_debug_misc(&quot;names&quot;, &quot;namelist-&gt;roomname:%s\n&quot;,
                         namelist-&gt;roomname);
         if (namelist
             &amp;&amp; !strncmp(namelist-&gt;roomname, args[1],
                         strlen(namelist-&gt;roomname))) {
-            gaim_debug_misc(&quot;names&quot;,
+            purple_debug_misc(&quot;names&quot;,
                             &quot;*****Got all names responses for %s\n&quot;,
                             args[1]);
             GaymNamelist *namelist = g_queue_pop_head(gaym-&gt;namelists);
-            gaim_debug_misc(&quot;msgs&quot;,
+            purple_debug_misc(&quot;msgs&quot;,
                             &quot;should be emitting namelist-complete signal passing namelist %x\n&quot;,
                             namelist);
-            gaim_signal_emit(gaim_accounts_get_handle(),
+            purple_signal_emit(purple_accounts_get_handle(),
                              &quot;namelist-complete&quot;, gaym-&gt;account, namelist);
             return;
         }
         if (!gaym-&gt;nameconv)
             return;
         convo =
-            gaim_find_conversation_with_account(GAIM_CONV_TYPE_CHAT,
+            purple_find_conversation_with_account(PURPLE_CONV_TYPE_CHAT,
                                                 gaym-&gt;nameconv ? gaym-&gt;
                                                 nameconv : args[1],
                                                 gaym-&gt;account);
         if (!convo) {
-            gaim_debug(GAIM_DEBUG_ERROR, &quot;gaym&quot;,
+            purple_debug(PURPLE_DEBUG_ERROR, &quot;gaym&quot;,
                        &quot;Got a NAMES list for %s, which doesn't exist\n&quot;,
                        args[1]);
             g_string_free(gaym-&gt;names, TRUE);
@@ -475,14 +445,14 @@
                 g_strdup_printf(_(&quot;Users on %s: %s&quot;),
                                 args[1] ? args[1] : &quot;&quot;,
                                 names ? names : &quot;&quot;);
-            if (gaim_conversation_get_type(convo) == GAIM_CONV_TYPE_CHAT)
-                gaim_conv_chat_write(GAIM_CONV_CHAT(convo), &quot;&quot;, msg,
-                                     GAIM_MESSAGE_SYSTEM |
-                                     GAIM_MESSAGE_NO_LOG, time(NULL));
+            if (purple_conversation_get_type(convo) == PURPLE_CONV_TYPE_CHAT)
+                purple_conv_chat_write(PURPLE_CONV_CHAT(convo), &quot;&quot;, msg,
+                                     PURPLE_MESSAGE_SYSTEM |
+                                     PURPLE_MESSAGE_NO_LOG, time(NULL));
             else
-                gaim_conv_im_write(GAIM_CONV_IM(convo), &quot;&quot;, msg,
-                                   GAIM_MESSAGE_SYSTEM |
-                                   GAIM_MESSAGE_NO_LOG, time(NULL));
+                purple_conv_im_write(PURPLE_CONV_IM(convo), &quot;&quot;, msg,
+                                   PURPLE_MESSAGE_SYSTEM |
+                                   PURPLE_MESSAGE_NO_LOG, time(NULL));
             g_free(msg);
             g_free(gaym-&gt;nameconv);
             gaym-&gt;nameconv = NULL;
@@ -503,7 +473,7 @@
             if (users != NULL) {
                 GList *l;
 
-                gaim_conv_chat_add_users(GAIM_CONV_CHAT(convo), users,
+                purple_conv_chat_add_users(PURPLE_CONV_CHAT(convo), users,
                                          NULL, NULL, FALSE);
 
                 for (l = users; l != NULL; l = l-&gt;next)
@@ -518,14 +488,14 @@
             gaym-&gt;names = g_string_new(&quot;&quot;);
             gaym-&gt;names = g_string_append(gaym-&gt;names, args[3]);
         }
-        gaim_debug_misc(&quot;names&quot;, &quot;Response: %s\n&quot;, args[3]);
+        purple_debug_misc(&quot;names&quot;, &quot;Response: %s\n&quot;, args[3]);
         GaymNamelist *nameslist = g_queue_peek_head(gaym-&gt;namelists);
         if (nameslist) {
             gchar **names = g_strsplit(args[3], &quot; &quot;, -1);
 
 
             int i = 0;
-            gaim_debug_misc(&quot;names&quot;,
+            purple_debug_misc(&quot;names&quot;,
                             &quot;names[i]: %s, nameslist-&gt;current: %x\n&quot;,
                             names[i], nameslist-&gt;current);
             while (names[i] &amp;&amp; strlen(names[i]) &amp;&amp; nameslist-&gt;current) {
@@ -547,30 +517,30 @@
 void gaym_msg_endmotd(struct gaym_conn *gaym, const char *name,
                       const char *from, char **args)
 {
-    GaimConnection *gc;
+    PurpleConnection *gc;
 
-    GaimBlistNode *gnode, *cnode, *bnode;
-    gaim_debug_misc(&quot;gaym&quot;, &quot;Got motd\n&quot;);
+    PurpleBlistNode *gnode, *cnode, *bnode;
+    purple_debug_misc(&quot;gaym&quot;, &quot;Got motd\n&quot;);
 
-    gc = gaim_account_get_connection(gaym-&gt;account);
+    gc = purple_account_get_connection(gaym-&gt;account);
     if (!gc) {
-        gaim_debug_misc(&quot;gaym&quot;, &quot;!gc ???\n&quot;);
+        purple_debug_misc(&quot;gaym&quot;, &quot;!gc ???\n&quot;);
         return;
     }
-    gaim_connection_set_state(gc, GAIM_CONNECTED);
+    purple_connection_set_state(gc, PURPLE_CONNECTED);
     // serv_finish_login(gc);
     /* this used to be in the core, but it's not now */
-    for (gnode = gaim_get_blist()-&gt;root; gnode; gnode = gnode-&gt;next) {
-        if (!GAIM_BLIST_NODE_IS_GROUP(gnode))
+    for (gnode = purple_get_blist()-&gt;root; gnode; gnode = gnode-&gt;next) {
+        if (!PURPLE_BLIST_NODE_IS_GROUP(gnode))
             continue;
         for (cnode = gnode-&gt;child; cnode; cnode = cnode-&gt;next) {
-            if (!GAIM_BLIST_NODE_IS_CONTACT(cnode))
+            if (!PURPLE_BLIST_NODE_IS_CONTACT(cnode))
                 continue;
             for (bnode = cnode-&gt;child; bnode; bnode = bnode-&gt;next) {
-                GaimBuddy *b;
-                if (!GAIM_BLIST_NODE_IS_BUDDY(bnode))
+                PurpleBuddy *b;
+                if (!PURPLE_BLIST_NODE_IS_BUDDY(bnode))
                     continue;
-                b = (GaimBuddy *) bnode;
+                b = (PurpleBuddy *) bnode;
                 if (b-&gt;account == gc-&gt;account) {
                     struct gaym_buddy *ib = g_new0(struct gaym_buddy, 1);
                     ib-&gt;name = g_strdup(b-&gt;name);
@@ -580,11 +550,11 @@
         }
     }
 
-    gaim_debug_misc(&quot;gaym&quot;, &quot;Calling blist timeout\n&quot;);
+    purple_debug_misc(&quot;gaym&quot;, &quot;Calling blist timeout\n&quot;);
     gaym_blist_timeout(gaym);
     if (!gaym-&gt;timer)
         gaym-&gt;timer =
-            gaim_timeout_add(BLIST_UPDATE_PERIOD,
+            purple_timeout_add(BLIST_UPDATE_PERIOD,
                              (GSourceFunc) gaym_blist_timeout,
                              (gpointer) gaym);
 }
@@ -592,40 +562,40 @@
 void gaym_msg_nochan(struct gaym_conn *gaym, const char *name,
                      const char *from, char **args)
 {
-    GaimConnection *gc = gaim_account_get_connection(gaym-&gt;account);
+    PurpleConnection *gc = purple_account_get_connection(gaym-&gt;account);
 
     if (gc == NULL || args == NULL || args[1] == NULL)
         return;
 
-    gaim_notify_error(gc, NULL, _(&quot;No such channel&quot;), args[1]);
+    purple_notify_error(gc, NULL, _(&quot;No such channel&quot;), args[1]);
 }
 
 void gaym_msg_nonick_chan(struct gaym_conn *gaym, const char *name,
                           const char *from, char **args)
 {
-    GaimConnection *gc = gaim_account_get_connection(gaym-&gt;account);
-    GaimConversation *convo;
+    PurpleConnection *gc = purple_account_get_connection(gaym-&gt;account);
+    PurpleConversation *convo;
 
     convo =
-        gaim_find_conversation_with_account(GAIM_CONV_TYPE_ANY, args[1],
+        purple_find_conversation_with_account(PURPLE_CONV_TYPE_ANY, args[1],
                                             gaym-&gt;account);
     if (convo) {
-        if (gaim_conversation_get_type(convo) == GAIM_CONV_TYPE_CHAT) {
+        if (purple_conversation_get_type(convo) == PURPLE_CONV_TYPE_CHAT) {
             /* does this happen? */
-            gaim_conv_chat_write(GAIM_CONV_CHAT(convo), args[1],
+            purple_conv_chat_write(PURPLE_CONV_CHAT(convo), args[1],
                                  _(&quot;no such channel&quot;),
-                                 GAIM_MESSAGE_SYSTEM | GAIM_MESSAGE_NO_LOG,
+                                 PURPLE_MESSAGE_SYSTEM | PURPLE_MESSAGE_NO_LOG,
                                  time(NULL));
         } else {
-            gaim_conv_im_write(GAIM_CONV_IM(convo), args[1],
+            purple_conv_im_write(PURPLE_CONV_IM(convo), args[1],
                                _(&quot;User is not logged in&quot;),
-                               GAIM_MESSAGE_SYSTEM | GAIM_MESSAGE_NO_LOG,
+                               PURPLE_MESSAGE_SYSTEM | PURPLE_MESSAGE_NO_LOG,
                                time(NULL));
         }
     } else {
-        if ((gc = gaim_account_get_connection(gaym-&gt;account)) == NULL)
+        if ((gc = purple_account_get_connection(gaym-&gt;account)) == NULL)
             return;
-        gaim_notify_error(gc, NULL, _(&quot;Not logged in: &quot;), args[1]);
+        purple_notify_error(gc, NULL, _(&quot;Not logged in: &quot;), args[1]);
     }
 
     if (gc == NULL || args == NULL || args[1] == NULL)
@@ -637,49 +607,49 @@
 void gaym_msg_nonick(struct gaym_conn *gaym, const char *name,
                      const char *from, char **args)
 {
-    GaimConnection *gc;
-    GaimConversation *convo;
+    PurpleConnection *gc;
+    PurpleConversation *convo;
 
     convo =
-        gaim_find_conversation_with_account(GAIM_CONV_TYPE_ANY, args[1],
+        purple_find_conversation_with_account(PURPLE_CONV_TYPE_ANY, args[1],
                                             gaym-&gt;account);
     if (convo) {
-        if (gaim_conversation_get_type(convo) == GAIM_CONV_TYPE_CHAT) {
+        if (purple_conversation_get_type(convo) == PURPLE_CONV_TYPE_CHAT) {
             /* does this happen? */
-            gaim_conv_chat_write(GAIM_CONV_CHAT(convo), args[1],
+            purple_conv_chat_write(PURPLE_CONV_CHAT(convo), args[1],
                                  _(&quot;no such channel&quot;),
-                                 GAIM_MESSAGE_SYSTEM | GAIM_MESSAGE_NO_LOG,
+                                 PURPLE_MESSAGE_SYSTEM | PURPLE_MESSAGE_NO_LOG,
                                  time(NULL));
         } else {
-            gaim_conv_im_write(GAIM_CONV_IM(convo), args[1],
+            purple_conv_im_write(PURPLE_CONV_IM(convo), args[1],
                                _(&quot;User is not logged in&quot;),
-                               GAIM_MESSAGE_SYSTEM | GAIM_MESSAGE_NO_LOG,
+                               PURPLE_MESSAGE_SYSTEM | PURPLE_MESSAGE_NO_LOG,
                                time(NULL));
         }
     } else {
-        if ((gc = gaim_account_get_connection(gaym-&gt;account)) == NULL)
+        if ((gc = purple_account_get_connection(gaym-&gt;account)) == NULL)
             return;
-        gaim_notify_error(gc, NULL, _(&quot;No such nick or channel&quot;), args[1]);
+        purple_notify_error(gc, NULL, _(&quot;No such nick or channel&quot;), args[1]);
     }
 }
 
 void gaym_msg_nosend(struct gaym_conn *gaym, const char *name,
                      const char *from, char **args)
 {
-    GaimConnection *gc;
-    GaimConversation *convo;
+    PurpleConnection *gc;
+    PurpleConversation *convo;
 
     convo =
-        gaim_find_conversation_with_account(GAIM_CONV_TYPE_CHAT, args[1],
+        purple_find_conversation_with_account(PURPLE_CONV_TYPE_CHAT, args[1],
                                             gaym-&gt;account);
     if (convo) {
-        gaim_conv_chat_write(GAIM_CONV_CHAT(convo), args[1], args[2],
-                             GAIM_MESSAGE_SYSTEM | GAIM_MESSAGE_NO_LOG,
+        purple_conv_chat_write(PURPLE_CONV_CHAT(convo), args[1], args[2],
+                             PURPLE_MESSAGE_SYSTEM | PURPLE_MESSAGE_NO_LOG,
                              time(NULL));
     } else {
-        if ((gc = gaim_account_get_connection(gaym-&gt;account)) == NULL)
+        if ((gc = purple_account_get_connection(gaym-&gt;account)) == NULL)
             return;
-        gaim_notify_error(gc, NULL, _(&quot;Could not send&quot;), args[2]);
+        purple_notify_error(gc, NULL, _(&quot;Could not send&quot;), args[2]);
     }
 }
 
@@ -689,18 +659,18 @@
 void gaym_msg_notinchan(struct gaym_conn *gaym, const char *name,
                         const char *from, char **args)
 {
-    GaimConversation *convo =
-        gaim_find_conversation_with_account(GAIM_CONV_TYPE_CHAT, args[1],
+    PurpleConversation *convo =
+        purple_find_conversation_with_account(PURPLE_CONV_TYPE_CHAT, args[1],
                                             gaym-&gt;account);
 
-    gaim_debug(GAIM_DEBUG_INFO, &quot;gaym&quot;,
+    purple_debug(PURPLE_DEBUG_INFO, &quot;gaym&quot;,
                &quot;We're apparently not in %s, but tried to use it\n&quot;,
                args[1]);
     if (convo) {
         /* g_slist_remove(gaym-&gt;gc-&gt;buddy_chats, convo);
-           gaim_conversation_set_account(convo, NULL); */
-        gaim_conv_chat_write(GAIM_CONV_CHAT(convo), args[1], args[2],
-                             GAIM_MESSAGE_SYSTEM | GAIM_MESSAGE_NO_LOG,
+           purple_conversation_set_account(convo, NULL); */
+        purple_conv_chat_write(PURPLE_CONV_CHAT(convo), args[1], args[2],
+                             PURPLE_MESSAGE_SYSTEM | PURPLE_MESSAGE_NO_LOG,
                              time(NULL));
     }
 }
@@ -711,7 +681,7 @@
 void gaym_msg_invite(struct gaym_conn *gaym, const char *name,
                      const char *from, char **args)
 {
-    GaimConnection *gc = gaim_account_get_connection(gaym-&gt;account);
+    PurpleConnection *gc = purple_account_get_connection(gaym-&gt;account);
     char *nick = gaym_mask_nick(from);
     GHashTable *components =
         g_hash_table_new_full(g_str_hash, g_str_equal, g_free, g_free);
@@ -738,7 +708,7 @@
 void gaym_msg_inviteonly(struct gaym_conn *gaym, const char *name,
                          const char *from, char **args)
 {
-    GaimConnection *gc = gaim_account_get_connection(gaym-&gt;account);
+    PurpleConnection *gc = purple_account_get_connection(gaym-&gt;account);
     char *buf;
 
     if (!args || !args[1] || !gc)
@@ -746,20 +716,20 @@
 
     buf =
         g_strdup_printf(_(&quot;Joining %s requires an invitation.&quot;), args[1]);
-    gaim_notify_error(gc, _(&quot;Invitation only&quot;), _(&quot;Invitation only&quot;), buf);
+    purple_notify_error(gc, _(&quot;Invitation only&quot;), _(&quot;Invitation only&quot;), buf);
     g_free(buf);
 }
 
 void gaym_msg_trace(struct gaym_conn *gaym, const char *name,
                     const char *from, char **args)
 {
-    GaimConversation *conv =
-        gaim_find_conversation_with_account(GAIM_CONV_TYPE_ANY,
+    PurpleConversation *conv =
+        purple_find_conversation_with_account(PURPLE_CONV_TYPE_ANY,
                                             gaym-&gt;traceconv ? gaym-&gt;
                                             traceconv : args[1],
                                             gaym-&gt;account);
-    gaim_conversation_write(conv, &quot;TRACE&quot;, args[3],
-                            GAIM_MESSAGE_SYSTEM | GAIM_MESSAGE_NO_LOG,
+    purple_conversation_write(conv, &quot;TRACE&quot;, args[3],
+                            PURPLE_MESSAGE_SYSTEM | PURPLE_MESSAGE_NO_LOG,
                             time(NULL));
 
 }
@@ -767,29 +737,29 @@
 void gaym_msg_join(struct gaym_conn *gaym, const char *name,
                    const char *from, char **args)
 {
-    gaim_debug_misc(&quot;join&quot;, &quot;got join for %s\n&quot;, args[0]);
-    GaimConnection *gc = gaim_account_get_connection(gaym-&gt;account);
+    purple_debug_misc(&quot;join&quot;, &quot;got join for %s\n&quot;, args[0]);
+    PurpleConnection *gc = purple_account_get_connection(gaym-&gt;account);
     g_return_if_fail(gc != NULL);
 
     char *nick = gaym_mask_nick(from);
 
-    GaimConversation *convo;
-    GaimConvChatBuddyFlags flags = GAIM_CBFLAGS_NONE;
+    PurpleConversation *convo;
+    PurpleConvChatBuddyFlags flags = PURPLE_CBFLAGS_NONE;
     char *bio = NULL;
     char *bio_markedup = NULL;
     static int id = 1;
 
     gcom_nick_to_gaym(nick);
-    if (!gaim_utf8_strcasecmp(nick, gaim_connection_get_display_name(gc))) {
+    if (!purple_utf8_strcasecmp(nick, purple_connection_get_display_name(gc))) {
         /* We are joining a channel for the first time */
 
         gpointer data, unused;
         gboolean hammering = g_hash_table_lookup_extended
             (gaym-&gt;hammers, args[0], &amp;unused, &amp;data);
         // There was a hammer, but it is cancelled. Leave!
-        gaim_debug_misc(&quot;join&quot;, &quot;Joined %s\n&quot;, args[0]);
+        purple_debug_misc(&quot;join&quot;, &quot;Joined %s\n&quot;, args[0]);
         if (hammering &amp;&amp; !data) {       // hammer was cancelled.
-            gaim_debug_misc(&quot;gaym&quot;,
+            purple_debug_misc(&quot;gaym&quot;,
                             &quot;JOINED, BUT HAMMER CANCELLED: ABORT!!!!\n&quot;);
             g_hash_table_remove(gaym-&gt;hammers, args[0]);
             gaym_cmd_part(gaym, NULL, NULL, (const char **) args);
@@ -808,10 +778,10 @@
     }
 
     convo =
-        gaim_find_conversation_with_account(GAIM_CONV_TYPE_ANY, args[0],
+        purple_find_conversation_with_account(PURPLE_CONV_TYPE_ANY, args[0],
                                             gaym-&gt;account);
     if (convo == NULL) {
-        gaim_debug(GAIM_DEBUG_ERROR, &quot;gaym&quot;, &quot;JOIN for %s failed\n&quot;,
+        purple_debug(PURPLE_DEBUG_ERROR, &quot;gaym&quot;, &quot;JOIN for %s failed\n&quot;,
                    args[0]);
         g_free(nick);
         return;
@@ -828,7 +798,7 @@
 
     bio = gaym_bio_strdup(args[1]);
     if (bio) {
-        bio_markedup = gaim_markup_linkify(bio);
+        bio_markedup = purple_markup_linkify(bio);
         g_free(bio);
     }
 
@@ -841,15 +811,15 @@
 
     gboolean gaym_privacy_permit = gaym_privacy_check(gc, nick);
     gboolean show_join =
-        gaim_prefs_get_bool(&quot;/plugins/prpl/gaym/show_join&quot;);
+        purple_prefs_get_bool(&quot;/plugins/prpl/gaym/show_join&quot;);
 
-    if (gaim_prefs_get_bool(&quot;/plugins/prpl/gaym/show_bio_with_join&quot;)) {
-        gaim_conv_chat_add_user(GAIM_CONV_CHAT(convo), nick, bio_markedup,
+    if (purple_prefs_get_bool(&quot;/plugins/prpl/gaym/show_bio_with_join&quot;)) {
+        purple_conv_chat_add_user(PURPLE_CONV_CHAT(convo), nick, bio_markedup,
                                 flags, (gaym_privacy_permit
                                         &amp;&amp; gaym_botfilter_permit
                                         &amp;&amp; show_join));
     } else {
-        gaim_conv_chat_add_user(GAIM_CONV_CHAT(convo), nick, NULL,
+        purple_conv_chat_add_user(PURPLE_CONV_CHAT(convo), nick, NULL,
                                 flags, (gaym_privacy_permit
                                         &amp;&amp; gaym_botfilter_permit
                                         &amp;&amp; show_join));
@@ -858,11 +828,11 @@
     /**
      * Make the ignore.png icon appear next to the nick.
      */
-    GaimConversationUiOps *ops = gaim_conversation_get_ui_ops(convo);
+    PurpleConversationUiOps *ops = purple_conversation_get_ui_ops(convo);
     if (gaym_privacy_permit &amp;&amp; gaym_botfilter_permit) {
-        gaim_conv_chat_unignore(GAIM_CONV_CHAT(convo), nick);
+        purple_conv_chat_unignore(PURPLE_CONV_CHAT(convo), nick);
     } else {
-        gaim_conv_chat_ignore(GAIM_CONV_CHAT(convo), nick);
+        purple_conv_chat_ignore(PURPLE_CONV_CHAT(convo), nick);
     }
     ops-&gt;chat_update_user((convo), nick);
 
@@ -874,15 +844,15 @@
 void gaym_msg_mode(struct gaym_conn *gaym, const char *name,
                    const char *from, char **args)
 {
-    GaimConversation *convo;
+    PurpleConversation *convo;
     char *nick = gaym_mask_nick(from), *buf;
 
     if (*args[0] == '#' || *args[0] == '&amp;') {   /* Channel */
         convo =
-            gaim_find_conversation_with_account(GAIM_CONV_TYPE_ANY,
+            purple_find_conversation_with_account(PURPLE_CONV_TYPE_ANY,
                                                 args[0], gaym-&gt;account);
         if (!convo) {
-            gaim_debug(GAIM_DEBUG_ERROR, &quot;gaym&quot;,
+            purple_debug(PURPLE_DEBUG_ERROR, &quot;gaym&quot;,
                        &quot;MODE received for %s, which we are not in\n&quot;,
                        args[0]);
             g_free(nick);
@@ -891,12 +861,12 @@
         buf =
             g_strdup_printf(_(&quot;mode (%s %s) by %s&quot;), args[1],
                             args[2] ? args[2] : &quot;&quot;, nick);
-        gaim_conv_chat_write(GAIM_CONV_CHAT(convo), args[0], buf,
-                             GAIM_MESSAGE_SYSTEM | GAIM_MESSAGE_NO_LOG,
+        purple_conv_chat_write(PURPLE_CONV_CHAT(convo), args[0], buf,
+                             PURPLE_MESSAGE_SYSTEM | PURPLE_MESSAGE_NO_LOG,
                              time(NULL));
         g_free(buf);
         if (args[2]) {
-            GaimConvChatBuddyFlags newflag, flags;
+            PurpleConvChatBuddyFlags newflag, flags;
             char *mcur, *cur, *end, *user;
             gboolean add = FALSE;
             mcur = args[1];
@@ -912,21 +882,21 @@
                     end = cur + strlen(cur);
                 user = g_strndup(cur, end - cur);
                 flags =
-                    gaim_conv_chat_user_get_flags(GAIM_CONV_CHAT(convo),
+                    purple_conv_chat_user_get_flags(PURPLE_CONV_CHAT(convo),
                                                   user);
-                newflag = GAIM_CBFLAGS_NONE;
+                newflag = PURPLE_CBFLAGS_NONE;
                 if (*mcur == 'o')
-                    newflag = GAIM_CBFLAGS_OP;
+                    newflag = PURPLE_CBFLAGS_OP;
                 else if (*mcur == 'h')
-                    newflag = GAIM_CBFLAGS_HALFOP;
+                    newflag = PURPLE_CBFLAGS_HALFOP;
                 else if (*mcur == 'v')
-                    newflag = GAIM_CBFLAGS_VOICE;
+                    newflag = PURPLE_CBFLAGS_VOICE;
                 if (newflag) {
                     if (add)
                         flags |= newflag;
                     else
                         flags &amp;= ~newflag;
-                    gaim_conv_chat_user_set_flags(GAIM_CONV_CHAT(convo),
+                    purple_conv_chat_user_set_flags(PURPLE_CONV_CHAT(convo),
                                                   user, flags);
                 }
                 g_free(user);
@@ -947,7 +917,7 @@
 {
     GSList *chats;
 
-    GaimConnection *gc = gaim_account_get_connection(gaym-&gt;account);
+    PurpleConnection *gc = purple_account_get_connection(gaym-&gt;account);
     char *nick = gaym_mask_nick(from);
 
     if (!gc) {
@@ -957,15 +927,15 @@
 
     chats = gc-&gt;buddy_chats;
 
-    if (!gaim_utf8_strcasecmp(nick, gaim_connection_get_display_name(gc))) {
-        gaim_connection_set_display_name(gc, args[0]);
+    if (!purple_utf8_strcasecmp(nick, purple_connection_get_display_name(gc))) {
+        purple_connection_set_display_name(gc, args[0]);
     }
 
     while (chats) {
-        GaimConvChat *chat = GAIM_CONV_CHAT(chats-&gt;data);
+        PurpleConvChat *chat = PURPLE_CONV_CHAT(chats-&gt;data);
         /* This is ugly ... */
-        if (gaim_conv_chat_find_user(chat, nick))
-            gaim_conv_chat_rename_user(chat, nick, args[0]);
+        if (purple_conv_chat_find_user(chat, nick))
+            purple_conv_chat_rename_user(chat, nick, args[0]);
         chats = chats-&gt;next;
     }
     g_free(nick);
@@ -974,7 +944,7 @@
 void gaym_msg_notice(struct gaym_conn *gaym, const char *name,
                      const char *from, char **args)
 {
-    GaimConnection *gc = gaim_account_get_connection(gaym-&gt;account);
+    PurpleConnection *gc = purple_account_get_connection(gaym-&gt;account);
 
     if (!gc) {
         return;
@@ -990,10 +960,10 @@
 void gaym_msg_part(struct gaym_conn *gaym, const char *name,
                    const char *from, char **args)
 {
-    GaimConversation *convo;
+    PurpleConversation *convo;
     char *msg;
 
-    GaimConnection *gc = gaim_account_get_connection(gaym-&gt;account);
+    PurpleConnection *gc = purple_account_get_connection(gaym-&gt;account);
     char *nick = gaym_mask_nick(from);
 
     if (!args || !args[0] || !gc || !nick) {
@@ -1002,43 +972,43 @@
     }
 
     convo =
-        gaim_find_conversation_with_account(GAIM_CONV_TYPE_ANY, args[0],
+        purple_find_conversation_with_account(PURPLE_CONV_TYPE_ANY, args[0],
                                             gaym-&gt;account);
     gboolean show_part =
-        gaim_prefs_get_bool(&quot;/plugins/prpl/gaym/show_part&quot;);
+        purple_prefs_get_bool(&quot;/plugins/prpl/gaym/show_part&quot;);
 
     gcom_nick_to_gaym(nick);
-    if (!gaim_utf8_strcasecmp(nick, gaim_connection_get_display_name(gc))) {
+    if (!purple_utf8_strcasecmp(nick, purple_connection_get_display_name(gc))) {
 
         g_hash_table_remove(gaym-&gt;entry_order, args[0]);
         msg = g_strdup_printf(_(&quot;You have parted the channel&quot;));
 
-        gaim_conv_chat_write(GAIM_CONV_CHAT(convo), args[0], msg,
-                             GAIM_MESSAGE_SYSTEM, time(NULL));
+        purple_conv_chat_write(PURPLE_CONV_CHAT(convo), args[0], msg,
+                             PURPLE_MESSAGE_SYSTEM, time(NULL));
         g_free(msg);
         serv_got_chat_left(gc,
-                           gaim_conv_chat_get_id(GAIM_CONV_CHAT(convo)));
+                           purple_conv_chat_get_id(PURPLE_CONV_CHAT(convo)));
     } else {
-        if (!gaim_conv_chat_is_user_ignored(GAIM_CONV_CHAT(convo), nick)
+        if (!purple_conv_chat_is_user_ignored(PURPLE_CONV_CHAT(convo), nick)
             &amp;&amp; show_part) {
-            gaim_conv_chat_remove_user(GAIM_CONV_CHAT(convo), nick, NULL);
+            purple_conv_chat_remove_user(PURPLE_CONV_CHAT(convo), nick, NULL);
         } else {
-            GaimConversationUiOps *ops =
-                gaim_conversation_get_ui_ops(convo);
+            PurpleConversationUiOps *ops =
+                purple_conversation_get_ui_ops(convo);
             if (ops != NULL &amp;&amp; ops-&gt;chat_remove_users != NULL) {
 		GList* users = g_list_append(NULL, (char*)nick);
                 ops-&gt;chat_remove_users(convo, users);
             }
-            GaimConvChatBuddy *cb =
-                gaim_conv_chat_cb_find(GAIM_CONV_CHAT(convo), nick);
+            PurpleConvChatBuddy *cb =
+                purple_conv_chat_cb_find(PURPLE_CONV_CHAT(convo), nick);
             if (cb) {
-                gaim_conv_chat_set_users(GAIM_CONV_CHAT(convo),
+                purple_conv_chat_set_users(PURPLE_CONV_CHAT(convo),
                                          g_list_remove
-                                         (gaim_conv_chat_get_users
-                                          (GAIM_CONV_CHAT(convo)), cb));
-                gaim_conv_chat_cb_destroy(cb);
+                                         (purple_conv_chat_get_users
+                                          (PURPLE_CONV_CHAT(convo)), cb));
+                purple_conv_chat_cb_destroy(cb);
                 if (!gaym_unreference_channel_member(gaym, nick))
-                    gaim_debug_error(&quot;gaym&quot;,
+                    purple_debug_error(&quot;gaym&quot;,
                                      &quot;channel_members reference counting bug.\n&quot;);
             }
         }
@@ -1062,8 +1032,8 @@
 void gaym_msg_pong(struct gaym_conn *gaym, const char *name,
                    const char *from, char **args)
 {
-    GaimConversation *convo;
-    GaimConnection *gc;
+    PurpleConversation *convo;
+    PurpleConnection *gc;
     char **parts, *msg;
     time_t oldstamp;
 
@@ -1086,25 +1056,25 @@
     }
 
     convo =
-        gaim_find_conversation_with_account(GAIM_CONV_TYPE_ANY, parts[0],
+        purple_find_conversation_with_account(PURPLE_CONV_TYPE_ANY, parts[0],
                                             gaym-&gt;account);
     g_strfreev(parts);
     if (convo) {
-        if (gaim_conversation_get_type(convo) == GAIM_CONV_TYPE_CHAT)
-            gaim_conv_chat_write(GAIM_CONV_CHAT(convo), &quot;PONG&quot;, msg,
-                                 GAIM_MESSAGE_SYSTEM | GAIM_MESSAGE_NO_LOG,
+        if (purple_conversation_get_type(convo) == PURPLE_CONV_TYPE_CHAT)
+            purple_conv_chat_write(PURPLE_CONV_CHAT(convo), &quot;PONG&quot;, msg,
+                                 PURPLE_MESSAGE_SYSTEM | PURPLE_MESSAGE_NO_LOG,
                                  time(NULL));
         else
-            gaim_conv_im_write(GAIM_CONV_IM(convo), &quot;PONG&quot;, msg,
-                               GAIM_MESSAGE_SYSTEM | GAIM_MESSAGE_NO_LOG,
+            purple_conv_im_write(PURPLE_CONV_IM(convo), &quot;PONG&quot;, msg,
+                               PURPLE_MESSAGE_SYSTEM | PURPLE_MESSAGE_NO_LOG,
                                time(NULL));
     } else {
-        gc = gaim_account_get_connection(gaym-&gt;account);
+        gc = purple_account_get_connection(gaym-&gt;account);
         if (!gc) {
             g_free(msg);
             return;
         }
-        gaim_notify_info(gc, NULL, &quot;PONG&quot;, msg);
+        purple_notify_info(gc, NULL, &quot;PONG&quot;, msg);
     }
     g_free(msg);
 }
@@ -1112,11 +1082,11 @@
 void gaym_msg_privmsg(struct gaym_conn *gaym, const char *name,
                       const char *from, char **args)
 {
-    GaimConversation *convo;
+    PurpleConversation *convo;
     char *tmp=0, *msg=0;
     int notice = 0;
 
-    GaimConnection *gc = gaim_account_get_connection(gaym-&gt;account);
+    PurpleConnection *gc = purple_account_get_connection(gaym-&gt;account);
     char *nick = gaym_mask_nick(from);
 
     if (!args || !args[0] || !args[1] || !gc) {
@@ -1153,7 +1123,7 @@
     }
 
     convo =
-        gaim_find_conversation_with_account(GAIM_CONV_TYPE_ANY, args[0],
+        purple_find_conversation_with_account(PURPLE_CONV_TYPE_ANY, args[0],
                                             gaym-&gt;account);
 
     notice = !strcmp(args[0], &quot; notice &quot;);
@@ -1180,17 +1150,17 @@
         msg = tmp;
     }
 
-    if (!gaim_utf8_strcasecmp
-        (args[0], gaim_connection_get_display_name(gc))) {
+    if (!purple_utf8_strcasecmp
+        (args[0], purple_connection_get_display_name(gc))) {
         serv_got_im(gc, nick, msg, 0, time(NULL));
     } else if (notice) {
         serv_got_im(gc, nick, msg, 0, time(NULL));
     } else if (convo) {
 
-        serv_got_chat_in(gc, gaim_conv_chat_get_id(GAIM_CONV_CHAT(convo)),
+        serv_got_chat_in(gc, purple_conv_chat_get_id(PURPLE_CONV_CHAT(convo)),
                          nick, 0, msg, time(NULL));
     } else {
-        gaim_debug(GAIM_DEBUG_ERROR, &quot;gaym&quot;,
+        purple_debug(PURPLE_DEBUG_ERROR, &quot;gaym&quot;,
                    &quot;Got a PRIVMSG on %s, which does not exist\n&quot;, args[0]);
     }
 
@@ -1201,14 +1171,14 @@
 void gaym_msg_regonly(struct gaym_conn *gaym, const char *name,
                       const char *from, char **args)
 {
-    GaimConnection *gc = gaim_account_get_connection(gaym-&gt;account);
+    PurpleConnection *gc = purple_account_get_connection(gaym-&gt;account);
     char *msg;
 
     if (!args || !args[1] || !args[2] || !gc)
         return;
 
     msg = g_strdup_printf(_(&quot;Cannot join %s:&quot;), args[1]);
-    gaim_notify_error(gc, _(&quot;Cannot join channel&quot;), msg, args[2]);
+    purple_notify_error(gc, _(&quot;Cannot join channel&quot;), msg, args[2]);
     g_free(msg);
 }
 
@@ -1216,7 +1186,7 @@
 void gaym_msg_quit(struct gaym_conn *gaym, const char *name,
                    const char *from, char **args)
 {
-    GaimConnection *gc = gaim_account_get_connection(gaym-&gt;account);
+    PurpleConnection *gc = purple_account_get_connection(gaym-&gt;account);
     char *data[2];
 
     if (!args || !args[0] || !gc)
@@ -1253,7 +1223,7 @@
         // Because the names parsing section terminates on a &quot;names&quot; from 
         // The exact channel name match.
         if (g_str_has_suffix(args[1], &quot;=*&quot;)) {
-            gaim_debug_misc(&quot;who&quot;,
+            purple_debug_misc(&quot;who&quot;,
                             &quot;Has a =* suffix, sending out one more namescmd \n&quot;);
             const char *cmdargs[1] = { args[1] };
             gaym_cmd_names(gaym, NULL, NULL, cmdargs);
@@ -1303,7 +1273,7 @@
             return;
         val = g_ascii_digit_value(*(++pos));
         if (val != nameslist-&gt;num_rooms) {
-            gaim_debug_misc(&quot;msgs&quot;, &quot;*******NEXT ROOM******\n&quot;);
+            purple_debug_misc(&quot;msgs&quot;, &quot;*******NEXT ROOM******\n&quot;);
             const char *cmdargs[1] = { args[1] };
             gaym_cmd_names(gaym, NULL, NULL, cmdargs);
             nameslist-&gt;num_rooms = val;
@@ -1320,10 +1290,10 @@
 {
     struct hammer_cb_data *hdata = (struct hammer_cb_data *) data;
 
-    gaim_debug_misc(&quot;gaym&quot;, &quot;hammer stopped, dialog is %x\n&quot;,
+    purple_debug_misc(&quot;gaym&quot;, &quot;hammer stopped, dialog is %x\n&quot;,
                     hdata-&gt;cancel_dialog);
     // This destroys the hammer data!
-    gaim_debug_misc(&quot;gaym&quot;, &quot;Cancelling hammer: %s\n&quot;, hdata-&gt;room);
+    purple_debug_misc(&quot;gaym&quot;, &quot;Cancelling hammer: %s\n&quot;, hdata-&gt;room);
     // I'm not sure if the dialog data is freed. 
     // For now, I assume not. 
     // hdata-&gt;cancel_dialog=0;
@@ -1337,7 +1307,7 @@
     if (!hdata)
         return;
     if (hdata-&gt;cancel_dialog)
-        gaim_request_close(GAIM_REQUEST_ACTION, hdata-&gt;cancel_dialog);
+        purple_request_close(PURPLE_REQUEST_ACTION, hdata-&gt;cancel_dialog);
     if (hdata-&gt;room)
         g_free(hdata-&gt;room);
     g_free(hdata);
@@ -1357,8 +1327,8 @@
     char *msg;
     msg = g_strdup_printf(&quot;Hammering into room %s&quot;, hdata-&gt;room);
     hdata-&gt;cancel_dialog =
-        gaim_request_action(hdata-&gt;gaym-&gt;account-&gt;gc, _(&quot;Cancel Hammer&quot;),
-                            msg, NULL, 0, hdata, 1, (&quot;Cancel&quot;),
+        purple_request_action(hdata-&gt;gaym-&gt;account-&gt;gc, _(&quot;Hammering...&quot;),
+                            msg, NULL, 0, NULL, hdata-&gt;room, NULL, hdata, 1, (&quot;Cancel&quot;),
                             hammer_stop_cb);
     g_hash_table_insert(hdata-&gt;gaym-&gt;hammers, g_strdup(hdata-&gt;room),
                         hdata);
@@ -1371,8 +1341,8 @@
 void gaym_msg_chanfull(struct gaym_conn *gaym, const char *name,
                        const char *from, char **args)
 {
-    GaimConnection *gc = gaim_account_get_connection(gaym-&gt;account);
-    char *buf;
+    PurpleConnection *gc = purple_account_get_connection(gaym-&gt;account);
+    gchar *buf;
     const char *joinargs[1];
 
     if (!args || !args[1] || !gc)
@@ -1389,18 +1359,16 @@
         // Add delay here?
         gaym_cmd_join(gaym, NULL, NULL, joinargs);
     } else if (hammering &amp;&amp; !data) {    // hammer was cancelled.
-        gaim_debug_misc(&quot;gaym&quot;, &quot;HAMMER CANCELLED ON FULL MESSAGE\n&quot;);
+        purple_debug_misc(&quot;gaym&quot;, &quot;HAMMER CANCELLED ON FULL MESSAGE\n&quot;);
         g_hash_table_remove(gaym-&gt;hammers, args[1]);
     } else {
-        buf =
-            g_strdup_printf(&quot;%s is full. Do you want to keep trying?&quot;,
-                            args[1]);
+        buf = g_strdup_printf(&quot;%s is full. Do you want to keep trying?&quot;, args[1]);
         struct hammer_cb_data *hdata = g_new0(struct hammer_cb_data, 1);
         hdata-&gt;gaym = gaym;
         hdata-&gt;room = g_strdup(args[1]);
         hdata-&gt;cancel_dialog = NULL;
-        gaim_request_yes_no(gc, _(&quot;Room Full&quot;), _(&quot;Room Full&quot;), buf, 0,
-                            hdata, hammer_cb_yes, hammer_cb_no);
+        purple_request_yes_no(gc, _(&quot;Room Full&quot;), _(&quot;Room Full&quot;), buf, 0,
+                            NULL,NULL,NULL,hdata, hammer_cb_yes, hammer_cb_no);
 
         g_free(buf);
     }
@@ -1410,13 +1378,13 @@
 void gaym_msg_create_pay_only(struct gaym_conn *gaym, const char *name,
                               const char *from, char **args)
 {
-    GaimConnection *gc = gaim_account_get_connection(gaym-&gt;account);
+    PurpleConnection *gc = purple_account_get_connection(gaym-&gt;account);
     char *buf;
     if (!args || !args[1] || !gc) {
         return;
     }
     buf = g_strdup_printf(_(&quot;%s&quot;), args[2]);
-    gaim_notify_error(gc, _(&quot;Pay Only&quot;), _(&quot;Pay Only&quot;), buf);
+    purple_notify_error(gc, _(&quot;Pay Only&quot;), _(&quot;Pay Only&quot;), buf);
     /**
      * FIXME
      * by now the chatroom is already in the buddy list...need
@@ -1428,7 +1396,7 @@
 void gaym_msg_pay_channel(struct gaym_conn *gaym, const char *name,
                           const char *from, char **args)
 {
-    GaimConnection *gc = gaim_account_get_connection(gaym-&gt;account);
+    PurpleConnection *gc = purple_account_get_connection(gaym-&gt;account);
     char *buf;
 
     if (!args || !args[1] || !gc)
@@ -1437,14 +1405,14 @@
     buf =
         g_strdup_printf(_(&quot;The channel %s is for paying members only.&quot;),
                         args[1]);
-    gaim_notify_error(gc, _(&quot;Pay Only&quot;), _(&quot;Pay Only&quot;), buf);
+    purple_notify_error(gc, _(&quot;Pay Only&quot;), _(&quot;Pay Only&quot;), buf);
     g_free(buf);
 }
 
 void gaym_msg_toomany_channels(struct gaym_conn *gaym, const char *name,
                                const char *from, char **args)
 {
-    GaimConnection *gc = gaim_account_get_connection(gaym-&gt;account);
+    PurpleConnection *gc = purple_account_get_connection(gaym-&gt;account);
     char *buf;
 
     if (!args || !args[1] || !gc)
@@ -1454,7 +1422,7 @@
         g_strdup_printf(_
                         (&quot;You have joined too many channels the maximum is (2). You cannot join channel %s. Part another channel first .&quot;),
                         args[1]);
-    gaim_notify_error(gc, _(&quot;Maximum ChannelsReached&quot;),
+    purple_notify_error(gc, _(&quot;Maximum ChannelsReached&quot;),
                       _(&quot;Maximum ChannelsReached&quot;), buf);
     g_free(buf);
 }
@@ -1462,15 +1430,15 @@
 void gaym_msg_list_busy(struct gaym_conn *gaym, const char *name,
                         const char *from, char **args)
 {
-    GaimConnection *gc = gaim_account_get_connection(gaym-&gt;account);
+    PurpleConnection *gc = purple_account_get_connection(gaym-&gt;account);
     char *buf;
     if (!args || !args[1] || !gc) {
         return;
     }
     buf = g_strdup_printf(_(&quot;%s&quot;), args[1]);
-    gaim_notify_error(gc, _(&quot;Server Busy&quot;), _(&quot;Server Busy&quot;), buf);
+    purple_notify_error(gc, _(&quot;Server Busy&quot;), _(&quot;Server Busy&quot;), buf);
     // if (gaym-&gt;roomlist) {
-    // gaim_roomlist_cancel_get_list(gaym-&gt;roomlist);
+    // purple_roomlist_cancel_get_list(gaym-&gt;roomlist);
     // }
     g_free(buf);
     /**
@@ -1490,9 +1458,9 @@
 void gaym_msg_richnames_list(struct gaym_conn *gaym, const char *name,
                              const char *from, char **args)
 {
-    GaimConnection *gc = gaim_account_get_connection(gaym-&gt;account);
-    GaimConversation *convo;
-    GaimConvChatBuddyFlags flags = GAIM_CBFLAGS_NONE;
+    PurpleConnection *gc = purple_account_get_connection(gaym-&gt;account);
+    PurpleConversation *convo;
+    PurpleConvChatBuddyFlags flags = PURPLE_CBFLAGS_NONE;
     char *channel = args[1];
     char *nick = args[2];
     char *extra = args[4];
@@ -1502,12 +1470,12 @@
     }
 
     gcom_nick_to_gaym(nick);
-    gaim_debug(GAIM_DEBUG_INFO, &quot;gaym&quot;,
+    purple_debug(PURPLE_DEBUG_INFO, &quot;gaym&quot;,
                &quot;gaym_msg_richnames_list() Channel: %s Nick: %s Extra: %s\n&quot;,
                channel, nick, extra);
 
     convo =
-        gaim_find_conversation_with_account(GAIM_CONV_TYPE_ANY, channel,
+        purple_find_conversation_with_account(PURPLE_CONV_TYPE_ANY, channel,
                                             gaym-&gt;account);
 
     char *bio = gaym_bio_strdup(extra);
@@ -1518,7 +1486,7 @@
     gaym_buddy_status(gaym, nick, TRUE, extra, FALSE);
 
     if (convo == NULL) {
-        gaim_debug(GAIM_DEBUG_ERROR, &quot;gaym&quot;, &quot;690 for %s failed\n&quot;,
+        purple_debug(PURPLE_DEBUG_ERROR, &quot;gaym&quot;, &quot;690 for %s failed\n&quot;,
                    args[1]);
         return;
     }
@@ -1529,17 +1497,17 @@
     flags = chat_pecking_order(extra);
     flags = include_chat_entry_order(flags, (*entry)--);
 
-    gaim_conv_chat_add_user(GAIM_CONV_CHAT(convo), nick, NULL, flags,
+    purple_conv_chat_add_user(PURPLE_CONV_CHAT(convo), nick, NULL, flags,
                             FALSE);
 
     /**
      * Make the ignore.png icon appear next to the nick.
      */
-    GaimConversationUiOps *ops = gaim_conversation_get_ui_ops(convo);
+    PurpleConversationUiOps *ops = purple_conversation_get_ui_ops(convo);
     if (gaym_privacy_check(gc, nick) &amp;&amp; gaym_botfilter_permit) {
-        gaim_conv_chat_unignore(GAIM_CONV_CHAT(convo), nick);
+        purple_conv_chat_unignore(PURPLE_CONV_CHAT(convo), nick);
     } else {
-        gaim_conv_chat_ignore(GAIM_CONV_CHAT(convo), nick);
+        purple_conv_chat_ignore(PURPLE_CONV_CHAT(convo), nick);
     }
     ops-&gt;chat_update_user((convo), nick);
     gaym_update_channel_member(gaym, nick, extra);

Modified: qrc/trunk/gaym/src/parse.c
===================================================================
--- qrc/trunk/gaym/src/parse.c	2007-07-13 19:53:50 UTC (rev 296)
+++ qrc/trunk/gaym/src/parse.c	2007-07-14 04:26:09 UTC (rev 297)
@@ -1,7 +1,7 @@
 /**
  * @file parse.c
  *
- * gaim
+ * purple
  *
  * Copyright (C) 2003, Ethan Blanton &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/qrc-svn">eblanton at cs.purdue.edu</A>&gt;
  *
@@ -198,38 +198,38 @@
 
 };
 
-static GaimCmdRet gaym_parse_gaim_cmd(GaimConversation * conv,
+static PurpleCmdRet gaym_parse_purple_cmd(PurpleConversation * conv,
                                       const gchar * cmd, gchar ** args,
                                       gchar ** error, void *data)
 {
-    GaimConnection *gc;
+    PurpleConnection *gc;
     struct gaym_conn *gaym;
     struct _gaym_user_cmd *cmdent;
 
-    gc = gaim_conversation_get_gc(conv);
+    gc = purple_conversation_get_gc(conv);
     if (!gc)
-        return GAIM_CMD_RET_FAILED;
+        return PURPLE_CMD_RET_FAILED;
 
     gaym = gc-&gt;proto_data;
 
     if ((cmdent = g_hash_table_lookup(gaym-&gt;cmds, cmd)) == NULL)
-        return GAIM_CMD_RET_FAILED;
+        return PURPLE_CMD_RET_FAILED;
 
-    (cmdent-&gt;cb) (gaym, cmd, gaim_conversation_get_name(conv),
+    (cmdent-&gt;cb) (gaym, cmd, purple_conversation_get_name(conv),
                   (const char **) args);
 
-    return GAIM_CMD_RET_OK;
+    return PURPLE_CMD_RET_OK;
 }
 
 static void gaym_register_command(struct _gaym_user_cmd *c)
 {
-    GaimCmdFlag f;
+    PurpleCmdFlag f;
     char args[10];
     char *format;
     int i;
 
-    f = GAIM_CMD_FLAG_CHAT | GAIM_CMD_FLAG_IM | GAIM_CMD_FLAG_PRPL_ONLY
-        | GAIM_CMD_FLAG_ALLOW_WRONG_ARGS;
+    f = PURPLE_CMD_FLAG_CHAT | PURPLE_CMD_FLAG_IM | PURPLE_CMD_FLAG_PRPL_ONLY
+        | PURPLE_CMD_FLAG_ALLOW_WRONG_ARGS;
 
     format = c-&gt;format;
 
@@ -249,8 +249,8 @@
 
     args[i] = '\0';
 
-    gaim_cmd_register(c-&gt;name, args, GAIM_CMD_P_PRPL, f, &quot;prpl-gaym&quot;,
-                      gaym_parse_gaim_cmd, _(c-&gt;help), NULL);
+    purple_cmd_register(c-&gt;name, args, PURPLE_CMD_P_PRPL, f, &quot;prpl-gaym&quot;,
+                      gaym_parse_purple_cmd, _(c-&gt;help), NULL);
 }
 
 void gaym_register_commands(void)
@@ -268,7 +268,7 @@
     const gchar *charset;
 
     charset =
-        gaim_account_get_string(gaym-&gt;account, &quot;encoding&quot;,
+        purple_account_get_string(gaym-&gt;account, &quot;encoding&quot;,
                                 IRC_DEFAULT_CHARSET);
     if (!strcasecmp(&quot;UTF-8&quot;, charset))
         return g_strdup(string);
@@ -277,9 +277,9 @@
         g_convert(string, strlen(string), charset, &quot;UTF-8&quot;, NULL, NULL,
                   &amp;err);
     if (err) {
-        gaim_debug(GAIM_DEBUG_ERROR, &quot;gaym&quot;, &quot;Send conversion error: %s\n&quot;,
+        purple_debug(PURPLE_DEBUG_ERROR, &quot;gaym&quot;, &quot;Send conversion error: %s\n&quot;,
                    err-&gt;message);
-        gaim_debug(GAIM_DEBUG_ERROR, &quot;gaym&quot;,
+        purple_debug(PURPLE_DEBUG_ERROR, &quot;gaym&quot;,
                    &quot;Sending as UTF-8 instead of %s\n&quot;, charset);
         utf8 = g_strdup(string);
         g_error_free(err);
@@ -295,7 +295,7 @@
     const gchar *charset;
 
     charset =
-        gaim_account_get_string(gaym-&gt;account, &quot;encoding&quot;,
+        purple_account_get_string(gaym-&gt;account, &quot;encoding&quot;,
                                 IRC_DEFAULT_CHARSET);
 
     if (!strcasecmp(&quot;UTF-8&quot;, charset)) {
@@ -308,7 +308,7 @@
     }
 
     if (err) {
-        gaim_debug(GAIM_DEBUG_ERROR, &quot;gaym&quot;, &quot;recv conversion error: %s\n&quot;,
+        purple_debug(PURPLE_DEBUG_ERROR, &quot;gaym&quot;, &quot;recv conversion error: %s\n&quot;,
                    err-&gt;message);
         g_error_free(err);
     }
@@ -325,7 +325,7 @@
 char *gaym_parse_ctcp(struct gaym_conn *gaym, const char *from,
                       const char *to, const char *msg, int notice)
 {
-    GaimConnection *gc;
+    PurpleConnection *gc;
     const char *cur = msg + 1;
     char *buf, *ctcp;
     time_t timestamp;
@@ -345,25 +345,25 @@
     } else if (!strncmp(cur, &quot;PING &quot;, 5)) {
         if (notice) {           /* reply */
             sscanf(cur, &quot;PING %lu&quot;, &amp;timestamp);
-            gc = gaim_account_get_connection(gaym-&gt;account);
+            gc = purple_account_get_connection(gaym-&gt;account);
             if (!gc)
                 return NULL;
             buf =
                 g_strdup_printf(_(&quot;Reply time from %s: %lu seconds&quot;), from,
                                 time(NULL) - timestamp);
-            gaim_notify_info(gc, _(&quot;PONG&quot;), _(&quot;CTCP PING reply&quot;), buf);
+            purple_notify_info(gc, _(&quot;PONG&quot;), _(&quot;CTCP PING reply&quot;), buf);
             g_free(buf);
             return NULL;
         } else {
             buf = gaym_format(gaym, &quot;vt:&quot;, &quot;NOTICE&quot;, from, msg);
             gaym_send(gaym, buf);
             g_free(buf);
-            gc = gaim_account_get_connection(gaym-&gt;account);
+            gc = purple_account_get_connection(gaym-&gt;account);
         }
     } else if (!strncmp(cur, &quot;VERSION&quot;, 7) &amp;&amp; !notice) {
         buf =
             gaym_format(gaym, &quot;vt:&quot;, &quot;NOTICE&quot;, from,
-                        &quot;\001VERSION Gaim IRC\001&quot;);
+                        &quot;\001VERSION Purple IRC\001&quot;);
         gaym_send(gaym, buf);
         g_free(buf);
     } else if (!strncmp(cur, &quot;DCC SEND &quot;, 9)) {
@@ -385,7 +385,7 @@
     int i;
 
     if (!gaym || !gaym-&gt;msgs) {
-        gaim_debug(GAIM_DEBUG_ERROR, &quot;gaym&quot;,
+        purple_debug(PURPLE_DEBUG_ERROR, &quot;gaym&quot;,
                    &quot;Attempt to build a message table on a bogus structure\n&quot;);
         return;
     }
@@ -401,7 +401,7 @@
     int i;
 
     if (!gaym || !gaym-&gt;cmds) {
-        gaim_debug(GAIM_DEBUG_ERROR, &quot;gaym&quot;,
+        purple_debug(PURPLE_DEBUG_ERROR, &quot;gaym&quot;,
                    &quot;Attempt to build a command table on a bogus structure\n&quot;);
         return;
     }
@@ -442,7 +442,7 @@
             g_free(tmp);
             break;
         default:
-            gaim_debug(GAIM_DEBUG_ERROR, &quot;gaym&quot;,
+            purple_debug(PURPLE_DEBUG_ERROR, &quot;gaym&quot;,
                        &quot;Invalid format character '%c'\n&quot;, *cur);
             break;
         }
@@ -459,7 +459,7 @@
         NULL, *fmt = NULL, **args = NULL, *msg = NULL;
     guint i;
 
-    /* gaim_debug(GAIM_DEBUG_INFO, &quot;gaym&quot;, &quot;RAW Protocol: %s\n&quot;, input); */
+    /* purple_debug(PURPLE_DEBUG_INFO, &quot;gaym&quot;, &quot;RAW Protocol: %s\n&quot;, input); */
 
     if (!strncmp(input, &quot;PING &quot;, 5)) {
         msg = gaym_format(gaym, &quot;vv&quot;, &quot;PONG&quot;, input + 5);
@@ -467,7 +467,7 @@
         g_free(msg);
         return;
     } else if (!strncmp(input, &quot;ERROR &quot;, 6)) {
-        gaim_connection_error(gaim_account_get_connection(gaym-&gt;account),
+        purple_connection_error(purple_account_get_connection(gaym-&gt;account),
                               _(&quot;Disconnected.&quot;));
         return;
     }
@@ -527,7 +527,7 @@
             cur = cur + strlen(cur);
             break;
         default:
-            gaim_debug(GAIM_DEBUG_ERROR, &quot;gaym&quot;,
+            purple_debug(PURPLE_DEBUG_ERROR, &quot;gaym&quot;,
                        &quot;invalid message format character '%c'\n&quot;, fmt[i]);
             break;
         }
@@ -544,7 +544,7 @@
 
 static void gaym_parse_error_cb(struct gaym_conn *gaym, char *input)
 {
-    gaim_debug(GAIM_DEBUG_WARNING, &quot;gaym&quot;, &quot;Unrecognized string: %s\n&quot;,
+    purple_debug(PURPLE_DEBUG_WARNING, &quot;gaym&quot;, &quot;Unrecognized string: %s\n&quot;,
                input);
 }
 

Modified: qrc/trunk/gaym/src/weblogin.c
===================================================================
--- qrc/trunk/gaym/src/weblogin.c	2007-07-13 19:53:50 UTC (rev 296)
+++ qrc/trunk/gaym/src/weblogin.c	2007-07-14 04:26:09 UTC (rev 297)
@@ -2,7 +2,7 @@
  * @file util.h Utility Functions
  * @ingroup core
  *
- * Gaim is the legal property of its developers, whose names are too numerous
+ * Purple is the legal property of its developers, whose names are too numerous
  * to list here.  Please refer to the COPYRIGHT file distributed with this
  * source distribution.
  *
@@ -32,7 +32,7 @@
 #include &quot;helpers.h&quot;
 
 
-static void gaym_session_destroy(GaimUrlSession * session)
+static void gaym_session_destroy(PurpleUrlSession * session)
 {
     if (session-&gt;cookies)
         g_free(session-&gt;cookies);
@@ -43,12 +43,12 @@
     g_free(session);
 }
 
-/* gaim_url_decode doesn't change pluses to spaces - edit in place */
+/* purple_url_decode doesn't change pluses to spaces - edit in place */
 static const char *gaym_url_decode(const char *string)
 {
     char *retval;
 
-    retval = (char *) (string = gaim_url_decode(string));
+    retval = (char *) (string = purple_url_decode(string));
     while (*retval != 0) {
         if (*retval == '+')
             *retval = ' ';
@@ -66,7 +66,7 @@
     g_return_if_fail(key != NULL);
     g_return_if_fail(value != NULL);
     g_return_if_fail(data != NULL);
-    GaimUrlSession *session = (GaimUrlSession *) data;
+    PurpleUrlSession *session = (PurpleUrlSession *) data;
     gchar *cookies = session-&gt;cookies;
     session-&gt;cookies =
         g_strconcat(cookies ? cookies : &quot;&quot;, key, &quot;=&quot;, value, &quot;; &quot;, NULL);
@@ -74,7 +74,7 @@
 
 }
 
-static void parse_cookies(const char *webdata, GaimUrlSession * session,
+static void parse_cookies(const char *webdata, PurpleUrlSession * session,
                           size_t len)
 {
     gchar **cookies = g_strsplit(webdata, &quot;\n&quot;, -1);
@@ -85,6 +85,7 @@
         cookie =
             return_string_between(&quot;Set-cookie: &quot;, &quot;; &quot;, cookies[index]);
         if (cookie) {
+            purple_debug_misc(&quot;NEW COOKIE***&quot;,&quot;%s&quot;,cookie);
             cookie_parts = g_strsplit(cookie, &quot;=&quot;, 2);
             if (cookie_parts[0] &amp;&amp; cookie_parts[1])
                 g_hash_table_replace(session-&gt;cookie_table,
@@ -99,7 +100,7 @@
 
 }
 
-gchar* gaym_build_session_request(gchar* url, GaimUrlSession* session)
+gchar* gaym_build_session_request(gchar* url, PurpleUrlSession* session)
 {
 	    if(!url || !session)
 		return 0;
@@ -121,13 +122,13 @@
 	return res;
 }
 static void
-gaym_weblogin_step5(GaimUtilFetchUrlData *url_data, gpointer data, const gchar *text, gsize len, const gchar* err)
+gaym_weblogin_step5(PurpleUtilFetchUrlData *url_data, gpointer data, const gchar *text, gsize len, const gchar* err)
 {
-    gaim_debug_misc(&quot;weblogin&quot;,&quot;STEP FIVE BEGINS\n&quot;); 
-    GaimUrlSession *session = (GaimUrlSession *) data;
+    purple_debug_misc(&quot;weblogin&quot;,&quot;STEP FIVE BEGINS: \n&quot;); 
+    PurpleUrlSession *session = (PurpleUrlSession *) data;
     struct gaym_conn *gaym = session-&gt;gaym;
     // Get hash from text
-    if (session &amp;&amp; GAIM_CONNECTION_IS_VALID(session-&gt;account-&gt;gc)) {
+    if (session &amp;&amp; PURPLE_CONNECTION_IS_VALID(session-&gt;account-&gt;gc)) {
         char *bio;
         char *thumbnail;
         char *temp = NULL;
@@ -135,8 +136,6 @@
         const char *match;
         const char *result;
 
-
-
         gaym-&gt;server_stats = NULL;
         gaym-&gt;chat_key = NULL;
         gaym-&gt;server_bioline = NULL;
@@ -149,17 +148,28 @@
             temp += strlen(match);
             temp2 = strstr(temp, &quot;\&quot; &quot;);
         }
-        if (!
-            (temp &amp;&amp; temp2 &amp;&amp; temp != temp2
-             &amp;&amp; (gaym-&gt;chat_key =
-                 g_strndup(temp, (temp2 - temp) * sizeof(char))))) {
-            gaim_connection_error((session-&gt;account-&gt;gc),
-                                  _
-                                  (&quot;Problem parsing password from web. Report a bug.&quot;));
+        if (!temp) {
+            purple_connection_error((session-&gt;account-&gt;gc), _ (&quot;Didn't find password token.&quot;));
             return;
         }
+        if (!temp2)
+        {
+            purple_connection_error((session-&gt;account-&gt;gc), _ (&quot;Didn't find password end&quot;));
+            return;
+        }
+        if (temp==temp2)
+        {
+            purple_connection_error((session-&gt;account-&gt;gc), _ (&quot;Empty Password&quot;));
+            return;
+        }
+        if (!(gaym-&gt;chat_key = g_strndup(temp, (temp2 - temp) * sizeof(char))))
+        {
+            purple_connection_error((session-&gt;account-&gt;gc), _ (&quot;Memory Allocation Error.&quot;));
+            return;
+        }
 
-        gaim_debug_misc(&quot;weblogin&quot;,
+        
+        purple_debug_misc(&quot;weblogin&quot;,
                         &quot;Got hash, temp=%x, temp2=%x, gaym-&gt;chat_key=%x\n&quot;,
                         temp, temp2, gaym-&gt;chat_key);
         // Next, loook for bio
@@ -172,8 +182,7 @@
         if (temp &amp;&amp; temp2) {
             thumbnail = g_strndup(temp, (temp2 - temp) * sizeof(char));
             result = gaym_url_decode(thumbnail);
-            (gaym-&gt;thumbnail = g_strdup(result))
-                || (gaym-&gt;thumbnail = g_strdup(&quot; &quot;));
+            gaym-&gt;thumbnail = result?g_strdup(result):g_strdup(&quot; &quot;);
 
             g_free(thumbnail);
             // Parse out non thumbnail part of bio.
@@ -181,30 +190,29 @@
             if (temp) {
                 bio = g_strndup(temp2, (temp - temp2) * sizeof(char));
                 result = gaym_url_decode(bio);
-                gaim_debug_info(&quot;gaym&quot;, &quot;Server BIO: %s Thumb: %s\n&quot;,
+                purple_debug_info(&quot;gaym&quot;, &quot;Server BIO: %s Thumb: %s\n&quot;,
                                 result, gaym-&gt;thumbnail);
-                (gaym-&gt;server_bioline = g_strdup(result))
-                    || (gaym-&gt;server_bioline = NULL);
+                gaym-&gt;server_bioline = result?g_strdup(result):NULL;
                 g_free(bio);
 
                 // Parse out stats part of bio.
                 temp2 = strchr(result, (char) 0x01);
                 if (temp2++) {
-                    gaim_debug_misc(&quot;gaym&quot;, &quot;Stats: %s\n&quot;, temp2);
+                    purple_debug_misc(&quot;gaym&quot;, &quot;Stats: %s\n&quot;, temp2);
                     gaym-&gt;server_stats = g_strdup(temp2);
                 }
             }
         } else {
-            // gaim_connection_error(
-            // gaim_account_get_connection(((struct
-            // gaym_conn*)((GaimUrlSession*)session)-&gt;account),
+            // purple_connection_error(
+            // purple_account_get_connection(((struct
+            // gaym_conn*)((PurpleUrlSession*)session)-&gt;account),
             // _(&quot;Problem parsing password from web. Report a bug.&quot;)));
         }
         session-&gt;session_cb(gaym-&gt;account);
 
     } else {
-        gaim_debug_misc(&quot;gaym&quot;, &quot;Connection was cancelled before step5\n&quot;);
-        gaim_debug_misc(&quot;gaym&quot;, &quot;gaym-&gt;session: %x\n&quot;, session);
+        purple_debug_misc(&quot;gaym&quot;, &quot;Connection was cancelled before step5\n&quot;);
+        purple_debug_misc(&quot;gaym&quot;, &quot;gaym-&gt;session: %x\n&quot;, session);
     }
 
     // We don't need the session info anymore.
@@ -213,38 +221,26 @@
 }
 
 static void
-gaym_weblogin_step4(GaimUtilFetchUrlData *url_data, gpointer data, const gchar *text, gsize len, const gchar* err)
+gaym_weblogin_step4(PurpleUtilFetchUrlData *url_data, gpointer data, const gchar *text, gsize len, const gchar* err)
 {
 
-    GaimUrlSession *session = (GaimUrlSession *) data;
+    PurpleUrlSession *session = (PurpleUrlSession *) data;
     parse_cookies(text, session, len);
-    gaim_debug_misc(&quot;gaym&quot;, &quot;Step 4: session: %x\n&quot;, session);
-    if (session &amp;&amp; GAIM_CONNECTION_IS_VALID(session-&gt;account-&gt;gc)) {
-        // The fourth step is to parse a rand=# value out of the message
-        // text from
-        // The previous step.
-        // We then connect to messenger/applet.html
-        char url[512];
-        int nonce;
-        //char *buf = g_strdup_printf(_(&quot;Signon: %s&quot;),
-        //                            (session-&gt;account-&gt;username));
-        //gaim_connection_update_progress(session-&gt;account-&gt;gc, buf, 3, 6);
-        sscanf(text, &quot;?rand=%d&quot;, &amp;nonce);
-        snprintf(url, 512,
-                 &quot;<A HREF="http://www.gay.com/messenger/applet.html?rand=%d">http://www.gay.com/messenger/applet.html?rand=%d</A>&quot;,
-                 nonce);
-	
+    purple_debug_misc(&quot;gaym&quot;, &quot;Step 4: session: %x\n&quot;, session);
+    if (session &amp;&amp; PURPLE_CONNECTION_IS_VALID(session-&gt;account-&gt;gc)) {
+	    
+        char *url=&quot;<A HREF="http://www.gay.com/messenger/applet.html?rand=36">http://www.gay.com/messenger/applet.html?rand=36</A>&quot;;
         session-&gt;hasFormData = TRUE;
-	gaim_debug_misc(&quot;weblogin&quot;,&quot;About to build url\n&quot;);
-	gchar* request=gaym_build_session_request(url, session);
-	gaim_debug_misc(&quot;weblogin&quot;,&quot;Requesting: %s\n&quot;,request);
-        gaim_util_fetch_url_request(url, FALSE, NULL, TRUE, 
+	    purple_debug_misc(&quot;weblogin&quot;,&quot;About to build url\n&quot;);
+	    gchar* request=gaym_build_session_request(url, session);
+	    purple_debug_misc(&quot;weblogin&quot;,&quot;Requesting: %s\n&quot;,request);
+        purple_util_fetch_url_request(url, FALSE, NULL, TRUE, 
 				    request, TRUE, gaym_weblogin_step5,
 				    session);
-	gaim_debug_misc(&quot;weblogin&quot;,&quot;applet fetched&quot;);
+	purple_debug_misc(&quot;weblogin&quot;,&quot;applet fetched&quot;);
     } else {
-        gaim_debug_misc(&quot;gaym&quot;, &quot;Connection was cancelled before step4\n&quot;);
-        gaim_debug_misc(&quot;gaym&quot;, &quot;session: %x\n&quot;, session);
+        purple_debug_misc(&quot;gaym&quot;, &quot;Connection was cancelled before step4\n&quot;);
+        purple_debug_misc(&quot;gaym&quot;, &quot;session: %x\n&quot;, session);
         gaym_session_destroy(session);
 
         // g_free(gaym-&gt;session);
@@ -252,14 +248,14 @@
 }
 
 void
-gaym_get_chat_key_from_weblogin(GaimAccount * account,
-                                void (*callback) (GaimAccount * account))
+gaym_get_chat_key_from_weblogin(PurpleAccount * account,
+                                void (*callback) (PurpleAccount * account))
 {
 
     struct gaym_conn *gaym = account-&gt;gc-&gt;proto_data;
-    if (GAIM_CONNECTION_IS_VALID(account-&gt;gc)) {
+    if (PURPLE_CONNECTION_IS_VALID(account-&gt;gc)) {
 
-        GaimUrlSession *session = g_new0(GaimUrlSession, 1);
+        PurpleUrlSession *session = g_new0(PurpleUrlSession, 1);
         session-&gt;session_cb = callback;
         session-&gt;cookies = NULL;
         session-&gt;account = account;
@@ -269,9 +265,9 @@
         session-&gt;cookie_table =
             g_hash_table_new_full(g_str_hash, g_str_equal, g_free, g_free);
 
-        gaim_debug_misc(&quot;gaym&quot;, &quot;Made session: %x\n&quot;, session);
-        if (GAIM_CONNECTION_IS_VALID
-            (((GaimUrlSession *) session)-&gt;account-&gt;gc)) {
+        purple_debug_misc(&quot;gaym&quot;, &quot;Made session: %x\n&quot;, session);
+        if (PURPLE_CONNECTION_IS_VALID
+            (((PurpleUrlSession *) session)-&gt;account-&gt;gc)) {
             // The first step is to establish the initial sesion
             // We connect to index.html, and get a few cookie values.
             char *url =
@@ -280,11 +276,11 @@
                  session-&gt;username, session-&gt;password);
 
             session-&gt;hasFormData = TRUE;
-            gaim_util_fetch_url_request(url, FALSE, NULL, FALSE, NULL, TRUE,
+            gaym_util_fetch_url_request(url, FALSE, NULL, FALSE, NULL, TRUE,
                                gaym_weblogin_step4, session);
         } else {
-            gaim_debug_misc(&quot;gaym&quot;, &quot;cancelled before step1\n&quot;);
-            gaim_debug_misc(&quot;gaym&quot;, &quot;gaym-&gt;sessoin: %x\n&quot;, session);
+            purple_debug_misc(&quot;gaym&quot;, &quot;cancelled before step1\n&quot;);
+            purple_debug_misc(&quot;gaym&quot;, &quot;gaym-&gt;sessoin: %x\n&quot;, session);
             gaym_session_destroy(session);
         }
 
@@ -293,12 +289,12 @@
 
 
 /*Doesn't do anything yet*/
-void gaym_try_cached_password(GaimAccount * account,
-                              void (*callback) (GaimAccount * account))
+void gaym_try_cached_password(PurpleAccount * account,
+                              void (*callback) (PurpleAccount * account))
 {
 
     const char *pw;
-    pw = gaim_account_get_string(account, &quot;chat_key&quot;, NULL);
+    pw = purple_account_get_string(account, &quot;chat_key&quot;, NULL);
     if (pw == NULL) {
         gaym_get_chat_key_from_weblogin(account, callback);
         return;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000225.html">[Qrc-svn] r296 - qrc/branches
</A></li>
	<LI>Next message: <A HREF="000226.html">[Qrc-svn] r298 - qrc/trunk/gaym/src
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#228">[ date ]</a>
              <a href="thread.html#228">[ thread ]</a>
              <a href="subject.html#228">[ subject ]</a>
              <a href="author.html#228">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/qrc-svn">More information about the Qrc-svn
mailing list</a><br>
</body></html>
