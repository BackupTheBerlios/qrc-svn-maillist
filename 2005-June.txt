From deckrider at sheep.berlios.de  Wed Jun  1 01:04:13 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Wed, 1 Jun 2005 01:04:13 +0200
Subject: [Qrc-svn] r49 - gaym/trunk/src
Message-ID: <200505312304.j4VN4D76008300@sheep.berlios.de>

Author: deckrider
Date: 2005-06-01 01:04:03 +0200 (Wed, 01 Jun 2005)
New Revision: 49

Modified:
   gaym/trunk/src/gaym.c
   gaym/trunk/src/helpers.c
   gaym/trunk/src/helpers.h
Log:
Synchronize icons next to chatroom members with privacy settings in
real time as the privacy settings are changed.  Thanks goes to many
people in #gaim who put up with my stupid questions, and especially
to "datallah" who found that my understanding of the structures
was incorrect.


Modified: gaym/trunk/src/gaym.c
===================================================================
--- gaym/trunk/src/gaym.c	2005-05-31 19:17:15 UTC (rev 48)
+++ gaym/trunk/src/gaym.c	2005-05-31 23:04:03 UTC (rev 49)
@@ -600,16 +600,11 @@
 
 static void gaym_add_permit(GaimConnection * gc, const char *name)
 {
-    // 
-    // FIXME: Add code here to synchronize icons.
-    // 
+    gaym_privacy_change(gc);
 }
 
 static void gaym_add_deny(GaimConnection * gc, const char *name)
 {
-    // 
-    // FIXME: Add code here to synchronize icons.
-    // 
     // FIXME: add code here to store this setting on gay.com
     // 
     // The way to store it is by doing a GET on www.gay.com to
@@ -621,20 +616,17 @@
     // status=ok
     // list=ignore
     // command=add
+
+    gaym_privacy_change(gc);
 }
 
 static void gaym_rem_permit(GaimConnection * gc, const char *name)
 {
-    // 
-    // FIXME: Add code here to synchronize icons.
-    // 
+    gaym_privacy_change(gc);
 }
 
 static void gaym_rem_deny(GaimConnection * gc, const char *name)
 {
-    // 
-    // FIXME: Add code here to synchronize icons.
-    // 
     // FIXME: add code here to store this setting on gay.com
     // 
     // The way to store it is by doing a GET on www.gay.com to
@@ -646,53 +638,13 @@
     // status=ok
     // list=ignore
     // command=remove
+
+    gaym_privacy_change(gc);
 }
 
 static void gaym_set_permit_deny(GaimConnection * gc)
 {
-    // 
-    // FIXME: Add code here to synchronize icons.
-    // 
-    // GAIM_PRIVACY_ALLOW_ALL,
-    // GAIM_PRIVACY_DENY_ALL,
-    // perhaps this should set the user "invisible"
-    // instead of actually blocking everyone, then
-    // all the other options would return the user
-    // to "visible" status as well as their normal
-    // block/unblock operations
-    // GAIM_PRIVACY_ALLOW_USERS,
-    // GAIM_PRIVACY_DENY_USERS,
-    // GAIM_PRIVACY_ALLOW_BUDDYLIST
-    // 
-
-    GaimAccount *acct = NULL;
-
-    acct = gc->account;
-
-    switch (acct->perm_deny) {
-    case GAIM_PRIVACY_ALLOW_ALL:
-        break;
-    case GAIM_PRIVACY_DENY_ALL:
-        // This causes a crash:
-        //
-        // GSList *rooms = NULL;
-        // for (rooms = gc->buddy_chats; rooms; rooms = rooms->next) {
-        //     printf("ROOM\n");
-        //     GaimConvChat *chatroom = rooms->data;
-        //     GList *members = chatroom->in_room;
-        //     gaim_conv_chat_set_ignored(chatroom, members);
-        // }
-        break;
-    case GAIM_PRIVACY_ALLOW_USERS:
-        break;
-    case GAIM_PRIVACY_DENY_USERS:
-        break;
-    case GAIM_PRIVACY_ALLOW_BUDDYLIST:
-        break;
-    default:
-        // error
-        break;
-    }
+    gaym_privacy_change(gc);
 }
 
 static void gaym_chat_join(GaimConnection * gc, GHashTable * data)
@@ -704,7 +656,7 @@
     GaimChat *c = NULL;
 
     GHashTable *chatinfo = NULL;        // need a copy, because data gets
-                                        // destroyed in roomlist.c
+    // destroyed in roomlist.c
 
     args[0] = g_hash_table_lookup(data, "channel");
 

Modified: gaym/trunk/src/helpers.c
===================================================================
--- gaym/trunk/src/helpers.c	2005-05-31 19:17:15 UTC (rev 48)
+++ gaym/trunk/src/helpers.c	2005-05-31 23:04:03 UTC (rev 49)
@@ -181,4 +181,27 @@
     return permitted;
 }
 
+void gaym_privacy_change(GaimConnection * gc)
+{
+    GSList *rooms = NULL;
+    for (rooms = gc->buddy_chats; rooms; rooms = rooms->next) {
+        GaimConversation *convo = rooms->data;
+        GaimConvChat *chat = gaim_conversation_get_chat_data(convo);
+        GList *people = NULL;
+        for (people = chat->in_room; people; people = people->next) {
+            GaimConvChatBuddy *buddy = people->data;
+            GaimConversationUiOps *ops =
+                gaim_conversation_get_ui_ops(convo);
+            if (gaym_privacy_check(gc, buddy->name)) {
+                gaim_conv_chat_unignore(GAIM_CONV_CHAT(convo),
+                                        buddy->name);
+                ops->chat_update_user((convo), buddy->name);
+            } else {
+                gaim_conv_chat_ignore(GAIM_CONV_CHAT(convo), buddy->name);
+                ops->chat_update_user((convo), buddy->name);
+            }
+        }
+    }
+}
+
 // vim:tabstop=4:shiftwidth=4:expandtab:

Modified: gaym/trunk/src/helpers.h
===================================================================
--- gaym/trunk/src/helpers.h	2005-05-31 19:17:15 UTC (rev 48)
+++ gaym/trunk/src/helpers.h	2005-05-31 23:04:03 UTC (rev 49)
@@ -18,4 +18,6 @@
 
 gboolean gaym_privacy_check(GaimConnection * gc, const char *nick);
 
+void gaym_privacy_change(GaimConnection * gc);
+
 // vim:tabstop=4:shiftwidth=4:expandtab:



From deckrider at sheep.berlios.de  Wed Jun  1 04:09:32 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Wed, 1 Jun 2005 04:09:32 +0200
Subject: [Qrc-svn] r50 - gaym/trunk
Message-ID: <200506010209.j5129WkH021087@sheep.berlios.de>

Author: deckrider
Date: 2005-06-01 04:09:19 +0200 (Wed, 01 Jun 2005)
New Revision: 50

Modified:
   gaym/trunk/TODO
Log:
Updated TODO to show that activating all available GUI privacy features
is complete.


Modified: gaym/trunk/TODO
===================================================================
--- gaym/trunk/TODO	2005-05-31 23:04:03 UTC (rev 49)
+++ gaym/trunk/TODO	2005-06-01 02:09:19 UTC (rev 50)
@@ -3,9 +3,6 @@
 TODO
 ====
 
-- activate privacy/block users in gui (almost DONE, but icons in chat
-  need to be synchronized)
-
 - add gaym_bot_check(), patterned similar to gaym_privacy_check() that
   takes a list of strings/patterns the user can enter in GayM
   preferences and then looks to see if a match is found in the nick's
@@ -94,6 +91,8 @@
 DONE
 ====
 
+- activate privacy/block users in gui
+
 - Join/part message on/off
 
 - make roomlist show "room name:1" similar to yahoo



From deckrider at sheep.berlios.de  Thu Jun  2 20:17:27 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Thu, 2 Jun 2005 20:17:27 +0200
Subject: [Qrc-svn] r51 - gaym/trunk/src
Message-ID: <200506021817.j52IHRrQ007800@sheep.berlios.de>

Author: deckrider
Date: 2005-06-02 20:17:26 +0200 (Thu, 02 Jun 2005)
New Revision: 51

Modified:
   gaym/trunk/src/gaym.c
   gaym/trunk/src/helpers.c
   gaym/trunk/src/helpers.h
Log:
- Make privacy a bit more efficient.
- Do not allow adding of self to permit/deny lists.
- Do not block/ignore self.
- Spelling corrections in Preferences->GayM->Conversations (thanks
  r0bby__).


Modified: gaym/trunk/src/gaym.c
===================================================================
--- gaym/trunk/src/gaym.c	2005-06-01 02:09:19 UTC (rev 50)
+++ gaym/trunk/src/gaym.c	2005-06-02 18:17:26 UTC (rev 51)
@@ -222,11 +222,13 @@
         return;
     }
 }
+
 static void gaym_show_set_info(GaimPluginAction * action)
 {
     GaimConnection *gc = (GaimConnection *) action->context;
     gaim_account_request_change_user_info(gaim_connection_get_account(gc));
 }
+
 static GList *gaym_actions(GaimPlugin * plugin, gpointer context)
 {
     GList *list = NULL;
@@ -600,7 +602,7 @@
 
 static void gaym_add_permit(GaimConnection * gc, const char *name)
 {
-    gaym_privacy_change(gc);
+    gaym_privacy_change(gc, name);
 }
 
 static void gaym_add_deny(GaimConnection * gc, const char *name)
@@ -617,12 +619,12 @@
     // list=ignore
     // command=add
 
-    gaym_privacy_change(gc);
+    gaym_privacy_change(gc, name);
 }
 
 static void gaym_rem_permit(GaimConnection * gc, const char *name)
 {
-    gaym_privacy_change(gc);
+    gaym_privacy_change(gc, name);
 }
 
 static void gaym_rem_deny(GaimConnection * gc, const char *name)
@@ -639,12 +641,12 @@
     // list=ignore
     // command=remove
 
-    gaym_privacy_change(gc);
+    gaym_privacy_change(gc, name);
 }
 
 static void gaym_set_permit_deny(GaimConnection * gc)
 {
-    gaym_privacy_change(gc);
+    gaym_privacy_change(gc, NULL);
 }
 
 static void gaym_chat_join(GaimConnection * gc, GHashTable * data)
@@ -944,13 +946,13 @@
     ppref =
         gaim_plugin_pref_new_with_name_and_label
         ("/plugins/prpl/gaym/show_join_leave_msgs",
-         _("Show entance/exit messages"));
+         _("Show entrance/exit messages"));
     gaim_plugin_pref_frame_add(frame, ppref);
 
     ppref =
         gaim_plugin_pref_new_with_name_and_label
         ("/plugins/prpl/gaym/show_bio_with_join",
-         _("Show bio when entance messages are shown."));
+         _("Show bio when entrance messages are shown"));
     gaim_plugin_pref_frame_add(frame, ppref);
 
     // ppref = gaim_plugin_pref_new_with_name_and_label(
@@ -1011,7 +1013,6 @@
     prpl_info.protocol_options =
         g_list_append(prpl_info.protocol_options, option);
 
-
     option = gaim_account_option_string_new(_("Bio Line"), "bioline", "");
     prpl_info.protocol_options =
         g_list_append(prpl_info.protocol_options, option);

Modified: gaym/trunk/src/helpers.c
===================================================================
--- gaym/trunk/src/helpers.c	2005-06-01 02:09:19 UTC (rev 50)
+++ gaym/trunk/src/helpers.c	2005-06-02 18:17:26 UTC (rev 51)
@@ -178,11 +178,35 @@
         break;
     }
 
+    // don't block/ignore self
+    if (!gaim_utf8_strcasecmp(gc->account->username, nick)) {
+        permitted = TRUE;
+        gaim_debug_info("gaym", "declining to block/ignore self\n");
+        return permitted;
+    }
+
     return permitted;
 }
 
-void gaym_privacy_change(GaimConnection * gc)
+// if name is NULL, then we reset all names, otherwise
+// only the name provided
+
+void gaym_privacy_change(GaimConnection * gc, const char *name)
 {
+    // don't allow adding self to permit/deny lists
+
+    if (name) {
+        if (!gaim_utf8_strcasecmp(gc->account->username, name)) {
+            gaim_privacy_deny_remove(gc->account, gc->account->username,
+                                     TRUE);
+            gaim_privacy_permit_remove(gc->account, gc->account->username,
+                                       TRUE);
+            gaim_debug_info("gaym",
+                             "declining to add self to permit/deny list\n");
+            return;
+        }
+    }
+
     GSList *rooms = NULL;
     for (rooms = gc->buddy_chats; rooms; rooms = rooms->next) {
         GaimConversation *convo = rooms->data;
@@ -192,12 +216,25 @@
             GaimConvChatBuddy *buddy = people->data;
             GaimConversationUiOps *ops =
                 gaim_conversation_get_ui_ops(convo);
-            if (gaym_privacy_check(gc, buddy->name)) {
-                gaim_conv_chat_unignore(GAIM_CONV_CHAT(convo),
-                                        buddy->name);
-                ops->chat_update_user((convo), buddy->name);
+            if (name) {
+                if (!gaim_utf8_strcasecmp(name, buddy->name)) {
+                    if (gaym_privacy_check(gc, buddy->name)) {
+                        gaim_conv_chat_unignore(GAIM_CONV_CHAT(convo),
+                                                buddy->name);
+                    } else {
+                        gaim_conv_chat_ignore(GAIM_CONV_CHAT(convo),
+                                              buddy->name);
+                    }
+                    ops->chat_update_user((convo), buddy->name);
+                }
             } else {
-                gaim_conv_chat_ignore(GAIM_CONV_CHAT(convo), buddy->name);
+                if (gaym_privacy_check(gc, buddy->name)) {
+                    gaim_conv_chat_unignore(GAIM_CONV_CHAT(convo),
+                                            buddy->name);
+                } else {
+                    gaim_conv_chat_ignore(GAIM_CONV_CHAT(convo),
+                                          buddy->name);
+                }
                 ops->chat_update_user((convo), buddy->name);
             }
         }

Modified: gaym/trunk/src/helpers.h
===================================================================
--- gaym/trunk/src/helpers.h	2005-06-01 02:09:19 UTC (rev 50)
+++ gaym/trunk/src/helpers.h	2005-06-02 18:17:26 UTC (rev 51)
@@ -18,6 +18,6 @@
 
 gboolean gaym_privacy_check(GaimConnection * gc, const char *nick);
 
-void gaym_privacy_change(GaimConnection * gc);
+void gaym_privacy_change(GaimConnection * gc, const char *name);
 
 // vim:tabstop=4:shiftwidth=4:expandtab:



From deckrider at sheep.berlios.de  Thu Jun  2 21:04:03 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Thu, 2 Jun 2005 21:04:03 +0200
Subject: [Qrc-svn] r52 - gaym/trunk/src
Message-ID: <200506021904.j52J43cb013303@sheep.berlios.de>

Author: deckrider
Date: 2005-06-02 21:04:03 +0200 (Thu, 02 Jun 2005)
New Revision: 52

Modified:
   gaym/trunk/src/msgs.c
Log:
Make "Member Created" rooms consistent with the others in the roomlist.


Modified: gaym/trunk/src/msgs.c
===================================================================
--- gaym/trunk/src/msgs.c	2005-06-02 18:17:26 UTC (rev 51)
+++ gaym/trunk/src/msgs.c	2005-06-02 19:04:03 UTC (rev 52)
@@ -402,8 +402,8 @@
                              "Member created room list parsing error");
             return;
         }
-
         field_start++;
+        field_end = field_end + 2;
 
         field_len = field_end - field_start;
 
@@ -418,6 +418,8 @@
                 field_name[i] = ' ';
             }
         }
+        // replace '=' with ':'
+        field_name[i-2] = ':';
 
         room = gaim_roomlist_room_new(GAIM_ROOMLIST_ROOMTYPE_ROOM,
                                       field_name,



From deckrider at sheep.berlios.de  Fri Jun  3 01:52:18 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Fri, 3 Jun 2005 01:52:18 +0200
Subject: [Qrc-svn] r53 - gaym/trunk/src
Message-ID: <200506022352.j52NqI72017314@sheep.berlios.de>

Author: deckrider
Date: 2005-06-03 01:52:01 +0200 (Fri, 03 Jun 2005)
New Revision: 53

Modified:
   gaym/trunk/src/gaym.c
Log:
Do not allow adding NULL entries to the permit/deny list.


Modified: gaym/trunk/src/gaym.c
===================================================================
--- gaym/trunk/src/gaym.c	2005-06-02 19:04:03 UTC (rev 52)
+++ gaym/trunk/src/gaym.c	2005-06-02 23:52:01 UTC (rev 53)
@@ -602,6 +602,10 @@
 
 static void gaym_add_permit(GaimConnection * gc, const char *name)
 {
+    if(!name || name[0] == NULL) {
+        gaim_privacy_permit_remove(gc->account, name, TRUE);
+        return;
+    }
     gaym_privacy_change(gc, name);
 }
 
@@ -619,6 +623,10 @@
     // list=ignore
     // command=add
 
+    if(!name || name[0] == NULL) {
+        gaim_privacy_deny_remove(gc->account, name, TRUE);
+        return;
+    }
     gaym_privacy_change(gc, name);
 }
 



From deckrider at sheep.berlios.de  Fri Jun  3 06:07:33 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Fri, 3 Jun 2005 06:07:33 +0200
Subject: [Qrc-svn] r54 - gaym/trunk/src
Message-ID: <200506030407.j5347X3n000893@sheep.berlios.de>

Author: deckrider
Date: 2005-06-03 06:06:52 +0200 (Fri, 03 Jun 2005)
New Revision: 54

Modified:
   gaym/trunk/src/gaym.c
Log:
Added gaim_normalize for the prpl callback.  Began using it to make
certain only nicks with valid characters, no white-space, etc. are
entered into the permit/deny lists.


Modified: gaym/trunk/src/gaym.c
===================================================================
--- gaym/trunk/src/gaym.c	2005-06-02 23:52:01 UTC (rev 53)
+++ gaym/trunk/src/gaym.c	2005-06-03 04:06:52 UTC (rev 54)
@@ -602,11 +602,13 @@
 
 static void gaym_add_permit(GaimConnection * gc, const char *name)
 {
-    if(!name || name[0] == NULL) {
-        gaim_privacy_permit_remove(gc->account, name, TRUE);
+    gaim_privacy_permit_remove(gc->account, name, TRUE);
+    const char *normalized = gaim_normalize(gc->account, name);
+    if (!normalized[0]) {
         return;
     }
-    gaym_privacy_change(gc, name);
+    gaim_privacy_permit_add(gc->account, normalized, TRUE);
+    gaym_privacy_change(gc, normalized);
 }
 
 static void gaym_add_deny(GaimConnection * gc, const char *name)
@@ -623,11 +625,13 @@
     // list=ignore
     // command=add
 
-    if(!name || name[0] == NULL) {
-        gaim_privacy_deny_remove(gc->account, name, TRUE);
+    gaim_privacy_deny_remove(gc->account, name, TRUE);
+    const char *normalized = gaim_normalize(gc->account, name);
+    if (!normalized[0]) {
         return;
     }
-    gaym_privacy_change(gc, name);
+    gaim_privacy_deny_add(gc->account, normalized, TRUE);
+    gaym_privacy_change(gc, normalized);
 }
 
 static void gaym_rem_permit(GaimConnection * gc, const char *name)
@@ -760,6 +764,28 @@
     return 0;
 }
 
+const char *gaym_normalize(const GaimAccount * acct, const char *nick)
+{
+    if (!nick) {
+        return NULL;
+    }
+    char *retval = g_new0(char, 31);    // max 30, plus one for the NULL
+    char *allowed =
+        "ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz0123456789\0";
+    int i = 0;
+    int j = 0;
+    int k = 0;
+    for (i = 0; nick[i]; i++) {
+        for (j = 0; allowed[j]; j++) {
+            if ((k < 31) && (nick[i] == allowed[j])) {
+                retval[k] = nick[i];
+                k++;
+            }
+        }
+    }
+    return retval;
+}
+
 static guint gaym_nick_hash(const char *nick)
 {
     char *lc;
@@ -886,7 +912,7 @@
     NULL,                       /* rename_group */
     NULL,                       /* buddy_free */
     NULL,                       /* convo_closed */
-    NULL,                       /* normalize */
+    gaym_normalize,             /* normalize */
     NULL,                       /* set_buddy_icon */
     NULL,                       /* remove_group */
     NULL,                       /* get_cb_real_name */



From deckrider at sheep.berlios.de  Fri Jun  3 15:49:35 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Fri, 3 Jun 2005 15:49:35 +0200
Subject: [Qrc-svn] r56 - gaym/trunk
Message-ID: <200506031349.j53DnZ8b002204@sheep.berlios.de>

Author: deckrider
Date: 2005-06-03 15:49:33 +0200 (Fri, 03 Jun 2005)
New Revision: 56

Modified:
   gaym/trunk/autogen.sh
   gaym/trunk/configure.ac
Log:
- Require at least automake 1.9.5 (thanks: michael <rubberboy at doggie.org>).
- Exit autogen.sh on automake error.


Modified: gaym/trunk/autogen.sh
===================================================================
--- gaym/trunk/autogen.sh	2005-06-03 05:21:18 UTC (rev 55)
+++ gaym/trunk/autogen.sh	2005-06-03 13:49:33 UTC (rev 56)
@@ -60,23 +60,14 @@
 echo;
 echo "Running automake...."
 echo;
-automake --force-missing --add-missing;
+automake --force-missing --add-missing || exit;
 
 echo;
 echo "Running autoconf...."
 echo;
 autoconf --force || exit;
 
-#
-# Apparently, running automake a second time like this fixes 
-# distcheck for automake 1.5 and doesn't break it for 1.4.
-#
 echo;
-echo "Running automake again...."
-echo;
-automake || exit;
-
-echo;
 echo "Finished generating configuration files for GayM."
 echo "Now you may run './configure'."
 echo;

Modified: gaym/trunk/configure.ac
===================================================================
--- gaym/trunk/configure.ac	2005-06-03 05:21:18 UTC (rev 55)
+++ gaym/trunk/configure.ac	2005-06-03 13:49:33 UTC (rev 56)
@@ -4,7 +4,7 @@
 AC_PREREQ([2.59])
 AC_INIT([gaim-gaym],[0.33.0+svn],[gaymplugin at yahoogroups.com])
 AC_CANONICAL_SYSTEM
-AM_INIT_AUTOMAKE
+AM_INIT_AUTOMAKE([1.9.5])
 
 REQUIRED_GAIM="gaim >= 1.2 gaim < 2.0"
 AC_SUBST(REQUIRED_GAIM)
@@ -17,7 +17,7 @@
 # Checks for programs.
 AC_PROG_CC
 AC_DISABLE_STATIC
-AM_PROG_LIBTOOL
+AC_PROG_LIBTOOL
 LIBTOOL="$LIBTOOL --silent"
 AC_PROG_INSTALL
 



From deckrider at sheep.berlios.de  Fri Jun  3 17:38:48 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Fri, 3 Jun 2005 17:38:48 +0200
Subject: [Qrc-svn] r57 - gaym/trunk
Message-ID: <200506031538.j53FcmBG008984@sheep.berlios.de>

Author: deckrider
Date: 2005-06-03 17:38:47 +0200 (Fri, 03 Jun 2005)
New Revision: 57

Modified:
   gaym/trunk/TODO
Log:
Updated latest status and added a note about windows packaging.


Modified: gaym/trunk/TODO
===================================================================
--- gaym/trunk/TODO	2005-06-03 13:49:33 UTC (rev 56)
+++ gaym/trunk/TODO	2005-06-03 15:38:47 UTC (rev 57)
@@ -20,8 +20,6 @@
   the end or receive an error, since the server doesn't appear to send
   one at at first glance (verify before acting).
 
-- Connect link to web page for report user to Warn button in Gaim
-
 - integrate server buddy, bookmarks, hotlists, im hot lists, ignore
   lists (below is two version of this)
 
@@ -46,7 +44,7 @@
   should automatically display the multiple rooms associated with a
   locale, so that the user can select one. The user should have the
   option of adding EITHER the #xxx=* room, OR a particular #xxx=x room,
-  to the buddy list. 
+  to the buddy list.   (I think this is somewhat done, but not sure)
 
 - Split-phase operation notifiers. For example.... if you click to join
   a channel, there may be a delay if, for example, the buddy list is
@@ -88,9 +86,13 @@
   eventually use autoconf/automake, but I don't yet know how
   cross-compiler builds would work with this.
 
+- Add windows installer package
+
 DONE
 ====
 
+- Connect link to web page for report user to Warn button in Gaim
+
 - activate privacy/block users in gui
 
 - Join/part message on/off



From deckrider at sheep.berlios.de  Fri Jun  3 18:23:18 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Fri, 3 Jun 2005 18:23:18 +0200
Subject: [Qrc-svn] r58 - gaym/trunk/src
Message-ID: <200506031623.j53GNIEa011319@sheep.berlios.de>

Author: deckrider
Date: 2005-06-03 18:23:17 +0200 (Fri, 03 Jun 2005)
New Revision: 58

Modified:
   gaym/trunk/src/gaym.c
Log:
Updated gaym_normalize() to ensure the first character is a letter and
to allow hyphens and periods in the remaining characters.


Modified: gaym/trunk/src/gaym.c
===================================================================
--- gaym/trunk/src/gaym.c	2005-06-03 15:38:47 UTC (rev 57)
+++ gaym/trunk/src/gaym.c	2005-06-03 16:23:17 UTC (rev 58)
@@ -777,23 +777,46 @@
     return 0;
 }
 
+// According to http://www.gay.com/members/join/ the member name is:
+//
+//   - Up to 30 characters
+//   - Must begin with a letter
+//   - Can contain only letters, numbers, and underscores ( _ )
+//   - Cannot contain special characters, spaces, periods, or hyphens (-)
+//
+// However, in testing as well as observing existing members, the
+// the member name may in fact contain periods and hyphens.
+
 const char *gaym_normalize(const GaimAccount * acct, const char *nick)
 {
     if (!nick) {
         return NULL;
     }
     char *retval = g_new0(char, 31);    // max 30, plus one for the NULL
+    char *firstchar =
+        "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";
     char *allowed =
-        "ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz0123456789\0";
+        "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_.-\0";
     int i = 0;
     int j = 0;
     int k = 0;
     for (i = 0; nick[i]; i++) {
-        for (j = 0; allowed[j]; j++) {
-            if ((k < 31) && (nick[i] == allowed[j])) {
-                retval[k] = nick[i];
-                k++;
+        if (k == 0) {
+            for (j = 0; firstchar[j]; j++) {
+                if ((k == 0) && (nick[i] == firstchar[j])) {
+                    retval[k] = nick[i];
+                    k++;
+                    break;
+                }
             }
+        } else {
+            for (j = 0; allowed[j]; j++) {
+                if ((k < 31) && (nick[i] == allowed[j])) {
+                    retval[k] = nick[i];
+                    k++;
+                    break;
+                }
+            }
         }
     }
     return retval;



From deckrider at sheep.berlios.de  Fri Jun  3 22:20:37 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Fri, 3 Jun 2005 22:20:37 +0200
Subject: [Qrc-svn] r59 - in gaym/trunk: . nsis nsis/locale nsis/pixmaps pixmaps src
Message-ID: <200506032020.j53KKbR0012777@sheep.berlios.de>

Author: deckrider
Date: 2005-06-03 22:20:34 +0200 (Fri, 03 Jun 2005)
New Revision: 59

Added:
   gaym/trunk/nsis/
   gaym/trunk/nsis/gaim-gaym.nsi
   gaym/trunk/nsis/locale/
   gaym/trunk/nsis/locale/english.nsh
   gaym/trunk/nsis/pixmaps/
   gaym/trunk/nsis/pixmaps/gaym.bmp
Removed:
   gaym/trunk/Include.mingw
   gaym/trunk/pixmaps/Makefile.mingw
Modified:
   gaym/trunk/Makefile.mingw
   gaym/trunk/README.mingw
   gaym/trunk/TODO
   gaym/trunk/src/Makefile.mingw
   gaym/trunk/src/gaym.c
Log:
Added support for building an nsis-based win32 installer package.


Deleted: gaym/trunk/Include.mingw
===================================================================
--- gaym/trunk/Include.mingw	2005-06-03 16:23:17 UTC (rev 58)
+++ gaym/trunk/Include.mingw	2005-06-03 20:20:34 UTC (rev 59)
@@ -1,15 +0,0 @@
-# Things you might want to change on the command line
-#
-# For instance:
-# "make GTK_TOP=/path/to/gtk GAIM_TOP=/path/to/gaim CC=gcc.exe"
-
-GTK_TOP  =
-GAIM_TOP =
-CC       = 
-
-# Basics 
-
-PRPL         = src
-PIXMAPS      = pixmaps
-INSTALL_DIR  = gaym-win32-install-dir
-

Modified: gaym/trunk/Makefile.mingw
===================================================================
--- gaym/trunk/Makefile.mingw	2005-06-03 16:23:17 UTC (rev 58)
+++ gaym/trunk/Makefile.mingw	2005-06-03 20:20:34 UTC (rev 59)
@@ -3,18 +3,15 @@
 # Description: Top Makefile for win32 (mingw) port of gaym
 #
 
-include Include.mingw
-
 all:
-	$(MAKE) -C $(PRPL) -f Makefile.mingw
+	$(MAKE) -C src -f Makefile.mingw
 
 install: all
-	mkdir -p $(INSTALL_DIR)
-	$(MAKE) -C $(PIXMAPS) -f Makefile.mingw install
-	$(MAKE) -C $(PRPL) -f Makefile.mingw install
-	cp README.mingw $(INSTALL_DIR)/README.txt
-	unix2dos $(INSTALL_DIR)/README.txt
+	$(MAKENSIS) \
+		-DGAYM_VERSION="$(GAYM_VERSION)" \
+		-DGAIM_VERSION="$(GAIM_VERSION)" \
+		-DGAIM_TOP="$(GAIM_TOP)" nsis/gaim-gaym.nsi
 
 clean:
-	$(MAKE) -C $(PRPL) -f Makefile.mingw clean
-	-rm -r $(INSTALL_DIR)
+	$(MAKE) -C src -f Makefile.mingw clean
+	-rm *.exe

Modified: gaym/trunk/README.mingw
===================================================================
--- gaym/trunk/README.mingw	2005-06-03 16:23:17 UTC (rev 58)
+++ gaym/trunk/README.mingw	2005-06-03 20:20:34 UTC (rev 59)
@@ -15,8 +15,8 @@
 
    - This assumes your home directory is /home/deckrider, and your
      directory to download and unwind gaim and other required software
-     is /home/deckrider/wingaim, and your cross compiler name is
-     i586-mingw32msvc-gcc
+     is /home/deckrider/wingaim, your cross compiler name is
+     i586-mingw32msvc-gcc, and you have nsis installed.
 
    - Download and unwind the following under
      /home/deckrider/wingaim/win32-dev:
@@ -40,16 +40,17 @@
    - make -f Makefile.mingw  gaim.dll CC=i586-mingw32msvc-gcc
 
    - Now you can build the gaym plugin from its top level source
-     directory (the same directory containing this file):
+     directory (the same directory containing this file).  This
+     requires that you have nsis to build the windows installer:
 
-   - make -f Makefile.mingw \
-     GTK_TOP=/home/deckrider/wingaim/win32-dev/gtk_2_0 \
-     GAIM_TOP=/home/deckrider/wingaim/gaim-1.3.0 \
-     CC=i586-mingw32msvc-gcc
+   - make -f Makefile.mingw install \
+     GAYM_VERSION="0.33.0+2005-06-03" \
+     GAIM_VERSION="1.3.0" \
+     GAIM_TOP="/home/deckrider/wingaim/gaim-1.3.0" \
+     CC=i586-mingw32msvc-gcc \
+     MAKENSIS=makensis \
+     GTK_TOP="/home/deckrider/wingaim/win32-dev/gtk_2_0"
 
-   - make -f Makefile.mingw install
-     (will install necessary windows components to ./gaym-win32-install-dir)
-
    - make -f Makefile.mingw clean
      (will restore the the source tree to its pristine form)
 

Modified: gaym/trunk/TODO
===================================================================
--- gaym/trunk/TODO	2005-06-03 16:23:17 UTC (rev 58)
+++ gaym/trunk/TODO	2005-06-03 20:20:34 UTC (rev 59)
@@ -86,11 +86,11 @@
   eventually use autoconf/automake, but I don't yet know how
   cross-compiler builds would work with this.
 
-- Add windows installer package
-
 DONE
 ====
 
+- Add windows installer package
+
 - Connect link to web page for report user to Warn button in Gaim
 
 - activate privacy/block users in gui

Added: gaym/trunk/nsis/gaim-gaym.nsi
===================================================================
--- gaym/trunk/nsis/gaim-gaym.nsi	2005-06-03 16:23:17 UTC (rev 58)
+++ gaym/trunk/nsis/gaim-gaym.nsi	2005-06-03 20:20:34 UTC (rev 59)
@@ -0,0 +1,335 @@
+; NSIS Script For Gaim-GayM Plugin
+; Author Don Seiler
+; Based on the Gaim-BNET installer by Daniel Atallah
+; Uses NSIS v2.0
+
+Name "Gaim-GayM ${GAYM_VERSION}"
+
+; Registry keys:
+!define GAYM_REG_KEY        "SOFTWARE\gaim-gaym"
+!define GAYM_UNINSTALL_KEY  "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\gaim-gaym"
+!define GAYM_UNINST_EXE     "gaim-gaym-uninst.exe"
+!define GAYM_DLL            "libgaym.dll"
+!define GAYM_PNG            "gaym.png"
+!define GAYM_UNINSTALL_LNK  "Gaim-GayM Uninstall.lnk"
+!define GAIM_MACRO_DEFAULT_STRING "Gaim-GayM"
+
+
+!include "MUI.nsh"
+
+;Do A CRC Check
+CRCCheck On
+
+;Output File Name
+OutFile "..\gaim-gaym-${GAYM_VERSION}.exe"
+
+ShowInstDetails show
+ShowUnInstDetails show
+SetCompressor lzma
+
+; Translations
+!include "locale\english.nsh"
+
+;-------------------------------
+; Gaim Plugin installer helper stuff
+!addincludedir "${GAIM_TOP}\src\win32\nsis"
+!include "gaim-plugin.nsh"
+
+; Modern UI Configuration
+
+;!define MUI_ICON .\nsis\install.ico
+;!define MUI_UNICON .\nsis\install.ico
+!define MUI_HEADERIMAGE
+!define MUI_HEADERIMAGE_BITMAP "pixmaps\gaym.bmp"
+
+
+; Pages
+!define MUI_WELCOMEPAGE_TITLE $(WELCOME_TITLE)
+!define MUI_WELCOMEPAGE_TEXT $(WELCOME_TEXT)
+!insertmacro MUI_PAGE_WELCOME
+
+!insertmacro MUI_PAGE_LICENSE  "..\COPYING"
+
+!define MUI_DIRECTORYPAGE_TEXT_TOP $(DIR_SUBTITLE)
+!define MUI_DIRECTORYPAGE_TEXT_DESTINATION $(DIR_INNERTEXT)
+!insertmacro MUI_PAGE_DIRECTORY
+
+!insertmacro MUI_PAGE_INSTFILES
+
+!define MUI_FINISHPAGE_TITLE $(FINISH_TITLE)
+!define MUI_FINISHPAGE_TEXT $(FINISH_TEXT)
+!insertmacro MUI_PAGE_FINISH
+
+; MUI Config
+
+!define MUI_CUSTOMFUNCTION_GUIINIT gaym_checkGaimVersion
+!define MUI_ABORTWARNING
+!define MUI_UNINSTALLER
+!define MUI_PROGRESSBAR smooth
+!define MUI_INSTALLCOLORS /windows
+
+!insertmacro MUI_LANGUAGE "English"
+
+!define MUI_LICENSEPAGE_RADIOBUTTONS
+
+
+;The Default Installation Directory
+InstallDir "$PROGRAMFILES\gaim"
+InstallDirRegKey HKLM SOFTWARE\gaim ""
+
+Section -SecUninstallOldPlugin
+  ; Check install rights..
+  Call CheckUserInstallRights
+  Pop $R0
+
+  StrCmp $R0 "HKLM" rights_hklm
+  StrCmp $R0 "HKCU" rights_hkcu done
+
+  rights_hkcu:
+      ReadRegStr $R1 HKCU "${GAYM_REG_KEY}" ""
+      ReadRegStr $R2 HKCU "${GAYM_REG_KEY}" "Version"
+      ReadRegStr $R3 HKCU "${GAYM_UNINSTALL_KEY}" "UninstallString"
+      Goto try_uninstall
+
+  rights_hklm:
+      ReadRegStr $R1 HKLM "${GAYM_REG_KEY}" ""
+      ReadRegStr $R2 HKLM "${GAYM_REG_KEY}" "Version"
+      ReadRegStr $R3 HKLM "${GAYM_UNINSTALL_KEY}" "UninstallString"
+
+  ; If previous version exists .. remove
+  try_uninstall:
+    StrCmp $R1 "" done
+      StrCmp $R2 "" uninstall_problem
+        IfFileExists $R3 0 uninstall_problem
+          ; Have uninstall string.. go ahead and uninstall.
+          SetOverwrite on
+          ; Need to copy uninstaller outside of the install dir
+          ClearErrors
+          CopyFiles /SILENT $R3 "$TEMP\${GAYM_UNINST_EXE}"
+          SetOverwrite off
+          IfErrors uninstall_problem
+            ; Ready to uninstall..
+            ClearErrors
+            ExecWait '"$TEMP\${GAYM_UNINST_EXE}" /S _?=$R1'
+            IfErrors exec_error
+              Delete "$TEMP\${GAYM_UNINST_EXE}"
+              Goto done
+
+            exec_error:
+              Delete "$TEMP\${GAYM_UNINST_EXE}"
+              Goto uninstall_problem
+
+        uninstall_problem:
+            ; Just delete the plugin and uninstaller, and remove Registry key
+             MessageBox MB_YESNO $(GAYM_PROMPT_WIPEOUT) IDYES do_wipeout IDNO cancel_install
+          cancel_install:
+            Quit
+
+          do_wipeout:
+            StrCmp $R0 "HKLM" del_lm_reg del_cu_reg
+            del_cu_reg:
+              DeleteRegKey HKCU ${GAYM_REG_KEY}
+              Goto uninstall_prob_cont
+            del_lm_reg:
+              DeleteRegKey HKLM ${GAYM_REG_KEY}
+
+            uninstall_prob_cont:
+              ; plugin DLL
+              Delete "$R1\plugins\${GAYM_DLL}"
+              ; pixmaps
+              Delete "$R1\pixmaps\gaim\status\default\${GAYM_PNG}"
+              Delete "$R3"
+
+  done:
+
+SectionEnd
+
+
+Section "Install"
+  Call CheckUserInstallRights
+  Pop $R0
+
+  StrCmp $R0 "NONE" instrights_none
+  StrCmp $R0 "HKLM" instrights_hklm instrights_hkcu
+
+  instrights_hklm:
+    ; Write the version registry keys:
+    WriteRegStr HKLM ${GAYM_REG_KEY} "" "$INSTDIR"
+    WriteRegStr HKLM ${GAYM_REG_KEY} "Version" "${GAYM_VERSION}"
+
+    ; Write the uninstall keys for Windows
+    WriteRegStr HKLM ${GAYM_UNINSTALL_KEY} "DisplayName" "$(GAYM_UNINSTALL_DESC)"
+    WriteRegStr HKLM ${GAYM_UNINSTALL_KEY} "UninstallString" "$INSTDIR\${GAYM_UNINST_EXE}"
+    SetShellVarContext "all"
+    Goto install_files
+
+  instrights_hkcu:
+    ; Write the version registry keys:
+    WriteRegStr HKCU ${GAYM_REG_KEY} "" "$INSTDIR"
+    WriteRegStr HKCU ${GAYM_REG_KEY} "Version" "${GAYM_VERSION}"
+
+    ; Write the uninstall keys for Windows
+    WriteRegStr HKCU ${GAYM_UNINSTALL_KEY} "DisplayName" "$(GAYM_UNINSTALL_DESC)"
+    WriteRegStr HKCU ${GAYM_UNINSTALL_KEY} "UninstallString" "$INSTDIR\${GAYM_UNINST_EXE}"
+    Goto install_files
+  
+  instrights_none:
+    ; No registry keys for us...
+    
+  install_files:
+    SetOutPath "$INSTDIR\plugins"
+    SetCompress Auto
+    SetOverwrite on
+    File "..\src\${GAYM_DLL}"
+    
+    SetOutPath "$INSTDIR\pixmaps\gaim\status\default"
+    File "..\pixmaps\${GAYM_PNG}"
+    
+    StrCmp $R0 "NONE" done
+    CreateShortCut "$SMPROGRAMS\Gaim\${GAYM_UNINSTALL_LNK}" "$INSTDIR\${GAYM_UNINST_EXE}"
+    WriteUninstaller "$INSTDIR\${GAYM_UNINST_EXE}"
+    SetOverWrite off
+
+  done:
+SectionEnd
+
+Section Uninstall
+  Call un.CheckUserInstallRights
+  Pop $R0
+  StrCmp $R0 "NONE" no_rights
+  StrCmp $R0 "HKCU" try_hkcu try_hklm
+
+  try_hkcu:
+    ReadRegStr $R0 HKCU "${GAYM_REG_KEY}" ""
+    StrCmp $R0 $INSTDIR 0 cant_uninstall
+      ; HKCU install path matches our INSTDIR.. so uninstall
+      DeleteRegKey HKCU "${GAYM_REG_KEY}"
+      DeleteRegKey HKCU "${GAYM_UNINSTALL_KEY}"
+      Goto cont_uninstall
+
+  try_hklm:
+    ReadRegStr $R0 HKLM "${GAYM_REG_KEY}" ""
+    StrCmp $R0 $INSTDIR 0 try_hkcu
+      ; HKLM install path matches our INSTDIR.. so uninstall
+      DeleteRegKey HKLM "${GAYM_REG_KEY}"
+      DeleteRegKey HKLM "${GAYM_UNINSTALL_KEY}"
+      ; Sets start menu and desktop scope to all users..
+      SetShellVarContext "all"
+
+  cont_uninstall:
+    ; plugin 
+    Delete "$INSTDIR\plugins\${GAYM_DLL}"
+    ; pixmaps
+    Delete "$INSTDIR\pixmaps\gaim\status\default\${GAYM_PNG}"
+    ; uninstaller
+    Delete "$INSTDIR\${GAYM_UNINST_EXE}"
+    ; uninstaller shortcut
+    Delete "$SMPROGRAMS\Gaim\${GAYM_UNINSTALL_LNK}"
+    
+    ; try to delete the Gaim directories, in case it has already uninstalled
+    RMDir "$INSTDIR\plugins"
+    RMDir "$INSTDIR"
+    RMDir "$SMPROGRAMS\Gaim"
+
+    Goto done
+
+  cant_uninstall:
+    MessageBox MB_OK $(un.GAYM_UNINSTALL_ERROR_1) IDOK
+    Quit
+
+  no_rights:
+    MessageBox MB_OK $(un.GAYM_UNINSTALL_ERROR_2) IDOK
+    Quit
+
+  done:
+SectionEnd
+
+Function .onVerifyInstDir
+  IfFileExists $INSTDIR\gaim.exe Good1
+    Abort
+  Good1:
+FunctionEnd
+
+Function gaym_checkGaimVersion
+  Push $R0
+
+  Push ${GAIM_VERSION}
+  Call CheckGaimVersion
+  Pop $R0
+
+  StrCmp $R0 ${GAIM_VERSION_OK} gaym_checkGaimVersion_OK
+  StrCmp $R0 ${GAIM_VERSION_INCOMPATIBLE} +1 +6
+    Call GetGaimVersion
+    IfErrors +3
+    Pop $R0
+    MessageBox MB_OK|MB_ICONSTOP "$(BAD_GAIM_VERSION_1) $R0 $(BAD_GAIM_VERSION_2)"
+    goto +2
+    MessageBox MB_OK|MB_ICONSTOP "$(NO_GAIM_VERSION)"
+    Quit
+
+  gaym_checkGaimVersion_OK:
+  Pop $R0
+FunctionEnd
+
+Function CheckUserInstallRights
+        ClearErrors
+        UserInfo::GetName
+        IfErrors Win9x
+        Pop $0
+        UserInfo::GetAccountType
+        Pop $1
+
+        StrCmp $1 "Admin" 0 +3
+                StrCpy $1 "HKLM"
+                Goto done
+        StrCmp $1 "Power" 0 +3
+                StrCpy $1 "HKLM"
+                Goto done
+        StrCmp $1 "User" 0 +3
+                StrCpy $1 "HKCU"
+                Goto done
+        StrCmp $1 "Guest" 0 +3
+                StrCpy $1 "NONE"
+                Goto done
+        ; Unknown error
+        StrCpy $1 "NONE"
+        Goto done
+
+        Win9x:
+                StrCpy $1 "HKLM"
+
+        done:
+        Push $1
+FunctionEnd
+
+Function un.CheckUserInstallRights
+        ClearErrors
+        UserInfo::GetName
+        IfErrors Win9x
+        Pop $0
+        UserInfo::GetAccountType
+        Pop $1
+        StrCmp $1 "Admin" 0 +3
+                StrCpy $1 "HKLM"
+                Goto done
+        StrCmp $1 "Power" 0 +3
+                StrCpy $1 "HKLM"
+                Goto done
+        StrCmp $1 "User" 0 +3
+                StrCpy $1 "HKCU"
+                Goto done
+        StrCmp $1 "Guest" 0 +3
+                StrCpy $1 "NONE"
+                Goto done
+        ; Unknown error
+        StrCpy $1 "NONE"
+        Goto done
+
+        Win9x:
+                StrCpy $1 "HKLM"
+
+        done:
+        Push $1
+FunctionEnd
+
+

Added: gaym/trunk/nsis/locale/english.nsh
===================================================================
--- gaym/trunk/nsis/locale/english.nsh	2005-06-03 16:23:17 UTC (rev 58)
+++ gaym/trunk/nsis/locale/english.nsh	2005-06-03 20:20:34 UTC (rev 59)
@@ -0,0 +1,39 @@
+;;
+;;  english.nsh
+;;
+;;  Default language strings for the Windows gaim-gaym NSIS installer.
+;;  Windows Code page: 1252
+;;
+
+; Startup Gaim check
+LangString GAIM_NEEDED ${LANG_ENGLISH} "Gaim-GayM requires that Gaim be installed. You must install Gaim (http://gaim.sourceforge.net/win32/index.php) before installing Gaim-GayM."
+
+LangString GAYM_TITLE ${LANG_ENGLISH} "Gaim-GayM plugin for Gaim"
+
+LangString NO_GAIM_VERSION ${LANG_ENGLISH} "Unable to determine installed Gaim version."
+
+LangString BAD_GAIM_VERSION_1 ${LANG_ENGLISH} "Incompatible version.$\r$\n$\r$\nThis version of the Gaim-GayM plugin was built for Gaim version ${GAIM_VERSION}.  It appears that you have Gaim version"
+
+LangString BAD_GAIM_VERSION_2 ${LANG_ENGLISH} "installed.$\r$\n$\r$\nSee http://developer.berlios.de/projects/qrc/ for more information."
+
+; Overrides for default text in windows:
+
+LangString WELCOME_TITLE ${LANG_ENGLISH} "Gaim-GayM v${GAYM_VERSION} Installer"
+LangString WELCOME_TEXT  ${LANG_ENGLISH} "Note: This version of the plugin is designed for Gaim ${GAIM_VERSION}, and will not install or function with other versions of Gaim.\r\n\r\nWhen you upgrade your version of Gaim, you must uninstall or upgrade this plugin as well.\r\n\r\n"
+
+LangString DIR_SUBTITLE ${LANG_ENGLISH} "Please locate the directory where Gaim is installed"
+LangString DIR_INNERTEXT ${LANG_ENGLISH} "Install in this Gaim folder:"
+
+LangString FINISH_TITLE ${LANG_ENGLISH} "Gaim-GayM v${GAYM_VERSION} Install Complete"
+LangString FINISH_TEXT ${LANG_ENGLISH} "You will need to restart Gaim for the plugin to be loaded."
+
+; during install uninstaller
+LangString GAYM_PROMPT_WIPEOUT ${LANG_ENGLISH} "The libgaym.dll plugin is about to be deleted from your Gaim/plugins directory.  Continue?"
+
+; for windows uninstall
+LangString GAYM_UNINSTALL_DESC ${LANG_ENGLISH} "Gaim-GayM Plugin (remove only)"
+LangString un.GAYM_UNINSTALL_ERROR_1 ${LANG_ENGLISH} "The uninstaller could not find registry entries for Gaim-GayM.$\rIt is likely that another user installed the plugin."
+LangString un.GAYM_UNINSTALL_ERROR_2 ${LANG_ENGLISH} "You do not have the permissions necessary to uninstall the plugin."
+
+
+

Added: gaym/trunk/nsis/pixmaps/gaym.bmp
===================================================================
(Binary files differ)


Property changes on: gaym/trunk/nsis/pixmaps/gaym.bmp
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Deleted: gaym/trunk/pixmaps/Makefile.mingw
===================================================================
--- gaym/trunk/pixmaps/Makefile.mingw	2005-06-03 16:23:17 UTC (rev 58)
+++ gaym/trunk/pixmaps/Makefile.mingw	2005-06-03 20:20:34 UTC (rev 59)
@@ -1,13 +0,0 @@
-#
-# Makefile.mingw
-#
-# Description: Makefile for win32 (mingw) version of libgaym
-
-include ../Include.mingw
-
-TARGET = gaym
-
-
-install:
-	cp $(TARGET).png ../$(INSTALL_DIR)
-

Modified: gaym/trunk/src/Makefile.mingw
===================================================================
--- gaym/trunk/src/Makefile.mingw	2005-06-03 16:23:17 UTC (rev 58)
+++ gaym/trunk/src/Makefile.mingw	2005-06-03 20:20:34 UTC (rev 59)
@@ -3,8 +3,6 @@
 #
 # Description: Makefile for win32 (mingw) version of libgaym
 
-include ../Include.mingw
-
 # Compiler Options
 
 CFLAGS =
@@ -105,10 +103,7 @@
 
 all: $(TARGET).dll
 
-install:
-	cp $(TARGET).dll ../$(INSTALL_DIR)
 
-
 ##
 ## BUILD DLL
 ##

Modified: gaym/trunk/src/gaym.c
===================================================================
--- gaym/trunk/src/gaym.c	2005-06-03 16:23:17 UTC (rev 58)
+++ gaym/trunk/src/gaym.c	2005-06-03 20:20:34 UTC (rev 59)
@@ -778,12 +778,12 @@
 }
 
 // According to http://www.gay.com/members/join/ the member name is:
-//
-//   - Up to 30 characters
-//   - Must begin with a letter
-//   - Can contain only letters, numbers, and underscores ( _ )
-//   - Cannot contain special characters, spaces, periods, or hyphens (-)
-//
+// 
+// - Up to 30 characters
+// - Must begin with a letter
+// - Can contain only letters, numbers, and underscores ( _ )
+// - Cannot contain special characters, spaces, periods, or hyphens (-)
+// 
 // However, in testing as well as observing existing members, the
 // the member name may in fact contain periods and hyphens.
 



From deckrider at sheep.berlios.de  Sat Jun  4 00:29:12 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Sat, 4 Jun 2005 00:29:12 +0200
Subject: [Qrc-svn] r60 - in gaym/trunk: . nsis nsis/locale nsis/pixmaps pixmaps
Message-ID: <200506032229.j53MTCB0020828@sheep.berlios.de>

Author: deckrider
Date: 2005-06-04 00:29:11 +0200 (Sat, 04 Jun 2005)
New Revision: 60

Added:
   gaym/trunk/nsis/Makefile.am
   gaym/trunk/nsis/locale/Makefile.am
   gaym/trunk/nsis/pixmaps/Makefile.am
   gaym/trunk/nsis/pixmaps/gaym.ico
Modified:
   gaym/trunk/Makefile.am
   gaym/trunk/configure.ac
   gaym/trunk/nsis/gaim-gaym.nsi
   gaym/trunk/pixmaps/Makefile.am
Log:
- Integrate the nsis stuff into the autoconf/automake system.
- Add nsis/pixmaps/gaym.ico for the installer package icon.


Modified: gaym/trunk/Makefile.am
===================================================================
--- gaym/trunk/Makefile.am	2005-06-03 20:20:34 UTC (rev 59)
+++ gaym/trunk/Makefile.am	2005-06-03 22:29:11 UTC (rev 60)
@@ -1,9 +1,9 @@
 EXTRA_DIST = \
-	Include.mingw \
 	Makefile.mingw \
 	README.mingw \
 	TODO
 
 SUBDIRS = \
+	nsis \
 	src \
         pixmaps

Modified: gaym/trunk/configure.ac
===================================================================
--- gaym/trunk/configure.ac	2005-06-03 20:20:34 UTC (rev 59)
+++ gaym/trunk/configure.ac	2005-06-03 22:29:11 UTC (rev 60)
@@ -56,6 +56,9 @@
 AC_SUBST(CFLAGS)
 
 AC_CONFIG_FILES([Makefile
+                 nsis/Makefile
+		 nsis/locale/Makefile
+		 nsis/pixmaps/Makefile
                  pixmaps/Makefile
                  src/Makefile])
 AC_OUTPUT

Added: gaym/trunk/nsis/Makefile.am
===================================================================
--- gaym/trunk/nsis/Makefile.am	2005-06-03 20:20:34 UTC (rev 59)
+++ gaym/trunk/nsis/Makefile.am	2005-06-03 22:29:11 UTC (rev 60)
@@ -0,0 +1,6 @@
+EXTRA_DIST = \
+	gaim-gaym.nsi
+
+SUBDIRS = \
+	locale \
+	pixmaps

Modified: gaym/trunk/nsis/gaim-gaym.nsi
===================================================================
--- gaym/trunk/nsis/gaim-gaym.nsi	2005-06-03 20:20:34 UTC (rev 59)
+++ gaym/trunk/nsis/gaim-gaym.nsi	2005-06-03 22:29:11 UTC (rev 60)
@@ -12,9 +12,7 @@
 !define GAYM_DLL            "libgaym.dll"
 !define GAYM_PNG            "gaym.png"
 !define GAYM_UNINSTALL_LNK  "Gaim-GayM Uninstall.lnk"
-!define GAIM_MACRO_DEFAULT_STRING "Gaim-GayM"
 
-
 !include "MUI.nsh"
 
 ;Do A CRC Check
@@ -30,15 +28,15 @@
 ; Translations
 !include "locale\english.nsh"
 
-;-------------------------------
 ; Gaim Plugin installer helper stuff
+
 !addincludedir "${GAIM_TOP}\src\win32\nsis"
 !include "gaim-plugin.nsh"
 
 ; Modern UI Configuration
 
-;!define MUI_ICON .\nsis\install.ico
-;!define MUI_UNICON .\nsis\install.ico
+!define MUI_ICON "pixmaps\gaym.ico"
+!define MUI_UNICON "pixmaps\gaym.ico"
 !define MUI_HEADERIMAGE
 !define MUI_HEADERIMAGE_BITMAP "pixmaps\gaym.bmp"
 

Added: gaym/trunk/nsis/locale/Makefile.am
===================================================================
--- gaym/trunk/nsis/locale/Makefile.am	2005-06-03 20:20:34 UTC (rev 59)
+++ gaym/trunk/nsis/locale/Makefile.am	2005-06-03 22:29:11 UTC (rev 60)
@@ -0,0 +1,2 @@
+EXTRA_DIST = \
+	english.nsh

Added: gaym/trunk/nsis/pixmaps/Makefile.am
===================================================================
--- gaym/trunk/nsis/pixmaps/Makefile.am	2005-06-03 20:20:34 UTC (rev 59)
+++ gaym/trunk/nsis/pixmaps/Makefile.am	2005-06-03 22:29:11 UTC (rev 60)
@@ -0,0 +1,3 @@
+EXTRA_DIST = \
+	gaym.bmp \
+	gaym.ico

Added: gaym/trunk/nsis/pixmaps/gaym.ico
===================================================================
(Binary files differ)


Property changes on: gaym/trunk/nsis/pixmaps/gaym.ico
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Modified: gaym/trunk/pixmaps/Makefile.am
===================================================================
--- gaym/trunk/pixmaps/Makefile.am	2005-06-03 20:20:34 UTC (rev 59)
+++ gaym/trunk/pixmaps/Makefile.am	2005-06-03 22:29:11 UTC (rev 60)
@@ -1,6 +1,5 @@
 EXTRA_DIST = \
-	gaym.png \
-	Makefile.mingw
+	gaym.png
 
 gaymstatuspixdir = \
 	$(GAIM_DATADIR)/pixmaps/gaim/status/default



From deckrider at sheep.berlios.de  Sat Jun  4 08:16:17 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Sat, 4 Jun 2005 08:16:17 +0200
Subject: [Qrc-svn] r61 - in gaym/trunk: . nsis
Message-ID: <200506040616.j546GHG5031654@sheep.berlios.de>

Author: deckrider
Date: 2005-06-04 08:16:05 +0200 (Sat, 04 Jun 2005)
New Revision: 61

Added:
   gaym/trunk/nsis/installer.nsi
Removed:
   gaym/trunk/nsis/gaim-gaym.nsi
   gaym/trunk/nsis/pixmaps/
Modified:
   gaym/trunk/Makefile.mingw
   gaym/trunk/configure.ac
   gaym/trunk/nsis/Makefile.am
Log:
More windows packaging updates.  Trying to simplify a bit.


Modified: gaym/trunk/Makefile.mingw
===================================================================
--- gaym/trunk/Makefile.mingw	2005-06-03 22:29:11 UTC (rev 60)
+++ gaym/trunk/Makefile.mingw	2005-06-04 06:16:05 UTC (rev 61)
@@ -10,7 +10,7 @@
 	$(MAKENSIS) \
 		-DGAYM_VERSION="$(GAYM_VERSION)" \
 		-DGAIM_VERSION="$(GAIM_VERSION)" \
-		-DGAIM_TOP="$(GAIM_TOP)" nsis/gaim-gaym.nsi
+		-DGAIM_TOP="$(GAIM_TOP)" nsis/installer.nsi
 
 clean:
 	$(MAKE) -C src -f Makefile.mingw clean

Modified: gaym/trunk/configure.ac
===================================================================
--- gaym/trunk/configure.ac	2005-06-03 22:29:11 UTC (rev 60)
+++ gaym/trunk/configure.ac	2005-06-04 06:16:05 UTC (rev 61)
@@ -58,7 +58,6 @@
 AC_CONFIG_FILES([Makefile
                  nsis/Makefile
 		 nsis/locale/Makefile
-		 nsis/pixmaps/Makefile
                  pixmaps/Makefile
                  src/Makefile])
 AC_OUTPUT

Modified: gaym/trunk/nsis/Makefile.am
===================================================================
--- gaym/trunk/nsis/Makefile.am	2005-06-03 22:29:11 UTC (rev 60)
+++ gaym/trunk/nsis/Makefile.am	2005-06-04 06:16:05 UTC (rev 61)
@@ -1,6 +1,5 @@
 EXTRA_DIST = \
-	gaim-gaym.nsi
+	installer.nsi
 
 SUBDIRS = \
-	locale \
-	pixmaps
+	locale

Deleted: gaym/trunk/nsis/gaim-gaym.nsi
===================================================================
--- gaym/trunk/nsis/gaim-gaym.nsi	2005-06-03 22:29:11 UTC (rev 60)
+++ gaym/trunk/nsis/gaim-gaym.nsi	2005-06-04 06:16:05 UTC (rev 61)
@@ -1,333 +0,0 @@
-; NSIS Script For Gaim-GayM Plugin
-; Author Don Seiler
-; Based on the Gaim-BNET installer by Daniel Atallah
-; Uses NSIS v2.0
-
-Name "Gaim-GayM ${GAYM_VERSION}"
-
-; Registry keys:
-!define GAYM_REG_KEY        "SOFTWARE\gaim-gaym"
-!define GAYM_UNINSTALL_KEY  "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\gaim-gaym"
-!define GAYM_UNINST_EXE     "gaim-gaym-uninst.exe"
-!define GAYM_DLL            "libgaym.dll"
-!define GAYM_PNG            "gaym.png"
-!define GAYM_UNINSTALL_LNK  "Gaim-GayM Uninstall.lnk"
-
-!include "MUI.nsh"
-
-;Do A CRC Check
-CRCCheck On
-
-;Output File Name
-OutFile "..\gaim-gaym-${GAYM_VERSION}.exe"
-
-ShowInstDetails show
-ShowUnInstDetails show
-SetCompressor lzma
-
-; Translations
-!include "locale\english.nsh"
-
-; Gaim Plugin installer helper stuff
-
-!addincludedir "${GAIM_TOP}\src\win32\nsis"
-!include "gaim-plugin.nsh"
-
-; Modern UI Configuration
-
-!define MUI_ICON "pixmaps\gaym.ico"
-!define MUI_UNICON "pixmaps\gaym.ico"
-!define MUI_HEADERIMAGE
-!define MUI_HEADERIMAGE_BITMAP "pixmaps\gaym.bmp"
-
-
-; Pages
-!define MUI_WELCOMEPAGE_TITLE $(WELCOME_TITLE)
-!define MUI_WELCOMEPAGE_TEXT $(WELCOME_TEXT)
-!insertmacro MUI_PAGE_WELCOME
-
-!insertmacro MUI_PAGE_LICENSE  "..\COPYING"
-
-!define MUI_DIRECTORYPAGE_TEXT_TOP $(DIR_SUBTITLE)
-!define MUI_DIRECTORYPAGE_TEXT_DESTINATION $(DIR_INNERTEXT)
-!insertmacro MUI_PAGE_DIRECTORY
-
-!insertmacro MUI_PAGE_INSTFILES
-
-!define MUI_FINISHPAGE_TITLE $(FINISH_TITLE)
-!define MUI_FINISHPAGE_TEXT $(FINISH_TEXT)
-!insertmacro MUI_PAGE_FINISH
-
-; MUI Config
-
-!define MUI_CUSTOMFUNCTION_GUIINIT gaym_checkGaimVersion
-!define MUI_ABORTWARNING
-!define MUI_UNINSTALLER
-!define MUI_PROGRESSBAR smooth
-!define MUI_INSTALLCOLORS /windows
-
-!insertmacro MUI_LANGUAGE "English"
-
-!define MUI_LICENSEPAGE_RADIOBUTTONS
-
-
-;The Default Installation Directory
-InstallDir "$PROGRAMFILES\gaim"
-InstallDirRegKey HKLM SOFTWARE\gaim ""
-
-Section -SecUninstallOldPlugin
-  ; Check install rights..
-  Call CheckUserInstallRights
-  Pop $R0
-
-  StrCmp $R0 "HKLM" rights_hklm
-  StrCmp $R0 "HKCU" rights_hkcu done
-
-  rights_hkcu:
-      ReadRegStr $R1 HKCU "${GAYM_REG_KEY}" ""
-      ReadRegStr $R2 HKCU "${GAYM_REG_KEY}" "Version"
-      ReadRegStr $R3 HKCU "${GAYM_UNINSTALL_KEY}" "UninstallString"
-      Goto try_uninstall
-
-  rights_hklm:
-      ReadRegStr $R1 HKLM "${GAYM_REG_KEY}" ""
-      ReadRegStr $R2 HKLM "${GAYM_REG_KEY}" "Version"
-      ReadRegStr $R3 HKLM "${GAYM_UNINSTALL_KEY}" "UninstallString"
-
-  ; If previous version exists .. remove
-  try_uninstall:
-    StrCmp $R1 "" done
-      StrCmp $R2 "" uninstall_problem
-        IfFileExists $R3 0 uninstall_problem
-          ; Have uninstall string.. go ahead and uninstall.
-          SetOverwrite on
-          ; Need to copy uninstaller outside of the install dir
-          ClearErrors
-          CopyFiles /SILENT $R3 "$TEMP\${GAYM_UNINST_EXE}"
-          SetOverwrite off
-          IfErrors uninstall_problem
-            ; Ready to uninstall..
-            ClearErrors
-            ExecWait '"$TEMP\${GAYM_UNINST_EXE}" /S _?=$R1'
-            IfErrors exec_error
-              Delete "$TEMP\${GAYM_UNINST_EXE}"
-              Goto done
-
-            exec_error:
-              Delete "$TEMP\${GAYM_UNINST_EXE}"
-              Goto uninstall_problem
-
-        uninstall_problem:
-            ; Just delete the plugin and uninstaller, and remove Registry key
-             MessageBox MB_YESNO $(GAYM_PROMPT_WIPEOUT) IDYES do_wipeout IDNO cancel_install
-          cancel_install:
-            Quit
-
-          do_wipeout:
-            StrCmp $R0 "HKLM" del_lm_reg del_cu_reg
-            del_cu_reg:
-              DeleteRegKey HKCU ${GAYM_REG_KEY}
-              Goto uninstall_prob_cont
-            del_lm_reg:
-              DeleteRegKey HKLM ${GAYM_REG_KEY}
-
-            uninstall_prob_cont:
-              ; plugin DLL
-              Delete "$R1\plugins\${GAYM_DLL}"
-              ; pixmaps
-              Delete "$R1\pixmaps\gaim\status\default\${GAYM_PNG}"
-              Delete "$R3"
-
-  done:
-
-SectionEnd
-
-
-Section "Install"
-  Call CheckUserInstallRights
-  Pop $R0
-
-  StrCmp $R0 "NONE" instrights_none
-  StrCmp $R0 "HKLM" instrights_hklm instrights_hkcu
-
-  instrights_hklm:
-    ; Write the version registry keys:
-    WriteRegStr HKLM ${GAYM_REG_KEY} "" "$INSTDIR"
-    WriteRegStr HKLM ${GAYM_REG_KEY} "Version" "${GAYM_VERSION}"
-
-    ; Write the uninstall keys for Windows
-    WriteRegStr HKLM ${GAYM_UNINSTALL_KEY} "DisplayName" "$(GAYM_UNINSTALL_DESC)"
-    WriteRegStr HKLM ${GAYM_UNINSTALL_KEY} "UninstallString" "$INSTDIR\${GAYM_UNINST_EXE}"
-    SetShellVarContext "all"
-    Goto install_files
-
-  instrights_hkcu:
-    ; Write the version registry keys:
-    WriteRegStr HKCU ${GAYM_REG_KEY} "" "$INSTDIR"
-    WriteRegStr HKCU ${GAYM_REG_KEY} "Version" "${GAYM_VERSION}"
-
-    ; Write the uninstall keys for Windows
-    WriteRegStr HKCU ${GAYM_UNINSTALL_KEY} "DisplayName" "$(GAYM_UNINSTALL_DESC)"
-    WriteRegStr HKCU ${GAYM_UNINSTALL_KEY} "UninstallString" "$INSTDIR\${GAYM_UNINST_EXE}"
-    Goto install_files
-  
-  instrights_none:
-    ; No registry keys for us...
-    
-  install_files:
-    SetOutPath "$INSTDIR\plugins"
-    SetCompress Auto
-    SetOverwrite on
-    File "..\src\${GAYM_DLL}"
-    
-    SetOutPath "$INSTDIR\pixmaps\gaim\status\default"
-    File "..\pixmaps\${GAYM_PNG}"
-    
-    StrCmp $R0 "NONE" done
-    CreateShortCut "$SMPROGRAMS\Gaim\${GAYM_UNINSTALL_LNK}" "$INSTDIR\${GAYM_UNINST_EXE}"
-    WriteUninstaller "$INSTDIR\${GAYM_UNINST_EXE}"
-    SetOverWrite off
-
-  done:
-SectionEnd
-
-Section Uninstall
-  Call un.CheckUserInstallRights
-  Pop $R0
-  StrCmp $R0 "NONE" no_rights
-  StrCmp $R0 "HKCU" try_hkcu try_hklm
-
-  try_hkcu:
-    ReadRegStr $R0 HKCU "${GAYM_REG_KEY}" ""
-    StrCmp $R0 $INSTDIR 0 cant_uninstall
-      ; HKCU install path matches our INSTDIR.. so uninstall
-      DeleteRegKey HKCU "${GAYM_REG_KEY}"
-      DeleteRegKey HKCU "${GAYM_UNINSTALL_KEY}"
-      Goto cont_uninstall
-
-  try_hklm:
-    ReadRegStr $R0 HKLM "${GAYM_REG_KEY}" ""
-    StrCmp $R0 $INSTDIR 0 try_hkcu
-      ; HKLM install path matches our INSTDIR.. so uninstall
-      DeleteRegKey HKLM "${GAYM_REG_KEY}"
-      DeleteRegKey HKLM "${GAYM_UNINSTALL_KEY}"
-      ; Sets start menu and desktop scope to all users..
-      SetShellVarContext "all"
-
-  cont_uninstall:
-    ; plugin 
-    Delete "$INSTDIR\plugins\${GAYM_DLL}"
-    ; pixmaps
-    Delete "$INSTDIR\pixmaps\gaim\status\default\${GAYM_PNG}"
-    ; uninstaller
-    Delete "$INSTDIR\${GAYM_UNINST_EXE}"
-    ; uninstaller shortcut
-    Delete "$SMPROGRAMS\Gaim\${GAYM_UNINSTALL_LNK}"
-    
-    ; try to delete the Gaim directories, in case it has already uninstalled
-    RMDir "$INSTDIR\plugins"
-    RMDir "$INSTDIR"
-    RMDir "$SMPROGRAMS\Gaim"
-
-    Goto done
-
-  cant_uninstall:
-    MessageBox MB_OK $(un.GAYM_UNINSTALL_ERROR_1) IDOK
-    Quit
-
-  no_rights:
-    MessageBox MB_OK $(un.GAYM_UNINSTALL_ERROR_2) IDOK
-    Quit
-
-  done:
-SectionEnd
-
-Function .onVerifyInstDir
-  IfFileExists $INSTDIR\gaim.exe Good1
-    Abort
-  Good1:
-FunctionEnd
-
-Function gaym_checkGaimVersion
-  Push $R0
-
-  Push ${GAIM_VERSION}
-  Call CheckGaimVersion
-  Pop $R0
-
-  StrCmp $R0 ${GAIM_VERSION_OK} gaym_checkGaimVersion_OK
-  StrCmp $R0 ${GAIM_VERSION_INCOMPATIBLE} +1 +6
-    Call GetGaimVersion
-    IfErrors +3
-    Pop $R0
-    MessageBox MB_OK|MB_ICONSTOP "$(BAD_GAIM_VERSION_1) $R0 $(BAD_GAIM_VERSION_2)"
-    goto +2
-    MessageBox MB_OK|MB_ICONSTOP "$(NO_GAIM_VERSION)"
-    Quit
-
-  gaym_checkGaimVersion_OK:
-  Pop $R0
-FunctionEnd
-
-Function CheckUserInstallRights
-        ClearErrors
-        UserInfo::GetName
-        IfErrors Win9x
-        Pop $0
-        UserInfo::GetAccountType
-        Pop $1
-
-        StrCmp $1 "Admin" 0 +3
-                StrCpy $1 "HKLM"
-                Goto done
-        StrCmp $1 "Power" 0 +3
-                StrCpy $1 "HKLM"
-                Goto done
-        StrCmp $1 "User" 0 +3
-                StrCpy $1 "HKCU"
-                Goto done
-        StrCmp $1 "Guest" 0 +3
-                StrCpy $1 "NONE"
-                Goto done
-        ; Unknown error
-        StrCpy $1 "NONE"
-        Goto done
-
-        Win9x:
-                StrCpy $1 "HKLM"
-
-        done:
-        Push $1
-FunctionEnd
-
-Function un.CheckUserInstallRights
-        ClearErrors
-        UserInfo::GetName
-        IfErrors Win9x
-        Pop $0
-        UserInfo::GetAccountType
-        Pop $1
-        StrCmp $1 "Admin" 0 +3
-                StrCpy $1 "HKLM"
-                Goto done
-        StrCmp $1 "Power" 0 +3
-                StrCpy $1 "HKLM"
-                Goto done
-        StrCmp $1 "User" 0 +3
-                StrCpy $1 "HKCU"
-                Goto done
-        StrCmp $1 "Guest" 0 +3
-                StrCpy $1 "NONE"
-                Goto done
-        ; Unknown error
-        StrCpy $1 "NONE"
-        Goto done
-
-        Win9x:
-                StrCpy $1 "HKLM"
-
-        done:
-        Push $1
-FunctionEnd
-
-

Added: gaym/trunk/nsis/installer.nsi
===================================================================
--- gaym/trunk/nsis/installer.nsi	2005-06-03 22:29:11 UTC (rev 60)
+++ gaym/trunk/nsis/installer.nsi	2005-06-04 06:16:05 UTC (rev 61)
@@ -0,0 +1,327 @@
+; NSIS Script For Gaim-GayM Plugin
+; Uses NSIS v2.0
+
+Name "Gaim-GayM ${GAYM_VERSION}"
+
+; Registry keys:
+!define GAYM_REG_KEY        "SOFTWARE\gaim-gaym"
+!define GAYM_UNINSTALL_KEY  "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\gaim-gaym"
+!define GAYM_UNINST_EXE     "gaim-gaym-uninst.exe"
+!define GAYM_DLL            "libgaym.dll"
+!define GAYM_PNG            "gaym.png"
+!define GAYM_UNINSTALL_LNK  "Gaim-GayM Uninstall.lnk"
+
+!include "MUI.nsh"
+
+;Do A CRC Check
+CRCCheck On
+
+;Output File Name
+OutFile "..\gaim-gaym-${GAYM_VERSION}.exe"
+
+ShowInstDetails show
+ShowUnInstDetails show
+SetCompressor lzma
+
+; Translations
+!include "locale\english.nsh"
+
+; Gaim Plugin installer helper stuff
+
+!addincludedir "${GAIM_TOP}\src\win32\nsis"
+!include "gaim-plugin.nsh"
+
+; Modern UI Configuration
+!define MUI_HEADERIMAGE
+
+; Pages
+!define MUI_WELCOMEPAGE_TITLE $(WELCOME_TITLE)
+!define MUI_WELCOMEPAGE_TEXT $(WELCOME_TEXT)
+!insertmacro MUI_PAGE_WELCOME
+
+!insertmacro MUI_PAGE_LICENSE  "..\COPYING"
+
+!define MUI_DIRECTORYPAGE_TEXT_TOP $(DIR_SUBTITLE)
+!define MUI_DIRECTORYPAGE_TEXT_DESTINATION $(DIR_INNERTEXT)
+!insertmacro MUI_PAGE_DIRECTORY
+
+!define MUI_FINISHPAGE_NOAUTOCLOSE
+!insertmacro MUI_PAGE_INSTFILES
+
+!define MUI_FINISHPAGE_TITLE $(FINISH_TITLE)
+!define MUI_FINISHPAGE_TEXT $(FINISH_TEXT)
+!insertmacro MUI_PAGE_FINISH
+
+; MUI Config
+
+!define MUI_CUSTOMFUNCTION_GUIINIT gaym_checkGaimVersion
+!define MUI_ABORTWARNING
+!define MUI_UNINSTALLER
+!define MUI_PROGRESSBAR smooth
+!define MUI_INSTALLCOLORS /windows
+
+!insertmacro MUI_LANGUAGE "English"
+
+!define MUI_LICENSEPAGE_RADIOBUTTONS
+
+
+;The Default Installation Directory
+InstallDir "$PROGRAMFILES\gaim"
+InstallDirRegKey HKLM SOFTWARE\gaim ""
+
+Section -SecUninstallOldPlugin
+  ; Check install rights..
+  Call CheckUserInstallRights
+  Pop $R0
+
+  StrCmp $R0 "HKLM" rights_hklm
+  StrCmp $R0 "HKCU" rights_hkcu done
+
+  rights_hkcu:
+      ReadRegStr $R1 HKCU "${GAYM_REG_KEY}" ""
+      ReadRegStr $R2 HKCU "${GAYM_REG_KEY}" "Version"
+      ReadRegStr $R3 HKCU "${GAYM_UNINSTALL_KEY}" "UninstallString"
+      Goto try_uninstall
+
+  rights_hklm:
+      ReadRegStr $R1 HKLM "${GAYM_REG_KEY}" ""
+      ReadRegStr $R2 HKLM "${GAYM_REG_KEY}" "Version"
+      ReadRegStr $R3 HKLM "${GAYM_UNINSTALL_KEY}" "UninstallString"
+
+  ; If previous version exists .. remove
+  try_uninstall:
+    StrCmp $R1 "" done
+      StrCmp $R2 "" uninstall_problem
+        IfFileExists $R3 0 uninstall_problem
+          ; Have uninstall string.. go ahead and uninstall.
+          SetOverwrite on
+          ; Need to copy uninstaller outside of the install dir
+          ClearErrors
+          CopyFiles /SILENT $R3 "$TEMP\${GAYM_UNINST_EXE}"
+          SetOverwrite off
+          IfErrors uninstall_problem
+            ; Ready to uninstall..
+            ClearErrors
+            ExecWait '"$TEMP\${GAYM_UNINST_EXE}" /S _?=$R1'
+            IfErrors exec_error
+              Delete "$TEMP\${GAYM_UNINST_EXE}"
+              Goto done
+
+            exec_error:
+              Delete "$TEMP\${GAYM_UNINST_EXE}"
+              Goto uninstall_problem
+
+        uninstall_problem:
+            ; Just delete the plugin and uninstaller, and remove Registry key
+             MessageBox MB_YESNO $(GAYM_PROMPT_WIPEOUT) IDYES do_wipeout IDNO cancel_install
+          cancel_install:
+            Quit
+
+          do_wipeout:
+            StrCmp $R0 "HKLM" del_lm_reg del_cu_reg
+            del_cu_reg:
+              DeleteRegKey HKCU ${GAYM_REG_KEY}
+              Goto uninstall_prob_cont
+            del_lm_reg:
+              DeleteRegKey HKLM ${GAYM_REG_KEY}
+
+            uninstall_prob_cont:
+              ; plugin DLL
+              Delete "$R1\plugins\${GAYM_DLL}"
+              ; pixmaps
+              Delete "$R1\pixmaps\gaim\status\default\${GAYM_PNG}"
+              Delete "$R3"
+
+  done:
+
+SectionEnd
+
+
+Section "Install"
+  Call CheckUserInstallRights
+  Pop $R0
+
+  StrCmp $R0 "NONE" instrights_none
+  StrCmp $R0 "HKLM" instrights_hklm instrights_hkcu
+
+  instrights_hklm:
+    ; Write the version registry keys:
+    WriteRegStr HKLM ${GAYM_REG_KEY} "" "$INSTDIR"
+    WriteRegStr HKLM ${GAYM_REG_KEY} "Version" "${GAYM_VERSION}"
+
+    ; Write the uninstall keys for Windows
+    WriteRegStr HKLM ${GAYM_UNINSTALL_KEY} "DisplayName" "$(GAYM_UNINSTALL_DESC)"
+    WriteRegStr HKLM ${GAYM_UNINSTALL_KEY} "UninstallString" "$INSTDIR\${GAYM_UNINST_EXE}"
+    SetShellVarContext "all"
+    Goto install_files
+
+  instrights_hkcu:
+    ; Write the version registry keys:
+    WriteRegStr HKCU ${GAYM_REG_KEY} "" "$INSTDIR"
+    WriteRegStr HKCU ${GAYM_REG_KEY} "Version" "${GAYM_VERSION}"
+
+    ; Write the uninstall keys for Windows
+    WriteRegStr HKCU ${GAYM_UNINSTALL_KEY} "DisplayName" "$(GAYM_UNINSTALL_DESC)"
+    WriteRegStr HKCU ${GAYM_UNINSTALL_KEY} "UninstallString" "$INSTDIR\${GAYM_UNINST_EXE}"
+    Goto install_files
+  
+  instrights_none:
+    ; No registry keys for us...
+    
+  install_files:
+    SetOutPath "$INSTDIR\plugins"
+    SetCompress Auto
+    SetOverwrite on
+    File "..\src\${GAYM_DLL}"
+    
+    SetOutPath "$INSTDIR\pixmaps\gaim\status\default"
+    File "..\pixmaps\${GAYM_PNG}"
+    
+    StrCmp $R0 "NONE" done
+    CreateShortCut "$SMPROGRAMS\Gaim\${GAYM_UNINSTALL_LNK}" "$INSTDIR\${GAYM_UNINST_EXE}"
+    WriteUninstaller "$INSTDIR\${GAYM_UNINST_EXE}"
+    SetOverWrite off
+
+  done:
+SectionEnd
+
+Section Uninstall
+  Call un.CheckUserInstallRights
+  Pop $R0
+  StrCmp $R0 "NONE" no_rights
+  StrCmp $R0 "HKCU" try_hkcu try_hklm
+
+  try_hkcu:
+    ReadRegStr $R0 HKCU "${GAYM_REG_KEY}" ""
+    StrCmp $R0 $INSTDIR 0 cant_uninstall
+      ; HKCU install path matches our INSTDIR.. so uninstall
+      DeleteRegKey HKCU "${GAYM_REG_KEY}"
+      DeleteRegKey HKCU "${GAYM_UNINSTALL_KEY}"
+      Goto cont_uninstall
+
+  try_hklm:
+    ReadRegStr $R0 HKLM "${GAYM_REG_KEY}" ""
+    StrCmp $R0 $INSTDIR 0 try_hkcu
+      ; HKLM install path matches our INSTDIR.. so uninstall
+      DeleteRegKey HKLM "${GAYM_REG_KEY}"
+      DeleteRegKey HKLM "${GAYM_UNINSTALL_KEY}"
+      ; Sets start menu and desktop scope to all users..
+      SetShellVarContext "all"
+
+  cont_uninstall:
+    ; plugin 
+    Delete "$INSTDIR\plugins\${GAYM_DLL}"
+    ; pixmaps
+    Delete "$INSTDIR\pixmaps\gaim\status\default\${GAYM_PNG}"
+    ; uninstaller
+    Delete "$INSTDIR\${GAYM_UNINST_EXE}"
+    ; uninstaller shortcut
+    Delete "$SMPROGRAMS\Gaim\${GAYM_UNINSTALL_LNK}"
+    
+    ; try to delete the Gaim directories, in case it has already uninstalled
+    RMDir "$INSTDIR\plugins"
+    RMDir "$INSTDIR"
+    RMDir "$SMPROGRAMS\Gaim"
+
+    Goto done
+
+  cant_uninstall:
+    MessageBox MB_OK $(un.GAYM_UNINSTALL_ERROR_1) IDOK
+    Quit
+
+  no_rights:
+    MessageBox MB_OK $(un.GAYM_UNINSTALL_ERROR_2) IDOK
+    Quit
+
+  done:
+SectionEnd
+
+Function .onVerifyInstDir
+  IfFileExists $INSTDIR\gaim.exe Good1
+    Abort
+  Good1:
+FunctionEnd
+
+Function gaym_checkGaimVersion
+  Push $R0
+
+  Push ${GAIM_VERSION}
+  Call CheckGaimVersion
+  Pop $R0
+
+  StrCmp $R0 ${GAIM_VERSION_OK} gaym_checkGaimVersion_OK
+  StrCmp $R0 ${GAIM_VERSION_INCOMPATIBLE} +1 +6
+    Call GetGaimVersion
+    IfErrors +3
+    Pop $R0
+    MessageBox MB_OK|MB_ICONSTOP "$(BAD_GAIM_VERSION_1) $R0 $(BAD_GAIM_VERSION_2)"
+    goto +2
+    MessageBox MB_OK|MB_ICONSTOP "$(NO_GAIM_VERSION)"
+    Quit
+
+  gaym_checkGaimVersion_OK:
+  Pop $R0
+FunctionEnd
+
+Function CheckUserInstallRights
+        ClearErrors
+        UserInfo::GetName
+        IfErrors Win9x
+        Pop $0
+        UserInfo::GetAccountType
+        Pop $1
+
+        StrCmp $1 "Admin" 0 +3
+                StrCpy $1 "HKLM"
+                Goto done
+        StrCmp $1 "Power" 0 +3
+                StrCpy $1 "HKLM"
+                Goto done
+        StrCmp $1 "User" 0 +3
+                StrCpy $1 "HKCU"
+                Goto done
+        StrCmp $1 "Guest" 0 +3
+                StrCpy $1 "NONE"
+                Goto done
+        ; Unknown error
+        StrCpy $1 "NONE"
+        Goto done
+
+        Win9x:
+                StrCpy $1 "HKLM"
+
+        done:
+        Push $1
+FunctionEnd
+
+Function un.CheckUserInstallRights
+        ClearErrors
+        UserInfo::GetName
+        IfErrors Win9x
+        Pop $0
+        UserInfo::GetAccountType
+        Pop $1
+        StrCmp $1 "Admin" 0 +3
+                StrCpy $1 "HKLM"
+                Goto done
+        StrCmp $1 "Power" 0 +3
+                StrCpy $1 "HKLM"
+                Goto done
+        StrCmp $1 "User" 0 +3
+                StrCpy $1 "HKCU"
+                Goto done
+        StrCmp $1 "Guest" 0 +3
+                StrCpy $1 "NONE"
+                Goto done
+        ; Unknown error
+        StrCpy $1 "NONE"
+        Goto done
+
+        Win9x:
+                StrCpy $1 "HKLM"
+
+        done:
+        Push $1
+FunctionEnd
+
+



From deckrider at sheep.berlios.de  Sat Jun  4 08:40:19 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Sat, 4 Jun 2005 08:40:19 +0200
Subject: [Qrc-svn] r62 - gaym/trunk/nsis
Message-ID: <200506040640.j546eJp9021541@sheep.berlios.de>

Author: deckrider
Date: 2005-06-04 08:40:16 +0200 (Sat, 04 Jun 2005)
New Revision: 62

Modified:
   gaym/trunk/nsis/installer.nsi
Log:
Adding the version of Gaim to the windows installer filename.


Modified: gaym/trunk/nsis/installer.nsi
===================================================================
--- gaym/trunk/nsis/installer.nsi	2005-06-04 06:16:05 UTC (rev 61)
+++ gaym/trunk/nsis/installer.nsi	2005-06-04 06:40:16 UTC (rev 62)
@@ -17,7 +17,7 @@
 CRCCheck On
 
 ;Output File Name
-OutFile "..\gaim-gaym-${GAYM_VERSION}.exe"
+OutFile "..\gaim-${GAIM_VERSION}-gaym-${GAYM_VERSION}.exe"
 
 ShowInstDetails show
 ShowUnInstDetails show



From deckrider at sheep.berlios.de  Sat Jun  4 09:52:15 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Sat, 4 Jun 2005 09:52:15 +0200
Subject: [Qrc-svn] r63 - gaym/trunk/src
Message-ID: <200506040752.j547qFpg025292@sheep.berlios.de>

Author: deckrider
Date: 2005-06-04 09:52:14 +0200 (Sat, 04 Jun 2005)
New Revision: 63

Modified:
   gaym/trunk/src/gaym.c
Log:
Adding a NULL I had omitted.

Modified: gaym/trunk/src/gaym.c
===================================================================
--- gaym/trunk/src/gaym.c	2005-06-04 06:40:16 UTC (rev 62)
+++ gaym/trunk/src/gaym.c	2005-06-04 07:52:14 UTC (rev 63)
@@ -794,7 +794,7 @@
     }
     char *retval = g_new0(char, 31);    // max 30, plus one for the NULL
     char *firstchar =
-        "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";
+        "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz\0";
     char *allowed =
         "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_.-\0";
     int i = 0;



From deckrider at sheep.berlios.de  Sat Jun  4 10:15:15 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Sat, 4 Jun 2005 10:15:15 +0200
Subject: [Qrc-svn] r64 - gaym/trunk/src
Message-ID: <200506040815.j548FFwr026005@sheep.berlios.de>

Author: deckrider
Date: 2005-06-04 10:15:13 +0200 (Sat, 04 Jun 2005)
New Revision: 64

Modified:
   gaym/trunk/src/gaym.c
Log:
Reverting an earlier change to gaym_normalize() that broke some things.
Not sure why yet, but need to back this out until I understand it.


Modified: gaym/trunk/src/gaym.c
===================================================================
--- gaym/trunk/src/gaym.c	2005-06-04 07:52:14 UTC (rev 63)
+++ gaym/trunk/src/gaym.c	2005-06-04 08:15:13 UTC (rev 64)
@@ -777,46 +777,23 @@
     return 0;
 }
 
-// According to http://www.gay.com/members/join/ the member name is:
-// 
-// - Up to 30 characters
-// - Must begin with a letter
-// - Can contain only letters, numbers, and underscores ( _ )
-// - Cannot contain special characters, spaces, periods, or hyphens (-)
-// 
-// However, in testing as well as observing existing members, the
-// the member name may in fact contain periods and hyphens.
-
 const char *gaym_normalize(const GaimAccount * acct, const char *nick)
 {
     if (!nick) {
         return NULL;
     }
     char *retval = g_new0(char, 31);    // max 30, plus one for the NULL
-    char *firstchar =
-        "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz\0";
     char *allowed =
-        "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_.-\0";
+        "ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz0123456789\0";
     int i = 0;
     int j = 0;
     int k = 0;
     for (i = 0; nick[i]; i++) {
-        if (k == 0) {
-            for (j = 0; firstchar[j]; j++) {
-                if ((k == 0) && (nick[i] == firstchar[j])) {
-                    retval[k] = nick[i];
-                    k++;
-                    break;
-                }
+        for (j = 0; allowed[j]; j++) {
+            if ((k < 31) && (nick[i] == allowed[j])) {
+                retval[k] = nick[i];
+                k++;
             }
-        } else {
-            for (j = 0; allowed[j]; j++) {
-                if ((k < 31) && (nick[i] == allowed[j])) {
-                    retval[k] = nick[i];
-                    k++;
-                    break;
-                }
-            }
         }
     }
     return retval;



From deckrider at sheep.berlios.de  Sun Jun  5 06:59:20 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Sun, 5 Jun 2005 06:59:20 +0200
Subject: [Qrc-svn] r66 - gaym/trunk/src
Message-ID: <200506050459.j554xKYp022865@sheep.berlios.de>

Author: deckrider
Date: 2005-06-05 06:58:44 +0200 (Sun, 05 Jun 2005)
New Revision: 66

Modified:
   gaym/trunk/src/gaym.c
Log:
Added a GUI skeleton for spam/bot filtering.  Doesn't actually do
anything yet.


Modified: gaym/trunk/src/gaym.c
===================================================================
--- gaym/trunk/src/gaym.c	2005-06-04 18:12:31 UTC (rev 65)
+++ gaym/trunk/src/gaym.c	2005-06-05 04:58:44 UTC (rev 66)
@@ -35,6 +35,7 @@
 #include "util.h"
 #include "version.h"
 #include "helpers.h"
+#include "request.h"
 
 
 
@@ -229,6 +230,30 @@
     gaim_account_request_change_user_info(gaim_connection_get_account(gc));
 }
 
+static void spam_filters_ok_cb(GaimConnection * gc, const char *entry)
+{
+    gchar **filters = g_strsplit(entry, "\n", -1);
+    int i = 0;
+    for (i = 0; filters[i]; i++) {
+        // deckrider FIXME:  Actually do something here
+        gaim_debug_misc("gaym", "Spam Filter Line = %s\n", filters[i]);
+    }
+    g_strfreev(filters);
+}
+
+static void gaym_show_set_spam(GaimPluginAction * action)
+{
+    GaimConnection *gc = (GaimConnection *) action->context;
+    gaim_request_input(gc,
+                       _("Spam Filters"),
+                       _("Enter phrases to block/ignore"),
+                       _("Enter phrases below, each phrase beginning on a new line.  If any one of these phrases is found in a member's profile, that member will be automatically blocked/ignored."),
+                       _("This is only eye candy.  Hope to have it working soon."),
+                       TRUE, FALSE, NULL, _("Save"),
+                       GAIM_CALLBACK(spam_filters_ok_cb), _("Cancel"),
+                       NULL, gc);
+}
+
 static GList *gaym_actions(GaimPlugin * plugin, gpointer context)
 {
     GList *list = NULL;
@@ -237,6 +262,9 @@
     act = gaim_plugin_action_new(_("Change Bio"), gaym_show_set_info);
     list = g_list_append(list, act);
 
+    act = gaim_plugin_action_new(_("Spam Filters"), gaym_show_set_spam);
+    list = g_list_append(list, act);
+
     return list;
 }
 



From deckrider at sheep.berlios.de  Mon Jun  6 06:39:45 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Mon, 6 Jun 2005 06:39:45 +0200
Subject: [Qrc-svn] r67 - gaym/trunk/src
Message-ID: <200506060439.j564djiJ013057@sheep.berlios.de>

Author: deckrider
Date: 2005-06-06 06:38:59 +0200 (Mon, 06 Jun 2005)
New Revision: 67

Modified:
   gaym/trunk/src/gaym.c
Log:
- Trying to wean myself of using C++/Java style comments.
- Removed the earlier Spam Filter GUI approach, since it was
  account-related instead of plugin related.  Unfortunately, there is no
  multi-line text approach available, so a separator character needs to
  be used.


Modified: gaym/trunk/src/gaym.c
===================================================================
--- gaym/trunk/src/gaym.c	2005-06-05 04:58:44 UTC (rev 66)
+++ gaym/trunk/src/gaym.c	2005-06-06 04:38:59 UTC (rev 67)
@@ -149,8 +149,6 @@
 
 }
 
-
-
 static void gaym_ison_one(struct gaym_conn *gaym, struct gaym_buddy *ib)
 {
     char *buf;
@@ -163,7 +161,6 @@
     g_free(buf);
 }
 
-
 static const char *gaym_blist_icon(GaimAccount * a, GaimBuddy * b)
 {
     return "gaym";
@@ -230,30 +227,6 @@
     gaim_account_request_change_user_info(gaim_connection_get_account(gc));
 }
 
-static void spam_filters_ok_cb(GaimConnection * gc, const char *entry)
-{
-    gchar **filters = g_strsplit(entry, "\n", -1);
-    int i = 0;
-    for (i = 0; filters[i]; i++) {
-        // deckrider FIXME:  Actually do something here
-        gaim_debug_misc("gaym", "Spam Filter Line = %s\n", filters[i]);
-    }
-    g_strfreev(filters);
-}
-
-static void gaym_show_set_spam(GaimPluginAction * action)
-{
-    GaimConnection *gc = (GaimConnection *) action->context;
-    gaim_request_input(gc,
-                       _("Spam Filters"),
-                       _("Enter phrases to block/ignore"),
-                       _("Enter phrases below, each phrase beginning on a new line.  If any one of these phrases is found in a member's profile, that member will be automatically blocked/ignored."),
-                       _("This is only eye candy.  Hope to have it working soon."),
-                       TRUE, FALSE, NULL, _("Save"),
-                       GAIM_CALLBACK(spam_filters_ok_cb), _("Cancel"),
-                       NULL, gc);
-}
-
 static GList *gaym_actions(GaimPlugin * plugin, gpointer context)
 {
     GList *list = NULL;
@@ -262,9 +235,6 @@
     act = gaim_plugin_action_new(_("Change Bio"), gaym_show_set_info);
     list = g_list_append(list, act);
 
-    act = gaim_plugin_action_new(_("Spam Filters"), gaym_show_set_spam);
-    list = g_list_append(list, act);
-
     return list;
 }
 
@@ -353,12 +323,16 @@
     gaym->account = account;
 
 
-    // gaim_connection_set_display_name(gc, userparts[0]);
+    /**
+     * gaim_connection_set_display_name(gc, userparts[0]);
+     */
     gaim_connection_set_display_name(gc, username);
     gaym->server =
         g_strdup(gaim_account_get_string
                  (account, "server", "www.gay.com"));
-    // gaym->server = "www.gay.com";
+    /**
+     * gaym->server = "www.gay.com";
+     */
     gaym->buddies =
         g_hash_table_new_full((GHashFunc) gaym_nick_hash,
                               (GEqualFunc) gaym_nick_equal, NULL,
@@ -383,8 +357,9 @@
     if (!config_text) {
         return;
     }
-    // Call Jason's cool function to do away with java madness
-
+    /**
+     * Call Jason's cool function to do away with java madness
+     */
     gaym->configtxt = ascii2native(config_text);
 
     if (!gaym->configtxt) {
@@ -414,8 +389,6 @@
             return;
         }
 
-
-
         if (!g_list_find(connections, gc)) {
             close(source);
             return;
@@ -525,9 +498,11 @@
     if (flags & GAIM_CONV_IM_AUTO_RESP) {
         awaymsg = g_strdup_printf("<Auto-response> %s", what);
         args[1] = awaymsg;
-        // Prevent memory leak
-        // g_free(what);
-        // what=args[1];
+        /**
+         * Prevent memory leak
+         * g_free(what);
+         * what=args[1];
+         */
 
     } else
         args[1] = what;
@@ -549,8 +524,10 @@
 static void gaym_set_away(GaimConnection * gc, const char *state,
                           const char *msg)
 {
-    // struct gaym_conn *gaym = gc->proto_data;
-    // const char *args[1];
+    /**
+     * struct gaym_conn *gaym = gc->proto_data;
+     * const char *args[1];
+     */
 
     if (gc->away) {
         g_free(gc->away);
@@ -560,8 +537,10 @@
     if (msg)
         gc->away = g_strdup(msg);
 
-    // args[0] = msg;
-    // gaym_cmd_away(gaym, "away", NULL, args);
+    /**
+     * args[0] = msg;
+     * gaym_cmd_away(gaym, "away", NULL, args);
+     */
 }
 
 static void gaym_add_buddy(GaimConnection * gc, GaimBuddy * buddy,
@@ -572,9 +551,11 @@
     ib->name = g_strdup(buddy->name);
     g_hash_table_insert(gaym->buddies, ib->name, ib);
     gaim_debug_misc("gaym", "Add buddy: %s\n", buddy->name);
-    /* if the timer isn't set, this is during signon, so we don't want to
-       flood ourself off with ISON's, so we don't, but after that we want
-       to know when someone's online asap */
+    /**
+     * if the timer isn't set, this is during signon, so we don't want to
+     * flood ourself off with ISON's, so we don't, but after that we want
+     * to know when someone's online asap
+     */
     if (gaym->timer)
         gaym_ison_one(gaym, ib);
 }
@@ -641,17 +622,21 @@
 
 static void gaym_add_deny(GaimConnection * gc, const char *name)
 {
-    // FIXME: add code here to store this setting on gay.com
-    // 
-    // The way to store it is by doing a GET on www.gay.com to
-    // /messenger/lists.txt?name=NICK_TO_BLOCK&key=BIG_STRING_THAT_WAS_USED_TO_RETRIEVE_CONFIG_TXT&list=ignore&op=add
-    // 
-    // If successful, the following is returned:
-    // 
-    // success=1
-    // status=ok
-    // list=ignore
-    // command=add
+    /**
+     * FIXME: add code here to store this setting on gay.com
+     * 
+     * The way to store it is by doing a GET on www.gay.com to
+     * /messenger/lists.txt?name=NICK_TO_BLOCK
+     * &key=BIG_STRING_THAT_WAS_USED_TO_RETRIEVE_CONFIG_TXT
+     * &list=ignore&op=add
+     * 
+     * If successful, the following is returned:
+     * 
+     * success=1
+     * status=ok
+     * list=ignore
+     * command=add
+     */
 
     if (!gaym_nick_check(name)) {
         gaim_privacy_deny_remove(gc->account, name, TRUE);
@@ -669,17 +654,21 @@
 
 static void gaym_rem_deny(GaimConnection * gc, const char *name)
 {
-    // FIXME: add code here to store this setting on gay.com
-    // 
-    // The way to store it is by doing a GET on www.gay.com to
-    // /messenger/lists.txt?name=NICK_TO_BLOCK&key=BIG_STRING_THAT_WAS_USED_TO_RETRIEVE_CONFIG_TXT&list=ignore&op=remove
-    // 
-    // If successful, the following is returned:
-    // 
-    // success=1
-    // status=ok
-    // list=ignore
-    // command=remove
+    /**
+     * FIXME: add code here to store this setting on gay.com
+     * 
+     * The way to store it is by doing a GET on www.gay.com to
+     * /messenger/lists.txt?name=NICK_TO_BLOCK
+     * &key=BIG_STRING_THAT_WAS_USED_TO_RETRIEVE_CONFIG_TXT
+     * &list=ignore&op=remove
+     * 
+     * If successful, the following is returned:
+     * 
+     * success=1
+     * status=ok
+     * list=ignore
+     * command=remove
+     */
 
     gaym_privacy_change(gc, name);
 }
@@ -710,8 +699,11 @@
 
     GaimChat *c = NULL;
 
-    GHashTable *chatinfo = NULL;        // need a copy, because data gets
-    // destroyed in roomlist.c
+    /**
+     * need a copy, because data gets
+     * destroyed in roomlist.c
+     */
+    GHashTable *chatinfo = NULL;
 
     args[0] = g_hash_table_lookup(data, "channel");
 
@@ -731,7 +723,9 @@
     }
 
     if (!args[0] || *args[0] != '#') {
-        // Trigger a room search in config.txt....
+        /**
+         * Trigger a room search in config.txt....
+         */
         return;
     }
 
@@ -761,7 +755,6 @@
                     args);
 }
 
-
 static void gaym_chat_leave(GaimConnection * gc, int id)
 {
     struct gaym_conn *gaym = gc->proto_data;
@@ -853,9 +846,11 @@
 
     gaim_roomlist_set_fields(gaym->roomlist, fields);
 
-    // Member created rooms are retrieved through the IRC protocol
-    // and after the last response is recieved from that request
-    // the static rooms are added
+    /**
+     * Member created rooms are retrieved through the IRC protocol
+     * and after the last response is recieved from that request
+     * the static rooms are added
+     */
 
     buf = gaym_format(gaym, "v", "LIST #_*");
     gaym_send(gaym, buf);
@@ -990,10 +985,9 @@
     GaimPluginPrefFrame *frame;
     GaimPluginPref *ppref;
 
-    gaim_debug_misc("gaym", "get pref frame...\n");
     frame = gaim_plugin_pref_frame_new();
 
-    ppref = gaim_plugin_pref_new_with_label(_("Conversations"));
+    ppref = gaim_plugin_pref_new_with_label(_("Chat Rooms"));
     gaim_plugin_pref_frame_add(frame, ppref);
 
     ppref =
@@ -1008,11 +1002,26 @@
          _("Show bio when entrance messages are shown"));
     gaim_plugin_pref_frame_add(frame, ppref);
 
-    // ppref = gaim_plugin_pref_new_with_name_and_label(
-    // "/plugins/prpl/gaym/bot_lines",
-    // _("Space-seperated list of terms that bots use. <Not yet
-    // implemented>"));
-    // gaim_plugin_pref_frame_add(frame, ppref);
+    /**
+     * Note that gaim's gtkpluginpref.c does not support
+     * GAIM_PREF_STRING_LIST, so we have to put the spam
+     * string list in a single string with separators
+     */
+
+    ppref = gaim_plugin_pref_new_with_label(_("Spam Bio Phrase Filter"));
+    gaim_plugin_pref_frame_add(frame, ppref);
+
+    ppref =
+        gaim_plugin_pref_new_with_name_and_label
+        ("/plugins/prpl/gaym/spam_filter_sep", _("Spam Phrase Separator"));
+    gaim_plugin_pref_set_max_length(ppref, 1);
+    gaim_plugin_pref_frame_add(frame, ppref);
+
+    ppref =
+        gaim_plugin_pref_new_with_name_and_label
+        ("/plugins/prpl/gaym/spam_filter_str", _("Spam Phrases"));
+    gaim_plugin_pref_frame_add(frame, ppref);
+
     return frame;
 }
 
@@ -1034,7 +1043,7 @@
     "GayM",                                               /**< name           */
     VERSION,                                              /**< version        */
     N_("GayM Protocol Plugin"),                           /**  summary        */
-    N_("Gay.com Protocol based on IRC"),                  /**  description    */
+    N_("Gay.com Messaging based on IRC"),                 /**  description    */
     NULL,                                                 /**< author         */
     "http://qrc.berlios.de/",                             /**< homepage       */
 
@@ -1048,8 +1057,6 @@
     gaym_actions
 };
 
-
-
 static void _init_plugin(GaimPlugin * plugin)
 {
 
@@ -1070,18 +1077,24 @@
     prpl_info.protocol_options =
         g_list_append(prpl_info.protocol_options, option);
 
-    // gaim doesn't support suppressing entrance messages
+    /**
+     * gaim doesn't support suppressing entrance messages
+     */
     gaim_signal_connect(gaim_conversations_get_handle(),
                         "chat-buddy-joining", plugin,
                         GAIM_CALLBACK(gaym_filter_join_leave_msgs), NULL);
 
-    // gaim doesn't support suppressing exit messages
+    /**
+     * gaim doesn't support suppressing exit messages
+     */
     gaim_signal_connect(gaim_conversations_get_handle(),
                         "chat-buddy-leaving", plugin,
                         GAIM_CALLBACK(gaym_filter_join_leave_msgs), NULL);
 
-    // We have to pull thumbnails, since they aren't pushed like with
-    // other protocols.
+    /**
+     * We have to pull thumbnails, since they aren't pushed like with
+     * other protocols.
+     */
     gaim_signal_connect(gaim_conversations_get_handle(),
                         "conversation-created", plugin,
                         GAIM_CALLBACK(gaym_get_photo_info), NULL);
@@ -1089,7 +1102,9 @@
     gaim_prefs_add_none("/plugins/prpl/gaym");
     gaim_prefs_add_bool("/plugins/prpl/gaym/show_bio_with_join", TRUE);
     gaim_prefs_add_bool("/plugins/prpl/gaym/show_join_leave_msgs", TRUE);
-    // gaim_prefs_add_string("/plugins/prpl/gaym/bot_lines", NULL);
+    gaim_prefs_add_string("/plugins/prpl/gaym/spam_filter_sep", "|");
+    gaim_prefs_add_string("/plugins/prpl/gaym/spam_filter_str",
+                          "This doesn't work yet");
 
     _gaym_plugin = plugin;
 
@@ -1097,5 +1112,3 @@
 }
 
 GAIM_INIT_PLUGIN(gaym, _init_plugin, info);
-
-// vim:tabstop=4:shiftwidth=4:expandtab:



From deckrider at sheep.berlios.de  Tue Jun  7 19:48:15 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Tue, 7 Jun 2005 19:48:15 +0200
Subject: [Qrc-svn] r69 - gaym/trunk/src
Message-ID: <200506071748.j57HmFRD010171@sheep.berlios.de>

Author: deckrider
Date: 2005-06-07 19:48:14 +0200 (Tue, 07 Jun 2005)
New Revision: 69

Modified:
   gaym/trunk/src/gaym.c
   gaym/trunk/src/helpers.c
   gaym/trunk/src/helpers.h
   gaym/trunk/src/msgs.c
Log:
Added a plugin preference to only permit the opening of an IM session
from someone on the account's buddy list.  Removed my earlier spam
commit(s).  Small comment update and reformatting.


Modified: gaym/trunk/src/gaym.c
===================================================================
--- gaym/trunk/src/gaym.c	2005-06-06 15:00:27 UTC (rev 68)
+++ gaym/trunk/src/gaym.c	2005-06-07 17:48:14 UTC (rev 69)
@@ -1000,26 +1000,12 @@
          _("Show bio when entrance messages are shown"));
     gaim_plugin_pref_frame_add(frame, ppref);
 
-    /**
-     * Note that gaim's gtkpluginpref.c does not support
-     * GAIM_PREF_STRING_LIST, so we have to put the spam
-     * string list in a single string with separators
-     */
-
-    ppref = gaim_plugin_pref_new_with_label(_("Spam Bio Phrase Filter"));
-    gaim_plugin_pref_frame_add(frame, ppref);
-
     ppref =
         gaim_plugin_pref_new_with_name_and_label
-        ("/plugins/prpl/gaym/spam_filter_sep", _("Spam Phrase Separator"));
-    gaim_plugin_pref_set_max_length(ppref, 1);
+        ("/plugins/prpl/gaym/only_buddies_can_im",
+         _("Only buddies may open an IM session to me"));
     gaim_plugin_pref_frame_add(frame, ppref);
 
-    ppref =
-        gaim_plugin_pref_new_with_name_and_label
-        ("/plugins/prpl/gaym/spam_filter_str", _("Spam Phrases"));
-    gaim_plugin_pref_frame_add(frame, ppref);
-
     return frame;
 }
 
@@ -1100,9 +1086,7 @@
     gaim_prefs_add_none("/plugins/prpl/gaym");
     gaim_prefs_add_bool("/plugins/prpl/gaym/show_bio_with_join", TRUE);
     gaim_prefs_add_bool("/plugins/prpl/gaym/show_join_leave_msgs", TRUE);
-    gaim_prefs_add_string("/plugins/prpl/gaym/spam_filter_sep", "|");
-    gaim_prefs_add_string("/plugins/prpl/gaym/spam_filter_str",
-                          "This doesn't work yet");
+    gaim_prefs_add_bool("/plugins/prpl/gaym/only_buddies_can_im", FALSE);
 
     _gaym_plugin = plugin;
 

Modified: gaym/trunk/src/helpers.c
===================================================================
--- gaym/trunk/src/helpers.c	2005-06-06 15:00:27 UTC (rev 68)
+++ gaym/trunk/src/helpers.c	2005-06-07 17:48:14 UTC (rev 69)
@@ -21,6 +21,7 @@
  */
 #include "internal.h"
 #include "debug.h"
+#include "prefs.h"
 #include "privacy.h"
 #include "util.h"
 
@@ -340,6 +341,33 @@
     return retval;
 }
 
+gboolean gaym_im_check(GaimConnection * gc, const char *nick)
+{
+    gboolean retval = TRUE;
+
+    /* not good, but don't do anything */
+    if (!gc || !nick) {
+        return retval;
+    }
+
+    /* user wants to allow anyone */
+    if (!gaim_prefs_get_bool("/plugins/prpl/gaym/only_buddies_can_im")) {
+        return retval;
+    }
+
+    /* there is already an open conversation, so it must be allowed */
+    if (gaim_find_conversation_with_account(nick, gc->account)) {
+        return retval;
+    }
+
+    /* nick is not on the account's buddy list */
+    if (!gaim_find_buddy(gc->account, nick)) {
+        retval = FALSE;
+    }
+
+    return retval;
+}
+
 /**
  * vim:tabstop=4:shiftwidth=4:expandtab:
  */

Modified: gaym/trunk/src/helpers.h
===================================================================
--- gaym/trunk/src/helpers.h	2005-06-06 15:00:27 UTC (rev 68)
+++ gaym/trunk/src/helpers.h	2005-06-07 17:48:14 UTC (rev 69)
@@ -60,7 +60,7 @@
  * Respond to notification that the account's privacy settings have
  * changed.
  *
- * @param account The account.
+ * @param         The connection.
  * @param name    The user that was changed (added/removed from the
  *                permit/deny lists).  If the privacy type has changed
  *                this must be NULL so that all users are reset and
@@ -85,6 +85,16 @@
  */
 gboolean gaym_nick_check(const char *nick);
 
+/**
+ * Check if the plugin's settings allow or block an IM.
+ *
+ * @param gc   The connection.
+ * @param nick The user sending the IM.
+ *
+ * @return TRUE if the user is allowed, or @c FALSE otherwise.
+ */
+gboolean gaym_im_check(GaimConnection * gc, const char *nick);
+
 #endif                          /* _GAIM_GAYM_HELPERS_H_ */
 
 /**

Modified: gaym/trunk/src/msgs.c
===================================================================
--- gaym/trunk/src/msgs.c	2005-06-06 15:00:27 UTC (rev 68)
+++ gaym/trunk/src/msgs.c	2005-06-07 17:48:14 UTC (rev 69)
@@ -419,7 +419,7 @@
             }
         }
         // replace '=' with ':'
-        field_name[i-2] = ':';
+        field_name[i - 2] = ':';
 
         room = gaim_roomlist_room_new(GAIM_ROOMLIST_ROOMTYPE_ROOM,
                                       field_name,
@@ -1301,15 +1301,15 @@
         return;
     }
 
-    if (!gaym_privacy_check(gc, nick)) {
+    convert_nick_from_gaycom(args[1]);
+    convert_nick_from_gaycom(args[0]);
+    convert_nick_from_gaycom(nick);
+
+    if (!gaym_privacy_check(gc, nick) || !gaym_im_check(gc, nick)) {
         g_free(nick);
         return;
     }
 
-    convert_nick_from_gaycom(args[1]);
-    convert_nick_from_gaycom(args[0]);
-    convert_nick_from_gaycom(nick);
-
     convo = gaim_find_conversation_with_account(args[0], gaym->account);
 
     notice = !strcmp(args[0], " notice ");



From deckrider at sheep.berlios.de  Wed Jun  8 02:55:25 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Wed, 8 Jun 2005 02:55:25 +0200
Subject: [Qrc-svn] r70 - in gaym/trunk: . src
Message-ID: <200506080055.j580tP2t007567@sheep.berlios.de>

Author: deckrider
Date: 2005-06-08 02:54:54 +0200 (Wed, 08 Jun 2005)
New Revision: 70

Modified:
   gaym/trunk/README
   gaym/trunk/src/gaym.c
Log:
Added some documentation on privacy settings and a small change in the
preferences layout to provide a bit more clarity.


Modified: gaym/trunk/README
===================================================================
--- gaym/trunk/README	2005-06-07 17:48:14 UTC (rev 69)
+++ gaym/trunk/README	2005-06-08 00:54:54 UTC (rev 70)
@@ -0,0 +1,59 @@
+This file should document many things, but for now it is:
+
+An explanation of privacy settings as implemented in GayM.
+
+Gaim Privacy Setting Options (only one of the following may be selected):
+
+   Tools->Privacy->Allow all users to contact me
+   Tools->Privacy->Allow all users on my buddy list
+   Tools->Privacy->Allow only the users below (permit list)
+   Tools->Privacy->Block all users
+   Tools->Privacy->Block only the users below (deny list)
+
+GayM Preferences that enhance privacy settings (enable/disable):
+
+   G1 = Preferences->GayM->Only buddies may open an IM session to me
+
+Widgets that interact with privacy settings:
+
+   Chat Room->Ignore the user (ignore/unignore toggle)
+   Instant Message->Block (add to deny list)
+
+Gaim Privacy Principles
+
+   If a member is blocked via Gaim Privacy, you will never see anything
+   from them, either any chat rooms or in an instant message.  GayM
+   Preferences will not override it.
+
+GayM Preferences (Only buddies may open an IM session to me):
+
+   When enabled, only members of your Gaim buddy list may INITIATE an IM
+   session with you.  However, you may initiate an IM session with
+   someone who is not on your buddy list, and then they will be able to
+   IM you.
+
+   An IM session is defined as a visibly open Instant Message window.
+   To initiate an IM session, simply double-click on the user to open
+   the IM window.  If you both have GayM and neither are on the other's
+   buddy list, agree in the chat room that you want to IM each other,
+   both open an IM window, and you both may begin speaking.
+
+   However, if Gaim Privacy already blocks a member, that member will
+   still not be able to communicate with you in any way.
+
+Chat Room->Ignore the user
+
+   This will ignore the user in that chat room only, and only while that
+   chat room window is open--if you close the chat room and re-open it,
+   the user is no longer ignore--if you close the chat room and re-open
+   it, the user is no longer ignored.  The user can always IM you and is
+   not ignored in other chat rooms (unless you click "Ignore the user"
+   in those rooms also).
+
+Instant Message->Block
+
+   All this does is add someone to your block/ignore list.  However, if
+   you have chosen something other than "Block only the users below" in
+   Tools->Privacy, you will see no change in privacy behavior after
+   clicking this button.
+

Modified: gaym/trunk/src/gaym.c
===================================================================
--- gaym/trunk/src/gaym.c	2005-06-07 17:48:14 UTC (rev 69)
+++ gaym/trunk/src/gaym.c	2005-06-08 00:54:54 UTC (rev 70)
@@ -1000,6 +1000,9 @@
          _("Show bio when entrance messages are shown"));
     gaim_plugin_pref_frame_add(frame, ppref);
 
+    ppref = gaim_plugin_pref_new_with_label(_("Instant Messages"));
+    gaim_plugin_pref_frame_add(frame, ppref);
+
     ppref =
         gaim_plugin_pref_new_with_name_and_label
         ("/plugins/prpl/gaym/only_buddies_can_im",



From deckrider at sheep.berlios.de  Wed Jun  8 16:18:47 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Wed, 8 Jun 2005 16:18:47 +0200
Subject: [Qrc-svn] r71 - gaym/trunk/src
Message-ID: <200506081418.j58EIlXe006499@sheep.berlios.de>

Author: deckrider
Date: 2005-06-08 16:18:46 +0200 (Wed, 08 Jun 2005)
New Revision: 71

Added:
   gaym/trunk/src/gaympriv.c
   gaym/trunk/src/gaympriv.h
Modified:
   gaym/trunk/src/Makefile.am
   gaym/trunk/src/Makefile.mingw
   gaym/trunk/src/gaym.c
   gaym/trunk/src/helpers.c
   gaym/trunk/src/helpers.h
   gaym/trunk/src/msgs.c
Log:
Moved all the privacy related stuff to src/gaympriv.[ch]


Modified: gaym/trunk/src/Makefile.am
===================================================================
--- gaym/trunk/src/Makefile.am	2005-06-08 00:54:54 UTC (rev 70)
+++ gaym/trunk/src/Makefile.am	2005-06-08 14:18:46 UTC (rev 71)
@@ -9,6 +9,8 @@
 	dcc_send.c \
 	gaym.c \
 	gaym.h \
+	gaympriv.c \
+	gaympriv.h \
 	helpers.c \
 	helpers.h \
 	msgs.c \

Modified: gaym/trunk/src/Makefile.mingw
===================================================================
--- gaym/trunk/src/Makefile.mingw	2005-06-08 00:54:54 UTC (rev 70)
+++ gaym/trunk/src/Makefile.mingw	2005-06-08 14:18:46 UTC (rev 71)
@@ -63,6 +63,7 @@
 C_SRC =			cmds.c \
 			dcc_send.c \
 			gaym.c \
+			gaympriv.c \
 			helpers.c \
 			msgs.c \
 			parse.c \

Modified: gaym/trunk/src/gaym.c
===================================================================
--- gaym/trunk/src/gaym.c	2005-06-08 00:54:54 UTC (rev 70)
+++ gaym/trunk/src/gaym.c	2005-06-08 14:18:46 UTC (rev 71)
@@ -37,6 +37,7 @@
 #include "privacy.h"
 
 #include "helpers.h"
+#include "gaympriv.h"
 #include "gaym.h"
 
 char *gaym_mask_bio(const char *biostring);
@@ -937,21 +938,6 @@
     gaym_dccsend_send_file      /* send_file */
 };
 
-static int gaym_filter_join_leave_msgs(GaimConversation * conv, char *name)
-{
-    GaimConnection *gc = gaim_conversation_get_gc(conv);
-    if (!gc) {
-        return 1;
-    }
-    if (!gaim_prefs_get_bool("/plugins/prpl/gaym/show_join_leave_msgs")) {
-        return 1;
-    }
-    if (!gaym_privacy_check(gc, name)) {
-        return 1;
-    }
-    return 0;
-}
-
 static void gaym_get_photo_info(GaimConversation * conv)
 {
     char *buf;
@@ -1069,14 +1055,14 @@
      */
     gaim_signal_connect(gaim_conversations_get_handle(),
                         "chat-buddy-joining", plugin,
-                        GAIM_CALLBACK(gaym_filter_join_leave_msgs), NULL);
+                        GAIM_CALLBACK(gaym_ignore_joining_leaving), NULL);
 
     /**
      * gaim doesn't support suppressing exit messages
      */
     gaim_signal_connect(gaim_conversations_get_handle(),
                         "chat-buddy-leaving", plugin,
-                        GAIM_CALLBACK(gaym_filter_join_leave_msgs), NULL);
+                        GAIM_CALLBACK(gaym_ignore_joining_leaving), NULL);
 
     /**
      * We have to pull thumbnails, since they aren't pushed like with

Added: gaym/trunk/src/gaympriv.c
===================================================================
--- gaym/trunk/src/gaympriv.c	2005-06-08 00:54:54 UTC (rev 70)
+++ gaym/trunk/src/gaympriv.c	2005-06-08 14:18:46 UTC (rev 71)
@@ -0,0 +1,208 @@
+/**
+ * GayM
+ *
+ * GayM is the legal property of its developers, whose names are too numerous
+ * to list here.  Please refer to the COPYRIGHT file distributed with this
+ * source distribution.
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License
+ * along with this program; if not, write to the Free Software
+ * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ */
+#include "internal.h"
+#include "debug.h"
+#include "privacy.h"
+#include "util.h"
+
+#include "gaympriv.h"
+
+int gaym_ignore_joining_leaving(GaimConversation * conv, char *name)
+{
+    GaimConnection *gc = gaim_conversation_get_gc(conv);
+    if (!gc) {
+        return 1;
+    }
+    if (!gaim_prefs_get_bool("/plugins/prpl/gaym/show_join_leave_msgs")) {
+        return 1;
+    }
+    if (!gaym_privacy_check(gc, name)) {
+        return 1;
+    }
+    return 0;
+}
+
+gboolean gaym_privacy_check(GaimConnection * gc, const char *nick)
+{
+    /**
+     * returns TRUE if allowed through, FALSE otherwise
+     */
+    GSList *list;
+    gboolean permitted = FALSE;
+
+    switch (gc->account->perm_deny) {
+    case 0:
+        gaim_debug_warning("gaym", "Privacy setting was 0.  If you can "
+                           "reproduce this, please file a bug report.\n");
+        permitted = TRUE;
+        break;
+
+    case GAIM_PRIVACY_ALLOW_ALL:
+        permitted = TRUE;
+        break;
+
+    case GAIM_PRIVACY_DENY_ALL:
+        gaim_debug_info("gaym",
+                        "%s blocked data received from %s (GAIM_PRIVACY_DENY_ALL)\n",
+                        gc->account->username, nick);
+        break;
+
+    case GAIM_PRIVACY_ALLOW_USERS:
+        for (list = gc->account->permit; list != NULL; list = list->next) {
+            if (!gaim_utf8_strcasecmp
+                (nick, gaim_normalize(gc->account, (char *) list->data))) {
+                permitted = TRUE;
+                gaim_debug_info("gaym",
+                                "%s allowed data received from %s (GAIM_PRIVACY_ALLOW_USERS)\n",
+                                gc->account->username, nick);
+                break;
+            }
+        }
+        break;
+
+    case GAIM_PRIVACY_DENY_USERS:
+        /* seeing we're letting everyone through, except the deny list */
+        permitted = TRUE;
+        for (list = gc->account->deny; list != NULL; list = list->next) {
+            if (!gaim_utf8_strcasecmp
+                (nick, gaim_normalize(gc->account, (char *) list->data))) {
+                permitted = FALSE;
+                gaim_debug_info("gaym",
+                                "%s blocked data received from %s (GAIM_PRIVACY_DENY_USERS)\n",
+                                gc->account->username, nick);
+                break;
+            }
+        }
+        break;
+
+    case GAIM_PRIVACY_ALLOW_BUDDYLIST:
+        if (gaim_find_buddy(gc->account, nick) != NULL) {
+            permitted = TRUE;
+        } else {
+            gaim_debug_info("gaym",
+                            "%s blocked data received from %s (GAIM_PRIVACY_ALLOW_BUDDYLIST)\n",
+                            gc->account->username, nick);
+        }
+        break;
+
+    default:
+        gaim_debug_warning("gaym",
+                           "Privacy setting was unknown.  If you can "
+                           "reproduce this, please file a bug report.\n");
+        permitted = FALSE;
+        break;
+    }
+
+    /**
+     * don't block/ignore self
+     */
+    if (!gaim_utf8_strcasecmp(gc->account->username, nick)) {
+        permitted = TRUE;
+        gaim_debug_info("gaym", "declining to block/ignore self\n");
+        return permitted;
+    }
+
+    return permitted;
+}
+
+void gaym_privacy_change(GaimConnection * gc, const char *name)
+{
+    /**
+     * don't allow adding self to permit/deny lists
+     */
+
+    if (name) {
+        if (!gaim_utf8_strcasecmp(gc->account->username, name)) {
+            gaim_privacy_deny_remove(gc->account, gc->account->username,
+                                     TRUE);
+            gaim_privacy_permit_remove(gc->account, gc->account->username,
+                                       TRUE);
+            gaim_debug_info("gaym",
+                            "declining to add self to permit/deny list\n");
+            return;
+        }
+    }
+
+    GSList *rooms = NULL;
+    for (rooms = gc->buddy_chats; rooms; rooms = rooms->next) {
+        GaimConversation *convo = rooms->data;
+        GaimConvChat *chat = gaim_conversation_get_chat_data(convo);
+        GList *people = NULL;
+        for (people = chat->in_room; people; people = people->next) {
+            GaimConvChatBuddy *buddy = people->data;
+            GaimConversationUiOps *ops =
+                gaim_conversation_get_ui_ops(convo);
+            if (name) {
+                if (!gaim_utf8_strcasecmp(name, buddy->name)) {
+                    if (gaym_privacy_check(gc, buddy->name)) {
+                        gaim_conv_chat_unignore(GAIM_CONV_CHAT(convo),
+                                                buddy->name);
+                    } else {
+                        gaim_conv_chat_ignore(GAIM_CONV_CHAT(convo),
+                                              buddy->name);
+                    }
+                    ops->chat_update_user((convo), buddy->name);
+                }
+            } else {
+                if (gaym_privacy_check(gc, buddy->name)) {
+                    gaim_conv_chat_unignore(GAIM_CONV_CHAT(convo),
+                                            buddy->name);
+                } else {
+                    gaim_conv_chat_ignore(GAIM_CONV_CHAT(convo),
+                                          buddy->name);
+                }
+                ops->chat_update_user((convo), buddy->name);
+            }
+        }
+    }
+}
+
+gboolean gaym_im_check(GaimConnection * gc, const char *nick)
+{
+    gboolean retval = TRUE;
+
+    /* not good, but don't do anything */
+    if (!gc || !nick) {
+        return retval;
+    }
+
+    /* user wants to allow anyone */
+    if (!gaim_prefs_get_bool("/plugins/prpl/gaym/only_buddies_can_im")) {
+        return retval;
+    }
+
+    /* there is already an open conversation, so it must be allowed */
+    if (gaim_find_conversation_with_account(nick, gc->account)) {
+        return retval;
+    }
+
+    /* nick is not on the account's buddy list */
+    if (!gaim_find_buddy(gc->account, nick)) {
+        retval = FALSE;
+    }
+
+    return retval;
+}
+
+/**
+ * vim:tabstop=4:shiftwidth=4:expandtab:
+ */

Added: gaym/trunk/src/gaympriv.h
===================================================================
--- gaym/trunk/src/gaympriv.h	2005-06-08 00:54:54 UTC (rev 70)
+++ gaym/trunk/src/gaympriv.h	2005-06-08 14:18:46 UTC (rev 71)
@@ -0,0 +1,79 @@
+/**
+ * @file helpers.h GayM Helpers API
+ *
+ * GayM
+ *
+ * GayM is the legal property of its developers, whose names are too numerous
+ * to list here.  Please refer to the COPYRIGHT file distributed with this
+ * source distribution.
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License
+ * along with this program; if not, write to the Free Software
+ * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ */
+#ifndef _GAIM_GAYM_GAYMPRIV_H_
+#define _GAIM_GAYM_GAYMPRIV_H_
+
+#include "connection.h"
+
+#include <glib.h>
+
+/**
+ * Selectively ignores joining / leaving messages based on GayM
+ * preferences and Gaim privacy settings.
+ *
+ * @param gc   The connection.
+ * @param name The user joining or leaving.
+ *
+ * @return 0 to show the join/leave message, or @c 1 otherwise.
+ */
+int gaym_ignore_joining_leaving(GaimConversation * conv, char *name);
+
+/**
+ * Check if the account's privacy settings allow or block the user
+ * (shamelessly taken from the yahoo prpl).
+ *
+ * @param gc   The connection.
+ * @param nick The user to check.
+ *
+ * @return TRUE if the user is allowed, or @c FALSE otherwise.
+ */
+gboolean gaym_privacy_check(GaimConnection * gc, const char *nick);
+
+/**
+ * Respond to notification that the account's privacy settings have
+ * changed.
+ *
+ * @param         The connection.
+ * @param name    The user that was changed (added/removed from the
+ *                permit/deny lists).  If the privacy type has changed
+ *                this must be NULL so that all users are reset and
+ *                checked.
+ */
+void gaym_privacy_change(GaimConnection * gc, const char *name);
+
+/**
+ * Check if the plugin's settings allow or block an IM.
+ *
+ * @param gc   The connection.
+ * @param nick The user sending the IM.
+ *
+ * @return TRUE if the user is allowed, or @c FALSE otherwise.
+ */
+gboolean gaym_im_check(GaimConnection * gc, const char *nick);
+
+#endif                          /* _GAIM_GAYM_GAYMPRIV_H_ */
+
+/**
+ * vim:tabstop=4:shiftwidth=4:expandtab:
+ */

Modified: gaym/trunk/src/helpers.c
===================================================================
--- gaym/trunk/src/helpers.c	2005-06-08 00:54:54 UTC (rev 70)
+++ gaym/trunk/src/helpers.c	2005-06-08 14:18:46 UTC (rev 71)
@@ -20,10 +20,6 @@
  * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
  */
 #include "internal.h"
-#include "debug.h"
-#include "prefs.h"
-#include "privacy.h"
-#include "util.h"
 
 #include "helpers.h"
 
@@ -147,141 +143,6 @@
     return outstr;
 }
 
-gboolean gaym_privacy_check(GaimConnection * gc, const char *nick)
-{
-    /**
-     * returns TRUE if allowed through, FALSE otherwise
-     */
-    GSList *list;
-    gboolean permitted = FALSE;
-
-    switch (gc->account->perm_deny) {
-    case 0:
-        gaim_debug_warning("gaym", "Privacy setting was 0.  If you can "
-                           "reproduce this, please file a bug report.\n");
-        permitted = TRUE;
-        break;
-
-    case GAIM_PRIVACY_ALLOW_ALL:
-        permitted = TRUE;
-        break;
-
-    case GAIM_PRIVACY_DENY_ALL:
-        gaim_debug_info("gaym",
-                        "%s blocked data received from %s (GAIM_PRIVACY_DENY_ALL)\n",
-                        gc->account->username, nick);
-        break;
-
-    case GAIM_PRIVACY_ALLOW_USERS:
-        for (list = gc->account->permit; list != NULL; list = list->next) {
-            if (!gaim_utf8_strcasecmp
-                (nick, gaim_normalize(gc->account, (char *) list->data))) {
-                permitted = TRUE;
-                gaim_debug_info("gaym",
-                                "%s allowed data received from %s (GAIM_PRIVACY_ALLOW_USERS)\n",
-                                gc->account->username, nick);
-                break;
-            }
-        }
-        break;
-
-    case GAIM_PRIVACY_DENY_USERS:
-        /* seeing we're letting everyone through, except the deny list */
-        permitted = TRUE;
-        for (list = gc->account->deny; list != NULL; list = list->next) {
-            if (!gaim_utf8_strcasecmp
-                (nick, gaim_normalize(gc->account, (char *) list->data))) {
-                permitted = FALSE;
-                gaim_debug_info("gaym",
-                                "%s blocked data received from %s (GAIM_PRIVACY_DENY_USERS)\n",
-                                gc->account->username, nick);
-                break;
-            }
-        }
-        break;
-
-    case GAIM_PRIVACY_ALLOW_BUDDYLIST:
-        if (gaim_find_buddy(gc->account, nick) != NULL) {
-            permitted = TRUE;
-        } else {
-            gaim_debug_info("gaym",
-                            "%s blocked data received from %s (GAIM_PRIVACY_ALLOW_BUDDYLIST)\n",
-                            gc->account->username, nick);
-        }
-        break;
-
-    default:
-        gaim_debug_warning("gaym",
-                           "Privacy setting was unknown.  If you can "
-                           "reproduce this, please file a bug report.\n");
-        permitted = FALSE;
-        break;
-    }
-
-    /**
-     * don't block/ignore self
-     */
-    if (!gaim_utf8_strcasecmp(gc->account->username, nick)) {
-        permitted = TRUE;
-        gaim_debug_info("gaym", "declining to block/ignore self\n");
-        return permitted;
-    }
-
-    return permitted;
-}
-
-void gaym_privacy_change(GaimConnection * gc, const char *name)
-{
-    /**
-     * don't allow adding self to permit/deny lists
-     */
-
-    if (name) {
-        if (!gaim_utf8_strcasecmp(gc->account->username, name)) {
-            gaim_privacy_deny_remove(gc->account, gc->account->username,
-                                     TRUE);
-            gaim_privacy_permit_remove(gc->account, gc->account->username,
-                                       TRUE);
-            gaim_debug_info("gaym",
-                            "declining to add self to permit/deny list\n");
-            return;
-        }
-    }
-
-    GSList *rooms = NULL;
-    for (rooms = gc->buddy_chats; rooms; rooms = rooms->next) {
-        GaimConversation *convo = rooms->data;
-        GaimConvChat *chat = gaim_conversation_get_chat_data(convo);
-        GList *people = NULL;
-        for (people = chat->in_room; people; people = people->next) {
-            GaimConvChatBuddy *buddy = people->data;
-            GaimConversationUiOps *ops =
-                gaim_conversation_get_ui_ops(convo);
-            if (name) {
-                if (!gaim_utf8_strcasecmp(name, buddy->name)) {
-                    if (gaym_privacy_check(gc, buddy->name)) {
-                        gaim_conv_chat_unignore(GAIM_CONV_CHAT(convo),
-                                                buddy->name);
-                    } else {
-                        gaim_conv_chat_ignore(GAIM_CONV_CHAT(convo),
-                                              buddy->name);
-                    }
-                    ops->chat_update_user((convo), buddy->name);
-                }
-            } else {
-                if (gaym_privacy_check(gc, buddy->name)) {
-                    gaim_conv_chat_unignore(GAIM_CONV_CHAT(convo),
-                                            buddy->name);
-                } else {
-                    gaim_conv_chat_ignore(GAIM_CONV_CHAT(convo),
-                                          buddy->name);
-                }
-                ops->chat_update_user((convo), buddy->name);
-            }
-        }
-    }
-}
-
 gboolean gaym_nick_check(const char *nick)
 {
     gboolean retval = FALSE;
@@ -341,33 +202,6 @@
     return retval;
 }
 
-gboolean gaym_im_check(GaimConnection * gc, const char *nick)
-{
-    gboolean retval = TRUE;
-
-    /* not good, but don't do anything */
-    if (!gc || !nick) {
-        return retval;
-    }
-
-    /* user wants to allow anyone */
-    if (!gaim_prefs_get_bool("/plugins/prpl/gaym/only_buddies_can_im")) {
-        return retval;
-    }
-
-    /* there is already an open conversation, so it must be allowed */
-    if (gaim_find_conversation_with_account(nick, gc->account)) {
-        return retval;
-    }
-
-    /* nick is not on the account's buddy list */
-    if (!gaim_find_buddy(gc->account, nick)) {
-        retval = FALSE;
-    }
-
-    return retval;
-}
-
 /**
  * vim:tabstop=4:shiftwidth=4:expandtab:
  */

Modified: gaym/trunk/src/helpers.h
===================================================================
--- gaym/trunk/src/helpers.h	2005-06-08 00:54:54 UTC (rev 70)
+++ gaym/trunk/src/helpers.h	2005-06-08 14:18:46 UTC (rev 71)
@@ -24,8 +24,6 @@
 #ifndef _GAIM_GAYM_HELPERS_H_
 #define _GAIM_GAYM_HELPERS_H_
 
-#include "connection.h"
-
 #include <glib.h>
 
 char *return_string_between(const char *startbit, const char *endbit,
@@ -46,29 +44,6 @@
 gchar *ascii2native(const gchar * str);
 
 /**
- * Check if the account's privacy settings allow or block the user
- * (shamelessly taken from the yahoo prpl).
- *
- * @param gc   The connection.
- * @param nick The user to check.
- *
- * @return TRUE if the user is allowed, or @c FALSE otherwise.
- */
-gboolean gaym_privacy_check(GaimConnection * gc, const char *nick);
-
-/**
- * Respond to notification that the account's privacy settings have
- * changed.
- *
- * @param         The connection.
- * @param name    The user that was changed (added/removed from the
- *                permit/deny lists).  If the privacy type has changed
- *                this must be NULL so that all users are reset and
- *                checked.
- */
-void gaym_privacy_change(GaimConnection * gc, const char *name);
-
-/**
  * Check if the string could be a valid user name.
  *
  * According to http://www.gay.com/members/join/ the member name is:
@@ -85,16 +60,6 @@
  */
 gboolean gaym_nick_check(const char *nick);
 
-/**
- * Check if the plugin's settings allow or block an IM.
- *
- * @param gc   The connection.
- * @param nick The user sending the IM.
- *
- * @return TRUE if the user is allowed, or @c FALSE otherwise.
- */
-gboolean gaym_im_check(GaimConnection * gc, const char *nick);
-
 #endif                          /* _GAIM_GAYM_HELPERS_H_ */
 
 /**

Modified: gaym/trunk/src/msgs.c
===================================================================
--- gaym/trunk/src/msgs.c	2005-06-08 00:54:54 UTC (rev 70)
+++ gaym/trunk/src/msgs.c	2005-06-08 14:18:46 UTC (rev 71)
@@ -21,21 +21,22 @@
 */
 
 #include "internal.h"
-
 #include "conversation.h"
 #include "blist.h"
 #include "notify.h"
 #include "util.h"
 #include "debug.h"
-#include "gaym.h"
 #include "imgstore.h"
-#include "helpers.h"
 #include "request.h"
 #include "privacy.h"
 #include "prefs.h"
 
 #include <stdio.h>
 
+#include "helpers.h"
+#include "gaympriv.h"
+#include "gaym.h"
+
 // begin forward declarations
 
 static char *gaym_mask_nick(const char *mask);



From deckrider at sheep.berlios.de  Thu Jun  9 06:37:25 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Thu, 9 Jun 2005 06:37:25 +0200
Subject: [Qrc-svn] r80 - in trunk: . chatsort gaym gaym/pixmaps roombrowse
Message-ID: <200506090437.j594bP4m006536@sheep.berlios.de>

Author: deckrider
Date: 2005-06-09 06:36:53 +0200 (Thu, 09 Jun 2005)
New Revision: 80

Added:
   trunk/chatsort/Makefile.mingw
   trunk/gaym/Makefile.am
   trunk/gaym/pixmaps/
   trunk/gaym/pixmaps/Makefile.am
   trunk/gaym/pixmaps/gaym.png
   trunk/roombrowse/Makefile.am
   trunk/roombrowse/Makefile.mingw
Removed:
   trunk/pixmaps/
Modified:
   trunk/Makefile.am
   trunk/autogen.sh
   trunk/configure.ac
Log:
make dist-check works with gaym

Modified: trunk/Makefile.am
===================================================================
--- trunk/Makefile.am	2005-06-09 04:11:38 UTC (rev 79)
+++ trunk/Makefile.am	2005-06-09 04:36:53 UTC (rev 80)
@@ -1,4 +1,5 @@
 DIST_SUBDIRS = \
+	nsis \
 	chatsort \
 	gaym \
 	privacy \
@@ -11,6 +12,5 @@
 
 SUBDIRS = \
 	nsis \
-        pixmaps \
-	$ENABLED_PLUGINS
+	$(ENABLED_PLUGINS)
 

Modified: trunk/autogen.sh
===================================================================
--- trunk/autogen.sh	2005-06-09 04:11:38 UTC (rev 79)
+++ trunk/autogen.sh	2005-06-09 04:36:53 UTC (rev 80)
@@ -8,27 +8,27 @@
 #
 (libtoolize --version) < /dev/null > /dev/null 2>&1 || {
 	echo;
-	echo "You must have libtool installed to compile GayM.";
+	echo "You must have libtool installed to compile the QRC Plugins.";
 	echo;
 	exit;
 }
 
 (automake --version) < /dev/null > /dev/null 2>&1 || {
 	echo;
-	echo "You must have automake installed to compile GayM.";
+	echo "You must have automake installed to compile the QRC plugins.";
 	echo;
 	exit;
 }
 
 (autoconf --version) < /dev/null > /dev/null 2>&1 || {
 	echo;
-	echo "You must have autoconf installed to compile GayM.";
+	echo "You must have autoconf installed to compile the QRC plugins.";
 	echo;
 	exit;
 }
 
 echo;
-echo "Generating configuration files for GayM, please wait...."
+echo "Generating configuration files for the QRC plugins, please wait...."
 
 echo;
 echo "Running libtoolize, please ignore non-fatal messages...."
@@ -68,7 +68,7 @@
 autoconf --force || exit;
 
 echo;
-echo "Finished generating configuration files for GayM."
+echo "Finished generating configuration files for the QRC plugins."
 echo "Now you may run './configure'."
 echo;
 

Added: trunk/chatsort/Makefile.mingw
===================================================================
--- trunk/chatsort/Makefile.mingw	2005-06-09 04:11:38 UTC (rev 79)
+++ trunk/chatsort/Makefile.mingw	2005-06-09 04:36:53 UTC (rev 80)
@@ -0,0 +1,122 @@
+#
+# Makefile.mingw
+#
+# Description: Makefile for win32 (mingw) version of libgaym
+
+# Compiler Options
+
+CFLAGS =
+
+DEFINES =
+
+
+# Use -g flag when building debug version of Gaim (including plugins).
+# Use -fnative-struct instead of -mms-bitfields when using mingw 1.1
+# (gcc 2.95)
+CFLAGS += -O2 -Wall -mno-cygwin -mms-bitfields
+
+# If not specified, dlls are built with the default base address of 0x10000000.
+# When loaded into a process address space a dll will be rebased if its base
+# address colides with the base address of an existing dll.  To avoid rebasing
+# we do the following.  Rebasing can slow down the load time of dlls and it
+# also renders debug info useless.
+DLL_LD_FLAGS += -Wl,--enable-auto-image-base
+
+ifdef GAIM_TOP
+VERSION := $(shell cat $(GAIM_TOP)/VERSION)
+endif
+
+DEFINES +=      -DVERSION=\"$(VERSION)\" \
+                -DHAVE_CONFIG_H
+
+##
+## TARGET
+##
+
+TARGET = libgaym
+
+##
+## INCLUDE PATHS
+##
+
+INCLUDE_PATHS +=	-I$../ \
+			-I$(GTK_TOP)/include \
+			-I$(GTK_TOP)/include/gtk-2.0 \
+			-I$(GTK_TOP)/include/glib-2.0 \
+			-I$(GTK_TOP)/include/pango-1.0 \
+			-I$(GTK_TOP)/include/atk-1.0 \
+			-I$(GTK_TOP)/lib/glib-2.0/include \
+			-I$(GTK_TOP)/lib/gtk-2.0/include \
+			-I$(GAIM_TOP)/src \
+			-I$(GAIM_TOP)/src/win32 \
+			-I$(GAIM_TOP)
+
+
+LIB_PATHS =		-L$(GTK_TOP)/lib \
+			-L$(GAIM_TOP)/src
+
+
+##
+##  SOURCES, OBJECTS
+##
+
+C_SRC =			cmds.c \
+			dcc_send.c \
+			gaym.c \
+			gaympriv.c \
+			helpers.c \
+			msgs.c \
+			parse.c \
+			weblogin.c
+
+
+OBJECTS = $(C_SRC:%.c=%.o)
+
+
+##
+## LIBRARIES
+##
+
+LIBS =			-lgtk-win32-2.0 \
+			-lglib-2.0 \
+			-lgdk-win32-2.0 \
+			-lgmodule-2.0 \
+			-lgobject-2.0 \
+			-lws2_32 \
+			-lintl \
+			-lgaim
+
+
+##
+## RULES
+##
+
+# How to make a C file
+
+%.o: %.c
+	$(CC) $(CFLAGS) $(DEFINES) $(INCLUDE_PATHS) -o $@ -c $<
+
+##
+## TARGET DEFINITIONS
+##
+
+.PHONY: all clean
+
+all: $(TARGET).dll
+
+
+##
+## BUILD DLL
+##
+
+$(TARGET).dll: $(OBJECTS)
+	$(CC) -shared $(OBJECTS) $(LIB_PATHS) $(LIBS) $(DLL_LD_FLAGS) -Wl,--out-implib,$(TARGET).lib -o $(TARGET).dll
+
+##
+## CLEAN RULES
+##
+
+clean:
+	-rm *.o
+	-rm $(TARGET).dll
+	-rm $(TARGET).lib

Modified: trunk/configure.ac
===================================================================
--- trunk/configure.ac	2005-06-09 04:11:38 UTC (rev 79)
+++ trunk/configure.ac	2005-06-09 04:36:53 UTC (rev 80)
@@ -9,7 +9,7 @@
 REQUIRED_GAIM="gaim >= 1.2 gaim < 2.0"
 AC_SUBST(REQUIRED_GAIM)
 
-AC_CONFIG_SRCDIR([gaym/gaym.h])
+AC_CONFIG_SRCDIR([gaym/src/gaym.h])
 AC_CONFIG_HEADER([config.h])
 
 AC_DEFINE(GAIM_PLUGINS, 1, [Define if plugins are enabled.])
@@ -57,22 +57,23 @@
 
 ENABLED_PLUGINS=""
 
-AC_ARG_ENABLE([chatsort],AC_HELP_STRING([--disable-chatsort],[don't build the chatsort plugin]),,[ENABLED_PLUGINS="$ENABLED_PLUGINS chatsort"])
+AC_ARG_ENABLE([chatsort],AC_HELP_STRING([--enable-chatsort],[build the chatsort plugin @<:@default=no@:>@]),[ENABLED_PLUGINS="$ENABLED_PLUGINS chatsort"],)
 
-AC_ARG_ENABLE([gaym],AC_HELP_STRING([--disable-gaym],[don't build the gaym plugin]),,[ENABLED_PLUGINS="$ENABLED_PLUGINS gaym"])
+AC_ARG_ENABLE([gaym],AC_HELP_STRING([--enable-gaym],[build the gaym plugin @<:@default=yes@:>@]),,[ENABLED_PLUGINS="$ENABLED_PLUGINS gaym"])
 
-AC_ARG_ENABLE([privacy],AC_HELP_STRING([--enable-privacy],[build the privacy plugin]),[ENABLED_PLUGINS="$ENABLED_PLUGINS privacy"],)
+AC_ARG_ENABLE([privacy],AC_HELP_STRING([--enable-privacy],[build the privacy plugin @<:@default=no@:>@]),[ENABLED_PLUGINS="$ENABLED_PLUGINS privacy"],)
 
-AC_ARG_ENABLE([roombrowse],AC_HELP_STRING([--enable-roombrowse],[build the roombrowse plugin]),[ENABLED_PLUGINS="$ENABLED_PLUGINS roombrowse"],)
+AC_ARG_ENABLE([roombrowse],AC_HELP_STRING([--enable-roombrowse],[build the roombrowse plugin @<:@default=no@:>@]),[ENABLED_PLUGINS="$ENABLED_PLUGINS roombrowse"],)
 
 AC_SUBST(ENABLED_PLUGINS)
 
 AC_CONFIG_FILES([Makefile
                  chatsort/Makefile
                  gaym/Makefile
+                 gaym/pixmaps/Makefile
+                 gaym/src/Makefile
                  nsis/Makefile
 		 nsis/locale/Makefile
-                 pixmaps/Makefile
                  privacy/Makefile
                  roombrowse/Makefile])
 AC_OUTPUT

Added: trunk/gaym/Makefile.am
===================================================================
--- trunk/gaym/Makefile.am	2005-06-09 04:11:38 UTC (rev 79)
+++ trunk/gaym/Makefile.am	2005-06-09 04:36:53 UTC (rev 80)
@@ -0,0 +1,3 @@
+SUBDIRS = \
+	src \
+        pixmaps

Copied: trunk/gaym/pixmaps/Makefile.am (from rev 78, trunk/pixmaps/Makefile.am)

Copied: trunk/gaym/pixmaps/gaym.png (from rev 78, trunk/pixmaps/gaym.png)

Added: trunk/roombrowse/Makefile.am
===================================================================
--- trunk/roombrowse/Makefile.am	2005-06-09 04:11:38 UTC (rev 79)
+++ trunk/roombrowse/Makefile.am	2005-06-09 04:36:53 UTC (rev 80)
@@ -0,0 +1,26 @@
+EXTRA_DIST = \
+	Makefile.mingw
+
+pkgdir = \
+	$(GAIM_LIBDIR)/gaim
+
+GAYMSOURCES = \
+	roombrowse.c
+
+AM_CFLAGS = \
+	$(st)
+
+libroombrowse_la_LDFLAGS = \
+	-module \
+	-avoid-version \
+	$(GAIM_LIBS)
+
+pkg_LTLIBRARIES = \
+	libroombrowse.la
+
+libroombrowse_la_SOURCES = \
+	$(GAYMSOURCES)
+
+AM_CPPFLAGS = \
+	$(GAIM_CFLAGS) \
+	$(DEBUG_CFLAGS)

Added: trunk/roombrowse/Makefile.mingw
===================================================================
--- trunk/roombrowse/Makefile.mingw	2005-06-09 04:11:38 UTC (rev 79)
+++ trunk/roombrowse/Makefile.mingw	2005-06-09 04:36:53 UTC (rev 80)
@@ -0,0 +1,122 @@
+#
+# Makefile.mingw
+#
+# Description: Makefile for win32 (mingw) version of libgaym
+
+# Compiler Options
+
+CFLAGS =
+
+DEFINES =
+
+
+# Use -g flag when building debug version of Gaim (including plugins).
+# Use -fnative-struct instead of -mms-bitfields when using mingw 1.1
+# (gcc 2.95)
+CFLAGS += -O2 -Wall -mno-cygwin -mms-bitfields
+
+# If not specified, dlls are built with the default base address of 0x10000000.
+# When loaded into a process address space a dll will be rebased if its base
+# address colides with the base address of an existing dll.  To avoid rebasing
+# we do the following.  Rebasing can slow down the load time of dlls and it
+# also renders debug info useless.
+DLL_LD_FLAGS += -Wl,--enable-auto-image-base
+
+ifdef GAIM_TOP
+VERSION := $(shell cat $(GAIM_TOP)/VERSION)
+endif
+
+DEFINES +=      -DVERSION=\"$(VERSION)\" \
+                -DHAVE_CONFIG_H
+
+##
+## TARGET
+##
+
+TARGET = libgaym
+
+##
+## INCLUDE PATHS
+##
+
+INCLUDE_PATHS +=	-I$../ \
+			-I$(GTK_TOP)/include \
+			-I$(GTK_TOP)/include/gtk-2.0 \
+			-I$(GTK_TOP)/include/glib-2.0 \
+			-I$(GTK_TOP)/include/pango-1.0 \
+			-I$(GTK_TOP)/include/atk-1.0 \
+			-I$(GTK_TOP)/lib/glib-2.0/include \
+			-I$(GTK_TOP)/lib/gtk-2.0/include \
+			-I$(GAIM_TOP)/src \
+			-I$(GAIM_TOP)/src/win32 \
+			-I$(GAIM_TOP)
+
+
+LIB_PATHS =		-L$(GTK_TOP)/lib \
+			-L$(GAIM_TOP)/src
+
+
+##
+##  SOURCES, OBJECTS
+##
+
+C_SRC =			cmds.c \
+			dcc_send.c \
+			gaym.c \
+			gaympriv.c \
+			helpers.c \
+			msgs.c \
+			parse.c \
+			weblogin.c
+
+
+OBJECTS = $(C_SRC:%.c=%.o)
+
+
+##
+## LIBRARIES
+##
+
+LIBS =			-lgtk-win32-2.0 \
+			-lglib-2.0 \
+			-lgdk-win32-2.0 \
+			-lgmodule-2.0 \
+			-lgobject-2.0 \
+			-lws2_32 \
+			-lintl \
+			-lgaim
+
+
+##
+## RULES
+##
+
+# How to make a C file
+
+%.o: %.c
+	$(CC) $(CFLAGS) $(DEFINES) $(INCLUDE_PATHS) -o $@ -c $<
+
+##
+## TARGET DEFINITIONS
+##
+
+.PHONY: all clean
+
+all: $(TARGET).dll
+
+
+##
+## BUILD DLL
+##
+
+$(TARGET).dll: $(OBJECTS)
+	$(CC) -shared $(OBJECTS) $(LIB_PATHS) $(LIBS) $(DLL_LD_FLAGS) -Wl,--out-implib,$(TARGET).lib -o $(TARGET).dll
+
+##
+## CLEAN RULES
+##
+
+clean:
+	-rm *.o
+	-rm $(TARGET).dll
+	-rm $(TARGET).lib



From deckrider at sheep.berlios.de  Thu Jun  9 08:16:52 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Thu, 9 Jun 2005 08:16:52 +0200
Subject: [Qrc-svn] r81 - in trunk: . chatsort roombrowse
Message-ID: <200506090616.j596GqZR013119@sheep.berlios.de>

Author: deckrider
Date: 2005-06-09 08:16:28 +0200 (Thu, 09 Jun 2005)
New Revision: 81

Modified:
   trunk/Makefile.am
   trunk/chatsort/Makefile.am
   trunk/configure.ac
   trunk/roombrowse/Makefile.am
Log:
Can somwhat build all plugins now.  But there are some warnings.
And I think I'm not aware of all the dependencies that might be
needed.


Modified: trunk/Makefile.am
===================================================================
--- trunk/Makefile.am	2005-06-09 04:36:53 UTC (rev 80)
+++ trunk/Makefile.am	2005-06-09 06:16:28 UTC (rev 81)
@@ -1,10 +1,19 @@
-DIST_SUBDIRS = \
-	nsis \
-	chatsort \
-	gaym \
-	privacy \
-	roombrowse
+if COND_CHATSORT
+MAYBE_CHATSORT = chatsort
+endif
 
+if COND_GAYM
+MAYBE_GAYM = gaym
+endif
+
+if COND_PRIVACY
+MAYBE_PRIVACY = privacy
+endif
+
+if COND_ROOMBROWSE
+MAYBE_ROOMBROWSE = roombrowse
+endif
+
 EXTRA_DIST = \
 	Makefile.mingw \
 	README.mingw \
@@ -12,5 +21,7 @@
 
 SUBDIRS = \
 	nsis \
-	$(ENABLED_PLUGINS)
-
+	$(MAYBE_CHATSORT) \
+	$(MAYBE_GAYM) \
+	$(MAYBE_PRIVACY) \
+	$(MAYBE_ROOMBROWSE)

Modified: trunk/chatsort/Makefile.am
===================================================================
--- trunk/chatsort/Makefile.am	2005-06-09 04:36:53 UTC (rev 80)
+++ trunk/chatsort/Makefile.am	2005-06-09 06:16:28 UTC (rev 81)
@@ -13,7 +13,8 @@
 libchatsort_la_LDFLAGS = \
 	-module \
 	-avoid-version \
-	$(GAIM_LIBS)
+	$(GAIM_LIBS) \
+	$(GTK_LIBS)
 
 pkg_LTLIBRARIES = \
 	libchatsort.la
@@ -23,4 +24,5 @@
 
 AM_CPPFLAGS = \
 	$(GAIM_CFLAGS) \
+	$(GTK_CFLAGS) \
 	$(DEBUG_CFLAGS)

Modified: trunk/configure.ac
===================================================================
--- trunk/configure.ac	2005-06-09 04:36:53 UTC (rev 80)
+++ trunk/configure.ac	2005-06-09 06:16:28 UTC (rev 81)
@@ -20,6 +20,7 @@
 AC_PROG_LIBTOOL
 LIBTOOL="$LIBTOOL --silent"
 AC_PROG_INSTALL
+AC_PROG_RANLIB
 
 # Checks for libraries.
 PKG_CHECK_MODULES([GAIM], [$REQUIRED_GAIM],
@@ -39,6 +40,54 @@
 AC_SUBST(GAIM_DATADIR)
 AC_SUBST(GAIM_LIBDIR)
 
+AM_PATH_GLIB_2_0(2.0.0,,AC_MSG_ERROR([
+*** GLib 2.0 is required to build the QRC plugins; please make sure you
+*** have the GLib development headers installed. The latest version of
+*** GLib is always available at http://www.gtk.org/.]))
+AC_SUBST(GLIB_LIBS)
+AC_SUBST(GLIB_CFLAGS)
+
+AC_ARG_ENABLE([chatsort],AC_HELP_STRING([--enable-chatsort],[build the chatsort plugin @<:@default=no@:>@]),[want_chatsort="yes"],)
+
+AC_ARG_ENABLE([gaym],AC_HELP_STRING([--enable-gaym],[build the gaym plugin @<:@default=yes@:>@]),,[want_gaym="yes"])
+
+AC_ARG_ENABLE([privacy],AC_HELP_STRING([--enable-privacy],[build the privacy plugin @<:@default=no@:>@]),[want_privacy="yes"],)
+
+AC_ARG_ENABLE([roombrowse],AC_HELP_STRING([--enable-roombrowse],[build the roombrowse plugin @<:@default=no@:>@]),[want_roombrowse="yes"],)
+
+AM_CONDITIONAL([COND_CHATSORT], [test "$want_chatsort" = "yes"])
+AM_CONDITIONAL([COND_GAYM], [test "$want_gaym" = "yes"])
+AM_CONDITIONAL([COND_PRIVACY], [test "$want_privacy" = "yes"])
+AM_CONDITIONAL([COND_ROOMBROWSE], [test "$want_roombrowse" = "yes"])
+
+if test "$want_chatsort" != "yes" ; then
+	want_chatsort="no"
+fi
+
+if test "$want_gaym" != "yes" ; then
+	want_gaym="no"
+fi
+
+if test "$want_privacy" != "yes" ; then
+	want_privacy="no"
+fi
+
+if test "$want_roombrowse" != "yes" ; then
+	want_roombrowse="no"
+fi
+
+if test "$want_chatsort" = "yes" -o "$want_roombrowse" = "yes" ; then
+
+AM_PATH_GTK_2_0(2.0.0,,AC_MSG_ERROR([
+*** GTK+ 2.0 is required to build the roombrowse and chatsort QRC
+*** plugins; please make sure you have the GTK+ development headers
+*** installed. The latest version of GTK+ is always available at
+*** http://www.gtk.org/.]))
+AC_SUBST(GTK_LIBS)
+AC_SUBST(GTK_CFLAGS)
+
+fi
+
 # Checks for header files.
 AC_HEADER_STDC
 AC_CHECK_HEADERS([stdlib.h string.h])
@@ -55,18 +104,7 @@
 fi
 AC_SUBST(CFLAGS)
 
-ENABLED_PLUGINS=""
 
-AC_ARG_ENABLE([chatsort],AC_HELP_STRING([--enable-chatsort],[build the chatsort plugin @<:@default=no@:>@]),[ENABLED_PLUGINS="$ENABLED_PLUGINS chatsort"],)
-
-AC_ARG_ENABLE([gaym],AC_HELP_STRING([--enable-gaym],[build the gaym plugin @<:@default=yes@:>@]),,[ENABLED_PLUGINS="$ENABLED_PLUGINS gaym"])
-
-AC_ARG_ENABLE([privacy],AC_HELP_STRING([--enable-privacy],[build the privacy plugin @<:@default=no@:>@]),[ENABLED_PLUGINS="$ENABLED_PLUGINS privacy"],)
-
-AC_ARG_ENABLE([roombrowse],AC_HELP_STRING([--enable-roombrowse],[build the roombrowse plugin @<:@default=no@:>@]),[ENABLED_PLUGINS="$ENABLED_PLUGINS roombrowse"],)
-
-AC_SUBST(ENABLED_PLUGINS)
-
 AC_CONFIG_FILES([Makefile
                  chatsort/Makefile
                  gaym/Makefile
@@ -79,9 +117,14 @@
 AC_OUTPUT
 
 echo
-echo The following plugins will be built: $ENABLED_PLUGINS
+echo $PACKAGE $VERSION
 echo
-echo $PACKAGE $VERSION will be installed in $GAIM_LIBDIR/gaim
+echo Build chatsort plugin............ : $want_chatsort
+echo Build gaym plugin................ : $want_gaym
+echo Build privacy plugin............. : $want_privacy
+echo Build roombrowse plugin.......... : $want_roombrowse
 echo
+echo Installation directory........... : $GAIM_LIBDIR/gaim
+echo
 echo configure complete, now type \'make\'
 echo

Modified: trunk/roombrowse/Makefile.am
===================================================================
--- trunk/roombrowse/Makefile.am	2005-06-09 04:36:53 UTC (rev 80)
+++ trunk/roombrowse/Makefile.am	2005-06-09 06:16:28 UTC (rev 81)
@@ -13,7 +13,8 @@
 libroombrowse_la_LDFLAGS = \
 	-module \
 	-avoid-version \
-	$(GAIM_LIBS)
+	$(GAIM_LIBS) \
+	$(GTK_LIBS)
 
 pkg_LTLIBRARIES = \
 	libroombrowse.la
@@ -23,4 +24,5 @@
 
 AM_CPPFLAGS = \
 	$(GAIM_CFLAGS) \
+	$(GTK_CFLAGS) \
 	$(DEBUG_CFLAGS)



From deckrider at sheep.berlios.de  Thu Jun  9 08:56:01 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Thu, 9 Jun 2005 08:56:01 +0200
Subject: [Qrc-svn] r82 - in trunk: . gaym nsis
Message-ID: <200506090656.j596u1KU030207@sheep.berlios.de>

Author: deckrider
Date: 2005-06-09 08:55:37 +0200 (Thu, 09 Jun 2005)
New Revision: 82

Added:
   trunk/gaym/Makefile.mingw
Modified:
   trunk/Makefile.mingw
   trunk/gaym/Makefile.am
   trunk/nsis/installer.nsi
Log:
Updating win32 build.

Modified: trunk/Makefile.mingw
===================================================================
--- trunk/Makefile.mingw	2005-06-09 06:16:28 UTC (rev 81)
+++ trunk/Makefile.mingw	2005-06-09 06:55:37 UTC (rev 82)
@@ -13,5 +13,5 @@
 		-DGAIM_TOP="$(GAIM_TOP)" nsis/installer.nsi
 
 clean:
-	$(MAKE) -C src -f Makefile.mingw clean
+	$(MAKE) -C gaym -f Makefile.mingw clean
 	-rm *.exe

Modified: trunk/gaym/Makefile.am
===================================================================
--- trunk/gaym/Makefile.am	2005-06-09 06:16:28 UTC (rev 81)
+++ trunk/gaym/Makefile.am	2005-06-09 06:55:37 UTC (rev 82)
@@ -1,3 +1,6 @@
+EXTRA_DIST = \
+	Makefile.mingw
+
 SUBDIRS = \
 	src \
         pixmaps

Added: trunk/gaym/Makefile.mingw
===================================================================
--- trunk/gaym/Makefile.mingw	2005-06-09 06:16:28 UTC (rev 81)
+++ trunk/gaym/Makefile.mingw	2005-06-09 06:55:37 UTC (rev 82)
@@ -0,0 +1,10 @@
+# Makefile.mingw
+#
+# Description: Top Makefile for win32 (mingw) port of qrc
+#
+
+all:
+	$(MAKE) -C src -f Makefile.mingw
+
+clean:
+	$(MAKE) -C src -f Makefile.mingw clean

Modified: trunk/nsis/installer.nsi
===================================================================
--- trunk/nsis/installer.nsi	2005-06-09 06:16:28 UTC (rev 81)
+++ trunk/nsis/installer.nsi	2005-06-09 06:55:37 UTC (rev 82)
@@ -172,10 +172,10 @@
     SetOutPath "$INSTDIR\plugins"
     SetCompress Auto
     SetOverwrite on
-    File "..\gaym\${GAYM_DLL}"
+    File "..\gaym\src\${GAYM_DLL}"
     
     SetOutPath "$INSTDIR\pixmaps\gaim\status\default"
-    File "..\pixmaps\${GAYM_PNG}"
+    File "..\gaym\pixmaps\${GAYM_PNG}"
     
     StrCmp $R0 "NONE" done
     CreateShortCut "$SMPROGRAMS\Gaim\${GAYM_UNINSTALL_LNK}" "$INSTDIR\${GAYM_UNINST_EXE}"



From deckrider at sheep.berlios.de  Thu Jun  9 08:58:18 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Thu, 9 Jun 2005 08:58:18 +0200
Subject: [Qrc-svn] r83 - trunk
Message-ID: <200506090658.j596wIIT030773@sheep.berlios.de>

Author: deckrider
Date: 2005-06-09 08:57:44 +0200 (Thu, 09 Jun 2005)
New Revision: 83

Modified:
   trunk/configure.ac
Log:
Using AC_PROG_RANLIB is rendered obsolete by AC_PROG_LIBTOOL

Modified: trunk/configure.ac
===================================================================
--- trunk/configure.ac	2005-06-09 06:55:37 UTC (rev 82)
+++ trunk/configure.ac	2005-06-09 06:57:44 UTC (rev 83)
@@ -20,7 +20,6 @@
 AC_PROG_LIBTOOL
 LIBTOOL="$LIBTOOL --silent"
 AC_PROG_INSTALL
-AC_PROG_RANLIB
 
 # Checks for libraries.
 PKG_CHECK_MODULES([GAIM], [$REQUIRED_GAIM],



From deckrider at sheep.berlios.de  Fri Jun 10 01:38:40 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Fri, 10 Jun 2005 01:38:40 +0200
Subject: [Qrc-svn] r85 - in trunk: . nsis nsis/locale
Message-ID: <200506092338.j59NcejF000908@sheep.berlios.de>

Author: deckrider
Date: 2005-06-10 01:38:19 +0200 (Fri, 10 Jun 2005)
New Revision: 85

Modified:
   trunk/README.mingw
   trunk/nsis/installer.nsi
   trunk/nsis/locale/english.nsh
Log:
Convert nsis components to new structure.  Update README.mingw in
light of this.


Modified: trunk/README.mingw
===================================================================
--- trunk/README.mingw	2005-06-09 22:17:03 UTC (rev 84)
+++ trunk/README.mingw	2005-06-09 23:38:19 UTC (rev 85)
@@ -1,16 +1,38 @@
-To install:
+         NEW AND IMPROVED WIN32 (tested on Debian/GNU Linux)
 
-   - install gaim from http://gaim.sourceforge.net/win32/index.php
+Getting a build environment:
 
-   - probably you need to reboot at this point
+   Get something like gaim-win32-dev-1.3.0-1.tar.gz from
+   http://developer.berlios.de/projects/qrc/
 
-   - find the file "libirc.dll" and put "libgaym.dll" in the same
-     directory
+   Unwind it in a directory of your choice and run build-pkgconfig.sh to
+   set up the pkgconfig paths.
 
-   - find the file "irc.png" and put "gaym.png" in the same directory
+Running configure:
+   
+   ./configure --host=i586-mingw32msvc \
+   PKG_CONFIG_PATH=/some/path/to/gaim-win32-dev-1.3.0-1/pkgconfig
 
-   - probably you need to reboot at this point
+Running make:
 
+   make   (what did you expect?)
+
+Building the windows installer
+
+   makensis -DQRC_VERSION="0.33.0+svn" -DGAIM_VERSION="1.3.0" \
+   -DGAIM_TOP="/some/path/to/gaim-win32-dev-1.3.0-1/gaim-1.3.0" \
+   nsis/installer.nsi
+
+   QRC_VERSION and GAIM_VERSION are I hope obvious.
+
+   GAIM_TOP is the absolute path to the top level directory inside your
+   win32 gaim development libraries and headers.
+
+How to make a win32 build environment (only true geeks need this):
+
+   This documents how the win32 build environment available at
+   http://developer.berlios.de/projects/qrc/ was created.
+
 To build from linux:
 
    - This assumes your home directory is /home/deckrider, and your
@@ -39,18 +61,18 @@
 
    - make -f Makefile.mingw  gaim.dll CC=i586-mingw32msvc-gcc
 
-   - Now you can build the gaym plugin from its top level source
-     directory (the same directory containing this file).  This
-     requires that you have nsis to build the windows installer:
+   - Additionally, you need to rename gaim.dll to libgaim.dll
 
-   - make -f Makefile.mingw install \
-     GAYM_VERSION="0.33.0+2005-06-03" \
-     GAIM_VERSION="1.3.0" \
-     GAIM_TOP="/home/deckrider/wingaim/gaim-1.3.0" \
-     CC=i586-mingw32msvc-gcc \
-     MAKENSIS=makensis \
-     GTK_TOP="/home/deckrider/wingaim/win32-dev/gtk_2_0"
+   - move the top level gaim directory in with the others under
+     win32-dev
 
-   - make -f Makefile.mingw clean
-     (will restore the the source tree to its pristine form)
+   - find all the *.pc files, put them in a central location and fix
+     their paths (since they report a path different from where they
+     probably are now)
 
+   - Finally you will need to create gaim.pc, since for some reason they
+     don't build one under win32.  You can use the template they provide
+     called gaim.pc.in (used for regular builds).  Note that under
+     win32, all gaim plugins require gtk, even if they don't directly
+     use it.
+

Modified: trunk/nsis/installer.nsi
===================================================================
--- trunk/nsis/installer.nsi	2005-06-09 22:17:03 UTC (rev 84)
+++ trunk/nsis/installer.nsi	2005-06-09 23:38:19 UTC (rev 85)
@@ -1,15 +1,15 @@
-; NSIS Script For Gaim-GayM Plugin
+; NSIS Script for the Gaim-QRC Plugins
 ; Uses NSIS v2.0
 
-Name "Gaim-GayM ${GAYM_VERSION}"
+Name "Gaim-QRC ${QRC_VERSION}"
 
 ; Registry keys:
-!define GAYM_REG_KEY        "SOFTWARE\gaim-qrc"
-!define GAYM_UNINSTALL_KEY  "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\gaim-qrc"
-!define GAYM_UNINST_EXE     "gaim-qrc-uninst.exe"
-!define GAYM_DLL            "libgaym.dll"
-!define GAYM_PNG            "gaym.png"
-!define GAYM_UNINSTALL_LNK  "Gaim-GayM Uninstall.lnk"
+!define QRC_REG_KEY        "SOFTWARE\gaim-qrc"
+!define QRC_UNINSTALL_KEY  "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\gaim-qrc"
+!define QRC_UNINST_EXE     "gaim-qrc-uninst.exe"
+!define GAYM_DLL           "libgaym.dll"
+!define GAYM_PNG           "gaym.png"
+!define QRC_UNINSTALL_LNK  "Gaim-QRC Uninstall.lnk"
 
 !include "MUI.nsh"
 
@@ -17,7 +17,7 @@
 CRCCheck On
 
 ;Output File Name
-OutFile "..\gaim-${GAIM_VERSION}-qrc-${GAYM_VERSION}.exe"
+OutFile "..\gaim-${GAIM_VERSION}-qrc-${QRC_VERSION}.exe"
 
 ShowInstDetails show
 ShowUnInstDetails show
@@ -78,15 +78,15 @@
   StrCmp $R0 "HKCU" rights_hkcu done
 
   rights_hkcu:
-      ReadRegStr $R1 HKCU "${GAYM_REG_KEY}" ""
-      ReadRegStr $R2 HKCU "${GAYM_REG_KEY}" "Version"
-      ReadRegStr $R3 HKCU "${GAYM_UNINSTALL_KEY}" "UninstallString"
+      ReadRegStr $R1 HKCU "${QRC_REG_KEY}" ""
+      ReadRegStr $R2 HKCU "${QRC_REG_KEY}" "Version"
+      ReadRegStr $R3 HKCU "${QRC_UNINSTALL_KEY}" "UninstallString"
       Goto try_uninstall
 
   rights_hklm:
-      ReadRegStr $R1 HKLM "${GAYM_REG_KEY}" ""
-      ReadRegStr $R2 HKLM "${GAYM_REG_KEY}" "Version"
-      ReadRegStr $R3 HKLM "${GAYM_UNINSTALL_KEY}" "UninstallString"
+      ReadRegStr $R1 HKLM "${QRC_REG_KEY}" ""
+      ReadRegStr $R2 HKLM "${QRC_REG_KEY}" "Version"
+      ReadRegStr $R3 HKLM "${QRC_UNINSTALL_KEY}" "UninstallString"
 
   ; If previous version exists .. remove
   try_uninstall:
@@ -97,33 +97,33 @@
           SetOverwrite on
           ; Need to copy uninstaller outside of the install dir
           ClearErrors
-          CopyFiles /SILENT $R3 "$TEMP\${GAYM_UNINST_EXE}"
+          CopyFiles /SILENT $R3 "$TEMP\${QRC_UNINST_EXE}"
           SetOverwrite off
           IfErrors uninstall_problem
             ; Ready to uninstall..
             ClearErrors
-            ExecWait '"$TEMP\${GAYM_UNINST_EXE}" /S _?=$R1'
+            ExecWait '"$TEMP\${QRC_UNINST_EXE}" /S _?=$R1'
             IfErrors exec_error
-              Delete "$TEMP\${GAYM_UNINST_EXE}"
+              Delete "$TEMP\${QRC_UNINST_EXE}"
               Goto done
 
             exec_error:
-              Delete "$TEMP\${GAYM_UNINST_EXE}"
+              Delete "$TEMP\${QRC_UNINST_EXE}"
               Goto uninstall_problem
 
         uninstall_problem:
             ; Just delete the plugin and uninstaller, and remove Registry key
-             MessageBox MB_YESNO $(GAYM_PROMPT_WIPEOUT) IDYES do_wipeout IDNO cancel_install
+             MessageBox MB_YESNO $(QRC_PROMPT_WIPEOUT) IDYES do_wipeout IDNO cancel_install
           cancel_install:
             Quit
 
           do_wipeout:
             StrCmp $R0 "HKLM" del_lm_reg del_cu_reg
             del_cu_reg:
-              DeleteRegKey HKCU ${GAYM_REG_KEY}
+              DeleteRegKey HKCU ${QRC_REG_KEY}
               Goto uninstall_prob_cont
             del_lm_reg:
-              DeleteRegKey HKLM ${GAYM_REG_KEY}
+              DeleteRegKey HKLM ${QRC_REG_KEY}
 
             uninstall_prob_cont:
               ; plugin DLL
@@ -146,23 +146,23 @@
 
   instrights_hklm:
     ; Write the version registry keys:
-    WriteRegStr HKLM ${GAYM_REG_KEY} "" "$INSTDIR"
-    WriteRegStr HKLM ${GAYM_REG_KEY} "Version" "${GAYM_VERSION}"
+    WriteRegStr HKLM ${QRC_REG_KEY} "" "$INSTDIR"
+    WriteRegStr HKLM ${QRC_REG_KEY} "Version" "${QRC_VERSION}"
 
     ; Write the uninstall keys for Windows
-    WriteRegStr HKLM ${GAYM_UNINSTALL_KEY} "DisplayName" "$(GAYM_UNINSTALL_DESC)"
-    WriteRegStr HKLM ${GAYM_UNINSTALL_KEY} "UninstallString" "$INSTDIR\${GAYM_UNINST_EXE}"
+    WriteRegStr HKLM ${QRC_UNINSTALL_KEY} "DisplayName" "$(QRC_UNINSTALL_DESC)"
+    WriteRegStr HKLM ${QRC_UNINSTALL_KEY} "UninstallString" "$INSTDIR\${QRC_UNINST_EXE}"
     SetShellVarContext "all"
     Goto install_files
 
   instrights_hkcu:
     ; Write the version registry keys:
-    WriteRegStr HKCU ${GAYM_REG_KEY} "" "$INSTDIR"
-    WriteRegStr HKCU ${GAYM_REG_KEY} "Version" "${GAYM_VERSION}"
+    WriteRegStr HKCU ${QRC_REG_KEY} "" "$INSTDIR"
+    WriteRegStr HKCU ${QRC_REG_KEY} "Version" "${QRC_VERSION}"
 
     ; Write the uninstall keys for Windows
-    WriteRegStr HKCU ${GAYM_UNINSTALL_KEY} "DisplayName" "$(GAYM_UNINSTALL_DESC)"
-    WriteRegStr HKCU ${GAYM_UNINSTALL_KEY} "UninstallString" "$INSTDIR\${GAYM_UNINST_EXE}"
+    WriteRegStr HKCU ${QRC_UNINSTALL_KEY} "DisplayName" "$(QRC_UNINSTALL_DESC)"
+    WriteRegStr HKCU ${QRC_UNINSTALL_KEY} "UninstallString" "$INSTDIR\${QRC_UNINST_EXE}"
     Goto install_files
   
   instrights_none:
@@ -172,14 +172,14 @@
     SetOutPath "$INSTDIR\plugins"
     SetCompress Auto
     SetOverwrite on
-    File "..\gaym\src\${GAYM_DLL}"
+    File "..\gaym\src\.libs\${GAYM_DLL}"
     
     SetOutPath "$INSTDIR\pixmaps\gaim\status\default"
     File "..\gaym\pixmaps\${GAYM_PNG}"
     
     StrCmp $R0 "NONE" done
-    CreateShortCut "$SMPROGRAMS\Gaim\${GAYM_UNINSTALL_LNK}" "$INSTDIR\${GAYM_UNINST_EXE}"
-    WriteUninstaller "$INSTDIR\${GAYM_UNINST_EXE}"
+    CreateShortCut "$SMPROGRAMS\Gaim\${QRC_UNINSTALL_LNK}" "$INSTDIR\${QRC_UNINST_EXE}"
+    WriteUninstaller "$INSTDIR\${QRC_UNINST_EXE}"
     SetOverWrite off
 
   done:
@@ -192,19 +192,19 @@
   StrCmp $R0 "HKCU" try_hkcu try_hklm
 
   try_hkcu:
-    ReadRegStr $R0 HKCU "${GAYM_REG_KEY}" ""
+    ReadRegStr $R0 HKCU "${QRC_REG_KEY}" ""
     StrCmp $R0 $INSTDIR 0 cant_uninstall
       ; HKCU install path matches our INSTDIR.. so uninstall
-      DeleteRegKey HKCU "${GAYM_REG_KEY}"
-      DeleteRegKey HKCU "${GAYM_UNINSTALL_KEY}"
+      DeleteRegKey HKCU "${QRC_REG_KEY}"
+      DeleteRegKey HKCU "${QRC_UNINSTALL_KEY}"
       Goto cont_uninstall
 
   try_hklm:
-    ReadRegStr $R0 HKLM "${GAYM_REG_KEY}" ""
+    ReadRegStr $R0 HKLM "${QRC_REG_KEY}" ""
     StrCmp $R0 $INSTDIR 0 try_hkcu
       ; HKLM install path matches our INSTDIR.. so uninstall
-      DeleteRegKey HKLM "${GAYM_REG_KEY}"
-      DeleteRegKey HKLM "${GAYM_UNINSTALL_KEY}"
+      DeleteRegKey HKLM "${QRC_REG_KEY}"
+      DeleteRegKey HKLM "${QRC_UNINSTALL_KEY}"
       ; Sets start menu and desktop scope to all users..
       SetShellVarContext "all"
 
@@ -214,9 +214,9 @@
     ; pixmaps
     Delete "$INSTDIR\pixmaps\gaim\status\default\${GAYM_PNG}"
     ; uninstaller
-    Delete "$INSTDIR\${GAYM_UNINST_EXE}"
+    Delete "$INSTDIR\${QRC_UNINST_EXE}"
     ; uninstaller shortcut
-    Delete "$SMPROGRAMS\Gaim\${GAYM_UNINSTALL_LNK}"
+    Delete "$SMPROGRAMS\Gaim\${QRC_UNINSTALL_LNK}"
     
     ; try to delete the Gaim directories, in case it has already uninstalled
     RMDir "$INSTDIR\plugins"
@@ -226,11 +226,11 @@
     Goto done
 
   cant_uninstall:
-    MessageBox MB_OK $(un.GAYM_UNINSTALL_ERROR_1) IDOK
+    MessageBox MB_OK $(un.QRC_UNINSTALL_ERROR_1) IDOK
     Quit
 
   no_rights:
-    MessageBox MB_OK $(un.GAYM_UNINSTALL_ERROR_2) IDOK
+    MessageBox MB_OK $(un.QRC_UNINSTALL_ERROR_2) IDOK
     Quit
 
   done:

Modified: trunk/nsis/locale/english.nsh
===================================================================
--- trunk/nsis/locale/english.nsh	2005-06-09 22:17:03 UTC (rev 84)
+++ trunk/nsis/locale/english.nsh	2005-06-09 23:38:19 UTC (rev 85)
@@ -6,34 +6,34 @@
 ;;
 
 ; Startup Gaim check
-LangString GAIM_NEEDED ${LANG_ENGLISH} "Gaim-GayM requires that Gaim be installed. You must install Gaim (http://gaim.sourceforge.net/win32/index.php) before installing Gaim-GayM."
+LangString GAIM_NEEDED ${LANG_ENGLISH} "The Gaim-QRC plugins require that Gaim be installed. You must install Gaim (http://gaim.sourceforge.net/win32/index.php) before installing Gaim-QRC."
 
-LangString GAYM_TITLE ${LANG_ENGLISH} "Gaim-GayM plugin for Gaim"
+LangString QRC_TITLE ${LANG_ENGLISH} "Gaim-QRC plugins for Gaim"
 
 LangString NO_GAIM_VERSION ${LANG_ENGLISH} "Unable to determine installed Gaim version."
 
-LangString BAD_GAIM_VERSION_1 ${LANG_ENGLISH} "Incompatible version.$\r$\n$\r$\nThis version of the Gaim-GayM plugin was built for Gaim version ${GAIM_VERSION}.  It appears that you have Gaim version"
+LangString BAD_GAIM_VERSION_1 ${LANG_ENGLISH} "Incompatible version.$\r$\n$\r$\nThis version of the Gaim-QRC plugins was built for Gaim version ${GAIM_VERSION}.  It appears that you have Gaim version"
 
 LangString BAD_GAIM_VERSION_2 ${LANG_ENGLISH} "installed.$\r$\n$\r$\nSee http://developer.berlios.de/projects/qrc/ for more information."
 
 ; Overrides for default text in windows:
 
-LangString WELCOME_TITLE ${LANG_ENGLISH} "Gaim-GayM v${GAYM_VERSION} Installer"
+LangString WELCOME_TITLE ${LANG_ENGLISH} "Gaim-QRC v${QRC_VERSION} Installer"
 LangString WELCOME_TEXT  ${LANG_ENGLISH} "Note: This version of the plugin is designed for Gaim ${GAIM_VERSION}, and will not install or function with other versions of Gaim.\r\n\r\nWhen you upgrade your version of Gaim, you must uninstall or upgrade this plugin as well.\r\n\r\n"
 
 LangString DIR_SUBTITLE ${LANG_ENGLISH} "Please locate the directory where Gaim is installed"
 LangString DIR_INNERTEXT ${LANG_ENGLISH} "Install in this Gaim folder:"
 
-LangString FINISH_TITLE ${LANG_ENGLISH} "Gaim-GayM v${GAYM_VERSION} Install Complete"
+LangString FINISH_TITLE ${LANG_ENGLISH} "Gaim-QRC v${QRC_VERSION} Install Complete"
 LangString FINISH_TEXT ${LANG_ENGLISH} "You will need to restart Gaim for the plugin to be loaded."
 
 ; during install uninstaller
-LangString GAYM_PROMPT_WIPEOUT ${LANG_ENGLISH} "The libgaym.dll plugin is about to be deleted from your Gaim/plugins directory.  Continue?"
+LangString QRC_PROMPT_WIPEOUT ${LANG_ENGLISH} "The libgaym.dll plugin is about to be deleted from your Gaim/plugins directory.  Continue?"
 
 ; for windows uninstall
-LangString GAYM_UNINSTALL_DESC ${LANG_ENGLISH} "Gaim-GayM Plugin (remove only)"
-LangString un.GAYM_UNINSTALL_ERROR_1 ${LANG_ENGLISH} "The uninstaller could not find registry entries for Gaim-GayM.$\rIt is likely that another user installed the plugin."
-LangString un.GAYM_UNINSTALL_ERROR_2 ${LANG_ENGLISH} "You do not have the permissions necessary to uninstall the plugin."
+LangString QRC_UNINSTALL_DESC ${LANG_ENGLISH} "Gaim-QRC Plugins (remove only)"
+LangString un.QRC_UNINSTALL_ERROR_1 ${LANG_ENGLISH} "The uninstaller could not find registry entries for Gaim-QRC.$\rIt is likely that another user installed the plugin."
+LangString un.QRC_UNINSTALL_ERROR_2 ${LANG_ENGLISH} "You do not have the permissions necessary to uninstall the plugin."
 
 
 



From deckrider at sheep.berlios.de  Fri Jun 10 02:53:50 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Fri, 10 Jun 2005 02:53:50 +0200
Subject: [Qrc-svn] r86 - in trunk: . chatsort roombrowse
Message-ID: <200506100053.j5A0roG1003727@sheep.berlios.de>

Author: deckrider
Date: 2005-06-10 02:53:29 +0200 (Fri, 10 Jun 2005)
New Revision: 86

Modified:
   trunk/chatsort/chatsort.c
   trunk/configure.ac
   trunk/roombrowse/roombrowse.c
Log:
configure.ac
   Be a little more elegant with the depends

chatsort/chatsort.c
roombrowse/roombrowse.c
   Eliminate compiler warnings


Modified: trunk/chatsort/chatsort.c
===================================================================
--- trunk/chatsort/chatsort.c	2005-06-09 23:38:19 UTC (rev 85)
+++ trunk/chatsort/chatsort.c	2005-06-10 00:53:29 UTC (rev 86)
@@ -29,8 +29,12 @@
 static void redochatwindow(GaimConversation *c) {
 
 	GtkListStore *ls;
-	GtkCellRenderer *rend;
-	GtkTreeViewColumn *col;
+	/**
+	 * Unused variables:
+	 *
+	 * GtkCellRenderer *rend;
+	 * GtkTreeViewColumn *col;
+	 */
 	GtkTreeModel *oldls;
 	GtkTreeIter iter;
 	

Modified: trunk/configure.ac
===================================================================
--- trunk/configure.ac	2005-06-09 23:38:19 UTC (rev 85)
+++ trunk/configure.ac	2005-06-10 00:53:29 UTC (rev 86)
@@ -9,6 +9,9 @@
 REQUIRED_GAIM="gaim >= 1.2 gaim < 2.0"
 AC_SUBST(REQUIRED_GAIM)
 
+REQUIRED_GTK="gtk+-2.0"
+AC_SUBST(REQUIRED_GTK)
+
 AC_CONFIG_SRCDIR([gaym/src/gaym.h])
 AC_CONFIG_HEADER([config.h])
 
@@ -22,31 +25,7 @@
 LIBTOOL="$LIBTOOL --silent"
 AC_PROG_INSTALL
 
-# Checks for libraries.
-PKG_CHECK_MODULES([GAIM], [$REQUIRED_GAIM],
-	[
-	AC_SUBST(GAIM_CFLAGS)
-	AC_SUBST(GAIM_LIBS)
-	]
-)
-AC_ARG_VAR([GAIM_DATADIR], [datadir of GAIM, overriding pkg-config])dnl
-AC_ARG_VAR([GAIM_LIBDIR], [libdir of GAIM, overriding pkg-config])dnl
-AC_CACHE_CHECK([for GAIM][_DATADIR], [pkg_cv_][GAIM][_DATADIR],
-	[_PKG_CONFIG([GAIM][_DATADIR], [variable=datadir], [gaim])])
-AC_CACHE_CHECK([for GAIM][_LIBDIR], [pkg_cv_][GAIM][_LIBDIR],
-	[_PKG_CONFIG([GAIM][_LIBDIR], [variable=libdir], [gaim])])
-GAIM[]_DATADIR=$pkg_cv_[]GAIM[]_DATADIR
-GAIM[]_LIBDIR=$pkg_cv_[]GAIM[]_LIBDIR
-AC_SUBST(GAIM_DATADIR)
-AC_SUBST(GAIM_LIBDIR)
-
-AM_PATH_GLIB_2_0(2.0.0,,AC_MSG_ERROR([
-*** GLib 2.0 is required to build the QRC plugins; please make sure you
-*** have the GLib development headers installed. The latest version of
-*** GLib is always available at http://www.gtk.org/.]))
-AC_SUBST(GLIB_LIBS)
-AC_SUBST(GLIB_CFLAGS)
-
+# Build preferences
 AC_ARG_ENABLE([chatsort],AC_HELP_STRING([--enable-chatsort],[build the chatsort plugin @<:@default=no@:>@]),[want_chatsort="yes"],)
 
 AC_ARG_ENABLE([gaym],AC_HELP_STRING([--enable-gaym],[build the gaym plugin @<:@default=yes@:>@]),,[want_gaym="yes"])
@@ -76,18 +55,32 @@
 	want_roombrowse="no"
 fi
 
-#if test "$want_chatsort" = "yes" -o "$want_roombrowse" = "yes" ; then
+# Checks for libraries.
+if test "$want_chatsort" = "yes" -o "$want_roombrowse" = "yes" ; then
+	PKG_CHECK_MODULES([GTK], [$REQUIRED_GTK],
+		[
+		AC_SUBST(GTK_CFLAGS)
+		AC_SUBST(GTK_LIBS)
+		]
+	)
+fi
+PKG_CHECK_MODULES([GAIM], [$REQUIRED_GAIM],
+	[
+	AC_SUBST(GAIM_CFLAGS)
+	AC_SUBST(GAIM_LIBS)
+	]
+)
+AC_ARG_VAR([GAIM_DATADIR], [datadir of GAIM, overriding pkg-config])dnl
+AC_ARG_VAR([GAIM_LIBDIR], [libdir of GAIM, overriding pkg-config])dnl
+AC_CACHE_CHECK([for GAIM][_DATADIR], [pkg_cv_][GAIM][_DATADIR],
+	[_PKG_CONFIG([GAIM][_DATADIR], [variable=datadir], [gaim])])
+AC_CACHE_CHECK([for GAIM][_LIBDIR], [pkg_cv_][GAIM][_LIBDIR],
+	[_PKG_CONFIG([GAIM][_LIBDIR], [variable=libdir], [gaim])])
+GAIM[]_DATADIR=$pkg_cv_[]GAIM[]_DATADIR
+GAIM[]_LIBDIR=$pkg_cv_[]GAIM[]_LIBDIR
+AC_SUBST(GAIM_DATADIR)
+AC_SUBST(GAIM_LIBDIR)
 
-AM_PATH_GTK_2_0(2.0.0,,AC_MSG_ERROR([
-*** GTK+ 2.0 is required to build the roombrowse and chatsort QRC
-*** plugins; please make sure you have the GTK+ development headers
-*** installed. The latest version of GTK+ is always available at
-*** http://www.gtk.org/.]))
-AC_SUBST(GTK_LIBS)
-AC_SUBST(GTK_CFLAGS)
-
-#fi
-
 # Checks for header files.
 AC_HEADER_STDC
 AC_CHECK_HEADERS([stdlib.h string.h])

Modified: trunk/roombrowse/roombrowse.c
===================================================================
--- trunk/roombrowse/roombrowse.c	2005-06-09 23:38:19 UTC (rev 85)
+++ trunk/roombrowse/roombrowse.c	2005-06-10 00:53:29 UTC (rev 86)
@@ -19,13 +19,19 @@
 #include "gtkdialogs.h"
 #include "gtkutils.h"
 #include "gtkblist.h"
+#include "gtkimhtmltoolbar.h"
 #include <gdk/gdkkeysyms.h>
 
 #define CHATSORT_PLUGIN_ID "gtk-chatsort"
 #define CHATSORT_USERS_COLUMNS 4
 #define CHATSORT_USERS_ENTRY_COLUMN 3
 
-static GList *browsers = NULL;
+/**
+ * Unused variables:
+ *
+ * static GList *browsers = NULL;
+ */
+
 struct RoomBrowseInfo {
 
 	GaimAccount *account;
@@ -35,22 +41,28 @@
 static GtkWidget *
 setup_roombrowse_pane(GaimConversation *conv)
 {
-	GaimPluginProtocolInfo *prpl_info = NULL;
 	GaimGtkConversation *gtkconv;
 	GaimGtkChatPane *gtkchat;
 	GaimConnection *gc;
 	GtkWidget *vpaned, *hpaned;
-	GtkWidget *vbox, *hbox;
-	GtkWidget *lbox, *bbox;
-	GtkWidget *label;
-	GtkWidget *list;
-	GtkWidget *button;
-	GtkWidget *sw;
-	GtkListStore *ls;
-	GtkCellRenderer *rend;
-	GtkTreeViewColumn *col;
-	GList *focus_chain = NULL;
+	GtkWidget *vbox;
 
+	/**
+	 * Unused variables:
+	 *
+	 * GaimPluginProtocolInfo *prpl_info = NULL;
+	 * GtkWidget *hbox;
+	 * GtkWidget *lbox, *bbox;
+	 * GtkWidget *label;
+	 * GtkWidget *list;
+	 * GtkWidget *button;
+	 * GtkWidget *sw;
+	 * GtkListStore *ls;
+	 * GtkCellRenderer *rend;
+	 * GtkTreeViewColumn *col;
+	 * GList *focus_chain = NULL;
+	 */
+
 	gtkconv = GAIM_GTK_CONVERSATION(conv);
 	gtkchat = gtkconv->u.chat;
 	gc      = gaim_conversation_get_gc(conv);
@@ -136,6 +148,10 @@
  return status;
 }
 
+/**
+ * Unused function
+ */
+#if 0
 static void
 update_tab_icon(GaimConversation *conv)
 {
@@ -172,6 +188,8 @@
                         g_object_unref(status);
         }
 }
+#endif
+
 /* Courtesy of Galeon! */
 static void
 tab_close_button_state_changed_cb(GtkWidget *widget, GtkStateType prev_state)



From deckrider at sheep.berlios.de  Fri Jun 10 05:40:53 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Fri, 10 Jun 2005 05:40:53 +0200
Subject: [Qrc-svn] r87 - trunk
Message-ID: <200506100340.j5A3ereg010530@sheep.berlios.de>

Author: deckrider
Date: 2005-06-10 05:40:37 +0200 (Fri, 10 Jun 2005)
New Revision: 87

Modified:
   trunk/configure.ac
Log:
An annoying feature of PKG_CHECK_MODULES is that the first instance
in configure.ac is the one that checks and sets up the path to
pkg-config.  But then since the first one was inside a conditional,
it didn't actually set up the path so the second instance decides
it can't find pkg-config.  Anyway, it all seems to work, so long
as the one that is always checked is first.


Modified: trunk/configure.ac
===================================================================
--- trunk/configure.ac	2005-06-10 00:53:29 UTC (rev 86)
+++ trunk/configure.ac	2005-06-10 03:40:37 UTC (rev 87)
@@ -56,14 +56,6 @@
 fi
 
 # Checks for libraries.
-if test "$want_chatsort" = "yes" -o "$want_roombrowse" = "yes" ; then
-	PKG_CHECK_MODULES([GTK], [$REQUIRED_GTK],
-		[
-		AC_SUBST(GTK_CFLAGS)
-		AC_SUBST(GTK_LIBS)
-		]
-	)
-fi
 PKG_CHECK_MODULES([GAIM], [$REQUIRED_GAIM],
 	[
 	AC_SUBST(GAIM_CFLAGS)
@@ -80,6 +72,14 @@
 GAIM[]_LIBDIR=$pkg_cv_[]GAIM[]_LIBDIR
 AC_SUBST(GAIM_DATADIR)
 AC_SUBST(GAIM_LIBDIR)
+if test "$want_chatsort" = "yes" -o "$want_roombrowse" = "yes" ; then
+	PKG_CHECK_MODULES([GTK], [$REQUIRED_GTK],
+		[
+		AC_SUBST(GTK_CFLAGS)
+		AC_SUBST(GTK_LIBS)
+		]
+	)
+fi
 
 # Checks for header files.
 AC_HEADER_STDC



From deckrider at sheep.berlios.de  Sat Jun 11 14:26:41 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Sat, 11 Jun 2005 14:26:41 +0200
Subject: [Qrc-svn] r89 - trunk/gaym/src
Message-ID: <200506111226.j5BCQf4D002376@sheep.berlios.de>

Author: deckrider
Date: 2005-06-11 14:26:40 +0200 (Sat, 11 Jun 2005)
New Revision: 89

Modified:
   trunk/gaym/src/gaym.c
Log:
Small preference GUI clarification

Modified: trunk/gaym/src/gaym.c
===================================================================
--- trunk/gaym/src/gaym.c	2005-06-11 06:10:37 UTC (rev 88)
+++ trunk/gaym/src/gaym.c	2005-06-11 12:26:40 UTC (rev 89)
@@ -987,7 +987,8 @@
          _("Show bio when entrance messages are shown"));
     gaim_plugin_pref_frame_add(frame, ppref);
 
-    ppref = gaim_plugin_pref_new_with_label(_("Instant Messages"));
+    ppref =
+        gaim_plugin_pref_new_with_label(_("Instant Messages (stricter privacy settings override these)"));
     gaim_plugin_pref_frame_add(frame, ppref);
 
     ppref =



From deckrider at sheep.berlios.de  Sat Jun 11 14:39:17 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Sat, 11 Jun 2005 14:39:17 +0200
Subject: [Qrc-svn] r90 - trunk
Message-ID: <200506111239.j5BCdHv1003190@sheep.berlios.de>

Author: deckrider
Date: 2005-06-11 14:39:16 +0200 (Sat, 11 Jun 2005)
New Revision: 90

Modified:
   trunk/TODO
Log:
Updated TODO with bot-challenge status.

Modified: trunk/TODO
===================================================================
--- trunk/TODO	2005-06-11 12:26:40 UTC (rev 89)
+++ trunk/TODO	2005-06-11 12:39:16 UTC (rev 90)
@@ -3,12 +3,6 @@
 TODO
 ====
 
-- add gaym_bot_check(), patterned similar to gaym_privacy_check() that
-  takes a list of strings/patterns the user can enter in GayM
-  preferences and then looks to see if a match is found in the nick's
-  bio.  If there is, returns TRUE (or FALSE?), if not, then the
-  opposite.
-
 - "Tools | Account Actions | Change Bio" should not obliterate the
   "^AS|A|L" but only the bio string.  Currently, the S|A|L gets
   obliterated which means no one else can see it.
@@ -89,6 +83,15 @@
 DONE
 ====
 
+- NOTE:  This item was found to be ineffective and not committed,
+  instead, a challenge / response system was put in its place.  Add
+  gaym_bot_check(), patterned similar to gaym_privacy_check() that takes
+  a list of strings/patterns the user can enter in GayM preferences and
+  then looks to see if a match is found in the nick's bio.  If there is,
+  returns TRUE (or FALSE?), if not, then the opposite.  NOTE:  This was
+  found to be ineffective and not done, instead, a challenge / response
+  system was put in its place.
+
 - Add windows installer package
 
 - Connect link to web page for report user to Warn button in Gaim



From deckrider at sheep.berlios.de  Sat Jun 11 16:52:56 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Sat, 11 Jun 2005 16:52:56 +0200
Subject: [Qrc-svn] r91 - trunk/gaym/src
Message-ID: <200506111452.j5BEquXu008991@sheep.berlios.de>

Author: deckrider
Date: 2005-06-11 16:52:55 +0200 (Sat, 11 Jun 2005)
New Revision: 91

Modified:
   trunk/gaym/src/gaympriv.c
Log:
Added debug message to show the pending bot challenger queue


Modified: trunk/gaym/src/gaympriv.c
===================================================================
--- trunk/gaym/src/gaympriv.c	2005-06-11 12:39:16 UTC (rev 90)
+++ trunk/gaym/src/gaympriv.c	2005-06-11 14:52:55 UTC (rev 91)
@@ -285,7 +285,13 @@
                 retval = FALSE;
             }
         }
+        for (tmp = challenge_q; tmp; tmp = tmp->next) {
+            char *debug = tmp->data;
+            gaim_debug_info("gaym", "Bot Challenge Queue Item: %s\n",
+                            debug);
+        }
     }
+
     return retval;
 }
 



From deckrider at sheep.berlios.de  Sun Jun 12 06:54:15 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Sun, 12 Jun 2005 06:54:15 +0200
Subject: [Qrc-svn] r93 - trunk/gaym/src
Message-ID: <200506120454.j5C4sFgp001517@sheep.berlios.de>

Author: deckrider
Date: 2005-06-12 06:53:45 +0200 (Sun, 12 Jun 2005)
New Revision: 93

Modified:
   trunk/gaym/src/gaym.c
   trunk/gaym/src/gaympriv.c
Log:
Added ceiling of 10 entries to challenge_q.  Oldest (first) entries will
be the first to be removed to make room for new entries.


Modified: trunk/gaym/src/gaym.c
===================================================================
--- trunk/gaym/src/gaym.c	2005-06-11 21:32:10 UTC (rev 92)
+++ trunk/gaym/src/gaym.c	2005-06-12 04:53:45 UTC (rev 93)
@@ -1097,9 +1097,9 @@
     gaim_prefs_add_bool("/plugins/prpl/gaym/only_buddies_can_im", FALSE);
     gaim_prefs_add_bool("/plugins/prpl/gaym/challenge_enable", FALSE);
     gaim_prefs_add_string("/plugins/prpl/gaym/challenge_question",
-                          "What is the last word in this sentence?");
+                          _("What is the last word in this sentence?"));
     gaim_prefs_add_string("/plugins/prpl/gaym/challenge_answer",
-                          "sentence");
+                          _("sentence"));
 
     _gaym_plugin = plugin;
 

Modified: trunk/gaym/src/gaympriv.c
===================================================================
--- trunk/gaym/src/gaympriv.c	2005-06-11 21:32:10 UTC (rev 92)
+++ trunk/gaym/src/gaympriv.c	2005-06-12 04:53:45 UTC (rev 93)
@@ -244,8 +244,10 @@
         args[0] = nick;
         gboolean found = FALSE;
         GList *tmp;
+        gint pos = -1;
         for (tmp = challenge_q; tmp; tmp = tmp->next) {
             char *q_nick = tmp->data;
+            pos = g_list_position(challenge_q, tmp);
             if (!gaim_utf8_strcasecmp(nick, q_nick)) {
                 found = TRUE;
                 break;
@@ -256,6 +258,14 @@
              * its the first time through, save the nick/msg to the
              * queue and ask the question
              */
+            if (pos == 19) {    /* don't track more than 10 pending */
+                challenge_q =
+                    g_list_remove(challenge_q,
+                                  g_list_nth_data(challenge_q, 0));
+                challenge_q =
+                    g_list_remove(challenge_q,
+                                  g_list_nth_data(challenge_q, 0));
+            }
             challenge_q = g_list_append(challenge_q, g_strdup(nick));
             challenge_q = g_list_append(challenge_q, g_strdup(msg));
             args[1] = _("GayM Bot Challenger requires a correct answer:");



From deckrider at sheep.berlios.de  Sun Jun 12 16:54:30 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Sun, 12 Jun 2005 16:54:30 +0200
Subject: [Qrc-svn] r94 - trunk
Message-ID: <200506121454.j5CEsUot015423@sheep.berlios.de>

Author: deckrider
Date: 2005-06-12 16:54:29 +0200 (Sun, 12 Jun 2005)
New Revision: 94

Modified:
   trunk/configure.ac
Log:
Updates to configure.ac to require pkg-config 0.17.2

Modified: trunk/configure.ac
===================================================================
--- trunk/configure.ac	2005-06-12 04:53:45 UTC (rev 93)
+++ trunk/configure.ac	2005-06-12 14:54:29 UTC (rev 94)
@@ -6,6 +6,9 @@
 AC_CANONICAL_SYSTEM
 AM_INIT_AUTOMAKE([1.9.5])
 
+REQUIRED_PKG_CONFIG="0.17.2"
+AC_SUBST(REQUIRED_PKG_CONFIG)
+
 REQUIRED_GAIM="gaim >= 1.2 gaim < 2.0"
 AC_SUBST(REQUIRED_GAIM)
 
@@ -24,7 +27,12 @@
 AC_PROG_LIBTOOL
 LIBTOOL="$LIBTOOL --silent"
 AC_PROG_INSTALL
+AC_PATH_PROG(PKG_CONFIG, [pkg-config], [no])
 
+if test x$PKG_CONFIG = xno ; then
+  AC_MSG_ERROR([*** pkg-config not found])
+fi
+
 # Build preferences
 AC_ARG_ENABLE([chatsort],AC_HELP_STRING([--enable-chatsort],[build the chatsort plugin @<:@default=no@:>@]),[want_chatsort="yes"],)
 
@@ -56,6 +64,15 @@
 fi
 
 # Checks for libraries.
+PKG_PROG_PKG_CONFIG([$REQUIRED_PKG_CONFIG])
+if test "$want_chatsort" = "yes" -o "$want_roombrowse" = "yes" ; then
+	PKG_CHECK_MODULES([GTK], [$REQUIRED_GTK],
+		[
+		AC_SUBST(GTK_CFLAGS)
+		AC_SUBST(GTK_LIBS)
+		]
+	)
+fi
 PKG_CHECK_MODULES([GAIM], [$REQUIRED_GAIM],
 	[
 	AC_SUBST(GAIM_CFLAGS)
@@ -72,14 +89,6 @@
 GAIM[]_LIBDIR=$pkg_cv_[]GAIM[]_LIBDIR
 AC_SUBST(GAIM_DATADIR)
 AC_SUBST(GAIM_LIBDIR)
-if test "$want_chatsort" = "yes" -o "$want_roombrowse" = "yes" ; then
-	PKG_CHECK_MODULES([GTK], [$REQUIRED_GTK],
-		[
-		AC_SUBST(GTK_CFLAGS)
-		AC_SUBST(GTK_LIBS)
-		]
-	)
-fi
 
 # Checks for header files.
 AC_HEADER_STDC



From deckrider at sheep.berlios.de  Sun Jun 12 19:17:28 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Sun, 12 Jun 2005 19:17:28 +0200
Subject: [Qrc-svn] r95 - trunk
Message-ID: <200506121717.j5CHHSu9019336@sheep.berlios.de>

Author: deckrider
Date: 2005-06-12 19:17:20 +0200 (Sun, 12 Jun 2005)
New Revision: 95

Modified:
   trunk/configure.ac
Log:
Fixed configure defaults and options

Modified: trunk/configure.ac
===================================================================
--- trunk/configure.ac	2005-06-12 14:54:29 UTC (rev 94)
+++ trunk/configure.ac	2005-06-12 17:17:20 UTC (rev 95)
@@ -34,38 +34,50 @@
 fi
 
 # Build preferences
-AC_ARG_ENABLE([chatsort],AC_HELP_STRING([--enable-chatsort],[build the chatsort plugin @<:@default=no@:>@]),[want_chatsort="yes"],)
+AC_ARG_ENABLE([chatsort],
+	[AC_HELP_STRING([--enable-chatsort],
+		[build the chatsort plugin @<:@default=no@:>@])],,
+	[enable_chatsort="no"])
 
-AC_ARG_ENABLE([gaym],AC_HELP_STRING([--enable-gaym],[build the gaym plugin @<:@default=yes@:>@]),,[want_gaym="yes"])
+AC_ARG_ENABLE([gaym],
+	[AC_HELP_STRING([--enable-gaym],
+		[build the gaym plugin @<:@default=yes@:>@])],,
+	[enable_gaym="yes"])
 
-AC_ARG_ENABLE([privacy],AC_HELP_STRING([--enable-privacy],[build the privacy plugin @<:@default=no@:>@]),[want_privacy="yes"],)
+AC_ARG_ENABLE([privacy],
+	[AC_HELP_STRING([--enable-privacy],
+		[build the privacy plugin @<:@default=no@:>@])],,
+	[enable_privacy="no"])
 
-AC_ARG_ENABLE([roombrowse],AC_HELP_STRING([--enable-roombrowse],[build the roombrowse plugin @<:@default=no@:>@]),[want_roombrowse="yes"],)
+AC_ARG_ENABLE([roombrowse],
+	[AC_HELP_STRING([--enable-roombrowse],
+		[build the roombrowse plugin @<:@default=no@:>@])],,
+	[enable_roombrowse="no"])
 
-AM_CONDITIONAL([COND_CHATSORT], [test "$want_chatsort" = "yes"])
-AM_CONDITIONAL([COND_GAYM], [test "$want_gaym" = "yes"])
-AM_CONDITIONAL([COND_PRIVACY], [test "$want_privacy" = "yes"])
-AM_CONDITIONAL([COND_ROOMBROWSE], [test "$want_roombrowse" = "yes"])
+AM_CONDITIONAL([COND_CHATSORT], [test "$enable_chatsort" = "yes"])
+AM_CONDITIONAL([COND_GAYM], [test "$enable_gaym" = "yes"])
+AM_CONDITIONAL([COND_PRIVACY], [test "$enable_privacy" = "yes"])
+AM_CONDITIONAL([COND_ROOMBROWSE], [test "$enable_roombrowse" = "yes"])
 
-if test "$want_chatsort" != "yes" ; then
-	want_chatsort="no"
+if test "$enable_chatsort" != "yes" ; then
+	enable_chatsort="no"
 fi
 
-if test "$want_gaym" != "yes" ; then
-	want_gaym="no"
+if test "$enable_gaym" != "yes" ; then
+	enable_gaym="no"
 fi
 
-if test "$want_privacy" != "yes" ; then
-	want_privacy="no"
+if test "$enable_privacy" != "yes" ; then
+	enable_privacy="no"
 fi
 
-if test "$want_roombrowse" != "yes" ; then
-	want_roombrowse="no"
+if test "$enable_roombrowse" != "yes" ; then
+	enable_roombrowse="no"
 fi
 
 # Checks for libraries.
 PKG_PROG_PKG_CONFIG([$REQUIRED_PKG_CONFIG])
-if test "$want_chatsort" = "yes" -o "$want_roombrowse" = "yes" ; then
+if test "$enable_chatsort" = "yes" -o "$enable_roombrowse" = "yes" ; then
 	PKG_CHECK_MODULES([GTK], [$REQUIRED_GTK],
 		[
 		AC_SUBST(GTK_CFLAGS)
@@ -130,10 +142,10 @@
 echo
 echo $PACKAGE $VERSION
 echo
-echo Build chatsort plugin............ : $want_chatsort
-echo Build gaym plugin................ : $want_gaym
-echo Build privacy plugin............. : $want_privacy
-echo Build roombrowse plugin.......... : $want_roombrowse
+echo Build chatsort plugin............ : $enable_chatsort
+echo Build gaym plugin................ : $enable_gaym
+echo Build privacy plugin............. : $enable_privacy
+echo Build roombrowse plugin.......... : $enable_roombrowse
 echo
 echo Installation directory........... : $GAIM_LIBDIR/gaim
 echo



From deckrider at sheep.berlios.de  Sun Jun 12 22:01:00 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Sun, 12 Jun 2005 22:01:00 +0200
Subject: [Qrc-svn] r96 - trunk
Message-ID: <200506122001.j5CK1096027752@sheep.berlios.de>

Author: deckrider
Date: 2005-06-12 22:00:59 +0200 (Sun, 12 Jun 2005)
New Revision: 96

Removed:
   trunk/autogen.sh
Log:
Removing autogen.sh; use 'autoreconf --force --install --install --symlink' instead.

Deleted: trunk/autogen.sh
===================================================================
--- trunk/autogen.sh	2005-06-12 17:17:20 UTC (rev 95)
+++ trunk/autogen.sh	2005-06-12 20:00:59 UTC (rev 96)
@@ -1,74 +0,0 @@
-#!/bin/sh
-
-# Run this when building from subversion.  Don't commit
-# any of the files it generates.
-
-#
-# Require libtool, automake, and autoconf
-#
-(libtoolize --version) < /dev/null > /dev/null 2>&1 || {
-	echo;
-	echo "You must have libtool installed to compile the QRC Plugins.";
-	echo;
-	exit;
-}
-
-(automake --version) < /dev/null > /dev/null 2>&1 || {
-	echo;
-	echo "You must have automake installed to compile the QRC plugins.";
-	echo;
-	exit;
-}
-
-(autoconf --version) < /dev/null > /dev/null 2>&1 || {
-	echo;
-	echo "You must have autoconf installed to compile the QRC plugins.";
-	echo;
-	exit;
-}
-
-echo;
-echo "Generating configuration files for the QRC plugins, please wait...."
-
-echo;
-echo "Running libtoolize, please ignore non-fatal messages...."
-echo;
-libtoolize --force || exit;
-
-#
-# Account for odd location of macros
-#
-for dir in "/usr/local/share/aclocal" \
-	"/opt/gnome-1.4/share/aclocal" \
-	"/sw/share/aclocal"
-do
-	if test -d $dir ; then
-		ACLOCAL_FLAGS="$ACLOCAL_FLAGS -I $dir"
-	fi
-done
-
-echo;
-echo "Running aclocal...."
-echo;
-aclocal $ACLOCAL_FLAGS || exit;
-
-echo;
-echo "Running autoheader...."
-echo;
-autoheader --force || exit;
-
-echo;
-echo "Running automake...."
-echo;
-automake --force-missing --add-missing || exit;
-
-echo;
-echo "Running autoconf...."
-echo;
-autoconf --force || exit;
-
-echo;
-echo "Finished generating configuration files for the QRC plugins."
-echo "Now you may run './configure'."
-echo;
-



From deckrider at sheep.berlios.de  Sun Jun 12 22:02:15 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Sun, 12 Jun 2005 22:02:15 +0200
Subject: [Qrc-svn] r97 - trunk
Message-ID: <200506122002.j5CK2FJ9027856@sheep.berlios.de>

Author: deckrider
Date: 2005-06-12 22:02:14 +0200 (Sun, 12 Jun 2005)
New Revision: 97

Modified:
   trunk/configure.ac
Log:
Updating configure.ac for latest syntax and obsolete macros on autoupdate.

Modified: trunk/configure.ac
===================================================================
--- trunk/configure.ac	2005-06-12 20:00:59 UTC (rev 96)
+++ trunk/configure.ac	2005-06-12 20:02:14 UTC (rev 97)
@@ -1,9 +1,9 @@
 #                                               -*- Autoconf -*-
 # Process this file with autoconf to produce a configure script.
 
-AC_PREREQ([2.59])
+AC_PREREQ(2.59)
 AC_INIT([qrc],[0.33.0+svn],[gaymplugin at yahoogroups.com])
-AC_CANONICAL_SYSTEM
+AC_CANONICAL_TARGET([])
 AM_INIT_AUTOMAKE([1.9.5])
 
 REQUIRED_PKG_CONFIG="0.17.2"
@@ -35,23 +35,19 @@
 
 # Build preferences
 AC_ARG_ENABLE([chatsort],
-	[AC_HELP_STRING([--enable-chatsort],
-		[build the chatsort plugin @<:@default=no@:>@])],,
+	[AS_HELP_STRING(--enable-chatsort,build the chatsort plugin @<:@default=no@:>@)],,
 	[enable_chatsort="no"])
 
 AC_ARG_ENABLE([gaym],
-	[AC_HELP_STRING([--enable-gaym],
-		[build the gaym plugin @<:@default=yes@:>@])],,
+	[AS_HELP_STRING(--enable-gaym,build the gaym plugin @<:@default=yes@:>@)],,
 	[enable_gaym="yes"])
 
 AC_ARG_ENABLE([privacy],
-	[AC_HELP_STRING([--enable-privacy],
-		[build the privacy plugin @<:@default=no@:>@])],,
+	[AS_HELP_STRING(--enable-privacy,build the privacy plugin @<:@default=no@:>@)],,
 	[enable_privacy="no"])
 
 AC_ARG_ENABLE([roombrowse],
-	[AC_HELP_STRING([--enable-roombrowse],
-		[build the roombrowse plugin @<:@default=no@:>@])],,
+	[AS_HELP_STRING(--enable-roombrowse,build the roombrowse plugin @<:@default=no@:>@)],,
 	[enable_roombrowse="no"])
 
 AM_CONDITIONAL([COND_CHATSORT], [test "$enable_chatsort" = "yes"])



From deckrider at sheep.berlios.de  Sun Jun 12 22:03:08 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Sun, 12 Jun 2005 22:03:08 +0200
Subject: [Qrc-svn] r98 - trunk
Message-ID: <200506122003.j5CK38ZW027935@sheep.berlios.de>

Author: deckrider
Date: 2005-06-12 22:03:07 +0200 (Sun, 12 Jun 2005)
New Revision: 98

Modified:
   trunk/README
Log:
Updated README to compensate for the removal of autogen.sh

Modified: trunk/README
===================================================================
--- trunk/README	2005-06-12 20:02:14 UTC (rev 97)
+++ trunk/README	2005-06-12 20:03:07 UTC (rev 98)
@@ -1,7 +1,9 @@
-This file should document many things, but for now it is:
+When using subversion, before running ./configure, run:
 
-An explanation of privacy settings as implemented in GayM.
+   autoreconf --force --install --symlink 
 
+An explanation of privacy settings as implemented in GayM:
+
 Gaim Privacy Setting Options (only one of the following may be selected):
 
    Tools->Privacy->Allow all users to contact me



From deckrider at sheep.berlios.de  Mon Jun 13 00:28:49 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Mon, 13 Jun 2005 00:28:49 +0200
Subject: [Qrc-svn] r99 - trunk/gaym/src
Message-ID: <200506122228.j5CMSn5W004682@sheep.berlios.de>

Author: deckrider
Date: 2005-06-13 00:28:48 +0200 (Mon, 13 Jun 2005)
New Revision: 99

Modified:
   trunk/gaym/src/gaympriv.c
Log:
Fixed Bot Challenger memory leaks and changed to only asking the
once.


Modified: trunk/gaym/src/gaympriv.c
===================================================================
--- trunk/gaym/src/gaympriv.c	2005-06-12 20:03:07 UTC (rev 98)
+++ trunk/gaym/src/gaympriv.c	2005-06-12 22:28:48 UTC (rev 99)
@@ -259,39 +259,47 @@
              * queue and ask the question
              */
             if (pos == 19) {    /* don't track more than 10 pending */
+                g_free(g_list_nth_data(challenge_q, 0));
                 challenge_q =
-                    g_list_remove(challenge_q,
-                                  g_list_nth_data(challenge_q, 0));
+                    g_list_remove_link(challenge_q,
+                                       g_list_nth(challenge_q, 0));
+
+                g_free(g_list_nth_data(challenge_q, 0));
                 challenge_q =
-                    g_list_remove(challenge_q,
-                                  g_list_nth_data(challenge_q, 0));
+                    g_list_remove_link(challenge_q,
+                                       g_list_nth(challenge_q, 0));
             }
             challenge_q = g_list_append(challenge_q, g_strdup(nick));
             challenge_q = g_list_append(challenge_q, g_strdup(msg));
-            args[1] = _("GayM Bot Challenger requires a correct answer:");
+            args[1] =
+                g_strdup_printf(_
+                                ("GayM Bot Challenger engaged!  You are now on auto-ignore until you provide the correct answer:  %s"),
+                                question);
             gaym_cmd_privmsg(gc->proto_data, "msg", NULL, args);
-            args[1] = question;
-            gaym_cmd_privmsg(gc->proto_data, "msg", NULL, args);
+            g_free((gpointer) args[1]);
             retval = FALSE;
         } else {
             if (gaim_utf8_strcasecmp(msg, answer)) {
                 /**
                  * Sorry, thanks for playing, please try again
                  */
-                args[1] = question;
-                gaym_cmd_privmsg(gc->proto_data, "msg", NULL, args);
                 retval = FALSE;
             } else {
-                args[1] = _("Your answer was accepted");
+                args[1] =
+                    _
+                    ("Bot Challenger accepted your answer and delivered your original message.  You may now speak freely.");
                 gaym_cmd_privmsg(gc->proto_data, "msg", NULL, args);
 
                 GList *next = tmp->next;
                 char *q_msg = next->data;
                 serv_got_im(gc, nick, q_msg, 0, time(NULL));
 
-                challenge_q = g_list_remove(challenge_q, next->data);
-                challenge_q = g_list_remove(challenge_q, tmp->data);
+                g_free(next->data);
+                g_free(tmp->data);
 
+                challenge_q = g_list_remove_link(challenge_q, next);
+                challenge_q = g_list_remove_link(challenge_q, tmp);
+
                 retval = FALSE;
             }
         }



From deckrider at sheep.berlios.de  Mon Jun 13 14:50:34 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Mon, 13 Jun 2005 14:50:34 +0200
Subject: [Qrc-svn] r100 - trunk
Message-ID: <200506131250.j5DCoYTa011138@sheep.berlios.de>

Author: deckrider
Date: 2005-06-13 14:50:33 +0200 (Mon, 13 Jun 2005)
New Revision: 100

Modified:
   trunk/configure.ac
Log:
Accept pkg-config 0.15, but only for source packages.  Subversion
hacking still requires 0.17.


Modified: trunk/configure.ac
===================================================================
--- trunk/configure.ac	2005-06-12 22:28:48 UTC (rev 99)
+++ trunk/configure.ac	2005-06-13 12:50:33 UTC (rev 100)
@@ -6,7 +6,7 @@
 AC_CANONICAL_TARGET([])
 AM_INIT_AUTOMAKE([1.9.5])
 
-REQUIRED_PKG_CONFIG="0.17.2"
+REQUIRED_PKG_CONFIG="0.15.0"
 AC_SUBST(REQUIRED_PKG_CONFIG)
 
 REQUIRED_GAIM="gaim >= 1.2 gaim < 2.0"



From deckrider at sheep.berlios.de  Mon Jun 13 15:58:34 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Mon, 13 Jun 2005 15:58:34 +0200
Subject: [Qrc-svn] r101 - trunk
Message-ID: <200506131358.j5DDwYSj017911@sheep.berlios.de>

Author: deckrider
Date: 2005-06-13 15:58:33 +0200 (Mon, 13 Jun 2005)
New Revision: 101

Added:
   trunk/README.svn
Modified:
   trunk/README
Log:
Added README.svn to document how to hack with subversion.  It is not
included in the source package, since the information is specific to
working with qrc from subversion.



Modified: trunk/README
===================================================================
--- trunk/README	2005-06-13 12:50:33 UTC (rev 100)
+++ trunk/README	2005-06-13 13:58:33 UTC (rev 101)
@@ -1,7 +1,3 @@
-When using subversion, before running ./configure, run:
-
-   autoreconf --force --install --symlink 
-
 An explanation of privacy settings as implemented in GayM:
 
 Gaim Privacy Setting Options (only one of the following may be selected):

Added: trunk/README.svn
===================================================================
--- trunk/README.svn	2005-06-13 12:50:33 UTC (rev 100)
+++ trunk/README.svn	2005-06-13 13:58:33 UTC (rev 101)
@@ -0,0 +1,19 @@
+When using subversion, there is no configure script, so you have to
+generate one (as well as many other generated files you need):
+
+   autoreconf --force --install --symlink 
+
+You may need other options, based on the layout of your environment.
+Read the manual or run:
+
+   autoreconf --help
+
+Doing the above requires special versions of software, some of which is
+not needed if you use a normal source package (qrc.x.y.z.tar.gz):
+
+   autoconf   2.59a  (not needed by source packages)
+   automake   1.9.5  (not needed by source packages)
+   libtool    1.5.6  (not needed by source packages)
+   pkg-config 0.17.2 (source packages may use pkg-config >= 0.15.0)
+
+# this README.svn should not be included in the source package



From deckrider at sheep.berlios.de  Tue Jun 14 15:01:30 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Tue, 14 Jun 2005 15:01:30 +0200
Subject: [Qrc-svn] r107 - trunk/nsis/locale
Message-ID: <200506141301.j5ED1UYV013772@sheep.berlios.de>

Author: deckrider
Date: 2005-06-14 15:01:29 +0200 (Tue, 14 Jun 2005)
New Revision: 107

Modified:
   trunk/nsis/locale/english.nsh
Log:
Small wording corrections.

Modified: trunk/nsis/locale/english.nsh
===================================================================
--- trunk/nsis/locale/english.nsh	2005-06-14 03:09:04 UTC (rev 106)
+++ trunk/nsis/locale/english.nsh	2005-06-14 13:01:29 UTC (rev 107)
@@ -19,21 +19,21 @@
 ; Overrides for default text in windows:
 
 LangString WELCOME_TITLE ${LANG_ENGLISH} "Gaim-QRC v${QRC_VERSION} Installer"
-LangString WELCOME_TEXT  ${LANG_ENGLISH} "Note: This version of the plugin is designed for Gaim ${GAIM_VERSION}, and will not install or function with other versions of Gaim.\r\n\r\nWhen you upgrade your version of Gaim, you must uninstall or upgrade this plugin as well.\r\n\r\n"
+LangString WELCOME_TEXT  ${LANG_ENGLISH} "Note: These plugins are designed for Gaim ${GAIM_VERSION}, and will not install or function with other versions of Gaim.\r\n\r\nWhen you upgrade your version of Gaim, you must uninstall or upgrade this plugin as well.\r\n\r\n"
 
 LangString DIR_SUBTITLE ${LANG_ENGLISH} "Please locate the directory where Gaim is installed"
 LangString DIR_INNERTEXT ${LANG_ENGLISH} "Install in this Gaim folder:"
 
 LangString FINISH_TITLE ${LANG_ENGLISH} "Gaim-QRC v${QRC_VERSION} Install Complete"
-LangString FINISH_TEXT ${LANG_ENGLISH} "You will need to restart Gaim for the plugin to be loaded."
+LangString FINISH_TEXT ${LANG_ENGLISH} "You will need to restart Gaim for the plugins to be loaded."
 
 ; during install uninstaller
 LangString QRC_PROMPT_WIPEOUT ${LANG_ENGLISH} "The QRC plugins are about to be deleted from your Gaim/plugins directory.  Continue?"
 
 ; for windows uninstall
 LangString QRC_UNINSTALL_DESC ${LANG_ENGLISH} "Gaim-QRC Plugins (remove only)"
-LangString un.QRC_UNINSTALL_ERROR_1 ${LANG_ENGLISH} "The uninstaller could not find registry entries for Gaim-QRC.$\rIt is likely that another user installed the plugin."
-LangString un.QRC_UNINSTALL_ERROR_2 ${LANG_ENGLISH} "You do not have the permissions necessary to uninstall the plugin."
+LangString un.QRC_UNINSTALL_ERROR_1 ${LANG_ENGLISH} "The uninstaller could not find registry entries for Gaim-QRC.$\rIt is likely that another user installed the plugins."
+LangString un.QRC_UNINSTALL_ERROR_2 ${LANG_ENGLISH} "You do not have the permissions necessary to uninstall the plugins."
 
 
 



From deckrider at sheep.berlios.de  Wed Jun 15 06:20:01 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Wed, 15 Jun 2005 06:20:01 +0200
Subject: [Qrc-svn] r108 - trunk/gaym/src
Message-ID: <200506150420.j5F4K11I011009@sheep.berlios.de>

Author: deckrider
Date: 2005-06-15 06:20:00 +0200 (Wed, 15 Jun 2005)
New Revision: 108

Modified:
   trunk/gaym/src/msgs.c
Log:
Fixed problem of looping too far through the nicks in
gaym_msg_ison().


Modified: trunk/gaym/src/msgs.c
===================================================================
--- trunk/gaym/src/msgs.c	2005-06-14 13:01:29 UTC (rev 107)
+++ trunk/gaym/src/msgs.c	2005-06-15 04:20:00 UTC (rev 108)
@@ -946,7 +946,7 @@
     if (!args || !args[1])
         return;
     nicks = g_strsplit(args[1], " ", -1);
-    for (i = 0; nicks[i]; i++) {
+    for (i = 0; (nicks[i] != NULL) && (*nicks[i] != '\0'); i++) {
         convert_nick_from_gaycom(nicks[i]);
         if ((ib =
              g_hash_table_lookup(gaym->buddies,



From deckrider at sheep.berlios.de  Thu Jun 16 05:41:56 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Thu, 16 Jun 2005 05:41:56 +0200
Subject: [Qrc-svn] r109 - trunk/bot-challenger
Message-ID: <200506160341.j5G3fuXj016442@sheep.berlios.de>

Author: deckrider
Date: 2005-06-16 05:41:44 +0200 (Thu, 16 Jun 2005)
New Revision: 109

Modified:
   trunk/bot-challenger/bot-challenger.c
Log:
Added more comments and conformed to gaim plugin naming standards.


Modified: trunk/bot-challenger/bot-challenger.c
===================================================================
--- trunk/bot-challenger/bot-challenger.c	2005-06-15 04:20:00 UTC (rev 108)
+++ trunk/bot-challenger/bot-challenger.c	2005-06-16 03:41:44 UTC (rev 109)
@@ -28,29 +28,36 @@
 /* system headers */
 #include <glib.h>
 
-/* gaim headers */
-#include "gaim.h"
-#include "internal.h"
-#include "conversation.h"
+/* gaim headers for most plugins */
+#include "plugin.h"
+#include "version.h"
+
+/* gaim headers for this plugin */
+#include "util.h"
 #include "debug.h"
-#include "pluginpref.h"
-#include "prefs.h"
-#include "util.h"
-#include "version.h"
 #include "account.h"
 #include "privacy.h"
 
+/* gaim header needed for gettext */
+#include "internal.h"
+
+/**
+ * Declare the list of struct that is used to store the first
+ * message that a member sends for later delivery if he meets
+ * the challenge.
+ */
 typedef struct _PendingMessage PendingMessage;
-
 struct _PendingMessage {
     char *protocol;
     char *username;
     char *sender;
     char *message;
 };
-
 static GSList *pending_list = NULL;     /* GSList of PendingMessage */
 
+/**
+ * Return TRUE if the protocols match
+ */
 gboolean protocmp(GaimAccount * account, const PendingMessage * pending)
 {
     if (!gaim_utf8_strcasecmp(pending->username, account->username)) {
@@ -60,6 +67,9 @@
     }
 }
 
+/**
+ * Return TRUE if the accounts match
+ */
 gboolean usercmp(GaimAccount * account, const PendingMessage * pending)
 {
     if (!gaim_utf8_strcasecmp(pending->username, account->username)) {
@@ -69,6 +79,9 @@
     }
 }
 
+/**
+ * Return TRUE if the member names match
+ */
 gboolean sendercmp(const char *sender, const PendingMessage * pending)
 {
     if (!gaim_utf8_strcasecmp(pending->sender, sender)) {
@@ -78,6 +91,9 @@
     }
 }
 
+/**
+ * Print the contents of pending_list to the debug log
+ */
 void debug_pending_list()
 {
     GSList *search = NULL;
@@ -90,7 +106,9 @@
     }
 }
 
-/* thanks to the gaim-otr plugin */
+/**
+ * Send an IM to the recipient (thanks to the gaim-otr plugin)
+ */
 void inject_message(GaimAccount * account, const char *recipient,
                     const char *message)
 {
@@ -115,7 +133,11 @@
     serv_send_im(connection, recipient, message, 0);
 }
 
-/* return TRUE to block the IM, FALSE to accept the IM */
+/**
+ * This is our callback for the receiving-im-msg signal.
+ *
+ * We return TRUE to block the IM, FALSE to accept the IM
+ */
 static gboolean receiving_im_msg_cb(GaimAccount * account, char **sender,
                                     char **buffer, int *flags, void *data)
 {
@@ -158,9 +180,9 @@
 
     /* if there is no question or no answer, allowe the sender */
     const char *question =
-        gaim_prefs_get_string("/plugins/bot/challenger/question");
+        gaim_prefs_get_string("/plugins/core/bot/challenger/question");
     const char *answer =
-        gaim_prefs_get_string("/plugins/bot/challenger/answer");
+        gaim_prefs_get_string("/plugins/core/bot/challenger/answer");
     if (!question || !answer) {
         return retval;
     }
@@ -234,7 +256,7 @@
             inject_message(account, *sender, botmsg);
 
             if (gaim_prefs_get_bool
-                ("/plugins/bot/challenger/auto_add_permit")) {
+                ("/plugins/core/bot/challenger/auto_add_permit")) {
                 if (!gaim_privacy_permit_add(account, *sender, FALSE)) {
                     gaim_debug_info("bot-challenger",
                                     "Unable to add %s/%s/%s to permit list\n",
@@ -277,12 +299,12 @@
 
     ppref =
         gaim_plugin_pref_new_with_name_and_label
-        ("/plugins/bot/challenger/question", _("Question"));
+        ("/plugins/core/bot/challenger/question", _("Question"));
     gaim_plugin_pref_frame_add(frame, ppref);
 
     ppref =
         gaim_plugin_pref_new_with_name_and_label
-        ("/plugins/bot/challenger/answer", _("Answer"));
+        ("/plugins/core/bot/challenger/answer", _("Answer"));
     gaim_plugin_pref_frame_add(frame, ppref);
 
     ppref =
@@ -292,7 +314,7 @@
 
     ppref =
         gaim_plugin_pref_new_with_name_and_label
-        ("/plugins/bot/challenger/auto_add_permit",
+        ("/plugins/core/bot/challenger/auto_add_permit",
          _("Add this person to your Permit List"));
     gaim_plugin_pref_frame_add(frame, ppref);
 
@@ -307,14 +329,17 @@
 {
     void *conv_handle = gaim_conversations_get_handle();
 
-    gaim_prefs_add_none("/plugins/bot");
-    gaim_prefs_add_none("/plugins/bot/challenger");
+    gaim_prefs_add_none("/plugins");
+    gaim_prefs_add_none("/plugins/core");
+    gaim_prefs_add_none("/plugins/core/bot");
+    gaim_prefs_add_none("/plugins/core/bot/challenger");
 
-    gaim_prefs_add_string("/plugins/bot/challenger/question",
+    gaim_prefs_add_string("/plugins/core/bot/challenger/question",
                           _("How do you spell the number 10?"));
-    gaim_prefs_add_string("/plugins/bot/challenger/answer", _("ten"));
+    gaim_prefs_add_string("/plugins/core/bot/challenger/answer", _("ten"));
 
-    gaim_prefs_add_bool("/plugins/bot/challenger/auto_add_permit", FALSE);
+    gaim_prefs_add_bool("/plugins/core/bot/challenger/auto_add_permit",
+                        FALSE);
 
     gaim_signal_connect(conv_handle, "receiving-im-msg",
                         plugin, GAIM_CALLBACK(receiving_im_msg_cb), NULL);
@@ -332,7 +357,7 @@
     NULL,                                                 /**< dependencies   */
     GAIM_PRIORITY_DEFAULT,                                /**< priority       */
 
-    N_("bot-challenger"),                                 /**< id             */
+    N_("core-bot_challenger"),                            /**< id             */
     N_("Bot Challenger"),                                 /**< name           */
     VERSION,                                              /**< version        */
                                                           /**  summary        */
@@ -357,7 +382,7 @@
     return;
 }
 
-GAIM_INIT_PLUGIN(bot - challenger, init_plugin, info)
+GAIM_INIT_PLUGIN(bot_challenger, init_plugin, info)
 
 /**
  * vim:tabstop=4:shiftwidth=4:expandtab:



From deckrider at sheep.berlios.de  Thu Jun 16 17:03:23 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Thu, 16 Jun 2005 17:03:23 +0200
Subject: [Qrc-svn] r110 - trunk/gaym/src
Message-ID: <200506161503.j5GF3N7k021439@sheep.berlios.de>

Author: deckrider
Date: 2005-06-16 17:03:22 +0200 (Thu, 16 Jun 2005)
New Revision: 110

Modified:
   trunk/gaym/src/gaym.c
   trunk/gaym/src/gaympriv.c
   trunk/gaym/src/gaympriv.h
Log:
Removed forward declaration of gaym_cmd_privmsg() since it is no longer
needed.

Tools->Privacy now adds the name to the server's deny list when that
name is added to Gaim's deny list.  It also removes the name from the
server's deny list when that name is removed from Gaim's deny list.


Modified: trunk/gaym/src/gaym.c
===================================================================
--- trunk/gaym/src/gaym.c	2005-06-16 03:41:44 UTC (rev 109)
+++ trunk/gaym/src/gaym.c	2005-06-16 15:03:22 UTC (rev 110)
@@ -622,28 +622,13 @@
 
 static void gaym_add_deny(GaimConnection * gc, const char *name)
 {
-    /**
-     * FIXME: add code here to store this setting on gay.com
-     * 
-     * The way to store it is by doing a GET on www.gay.com to
-     * /messenger/lists.txt?name=NICK_TO_BLOCK
-     * &key=BIG_STRING_THAT_WAS_USED_TO_RETRIEVE_CONFIG_TXT
-     * &list=ignore&op=add
-     * 
-     * If successful, the following is returned:
-     * 
-     * success=1
-     * status=ok
-     * list=ignore
-     * command=add
-     */
-
     if (!gaym_nick_check(name)) {
         gaim_privacy_deny_remove(gc->account, name, TRUE);
         gaim_notify_error(gc, _("Invalid User Name"), name,
                           _("Invalid user name not added."));
         return;
     }
+    gaym_server_store_deny(gc, name, TRUE);
     gaym_privacy_change(gc, name);
 }
 
@@ -654,22 +639,7 @@
 
 static void gaym_rem_deny(GaimConnection * gc, const char *name)
 {
-    /**
-     * FIXME: add code here to store this setting on gay.com
-     * 
-     * The way to store it is by doing a GET on www.gay.com to
-     * /messenger/lists.txt?name=NICK_TO_BLOCK
-     * &key=BIG_STRING_THAT_WAS_USED_TO_RETRIEVE_CONFIG_TXT
-     * &list=ignore&op=remove
-     * 
-     * If successful, the following is returned:
-     * 
-     * success=1
-     * status=ok
-     * list=ignore
-     * command=remove
-     */
-
+    gaym_server_store_deny(gc, name, FALSE);
     gaym_privacy_change(gc, name);
 }
 

Modified: trunk/gaym/src/gaympriv.c
===================================================================
--- trunk/gaym/src/gaympriv.c	2005-06-16 03:41:44 UTC (rev 109)
+++ trunk/gaym/src/gaympriv.c	2005-06-16 15:03:22 UTC (rev 110)
@@ -27,14 +27,6 @@
 #include "gaympriv.h"
 #include "gaym.h"
 
-/**
- * Function we need from cmds.c, but if we make cmds.h, there is
- * a clash with cmds.h that is in gaim.  FIXME
- */
-
-int gaym_cmd_privmsg(struct gaym_conn *gaym, const char *cmd,
-                     const char *target, const char **args);
-
 int gaym_ignore_joining_leaving(GaimConversation * conv, char *name)
 {
     GaimConnection *gc = gaim_conversation_get_gc(conv);
@@ -219,6 +211,42 @@
     return retval;
 }
 
+void gaym_server_change_deny_status_cb(void *data, const char *result,
+                                       size_t len)
+{
+    gaim_debug_info("gaym", "gaym_server_change_deny_status_cb:\n%s\n",
+                    result);
+    return;
+}
+
+void gaym_server_store_deny(GaimConnection * gc, const char *name,
+                            gboolean add)
+{
+    char *action = NULL;
+    if (add) {
+        action = "add";
+    } else {
+        action = "remove";
+    }
+
+    struct gaym_conn *gaym = gc->proto_data;
+    const char *server =
+        gaim_account_get_string(gc->account, "server", IRC_DEFAULT_SERVER);
+
+    char *url =
+        g_strdup_printf
+        ("http://%s/messenger/lists.txt?name=%s&key=%s&list=ignore&op=%s",
+         server, name, gaym->hash_pw, action);
+
+    char *user_agent = "Mozilla/4.0";
+
+    gaim_url_fetch(url, FALSE, user_agent, FALSE,
+                   gaym_server_change_deny_status_cb, NULL);
+
+    g_free(url);
+    return;
+}
+
 /**
  * vim:tabstop=4:shiftwidth=4:expandtab:
  */

Modified: trunk/gaym/src/gaympriv.h
===================================================================
--- trunk/gaym/src/gaympriv.h	2005-06-16 03:41:44 UTC (rev 109)
+++ trunk/gaym/src/gaympriv.h	2005-06-16 15:03:22 UTC (rev 110)
@@ -73,6 +73,28 @@
 gboolean gaym_im_check(GaimConnection * gc, const char *nick,
                        const char *msg);
 
+/**
+ * Report the status of the http request to add a name to the deny
+ * list or remove a name from the deny list.
+ *
+ * @param gc     The connection.
+ * @param data   The data passed from gaim_url_fetch().
+ * @param result The information fetched by the http GET.
+ * @param len    The length of the result.
+ */
+void gaym_server_change_deny_status_cb(void *data, const char *result,
+                                       size_t len);
+
+/**
+ * Add a name to (or remove a name from) the Gay.com server's deny list.
+ *
+ * @param      gc The connection.
+ * @param name The name of the user to add or remove.
+ * @param add  TRUE of the name should be added, FALSE if the name should be removed.
+ */
+void gaym_server_store_deny(GaimConnection * gc, const char *name,
+                            gboolean add);
+
 #endif                          /* _GAIM_GAYM_GAYMPRIV_H_ */
 
 /**



From deckrider at sheep.berlios.de  Fri Jun 17 01:26:16 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Fri, 17 Jun 2005 01:26:16 +0200
Subject: [Qrc-svn] r111 - trunk/gaym/src
Message-ID: <200506162326.j5GNQGQI018342@sheep.berlios.de>

Author: deckrider
Date: 2005-06-17 01:26:08 +0200 (Fri, 17 Jun 2005)
New Revision: 111

Added:
   trunk/gaym/src/configtxt.c
   trunk/gaym/src/configtxt.h
Modified:
   trunk/gaym/src/Makefile.am
   trunk/gaym/src/gaym.c
Log:
Synchronize local and server deny lists.  Because Gay.com seems to store
a maximum of 67-68 people on this list, synchronization logic defaults
to attempting to store the superset of the local and server lists on
each.


Modified: trunk/gaym/src/Makefile.am
===================================================================
--- trunk/gaym/src/Makefile.am	2005-06-16 15:03:22 UTC (rev 110)
+++ trunk/gaym/src/Makefile.am	2005-06-16 23:26:08 UTC (rev 111)
@@ -3,6 +3,8 @@
 
 GAYMSOURCES = \
 	cmds.c \
+	configtxt.c \
+	configtxt.h \
 	dcc_send.c \
 	gaym.c \
 	gaym.h \

Added: trunk/gaym/src/configtxt.c
===================================================================
--- trunk/gaym/src/configtxt.c	2005-06-16 15:03:22 UTC (rev 110)
+++ trunk/gaym/src/configtxt.c	2005-06-16 23:26:08 UTC (rev 111)
@@ -0,0 +1,111 @@
+/**
+ * GayM
+ *
+ * GayM is the legal property of its developers, whose names are too numerous
+ * to list here.  Please refer to the COPYRIGHT file distributed with this
+ * source distribution.
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License
+ * along with this program; if not, write to the Free Software
+ * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ */
+
+/* config.h */
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
+/* system headers */
+#include <glib.h>
+
+/* gaim headers for this plugin */
+#include "util.h"
+#include "debug.h"
+#include "account.h"
+#include "privacy.h"
+
+/* local headers for this plugin */
+#include "gaympriv.h"
+#include "gaym.h"
+
+void synchronize_deny_list(GaimConnection * gc, const char *configtxt)
+{
+    char *srvdeny = NULL;
+    char *start = NULL;
+    char *end = NULL;
+    gchar **srvdenylist = NULL;
+    GSList *list;
+    gint i = 0;
+    gboolean needsync = FALSE;
+
+    start =
+        g_strstr_len(configtxt, -1, "connect-list.ignore.members=") + 28;
+    end = g_strstr_len(start, -1, "\n");
+    srvdeny = g_strndup(start, end - start);
+
+    srvdenylist = g_strsplit(srvdeny, ",", -1);
+
+    /* Add server deny list from config.txt to local deny list */
+    for (i = 0; srvdenylist[i]; i++) {
+        needsync = TRUE;
+        for (list = gc->account->deny; list != NULL; list = list->next) {
+            if (!gaim_utf8_strcasecmp
+                (srvdenylist[i],
+                 gaim_normalize(gc->account, (char *) list->data))) {
+                needsync = FALSE;
+                break;
+            }
+        }
+        if (needsync) {
+            if (!gaim_privacy_deny_add(gc->account, srvdenylist[i], TRUE)) {
+                gaim_debug_error("gaym",
+                                 "Failed to add %s to local deny list from server.\n",
+                                 srvdenylist[i]);
+            } else {
+                gaim_debug_misc("gaym",
+                                "Added %s to local deny list from server.\n",
+                                srvdenylist[i]);
+            }
+        }
+    }
+
+    /* Add local deny list not found in config.txt to server deny list */
+    for (list = gc->account->deny; list != NULL; list = list->next) {
+        needsync = TRUE;
+        for (i = 0; srvdenylist[i]; i++) {
+            if (!gaim_utf8_strcasecmp
+                (srvdenylist[i],
+                 gaim_normalize(gc->account, (char *) list->data))) {
+                needsync = FALSE;
+                break;
+            }
+        }
+        if (needsync) {
+            gaym_server_store_deny(gc, (char *) list->data, TRUE);
+        }
+    }
+
+    g_strfreev(srvdenylist);
+    g_free(srvdeny);
+    return;
+}
+
+void process_configtxt(GaimConnection * gc, const char *configtxt)
+{
+    synchronize_deny_list(gc, configtxt);
+    return;
+}
+
+/**
+ * vim:tabstop=4:shiftwidth=4:expandtab:
+ */

Added: trunk/gaym/src/configtxt.h
===================================================================
--- trunk/gaym/src/configtxt.h	2005-06-16 15:03:22 UTC (rev 110)
+++ trunk/gaym/src/configtxt.h	2005-06-16 23:26:08 UTC (rev 111)
@@ -0,0 +1,54 @@
+/**
+ * @file configtxt.h GayM Privacy API
+ *
+ * GayM
+ *
+ * GayM is the legal property of its developers, whose names are too numerous
+ * to list here.  Please refer to the COPYRIGHT file distributed with this
+ * source distribution.
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License
+ * along with this program; if not, write to the Free Software
+ * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ */
+#ifndef _GAIM_GAYM_CONFIGTXT_H_
+#define _GAIM_GAYM_CONFIGTXT_H_
+
+#include "connection.h"
+
+/**
+ * Try to synchronize the server's deny list with gaim's local deny
+ * list.  Because there may be a limit to the number of people you can
+ * store on the server's deny list, this function's goal so to put the
+ * superset of the two on both.
+ *
+ * @param gc        The connection.
+ * @param configtxt The config.txt java properties retrieved from Gay.com.
+ */
+void synchronize_deny_list(GaimConnection * gc, const char *configtxt);
+
+/**
+ * This is the driver function to do all the processing of the config.txt
+ * java properties file upon retrieval from Gay.com.  It should perform
+ * each of the above functions.
+ *
+ * @param gc        The connection.
+ * @param configtxt The config.txt java properties retrieved from Gay.com.
+ */
+void process_configtxt(GaimConnection * gc, const char *configtxt);
+
+#endif                          /* _GAIM_GAYM_CONFIGTXT_H_ */
+
+/**
+ * vim:tabstop=4:shiftwidth=4:expandtab:
+ */

Modified: trunk/gaym/src/gaym.c
===================================================================
--- trunk/gaym/src/gaym.c	2005-06-16 15:03:22 UTC (rev 110)
+++ trunk/gaym/src/gaym.c	2005-06-16 23:26:08 UTC (rev 111)
@@ -38,6 +38,7 @@
 
 #include "helpers.h"
 #include "gaympriv.h"
+#include "configtxt.h"
 #include "gaym.h"
 
 char *gaym_mask_bio(const char *biostring);
@@ -353,6 +354,7 @@
                                   const gchar * config_text, size_t len)
 {
     struct gaym_conn *gaym = (struct gaym_conn *) proto_data;
+    GaimConnection *gc = gaim_account_get_connection(gaym->account);
 
     if (!config_text) {
         return;
@@ -365,6 +367,8 @@
     if (!gaym->configtxt) {
         gaim_debug(GAIM_DEBUG_ERROR, "gaym",
                    "Could not convert config.txt to utf-8.\n");
+    } else {
+        process_configtxt(gc, gaym->configtxt);
     }
     return;
 }



From deckrider at sheep.berlios.de  Fri Jun 17 01:31:18 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Fri, 17 Jun 2005 01:31:18 +0200
Subject: [Qrc-svn] r112 - trunk
Message-ID: <200506162331.j5GNVIDF020595@sheep.berlios.de>

Author: deckrider
Date: 2005-06-17 01:30:53 +0200 (Fri, 17 Jun 2005)
New Revision: 112

Modified:
   trunk/TODO
Log:
Updated TODO showing that the activation of gaim's prpl privacy api is
now complete.


Modified: trunk/TODO
===================================================================
--- trunk/TODO	2005-06-16 23:26:08 UTC (rev 111)
+++ trunk/TODO	2005-06-16 23:30:53 UTC (rev 112)
@@ -14,8 +14,8 @@
   the end or receive an error, since the server doesn't appear to send
   one at at first glance (verify before acting).
 
-- integrate server buddy, bookmarks, hotlists, im hot lists, ignore
-  lists (below is two version of this)
+- integrate server buddy, bookmarks, hotlists, im hot lists, (below is two
+  version of this)
 
 - gay.com buddy list integration. An option to "auto-add" NOTIFY
   buddies (really, we already have the complete list in config.txt
@@ -49,7 +49,7 @@
 
 - Thumbnail in "chat" windows for selected user. Again -- this will need
   to be a separate plugin, since it will require gtk-specific code (most
-  likely)
+  likely) (gaim developers seem to be working on this now)
 
 - Room namelist sorting -- another non-proto option. I'm not even sure
   if a plugin can affect this, based on the way it seems to be
@@ -96,7 +96,9 @@
 
 - Connect link to web page for report user to Warn button in Gaim
 
-- activate privacy/block users in gui
+- Activate privacy/block users in gui, synchronize ignore/deny lists
+  between server and client.  Activation of Gaim's prpl privacy API is
+  complete.
 
 - Join/part message on/off
 



From deckrider at sheep.berlios.de  Sun Jun 19 01:18:07 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Sun, 19 Jun 2005 01:18:07 +0200
Subject: [Qrc-svn] r113 - trunk
Message-ID: <200506182318.j5INI7eG006852@sheep.berlios.de>

Author: deckrider
Date: 2005-06-19 01:17:33 +0200 (Sun, 19 Jun 2005)
New Revision: 113

Modified:
   trunk/TODO
Log:
More transfers from TODO to the berios bug system.


Modified: trunk/TODO
===================================================================
--- trunk/TODO	2005-06-16 23:30:53 UTC (rev 112)
+++ trunk/TODO	2005-06-18 23:17:33 UTC (rev 113)
@@ -3,42 +3,18 @@
 TODO
 ====
 
-- "Tools | Account Actions | Change Bio" should not obliterate the
-  "^AS|A|L" but only the bio string.  Currently, the S|A|L gets
-  obliterated which means no one else can see it.
+See http://developer.berlios.de/bugs/?group_id=2690
 
-- Make it so users enter free form text to chat and this gets converted
-  to a member-created-room style by replacing spaces with underscores
-  and appending #_ at the beginning and =1 (or some number) at the end.
-  Probably the users should be required to enter ":1" or some number at
-  the end or receive an error, since the server doesn't appear to send
-  one at at first glance (verify before acting).
+Working on transferring these remaining open TODO items to the Bugs
+system:
 
-- integrate server buddy, bookmarks, hotlists, im hot lists, (below is two
-  version of this)
-
-- gay.com buddy list integration. An option to "auto-add" NOTIFY
-  buddies (really, we already have the complete list in config.txt
-  without waiting for NOTIFY).
-
-- Synchronize buddy list with server.  This is easy to do.  Already, we
-  have the server's view of the list in config.txt.  Adding a new buddy
-  to the server is basically an http GET.  Some thought however needs to
-  be given to user interface design, in terms of whether we should sync
-  to the server's buddies, and/or bookmarks, and/or hotlist.
-
 - Bio Line display in chat window. (I think this can be done using
   TOPIC when the user's name is clicked.  I think yahoo may do something
   so its not editable, which would help us here.  So this could be a
   PROTOCOL PLUGIN)
 
-- The "Room List" operation should parse the /messenger/config.txt file
-  from gay.com. We need to hide as much as possible the "real" channel
-  names (Like #557 is Sacramento). As the room list is generated, it
-  should automatically display the multiple rooms associated with a
-  locale, so that the user can select one. The user should have the
-  option of adding EITHER the #xxx=* room, OR a particular #xxx=x room,
-  to the buddy list.   (I think this is somewhat done, but not sure)
+  As the room list is generated, it should automatically display the multiple
+  rooms associated with a locale, so that the user can select one.
 
 - Split-phase operation notifiers. For example.... if you click to join
   a channel, there may be a delay if, for example, the buddy list is
@@ -67,22 +43,19 @@
 - check if there is another way to retrieve thumbnails without the extra
   signal connect
 
-- there seem to be a lot of NOTIFYs that gaym ignores ... might be nice
-  to use them instead of polling (or in addition to)
-
 - handle all "unknowns" shown in the debug window
 
 - Getting these in red, not sure what it is: gaim_utf8_strcasecmp: One
   or both parameters are invalid UTF8  (still valid?)
 
+DONE
+====
+
 - Need a better way to coordinate VERSION between configure.ac an win32
   builds (which do not currently use autoconf).  Perhaps win32 can
   eventually use autoconf/automake, but I don't yet know how
   cross-compiler builds would work with this.
 
-DONE
-====
-
 - NOTE:  This item was found to be ineffective and not committed,
   instead, a challenge / response system was put in its place.  Add
   gaym_bot_check(), patterned similar to gaym_privacy_check() that takes



From deckrider at sheep.berlios.de  Sun Jun 19 06:20:28 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Sun, 19 Jun 2005 06:20:28 +0200
Subject: [Qrc-svn] r114 - in trunk: . gaym/src
Message-ID: <200506190420.j5J4KSqt025840@sheep.berlios.de>

Author: deckrider
Date: 2005-06-19 06:19:56 +0200 (Sun, 19 Jun 2005)
New Revision: 114

Modified:
   trunk/TODO
   trunk/gaym/src/gaym.c
   trunk/gaym/src/msgs.c
Log:
Wildcard roomlist and aliases from buddylist.
Various comment formating changes.


Modified: trunk/TODO
===================================================================
--- trunk/TODO	2005-06-18 23:17:33 UTC (rev 113)
+++ trunk/TODO	2005-06-19 04:19:56 UTC (rev 114)
@@ -13,7 +13,7 @@
   so its not editable, which would help us here.  So this could be a
   PROTOCOL PLUGIN)
 
-  As the room list is generated, it should automatically display the multiple
+- As the room list is generated, it should automatically display the multiple
   rooms associated with a locale, so that the user can select one.
 
 - Split-phase operation notifiers. For example.... if you click to join

Modified: trunk/gaym/src/gaym.c
===================================================================
--- trunk/gaym/src/gaym.c	2005-06-18 23:17:33 UTC (rev 113)
+++ trunk/gaym/src/gaym.c	2005-06-19 04:19:56 UTC (rev 114)
@@ -795,6 +795,58 @@
     g_free(ib);
 }
 
+static GaimChat *gaym_find_blist_chat(GaimAccount * account,
+                                      const char *name)
+{
+    char *chat_name;
+    GaimChat *chat;
+    GaimPlugin *prpl;
+    GaimPluginProtocolInfo *prpl_info = NULL;
+    struct proto_chat_entry *pce;
+    GaimBlistNode *node, *group;
+    GList *parts;
+
+    GaimBuddyList *gaimbuddylist = gaim_get_blist();
+
+    g_return_val_if_fail(gaimbuddylist != NULL, NULL);
+    g_return_val_if_fail((name != NULL) && (*name != '\0'), NULL);
+
+    if (!gaim_account_is_connected(account))
+        return NULL;
+
+    prpl = gaim_find_prpl(gaim_account_get_protocol_id(account));
+    prpl_info = GAIM_PLUGIN_PROTOCOL_INFO(prpl);
+
+    for (group = gaimbuddylist->root; group != NULL; group = group->next) {
+        for (node = group->child; node != NULL; node = node->next) {
+            if (GAIM_BLIST_NODE_IS_CHAT(node)) {
+
+                chat = (GaimChat *) node;
+
+                if (account != chat->account)
+                    continue;
+
+                parts =
+                    prpl_info->
+                    chat_info(gaim_account_get_connection(chat->account));
+
+                pce = parts->data;
+                chat_name = g_hash_table_lookup(chat->components,
+                                                pce->identifier);
+
+                if (chat->account == account && chat_name != NULL &&
+                    name != NULL
+                    && g_pattern_match_simple(chat_name, name)) {
+
+                    return chat;
+                }
+            }
+        }
+    }
+
+    return NULL;
+}
+
 static GaimRoomlist *gaym_roomlist_get_list(GaimConnection * gc)
 {
     struct gaym_conn *gaym;
@@ -905,7 +957,7 @@
     NULL,                       /* remove_group */
     NULL,                       /* get_cb_real_name */
     NULL,                       /* set_chat_topic */
-    NULL,                       /* find_blist_chat */
+    gaym_find_blist_chat,       /* find_blist_chat */
     gaym_roomlist_get_list,     /* roomlist_get_list */
     gaym_roomlist_cancel,       /* roomlist_cancel */
     NULL,                       /* roomlist_expand_category */

Modified: trunk/gaym/src/msgs.c
===================================================================
--- trunk/gaym/src/msgs.c	2005-06-18 23:17:33 UTC (rev 113)
+++ trunk/gaym/src/msgs.c	2005-06-19 04:19:56 UTC (rev 114)
@@ -1,24 +1,26 @@
 /**
-* @file msgs.c
-* 
-* gaim
-*
-* Copyright (C) 2003, Ethan Blanton <eblanton at cs.purdue.edu>
-* 
-* This program is free software; you can redistribute it and/or modify
-* it under the terms of the GNU General Public License as published by
-* the Free Software Foundation; either version 2 of the License, or
-* (at your option) any later version.
-*
-* This program is distributed in the hope that it will be useful,
-* but WITHOUT ANY WARRANTY; without even the implied warranty of
-* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-* GNU General Public License for more details.
-*
-* You should have received a copy of the GNU General Public License
-* along with this program; if not, write to the Free Software
-* Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
-*/
+ * @file msgs.c
+ *
+ * GayM
+ *
+ * GayM is the legal property of its developers, whose names are too numerous
+ * to list here.  Please refer to the COPYRIGHT file distributed with this
+ * source distribution.
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License
+ * along with this program; if not, write to the Free Software
+ * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ */
 
 #include "internal.h"
 #include "conversation.h"
@@ -31,13 +33,13 @@
 #include "privacy.h"
 #include "prefs.h"
 
-#include <stdio.h>
-
 #include "helpers.h"
 #include "gaympriv.h"
 #include "gaym.h"
 
-// begin forward declarations
+/**
+ * begin forward declarations
+ */
 
 static char *gaym_mask_nick(const char *mask);
 
@@ -47,7 +49,9 @@
 static void gaym_buddy_status(char *name, struct gaym_buddy *ib,
                               struct gaym_conn *gaym);
 
-// end forward declarations
+/**
+ * end forward declarations
+ */
 
 char *gaym_mask_thumbnail(const char *biostring)
 {
@@ -124,7 +128,9 @@
 
 static void gaym_chat_remove_buddy(GaimConversation * convo, char *data[2])
 {
-    // FIXME: is *message ever used ???
+    /**
+     * FIXME: is *message ever used ???
+     */
     char *message = g_strdup_printf("quit: %s", data[1]);
 
     if (gaim_conv_chat_find_user(GAIM_CONV_CHAT(convo), data[0]))
@@ -359,17 +365,17 @@
 void gaym_msg_list(struct gaym_conn *gaym, const char *name,
                    const char *from, char **args)
 {
-    // 
-    // If you free anything here related to the roomlist
-    // be sure you test what happens when the roomlist reference
-    // count goes to zero! Because it may crash gaim.
-    // 
+    /**
+     * If you free anything here related to the roomlist
+     * be sure you test what happens when the roomlist reference
+     * count goes to zero! Because it may crash gaim.
+     */
     if (!gaym->roomlist) {
         return;
     }
-    // 
-    // Begin result of member created room list
-    // 
+    /**
+     * Begin result of member created room list
+     */
     if (!strcmp(name, "321")) {
         GaimRoomlistRoom *room;
         room = gaim_roomlist_room_new(GAIM_ROOMLIST_ROOMTYPE_CATEGORY,
@@ -378,9 +384,9 @@
         gaim_roomlist_set_in_progress(gaym->roomlist, TRUE);
         return;
     }
-    // 
-    // The list of member created room
-    // 
+    /**
+     * The list of member created room
+     */
     if (!strcmp(name, "322")) {
         GaimRoomlistRoom *room;
         char *field_start = NULL;
@@ -391,10 +397,10 @@
         if (!args[1]) {
             return;
         }
-        // 
-        // strip leading "#_" and trailing "=1"
-        // 
 
+        /**
+         * strip leading "#_" and trailing "=1"
+         */
         field_start = strchr(args[1], '_');
         field_end = strrchr(args[1], '=');
 
@@ -410,16 +416,17 @@
 
         char *field_name = g_strndup(field_start, field_len);
 
-        // 
-        // replace all remaining "_" with " "
-        // 
-
+        /**
+         * replace all remaining "_" with " "
+         */
         for (i = 0; field_name[i] != '\0'; i++) {
             if (field_name[i] == '_') {
                 field_name[i] = ' ';
             }
         }
-        // replace '=' with ':'
+        /**
+         * replace '=' with ':'
+         */
         field_name[i - 2] = ':';
 
         room = gaim_roomlist_room_new(GAIM_ROOMLIST_ROOMTYPE_ROOM,
@@ -431,23 +438,23 @@
         gaim_roomlist_room_add(gaym->roomlist, room);
         g_free(field_name);
     }
-    // 
-    // Begin result of member created room list
-    // This is our trigger to add the static rooms
-    // 
+    /**
+     * Begin result of member created room list
+     * This is our trigger to add the static rooms
+     */
     if (!strcmp(name, "323")) {
 
-        // 
-        // The following shoul be done just before every "return"
-        // 
-        // gaim_roomlist_set_in_progress(gaym->roomlist, FALSE);
-        // gaim_roomlist_unref(gaym->roomlist);
-        // gaym->roomlist = NULL;
-        // return;
-        // 
-        // Perhaps this can be simplified, but not worrying with
-        // it right now
-        // 
+        /**
+         * The following shoul be done just before every "return"
+         * 
+         * gaim_roomlist_set_in_progress(gaym->roomlist, FALSE);
+         * gaim_roomlist_unref(gaym->roomlist);
+         * gaym->roomlist = NULL;
+         * return;
+         * 
+         * Perhaps this can be simplified, but not worrying with
+         * it right now
+         */
 
         int current_level = 0;
         char *list_position = NULL;
@@ -490,11 +497,13 @@
             level = 0;
             list_position += 2;
 
-            // 
-            // This is a room
-            // 
+            /**
+             * This is a room
+             */
             if (*list_position == '#') {
-                // First, parse the room number
+                /**
+                 * First, parse the room number
+                 */
                 field_end = strchr(list_position, '=');
                 if (!field_end) {
                     gaim_debug_error("gaym",
@@ -510,9 +519,9 @@
                 num = g_strndup(list_position, field_len);
                 list_position = field_end + 2;
 
-                // 
-                // Next, the +'s indicate the level in the tree
-                // 
+                /**
+                 * Next, the +'s indicate the level in the tree
+                 */
                 while (*list_position == '+') {
                     level++;
                     list_position++;
@@ -528,9 +537,9 @@
                             current_parent ? current_parent->parent : NULL;
                     }
                 }
-                // 
-                // Finally, the readable room name
-                // 
+                /**
+                 * Finally, the readable room name
+                 */
                 field_end = strstr(list_position, "\\\n");
                 if (!field_end) {
                     gaim_debug_error("gaym", "Room list parsing error!");
@@ -552,10 +561,9 @@
                 if (!gaym->roomlist_filter
                     || strstr(lname, gaym->roomlist_filter) != 0) {
 
-                    // 
-                    // create and add the room folder
-                    // 
-
+                    /**
+                     * create and add the room folder
+                     */
                     room =
                         gaim_roomlist_room_new
                         (GAIM_ROOMLIST_ROOMTYPE_CATEGORY, name,
@@ -564,9 +572,25 @@
 
                     room_title = room;
 
-                    // 
-                    // and now the room instances (1, 2, 3 ...)
-                    // 
+                    name_inst = g_strdup_printf("%s:*", name);
+                    num_inst = g_strdup_printf("%s*", num);
+
+                    room =
+                        gaim_roomlist_room_new
+                        (GAIM_ROOMLIST_ROOMTYPE_ROOM, name_inst,
+                         room_title);
+                    gaim_roomlist_room_add_field(gaym->roomlist, room,
+                                                 name_inst);
+                    gaim_roomlist_room_add_field(gaym->roomlist, room,
+                                                 num_inst);
+                    gaim_roomlist_room_add(gaym->roomlist, room);
+                    g_free(name_inst);
+                    g_free(num_inst);
+                    name_inst = NULL;
+                    num_inst = NULL;
+                    /**
+                     * and now the room instances (1, 2, 3 ...)
+                     */
                     room_inst = 0;
                     for (room_inst = 1; room_inst <= 4; room_inst++) {
                         name_inst =
@@ -582,11 +606,7 @@
                         gaim_roomlist_room_add_field(gaym->roomlist, room,
                                                      num_inst);
                         gaim_roomlist_room_add(gaym->roomlist, room);
-                        // gaim_debug_misc("gaym",
-                        // "(Ref %x) Added room %s: %s (level %d) (parent
-                        // %x)\n",
-                        // room, num, name, current_level,
-                        // room_title);
+
                         g_free(name_inst);
                         g_free(num_inst);
                         name_inst = NULL;
@@ -598,16 +618,15 @@
                         g_free(lname);
                     }
                 }
-                // 
-                // This is a category
-                // 
+                /**
+                 * This is a category
+                 */
             } else if (!gaym->roomlist_filter) {
 
-                // 
-                // This code is duplicated above. Should probably make a
-                // function.
-                // 
-
+                /**
+                 * This code is duplicated above. Should probably make a
+                 * function.
+                 */
                 while (*list_position == '+') {
                     level++;
                     list_position++;
@@ -622,14 +641,11 @@
                         current_level--;
                         current_parent =
                             current_parent ? current_parent->parent : NULL;
-                        // gaim_debug_misc("gaym", "Changed parent to
-                        // %x\n",
-                        // current_parent);
                     }
                 }
-                // 
-                // end duplicate
-                // 
+                /**
+                 * end duplicate
+                 */
                 field_end = strstr(list_position, "\\\n");
                 if (!field_end) {
                     gaim_debug_error("gaym", "Room list parsing error!");
@@ -645,9 +661,6 @@
                                            name, current_parent);
                 gaim_roomlist_room_add(gaym->roomlist, room);
 
-                // gaim_debug_misc("gaym",
-                // "(Ref %x) Added categroy %s (level %d) (parent %x)\n",
-                // room, name, level, current_parent);
                 g_free(name);
                 list_position = field_end;
             } else {
@@ -776,9 +789,9 @@
     }
 }
 
-
-// Change this to WELCOME
-
+/**
+ * Change this to WELCOME
+ */
 void gaym_msg_endmotd(struct gaym_conn *gaym, const char *name,
                       const char *from, char **args)
 {
@@ -829,19 +842,18 @@
 
     convo = gaim_find_conversation_with_account(args[1], gaym->account);
     if (convo) {
-        if (gaim_conversation_get_type(convo) == GAIM_CONV_CHAT)        /* does 
-                                                                           this 
-                                                                           happen? 
-                                                                         */
+        if (gaim_conversation_get_type(convo) == GAIM_CONV_CHAT) {
+            /* does this happen? */
             gaim_conv_chat_write(GAIM_CONV_CHAT(convo), args[1],
                                  _("no such channel"),
                                  GAIM_MESSAGE_SYSTEM | GAIM_MESSAGE_NO_LOG,
                                  time(NULL));
-        else
+        } else {
             gaim_conv_im_write(GAIM_CONV_IM(convo), args[1],
                                _("User is not logged in"),
                                GAIM_MESSAGE_SYSTEM | GAIM_MESSAGE_NO_LOG,
                                time(NULL));
+        }
     } else {
         if ((gc = gaim_account_get_connection(gaym->account)) == NULL)
             return;
@@ -873,7 +885,9 @@
     }
 }
 
-// Is this used?
+/**
+ * Is this used?
+ */
 void gaym_msg_notinchan(struct gaym_conn *gaym, const char *name,
                         const char *from, char **args)
 {
@@ -892,8 +906,9 @@
     }
 }
 
-
-// Invite WORKS in gay.com!
+/**
+ * Invite WORKS in gay.com!
+ */
 void gaym_msg_invite(struct gaym_conn *gaym, const char *name,
                      const char *from, char **args)
 {
@@ -974,9 +989,11 @@
         return;
 
     if (ib->online && !ib->flag) {
-        // FUTURE VERSION ALERT: This will become
-        // gaim_prpl_got_user_status.
-        // serv_got_update is being deprecated.
+        /**
+         * FUTURE VERSION ALERT: This will become
+         * gaim_prpl_got_user_status.
+         * serv_got_update is being deprecated.
+         */
         serv_got_update(gc, buddy->name, FALSE, 0, 0, 0, 0);
         ib->online = FALSE;
     }
@@ -1065,7 +1082,9 @@
                                 flags, TRUE);
     }
 
-    // Make the ignore.png icon appear next to the nick.
+    /**
+     * Make the ignore.png icon appear next to the nick.
+     */
     GaimConversationUiOps *ops = gaim_conversation_get_ui_ops(convo);
     if (!gaym_privacy_check(gc, nick)) {
         gaim_conv_chat_ignore(GAIM_CONV_CHAT(convo), nick);
@@ -1469,9 +1488,11 @@
     }
     buf = g_strdup_printf(_("%s"), args[2]);
     gaim_notify_error(gc, _("Pay Only"), _("Pay Only"), buf);
-    // FIXME
-    // by now the chatroom is already in the buddy list...need
-    // to remove it or something
+    /**
+     * FIXME
+     * by now the chatroom is already in the buddy list...need
+     * to remove it or something
+     */
     g_free(buf);
 }
 
@@ -1546,7 +1567,9 @@
 
     convo = gaim_find_conversation_with_account(channel, gaym->account);
 
-    // gaym_bot_detect(gaym_mask_bio(extra), convo, nick);
+    /**
+     * gaym_bot_detect(gaym_mask_bio(extra), convo, nick);
+     */
 
     if (convo == NULL) {
         gaim_debug(GAIM_DEBUG_ERROR, "gaym", "690 for %s failed\n",
@@ -1563,7 +1586,9 @@
     gaim_conv_chat_add_user(GAIM_CONV_CHAT(convo), nick, NULL, flags,
                             FALSE);
 
-    // Make the ignore.png icon appear next to the nick.
+    /**
+     * Make the ignore.png icon appear next to the nick.
+     */
     GaimConversationUiOps *ops = gaim_conversation_get_ui_ops(convo);
     if (!gaym_privacy_check(gc, nick)) {
         gaim_conv_chat_ignore(GAIM_CONV_CHAT(convo), nick);



From deckrider at sheep.berlios.de  Sun Jun 19 17:46:51 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Sun, 19 Jun 2005 17:46:51 +0200
Subject: [Qrc-svn] r115 - trunk
Message-ID: <200506191546.j5JFkpPx021253@sheep.berlios.de>

Author: deckrider
Date: 2005-06-19 17:46:50 +0200 (Sun, 19 Jun 2005)
New Revision: 115

Modified:
   trunk/TODO
Log:
Updated TODO.


Modified: trunk/TODO
===================================================================
--- trunk/TODO	2005-06-19 04:19:56 UTC (rev 114)
+++ trunk/TODO	2005-06-19 15:46:50 UTC (rev 115)
@@ -13,9 +13,6 @@
   so its not editable, which would help us here.  So this could be a
   PROTOCOL PLUGIN)
 
-- As the room list is generated, it should automatically display the multiple
-  rooms associated with a locale, so that the user can select one.
-
 - Split-phase operation notifiers. For example.... if you click to join
   a channel, there may be a delay if, for example, the buddy list is
   updating. This is NOT acceptable from a UI standpoint, since feedback



From deckrider at sheep.berlios.de  Mon Jun 20 14:47:18 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Mon, 20 Jun 2005 14:47:18 +0200
Subject: [Qrc-svn] r116 - trunk
Message-ID: <200506201247.j5KClIqC030204@sheep.berlios.de>

Author: deckrider
Date: 2005-06-20 14:47:17 +0200 (Mon, 20 Jun 2005)
New Revision: 116

Modified:
   trunk/configure.ac
Log:
Convert to produzing bzip2 source distributions, which are much smaller
than gzip distributions.


Modified: trunk/configure.ac
===================================================================
--- trunk/configure.ac	2005-06-19 15:46:50 UTC (rev 115)
+++ trunk/configure.ac	2005-06-20 12:47:17 UTC (rev 116)
@@ -4,7 +4,7 @@
 AC_PREREQ(2.59)
 AC_INIT([qrc],[0.33.0+svn],[gaymplugin at yahoogroups.com])
 AC_CANONICAL_TARGET([])
-AM_INIT_AUTOMAKE([1.9.5])
+AM_INIT_AUTOMAKE([1.9.5 no-dist-gzip dist-bzip2])
 
 REQUIRED_PKG_CONFIG="0.15.0"
 AC_SUBST(REQUIRED_PKG_CONFIG)



From deckrider at sheep.berlios.de  Mon Jun 20 22:28:09 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Mon, 20 Jun 2005 22:28:09 +0200
Subject: [Qrc-svn] r117 - trunk/bot-challenger
Message-ID: <200506202028.j5KKS9QO002690@sheep.berlios.de>

Author: deckrider
Date: 2005-06-20 22:28:08 +0200 (Mon, 20 Jun 2005)
New Revision: 117

Modified:
   trunk/bot-challenger/bot-challenger.c
Log:
Fixed a major issue of bot-challenger that caused it not to allow new
unknown people to speak to you unless you had enabled the "add to permit
list" option.


Modified: trunk/bot-challenger/bot-challenger.c
===================================================================
--- trunk/bot-challenger/bot-challenger.c	2005-06-20 12:47:17 UTC (rev 116)
+++ trunk/bot-challenger/bot-challenger.c	2005-06-20 20:28:08 UTC (rev 117)
@@ -265,17 +265,23 @@
                 }
             }
 
-            serv_got_im(connection, *sender, pending->message, 0,
-                        time(NULL));
+            /**
+             * Free what is currently in the buffer (the correct answer)
+             * and replace it with the user's first message that was
+             * queued, pending the correct answer.  I think some other
+             * process is supposed to free the buffer after its sent.
+             */
+            g_free(*buffer);
+            *buffer = pending->message;
 
+            /* Clean up everything else except pending->message */
             g_free(pending->protocol);
             g_free(pending->username);
             g_free(pending->sender);
-            g_free(pending->message);
             g_free(pending);
             pending_list = g_slist_remove_link(pending_list, search);
 
-            retval = TRUE;
+            retval = FALSE;     /* Don't block this message */
         }
     }
     debug_pending_list();



From deckrider at sheep.berlios.de  Tue Jun 21 17:06:44 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Tue, 21 Jun 2005 17:06:44 +0200
Subject: [Qrc-svn] r118 - trunk/bot-challenger
Message-ID: <200506211506.j5LF6iiY030371@sheep.berlios.de>

Author: deckrider
Date: 2005-06-21 17:06:42 +0200 (Tue, 21 Jun 2005)
New Revision: 118

Modified:
   trunk/bot-challenger/bot-challenger.c
Log:
Added function to clean up when the plugin is unloaded, and updated
on-screen text.


Modified: trunk/bot-challenger/bot-challenger.c
===================================================================
--- trunk/bot-challenger/bot-challenger.c	2005-06-20 20:28:08 UTC (rev 117)
+++ trunk/bot-challenger/bot-challenger.c	2005-06-21 15:06:42 UTC (rev 118)
@@ -321,7 +321,7 @@
     ppref =
         gaim_plugin_pref_new_with_name_and_label
         ("/plugins/core/bot/challenger/auto_add_permit",
-         _("Add this person to your Permit List"));
+         _("Add this person to your Allow List"));
     gaim_plugin_pref_frame_add(frame, ppref);
 
     return frame;
@@ -353,6 +353,21 @@
     return TRUE;
 }
 
+static gboolean plugin_unload(GaimPlugin * plugin)
+{
+    GSList *search = NULL;
+    for (search = pending_list; search; search = search->next) {
+        PendingMessage *pending = search->data;
+        g_free(pending->protocol);
+        g_free(pending->username);
+        g_free(pending->sender);
+        g_free(pending->message);
+        g_free(pending);
+        pending_list = g_slist_remove_link(pending_list, search);
+    }
+    return TRUE;
+}
+
 static GaimPluginInfo info = {
     GAIM_PLUGIN_MAGIC,
     GAIM_MAJOR_VERSION,
@@ -369,12 +384,12 @@
                                                           /**  summary        */
     N_("Block robots from sending Instant Messages"),
                                                           /**  description    */
-    N_("A simple challenge-response system to permit only real people to send you instant messages"),
+    N_("A simple challenge-response system to prevent spam-bots from sending you instant messages.  Think of it as a pop-up blocker.  You define a question and an answer.  Instant messages from others will be ignored unless one of the following is true:\n\n\t* the sender is in your Buddy List\n\t* the sender is in your Allow List\n\t* the sender correctly answers your question\n\nOptionally, you may have the sender automatically added to your Allow List when the correct answer is provided."),
     "David Everly <deckrider at gmail.com>",                 /**< author         */
     "http://developer.berlios.de/projects/qrc/",          /**< homepage       */
 
     plugin_load,                                          /**< load           */
-    NULL,                                                 /**< unload         */
+    plugin_unload,                                        /**< unload         */
     NULL,                                                 /**< destroy        */
 
     NULL,                                                 /**< ui_info        */



From deckrider at sheep.berlios.de  Thu Jun 23 05:32:18 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Thu, 23 Jun 2005 05:32:18 +0200
Subject: [Qrc-svn] r119 - trunk/bot-challenger
Message-ID: <200506230332.j5N3WImq031405@sheep.berlios.de>

Author: deckrider
Date: 2005-06-23 05:32:03 +0200 (Thu, 23 Jun 2005)
New Revision: 119

Modified:
   trunk/bot-challenger/bot-challenger.c
Log:
Now using 10 minute timer instead of waiting for messages to be pushed
off the end of a 10 member queue.

Reworded some of the text to include a mention of the time limit.

Moved queue clean up to its own function.


Modified: trunk/bot-challenger/bot-challenger.c
===================================================================
--- trunk/bot-challenger/bot-challenger.c	2005-06-21 15:06:42 UTC (rev 118)
+++ trunk/bot-challenger/bot-challenger.c	2005-06-23 03:32:03 UTC (rev 119)
@@ -48,6 +48,7 @@
  */
 typedef struct _PendingMessage PendingMessage;
 struct _PendingMessage {
+    glong tv_sec;
     char *protocol;
     char *username;
     char *sender;
@@ -55,6 +56,8 @@
 };
 static GSList *pending_list = NULL;     /* GSList of PendingMessage */
 
+#define BOT_MAX_MINUTES 10
+
 /**
  * Return TRUE if the protocols match
  */
@@ -92,6 +95,42 @@
 }
 
 /**
+ * Free an entry in the pending_list.  Don't free the message field
+ * unless free_message = TRUE
+ */
+void free_pending(GSList * entry, gboolean free_message)
+{
+    PendingMessage *pending = entry->data;
+    g_free(pending->protocol);
+    g_free(pending->username);
+    g_free(pending->sender);
+    if (free_message) {
+        g_free(pending->message);
+    }
+    g_free(pending);
+    pending_list = g_slist_remove_link(pending_list, entry);
+}
+
+/**
+ * Purge pending_list of entries older than BOT_MAX_MINUTES minutes
+ */
+void expire_pending_list()
+{
+    const glong max_sec = 60 * BOT_MAX_MINUTES;
+    GTimeVal *now = NULL;
+    now = g_new0(GTimeVal, 1);
+    g_get_current_time(now);
+    GSList *search = NULL;
+    for (search = pending_list; search; search = search->next) {
+        PendingMessage *pending = search->data;
+        if (pending->tv_sec < (now->tv_sec - max_sec)) {
+            free_pending(search, TRUE);
+        }
+    }
+    g_free(now);
+}
+
+/**
  * Print the contents of pending_list to the debug log
  */
 void debug_pending_list()
@@ -153,6 +192,9 @@
 
     GaimConnection *connection = NULL;
 
+    /* expire any old entries in pending */
+    expire_pending_list();
+
     connection = gaim_account_get_connection(account);
 
     /* not good, but don't do anything */
@@ -178,7 +220,7 @@
         }
     }
 
-    /* if there is no question or no answer, allowe the sender */
+    /* if there is no question or no answer, allow the sender */
     const char *question =
         gaim_prefs_get_string("/plugins/core/bot/challenger/question");
     const char *answer =
@@ -192,8 +234,6 @@
         return retval;
     }
 
-    /* ok, now we can actually do someting */
-
     /* search if this sender is already in pending */
     for (search = pending_list; search; search = search->next) {
         pending = search->data;
@@ -205,30 +245,19 @@
             break;
         }
     }
+
     if (!found) {
-            /**
-             * its the first time through, save the nick/msg to the
-             * queue and ask the question
-             */
-        if (pos == 9) {
-            /**
-             * don't track more than 10
-             * add to the end, remove from the beginning
-             */
-            PendingMessage *freepend = NULL;
-            freepend = g_slist_nth_data(pending_list, 0);
-            g_free(freepend->protocol);
-            g_free(freepend->username);
-            g_free(freepend->sender);
-            g_free(freepend->message);
-            g_free(freepend);
-            pending_list =
-                g_slist_remove_link(pending_list,
-                                    g_slist_nth(pending_list, 0));
-        }
+        /**
+         * its the first time through, save the nick/msg to the
+         * queue and ask the question
+         */
+        GTimeVal *now = NULL;
+        now = g_new0(GTimeVal, 1);
+        g_get_current_time(now);
+        PendingMessage *newpend = NULL;
 
-        PendingMessage *newpend = NULL;
         newpend = g_new0(PendingMessage, 1);
+        newpend->tv_sec = now->tv_sec;
         newpend->protocol = g_strdup(account->protocol_id);
         newpend->username = g_strdup(account->username);
         newpend->sender = g_strdup(*sender);
@@ -237,10 +266,11 @@
 
         botmsg =
             g_strdup_printf(_
-                            ("Bot Challenger engaged!  You are now on auto-ignore until you provide the correct answer:  %s"),
-                            question);
+                            ("Bot Challenger engaged:  you are now being ignored!  Your message will be delivered if you can correctly answer the following question within %i minutes:  %s"),
+                            BOT_MAX_MINUTES, question);
         inject_message(account, *sender, botmsg);
 
+        g_free(now);
         g_free(botmsg);
         retval = TRUE;
     } else {
@@ -275,17 +305,13 @@
             *buffer = pending->message;
 
             /* Clean up everything else except pending->message */
-            g_free(pending->protocol);
-            g_free(pending->username);
-            g_free(pending->sender);
-            g_free(pending);
-            pending_list = g_slist_remove_link(pending_list, search);
+            free_pending(search, FALSE);
 
             retval = FALSE;     /* Don't block this message */
         }
     }
     debug_pending_list();
-    return retval;              /* return TRUE to block the IM */
+    return retval;              /* returning TRUE will block the IM */
 }
 
 void gaim_plugin_remove()
@@ -357,13 +383,7 @@
 {
     GSList *search = NULL;
     for (search = pending_list; search; search = search->next) {
-        PendingMessage *pending = search->data;
-        g_free(pending->protocol);
-        g_free(pending->username);
-        g_free(pending->sender);
-        g_free(pending->message);
-        g_free(pending);
-        pending_list = g_slist_remove_link(pending_list, search);
+        free_pending(search, TRUE);
     }
     return TRUE;
 }



From deckrider at sheep.berlios.de  Thu Jun 23 16:06:35 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Thu, 23 Jun 2005 16:06:35 +0200
Subject: [Qrc-svn] r120 - trunk/gaym/src
Message-ID: <200506231406.j5NE6ZuS025316@sheep.berlios.de>

Author: deckrider
Date: 2005-06-23 16:06:28 +0200 (Thu, 23 Jun 2005)
New Revision: 120

Modified:
   trunk/gaym/src/gaym.c
   trunk/gaym/src/gaympriv.c
   trunk/gaym/src/gaympriv.h
   trunk/gaym/src/msgs.c
Log:
- removed option to suppress join/part messages:  this is already
  available in the Extended Preferences (http://gaim-extprefs.sf.net/)
  plugin
- Fixed a corner case where ignored member left chat, user removed
  member from the ignore list, and previously ignored member joined chat


Modified: trunk/gaym/src/gaym.c
===================================================================
--- trunk/gaym/src/gaym.c	2005-06-23 03:32:03 UTC (rev 119)
+++ trunk/gaym/src/gaym.c	2005-06-23 14:06:28 UTC (rev 120)
@@ -1003,14 +1003,8 @@
 
     ppref =
         gaim_plugin_pref_new_with_name_and_label
-        ("/plugins/prpl/gaym/show_join_leave_msgs",
-         _("Show entrance/exit messages"));
-    gaim_plugin_pref_frame_add(frame, ppref);
-
-    ppref =
-        gaim_plugin_pref_new_with_name_and_label
         ("/plugins/prpl/gaym/show_bio_with_join",
-         _("Show bio when entrance messages are shown"));
+         _("Show member bio with entrance announcement"));
     gaim_plugin_pref_frame_add(frame, ppref);
 
     ppref =
@@ -1080,20 +1074,6 @@
         g_list_append(prpl_info.protocol_options, option);
 
     /**
-     * gaim doesn't support suppressing entrance messages
-     */
-    gaim_signal_connect(gaim_conversations_get_handle(),
-                        "chat-buddy-joining", plugin,
-                        GAIM_CALLBACK(gaym_ignore_joining_leaving), NULL);
-
-    /**
-     * gaim doesn't support suppressing exit messages
-     */
-    gaim_signal_connect(gaim_conversations_get_handle(),
-                        "chat-buddy-leaving", plugin,
-                        GAIM_CALLBACK(gaym_ignore_joining_leaving), NULL);
-
-    /**
      * We have to pull thumbnails, since they aren't pushed like with
      * other protocols.
      */
@@ -1103,7 +1083,6 @@
 
     gaim_prefs_add_none("/plugins/prpl/gaym");
     gaim_prefs_add_bool("/plugins/prpl/gaym/show_bio_with_join", TRUE);
-    gaim_prefs_add_bool("/plugins/prpl/gaym/show_join_leave_msgs", TRUE);
     gaim_prefs_add_bool("/plugins/prpl/gaym/only_buddies_can_im", FALSE);
 
     _gaym_plugin = plugin;

Modified: trunk/gaym/src/gaympriv.c
===================================================================
--- trunk/gaym/src/gaympriv.c	2005-06-23 03:32:03 UTC (rev 119)
+++ trunk/gaym/src/gaympriv.c	2005-06-23 14:06:28 UTC (rev 120)
@@ -27,21 +27,6 @@
 #include "gaympriv.h"
 #include "gaym.h"
 
-int gaym_ignore_joining_leaving(GaimConversation * conv, char *name)
-{
-    GaimConnection *gc = gaim_conversation_get_gc(conv);
-    if (!gc) {
-        return 1;
-    }
-    if (!gaim_prefs_get_bool("/plugins/prpl/gaym/show_join_leave_msgs")) {
-        return 1;
-    }
-    if (!gaym_privacy_check(gc, name)) {
-        return 1;
-    }
-    return 0;
-}
-
 gboolean gaym_privacy_check(GaimConnection * gc, const char *nick)
 {
     /**

Modified: trunk/gaym/src/gaympriv.h
===================================================================
--- trunk/gaym/src/gaympriv.h	2005-06-23 03:32:03 UTC (rev 119)
+++ trunk/gaym/src/gaympriv.h	2005-06-23 14:06:28 UTC (rev 120)
@@ -29,17 +29,6 @@
 #include <glib.h>
 
 /**
- * Selectively ignores joining / leaving messages based on GayM
- * preferences and Gaim privacy settings.
- *
- * @param gc   The connection.
- * @param name The user joining or leaving.
- *
- * @return 0 to show the join/leave message, or @c 1 otherwise.
- */
-int gaym_ignore_joining_leaving(GaimConversation * conv, char *name);
-
-/**
  * Check if the account's privacy settings allow or block the user
  * (shamelessly taken from the yahoo prpl).
  *

Modified: trunk/gaym/src/msgs.c
===================================================================
--- trunk/gaym/src/msgs.c	2005-06-23 03:32:03 UTC (rev 119)
+++ trunk/gaym/src/msgs.c	2005-06-23 14:06:28 UTC (rev 120)
@@ -1074,22 +1074,26 @@
             flags = GAIM_CBFLAGS_OP;
     }
 
+    gboolean gaym_privacy_permit = gaym_privacy_check(gc, nick);
+
     if (gaim_prefs_get_bool("/plugins/prpl/gaym/show_bio_with_join")) {
         gaim_conv_chat_add_user(GAIM_CONV_CHAT(convo), nick, bio_markedup,
-                                flags, TRUE);
+                                flags, gaym_privacy_permit);
     } else {
         gaim_conv_chat_add_user(GAIM_CONV_CHAT(convo), nick, NULL,
-                                flags, TRUE);
+                                flags, gaym_privacy_permit);
     }
 
     /**
      * Make the ignore.png icon appear next to the nick.
      */
     GaimConversationUiOps *ops = gaim_conversation_get_ui_ops(convo);
-    if (!gaym_privacy_check(gc, nick)) {
+    if (gaym_privacy_permit) {
+        gaim_conv_chat_unignore(GAIM_CONV_CHAT(convo), nick);
+    } else {
         gaim_conv_chat_ignore(GAIM_CONV_CHAT(convo), nick);
-        ops->chat_update_user((convo), nick);
     }
+    ops->chat_update_user((convo), nick);
 
     if ((ib = g_hash_table_lookup(gaym->buddies, nick)) != NULL) {
         ib->flag = TRUE;
@@ -1223,7 +1227,7 @@
     GaimConnection *gc = gaim_account_get_connection(gaym->account);
     char *nick = gaym_mask_nick(from);
 
-    if (!args || !args[0] || !gc) {
+    if (!args || !args[0] || !gc || !nick) {
         g_free(nick);
         return;
     }
@@ -1240,7 +1244,24 @@
         serv_got_chat_left(gc,
                            gaim_conv_chat_get_id(GAIM_CONV_CHAT(convo)));
     } else {
-        gaim_conv_chat_remove_user(GAIM_CONV_CHAT(convo), nick, NULL);
+        if (gaym_privacy_check(gc, nick)) {
+            gaim_conv_chat_remove_user(GAIM_CONV_CHAT(convo), nick, NULL);
+        } else {
+            GaimConversationUiOps *ops =
+                gaim_conversation_get_ui_ops(convo);
+            if (ops != NULL && ops->chat_remove_user != NULL) {
+                ops->chat_remove_user(convo, nick);
+            }
+            GaimConvChatBuddy *cb =
+                gaim_conv_chat_cb_find(GAIM_CONV_CHAT(convo), nick);
+            if (cb) {
+                gaim_conv_chat_set_users(GAIM_CONV_CHAT(convo),
+                                         g_list_remove
+                                         (gaim_conv_chat_get_users
+                                          (GAIM_CONV_CHAT(convo)), cb));
+                gaim_conv_chat_cb_destroy(cb);
+            }
+        }
     }
 
     g_free(nick);
@@ -1590,10 +1611,12 @@
      * Make the ignore.png icon appear next to the nick.
      */
     GaimConversationUiOps *ops = gaim_conversation_get_ui_ops(convo);
-    if (!gaym_privacy_check(gc, nick)) {
+    if (gaym_privacy_check(gc, nick)) {
+        gaim_conv_chat_unignore(GAIM_CONV_CHAT(convo), nick);
+    } else {
         gaim_conv_chat_ignore(GAIM_CONV_CHAT(convo), nick);
-        ops->chat_update_user((convo), nick);
     }
+    ops->chat_update_user((convo), nick);
 }
 
 /**



From deckrider at sheep.berlios.de  Thu Jun 23 16:20:36 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Thu, 23 Jun 2005 16:20:36 +0200
Subject: [Qrc-svn] r121 - trunk/gaym/src
Message-ID: <200506231420.j5NEKa45029259@sheep.berlios.de>

Author: deckrider
Date: 2005-06-23 16:20:35 +0200 (Thu, 23 Jun 2005)
New Revision: 121

Modified:
   trunk/gaym/src/gaym.c
Log:
Use gaim function to retrieve config.txt, don't hard-code server it is
retrieved from, and add error logging if it cannot be retrieved.


Modified: trunk/gaym/src/gaym.c
===================================================================
--- trunk/gaym/src/gaym.c	2005-06-23 14:06:28 UTC (rev 120)
+++ trunk/gaym/src/gaym.c	2005-06-23 14:20:35 UTC (rev 121)
@@ -357,6 +357,8 @@
     GaimConnection *gc = gaim_account_get_connection(gaym->account);
 
     if (!config_text) {
+        gaim_debug(GAIM_DEBUG_ERROR, "gaym",
+                   "Could not retrieve config.txt.\n");
         return;
     }
     /**
@@ -452,12 +454,21 @@
         }
 
         g_free(buf);
-        const char *roomlisturl =
-            "http://www.gay.com/messenger/config.txt";
-        gaim_session_fetch(roomlisturl, FALSE,
-                           "Mozilla/4.0 (compatible; MSIE 5.0)", FALSE,
-                           gaym_get_configtxt_cb, gaym, gaym->session);
 
+        const char *server = gaim_account_get_string(gc->account, "server",
+                                                     IRC_DEFAULT_SERVER);
+
+        char *url =
+            g_strdup_printf
+            ("http://%s/messenger/config.txt?%s", server, gaym->hash_pw);
+
+        char *user_agent = "Mozilla/4.0";
+
+        gaim_url_fetch(url, FALSE, user_agent, FALSE,
+                       gaym_get_configtxt_cb, gaym);
+
+        g_free(url);
+
         gc->inpa =
             gaim_input_add(gaym->fd, GAIM_INPUT_READ, gaym_input_cb, gc);
     }



From deckrider at sheep.berlios.de  Thu Jun 23 16:28:09 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Thu, 23 Jun 2005 16:28:09 +0200
Subject: [Qrc-svn] r122 - trunk
Message-ID: <200506231428.j5NES9FZ031594@sheep.berlios.de>

Author: deckrider
Date: 2005-06-23 16:28:01 +0200 (Thu, 23 Jun 2005)
New Revision: 122

Modified:
   trunk/README.svn
Log:
Small corrections to README.svn

Modified: trunk/README.svn
===================================================================
--- trunk/README.svn	2005-06-23 14:20:35 UTC (rev 121)
+++ trunk/README.svn	2005-06-23 14:28:01 UTC (rev 122)
@@ -3,13 +3,13 @@
 
    autoreconf --force --install --symlink 
 
-You may need other options, based on the layout of your environment.
+You may need different options, based on the layout of your environment.
 Read the manual or run:
 
    autoreconf --help
 
 Doing the above requires special versions of software, some of which is
-not needed if you use a normal source package (qrc.x.y.z.tar.gz):
+not needed if you use a normal source package (qrc-x.y.z.tar.bz2):
 
    autoconf   2.59a  (not needed by source packages)
    automake   1.9.5  (not needed by source packages)



From deckrider at sheep.berlios.de  Fri Jun 24 02:50:57 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Fri, 24 Jun 2005 02:50:57 +0200
Subject: [Qrc-svn] r123 - trunk/gaym/src
Message-ID: <200506240050.j5O0ovGe012458@sheep.berlios.de>

Author: deckrider
Date: 2005-06-24 02:50:37 +0200 (Fri, 24 Jun 2005)
New Revision: 123

Modified:
   trunk/gaym/src/gaym.c
   trunk/gaym/src/msgs.c
Log:
Added buddy list context menu for 999=* channel types, and a preference
for how many instances to generate/show that affects the roomlist and
this context menu.


Modified: trunk/gaym/src/gaym.c
===================================================================
--- trunk/gaym/src/gaym.c	2005-06-23 14:28:01 UTC (rev 122)
+++ trunk/gaym/src/gaym.c	2005-06-24 00:50:37 UTC (rev 123)
@@ -239,15 +239,57 @@
     return list;
 }
 
-#if 0
+static void gaym_blist_join_chat_cb(GaimBlistNode * node, gpointer data)
+{
+    const char *args[1];
+
+    GaimChat *chat = (GaimChat *) node;
+    struct gaym_conn *gaym = chat->account->gc->proto_data;
+    args[0] = data;
+
+    g_return_if_fail(args[0] != NULL);
+    g_return_if_fail(gaym != NULL);
+
+    gaym_cmd_join(gaym, "join", NULL, args);
+}
+
 static GList *gaym_blist_node_menu(GaimBlistNode * node)
 {
     GList *m = NULL;
-    GaimBlistNodeAction *act;
+    GaimBlistNodeAction *act = NULL;
+    int i = 0;
 
+    if (node->type != GAIM_BLIST_CHAT_NODE) {
+        return m;
+    }
+
+    GaimChat *chat = (GaimChat *) node;
+    char *channel = g_hash_table_lookup(chat->components, "channel");
+
+    if (!channel) {
+        return m;
+    }
+
+    if (!g_str_has_suffix(channel, "=*")) {
+        return m;
+    }
+
+    char *label = NULL;
+    char *instance = NULL;
+
+    int max = gaim_prefs_get_int("/plugins/prpl/gaym/chat_room_instances");
+
+    for (i = 1; i <= max; i++) {
+        label = g_strdup_printf(_("Join Room %d"), i);
+        instance =
+            g_strdup_printf("%.*s%d", strlen(channel) - 1, channel, i);
+        act =
+            gaim_blist_node_action_new(label, gaym_blist_join_chat_cb,
+                                       instance);
+        m = g_list_append(m, act);
+    }
     return m;
 }
-#endif
 
 static GList *gaym_chat_join_info(GaimConnection * gc)
 {
@@ -925,7 +967,7 @@
     NULL,                       /* status_text */
     NULL,                       /* tooltip_text */
     gaym_away_states,           /* away_states */
-    NULL,                       /* blist_node_menu */
+    gaym_blist_node_menu,       /* blist_node_menu */
     gaym_chat_join_info,        /* chat_info */
     gaym_chat_info_defaults,    /* chat_info_defaults */
     gaym_login,                 /* login */
@@ -1019,6 +1061,13 @@
     gaim_plugin_pref_frame_add(frame, ppref);
 
     ppref =
+        gaim_plugin_pref_new_with_name_and_label
+        ("/plugins/prpl/gaym/chat_room_instances",
+         _("Number of chat room instances to display"));
+    gaim_plugin_pref_set_bounds(ppref, 0, 9);
+    gaim_plugin_pref_frame_add(frame, ppref);
+
+    ppref =
         gaim_plugin_pref_new_with_label(_
                                         ("Instant Messages (stricter privacy settings override these)"));
     gaim_plugin_pref_frame_add(frame, ppref);
@@ -1093,6 +1142,7 @@
                         GAIM_CALLBACK(gaym_get_photo_info), NULL);
 
     gaim_prefs_add_none("/plugins/prpl/gaym");
+    gaim_prefs_add_int("/plugins/prpl/gaym/chat_room_instances", 4);
     gaim_prefs_add_bool("/plugins/prpl/gaym/show_bio_with_join", TRUE);
     gaim_prefs_add_bool("/plugins/prpl/gaym/only_buddies_can_im", FALSE);
 

Modified: trunk/gaym/src/msgs.c
===================================================================
--- trunk/gaym/src/msgs.c	2005-06-23 14:28:01 UTC (rev 122)
+++ trunk/gaym/src/msgs.c	2005-06-24 00:50:37 UTC (rev 123)
@@ -385,7 +385,7 @@
         return;
     }
     /**
-     * The list of member created room
+     * The list of member created rooms
      */
     if (!strcmp(name, "322")) {
         GaimRoomlistRoom *room;
@@ -473,6 +473,9 @@
         char *name_inst = NULL;
         char *num_inst = NULL;
 
+        int max =
+            gaim_prefs_get_int("/plugins/prpl/gaym/chat_room_instances");
+
         if (!gaym->configtxt) {
             gaim_debug_fatal("gaym",
                              "Room list parsing error: No config webpage\n");
@@ -592,7 +595,7 @@
                      * and now the room instances (1, 2, 3 ...)
                      */
                     room_inst = 0;
-                    for (room_inst = 1; room_inst <= 4; room_inst++) {
+                    for (room_inst = 1; room_inst <= max; room_inst++) {
                         name_inst =
                             g_strdup_printf("%s:%i", name, room_inst);
                         num_inst = g_strdup_printf("%s%i", num, room_inst);



From deckrider at sheep.berlios.de  Fri Jun 24 15:25:29 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Fri, 24 Jun 2005 15:25:29 +0200
Subject: [Qrc-svn] r124 - trunk/bot-challenger
Message-ID: <200506241325.j5ODPSJe026509@sheep.berlios.de>

Author: deckrider
Date: 2005-06-24 15:25:28 +0200 (Fri, 24 Jun 2005)
New Revision: 124

Modified:
   trunk/bot-challenger/bot-challenger.c
Log:
Disconnect signals during plugin_unload(), and add note for encryption
plugin users.


Modified: trunk/bot-challenger/bot-challenger.c
===================================================================
--- trunk/bot-challenger/bot-challenger.c	2005-06-24 00:50:37 UTC (rev 123)
+++ trunk/bot-challenger/bot-challenger.c	2005-06-24 13:25:28 UTC (rev 124)
@@ -381,10 +381,13 @@
 
 static gboolean plugin_unload(GaimPlugin * plugin)
 {
+    gaim_signals_disconnect_by_handle(plugin);
+
     GSList *search = NULL;
     for (search = pending_list; search; search = search->next) {
         free_pending(search, TRUE);
     }
+
     return TRUE;
 }
 
@@ -404,7 +407,7 @@
                                                           /**  summary        */
     N_("Block robots from sending Instant Messages"),
                                                           /**  description    */
-    N_("A simple challenge-response system to prevent spam-bots from sending you instant messages.  Think of it as a pop-up blocker.  You define a question and an answer.  Instant messages from others will be ignored unless one of the following is true:\n\n\t* the sender is in your Buddy List\n\t* the sender is in your Allow List\n\t* the sender correctly answers your question\n\nOptionally, you may have the sender automatically added to your Allow List when the correct answer is provided."),
+    N_("A simple challenge-response system to prevent spam-bots from sending you instant messages.  Think of it as a pop-up blocker.  You define a question and an answer.  Instant messages from others will be ignored unless one of the following is true:\n\n\t* the sender is in your Buddy List\n\t* the sender is in your Allow List\n\t* the sender correctly answers your question\n\nOptionally, you may have the sender automatically added to your Allow List when the correct answer is provided.\n\nEncryption plugin users:  Bot Challenger will send plain text messages to the sender until the sender correctly answers your question."),
     "David Everly <deckrider at gmail.com>",                 /**< author         */
     "http://developer.berlios.de/projects/qrc/",          /**< homepage       */
 



From deckrider at sheep.berlios.de  Sat Jun 25 14:23:37 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Sat, 25 Jun 2005 14:23:37 +0200
Subject: [Qrc-svn] r125 - trunk/gaym/src
Message-ID: <200506251223.j5PCNbcC029260@sheep.berlios.de>

Author: deckrider
Date: 2005-06-25 14:23:36 +0200 (Sat, 25 Jun 2005)
New Revision: 125

Modified:
   trunk/gaym/src/msgs.c
Log:
No need to do the entire privacy check again when the user parts the
channel.  Run gaim_conv_chat_is_user_ignored() instead.


Modified: trunk/gaym/src/msgs.c
===================================================================
--- trunk/gaym/src/msgs.c	2005-06-24 13:25:28 UTC (rev 124)
+++ trunk/gaym/src/msgs.c	2005-06-25 12:23:36 UTC (rev 125)
@@ -1247,7 +1247,7 @@
         serv_got_chat_left(gc,
                            gaim_conv_chat_get_id(GAIM_CONV_CHAT(convo)));
     } else {
-        if (gaym_privacy_check(gc, nick)) {
+        if (!gaim_conv_chat_is_user_ignored(GAIM_CONV_CHAT(convo), nick)) {
             gaim_conv_chat_remove_user(GAIM_CONV_CHAT(convo), nick, NULL);
         } else {
             GaimConversationUiOps *ops =



From deckrider at sheep.berlios.de  Sat Jun 25 19:21:42 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Sat, 25 Jun 2005 19:21:42 +0200
Subject: [Qrc-svn] r126 - trunk/gaym/src
Message-ID: <200506251721.j5PHLg6G030123@sheep.berlios.de>

Author: deckrider
Date: 2005-06-25 19:21:33 +0200 (Sat, 25 Jun 2005)
New Revision: 126

Added:
   trunk/gaym/src/botfilter.c
   trunk/gaym/src/botfilter.h
Modified:
   trunk/gaym/src/Makefile.am
   trunk/gaym/src/gaym.c
   trunk/gaym/src/gaympriv.c
   trunk/gaym/src/msgs.c
Log:
Commit of "Bio-Based Chat Room Activity Filtering" patch as a temporary
measure to facilitate a near-term interim release of qrc.


Modified: trunk/gaym/src/Makefile.am
===================================================================
--- trunk/gaym/src/Makefile.am	2005-06-25 12:23:36 UTC (rev 125)
+++ trunk/gaym/src/Makefile.am	2005-06-25 17:21:33 UTC (rev 126)
@@ -2,6 +2,8 @@
 	$(GAIM_LIBDIR)/gaim
 
 GAYMSOURCES = \
+	botfilter.c \
+	botfilter.h \
 	cmds.c \
 	configtxt.c \
 	configtxt.h \

Added: trunk/gaym/src/botfilter.c
===================================================================
--- trunk/gaym/src/botfilter.c	2005-06-25 12:23:36 UTC (rev 125)
+++ trunk/gaym/src/botfilter.c	2005-06-25 17:21:33 UTC (rev 126)
@@ -0,0 +1,145 @@
+/**
+ * GayM
+ *
+ * GayM is the legal property of its developers, whose names are too numerous
+ * to list here.  Please refer to the COPYRIGHT file distributed with this
+ * source distribution.
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License
+ * along with this program; if not, write to the Free Software
+ * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ */
+#include "prefs.h"
+#include "util.h"
+#include "debug.h"
+
+#include "botfilter.h"
+
+typedef struct _FilteredBot FilteredBot;
+struct _FilteredBot {
+    char *username;
+    /**
+     * We may need the following later:
+     *
+     * char *bio;
+     */
+};
+static GSList *filtered_bots = NULL;    /* GSList of FilteredBot */
+
+void update_filtered_bots(const char *nick, gboolean permitted)
+{
+    GSList *search = NULL;
+    gboolean found = FALSE;
+    for (search = filtered_bots; search; search = search->next) {
+        FilteredBot *bot = search->data;
+        if (!gaim_utf8_strcasecmp(bot->username, nick)) {
+            found = TRUE;
+            break;
+        }
+    }
+
+    if (permitted) {
+        if (found) {
+            FilteredBot *bot = search->data;
+            g_free(bot->username);
+            g_free(bot);
+            filtered_bots = g_slist_remove_link(filtered_bots, search);
+        }
+    } else {
+        if (!found) {
+            FilteredBot *bot = g_new0(FilteredBot, 1);
+            bot->username = g_strdup(nick);
+            filtered_bots = g_slist_append(filtered_bots, bot);
+        }
+    }
+}
+
+gboolean gaym_botfilter_check(GaimConnection * gc, const char *nick,
+                              const char *text,
+                              gboolean gaym_privacy_change)
+{
+    /**
+     * returns TRUE if allowed through, FALSE otherwise
+     */
+    gboolean permitted = TRUE;
+    int i = 0;
+
+    if (!gaim_prefs_get_bool("/plugins/prpl/gaym/botfilter_enable")) {
+        permitted = TRUE;
+        update_filtered_bots(nick, permitted);
+        return permitted;
+    }
+
+    if (!gaim_utf8_strcasecmp(gc->account->username, nick)) {
+        permitted = TRUE;
+        gaim_debug_info("gaym", "declining to block/ignore self\n");
+        update_filtered_bots(nick, permitted);
+        return permitted;
+    }
+
+    /**
+     * prevent gaim privacy changes from affecting previously
+     * filtered bots
+     */
+    if (gaym_privacy_change) {
+        permitted = TRUE;
+        GSList *search = NULL;
+        for (search = filtered_bots; search; search = search->next) {
+            FilteredBot *bot = search->data;
+            if (!gaim_utf8_strcasecmp(bot->username, nick)) {
+                permitted = FALSE;
+                break;
+            }
+        }
+        return permitted;
+    }
+
+    if (!text) {
+        if (gaim_prefs_get_bool
+            ("/plugins/prpl/gaym/botfilter_ignore_null")) {
+            permitted = FALSE;
+        } else {
+            permitted = TRUE;
+        }
+        update_filtered_bots(nick, permitted);
+        return permitted;
+    }
+
+    const char *sep =
+        gaim_prefs_get_string("/plugins/prpl/gaym/botfilter_sep");
+    const char *patterns =
+        gaim_prefs_get_string("/plugins/prpl/gaym/botfilter_patterns");
+    if (!sep || !patterns) {
+        permitted = TRUE;
+        update_filtered_bots(nick, permitted);
+        return permitted;
+    }
+
+    gchar **pattern_list = g_strsplit(patterns, sep, 0);
+
+    for (i = 0; pattern_list[i] != NULL; i++) {
+        if (g_pattern_match_simple(pattern_list[i], text)) {
+            permitted = FALSE;
+            break;
+        }
+    }
+    g_strfreev(pattern_list);
+
+    update_filtered_bots(nick, permitted);
+
+    return permitted;
+}
+
+/**
+ * vim:tabstop=4:shiftwidth=4:expandtab:
+ */

Added: trunk/gaym/src/botfilter.h
===================================================================
--- trunk/gaym/src/botfilter.h	2005-06-25 12:23:36 UTC (rev 125)
+++ trunk/gaym/src/botfilter.h	2005-06-25 17:21:33 UTC (rev 126)
@@ -0,0 +1,49 @@
+/**
+ * @file botfilter.h GayM Bot Filter API
+ *
+ * GayM
+ *
+ * GayM is the legal property of its developers, whose names are too numerous
+ * to list here.  Please refer to the COPYRIGHT file distributed with this
+ * source distribution.
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License
+ * along with this program; if not, write to the Free Software
+ * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ */
+#ifndef _GAIM_GAYM_BOTFILTER_H_
+#define _GAIM_GAYM_BOTFILTER_H_
+
+#include "connection.h"
+
+#include <glib.h>
+
+/**
+ * Check if the account's botfilter settings allow or block the text
+ *
+ * @param gc                  The connection.
+ * @param nick                The user to check.
+ * @param text                The text to check.
+ * @param gaym_privacy_change Invoked from gaym_privacy_change().
+ *
+ * @return TRUE if the user is allowed, or @c FALSE otherwise.
+ */
+gboolean gaym_botfilter_check(GaimConnection * gc, const char *nick,
+                              const char *text,
+                              gboolean gaym_privacy_change);
+
+#endif                          /* _GAIM_GAYM_BOTFILTER_H_ */
+
+/**
+ * vim:tabstop=4:shiftwidth=4:expandtab:
+ */

Modified: trunk/gaym/src/gaym.c
===================================================================
--- trunk/gaym/src/gaym.c	2005-06-25 12:23:36 UTC (rev 125)
+++ trunk/gaym/src/gaym.c	2005-06-25 17:21:33 UTC (rev 126)
@@ -1069,6 +1069,36 @@
 
     ppref =
         gaim_plugin_pref_new_with_label(_
+                                        ("Bio-Based Chat Room Activity Filtering"));
+    gaim_plugin_pref_frame_add(frame, ppref);
+
+    ppref =
+        gaim_plugin_pref_new_with_name_and_label
+        ("/plugins/prpl/gaym/botfilter_enable", _("Enable"));
+    gaim_plugin_pref_frame_add(frame, ppref);
+
+    ppref =
+        gaim_plugin_pref_new_with_name_and_label
+        ("/plugins/prpl/gaym/botfilter_ignore_null",
+         _("Ignore if bio is blank"));
+    gaim_plugin_pref_frame_add(frame, ppref);
+
+    ppref =
+        gaim_plugin_pref_new_with_name_and_label
+        ("/plugins/prpl/gaym/botfilter_patterns",
+         _
+         ("Ignore if bio contains these patterns\n\t? = match any single character\n\t* = match zero, one, or more"));
+    gaim_plugin_pref_frame_add(frame, ppref);
+
+    ppref =
+        gaim_plugin_pref_new_with_name_and_label
+        ("/plugins/prpl/gaym/botfilter_sep",
+         _("Above patterns are separated by"));
+    gaim_plugin_pref_set_max_length(ppref, 1);
+    gaim_plugin_pref_frame_add(frame, ppref);
+
+    ppref =
+        gaim_plugin_pref_new_with_label(_
                                         ("Instant Messages (stricter privacy settings override these)"));
     gaim_plugin_pref_frame_add(frame, ppref);
 
@@ -1146,6 +1176,12 @@
     gaim_prefs_add_bool("/plugins/prpl/gaym/show_bio_with_join", TRUE);
     gaim_prefs_add_bool("/plugins/prpl/gaym/only_buddies_can_im", FALSE);
 
+    gaim_prefs_add_bool("/plugins/prpl/gaym/botfilter_enable", FALSE);
+    gaim_prefs_add_bool("/plugins/prpl/gaym/botfilter_ignore_null", FALSE);
+    gaim_prefs_add_string("/plugins/prpl/gaym/botfilter_sep", "|");
+    gaim_prefs_add_string("/plugins/prpl/gaym/botfilter_patterns",
+                          "NULL|MODE * -i|*dantcamboy*|*Free preview*|*epowerchat*|*Live gay sex cam show*|*camboiz*|*gaysplender.com*|*longschlong.com*|*levitra4all*|*facelink.ws*|*robofucker*|*ironflesh*|*bargaindujour*|*squiby.com*|*jc__32d*|*texaslonghorn21*|*gaycom.ws*|*h0rnydolls*|*allgaycom*|*hotnakedmen.com*|*gay-dar.net*|*twinks4you.com*|*toysanddildos.com*|*twinkplayground*|*hisrx.com*|*itrick.org*|*abelive.com*|*hornyd0lls*|*adultmodeling1.com*|*pornxxxporno.com*|*gayloves.com*|*gayonlinevideos.com*|*grandpaspup.4t.com*|*naughtysingles*|*ruckis.com*|*moan.at/*|*rainbowmeds.com*|*genxxxohio.com*|*deep.at*|*allgaycam.com*|*sweatyman.com*|*midwestxbois2003*|*fun4sale*|*wwwlookin-goodcom*|*sex3xsuperstore.com*|*turnedon.by/*|*hornyjock.com*|*camsguys.com*|*dirty-homepages.com*|*squirt.to*|*sugarboys*|*hairyfetishes.com*|*manzones.com*|*amateurstraightguys.com*|*funfirm.com*|*emil.virtue.nu*|*mywebpages.comcast.net/allaboutjae*|*guyshome.com*|*poppermart.com*|*assncoc!
 ks.com*|*twinkvillage.com*|*beercancock.com*|*2n1.net*|*medicineville.com*|*1stoptoys.com*|*cheappornnow.com*|*sexvids.150m.com*|*lookin-good.com*|*phelan-reunites-lovers.com*|*cowboy-style.com*|*burn.at/mypage*|*xxxmalemodels.com*|*jeffreys-place.com*|*mygaystuff.com*|*hornydolls.com*|*gayfreepicture.com*|*gayadultdvds.com*|*dvds.ne1.net*|*www.hot-sex.virtue.nu*|*gaypornfilms.com*|*2r4.com*|*hotmuscleboy.com*|*gayandproud.cjb.net*|*match.20fr.com*|*callbois4hire*|*fantasyboynyc*|*celebrityboiz*|*ratefun.com*|*callboisforhire*|*hot-cop.150m.com*|*pornboismanagement*|*trip0d*|*poppers4sale*|*ohghurl.com*|*www.h0rnydo*|*hung-jock.com*|*queerkid.com*|*beachguys.com*|*gay-teens.com*|*cutelad-uk*|*dicknetwork*|*my-gay-site*|*bondage4u.com*|*sorta__differentt*|*jock_forhookup*|*bestispdeal*|*dude_withcam*|*blatinothugs*|*gaypornpictures*|*bi_jock*|*dudedormpictures*|*earthtwink*|*escorts4unorfolk*|*menchats.com*|*gayvideovillage.com*|*angelfire.com*|*justin19freshman@*|*ge0cities!
 *|*freegaypix.com*|*cheap-gay-videos.com*|*man-sluts.com*|*sla!
 terreed.
com*|*boysoncam*|*gaypornopalace.com*|*gayzgood*|*fastdental*|*gayamateurworld*|*contax.150m*|*tekknick.com/itrick*|*onlinegayvideo*|*gay-connectdotnet*|*southernguyz*|*horny_stud_923*|*jock_for_hookup_9284*|*1stopcommunication*|*godsit*|*hung_meat_3796*|*big_collegecock_*|*aaronklinestudios*|*brownbuns*|*gayavenue*|*ukguyz*|*ozneworleans*|*bestviagra*|*bryanmartinonline*|*trafficsurvivor*|*wc1_18rentboy*|*fit-guy-n15*|*babyfacedtop*|*cameran23*|*hardick.co.uk*|*poppersexpress*|*dudepages*|*earthtwinks*|*wayofthemaster*|*outpersonals*|*pegasuspittsburgh*|*damienstevens*|*everythingundertherainbow*|*barebackflix*|*knightboyz*|*bbppv*|*biz-wise*|*boysonwebcam*|*xtremelygay*|*nudewebcamboys*|*czechboys*|*roksworld*|*4genericdrugs*|*justgay*|*http://home.bellsouth.net/p/s/community.dll?ep=16&groupid=237194&ck=*|*ddlworld*|*istarthere*|*igetnet*|*sahagent*|*bigebonystuds*|*bigasscock*|*4genericdrug*|*pigsinc*|*cknoway*|*m-cams*|*Orlandoflaboi80.4t.com*|*mailboxcocks.com*|*gaystre!
 amingvideos*|*bigmanmeat.com*|*bryanbanks*|*want2vote*|*icamsonline.com*|*successfulpeople.com*|*cockoncam*|*terra.es*|*fastsizenow*|*camsonline*|*tripod*|*freemuscledvd.com*|*gayxxxdvds*|*last36hours*|*sacbodymud.com*|*corycam*|*ryanproject*|*blackgaymen.net*|*xxxgaysuperstore*|*male4malesex.com*");
+
     _gaym_plugin = plugin;
 
     gaym_register_commands();

Modified: trunk/gaym/src/gaympriv.c
===================================================================
--- trunk/gaym/src/gaympriv.c	2005-06-25 12:23:36 UTC (rev 125)
+++ trunk/gaym/src/gaympriv.c	2005-06-25 17:21:33 UTC (rev 126)
@@ -25,6 +25,7 @@
 #include "util.h"
 
 #include "gaympriv.h"
+#include "botfilter.h"
 #include "gaym.h"
 
 gboolean gaym_privacy_check(GaimConnection * gc, const char *nick)
@@ -139,7 +140,9 @@
                 gaim_conversation_get_ui_ops(convo);
             if (name) {
                 if (!gaim_utf8_strcasecmp(name, buddy->name)) {
-                    if (gaym_privacy_check(gc, buddy->name)) {
+                    if (gaym_privacy_check(gc, buddy->name)
+                        && gaym_botfilter_check(gc, buddy->name, NULL,
+                                                TRUE)) {
                         gaim_conv_chat_unignore(GAIM_CONV_CHAT(convo),
                                                 buddy->name);
                     } else {
@@ -149,7 +152,8 @@
                     ops->chat_update_user((convo), buddy->name);
                 }
             } else {
-                if (gaym_privacy_check(gc, buddy->name)) {
+                if (gaym_privacy_check(gc, buddy->name)
+                    && gaym_botfilter_check(gc, buddy->name, NULL, TRUE)) {
                     gaim_conv_chat_unignore(GAIM_CONV_CHAT(convo),
                                             buddy->name);
                 } else {

Modified: trunk/gaym/src/msgs.c
===================================================================
--- trunk/gaym/src/msgs.c	2005-06-25 12:23:36 UTC (rev 125)
+++ trunk/gaym/src/msgs.c	2005-06-25 17:21:33 UTC (rev 126)
@@ -35,6 +35,7 @@
 
 #include "helpers.h"
 #include "gaympriv.h"
+#include "botfilter.h"
 #include "gaym.h"
 
 /**
@@ -1064,6 +1065,8 @@
     }
 
     bio = gaym_mask_bio(args[1]);
+    gboolean gaym_botfilter_permit =
+        gaym_botfilter_check(gc, nick, bio, FALSE);
 
     if (bio) {
         bio_markedup = gaim_markup_linkify(bio);
@@ -1081,17 +1084,19 @@
 
     if (gaim_prefs_get_bool("/plugins/prpl/gaym/show_bio_with_join")) {
         gaim_conv_chat_add_user(GAIM_CONV_CHAT(convo), nick, bio_markedup,
-                                flags, gaym_privacy_permit);
+                                flags, (gaym_privacy_permit
+                                        && gaym_botfilter_permit));
     } else {
         gaim_conv_chat_add_user(GAIM_CONV_CHAT(convo), nick, NULL,
-                                flags, gaym_privacy_permit);
+                                flags, (gaym_privacy_permit
+                                        && gaym_botfilter_permit));
     }
 
     /**
      * Make the ignore.png icon appear next to the nick.
      */
     GaimConversationUiOps *ops = gaim_conversation_get_ui_ops(convo);
-    if (gaym_privacy_permit) {
+    if (gaym_privacy_permit && gaym_botfilter_permit) {
         gaim_conv_chat_unignore(GAIM_CONV_CHAT(convo), nick);
     } else {
         gaim_conv_chat_ignore(GAIM_CONV_CHAT(convo), nick);
@@ -1591,10 +1596,13 @@
 
     convo = gaim_find_conversation_with_account(channel, gaym->account);
 
-    /**
-     * gaym_bot_detect(gaym_mask_bio(extra), convo, nick);
-     */
+    char *masked_bio = gaym_mask_bio(extra);
 
+    gboolean gaym_botfilter_permit =
+        gaym_botfilter_check(gc, nick, masked_bio, FALSE);
+
+    g_free(masked_bio);
+
     if (convo == NULL) {
         gaim_debug(GAIM_DEBUG_ERROR, "gaym", "690 for %s failed\n",
                    args[1]);
@@ -1614,7 +1622,7 @@
      * Make the ignore.png icon appear next to the nick.
      */
     GaimConversationUiOps *ops = gaim_conversation_get_ui_ops(convo);
-    if (gaym_privacy_check(gc, nick)) {
+    if (gaym_privacy_check(gc, nick) && gaym_botfilter_permit) {
         gaim_conv_chat_unignore(GAIM_CONV_CHAT(convo), nick);
     } else {
         gaim_conv_chat_ignore(GAIM_CONV_CHAT(convo), nick);



From deckrider at sheep.berlios.de  Mon Jun 27 01:13:50 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Mon, 27 Jun 2005 01:13:50 +0200
Subject: [Qrc-svn] r127 - trunk/gaym/src
Message-ID: <200506262313.j5QNDoDW012306@sheep.berlios.de>

Author: deckrider
Date: 2005-06-27 01:13:34 +0200 (Mon, 27 Jun 2005)
New Revision: 127

Modified:
   trunk/gaym/src/botfilter.c
   trunk/gaym/src/botfilter.h
   trunk/gaym/src/gaym.c
Log:
Added utilization of GayBoi's spam list.  Thanks to
evan at coolrunningconcepts.com for the idea and some code to look at.


Modified: trunk/gaym/src/botfilter.c
===================================================================
--- trunk/gaym/src/botfilter.c	2005-06-25 17:21:33 UTC (rev 126)
+++ trunk/gaym/src/botfilter.c	2005-06-26 23:13:34 UTC (rev 127)
@@ -25,6 +25,9 @@
 
 #include "botfilter.h"
 
+/* 1 day */
+#define MIN_CHECK_INTERVAL 60 * 60 * 24
+
 typedef struct _FilteredBot FilteredBot;
 struct _FilteredBot {
     char *username;
@@ -119,20 +122,41 @@
         gaim_prefs_get_string("/plugins/prpl/gaym/botfilter_sep");
     const char *patterns =
         gaim_prefs_get_string("/plugins/prpl/gaym/botfilter_patterns");
-    if (!sep || !patterns) {
+    const char *gayboi_patterns =
+        gaim_prefs_get_string("/plugins/prpl/gaym/botfilter_url_result");
+
+    if (!sep || !gaim_utf8_strcasecmp(sep, "")
+        || ((!patterns || !gaim_utf8_strcasecmp(patterns, ""))
+            && (!gayboi_patterns
+                || !gaim_utf8_strcasecmp(gayboi_patterns, "")))) {
         permitted = TRUE;
         update_filtered_bots(nick, permitted);
         return permitted;
     }
 
-    gchar **pattern_list = g_strsplit(patterns, sep, 0);
+    char *combined = NULL;
+    if (patterns && gaim_utf8_strcasecmp(patterns, "") && gayboi_patterns
+        && gaim_utf8_strcasecmp(gayboi_patterns, "")) {
+        combined = g_strdup_printf("%s|%s", patterns, gayboi_patterns);
+    } else {
+        if (patterns && gaim_utf8_strcasecmp(patterns, "")) {
+            combined = g_strdup_printf("%s", patterns);
+        } else if (gayboi_patterns
+                   && gaim_utf8_strcasecmp(gayboi_patterns, "")) {
+            combined = g_strdup_printf("%s", gayboi_patterns);
+        }
+    }
 
+
+    gchar **pattern_list = g_strsplit(combined, sep, 0);
+
     for (i = 0; pattern_list[i] != NULL; i++) {
         if (g_pattern_match_simple(pattern_list[i], text)) {
             permitted = FALSE;
             break;
         }
     }
+    g_free(combined);
     g_strfreev(pattern_list);
 
     update_filtered_bots(nick, permitted);
@@ -140,6 +164,83 @@
     return permitted;
 }
 
+void process_spamlist_from_web_cb(void *data, const char *result,
+                                  size_t len)
+{
+    if (!result) {
+        gaim_prefs_set_string("/plugins/prpl/gaym/botfilter_url_result",
+                              "");
+        return;
+    }
+    if (!g_str_has_prefix(result, "<HTML>\n")) {
+        gaim_prefs_set_string("/plugins/prpl/gaym/botfilter_url_result",
+                              "");
+        return;
+    }
+    if (!g_str_has_suffix(result, "</HTML>")) {
+        gaim_prefs_set_string("/plugins/prpl/gaym/botfilter_url_result",
+                              "");
+        return;
+    }
+    const char *sep =
+        gaim_prefs_get_string("/plugins/prpl/gaym/botfilter_sep");
+    if (!sep || !gaim_utf8_strcasecmp(sep, "")) {
+        gaim_prefs_set_string("/plugins/prpl/gaym/botfilter_url_result",
+                              "");
+        return;
+    }
+    char *html_stripped = gaim_markup_strip_html(result);
+    char *stripped = g_strstrip(html_stripped);
+    char **split = g_strsplit(stripped, "\n ", 0);
+    char *starsep = g_strdup_printf("*%s*", sep);
+    char *joined = g_strjoinv(starsep, split);
+    char *url_result = g_strdup_printf("*%s*", joined);
+
+    gaim_prefs_set_string("/plugins/prpl/gaym/botfilter_url_result",
+                          url_result);
+
+    g_free(url_result);
+    g_free(joined);
+    g_free(starsep);
+    g_strfreev(split);
+    g_free(html_stripped);
+}
+
+void get_spamlist_from_web(void)
+{
+    char *user_agent = "Mozilla/4.0";
+
+    const char *url =
+        gaim_prefs_get_string("/plugins/prpl/gaym/botfilter_url");
+    if (!url || !gaim_utf8_strcasecmp(url, "")) {
+        gaim_prefs_set_string("/plugins/prpl/gaym/botfilter_url_result",
+                              "");
+        return;
+    }
+
+    int last_check =
+        gaim_prefs_get_int("/plugins/prpl/gaym/botfilter_url_last_check");
+    const char *result =
+        gaim_prefs_get_string("/plugins/prpl/gaym/botfilter_url_result");
+
+
+    if (!last_check || !result || !gaim_utf8_strcasecmp(result, "")
+        || time(NULL) - last_check > MIN_CHECK_INTERVAL) {
+        gaim_prefs_set_int("/plugins/prpl/gaym/botfilter_url_last_check",
+                           time(NULL));
+        gaim_url_fetch(url, FALSE, user_agent, FALSE,
+                       process_spamlist_from_web_cb, NULL);
+    }
+
+    return;
+}
+
+void botfilter_url_changed_cb(const char *name, GaimPrefType type,
+                              gpointer value, gpointer data)
+{
+    gaim_prefs_set_int("/plugins/prpl/gaym/botfilter_url_last_check", 0);
+}
+
 /**
  * vim:tabstop=4:shiftwidth=4:expandtab:
  */

Modified: trunk/gaym/src/botfilter.h
===================================================================
--- trunk/gaym/src/botfilter.h	2005-06-25 17:21:33 UTC (rev 126)
+++ trunk/gaym/src/botfilter.h	2005-06-26 23:13:34 UTC (rev 127)
@@ -42,6 +42,16 @@
                               const char *text,
                               gboolean gaym_privacy_change);
 
+ /**
+ * Get GayBoi's spam list from his website.  Since this is for the plugin
+ * and not for any certain account, it should be done when the plugin
+ * is loaded.
+ */
+void get_spamlist_from_web(void);
+
+void botfilter_url_changed_cb(const char *name, GaimPrefType type,
+                              gpointer value, gpointer data);
+
 #endif                          /* _GAIM_GAYM_BOTFILTER_H_ */
 
 /**

Modified: trunk/gaym/src/gaym.c
===================================================================
--- trunk/gaym/src/gaym.c	2005-06-25 17:21:33 UTC (rev 126)
+++ trunk/gaym/src/gaym.c	2005-06-26 23:13:34 UTC (rev 127)
@@ -39,8 +39,11 @@
 #include "helpers.h"
 #include "gaympriv.h"
 #include "configtxt.h"
+#include "botfilter.h"
 #include "gaym.h"
 
+#define GAYBOI_SPAM_URL "http://gayboi.org/spam/spamlst.php"
+
 char *gaym_mask_bio(const char *biostring);
 static const char *gaym_blist_icon(GaimAccount * a, GaimBuddy * b);
 static void gaym_blist_emblems(GaimBuddy * b, char **se, char **sw,
@@ -506,6 +509,7 @@
 
         char *user_agent = "Mozilla/4.0";
 
+        get_spamlist_from_web();
         gaim_url_fetch(url, FALSE, user_agent, FALSE,
                        gaym_get_configtxt_cb, gaym);
 
@@ -1098,6 +1102,14 @@
     gaim_plugin_pref_frame_add(frame, ppref);
 
     ppref =
+        gaim_plugin_pref_new_with_name_and_label
+        ("/plugins/prpl/gaym/botfilter_url",
+         _
+         ("URL for GayBoi's spam database\n\tblank to disable\n\tchanges affect next login\n\tdefault is "
+          GAYBOI_SPAM_URL));
+    gaim_plugin_pref_frame_add(frame, ppref);
+
+    ppref =
         gaim_plugin_pref_new_with_label(_
                                         ("Instant Messages (stricter privacy settings override these)"));
     gaim_plugin_pref_frame_add(frame, ppref);
@@ -1180,8 +1192,16 @@
     gaim_prefs_add_bool("/plugins/prpl/gaym/botfilter_ignore_null", FALSE);
     gaim_prefs_add_string("/plugins/prpl/gaym/botfilter_sep", "|");
     gaim_prefs_add_string("/plugins/prpl/gaym/botfilter_patterns",
-                          "NULL|MODE * -i|*dantcamboy*|*Free preview*|*epowerchat*|*Live gay sex cam show*|*camboiz*|*gaysplender.com*|*longschlong.com*|*levitra4all*|*facelink.ws*|*robofucker*|*ironflesh*|*bargaindujour*|*squiby.com*|*jc__32d*|*texaslonghorn21*|*gaycom.ws*|*h0rnydolls*|*allgaycom*|*hotnakedmen.com*|*gay-dar.net*|*twinks4you.com*|*toysanddildos.com*|*twinkplayground*|*hisrx.com*|*itrick.org*|*abelive.com*|*hornyd0lls*|*adultmodeling1.com*|*pornxxxporno.com*|*gayloves.com*|*gayonlinevideos.com*|*grandpaspup.4t.com*|*naughtysingles*|*ruckis.com*|*moan.at/*|*rainbowmeds.com*|*genxxxohio.com*|*deep.at*|*allgaycam.com*|*sweatyman.com*|*midwestxbois2003*|*fun4sale*|*wwwlookin-goodcom*|*sex3xsuperstore.com*|*turnedon.by/*|*hornyjock.com*|*camsguys.com*|*dirty-homepages.com*|*squirt.to*|*sugarboys*|*hairyfetishes.com*|*manzones.com*|*amateurstraightguys.com*|*funfirm.com*|*emil.virtue.nu*|*mywebpages.comcast.net/allaboutjae*|*guyshome.com*|*poppermart.com*|*assncoc!
 ks.com*|*twinkvillage.com*|*beercancock.com*|*2n1.net*|*medicineville.com*|*1stoptoys.com*|*cheappornnow.com*|*sexvids.150m.com*|*lookin-good.com*|*phelan-reunites-lovers.com*|*cowboy-style.com*|*burn.at/mypage*|*xxxmalemodels.com*|*jeffreys-place.com*|*mygaystuff.com*|*hornydolls.com*|*gayfreepicture.com*|*gayadultdvds.com*|*dvds.ne1.net*|*www.hot-sex.virtue.nu*|*gaypornfilms.com*|*2r4.com*|*hotmuscleboy.com*|*gayandproud.cjb.net*|*match.20fr.com*|*callbois4hire*|*fantasyboynyc*|*celebrityboiz*|*ratefun.com*|*callboisforhire*|*hot-cop.150m.com*|*pornboismanagement*|*trip0d*|*poppers4sale*|*ohghurl.com*|*www.h0rnydo*|*hung-jock.com*|*queerkid.com*|*beachguys.com*|*gay-teens.com*|*cutelad-uk*|*dicknetwork*|*my-gay-site*|*bondage4u.com*|*sorta__differentt*|*jock_forhookup*|*bestispdeal*|*dude_withcam*|*blatinothugs*|*gaypornpictures*|*bi_jock*|*dudedormpictures*|*earthtwink*|*escorts4unorfolk*|*menchats.com*|*gayvideovillage.com*|*angelfire.com*|*justin19freshman@*|*ge0cities!
 *|*freegaypix.com*|*cheap-gay-videos.com*|*man-sluts.com*|*sla!
 terreed.
com*|*boysoncam*|*gaypornopalace.com*|*gayzgood*|*fastdental*|*gayamateurworld*|*contax.150m*|*tekknick.com/itrick*|*onlinegayvideo*|*gay-connectdotnet*|*southernguyz*|*horny_stud_923*|*jock_for_hookup_9284*|*1stopcommunication*|*godsit*|*hung_meat_3796*|*big_collegecock_*|*aaronklinestudios*|*brownbuns*|*gayavenue*|*ukguyz*|*ozneworleans*|*bestviagra*|*bryanmartinonline*|*trafficsurvivor*|*wc1_18rentboy*|*fit-guy-n15*|*babyfacedtop*|*cameran23*|*hardick.co.uk*|*poppersexpress*|*dudepages*|*earthtwinks*|*wayofthemaster*|*outpersonals*|*pegasuspittsburgh*|*damienstevens*|*everythingundertherainbow*|*barebackflix*|*knightboyz*|*bbppv*|*biz-wise*|*boysonwebcam*|*xtremelygay*|*nudewebcamboys*|*czechboys*|*roksworld*|*4genericdrugs*|*justgay*|*http://home.bellsouth.net/p/s/community.dll?ep=16&groupid=237194&ck=*|*ddlworld*|*istarthere*|*igetnet*|*sahagent*|*bigebonystuds*|*bigasscock*|*4genericdrug*|*pigsinc*|*cknoway*|*m-cams*|*Orlandoflaboi80.4t.com*|*mailboxcocks.com*|*gaystre!
 amingvideos*|*bigmanmeat.com*|*bryanbanks*|*want2vote*|*icamsonline.com*|*successfulpeople.com*|*cockoncam*|*terra.es*|*fastsizenow*|*camsonline*|*tripod*|*freemuscledvd.com*|*gayxxxdvds*|*last36hours*|*sacbodymud.com*|*corycam*|*ryanproject*|*blackgaymen.net*|*xxxgaysuperstore*|*male4malesex.com*");
+                          "NULL|MODE * -i|*dantcamboy*|*Free preview*|*epowerchat*|*Live gay sex cam show*|*camboiz*");
+    gaim_prefs_add_string("/plugins/prpl/gaym/botfilter_url",
+                          GAYBOI_SPAM_URL);
 
+    gaim_prefs_connect_callback("/plugins/prpl/gaym/botfilter_url",
+                                botfilter_url_changed_cb, NULL);
+
+    gaim_prefs_add_string("/plugins/prpl/gaym/botfilter_url_result", "");
+    gaim_prefs_add_int("/plugins/prpl/gaym/botfilter_url_last_check", 0);
+
     _gaym_plugin = plugin;
 
     gaym_register_commands();



From deckrider at sheep.berlios.de  Mon Jun 27 15:49:22 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Mon, 27 Jun 2005 15:49:22 +0200
Subject: [Qrc-svn] r128 - trunk/gaym/src
Message-ID: <200506271349.j5RDnMgt009436@sheep.berlios.de>

Author: deckrider
Date: 2005-06-27 15:49:20 +0200 (Mon, 27 Jun 2005)
New Revision: 128

Modified:
   trunk/gaym/src/gaym.c
Log:
Fixed a rather ugly problem that caused unknown messages to be sent to
the server for every buddy on the list, if one buddy was added that
contained a newline.  Cutting and pasting would sometimes cause this to
happen if the user wasn't careful.


Modified: trunk/gaym/src/gaym.c
===================================================================
--- trunk/gaym/src/gaym.c	2005-06-26 23:13:34 UTC (rev 127)
+++ trunk/gaym/src/gaym.c	2005-06-27 13:49:20 UTC (rev 128)
@@ -607,6 +607,9 @@
 static void gaym_add_buddy(GaimConnection * gc, GaimBuddy * buddy,
                            GaimGroup * group)
 {
+    buddy->name = g_strstrip(buddy->name);
+    buddy->alias = g_strstrip(buddy->alias);
+    buddy->server_alias = g_strstrip(buddy->server_alias);
     struct gaym_conn *gaym = (struct gaym_conn *) gc->proto_data;
     struct gaym_buddy *ib = g_new0(struct gaym_buddy, 1);
     ib->name = g_strdup(buddy->name);



From deckrider at sheep.berlios.de  Tue Jun 28 16:04:15 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Tue, 28 Jun 2005 16:04:15 +0200
Subject: [Qrc-svn] r129 - trunk/gaym/src
Message-ID: <200506281404.j5SE4FYZ006287@sheep.berlios.de>

Author: deckrider
Date: 2005-06-28 16:04:13 +0200 (Tue, 28 Jun 2005)
New Revision: 129

Modified:
   trunk/gaym/src/botfilter.c
Log:
Fix a race condition for downloading GayBoi's spam list that is
triggered when simultaneously logging into two gay.com usernames.


Modified: trunk/gaym/src/botfilter.c
===================================================================
--- trunk/gaym/src/botfilter.c	2005-06-27 13:49:20 UTC (rev 128)
+++ trunk/gaym/src/botfilter.c	2005-06-28 14:04:13 UTC (rev 129)
@@ -220,12 +220,9 @@
 
     int last_check =
         gaim_prefs_get_int("/plugins/prpl/gaym/botfilter_url_last_check");
-    const char *result =
-        gaim_prefs_get_string("/plugins/prpl/gaym/botfilter_url_result");
 
 
-    if (!last_check || !result || !gaim_utf8_strcasecmp(result, "")
-        || time(NULL) - last_check > MIN_CHECK_INTERVAL) {
+    if (!last_check || time(NULL) - last_check > MIN_CHECK_INTERVAL) {
         gaim_prefs_set_int("/plugins/prpl/gaym/botfilter_url_last_check",
                            time(NULL));
         gaim_url_fetch(url, FALSE, user_agent, FALSE,



From deckrider at sheep.berlios.de  Wed Jun 29 02:44:17 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Wed, 29 Jun 2005 02:44:17 +0200
Subject: [Qrc-svn] r130 - trunk/gaym/src
Message-ID: <200506290044.j5T0iHxE021261@sheep.berlios.de>

Author: deckrider
Date: 2005-06-29 02:44:01 +0200 (Wed, 29 Jun 2005)
New Revision: 130

Modified:
   trunk/gaym/src/botfilter.c
Log:
Reset botfilter_url_last_check to 0 any time botfilter_url_result is set
to blank.  This will allow a retry at the next login for the cases that
there was some network or server problem when GayBoi's spam list was
being downloaded.


Modified: trunk/gaym/src/botfilter.c
===================================================================
--- trunk/gaym/src/botfilter.c	2005-06-28 14:04:13 UTC (rev 129)
+++ trunk/gaym/src/botfilter.c	2005-06-29 00:44:01 UTC (rev 130)
@@ -170,16 +170,22 @@
     if (!result) {
         gaim_prefs_set_string("/plugins/prpl/gaym/botfilter_url_result",
                               "");
+        gaim_prefs_set_int("/plugins/prpl/gaym/botfilter_url_last_check",
+                           0);
         return;
     }
     if (!g_str_has_prefix(result, "<HTML>\n")) {
         gaim_prefs_set_string("/plugins/prpl/gaym/botfilter_url_result",
                               "");
+        gaim_prefs_set_int("/plugins/prpl/gaym/botfilter_url_last_check",
+                           0);
         return;
     }
     if (!g_str_has_suffix(result, "</HTML>")) {
         gaim_prefs_set_string("/plugins/prpl/gaym/botfilter_url_result",
                               "");
+        gaim_prefs_set_int("/plugins/prpl/gaym/botfilter_url_last_check",
+                           0);
         return;
     }
     const char *sep =
@@ -187,6 +193,8 @@
     if (!sep || !gaim_utf8_strcasecmp(sep, "")) {
         gaim_prefs_set_string("/plugins/prpl/gaym/botfilter_url_result",
                               "");
+        gaim_prefs_set_int("/plugins/prpl/gaym/botfilter_url_last_check",
+                           0);
         return;
     }
     char *html_stripped = gaim_markup_strip_html(result);
@@ -215,6 +223,8 @@
     if (!url || !gaim_utf8_strcasecmp(url, "")) {
         gaim_prefs_set_string("/plugins/prpl/gaym/botfilter_url_result",
                               "");
+        gaim_prefs_set_int("/plugins/prpl/gaym/botfilter_url_last_check",
+                           0);
         return;
     }
 



From deckrider at sheep.berlios.de  Thu Jun 30 19:11:22 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Thu, 30 Jun 2005 19:11:22 +0200
Subject: [Qrc-svn] r132 - trunk/gaym/src
Message-ID: <200506301711.j5UHBMvT003590@sheep.berlios.de>

Author: deckrider
Date: 2005-06-30 19:11:17 +0200 (Thu, 30 Jun 2005)
New Revision: 132

Modified:
   trunk/gaym/src/botfilter.c
Log:
Don't use bot filtering against members of the permit list or members
of the buddy list.  Thanks Evan Langlois <Evan at CoolRunningConcepts.com>



Modified: trunk/gaym/src/botfilter.c
===================================================================
--- trunk/gaym/src/botfilter.c	2005-06-30 15:02:31 UTC (rev 131)
+++ trunk/gaym/src/botfilter.c	2005-06-30 17:11:17 UTC (rev 132)
@@ -83,6 +83,7 @@
         return permitted;
     }
 
+    /* don't ignore self */
     if (!gaim_utf8_strcasecmp(gc->account->username, nick)) {
         permitted = TRUE;
         gaim_debug_info("gaym", "declining to block/ignore self\n");
@@ -90,6 +91,22 @@
         return permitted;
     }
 
+    /* don't make buddies use the challenge/response system */
+    if (gaim_find_buddy(gc->account, nick)) {
+        permitted = TRUE;
+        return permitted;
+    }
+
+    /* don't make permit list members use the challenge/response system */
+    GSList *slist = NULL;
+    for (slist = gc->account->permit; slist != NULL; slist = slist->next) {
+        if (!gaim_utf8_strcasecmp
+            (nick, gaim_normalize(gc->account, (char *) slist->data))) {
+            permitted = TRUE;
+            return permitted;
+        }
+    }
+
     /**
      * prevent gaim privacy changes from affecting previously
      * filtered bots



From deckrider at sheep.berlios.de  Thu Jun 30 17:02:32 2005
From: deckrider at sheep.berlios.de (David Everly at BerliOS)
Date: Thu, 30 Jun 2005 17:02:32 +0200
Subject: [Qrc-svn] r131 - trunk/bot-challenger
Message-ID: <200506301502.j5UF2WAm022515@sheep.berlios.de>

Author: deckrider
Date: 2005-06-30 17:02:31 +0200 (Thu, 30 Jun 2005)
New Revision: 131

Modified:
   trunk/bot-challenger/bot-challenger.c
Log:
Fixed problem where bot-challenger does not cooperate with Gaim's away
mechanisms.


Modified: trunk/bot-challenger/bot-challenger.c
===================================================================
--- trunk/bot-challenger/bot-challenger.c	2005-06-29 00:44:01 UTC (rev 130)
+++ trunk/bot-challenger/bot-challenger.c	2005-06-30 15:02:31 UTC (rev 131)
@@ -145,31 +145,25 @@
     }
 }
 
-/**
- * Send an IM to the recipient (thanks to the gaim-otr plugin)
- */
-void inject_message(GaimAccount * account, const char *recipient,
-                    const char *message)
+void send_auto_reply(GaimAccount * account, const char *recipient,
+                     const char *message)
 {
-    GaimConnection *connection;
+    int i = 0;
+    GaimConnection *gc = NULL;
+    GaimPluginProtocolInfo *prpl_info = NULL;
 
-    connection = gaim_account_get_connection(account);
+    gc = gaim_account_get_connection(account);
 
-    if (!connection) {
-        const char *protocol = gaim_account_get_protocol_id(account);
-        const char *accountname = gaim_account_get_username(account);
-        GaimPlugin *p = gaim_find_prpl(protocol);
+    if (gc != NULL && gc->prpl != NULL) {
+        prpl_info = GAIM_PLUGIN_PROTOCOL_INFO(gc->prpl);
+    }
 
-        gaim_debug_error("bot-challenger",
-                         "You are not currently connected to "
-                         "account %s (%s).", accountname, (p
-                                                           && p->info->
-                                                           name) ? p->
-                         info->name : "Unknown");
-
-        return;
+    if (prpl_info && prpl_info->send_im) {
+        i = prpl_info->send_im(gc, recipient, message,
+                               GAIM_CONV_IM_AUTO_RESP);
     }
-    serv_send_im(connection, recipient, message, 0);
+
+    return;
 }
 
 /**
@@ -268,7 +262,7 @@
             g_strdup_printf(_
                             ("Bot Challenger engaged:  you are now being ignored!  Your message will be delivered if you can correctly answer the following question within %i minutes:  %s"),
                             BOT_MAX_MINUTES, question);
-        inject_message(account, *sender, botmsg);
+        send_auto_reply(account, *sender, botmsg);
 
         g_free(now);
         g_free(botmsg);
@@ -283,7 +277,7 @@
             botmsg =
                 _
                 ("Bot Challenger accepted your answer and delivered your original message.  You may now speak freely.");
-            inject_message(account, *sender, botmsg);
+            send_auto_reply(account, *sender, botmsg);
 
             if (gaim_prefs_get_bool
                 ("/plugins/core/bot/challenger/auto_add_permit")) {



